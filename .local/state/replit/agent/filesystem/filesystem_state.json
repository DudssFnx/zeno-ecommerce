{"file_contents":{"client/src/components/ui/textarea.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Textarea = React.forwardRef<\n  HTMLTextAreaElement,\n  React.ComponentProps<\"textarea\">\n>(({ className, ...props }, ref) => {\n  return (\n    <textarea\n      className={cn(\n        \"flex min-h-[80px] w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm\",\n        className\n      )}\n      ref={ref}\n      {...props}\n    />\n  )\n})\nTextarea.displayName = \"Textarea\"\n\nexport { Textarea }\n","path":null,"size_bytes":689,"size_tokens":null},"client/src/pages/not-found.tsx":{"content":"import { Card, CardContent } from \"@/components/ui/card\";\nimport { AlertCircle } from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Link } from \"wouter\";\n\nexport default function NotFound() {\n  return (\n    <div className=\"min-h-screen w-full flex items-center justify-center bg-background\">\n      <Card className=\"w-full max-w-md mx-4\">\n        <CardContent className=\"pt-6\">\n          <div className=\"flex mb-4 gap-2\">\n            <AlertCircle className=\"h-8 w-8 text-destructive\" />\n            <h1 className=\"text-2xl font-bold\">Página não encontrada</h1>\n          </div>\n\n          <p className=\"mt-4 text-sm text-muted-foreground\">\n            A página que você está procurando não existe ou foi movida.\n          </p>\n          \n          <Link href=\"/\">\n            <Button className=\"mt-4\" data-testid=\"button-back-home\">\n              Voltar ao início\n            </Button>\n          </Link>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","path":null,"size_bytes":993,"size_tokens":null},"client/src/components/ui/badge.tsx":{"content":"import * as React from \"react\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst badgeVariants = cva(\n  // Whitespace-nowrap: Badges should never wrap.\n  \"whitespace-nowrap inline-flex items-center rounded-md border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2\" +\n  \" hover-elevate \" ,\n  {\n    variants: {\n      variant: {\n        default:\n          \"border-transparent bg-primary text-primary-foreground shadow-xs\",\n        secondary: \"border-transparent bg-secondary text-secondary-foreground\",\n        destructive:\n          \"border-transparent bg-destructive text-destructive-foreground shadow-xs\",\n\n        outline: \" border [border-color:var(--badge-outline)] shadow-xs\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  },\n)\n\nexport interface BadgeProps\n  extends React.HTMLAttributes<HTMLDivElement>,\n    VariantProps<typeof badgeVariants> {}\n\nfunction Badge({ className, variant, ...props }: BadgeProps) {\n  return (\n    <div className={cn(badgeVariants({ variant }), className)} {...props} />\n  );\n}\n\nexport { Badge, badgeVariants }\n","path":null,"size_bytes":1202,"size_tokens":null},"client/src/components/ui/context-menu.tsx":{"content":"import * as React from \"react\"\nimport * as ContextMenuPrimitive from \"@radix-ui/react-context-menu\"\nimport { Check, ChevronRight, Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ContextMenu = ContextMenuPrimitive.Root\n\nconst ContextMenuTrigger = ContextMenuPrimitive.Trigger\n\nconst ContextMenuGroup = ContextMenuPrimitive.Group\n\nconst ContextMenuPortal = ContextMenuPrimitive.Portal\n\nconst ContextMenuSub = ContextMenuPrimitive.Sub\n\nconst ContextMenuRadioGroup = ContextMenuPrimitive.RadioGroup\n\nconst ContextMenuSubTrigger = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.SubTrigger>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.SubTrigger> & {\n    inset?: boolean\n  }\n>(({ className, inset, children, ...props }, ref) => (\n  <ContextMenuPrimitive.SubTrigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <ChevronRight className=\"ml-auto h-4 w-4\" />\n  </ContextMenuPrimitive.SubTrigger>\n))\nContextMenuSubTrigger.displayName = ContextMenuPrimitive.SubTrigger.displayName\n\nconst ContextMenuSubContent = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.SubContent>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.SubContent>\n>(({ className, ...props }, ref) => (\n  <ContextMenuPrimitive.SubContent\n    ref={ref}\n    className={cn(\n      \"z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-context-menu-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nContextMenuSubContent.displayName = ContextMenuPrimitive.SubContent.displayName\n\nconst ContextMenuContent = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <ContextMenuPrimitive.Portal>\n    <ContextMenuPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"z-50 max-h-[--radix-context-menu-content-available-height] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md animate-in fade-in-80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-context-menu-content-transform-origin]\",\n        className\n      )}\n      {...props}\n    />\n  </ContextMenuPrimitive.Portal>\n))\nContextMenuContent.displayName = ContextMenuPrimitive.Content.displayName\n\nconst ContextMenuItem = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Item> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <ContextMenuPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nContextMenuItem.displayName = ContextMenuPrimitive.Item.displayName\n\nconst ContextMenuCheckboxItem = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.CheckboxItem>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.CheckboxItem>\n>(({ className, children, checked, ...props }, ref) => (\n  <ContextMenuPrimitive.CheckboxItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    checked={checked}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <ContextMenuPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </ContextMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </ContextMenuPrimitive.CheckboxItem>\n))\nContextMenuCheckboxItem.displayName =\n  ContextMenuPrimitive.CheckboxItem.displayName\n\nconst ContextMenuRadioItem = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.RadioItem>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.RadioItem>\n>(({ className, children, ...props }, ref) => (\n  <ContextMenuPrimitive.RadioItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <ContextMenuPrimitive.ItemIndicator>\n        <Circle className=\"h-2 w-2 fill-current\" />\n      </ContextMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </ContextMenuPrimitive.RadioItem>\n))\nContextMenuRadioItem.displayName = ContextMenuPrimitive.RadioItem.displayName\n\nconst ContextMenuLabel = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Label> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <ContextMenuPrimitive.Label\n    ref={ref}\n    className={cn(\n      \"px-2 py-1.5 text-sm font-semibold text-foreground\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nContextMenuLabel.displayName = ContextMenuPrimitive.Label.displayName\n\nconst ContextMenuSeparator = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <ContextMenuPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-border\", className)}\n    {...props}\n  />\n))\nContextMenuSeparator.displayName = ContextMenuPrimitive.Separator.displayName\n\nconst ContextMenuShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\n        \"ml-auto text-xs tracking-widest text-muted-foreground\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\nContextMenuShortcut.displayName = \"ContextMenuShortcut\"\n\nexport {\n  ContextMenu,\n  ContextMenuTrigger,\n  ContextMenuContent,\n  ContextMenuItem,\n  ContextMenuCheckboxItem,\n  ContextMenuRadioItem,\n  ContextMenuLabel,\n  ContextMenuSeparator,\n  ContextMenuShortcut,\n  ContextMenuGroup,\n  ContextMenuPortal,\n  ContextMenuSub,\n  ContextMenuSubContent,\n  ContextMenuSubTrigger,\n  ContextMenuRadioGroup,\n}\n","path":null,"size_bytes":7428,"size_tokens":null},"client/src/components/ui/progress.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as ProgressPrimitive from \"@radix-ui/react-progress\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Progress = React.forwardRef<\n  React.ElementRef<typeof ProgressPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof ProgressPrimitive.Root>\n>(({ className, value, ...props }, ref) => (\n  <ProgressPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"relative h-4 w-full overflow-hidden rounded-full bg-secondary\",\n      className\n    )}\n    {...props}\n  >\n    <ProgressPrimitive.Indicator\n      className=\"h-full w-full flex-1 bg-primary transition-all\"\n      style={{ transform: `translateX(-${100 - (value || 0)}%)` }}\n    />\n  </ProgressPrimitive.Root>\n))\nProgress.displayName = ProgressPrimitive.Root.displayName\n\nexport { Progress }\n","path":null,"size_bytes":791,"size_tokens":null},"server/db.ts":{"content":"import { drizzle } from \"drizzle-orm/node-postgres\";\nimport { Pool } from \"pg\";\n\nif (!process.env.DATABASE_URL) {\n  throw new Error(\"DATABASE_URL não definida\");\n}\n\nconst pool = new Pool({\n  connectionString: process.env.DATABASE_URL,\n  ssl: {\n    rejectUnauthorized: false,\n  },\n});\n\nexport const db = drizzle(pool);\nexport { pool };\n","path":null,"size_bytes":336,"size_tokens":null},"client/src/components/ui/form.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as LabelPrimitive from \"@radix-ui/react-label\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport {\n  Controller,\n  FormProvider,\n  useFormContext,\n  type ControllerProps,\n  type FieldPath,\n  type FieldValues,\n} from \"react-hook-form\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Label } from \"@/components/ui/label\"\n\nconst Form = FormProvider\n\ntype FormFieldContextValue<\n  TFieldValues extends FieldValues = FieldValues,\n  TName extends FieldPath<TFieldValues> = FieldPath<TFieldValues>\n> = {\n  name: TName\n}\n\nconst FormFieldContext = React.createContext<FormFieldContextValue>(\n  {} as FormFieldContextValue\n)\n\nconst FormField = <\n  TFieldValues extends FieldValues = FieldValues,\n  TName extends FieldPath<TFieldValues> = FieldPath<TFieldValues>\n>({\n  ...props\n}: ControllerProps<TFieldValues, TName>) => {\n  return (\n    <FormFieldContext.Provider value={{ name: props.name }}>\n      <Controller {...props} />\n    </FormFieldContext.Provider>\n  )\n}\n\nconst useFormField = () => {\n  const fieldContext = React.useContext(FormFieldContext)\n  const itemContext = React.useContext(FormItemContext)\n  const { getFieldState, formState } = useFormContext()\n\n  const fieldState = getFieldState(fieldContext.name, formState)\n\n  if (!fieldContext) {\n    throw new Error(\"useFormField should be used within <FormField>\")\n  }\n\n  const { id } = itemContext\n\n  return {\n    id,\n    name: fieldContext.name,\n    formItemId: `${id}-form-item`,\n    formDescriptionId: `${id}-form-item-description`,\n    formMessageId: `${id}-form-item-message`,\n    ...fieldState,\n  }\n}\n\ntype FormItemContextValue = {\n  id: string\n}\n\nconst FormItemContext = React.createContext<FormItemContextValue>(\n  {} as FormItemContextValue\n)\n\nconst FormItem = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => {\n  const id = React.useId()\n\n  return (\n    <FormItemContext.Provider value={{ id }}>\n      <div ref={ref} className={cn(\"space-y-2\", className)} {...props} />\n    </FormItemContext.Provider>\n  )\n})\nFormItem.displayName = \"FormItem\"\n\nconst FormLabel = React.forwardRef<\n  React.ElementRef<typeof LabelPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof LabelPrimitive.Root>\n>(({ className, ...props }, ref) => {\n  const { error, formItemId } = useFormField()\n\n  return (\n    <Label\n      ref={ref}\n      className={cn(error && \"text-destructive\", className)}\n      htmlFor={formItemId}\n      {...props}\n    />\n  )\n})\nFormLabel.displayName = \"FormLabel\"\n\nconst FormControl = React.forwardRef<\n  React.ElementRef<typeof Slot>,\n  React.ComponentPropsWithoutRef<typeof Slot>\n>(({ ...props }, ref) => {\n  const { error, formItemId, formDescriptionId, formMessageId } = useFormField()\n\n  return (\n    <Slot\n      ref={ref}\n      id={formItemId}\n      aria-describedby={\n        !error\n          ? `${formDescriptionId}`\n          : `${formDescriptionId} ${formMessageId}`\n      }\n      aria-invalid={!!error}\n      {...props}\n    />\n  )\n})\nFormControl.displayName = \"FormControl\"\n\nconst FormDescription = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLParagraphElement>\n>(({ className, ...props }, ref) => {\n  const { formDescriptionId } = useFormField()\n\n  return (\n    <p\n      ref={ref}\n      id={formDescriptionId}\n      className={cn(\"text-sm text-muted-foreground\", className)}\n      {...props}\n    />\n  )\n})\nFormDescription.displayName = \"FormDescription\"\n\nconst FormMessage = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLParagraphElement>\n>(({ className, children, ...props }, ref) => {\n  const { error, formMessageId } = useFormField()\n  const body = error ? String(error?.message ?? \"\") : children\n\n  if (!body) {\n    return null\n  }\n\n  return (\n    <p\n      ref={ref}\n      id={formMessageId}\n      className={cn(\"text-sm font-medium text-destructive\", className)}\n      {...props}\n    >\n      {body}\n    </p>\n  )\n})\nFormMessage.displayName = \"FormMessage\"\n\nexport {\n  useFormField,\n  Form,\n  FormItem,\n  FormLabel,\n  FormControl,\n  FormDescription,\n  FormMessage,\n  FormField,\n}\n","path":null,"size_bytes":4120,"size_tokens":null},"replit.md":{"content":"# B2B Wholesale Catalog & Order Management System\n\n## Overview\n\nA private, closed B2B wholesale catalog and order management platform for registered business clients. It facilitates product catalog browsing and order generation, specifically designed for internal business use with required authentication and role-based access control. The system aims to modernize a legacy system by incrementally migrating to a new B2B model while supporting existing functionalities.\n\n## User Preferences\n\nPreferred communication style: Simple, everyday language.\n\n## System Architecture\n\n### UI/UX Decisions\n- **Frontend Framework**: React 18 with TypeScript\n- **UI Components**: shadcn/ui built on Radix UI primitives\n- **Styling**: Tailwind CSS with custom design tokens and CSS variables\n- **Routing**: Wouter (lightweight React router)\n- **State Management**: TanStack React Query for server state, React Context for client state (Auth, Cart, Theme)\n- **Delivery Mode Catalog**: An alternative, mobile-first catalog view inspired by delivery apps (iFood), featuring horizontal category scroll, large product cards, direct quantity controls, and a prominent \"Highlights\" section.\n\n### Technical Implementations\n- **Backend**: Node.js with Express.js, TypeScript (ESM modules), RESTful API.\n- **Authentication**: Replit OpenID Connect (OIDC) with Passport.js; sessions stored in PostgreSQL.\n- **Database**: PostgreSQL with Drizzle ORM and `drizzle-zod` for schema validation.\n- **Dual-Schema Architecture**: Supports incremental migration from a legacy database model to a new B2B model, allowing new features to use `b2b_*` tables while legacy code continues with original tables.\n- **Role-Based Access Control (RBAC)**: Four hierarchical roles (Admin, Sales, Customer, Supplier) with granular, module-based permissions. Admins can customize user permissions, and user menus are filtered based on assigned access.\n- **Financial Modules**:\n    - **Accounts Receivable**: Manages customer credits, including debit/credit entries, payment tracking, and status management.\n    - **Accounts Payable**: Manages company expenses, including categorization, due dates, and payment tracking.\n- **Payment Module**: Manages custom payment types (e.g., \"Cash on Delivery\") and integrations with various payment gateways (Mercado Pago, PagSeguro, Stripe, PayPal, Asaas, Pix Manual).\n\n### Key Design Patterns\n- **Shared Schema**: Database schemas and TypeScript types defined once in `shared/schema.ts` for both frontend and backend.\n- **Storage Interface**: `server/storage.ts` provides a consistent interface for all database operations.\n- **Query Client Configuration**: Centralized API request handling in `client/src/lib/queryClient.ts`.\n\n## External Dependencies\n\n### Database\n- **PostgreSQL**: Primary data store for application data and sessions.\n\n### Authentication\n- **Replit OIDC**: OpenID Connect authentication provider.\n\n### UI Libraries\n- **Radix UI**: Accessible component primitives.\n- **Lucide React**: Icon library.\n- **Embla Carousel**: Carousel functionality.\n- **React Hook Form**: Form state management with Zod validation.\n\n### Build & Development\n- **Vite**: Frontend development server and bundler.\n- **esbuild**: Server-side bundling for production.\n- **TSX**: TypeScript execution for development.\n\n### Integrations\n- **Bling API v3**: Integrated for product and category synchronization, webhooks for real-time updates, and automatic order submission.","path":null,"size_bytes":3456,"size_tokens":null},"client/src/components/examples/ProductCardExample.tsx":{"content":"import { ProductCard } from \"../ProductCard\";\n\nconst mockProduct = {\n  id: \"1\",\n  name: \"Industrial Bearing Set - Heavy Duty\",\n  sku: \"BRG-001\",\n  category: \"Machinery Parts\",\n  brand: \"TechParts\",\n  price: 149.99,\n  stock: 25,\n};\n\nexport default function ProductCardExample() {\n  return (\n    <div className=\"max-w-[280px]\">\n      <ProductCard\n        product={mockProduct}\n        onAddToCart={(p, qty) => console.log(\"Added to cart:\", p.name, \"qty:\", qty)}\n      />\n    </div>\n  );\n}\n","path":null,"size_bytes":487,"size_tokens":null},"client/src/components/examples/LoginFormExample.tsx":{"content":"import { LoginForm } from \"../LoginForm\";\nimport { useState } from \"react\";\n\nexport default function LoginFormExample() {\n  const [isLoading, setIsLoading] = useState(false);\n\n  const handleLogin = async (email: string, password: string) => {\n    setIsLoading(true);\n    console.log(\"Login attempt:\", email, password);\n    await new Promise((r) => setTimeout(r, 1000));\n    setIsLoading(false);\n    return email.includes(\"@\");\n  };\n\n  return (\n    <div className=\"flex items-center justify-center\">\n      <LoginForm onSubmit={handleLogin} isLoading={isLoading} />\n    </div>\n  );\n}\n","path":null,"size_bytes":582,"size_tokens":null},"client/src/components/ui/separator.tsx":{"content":"import * as React from \"react\"\nimport * as SeparatorPrimitive from \"@radix-ui/react-separator\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Separator = React.forwardRef<\n  React.ElementRef<typeof SeparatorPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof SeparatorPrimitive.Root>\n>(\n  (\n    { className, orientation = \"horizontal\", decorative = true, ...props },\n    ref\n  ) => (\n    <SeparatorPrimitive.Root\n      ref={ref}\n      decorative={decorative}\n      orientation={orientation}\n      className={cn(\n        \"shrink-0 bg-border\",\n        orientation === \"horizontal\" ? \"h-[1px] w-full\" : \"h-full w-[1px]\",\n        className\n      )}\n      {...props}\n    />\n  )\n)\nSeparator.displayName = SeparatorPrimitive.Root.displayName\n\nexport { Separator }\n","path":null,"size_bytes":756,"size_tokens":null},"client/src/components/AppSidebar.tsx":{"content":"import { Link, useLocation } from \"wouter\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport {\n  Sidebar,\n  SidebarContent,\n  SidebarGroup,\n  SidebarGroupContent,\n  SidebarGroupLabel,\n  SidebarMenu,\n  SidebarMenuButton,\n  SidebarMenuItem,\n  SidebarMenuSub,\n  SidebarMenuSubItem,\n  SidebarMenuSubButton,\n  SidebarHeader,\n  SidebarFooter,\n} from \"@/components/ui/sidebar\";\nimport { Avatar, AvatarFallback } from \"@/components/ui/avatar\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Collapsible, CollapsibleContent, CollapsibleTrigger } from \"@/components/ui/collapsible\";\nimport {\n  LayoutDashboard,\n  Package,\n  ClipboardList,\n  Users,\n  UserCheck,\n  Settings,\n  LogOut,\n  Grid3X3,\n  Link2,\n  Ticket,\n  BarChart3,\n  TrendingUp,\n  ChevronRight,\n  ExternalLink,\n  ShoppingCart,\n  Calendar,\n  Palette,\n  Banknote,\n  ArrowUpRight,\n  ArrowDownRight,\n  Truck,\n  Sparkles,\n  Tag,\n  CreditCard,\n} from \"lucide-react\";\nimport logoImage from \"@assets/image_1765659931449.png\";\n\ntype UserRole = \"admin\" | \"sales\" | \"customer\" | \"supplier\";\n\ninterface MenuItem {\n  title: string;\n  url?: string;\n  icon: any;\n  moduleKey?: string;\n  badge?: string;\n  subItems?: { title: string; url: string; icon: any; moduleKey?: string; badge?: string }[];\n}\n\ninterface AppSidebarProps {\n  userRole?: UserRole;\n  userName?: string;\n  onLogout?: () => void;\n}\n\nconst allMenuItems: MenuItem[] = [\n  { \n    title: \"Painel\", \n    icon: LayoutDashboard,\n    moduleKey: \"reports\",\n    subItems: [\n      { title: \"Visao Geral\", url: \"/\", icon: LayoutDashboard, moduleKey: \"reports\" },\n      { title: \"Analise de Clientes\", url: \"/customer-analytics\", icon: BarChart3, moduleKey: \"reports\" },\n      { title: \"Analise de Produtos\", url: \"/product-analytics\", icon: TrendingUp, moduleKey: \"reports\" },\n      { title: \"Analise de Funcionarios\", url: \"/employee-analytics\", icon: Users, moduleKey: \"reports\" },\n      { title: \"Compras\", url: \"/purchases\", icon: ShoppingCart, moduleKey: \"reports\" },\n      { title: \"Marcas\", url: \"/brand-analytics\", icon: Tag, moduleKey: \"brands\" },\n    ]\n  },\n  { title: \"Categorias\", url: \"/categories\", icon: Grid3X3, moduleKey: \"catalog\" },\n  { title: \"Catalogo\", url: \"/catalog\", icon: Package, moduleKey: \"catalog\" },\n  { title: \"Pedidos\", url: \"/orders\", icon: ClipboardList, moduleKey: \"orders\" },\n  { title: \"Produtos\", url: \"/products\", icon: Package, moduleKey: \"products\" },\n  { title: \"Clientes\", url: \"/customers\", icon: UserCheck, moduleKey: \"customers\" },\n  { title: \"Usuarios\", url: \"/users\", icon: Users, moduleKey: \"customers\" },\n  { title: \"Fornecedores\", url: \"/suppliers\", icon: Truck, moduleKey: \"products\" },\n  { title: \"Cupons\", url: \"/coupons\", icon: Ticket, moduleKey: \"products\" },\n  { \n    title: \"Financeiro\", \n    icon: Banknote,\n    subItems: [\n      { title: \"Contas a Receber\", url: \"/contas-receber\", icon: ArrowUpRight, moduleKey: \"financial_receivables\" },\n      { title: \"Contas a Pagar\", url: \"/contas-pagar\", icon: ArrowDownRight, moduleKey: \"financial_payables\" },\n      { title: \"Pagamentos\", url: \"/payments\", icon: CreditCard, moduleKey: \"payments\" },\n    ]\n  },\n  { title: \"Agenda\", url: \"/agenda\", icon: Calendar, moduleKey: \"agenda\" },\n  { title: \"Bling\", url: \"/bling\", icon: Link2, moduleKey: \"settings\" },\n  { title: \"Aparencia\", url: \"/appearance\", icon: Palette, moduleKey: \"appearance\" },\n  { title: \"Configuracoes\", url: \"/settings\", icon: Settings, moduleKey: \"settings\" },\n];\n\nconst customerMenuItems: MenuItem[] = [\n  { title: \"Painel\", url: \"/\", icon: LayoutDashboard, moduleKey: \"catalog\" },\n  { title: \"Categorias\", url: \"/categories\", icon: Grid3X3, moduleKey: \"catalog\" },\n  { title: \"Catalogo\", url: \"/catalog\", icon: Package, moduleKey: \"catalog\" },\n  { title: \"Meus Pedidos\", url: \"/orders\", icon: ClipboardList, moduleKey: \"orders\" },\n];\n\nconst supplierMenuItems: MenuItem[] = [\n  { title: \"Marcas\", url: \"/brand-analytics\", icon: Tag, moduleKey: \"brands\" },\n];\n\nexport function AppSidebar({ userRole = \"customer\", userName = \"User\", onLogout }: AppSidebarProps) {\n  const [location] = useLocation();\n\n  const { data: permissionsData } = useQuery<{ modules: string[]; role: string }>({\n    queryKey: ['/api/auth/permissions'],\n    staleTime: 1000 * 60 * 5,\n  });\n\n  const userModules = permissionsData?.modules || [];\n  const isAdmin = userRole === \"admin\";\n\n  const filterMenuItems = (items: MenuItem[]): MenuItem[] => {\n    if (isAdmin) return items;\n\n    return items\n      .filter(item => {\n        if (item.subItems) {\n          const filteredSubItems = item.subItems.filter(sub => \n            !sub.moduleKey || userModules.includes(sub.moduleKey)\n          );\n          return filteredSubItems.length > 0;\n        }\n        return !item.moduleKey || userModules.includes(item.moduleKey);\n      })\n      .map(item => {\n        if (item.subItems) {\n          return {\n            ...item,\n            subItems: item.subItems.filter(sub => \n              !sub.moduleKey || userModules.includes(sub.moduleKey)\n            )\n          };\n        }\n        return item;\n      });\n  };\n\n  const baseItems = userRole === \"customer\" \n    ? customerMenuItems \n    : userRole === \"supplier\" \n      ? supplierMenuItems \n      : allMenuItems;\n  const items = filterMenuItems(baseItems);\n\n  const initials = userName\n    .split(\" \")\n    .map((n) => n[0])\n    .join(\"\")\n    .toUpperCase()\n    .slice(0, 2);\n\n  const getRoleBadgeVariant = (role: UserRole) => {\n    switch (role) {\n      case \"admin\": return \"default\";\n      case \"sales\": return \"secondary\";\n      case \"supplier\": return \"secondary\";\n      default: return \"outline\";\n    }\n  };\n\n  const getRoleLabel = (role: UserRole) => {\n    switch (role) {\n      case \"admin\": return \"Administrador\";\n      case \"sales\": return \"Vendedor\";\n      case \"supplier\": return \"Fornecedor\";\n      default: return \"Cliente\";\n    }\n  };\n\n  return (\n    <Sidebar className=\"border-r-0\">\n      <SidebarHeader className=\"p-0\">\n        <div className=\"bg-gradient-to-br from-primary/10 via-primary/5 to-transparent p-4\">\n          <div className=\"flex items-center gap-3\">\n            <div className=\"relative\">\n              <img \n                src={logoImage} \n                alt=\"Logo\" \n                className=\"h-11 w-11 rounded-xl shadow-sm ring-2 ring-primary/20\" \n              />\n              <div className=\"absolute -bottom-0.5 -right-0.5 h-3 w-3 rounded-full bg-green-500 ring-2 ring-sidebar\" />\n            </div>\n            <div className=\"flex-1 min-w-0\">\n              <h2 className=\"font-bold text-sm tracking-tight truncate\">Lojamadrugadao</h2>\n              <div className=\"flex items-center gap-1.5 mt-0.5\">\n                <Sparkles className=\"h-3 w-3 text-primary\" />\n                <span className=\"text-xs text-muted-foreground\">Portal Atacado</span>\n              </div>\n            </div>\n          </div>\n        </div>\n        \n        <div className=\"px-4 pb-4 pt-2\">\n          <p className=\"text-[10px] uppercase tracking-wider text-muted-foreground font-medium mb-2\">Visualizar como</p>\n          <div className=\"flex gap-2\">\n            <Button\n              variant=\"outline\"\n              size=\"sm\"\n              className=\"flex-1 h-8 text-xs\"\n              onClick={() => window.open('/', '_blank')}\n              data-testid=\"button-ver-varejo\"\n            >\n              <ExternalLink className=\"h-3 w-3 mr-1.5\" />\n              Varejo\n            </Button>\n            <Button\n              variant=\"outline\"\n              size=\"sm\"\n              className=\"flex-1 h-8 text-xs\"\n              onClick={() => window.open('/catalog', '_blank')}\n              data-testid=\"button-ver-atacado\"\n            >\n              <ExternalLink className=\"h-3 w-3 mr-1.5\" />\n              Atacado\n            </Button>\n          </div>\n        </div>\n      </SidebarHeader>\n\n      <SidebarContent className=\"px-2\">\n        <SidebarGroup>\n          <SidebarGroupLabel className=\"text-[10px] uppercase tracking-wider font-semibold text-muted-foreground px-2\">\n            Navegacao\n          </SidebarGroupLabel>\n          <SidebarGroupContent>\n            <SidebarMenu>\n              {items.map((item) => (\n                item.subItems ? (\n                  <Collapsible key={item.title} defaultOpen className=\"group/collapsible\">\n                    <SidebarMenuItem>\n                      <CollapsibleTrigger asChild>\n                        <SidebarMenuButton\n                          className=\"group/btn rounded-lg\"\n                          data-testid={`link-nav-${item.title.toLowerCase().replace(/\\s+/g, \"-\")}`}\n                        >\n                          <div className=\"flex items-center justify-center w-8 h-8 rounded-lg bg-muted/50 group-hover/btn:bg-primary/10 transition-colors\">\n                            <item.icon className=\"h-4 w-4 text-muted-foreground group-hover/btn:text-primary transition-colors\" />\n                          </div>\n                          <span className=\"font-medium\">{item.title}</span>\n                          {item.badge && (\n                            <Badge variant=\"secondary\" className=\"ml-auto mr-2 h-5 text-[10px]\">\n                              {item.badge}\n                            </Badge>\n                          )}\n                          <ChevronRight className=\"ml-auto h-4 w-4 text-muted-foreground transition-transform duration-200 group-data-[state=open]/collapsible:rotate-90\" />\n                        </SidebarMenuButton>\n                      </CollapsibleTrigger>\n                      <CollapsibleContent className=\"transition-all\">\n                        <SidebarMenuSub className=\"ml-6 border-l border-border/50 pl-2\">\n                          {item.subItems.map((subItem) => (\n                            <SidebarMenuSubItem key={subItem.title}>\n                              <SidebarMenuSubButton\n                                asChild\n                                isActive={location === subItem.url}\n                                className=\"rounded-md\"\n                                data-testid={`link-nav-${subItem.title.toLowerCase().replace(/\\s+/g, \"-\")}`}\n                              >\n                                <Link href={subItem.url}>\n                                  <subItem.icon className=\"h-3.5 w-3.5\" />\n                                  <span className=\"text-[13px]\">{subItem.title}</span>\n                                  {subItem.badge && (\n                                    <Badge variant=\"secondary\" className=\"ml-auto h-4 text-[9px] px-1.5\">\n                                      {subItem.badge}\n                                    </Badge>\n                                  )}\n                                </Link>\n                              </SidebarMenuSubButton>\n                            </SidebarMenuSubItem>\n                          ))}\n                        </SidebarMenuSub>\n                      </CollapsibleContent>\n                    </SidebarMenuItem>\n                  </Collapsible>\n                ) : (\n                  <SidebarMenuItem key={item.title}>\n                    <SidebarMenuButton \n                      asChild \n                      isActive={location === item.url}\n                      className=\"group/btn rounded-lg\"\n                      data-testid={`link-nav-${item.title.toLowerCase().replace(/\\s+/g, \"-\")}`}\n                    >\n                      <Link href={item.url!}>\n                        <div className=\"flex items-center justify-center w-8 h-8 rounded-lg bg-muted/50 group-hover/btn:bg-primary/10 data-[active=true]:bg-primary/15 transition-colors\">\n                          <item.icon className=\"h-4 w-4 text-muted-foreground group-hover/btn:text-primary transition-colors\" />\n                        </div>\n                        <span className=\"font-medium\">{item.title}</span>\n                        {item.badge && (\n                          <Badge variant=\"secondary\" className=\"ml-auto h-5 text-[10px]\">\n                            {item.badge}\n                          </Badge>\n                        )}\n                      </Link>\n                    </SidebarMenuButton>\n                  </SidebarMenuItem>\n                )\n              ))}\n            </SidebarMenu>\n          </SidebarGroupContent>\n        </SidebarGroup>\n      </SidebarContent>\n\n      <SidebarFooter className=\"p-3 mt-auto\">\n        <div className=\"flex items-center gap-3 p-2 rounded-xl bg-muted/30\">\n          <Avatar className=\"h-10 w-10 ring-2 ring-primary/20\">\n            <AvatarFallback className=\"bg-gradient-to-br from-primary/20 to-primary/5 text-primary text-sm font-bold\">\n              {initials}\n            </AvatarFallback>\n          </Avatar>\n          <div className=\"flex-1 min-w-0\">\n            <p className=\"text-sm font-semibold truncate\">{userName}</p>\n            <Badge variant={getRoleBadgeVariant(userRole)} className=\"h-4 text-[9px] px-1.5 mt-0.5\">\n              {getRoleLabel(userRole)}\n            </Badge>\n          </div>\n          <Button \n            variant=\"ghost\" \n            size=\"icon\"\n            className=\"h-8 w-8 rounded-lg text-muted-foreground hover:text-destructive hover:bg-destructive/10\"\n            onClick={onLogout}\n            data-testid=\"button-logout\"\n          >\n            <LogOut className=\"h-4 w-4\" />\n          </Button>\n        </div>\n      </SidebarFooter>\n    </Sidebar>\n  );\n}\n","path":null,"size_bytes":13435,"size_tokens":null},"vite.config.ts":{"content":"import { defineConfig } from \"vite\";\nimport react from \"@vitejs/plugin-react\";\nimport path from \"path\";\nimport runtimeErrorOverlay from \"@replit/vite-plugin-runtime-error-modal\";\n\nexport default defineConfig({\n  plugins: [\n    react(),\n    runtimeErrorOverlay(),\n    ...(process.env.NODE_ENV !== \"production\" &&\n    process.env.REPL_ID !== undefined\n      ? [\n          await import(\"@replit/vite-plugin-cartographer\").then((m) =>\n            m.cartographer(),\n          ),\n          await import(\"@replit/vite-plugin-dev-banner\").then((m) =>\n            m.devBanner(),\n          ),\n        ]\n      : []),\n  ],\n  resolve: {\n    alias: {\n      \"@\": path.resolve(import.meta.dirname, \"client\", \"src\"),\n      \"@shared\": path.resolve(import.meta.dirname, \"shared\"),\n      \"@assets\": path.resolve(import.meta.dirname, \"attached_assets\"),\n    },\n  },\n  root: path.resolve(import.meta.dirname, \"client\"),\n  build: {\n    outDir: path.resolve(import.meta.dirname, \"dist/public\"),\n    emptyOutDir: true,\n  },\n  server: {\n    fs: {\n      strict: true,\n      deny: [\"**/.*\"],\n    },\n  },\n});\n","path":null,"size_bytes":1080,"size_tokens":null},"client/src/components/ui/switch.tsx":{"content":"import * as React from \"react\"\nimport * as SwitchPrimitives from \"@radix-ui/react-switch\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Switch = React.forwardRef<\n  React.ElementRef<typeof SwitchPrimitives.Root>,\n  React.ComponentPropsWithoutRef<typeof SwitchPrimitives.Root>\n>(({ className, ...props }, ref) => (\n  <SwitchPrimitives.Root\n    className={cn(\n      \"peer inline-flex h-6 w-11 shrink-0 cursor-pointer items-center rounded-full border-2 border-transparent transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:ring-offset-background disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=unchecked]:bg-input\",\n      className\n    )}\n    {...props}\n    ref={ref}\n  >\n    <SwitchPrimitives.Thumb\n      className={cn(\n        \"pointer-events-none block h-5 w-5 rounded-full bg-background shadow-lg ring-0 transition-transform data-[state=checked]:translate-x-5 data-[state=unchecked]:translate-x-0\"\n      )}\n    />\n  </SwitchPrimitives.Root>\n))\nSwitch.displayName = SwitchPrimitives.Root.displayName\n\nexport { Switch }\n","path":null,"size_bytes":1139,"size_tokens":null},"client/src/components/examples/StatusBadgeExample.tsx":{"content":"import { StatusBadge } from \"../StatusBadge\";\n\nexport default function StatusBadgeExample() {\n  return (\n    <div className=\"flex flex-wrap gap-2\">\n      <StatusBadge status=\"pending\" />\n      <StatusBadge status=\"approved\" />\n      <StatusBadge status=\"processing\" />\n      <StatusBadge status=\"completed\" />\n      <StatusBadge status=\"cancelled\" />\n    </div>\n  );\n}\n","path":null,"size_bytes":369,"size_tokens":null},"client/src/components/ui/toggle.tsx":{"content":"import * as React from \"react\"\nimport * as TogglePrimitive from \"@radix-ui/react-toggle\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst toggleVariants = cva(\n  \"inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors hover:bg-muted hover:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=on]:bg-accent data-[state=on]:text-accent-foreground [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0 gap-2\",\n  {\n    variants: {\n      variant: {\n        default: \"bg-transparent\",\n        outline:\n          \"border border-input bg-transparent hover:bg-accent hover:text-accent-foreground\",\n      },\n      size: {\n        default: \"h-10 px-3 min-w-10\",\n        sm: \"h-9 px-2.5 min-w-9\",\n        lg: \"h-11 px-5 min-w-11\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n      size: \"default\",\n    },\n  }\n)\n\nconst Toggle = React.forwardRef<\n  React.ElementRef<typeof TogglePrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof TogglePrimitive.Root> &\n    VariantProps<typeof toggleVariants>\n>(({ className, variant, size, ...props }, ref) => (\n  <TogglePrimitive.Root\n    ref={ref}\n    className={cn(toggleVariants({ variant, size, className }))}\n    {...props}\n  />\n))\n\nToggle.displayName = TogglePrimitive.Root.displayName\n\nexport { Toggle, toggleVariants }\n","path":null,"size_bytes":1527,"size_tokens":null},"client/src/components/CartDrawer.tsx":{"content":"import { Sheet, SheetContent, SheetHeader, SheetTitle, SheetFooter } from \"@/components/ui/sheet\";\nimport { Button } from \"@/components/ui/button\";\nimport { Separator } from \"@/components/ui/separator\";\nimport { useCart } from \"@/contexts/CartContext\";\nimport { Minus, Plus, Trash2, Package, ShoppingCart, Loader2, ArrowRight } from \"lucide-react\";\nimport { useMutation } from \"@tanstack/react-query\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { useLocation } from \"wouter\";\n\ninterface CartDrawerProps {\n  isAuthenticated?: boolean;\n}\n\nexport function CartDrawer({ isAuthenticated = false }: CartDrawerProps) {\n  const { items, isOpen, closeCart, updateQuantity, removeItem, total, clearCart, selectedCustomer } = useCart();\n  const { toast } = useToast();\n  const [, setLocation] = useLocation();\n\n  const formatPrice = (price: number) => {\n    return new Intl.NumberFormat('pt-BR', {\n      style: 'currency',\n      currency: 'BRL'\n    }).format(price);\n  };\n\n  const createOrderMutation = useMutation({\n    mutationFn: async () => {\n      const orderItems = items.map(item => ({\n        productId: parseInt(item.productId),\n        quantity: item.quantity,\n      }));\n      const payload: any = { items: orderItems };\n      if (selectedCustomer) {\n        payload.userId = selectedCustomer.id;\n      }\n      const response = await apiRequest(\"POST\", \"/api/orders\", payload);\n      return response.json();\n    },\n    onSuccess: (data) => {\n      queryClient.invalidateQueries({ queryKey: ['/api/orders'] });\n      clearCart();\n      closeCart();\n      toast({\n        title: \"Orçamento Criado\",\n        description: `Orçamento ${data.orderNumber} foi criado com sucesso.`,\n      });\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Falha no Orçamento\",\n        description: error.message || \"Falha ao criar orçamento. Por favor, tente novamente.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const handleGenerateOrder = () => {\n    createOrderMutation.mutate();\n  };\n\n  const handleContinueCheckout = () => {\n    closeCart();\n    setLocation(\"/checkout\");\n  };\n\n  return (\n    <Sheet open={isOpen} onOpenChange={(open) => !open && closeCart()}>\n      <SheetContent className=\"flex flex-col w-full sm:max-w-lg\">\n        <SheetHeader>\n          <SheetTitle className=\"flex items-center gap-2\">\n            <ShoppingCart className=\"h-5 w-5\" />\n            Carrinho de Compras\n          </SheetTitle>\n        </SheetHeader>\n\n        {items.length === 0 ? (\n          <div className=\"flex-1 flex flex-col items-center justify-center text-center py-8\">\n            <Package className=\"h-16 w-16 text-muted-foreground/50 mb-4\" />\n            <p className=\"text-lg font-medium\">Seu carrinho esta vazio</p>\n            <p className=\"text-sm text-muted-foreground mt-1\">Adicione produtos para continuar</p>\n          </div>\n        ) : (\n          <>\n            <div className=\"flex-1 overflow-auto py-4 space-y-4\">\n              {items.map((item) => (\n                <div \n                  key={item.id} \n                  className=\"flex gap-4 p-3 rounded-lg bg-muted/50\"\n                  data-testid={`cart-item-${item.id}`}\n                >\n                  <div className=\"w-16 h-16 bg-muted rounded-md flex items-center justify-center flex-shrink-0\">\n                    {item.image ? (\n                      <img src={item.image} alt={item.name} className=\"w-full h-full object-cover rounded-md\" />\n                    ) : (\n                      <Package className=\"h-6 w-6 text-muted-foreground/50\" />\n                    )}\n                  </div>\n                  <div className=\"flex-1 min-w-0\">\n                    <p className=\"font-medium text-sm line-clamp-1\">{item.name}</p>\n                    <p className=\"text-xs text-muted-foreground\">{item.sku}</p>\n                    <p className=\"text-sm font-semibold mt-1\">{formatPrice(item.price)}</p>\n                  </div>\n                  <div className=\"flex flex-col items-end gap-2\">\n                    <Button\n                      variant=\"ghost\"\n                      size=\"icon\"\n                      onClick={() => removeItem(item.id)}\n                      data-testid={`button-remove-item-${item.id}`}\n                    >\n                      <Trash2 className=\"h-3 w-3\" />\n                    </Button>\n                    <div className=\"flex items-center gap-1\">\n                      <Button\n                        variant=\"outline\"\n                        size=\"icon\"\n                        onClick={() => updateQuantity(item.id, item.quantity - 1)}\n                        data-testid={`button-decrease-${item.id}`}\n                      >\n                        <Minus className=\"h-3 w-3\" />\n                      </Button>\n                      <span className=\"w-8 text-center text-sm font-medium\">{item.quantity}</span>\n                      <Button\n                        variant=\"outline\"\n                        size=\"icon\"\n                        onClick={() => updateQuantity(item.id, item.quantity + 1)}\n                        data-testid={`button-increase-${item.id}`}\n                      >\n                        <Plus className=\"h-3 w-3\" />\n                      </Button>\n                    </div>\n                  </div>\n                </div>\n              ))}\n            </div>\n\n            <div className=\"space-y-4\">\n              <Separator />\n              <div className=\"flex items-center justify-between\">\n                <span className=\"text-lg font-semibold\">Total</span>\n                <span className=\"text-2xl font-bold text-orange-600 dark:text-orange-500\" data-testid=\"text-cart-total\">\n                  {formatPrice(total)}\n                </span>\n              </div>\n              <SheetFooter className=\"gap-2 sm:gap-2\">\n                <Button variant=\"outline\" onClick={clearCart} className=\"flex-1\" data-testid=\"button-clear-cart\">\n                  Limpar\n                </Button>\n                {isAuthenticated ? (\n                  <Button \n                    onClick={handleGenerateOrder} \n                    className=\"flex-1 bg-orange-500 hover:bg-orange-600\" \n                    disabled={createOrderMutation.isPending}\n                    data-testid=\"button-generate-order\"\n                  >\n                    {createOrderMutation.isPending && <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />}\n                    Gerar Orçamento\n                  </Button>\n                ) : (\n                  <Button \n                    onClick={handleContinueCheckout} \n                    className=\"flex-1 bg-orange-500 hover:bg-orange-600\"\n                    data-testid=\"button-continue-checkout\"\n                  >\n                    Continuar\n                    <ArrowRight className=\"h-4 w-4 ml-2\" />\n                  </Button>\n                )}\n              </SheetFooter>\n            </div>\n          </>\n        )}\n      </SheetContent>\n    </Sheet>\n  );\n}\n","path":null,"size_bytes":7036,"size_tokens":null},"client/src/components/examples/UserCardExample.tsx":{"content":"import { UserCard } from \"../UserCard\";\n\n// todo: remove mock functionality\nconst mockUser = {\n  id: \"1\",\n  name: \"John Smith\",\n  email: \"john@clientcorp.com\",\n  company: \"Client Corp\",\n  role: \"customer\" as const,\n  status: \"pending\" as const,\n};\n\nexport default function UserCardExample() {\n  return (\n    <div className=\"max-w-md\">\n      <UserCard\n        user={mockUser}\n        onApprove={(u) => console.log(\"Approve:\", u.name)}\n        onReject={(u) => console.log(\"Reject:\", u.name)}\n        onChangeRole={(u, r) => console.log(\"Change role:\", u.name, \"to\", r)}\n      />\n    </div>\n  );\n}\n","path":null,"size_bytes":596,"size_tokens":null},"client/src/components/ui/tabs.tsx":{"content":"import * as React from \"react\"\nimport * as TabsPrimitive from \"@radix-ui/react-tabs\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Tabs = TabsPrimitive.Root\n\nconst TabsList = React.forwardRef<\n  React.ElementRef<typeof TabsPrimitive.List>,\n  React.ComponentPropsWithoutRef<typeof TabsPrimitive.List>\n>(({ className, ...props }, ref) => (\n  <TabsPrimitive.List\n    ref={ref}\n    className={cn(\n      \"inline-flex h-10 items-center justify-center rounded-md bg-muted p-1 text-muted-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\nTabsList.displayName = TabsPrimitive.List.displayName\n\nconst TabsTrigger = React.forwardRef<\n  React.ElementRef<typeof TabsPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof TabsPrimitive.Trigger>\n>(({ className, ...props }, ref) => (\n  <TabsPrimitive.Trigger\n    ref={ref}\n    className={cn(\n      \"inline-flex items-center justify-center whitespace-nowrap rounded-sm px-3 py-1.5 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=active]:bg-background data-[state=active]:text-foreground data-[state=active]:shadow-sm\",\n      className\n    )}\n    {...props}\n  />\n))\nTabsTrigger.displayName = TabsPrimitive.Trigger.displayName\n\nconst TabsContent = React.forwardRef<\n  React.ElementRef<typeof TabsPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof TabsPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <TabsPrimitive.Content\n    ref={ref}\n    className={cn(\n      \"mt-2 ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2\",\n      className\n    )}\n    {...props}\n  />\n))\nTabsContent.displayName = TabsPrimitive.Content.displayName\n\nexport { Tabs, TabsList, TabsTrigger, TabsContent }\n","path":null,"size_bytes":1883,"size_tokens":null},"client/src/contexts/AuthContext.tsx":{"content":"import { createContext, useContext, type ReactNode } from \"react\";\nimport { useAuth as useReplitAuth } from \"@/hooks/useAuth\";\nimport type { User } from \"@shared/schema\";\n\ninterface AuthContextType {\n  user: User | null;\n  isAuthenticated: boolean;\n  isLoading: boolean;\n  logout: () => void;\n  isAdmin: boolean;\n  isSales: boolean;\n  isCustomer: boolean;\n  isSupplier: boolean;\n  isApproved: boolean;\n}\n\nconst AuthContext = createContext<AuthContextType | undefined>(undefined);\n\nexport function AuthProvider({ children }: { children: ReactNode }) {\n  const { user, isLoading, isAuthenticated } = useReplitAuth();\n\n  const logout = async () => {\n    try {\n      await fetch(\"/api/auth/logout\", { method: \"POST\" });\n    } catch (error) {\n      console.error(\"Logout error:\", error);\n    }\n    window.location.href = \"/\";\n  };\n\n  const isAdmin = user?.role === \"admin\";\n  const isSales = user?.role === \"sales\";\n  const isCustomer = user?.role === \"customer\";\n  const isSupplier = user?.role === \"supplier\";\n  const isApproved = user?.approved || isAdmin;\n\n  return (\n    <AuthContext.Provider\n      value={{\n        user: user || null,\n        isAuthenticated,\n        isLoading,\n        logout,\n        isAdmin,\n        isSales,\n        isCustomer,\n        isSupplier,\n        isApproved,\n      }}\n    >\n      {children}\n    </AuthContext.Provider>\n  );\n}\n\nexport function useAuth() {\n  const context = useContext(AuthContext);\n  if (context === undefined) {\n    throw new Error(\"useAuth must be used within an AuthProvider\");\n  }\n  return context;\n}\n\nexport type { User };\n","path":null,"size_bytes":1575,"size_tokens":null},"client/src/components/ui/hover-card.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as HoverCardPrimitive from \"@radix-ui/react-hover-card\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst HoverCard = HoverCardPrimitive.Root\n\nconst HoverCardTrigger = HoverCardPrimitive.Trigger\n\nconst HoverCardContent = React.forwardRef<\n  React.ElementRef<typeof HoverCardPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof HoverCardPrimitive.Content>\n>(({ className, align = \"center\", sideOffset = 4, ...props }, ref) => (\n  <HoverCardPrimitive.Content\n    ref={ref}\n    align={align}\n    sideOffset={sideOffset}\n    className={cn(\n      \"z-50 w-64 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-hover-card-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nHoverCardContent.displayName = HoverCardPrimitive.Content.displayName\n\nexport { HoverCard, HoverCardTrigger, HoverCardContent }\n","path":null,"size_bytes":1251,"size_tokens":null},"client/src/components/examples/ProductGridExample.tsx":{"content":"import { ProductGrid } from \"../ProductGrid\";\n\nconst mockProducts = [\n  { id: \"1\", name: \"Industrial Bearing Set\", sku: \"BRG-001\", category: \"Machinery\", brand: \"TechParts\", price: 149.99, stock: 25 },\n  { id: \"2\", name: \"Hydraulic Pump Motor\", sku: \"HYD-102\", category: \"Hydraulics\", brand: \"FlowMax\", price: 599.00, stock: 8 },\n  { id: \"3\", name: \"Steel Cable 10m\", sku: \"CBL-203\", category: \"Materials\", brand: \"SteelCo\", price: 45.50, stock: 120 },\n  { id: \"4\", name: \"Safety Valve Kit\", sku: \"VLV-304\", category: \"Safety\", brand: \"SafeFlow\", price: 89.99, stock: 0 },\n];\n\nexport default function ProductGridExample() {\n  return (\n    <ProductGrid\n      products={mockProducts}\n      onAddToCart={(p, qty) => console.log(\"Added:\", p.name, \"qty:\", qty)}\n    />\n  );\n}\n","path":null,"size_bytes":771,"size_tokens":null},"client/src/components/ui/toaster.tsx":{"content":"import { useToast } from \"@/hooks/use-toast\"\nimport {\n  Toast,\n  ToastClose,\n  ToastDescription,\n  ToastProvider,\n  ToastTitle,\n  ToastViewport,\n} from \"@/components/ui/toast\"\n\nexport function Toaster() {\n  const { toasts } = useToast()\n\n  return (\n    <ToastProvider>\n      {toasts.map(function ({ id, title, description, action, ...props }) {\n        return (\n          <Toast key={id} {...props}>\n            <div className=\"grid gap-1\">\n              {title && <ToastTitle>{title}</ToastTitle>}\n              {description && (\n                <ToastDescription>{description}</ToastDescription>\n              )}\n            </div>\n            {action}\n            <ToastClose />\n          </Toast>\n        )\n      })}\n      <ToastViewport />\n    </ToastProvider>\n  )\n}\n","path":null,"size_bytes":772,"size_tokens":null},"client/src/contexts/ThemeContext.tsx":{"content":"import { createContext, useContext, useState, useEffect, type ReactNode } from \"react\";\n\ntype Theme = \"light\" | \"dark\";\n\ninterface ThemeContextType {\n  theme: Theme;\n  toggleTheme: () => void;\n  setTheme: (theme: Theme) => void;\n}\n\nconst ThemeContext = createContext<ThemeContextType | undefined>(undefined);\n\nexport function ThemeProvider({ children }: { children: ReactNode }) {\n  const [theme, setThemeState] = useState<Theme>(() => {\n    if (typeof window !== \"undefined\") {\n      const stored = localStorage.getItem(\"theme\") as Theme;\n      if (stored) return stored;\n      return window.matchMedia(\"(prefers-color-scheme: dark)\").matches ? \"dark\" : \"light\";\n    }\n    return \"light\";\n  });\n\n  useEffect(() => {\n    const root = document.documentElement;\n    if (theme === \"dark\") {\n      root.classList.add(\"dark\");\n    } else {\n      root.classList.remove(\"dark\");\n    }\n    localStorage.setItem(\"theme\", theme);\n    \n    // Apply sidebar theme colors\n    const sidebarTheme = localStorage.getItem(\"sidebarTheme\");\n    if (sidebarTheme) {\n      applySidebarTheme(sidebarTheme, theme === \"dark\");\n    }\n  }, [theme]);\n  \n  const applySidebarTheme = (themeId: string, isDark: boolean) => {\n    const themes: Record<string, { primary: string; accent: string; sidebar: string; sidebarDark: string }> = {\n      default: { primary: \"25 95% 53%\", accent: \"25 100% 95%\", sidebar: \"0 0% 98%\", sidebarDark: \"25 30% 10%\" },\n      blue: { primary: \"217 91% 60%\", accent: \"217 100% 95%\", sidebar: \"217 30% 97%\", sidebarDark: \"217 30% 10%\" },\n      green: { primary: \"142 71% 45%\", accent: \"142 100% 95%\", sidebar: \"142 30% 97%\", sidebarDark: \"142 30% 10%\" },\n      purple: { primary: \"262 83% 58%\", accent: \"262 100% 95%\", sidebar: \"262 30% 97%\", sidebarDark: \"262 30% 10%\" },\n      red: { primary: \"0 84% 60%\", accent: \"0 100% 95%\", sidebar: \"0 30% 97%\", sidebarDark: \"0 30% 10%\" },\n      teal: { primary: \"173 80% 40%\", accent: \"173 100% 95%\", sidebar: \"173 30% 97%\", sidebarDark: \"173 30% 10%\" },\n      pink: { primary: \"330 80% 60%\", accent: \"330 100% 95%\", sidebar: \"330 30% 97%\", sidebarDark: \"330 30% 10%\" },\n      amber: { primary: \"45 93% 47%\", accent: \"45 100% 95%\", sidebar: \"45 30% 97%\", sidebarDark: \"45 30% 10%\" },\n    };\n    const config = themes[themeId];\n    if (!config) return;\n    \n    const root = document.documentElement;\n    root.style.setProperty(\"--primary\", config.primary);\n    root.style.setProperty(\"--sidebar\", isDark ? config.sidebarDark : config.sidebar);\n    root.style.setProperty(\"--sidebar-accent\", config.accent);\n    root.style.setProperty(\"--ring\", config.primary);\n  };\n\n  const toggleTheme = () => {\n    setThemeState((prev) => (prev === \"light\" ? \"dark\" : \"light\"));\n  };\n\n  const setTheme = (newTheme: Theme) => {\n    setThemeState(newTheme);\n  };\n\n  return (\n    <ThemeContext.Provider value={{ theme, toggleTheme, setTheme }}>\n      {children}\n    </ThemeContext.Provider>\n  );\n}\n\nexport function useTheme() {\n  const context = useContext(ThemeContext);\n  if (context === undefined) {\n    throw new Error(\"useTheme must be used within a ThemeProvider\");\n  }\n  return context;\n}\n","path":null,"size_bytes":3118,"size_tokens":null},"client/src/components/ui/card.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Card = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\n      \"shadcn-card rounded-xl border bg-card border-card-border text-card-foreground shadow-sm\",\n      className\n    )}\n    {...props}\n  />\n));\nCard.displayName = \"Card\"\n\nconst CardHeader = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"flex flex-col space-y-1.5 p-6\", className)}\n    {...props}\n  />\n));\nCardHeader.displayName = \"CardHeader\"\n\nconst CardTitle = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\n      \"text-2xl font-semibold leading-none tracking-tight\",\n      className\n    )}\n    {...props}\n  />\n))\nCardTitle.displayName = \"CardTitle\"\n\nconst CardDescription = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n));\nCardDescription.displayName = \"CardDescription\"\n\nconst CardContent = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div ref={ref} className={cn(\"p-6 pt-0\", className)} {...props} />\n))\nCardContent.displayName = \"CardContent\"\n\nconst CardFooter = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"flex items-center p-6 pt-0\", className)}\n    {...props}\n  />\n))\nCardFooter.displayName = \"CardFooter\"\nexport {\n  Card,\n  CardHeader,\n  CardFooter,\n  CardTitle,\n  CardDescription,\n  CardContent,\n}\n","path":null,"size_bytes":1904,"size_tokens":null},"client/src/components/ui/toggle-group.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as ToggleGroupPrimitive from \"@radix-ui/react-toggle-group\"\nimport { type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\nimport { toggleVariants } from \"@/components/ui/toggle\"\n\nconst ToggleGroupContext = React.createContext<\n  VariantProps<typeof toggleVariants>\n>({\n  size: \"default\",\n  variant: \"default\",\n})\n\nconst ToggleGroup = React.forwardRef<\n  React.ElementRef<typeof ToggleGroupPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof ToggleGroupPrimitive.Root> &\n    VariantProps<typeof toggleVariants>\n>(({ className, variant, size, children, ...props }, ref) => (\n  <ToggleGroupPrimitive.Root\n    ref={ref}\n    className={cn(\"flex items-center justify-center gap-1\", className)}\n    {...props}\n  >\n    <ToggleGroupContext.Provider value={{ variant, size }}>\n      {children}\n    </ToggleGroupContext.Provider>\n  </ToggleGroupPrimitive.Root>\n))\n\nToggleGroup.displayName = ToggleGroupPrimitive.Root.displayName\n\nconst ToggleGroupItem = React.forwardRef<\n  React.ElementRef<typeof ToggleGroupPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof ToggleGroupPrimitive.Item> &\n    VariantProps<typeof toggleVariants>\n>(({ className, children, variant, size, ...props }, ref) => {\n  const context = React.useContext(ToggleGroupContext)\n\n  return (\n    <ToggleGroupPrimitive.Item\n      ref={ref}\n      className={cn(\n        toggleVariants({\n          variant: context.variant || variant,\n          size: context.size || size,\n        }),\n        className\n      )}\n      {...props}\n    >\n      {children}\n    </ToggleGroupPrimitive.Item>\n  )\n})\n\nToggleGroupItem.displayName = ToggleGroupPrimitive.Item.displayName\n\nexport { ToggleGroup, ToggleGroupItem }\n","path":null,"size_bytes":1753,"size_tokens":null},"client/src/components/ui/dropdown-menu.tsx":{"content":"import * as React from \"react\"\nimport * as DropdownMenuPrimitive from \"@radix-ui/react-dropdown-menu\"\nimport { Check, ChevronRight, Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst DropdownMenu = DropdownMenuPrimitive.Root\n\nconst DropdownMenuTrigger = DropdownMenuPrimitive.Trigger\n\nconst DropdownMenuGroup = DropdownMenuPrimitive.Group\n\nconst DropdownMenuPortal = DropdownMenuPrimitive.Portal\n\nconst DropdownMenuSub = DropdownMenuPrimitive.Sub\n\nconst DropdownMenuRadioGroup = DropdownMenuPrimitive.RadioGroup\n\nconst DropdownMenuSubTrigger = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.SubTrigger>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.SubTrigger> & {\n    inset?: boolean\n  }\n>(({ className, inset, children, ...props }, ref) => (\n  <DropdownMenuPrimitive.SubTrigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent data-[state=open]:bg-accent [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <ChevronRight className=\"ml-auto\" />\n  </DropdownMenuPrimitive.SubTrigger>\n))\nDropdownMenuSubTrigger.displayName =\n  DropdownMenuPrimitive.SubTrigger.displayName\n\nconst DropdownMenuSubContent = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.SubContent>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.SubContent>\n>(({ className, ...props }, ref) => (\n  <DropdownMenuPrimitive.SubContent\n    ref={ref}\n    className={cn(\n      \"z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-dropdown-menu-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nDropdownMenuSubContent.displayName =\n  DropdownMenuPrimitive.SubContent.displayName\n\nconst DropdownMenuContent = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Content>\n>(({ className, sideOffset = 4, ...props }, ref) => (\n  <DropdownMenuPrimitive.Portal>\n    <DropdownMenuPrimitive.Content\n      ref={ref}\n      sideOffset={sideOffset}\n      className={cn(\n        \"z-50 max-h-[var(--radix-dropdown-menu-content-available-height)] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover p-1 text-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-dropdown-menu-content-transform-origin]\",\n        className\n      )}\n      {...props}\n    />\n  </DropdownMenuPrimitive.Portal>\n))\nDropdownMenuContent.displayName = DropdownMenuPrimitive.Content.displayName\n\nconst DropdownMenuItem = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Item> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <DropdownMenuPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nDropdownMenuItem.displayName = DropdownMenuPrimitive.Item.displayName\n\nconst DropdownMenuCheckboxItem = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.CheckboxItem>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.CheckboxItem>\n>(({ className, children, checked, ...props }, ref) => (\n  <DropdownMenuPrimitive.CheckboxItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    checked={checked}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <DropdownMenuPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </DropdownMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </DropdownMenuPrimitive.CheckboxItem>\n))\nDropdownMenuCheckboxItem.displayName =\n  DropdownMenuPrimitive.CheckboxItem.displayName\n\nconst DropdownMenuRadioItem = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.RadioItem>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.RadioItem>\n>(({ className, children, ...props }, ref) => (\n  <DropdownMenuPrimitive.RadioItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <DropdownMenuPrimitive.ItemIndicator>\n        <Circle className=\"h-2 w-2 fill-current\" />\n      </DropdownMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </DropdownMenuPrimitive.RadioItem>\n))\nDropdownMenuRadioItem.displayName = DropdownMenuPrimitive.RadioItem.displayName\n\nconst DropdownMenuLabel = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Label> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <DropdownMenuPrimitive.Label\n    ref={ref}\n    className={cn(\n      \"px-2 py-1.5 text-sm font-semibold\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nDropdownMenuLabel.displayName = DropdownMenuPrimitive.Label.displayName\n\nconst DropdownMenuSeparator = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <DropdownMenuPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-muted\", className)}\n    {...props}\n  />\n))\nDropdownMenuSeparator.displayName = DropdownMenuPrimitive.Separator.displayName\n\nconst DropdownMenuShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\"ml-auto text-xs tracking-widest opacity-60\", className)}\n      {...props}\n    />\n  )\n}\nDropdownMenuShortcut.displayName = \"DropdownMenuShortcut\"\n\nexport {\n  DropdownMenu,\n  DropdownMenuTrigger,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuCheckboxItem,\n  DropdownMenuRadioItem,\n  DropdownMenuLabel,\n  DropdownMenuSeparator,\n  DropdownMenuShortcut,\n  DropdownMenuGroup,\n  DropdownMenuPortal,\n  DropdownMenuSub,\n  DropdownMenuSubContent,\n  DropdownMenuSubTrigger,\n  DropdownMenuRadioGroup,\n}\n","path":null,"size_bytes":7601,"size_tokens":null},"client/src/contexts/CartContext.tsx":{"content":"import { createContext, useContext, useState, useCallback, useEffect, type ReactNode } from \"react\";\n\nconst CART_STORAGE_KEY = \"lojamadrugadao_cart\";\n\nexport interface CartItem {\n  id: string;\n  productId: string;\n  name: string;\n  sku: string;\n  price: number;\n  quantity: number;\n  image?: string;\n}\n\nexport interface SelectedCustomer {\n  id: string;\n  name: string;\n}\n\ninterface CartContextType {\n  items: CartItem[];\n  addItem: (item: Omit<CartItem, \"id\">) => void;\n  removeItem: (id: string) => void;\n  updateQuantity: (id: string, quantity: number) => void;\n  clearCart: () => void;\n  total: number;\n  itemCount: number;\n  isOpen: boolean;\n  openCart: () => void;\n  closeCart: () => void;\n  selectedCustomer: SelectedCustomer | null;\n  setSelectedCustomer: (customer: SelectedCustomer | null) => void;\n}\n\nconst CartContext = createContext<CartContextType | undefined>(undefined);\n\nfunction loadCartFromStorage(): CartItem[] {\n  try {\n    const stored = localStorage.getItem(CART_STORAGE_KEY);\n    if (stored) {\n      const parsed = JSON.parse(stored);\n      if (Array.isArray(parsed)) {\n        return parsed;\n      }\n    }\n  } catch (e) {\n    console.error(\"Failed to load cart from storage:\", e);\n  }\n  return [];\n}\n\nfunction saveCartToStorage(items: CartItem[]) {\n  try {\n    localStorage.setItem(CART_STORAGE_KEY, JSON.stringify(items));\n  } catch (e) {\n    console.error(\"Failed to save cart to storage:\", e);\n  }\n}\n\nexport function CartProvider({ children }: { children: ReactNode }) {\n  const [items, setItems] = useState<CartItem[]>(() => loadCartFromStorage());\n  const [isOpen, setIsOpen] = useState(false);\n  const [selectedCustomer, setSelectedCustomer] = useState<SelectedCustomer | null>(null);\n\n  useEffect(() => {\n    saveCartToStorage(items);\n  }, [items]);\n\n  const addItem = useCallback((item: Omit<CartItem, \"id\">) => {\n    setItems((prev) => {\n      const existing = prev.find((i) => i.productId === item.productId);\n      if (existing) {\n        return prev.map((i) =>\n          i.productId === item.productId\n            ? { ...i, quantity: i.quantity + item.quantity }\n            : i\n        );\n      }\n      return [...prev, { ...item, id: crypto.randomUUID() }];\n    });\n  }, []);\n\n  const removeItem = useCallback((id: string) => {\n    setItems((prev) => prev.filter((i) => i.id !== id));\n  }, []);\n\n  const updateQuantity = useCallback((id: string, quantity: number) => {\n    if (quantity <= 0) {\n      setItems((prev) => prev.filter((i) => i.id !== id));\n    } else {\n      setItems((prev) =>\n        prev.map((i) => (i.id === id ? { ...i, quantity } : i))\n      );\n    }\n  }, []);\n\n  const clearCart = useCallback(() => {\n    setItems([]);\n    setSelectedCustomer(null);\n  }, []);\n\n  const total = items.reduce((sum, item) => sum + item.price * item.quantity, 0);\n  const itemCount = items.reduce((sum, item) => sum + item.quantity, 0);\n\n  const openCart = useCallback(() => setIsOpen(true), []);\n  const closeCart = useCallback(() => setIsOpen(false), []);\n\n  return (\n    <CartContext.Provider\n      value={{\n        items,\n        addItem,\n        removeItem,\n        updateQuantity,\n        clearCart,\n        total,\n        itemCount,\n        isOpen,\n        openCart,\n        closeCart,\n        selectedCustomer,\n        setSelectedCustomer,\n      }}\n    >\n      {children}\n    </CartContext.Provider>\n  );\n}\n\nexport function useCart() {\n  const context = useContext(CartContext);\n  if (context === undefined) {\n    throw new Error(\"useCart must be used within a CartProvider\");\n  }\n  return context;\n}\n","path":null,"size_bytes":3546,"size_tokens":null},"server/static.ts":{"content":"import express, { type Express } from \"express\";\nimport fs from \"fs\";\nimport path from \"path\";\n\nexport function serveStatic(app: Express) {\n  const distPath = path.resolve(__dirname, \"public\");\n  if (!fs.existsSync(distPath)) {\n    throw new Error(\n      `Could not find the build directory: ${distPath}, make sure to build the client first`,\n    );\n  }\n\n  app.use(express.static(distPath));\n\n  // fall through to index.html if the file doesn't exist\n  app.use(\"*\", (_req, res) => {\n    res.sendFile(path.resolve(distPath, \"index.html\"));\n  });\n}\n","path":null,"size_bytes":547,"size_tokens":null},"client/src/lib/authUtils.ts":{"content":"export function isUnauthorizedError(error: Error): boolean {\n  return /^401: .*Unauthorized/.test(error.message);\n}\n","path":null,"size_bytes":116,"size_tokens":null},"client/src/components/ui/dialog.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as DialogPrimitive from \"@radix-ui/react-dialog\"\nimport { X } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Dialog = DialogPrimitive.Root\n\nconst DialogTrigger = DialogPrimitive.Trigger\n\nconst DialogPortal = DialogPrimitive.Portal\n\nconst DialogClose = DialogPrimitive.Close\n\nconst DialogOverlay = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <DialogPrimitive.Overlay\n    ref={ref}\n    className={cn(\n      \"fixed inset-0 z-50 bg-black/80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0\",\n      className\n    )}\n    {...props}\n  />\n))\nDialogOverlay.displayName = DialogPrimitive.Overlay.displayName\n\nconst DialogContent = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Content>\n>(({ className, children, ...props }, ref) => (\n  <DialogPortal>\n    <DialogOverlay />\n    <DialogPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg\",\n        className\n      )}\n      {...props}\n    >\n      {children}\n      <DialogPrimitive.Close className=\"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-accent data-[state=open]:text-muted-foreground\">\n        <X className=\"h-4 w-4\" />\n        <span className=\"sr-only\">Close</span>\n      </DialogPrimitive.Close>\n    </DialogPrimitive.Content>\n  </DialogPortal>\n))\nDialogContent.displayName = DialogPrimitive.Content.displayName\n\nconst DialogHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col space-y-1.5 text-center sm:text-left\",\n      className\n    )}\n    {...props}\n  />\n)\nDialogHeader.displayName = \"DialogHeader\"\n\nconst DialogFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2\",\n      className\n    )}\n    {...props}\n  />\n)\nDialogFooter.displayName = \"DialogFooter\"\n\nconst DialogTitle = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <DialogPrimitive.Title\n    ref={ref}\n    className={cn(\n      \"text-lg font-semibold leading-none tracking-tight\",\n      className\n    )}\n    {...props}\n  />\n))\nDialogTitle.displayName = DialogPrimitive.Title.displayName\n\nconst DialogDescription = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <DialogPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nDialogDescription.displayName = DialogPrimitive.Description.displayName\n\nexport {\n  Dialog,\n  DialogPortal,\n  DialogOverlay,\n  DialogClose,\n  DialogTrigger,\n  DialogContent,\n  DialogHeader,\n  DialogFooter,\n  DialogTitle,\n  DialogDescription,\n}\n","path":null,"size_bytes":3848,"size_tokens":null},"client/src/components/CatalogFilters.tsx":{"content":"import { Input } from \"@/components/ui/input\";\nimport { Button } from \"@/components/ui/button\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport { Search, X, SlidersHorizontal } from \"lucide-react\";\nimport { Badge } from \"@/components/ui/badge\";\n\ninterface CatalogFiltersProps {\n  searchQuery: string;\n  onSearchChange: (query: string) => void;\n  category: string;\n  onCategoryChange: (category: string) => void;\n  brand: string;\n  onBrandChange: (brand: string) => void;\n  categories: string[];\n  brands: string[];\n  onClearFilters: () => void;\n}\n\nexport function CatalogFilters({\n  searchQuery,\n  onSearchChange,\n  category,\n  onCategoryChange,\n  brand,\n  onBrandChange,\n  categories,\n  brands,\n  onClearFilters,\n}: CatalogFiltersProps) {\n  const hasFilters = searchQuery || category !== \"all\" || brand !== \"all\";\n  const activeFiltersCount = [\n    searchQuery ? 1 : 0,\n    category !== \"all\" ? 1 : 0,\n    brand !== \"all\" ? 1 : 0,\n  ].reduce((a, b) => a + b, 0);\n\n  return (\n    <div className=\"space-y-3\">\n      <div className=\"flex flex-col sm:flex-row gap-3\">\n        <div className=\"relative flex-1\">\n          <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\n          <Input\n            placeholder=\"Buscar por nome ou código...\"\n            value={searchQuery}\n            onChange={(e) => onSearchChange(e.target.value)}\n            className=\"pl-9 h-10\"\n            data-testid=\"input-search-products\"\n          />\n        </div>\n        <div className=\"flex gap-2 flex-wrap\">\n          <Select value={category} onValueChange={onCategoryChange}>\n            <SelectTrigger className=\"w-[160px] h-10\" data-testid=\"select-category\">\n              <SelectValue placeholder=\"Categoria\" />\n            </SelectTrigger>\n            <SelectContent>\n              <SelectItem value=\"all\">Todas Categorias</SelectItem>\n              {categories.map((cat) => (\n                <SelectItem key={cat} value={cat}>{cat}</SelectItem>\n              ))}\n            </SelectContent>\n          </Select>\n          <Select value={brand} onValueChange={onBrandChange}>\n            <SelectTrigger className=\"w-[160px] h-10\" data-testid=\"select-brand\">\n              <SelectValue placeholder=\"Marca\" />\n            </SelectTrigger>\n            <SelectContent>\n              <SelectItem value=\"all\">Todas Marcas</SelectItem>\n              {brands.map((b) => (\n                <SelectItem key={b} value={b}>{b}</SelectItem>\n              ))}\n            </SelectContent>\n          </Select>\n          {hasFilters && (\n            <Button variant=\"outline\" size=\"default\" onClick={onClearFilters} className=\"gap-1 h-10\" data-testid=\"button-clear-filters\">\n              <X className=\"h-4 w-4\" />\n              Limpar\n              {activeFiltersCount > 0 && (\n                <Badge variant=\"secondary\" className=\"ml-1 h-5 px-1.5 text-xs\">\n                  {activeFiltersCount}\n                </Badge>\n              )}\n            </Button>\n          )}\n        </div>\n      </div>\n      \n      {hasFilters && (\n        <div className=\"flex items-center gap-2 flex-wrap\">\n          <SlidersHorizontal className=\"h-3.5 w-3.5 text-muted-foreground\" />\n          <span className=\"text-xs text-muted-foreground\">Filtros ativos:</span>\n          {searchQuery && (\n            <Badge variant=\"outline\" className=\"text-xs gap-1\">\n              Busca: \"{searchQuery}\"\n              <button onClick={() => onSearchChange(\"\")} className=\"ml-1 hover:text-destructive\">\n                <X className=\"h-3 w-3\" />\n              </button>\n            </Badge>\n          )}\n          {category !== \"all\" && (\n            <Badge variant=\"outline\" className=\"text-xs gap-1\">\n              {category}\n              <button onClick={() => onCategoryChange(\"all\")} className=\"ml-1 hover:text-destructive\">\n                <X className=\"h-3 w-3\" />\n              </button>\n            </Badge>\n          )}\n          {brand !== \"all\" && (\n            <Badge variant=\"outline\" className=\"text-xs gap-1\">\n              {brand}\n              <button onClick={() => onBrandChange(\"all\")} className=\"ml-1 hover:text-destructive\">\n                <X className=\"h-3 w-3\" />\n              </button>\n            </Badge>\n          )}\n        </div>\n      )}\n    </div>\n  );\n}\n","path":null,"size_bytes":4353,"size_tokens":null},"script/build.ts":{"content":"import { build as esbuild } from \"esbuild\";\nimport { build as viteBuild } from \"vite\";\nimport { rm, readFile } from \"fs/promises\";\n\n// server deps to bundle to reduce openat(2) syscalls\n// which helps cold start times\nconst allowlist = [\n  \"@google/generative-ai\",\n  \"axios\",\n  \"connect-pg-simple\",\n  \"cors\",\n  \"date-fns\",\n  \"drizzle-orm\",\n  \"drizzle-zod\",\n  \"express\",\n  \"express-rate-limit\",\n  \"express-session\",\n  \"jsonwebtoken\",\n  \"memorystore\",\n  \"multer\",\n  \"nanoid\",\n  \"nodemailer\",\n  \"openai\",\n  \"passport\",\n  \"passport-local\",\n  \"pg\",\n  \"stripe\",\n  \"uuid\",\n  \"ws\",\n  \"xlsx\",\n  \"zod\",\n  \"zod-validation-error\",\n];\n\nasync function buildAll() {\n  await rm(\"dist\", { recursive: true, force: true });\n\n  console.log(\"building client...\");\n  await viteBuild();\n\n  console.log(\"building server...\");\n  const pkg = JSON.parse(await readFile(\"package.json\", \"utf-8\"));\n  const allDeps = [\n    ...Object.keys(pkg.dependencies || {}),\n    ...Object.keys(pkg.devDependencies || {}),\n  ];\n  const externals = allDeps.filter((dep) => !allowlist.includes(dep));\n\n  await esbuild({\n    entryPoints: [\"server/index.ts\"],\n    platform: \"node\",\n    bundle: true,\n    format: \"cjs\",\n    outfile: \"dist/index.cjs\",\n    define: {\n      \"process.env.NODE_ENV\": '\"production\"',\n    },\n    minify: true,\n    external: externals,\n    logLevel: \"info\",\n  });\n}\n\nbuildAll().catch((err) => {\n  console.error(err);\n  process.exit(1);\n});\n","path":null,"size_bytes":1417,"size_tokens":null},"client/src/components/ui/chart.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as RechartsPrimitive from \"recharts\"\n\nimport { cn } from \"@/lib/utils\"\n\n// Format: { THEME_NAME: CSS_SELECTOR }\nconst THEMES = { light: \"\", dark: \".dark\" } as const\n\nexport type ChartConfig = {\n  [k in string]: {\n    label?: React.ReactNode\n    icon?: React.ComponentType\n  } & (\n    | { color?: string; theme?: never }\n    | { color?: never; theme: Record<keyof typeof THEMES, string> }\n  )\n}\n\ntype ChartContextProps = {\n  config: ChartConfig\n}\n\nconst ChartContext = React.createContext<ChartContextProps | null>(null)\n\nfunction useChart() {\n  const context = React.useContext(ChartContext)\n\n  if (!context) {\n    throw new Error(\"useChart must be used within a <ChartContainer />\")\n  }\n\n  return context\n}\n\nconst ChartContainer = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\"> & {\n    config: ChartConfig\n    children: React.ComponentProps<\n      typeof RechartsPrimitive.ResponsiveContainer\n    >[\"children\"]\n  }\n>(({ id, className, children, config, ...props }, ref) => {\n  const uniqueId = React.useId()\n  const chartId = `chart-${id || uniqueId.replace(/:/g, \"\")}`\n\n  return (\n    <ChartContext.Provider value={{ config }}>\n      <div\n        data-chart={chartId}\n        ref={ref}\n        className={cn(\n          \"flex aspect-video justify-center text-xs [&_.recharts-cartesian-axis-tick_text]:fill-muted-foreground [&_.recharts-cartesian-grid_line[stroke='#ccc']]:stroke-border/50 [&_.recharts-curve.recharts-tooltip-cursor]:stroke-border [&_.recharts-dot[stroke='#fff']]:stroke-transparent [&_.recharts-layer]:outline-none [&_.recharts-polar-grid_[stroke='#ccc']]:stroke-border [&_.recharts-radial-bar-background-sector]:fill-muted [&_.recharts-rectangle.recharts-tooltip-cursor]:fill-muted [&_.recharts-reference-line_[stroke='#ccc']]:stroke-border [&_.recharts-sector[stroke='#fff']]:stroke-transparent [&_.recharts-sector]:outline-none [&_.recharts-surface]:outline-none\",\n          className\n        )}\n        {...props}\n      >\n        <ChartStyle id={chartId} config={config} />\n        <RechartsPrimitive.ResponsiveContainer>\n          {children}\n        </RechartsPrimitive.ResponsiveContainer>\n      </div>\n    </ChartContext.Provider>\n  )\n})\nChartContainer.displayName = \"Chart\"\n\nconst ChartStyle = ({ id, config }: { id: string; config: ChartConfig }) => {\n  const colorConfig = Object.entries(config).filter(\n    ([, config]) => config.theme || config.color\n  )\n\n  if (!colorConfig.length) {\n    return null\n  }\n\n  return (\n    <style\n      dangerouslySetInnerHTML={{\n        __html: Object.entries(THEMES)\n          .map(\n            ([theme, prefix]) => `\n${prefix} [data-chart=${id}] {\n${colorConfig\n  .map(([key, itemConfig]) => {\n    const color =\n      itemConfig.theme?.[theme as keyof typeof itemConfig.theme] ||\n      itemConfig.color\n    return color ? `  --color-${key}: ${color};` : null\n  })\n  .join(\"\\n\")}\n}\n`\n          )\n          .join(\"\\n\"),\n      }}\n    />\n  )\n}\n\nconst ChartTooltip = RechartsPrimitive.Tooltip\n\nconst ChartTooltipContent = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<typeof RechartsPrimitive.Tooltip> &\n    React.ComponentProps<\"div\"> & {\n      hideLabel?: boolean\n      hideIndicator?: boolean\n      indicator?: \"line\" | \"dot\" | \"dashed\"\n      nameKey?: string\n      labelKey?: string\n    }\n>(\n  (\n    {\n      active,\n      payload,\n      className,\n      indicator = \"dot\",\n      hideLabel = false,\n      hideIndicator = false,\n      label,\n      labelFormatter,\n      labelClassName,\n      formatter,\n      color,\n      nameKey,\n      labelKey,\n    },\n    ref\n  ) => {\n    const { config } = useChart()\n\n    const tooltipLabel = React.useMemo(() => {\n      if (hideLabel || !payload?.length) {\n        return null\n      }\n\n      const [item] = payload\n      const key = `${labelKey || item?.dataKey || item?.name || \"value\"}`\n      const itemConfig = getPayloadConfigFromPayload(config, item, key)\n      const value =\n        !labelKey && typeof label === \"string\"\n          ? config[label as keyof typeof config]?.label || label\n          : itemConfig?.label\n\n      if (labelFormatter) {\n        return (\n          <div className={cn(\"font-medium\", labelClassName)}>\n            {labelFormatter(value, payload)}\n          </div>\n        )\n      }\n\n      if (!value) {\n        return null\n      }\n\n      return <div className={cn(\"font-medium\", labelClassName)}>{value}</div>\n    }, [\n      label,\n      labelFormatter,\n      payload,\n      hideLabel,\n      labelClassName,\n      config,\n      labelKey,\n    ])\n\n    if (!active || !payload?.length) {\n      return null\n    }\n\n    const nestLabel = payload.length === 1 && indicator !== \"dot\"\n\n    return (\n      <div\n        ref={ref}\n        className={cn(\n          \"grid min-w-[8rem] items-start gap-1.5 rounded-lg border border-border/50 bg-background px-2.5 py-1.5 text-xs shadow-xl\",\n          className\n        )}\n      >\n        {!nestLabel ? tooltipLabel : null}\n        <div className=\"grid gap-1.5\">\n          {payload.map((item, index) => {\n            const key = `${nameKey || item.name || item.dataKey || \"value\"}`\n            const itemConfig = getPayloadConfigFromPayload(config, item, key)\n            const indicatorColor = color || item.payload.fill || item.color\n\n            return (\n              <div\n                key={item.dataKey}\n                className={cn(\n                  \"flex w-full flex-wrap items-stretch gap-2 [&>svg]:h-2.5 [&>svg]:w-2.5 [&>svg]:text-muted-foreground\",\n                  indicator === \"dot\" && \"items-center\"\n                )}\n              >\n                {formatter && item?.value !== undefined && item.name ? (\n                  formatter(item.value, item.name, item, index, item.payload)\n                ) : (\n                  <>\n                    {itemConfig?.icon ? (\n                      <itemConfig.icon />\n                    ) : (\n                      !hideIndicator && (\n                        <div\n                          className={cn(\n                            \"shrink-0 rounded-[2px] border-[--color-border] bg-[--color-bg]\",\n                            {\n                              \"h-2.5 w-2.5\": indicator === \"dot\",\n                              \"w-1\": indicator === \"line\",\n                              \"w-0 border-[1.5px] border-dashed bg-transparent\":\n                                indicator === \"dashed\",\n                              \"my-0.5\": nestLabel && indicator === \"dashed\",\n                            }\n                          )}\n                          style={\n                            {\n                              \"--color-bg\": indicatorColor,\n                              \"--color-border\": indicatorColor,\n                            } as React.CSSProperties\n                          }\n                        />\n                      )\n                    )}\n                    <div\n                      className={cn(\n                        \"flex flex-1 justify-between leading-none\",\n                        nestLabel ? \"items-end\" : \"items-center\"\n                      )}\n                    >\n                      <div className=\"grid gap-1.5\">\n                        {nestLabel ? tooltipLabel : null}\n                        <span className=\"text-muted-foreground\">\n                          {itemConfig?.label || item.name}\n                        </span>\n                      </div>\n                      {item.value && (\n                        <span className=\"font-mono font-medium tabular-nums text-foreground\">\n                          {item.value.toLocaleString()}\n                        </span>\n                      )}\n                    </div>\n                  </>\n                )}\n              </div>\n            )\n          })}\n        </div>\n      </div>\n    )\n  }\n)\nChartTooltipContent.displayName = \"ChartTooltip\"\n\nconst ChartLegend = RechartsPrimitive.Legend\n\nconst ChartLegendContent = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\"> &\n    Pick<RechartsPrimitive.LegendProps, \"payload\" | \"verticalAlign\"> & {\n      hideIcon?: boolean\n      nameKey?: string\n    }\n>(\n  (\n    { className, hideIcon = false, payload, verticalAlign = \"bottom\", nameKey },\n    ref\n  ) => {\n    const { config } = useChart()\n\n    if (!payload?.length) {\n      return null\n    }\n\n    return (\n      <div\n        ref={ref}\n        className={cn(\n          \"flex items-center justify-center gap-4\",\n          verticalAlign === \"top\" ? \"pb-3\" : \"pt-3\",\n          className\n        )}\n      >\n        {payload.map((item) => {\n          const key = `${nameKey || item.dataKey || \"value\"}`\n          const itemConfig = getPayloadConfigFromPayload(config, item, key)\n\n          return (\n            <div\n              key={item.value}\n              className={cn(\n                \"flex items-center gap-1.5 [&>svg]:h-3 [&>svg]:w-3 [&>svg]:text-muted-foreground\"\n              )}\n            >\n              {itemConfig?.icon && !hideIcon ? (\n                <itemConfig.icon />\n              ) : (\n                <div\n                  className=\"h-2 w-2 shrink-0 rounded-[2px]\"\n                  style={{\n                    backgroundColor: item.color,\n                  }}\n                />\n              )}\n              {itemConfig?.label}\n            </div>\n          )\n        })}\n      </div>\n    )\n  }\n)\nChartLegendContent.displayName = \"ChartLegend\"\n\n// Helper to extract item config from a payload.\nfunction getPayloadConfigFromPayload(\n  config: ChartConfig,\n  payload: unknown,\n  key: string\n) {\n  if (typeof payload !== \"object\" || payload === null) {\n    return undefined\n  }\n\n  const payloadPayload =\n    \"payload\" in payload &&\n    typeof payload.payload === \"object\" &&\n    payload.payload !== null\n      ? payload.payload\n      : undefined\n\n  let configLabelKey: string = key\n\n  if (\n    key in payload &&\n    typeof payload[key as keyof typeof payload] === \"string\"\n  ) {\n    configLabelKey = payload[key as keyof typeof payload] as string\n  } else if (\n    payloadPayload &&\n    key in payloadPayload &&\n    typeof payloadPayload[key as keyof typeof payloadPayload] === \"string\"\n  ) {\n    configLabelKey = payloadPayload[\n      key as keyof typeof payloadPayload\n    ] as string\n  }\n\n  return configLabelKey in config\n    ? config[configLabelKey]\n    : config[key as keyof typeof config]\n}\n\nexport {\n  ChartContainer,\n  ChartTooltip,\n  ChartTooltipContent,\n  ChartLegend,\n  ChartLegendContent,\n  ChartStyle,\n}\n","path":null,"size_bytes":10481,"size_tokens":null},"client/src/components/ui/aspect-ratio.tsx":{"content":"import * as AspectRatioPrimitive from \"@radix-ui/react-aspect-ratio\"\n\nconst AspectRatio = AspectRatioPrimitive.Root\n\nexport { AspectRatio }\n","path":null,"size_bytes":140,"size_tokens":null},"client/src/components/ProductGrid.tsx":{"content":"import { ProductCard, type Product } from \"./ProductCard\";\nimport { Package } from \"lucide-react\";\n\ninterface ProductGridProps {\n  products: Product[];\n  onAddToCart?: (product: Product, quantity: number) => void;\n  showPrice?: boolean;\n}\n\nexport function ProductGrid({ products, onAddToCart, showPrice = true }: ProductGridProps) {\n  if (products.length === 0) {\n    return (\n      <div className=\"flex flex-col items-center justify-center py-20 text-center\">\n        <div className=\"w-20 h-20 rounded-full bg-muted/50 flex items-center justify-center mb-4\">\n          <Package className=\"h-10 w-10 text-muted-foreground/50\" />\n        </div>\n        <p className=\"text-lg font-medium\">Nenhum produto encontrado</p>\n        <p className=\"text-sm text-muted-foreground mt-1\">Tente ajustar seus filtros de busca</p>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-3\" data-testid=\"grid-products\">\n      {products.map((product) => (\n        <ProductCard\n          key={product.id}\n          product={product}\n          onAddToCart={onAddToCart}\n          showPrice={showPrice}\n        />\n      ))}\n    </div>\n  );\n}\n","path":null,"size_bytes":1202,"size_tokens":null},"client/src/components/ui/popover.tsx":{"content":"import * as React from \"react\"\nimport * as PopoverPrimitive from \"@radix-ui/react-popover\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Popover = PopoverPrimitive.Root\n\nconst PopoverTrigger = PopoverPrimitive.Trigger\n\nconst PopoverContent = React.forwardRef<\n  React.ElementRef<typeof PopoverPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof PopoverPrimitive.Content>\n>(({ className, align = \"center\", sideOffset = 4, ...props }, ref) => (\n  <PopoverPrimitive.Portal>\n    <PopoverPrimitive.Content\n      ref={ref}\n      align={align}\n      sideOffset={sideOffset}\n      className={cn(\n        \"z-50 w-72 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-popover-content-transform-origin]\",\n        className\n      )}\n      {...props}\n    />\n  </PopoverPrimitive.Portal>\n))\nPopoverContent.displayName = PopoverPrimitive.Content.displayName\n\nexport { Popover, PopoverTrigger, PopoverContent }\n","path":null,"size_bytes":1280,"size_tokens":null},"client/src/pages/dashboard.tsx":{"content":"import { useState } from \"react\";\nimport { StatCard } from \"@/components/StatCard\";\nimport { OrderTable, type Order } from \"@/components/OrderTable\";\nimport { useAuth } from \"@/contexts/AuthContext\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { ShoppingCart, Package, ClipboardList, Users, ArrowRight, Loader2, TrendingUp, DollarSign, Calendar, BarChart3, PieChart as PieChartIcon, Crown, Award, AlertTriangle, RefreshCw } from \"lucide-react\";\nimport { Link } from \"wouter\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport type { Order as SchemaOrder, Product, User } from \"@shared/schema\";\nimport { format } from \"date-fns\";\nimport { ptBR } from \"date-fns/locale\";\nimport { BarChart, Bar, XAxis, YAxis, Tooltip, ResponsiveContainer, PieChart, Pie, Cell, LineChart, Line, Legend } from \"recharts\";\nimport { CustomerMap } from \"@/components/CustomerMap\";\n\ninterface OrderWithItems extends SchemaOrder {\n  items?: { id: number; quantity: number }[];\n}\n\ninterface PurchaseStats {\n  totalSpent: number;\n  totalOrders: number;\n  completedOrders: number;\n  monthlyStats: Array<{ month: string; total: number; count: number }>;\n  topProducts: Array<{ productId: number; name: string; totalQuantity: number; totalValue: number }>;\n  lastMonthProducts: Array<{ productId: number; name: string; quantity: number; totalValue: number }>;\n}\n\ninterface AdminSalesStats {\n  totalRevenue: number;\n  totalCost: number;\n  totalProfit: number;\n  totalOrders: number;\n  completedOrders: number;\n  pendingOrders: number;\n  averageOrderValue: number;\n  monthlyRevenue: Array<{ month: string; revenue: number; orders: number }>;\n  topProducts: Array<{ productId: number; name: string; totalQuantity: number; totalValue: number }>;\n  ordersByStatus: Array<{ status: string; count: number }>;\n  dailySales: Array<{ day: string; revenue: number; orders: number }>;\n  salesByCategory: Array<{ categoryId: number; categoryName: string; totalValue: number; totalQuantity: number }>;\n  customerPositivation: { totalCustomers: number; activeThisPeriod: number; newThisPeriod: number };\n  salesEvolution: Array<{ month: string; revenue: number; orders: number; avgTicket: number }>;\n  periodLabel: string;\n}\n\ntype PeriodFilter = 'day' | 'week' | 'month' | 'year' | 'all';\n\ninterface CustomerRanking {\n  userId: string;\n  name: string;\n  company: string | null;\n  email: string | null;\n  totalRevenue: number;\n  orderCount: number;\n  avgTicket: number;\n  lastOrderDate: string | null;\n  daysSinceLastOrder: number;\n}\n\ninterface InactiveCustomer {\n  userId: string;\n  name: string;\n  company: string | null;\n  email: string | null;\n  lastOrderDate: string;\n  daysSinceLastOrder: number;\n  churnRisk: 'low' | 'medium' | 'high';\n  totalSpent: number;\n  orderCount: number;\n}\n\ninterface ConversionMetric {\n  userId: string;\n  name: string;\n  company: string | null;\n  email: string | null;\n  totalQuotes: number;\n  convertedOrders: number;\n  conversionRate: number;\n  totalRevenue: number;\n}\n\ninterface CustomerAnalyticsData {\n  topCustomersByRevenue: {\n    month: CustomerRanking[];\n    quarter: CustomerRanking[];\n    year: CustomerRanking[];\n  };\n  topCustomersByFrequency: CustomerRanking[];\n  inactiveCustomers: {\n    days7: InactiveCustomer[];\n    days15: InactiveCustomer[];\n    days30: InactiveCustomer[];\n    days60: InactiveCustomer[];\n    days90: InactiveCustomer[];\n  };\n  newCustomersThisMonth: CustomerRanking[];\n  conversionMetrics: ConversionMetric[];\n}\n\nconst STATUS_LABELS: Record<string, string> = {\n  'ORCAMENTO_ABERTO': 'Orçamento Aberto',\n  'ORCAMENTO_CONCLUIDO': 'Orçamento Concluído',\n  'PEDIDO_GERADO': 'Pedido Gerado',\n  'PEDIDO_FATURADO': 'Pedido Faturado',\n  'pending': 'Pendente',\n  'completed': 'Concluído',\n  'cancelled': 'Cancelado',\n};\n\nconst STATUS_COLORS = ['hsl(var(--chart-1))', 'hsl(var(--chart-2))', 'hsl(var(--chart-3))', 'hsl(var(--chart-4))', 'hsl(var(--chart-5))'];\n\nfunction formatMonthLabel(monthStr: string): string {\n  const [year, month] = monthStr.split('-');\n  const date = new Date(parseInt(year), parseInt(month) - 1, 1);\n  return format(date, \"MMM yyyy\", { locale: ptBR });\n}\n\nexport default function DashboardPage() {\n  const { user, isAdmin, isSales } = useAuth();\n  const showAllOrders = isAdmin || isSales;\n  const isCustomer = !isAdmin && !isSales;\n  const [periodFilter, setPeriodFilter] = useState<PeriodFilter>('month');\n\n  const { data: ordersData = [], isLoading: ordersLoading } = useQuery<OrderWithItems[]>({\n    queryKey: ['/api/orders'],\n  });\n\n  const { data: productsData = [], isLoading: productsLoading } = useQuery<Product[]>({\n    queryKey: ['/api/products'],\n    enabled: isAdmin,\n  });\n\n  const { data: usersData = [], isLoading: usersLoading } = useQuery<User[]>({\n    queryKey: ['/api/users'],\n    enabled: isAdmin,\n  });\n\n  const { data: purchaseStats, isLoading: statsLoading } = useQuery<PurchaseStats>({\n    queryKey: ['/api/me/purchase-stats'],\n    enabled: isCustomer,\n  });\n\n  const { data: adminStats, isLoading: adminStatsLoading } = useQuery<AdminSalesStats>({\n    queryKey: ['/api/admin/sales-stats', periodFilter],\n    queryFn: async () => {\n      const res = await fetch(`/api/admin/sales-stats?period=${periodFilter}`, { credentials: 'include' });\n      if (!res.ok) throw new Error('Failed to fetch');\n      return res.json();\n    },\n    enabled: isAdmin || isSales,\n  });\n\n  const { data: customerAnalytics, isLoading: customerAnalyticsLoading } = useQuery<CustomerAnalyticsData>({\n    queryKey: ['/api/admin/customer-analytics'],\n    enabled: isAdmin,\n  });\n\n  const recentOrders: Order[] = ordersData.slice(0, 5).map((order) => ({\n    id: String(order.id),\n    orderNumber: order.orderNumber,\n    customer: order.userId.substring(0, 8) + \"...\",\n    date: format(new Date(order.createdAt), \"MMM d, yyyy\"),\n    status: order.status as Order[\"status\"],\n    total: parseFloat(order.total),\n    itemCount: order.items?.length || 0,\n  }));\n\n  const pendingOrdersCount = ordersData.filter(o => o.status === \"pending\" || o.status === \"ORCAMENTO_ABERTO\" || o.status === \"ORCAMENTO_CONCLUIDO\").length;\n  const lastOrderDate = ordersData.length > 0 \n    ? format(new Date(ordersData[0].createdAt), \"dd MMM\", { locale: ptBR })\n    : \"N/A\";\n\n  if (isCustomer) {\n    const predictionTotal = purchaseStats?.lastMonthProducts?.reduce(\n      (sum, p) => sum + p.totalValue, 0\n    ) || 0;\n\n    return (\n      <div className=\"p-6 lg:p-8 space-y-8\">\n        <div>\n          <h1 className=\"text-3xl font-semibold\">Painel</h1>\n          <p className=\"text-muted-foreground mt-1\">Bem-vindo, {user?.firstName || user?.email}</p>\n        </div>\n\n        <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\n          <Card>\n            <CardHeader className=\"pb-3\">\n              <CardTitle className=\"text-lg flex items-center gap-2\">\n                <ShoppingCart className=\"h-5 w-5 text-muted-foreground\" />\n                Produtos Mais Comprados\n              </CardTitle>\n            </CardHeader>\n            <CardContent>\n              {statsLoading ? (\n                <div className=\"flex items-center justify-center py-8\">\n                  <Loader2 className=\"h-6 w-6 animate-spin text-muted-foreground\" />\n                </div>\n              ) : !purchaseStats?.topProducts?.length ? (\n                <p className=\"text-muted-foreground text-sm py-4\">Nenhum produto comprado ainda</p>\n              ) : (\n                <div className=\"space-y-3\">\n                  {purchaseStats.topProducts.map((product, idx) => (\n                    <div key={product.productId} className=\"flex items-center justify-between gap-4\" data-testid={`top-product-${product.productId}`}>\n                      <div className=\"flex items-center gap-3\">\n                        <span className=\"text-muted-foreground text-xs font-medium w-5\">{idx + 1}.</span>\n                        <span className=\"text-sm font-medium truncate max-w-[200px]\">{product.name}</span>\n                      </div>\n                      <div className=\"text-right flex-shrink-0\">\n                        <span className=\"text-sm font-semibold\">{product.totalQuantity} un.</span>\n                        <span className=\"text-xs text-muted-foreground ml-2\">R$ {product.totalValue.toFixed(2)}</span>\n                      </div>\n                    </div>\n                  ))}\n                </div>\n              )}\n            </CardContent>\n          </Card>\n\n          <Card>\n            <CardHeader className=\"pb-3\">\n              <CardTitle className=\"text-lg flex items-center gap-2\">\n                <TrendingUp className=\"h-5 w-5 text-muted-foreground\" />\n                Previsao de Pedido\n              </CardTitle>\n              <p className=\"text-xs text-muted-foreground\">Baseado nas suas compras do mes passado</p>\n            </CardHeader>\n            <CardContent>\n              {statsLoading ? (\n                <div className=\"flex items-center justify-center py-8\">\n                  <Loader2 className=\"h-6 w-6 animate-spin text-muted-foreground\" />\n                </div>\n              ) : !purchaseStats?.lastMonthProducts?.length ? (\n                <p className=\"text-muted-foreground text-sm py-4\">Nenhuma compra no mes passado para gerar previsao</p>\n              ) : (\n                <div className=\"space-y-4\">\n                  <div className=\"space-y-3\">\n                    {purchaseStats.lastMonthProducts.map((product) => (\n                      <div key={product.productId} className=\"flex items-center justify-between gap-4\" data-testid={`prediction-product-${product.productId}`}>\n                        <span className=\"text-sm font-medium truncate max-w-[200px]\">{product.name}</span>\n                        <div className=\"text-right flex-shrink-0\">\n                          <span className=\"text-sm font-semibold\">{product.quantity} un.</span>\n                          <span className=\"text-xs text-muted-foreground ml-2\">R$ {product.totalValue.toFixed(2)}</span>\n                        </div>\n                      </div>\n                    ))}\n                  </div>\n                  <div className=\"pt-3 border-t flex items-center justify-between\">\n                    <span className=\"text-sm font-medium\">Total Estimado</span>\n                    <span className=\"text-lg font-bold\">R$ {predictionTotal.toFixed(2)}</span>\n                  </div>\n                </div>\n              )}\n            </CardContent>\n          </Card>\n        </div>\n\n        <div className=\"flex gap-4\">\n          <Link href=\"/catalog\">\n            <Button data-testid=\"button-browse-catalog\">\n              <Package className=\"h-4 w-4 mr-2\" />\n              Ver Catalogo\n            </Button>\n          </Link>\n          <Link href=\"/orders\">\n            <Button variant=\"outline\" data-testid=\"link-view-all-orders\">\n              <ClipboardList className=\"h-4 w-4 mr-2\" />\n              Ver Pedidos\n            </Button>\n          </Link>\n        </div>\n      </div>\n    );\n  }\n\n  const chartData = adminStats?.monthlyRevenue.map(item => ({\n    month: formatMonthLabel(item.month),\n    revenue: item.revenue,\n    orders: item.orders,\n  })) || [];\n\n  const pieData = adminStats?.ordersByStatus.map(item => ({\n    name: STATUS_LABELS[item.status] || item.status,\n    value: item.count,\n  })) || [];\n\n  return (\n    <div className=\"p-6 lg:p-8 space-y-8\">\n      <div className=\"flex flex-wrap items-center justify-between gap-4\">\n        <div>\n          <h1 className=\"text-3xl font-semibold\">Painel</h1>\n          <p className=\"text-muted-foreground mt-1\">Bem-vindo, {user?.firstName || user?.email}</p>\n        </div>\n        <div className=\"flex items-center gap-2\">\n          <Calendar className=\"h-4 w-4 text-muted-foreground\" />\n          <Select value={periodFilter} onValueChange={(v) => setPeriodFilter(v as PeriodFilter)}>\n            <SelectTrigger className=\"w-[160px]\" data-testid=\"select-period-filter\">\n              <SelectValue placeholder=\"Periodo\" />\n            </SelectTrigger>\n            <SelectContent>\n              <SelectItem value=\"day\">Hoje</SelectItem>\n              <SelectItem value=\"week\">Esta Semana</SelectItem>\n              <SelectItem value=\"month\">Este Mes</SelectItem>\n              <SelectItem value=\"year\">Este Ano</SelectItem>\n              <SelectItem value=\"all\">Todo Periodo</SelectItem>\n            </SelectContent>\n          </Select>\n        </div>\n      </div>\n\n      <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6\">\n        <StatCard\n          title=\"Faturamento Total\"\n          value={adminStatsLoading ? \"...\" : `R$ ${(adminStats?.totalRevenue || 0).toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`}\n          icon={DollarSign}\n          data-testid=\"stat-total-revenue\"\n        />\n        <StatCard\n          title=\"Lucro\"\n          value={adminStatsLoading ? \"...\" : `R$ ${(adminStats?.totalProfit || 0).toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`}\n          icon={TrendingUp}\n          data-testid=\"stat-total-profit\"\n        />\n        <StatCard\n          title=\"Ticket Médio\"\n          value={adminStatsLoading ? \"...\" : `R$ ${(adminStats?.averageOrderValue || 0).toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`}\n          icon={BarChart3}\n          data-testid=\"stat-avg-order\"\n        />\n        <StatCard\n          title=\"Pedidos Pendentes\"\n          value={adminStatsLoading ? \"...\" : adminStats?.pendingOrders || 0}\n          icon={ClipboardList}\n          data-testid=\"stat-pending-orders\"\n        />\n        <StatCard\n          title=\"Pedidos Faturados\"\n          value={adminStatsLoading ? \"...\" : adminStats?.completedOrders || 0}\n          icon={Package}\n          data-testid=\"stat-completed-orders\"\n        />\n      </div>\n\n      {isAdmin && (\n        <div className=\"grid grid-cols-1 md:grid-cols-3 gap-6\">\n          <StatCard\n            title=\"Total de Pedidos\"\n            value={ordersLoading ? \"...\" : ordersData.length}\n            icon={ClipboardList}\n          />\n          <StatCard\n            title=\"Produtos Cadastrados\"\n            value={productsLoading ? \"...\" : productsData.length}\n            icon={Package}\n          />\n          <StatCard\n            title=\"Clientes Cadastrados\"\n            value={usersLoading ? \"...\" : usersData.filter(u => u.role === \"customer\").length}\n            icon={Users}\n          />\n        </div>\n      )}\n\n      {isAdmin && adminStats?.customerPositivation && (\n        <div className=\"grid grid-cols-1 md:grid-cols-3 gap-6\">\n          <Card>\n            <CardHeader className=\"pb-2\">\n              <CardTitle className=\"text-sm font-medium text-muted-foreground\">Total de Clientes</CardTitle>\n            </CardHeader>\n            <CardContent>\n              <div className=\"text-2xl font-bold\" data-testid=\"stat-total-customers\">{adminStats.customerPositivation.totalCustomers}</div>\n              <p className=\"text-xs text-muted-foreground\">Clientes cadastrados</p>\n            </CardContent>\n          </Card>\n          <Card>\n            <CardHeader className=\"pb-2\">\n              <CardTitle className=\"text-sm font-medium text-muted-foreground\">Clientes Ativos ({adminStats.periodLabel})</CardTitle>\n            </CardHeader>\n            <CardContent>\n              <div className=\"text-2xl font-bold text-green-600\" data-testid=\"stat-active-customers\">{adminStats.customerPositivation.activeThisPeriod}</div>\n              <p className=\"text-xs text-muted-foreground\">\n                {adminStats.customerPositivation.totalCustomers > 0 \n                  ? `${((adminStats.customerPositivation.activeThisPeriod / adminStats.customerPositivation.totalCustomers) * 100).toFixed(1)}% positivacao`\n                  : 'Positivacao'}\n              </p>\n            </CardContent>\n          </Card>\n          <Card>\n            <CardHeader className=\"pb-2\">\n              <CardTitle className=\"text-sm font-medium text-muted-foreground\">Clientes Novos ({adminStats.periodLabel})</CardTitle>\n            </CardHeader>\n            <CardContent>\n              <div className=\"text-2xl font-bold text-blue-600\" data-testid=\"stat-new-customers\">{adminStats.customerPositivation.newThisPeriod}</div>\n              <p className=\"text-xs text-muted-foreground\">Novos cadastros</p>\n            </CardContent>\n          </Card>\n        </div>\n      )}\n\n      {isAdmin && <CustomerMap />}\n\n      <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\n        <Card>\n          <CardHeader className=\"pb-3\">\n            <CardTitle className=\"text-lg flex items-center gap-2\">\n              <BarChart3 className=\"h-5 w-5 text-muted-foreground\" />\n              Faturamento Mensal\n            </CardTitle>\n          </CardHeader>\n          <CardContent>\n            {adminStatsLoading ? (\n              <div className=\"flex items-center justify-center py-12\">\n                <Loader2 className=\"h-6 w-6 animate-spin text-muted-foreground\" />\n              </div>\n            ) : chartData.length === 0 ? (\n              <p className=\"text-muted-foreground text-sm py-4\">Nenhum dado disponível</p>\n            ) : (\n              <div className=\"h-[280px]\" data-testid=\"chart-monthly-revenue\">\n                <ResponsiveContainer width=\"100%\" height=\"100%\">\n                  <BarChart data={chartData} margin={{ top: 10, right: 10, left: 0, bottom: 20 }}>\n                    <XAxis dataKey=\"month\" tick={{ fontSize: 12 }} tickLine={false} axisLine={false} />\n                    <YAxis tick={{ fontSize: 12 }} tickLine={false} axisLine={false} tickFormatter={(v) => `R$${(v/1000).toFixed(0)}k`} />\n                    <Tooltip \n                      formatter={(value: number) => [`R$ ${value.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`, 'Faturamento']}\n                      labelStyle={{ color: 'hsl(var(--foreground))' }}\n                      contentStyle={{ backgroundColor: 'hsl(var(--card))', border: '1px solid hsl(var(--border))' }}\n                    />\n                    <Bar dataKey=\"revenue\" fill=\"hsl(var(--primary))\" radius={[4, 4, 0, 0]} />\n                  </BarChart>\n                </ResponsiveContainer>\n              </div>\n            )}\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader className=\"pb-3\">\n            <CardTitle className=\"text-lg flex items-center gap-2\">\n              <PieChartIcon className=\"h-5 w-5 text-muted-foreground\" />\n              Pedidos por Status\n            </CardTitle>\n          </CardHeader>\n          <CardContent>\n            {adminStatsLoading ? (\n              <div className=\"flex items-center justify-center py-12\">\n                <Loader2 className=\"h-6 w-6 animate-spin text-muted-foreground\" />\n              </div>\n            ) : pieData.length === 0 ? (\n              <p className=\"text-muted-foreground text-sm py-4\">Nenhum dado disponível</p>\n            ) : (\n              <div className=\"h-[280px]\" data-testid=\"chart-orders-by-status\">\n                <ResponsiveContainer width=\"100%\" height=\"100%\">\n                  <PieChart>\n                    <Pie\n                      data={pieData}\n                      cx=\"50%\"\n                      cy=\"50%\"\n                      innerRadius={60}\n                      outerRadius={90}\n                      paddingAngle={2}\n                      dataKey=\"value\"\n                      label={({ name, percent }) => `${name} ${(percent * 100).toFixed(0)}%`}\n                      labelLine={false}\n                    >\n                      {pieData.map((_, index) => (\n                        <Cell key={`cell-${index}`} fill={STATUS_COLORS[index % STATUS_COLORS.length]} />\n                      ))}\n                    </Pie>\n                    <Tooltip \n                      formatter={(value: number) => [value, 'Pedidos']}\n                      contentStyle={{ backgroundColor: 'hsl(var(--card))', border: '1px solid hsl(var(--border))' }}\n                    />\n                  </PieChart>\n                </ResponsiveContainer>\n              </div>\n            )}\n          </CardContent>\n        </Card>\n      </div>\n\n      {isAdmin && adminStats?.salesByCategory && adminStats.salesByCategory.length > 0 && (\n        <Card>\n          <CardHeader className=\"pb-3\">\n            <CardTitle className=\"text-lg flex items-center gap-2\">\n              <PieChartIcon className=\"h-5 w-5 text-muted-foreground\" />\n              Vendas por Categoria\n            </CardTitle>\n          </CardHeader>\n          <CardContent>\n            <div className=\"h-[280px]\" data-testid=\"chart-sales-by-category\">\n              <ResponsiveContainer width=\"100%\" height=\"100%\">\n                <PieChart>\n                  <Pie\n                    data={adminStats.salesByCategory.map(c => ({ name: c.categoryName, value: c.totalValue }))}\n                    cx=\"50%\"\n                    cy=\"50%\"\n                    innerRadius={50}\n                    outerRadius={80}\n                    paddingAngle={2}\n                    dataKey=\"value\"\n                    label={({ name, percent }) => `${name.substring(0, 12)}${name.length > 12 ? '...' : ''} ${(percent * 100).toFixed(0)}%`}\n                    labelLine={false}\n                  >\n                    {adminStats.salesByCategory.map((_, index) => (\n                      <Cell key={`cat-${index}`} fill={STATUS_COLORS[index % STATUS_COLORS.length]} />\n                    ))}\n                  </Pie>\n                  <Tooltip \n                    formatter={(value: number) => [`R$ ${value.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`, 'Faturamento']}\n                    contentStyle={{ backgroundColor: 'hsl(var(--card))', border: '1px solid hsl(var(--border))' }}\n                  />\n                </PieChart>\n              </ResponsiveContainer>\n            </div>\n          </CardContent>\n        </Card>\n      )}\n\n      <Card>\n        <CardHeader className=\"pb-3\">\n          <CardTitle className=\"text-lg flex items-center gap-2\">\n            <ShoppingCart className=\"h-5 w-5 text-muted-foreground\" />\n            Produtos Mais Vendidos\n          </CardTitle>\n        </CardHeader>\n        <CardContent>\n          {adminStatsLoading ? (\n            <div className=\"flex items-center justify-center py-8\">\n              <Loader2 className=\"h-6 w-6 animate-spin text-muted-foreground\" />\n            </div>\n          ) : !adminStats?.topProducts?.length ? (\n            <p className=\"text-muted-foreground text-sm py-4\">Nenhum produto vendido ainda</p>\n          ) : (\n            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n              {adminStats.topProducts.map((product, idx) => (\n                <div key={product.productId} className=\"flex items-center justify-between gap-4 p-3 rounded-md bg-muted/50\" data-testid={`admin-top-product-${product.productId}`}>\n                  <div className=\"flex items-center gap-3\">\n                    <span className=\"text-muted-foreground text-sm font-bold w-6\">{idx + 1}.</span>\n                    <span className=\"text-sm font-medium truncate max-w-[180px]\">{product.name}</span>\n                  </div>\n                  <div className=\"text-right flex-shrink-0\">\n                    <span className=\"text-sm font-semibold\">R$ {product.totalValue.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</span>\n                    <span className=\"text-xs text-muted-foreground ml-2\">({product.totalQuantity} un.)</span>\n                  </div>\n                </div>\n              ))}\n            </div>\n          )}\n        </CardContent>\n      </Card>\n\n      {isAdmin && (\n        <div className=\"space-y-6\">\n          <h2 className=\"text-xl font-semibold flex items-center gap-2\">\n            <Users className=\"h-5 w-5 text-muted-foreground\" />\n            Analise de Usuarios\n          </h2>\n          \n          <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\n            <Card>\n              <CardHeader className=\"pb-3\">\n                <CardTitle className=\"text-lg flex items-center gap-2\">\n                  <Crown className=\"h-5 w-5 text-yellow-500\" />\n                  Top Clientes por Faturamento (Mes)\n                </CardTitle>\n              </CardHeader>\n              <CardContent>\n                {customerAnalyticsLoading ? (\n                  <div className=\"flex items-center justify-center py-8\">\n                    <Loader2 className=\"h-6 w-6 animate-spin text-muted-foreground\" />\n                  </div>\n                ) : !customerAnalytics?.topCustomersByRevenue?.month?.length ? (\n                  <p className=\"text-muted-foreground text-sm py-4\">Nenhum dado disponivel</p>\n                ) : (\n                  <div className=\"space-y-3\">\n                    {customerAnalytics.topCustomersByRevenue.month.slice(0, 10).map((customer, idx) => (\n                      <div key={customer.userId} className=\"flex items-center justify-between gap-4 p-2 rounded-md bg-muted/50\" data-testid={`top-customer-revenue-${customer.userId}`}>\n                        <div className=\"flex items-center gap-3\">\n                          <span className={`text-sm font-bold w-6 ${idx < 3 ? 'text-yellow-500' : 'text-muted-foreground'}`}>{idx + 1}.</span>\n                          <div className=\"flex flex-col\">\n                            <span className=\"text-sm font-medium truncate max-w-[160px]\">{customer.company || customer.name}</span>\n                            <span className=\"text-xs text-muted-foreground\">{customer.orderCount} pedidos</span>\n                          </div>\n                        </div>\n                        <div className=\"text-right flex-shrink-0\">\n                          <span className=\"text-sm font-semibold\">R$ {customer.totalRevenue.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</span>\n                        </div>\n                      </div>\n                    ))}\n                  </div>\n                )}\n              </CardContent>\n            </Card>\n\n            <Card>\n              <CardHeader className=\"pb-3\">\n                <CardTitle className=\"text-lg flex items-center gap-2\">\n                  <Award className=\"h-5 w-5 text-blue-500\" />\n                  Top Clientes por Frequencia\n                </CardTitle>\n              </CardHeader>\n              <CardContent>\n                {customerAnalyticsLoading ? (\n                  <div className=\"flex items-center justify-center py-8\">\n                    <Loader2 className=\"h-6 w-6 animate-spin text-muted-foreground\" />\n                  </div>\n                ) : !customerAnalytics?.topCustomersByFrequency?.length ? (\n                  <p className=\"text-muted-foreground text-sm py-4\">Nenhum dado disponivel</p>\n                ) : (\n                  <div className=\"space-y-3\">\n                    {customerAnalytics.topCustomersByFrequency.slice(0, 10).map((customer, idx) => (\n                      <div key={customer.userId} className=\"flex items-center justify-between gap-4 p-2 rounded-md bg-muted/50\" data-testid={`top-customer-frequency-${customer.userId}`}>\n                        <div className=\"flex items-center gap-3\">\n                          <span className={`text-sm font-bold w-6 ${idx < 3 ? 'text-blue-500' : 'text-muted-foreground'}`}>{idx + 1}.</span>\n                          <div className=\"flex flex-col\">\n                            <span className=\"text-sm font-medium truncate max-w-[160px]\">{customer.company || customer.name}</span>\n                            <span className=\"text-xs text-muted-foreground\">Ticket medio: R$ {customer.avgTicket.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</span>\n                          </div>\n                        </div>\n                        <div className=\"text-right flex-shrink-0\">\n                          <span className=\"text-sm font-semibold\">{customer.orderCount} pedidos</span>\n                        </div>\n                      </div>\n                    ))}\n                  </div>\n                )}\n              </CardContent>\n            </Card>\n          </div>\n\n          <Card>\n            <CardHeader className=\"pb-3\">\n              <CardTitle className=\"text-lg flex items-center gap-2\">\n                <RefreshCw className=\"h-5 w-5 text-green-500\" />\n                Ranking de Conversao (Orcamento para Faturado)\n              </CardTitle>\n              <p className=\"text-xs text-muted-foreground\">Clientes com melhor taxa de conversao de orcamentos</p>\n            </CardHeader>\n            <CardContent>\n              {customerAnalyticsLoading ? (\n                <div className=\"flex items-center justify-center py-8\">\n                  <Loader2 className=\"h-6 w-6 animate-spin text-muted-foreground\" />\n                </div>\n              ) : !customerAnalytics?.conversionMetrics?.length ? (\n                <p className=\"text-muted-foreground text-sm py-4\">Nenhum dado de conversao disponivel</p>\n              ) : (\n                <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4\">\n                  {customerAnalytics.conversionMetrics.slice(0, 9).map((customer, idx) => (\n                    <div key={customer.userId} className=\"flex flex-col gap-2 p-3 rounded-md bg-muted/50\" data-testid={`conversion-customer-${customer.userId}`}>\n                      <div className=\"flex items-center justify-between gap-2\">\n                        <div className=\"flex items-center gap-2\">\n                          <span className={`text-sm font-bold w-6 ${idx < 3 ? 'text-green-500' : 'text-muted-foreground'}`}>{idx + 1}.</span>\n                          <span className=\"text-sm font-medium truncate max-w-[120px]\">{customer.company || customer.name}</span>\n                        </div>\n                        <span className={`text-xs px-2 py-0.5 rounded-full ${\n                          customer.conversionRate >= 80 ? 'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400' :\n                          customer.conversionRate >= 50 ? 'bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-400' :\n                          'bg-orange-100 text-orange-700 dark:bg-orange-900/30 dark:text-orange-400'\n                        }`}>\n                          {customer.conversionRate.toFixed(0)}%\n                        </span>\n                      </div>\n                      <div className=\"flex items-center justify-between text-xs text-muted-foreground\">\n                        <span>{customer.convertedOrders} faturados / {customer.totalQuotes + customer.convertedOrders} total</span>\n                        <span>R$ {customer.totalRevenue.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</span>\n                      </div>\n                    </div>\n                  ))}\n                </div>\n              )}\n            </CardContent>\n          </Card>\n\n          <Card>\n            <CardHeader className=\"pb-3\">\n              <CardTitle className=\"text-lg flex items-center gap-2\">\n                <AlertTriangle className=\"h-5 w-5 text-orange-500\" />\n                Clientes Inativos (30+ dias)\n              </CardTitle>\n              <p className=\"text-xs text-muted-foreground\">Clientes que nao fizeram pedidos nos ultimos 30 dias</p>\n            </CardHeader>\n            <CardContent>\n              {customerAnalyticsLoading ? (\n                <div className=\"flex items-center justify-center py-8\">\n                  <Loader2 className=\"h-6 w-6 animate-spin text-muted-foreground\" />\n                </div>\n              ) : !customerAnalytics?.inactiveCustomers?.days30?.length ? (\n                <p className=\"text-muted-foreground text-sm py-4\">Nenhum cliente inativo</p>\n              ) : (\n                <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4\">\n                  {customerAnalytics.inactiveCustomers.days30.slice(0, 9).map((customer) => (\n                    <div key={customer.userId} className=\"flex flex-col gap-1 p-3 rounded-md bg-muted/50\" data-testid={`inactive-customer-${customer.userId}`}>\n                      <div className=\"flex items-center justify-between gap-2\">\n                        <span className=\"text-sm font-medium truncate max-w-[140px]\">{customer.company || customer.name}</span>\n                        <span className={`text-xs px-2 py-0.5 rounded-full ${\n                          customer.churnRisk === 'high' ? 'bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400' :\n                          customer.churnRisk === 'medium' ? 'bg-orange-100 text-orange-700 dark:bg-orange-900/30 dark:text-orange-400' :\n                          'bg-yellow-100 text-yellow-700 dark:bg-yellow-900/30 dark:text-yellow-400'\n                        }`}>\n                          {customer.churnRisk === 'high' ? 'Alto risco' : customer.churnRisk === 'medium' ? 'Medio risco' : 'Baixo risco'}\n                        </span>\n                      </div>\n                      <div className=\"flex items-center justify-between text-xs text-muted-foreground\">\n                        <span>{customer.daysSinceLastOrder} dias sem comprar</span>\n                        <span>R$ {customer.totalSpent.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</span>\n                      </div>\n                    </div>\n                  ))}\n                </div>\n              )}\n            </CardContent>\n          </Card>\n\n          {customerAnalytics?.newCustomersThisMonth && customerAnalytics.newCustomersThisMonth.length > 0 && (\n            <Card>\n              <CardHeader className=\"pb-3\">\n                <CardTitle className=\"text-lg flex items-center gap-2\">\n                  <Users className=\"h-5 w-5 text-green-500\" />\n                  Novos Clientes Este Mes\n                </CardTitle>\n              </CardHeader>\n              <CardContent>\n                <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4\">\n                  {customerAnalytics.newCustomersThisMonth.slice(0, 6).map((customer) => (\n                    <div key={customer.userId} className=\"flex items-center justify-between gap-4 p-3 rounded-md bg-muted/50\" data-testid={`new-customer-${customer.userId}`}>\n                      <div className=\"flex flex-col\">\n                        <span className=\"text-sm font-medium truncate max-w-[160px]\">{customer.company || customer.name}</span>\n                        <span className=\"text-xs text-muted-foreground\">{customer.orderCount} pedido(s)</span>\n                      </div>\n                      <span className=\"text-sm font-semibold\">R$ {customer.totalRevenue.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</span>\n                    </div>\n                  ))}\n                </div>\n              </CardContent>\n            </Card>\n          )}\n        </div>\n      )}\n\n      <div className=\"space-y-4\">\n        <div className=\"flex items-center justify-between gap-4\">\n          <h2 className=\"text-xl font-semibold\">\n            {showAllOrders ? \"Pedidos Recentes\" : \"Meus Pedidos Recentes\"}\n          </h2>\n          <Link href=\"/orders\">\n            <Button variant=\"ghost\" size=\"sm\" data-testid=\"link-view-all-orders\">\n              Ver Todos <ArrowRight className=\"h-4 w-4 ml-1\" />\n            </Button>\n          </Link>\n        </div>\n        {ordersLoading ? (\n          <div className=\"flex items-center justify-center py-12\">\n            <Loader2 className=\"h-8 w-8 animate-spin text-muted-foreground\" />\n          </div>\n        ) : recentOrders.length === 0 ? (\n          <div className=\"text-center py-12 text-muted-foreground\">\n            Nenhum pedido ainda\n          </div>\n        ) : (\n          <OrderTable\n            orders={recentOrders}\n            showCustomer={showAllOrders}\n            onViewOrder={(order) => console.log(\"View order:\", order.orderNumber)}\n          />\n        )}\n      </div>\n\n      <div className=\"flex gap-4\">\n        <Link href=\"/catalog\">\n          <Button data-testid=\"button-browse-catalog\">\n            <Package className=\"h-4 w-4 mr-2\" />\n            Ver Catálogo\n          </Button>\n        </Link>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":36214,"size_tokens":null},"drizzle.config.ts":{"content":"import { defineConfig } from \"drizzle-kit\";\n\nif (!process.env.DATABASE_URL) {\n  throw new Error(\"DATABASE_URL, ensure the database is provisioned\");\n}\n\nexport default defineConfig({\n  out: \"./migrations\",\n  schema: \"./shared/schema.ts\",\n  dialect: \"postgresql\",\n  dbCredentials: {\n    url: process.env.DATABASE_URL,\n  },\n});\n","path":null,"size_bytes":325,"size_tokens":null},"client/src/components/ui/input.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Input = React.forwardRef<HTMLInputElement, React.ComponentProps<\"input\">>(\n  ({ className, type, ...props }, ref) => {\n    // h-9 to match icon buttons and default buttons.\n    return (\n      <input\n        type={type}\n        className={cn(\n          \"flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium file:text-foreground placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm\",\n          className\n        )}\n        ref={ref}\n        {...props}\n      />\n    )\n  }\n)\nInput.displayName = \"Input\"\n\nexport { Input }\n","path":null,"size_bytes":844,"size_tokens":null},"server/index.ts":{"content":"import express, { type Request, Response, NextFunction } from \"express\";\nimport { registerRoutes } from \"./routes\";\nimport { serveStatic } from \"./static\";\nimport { createServer } from \"http\";\nimport { initializeBlingTokens } from \"./services/bling\";\nimport { pool } from \"./db\";\n\n\nconst app = express();\nconst httpServer = createServer(app);\n\ndeclare module \"http\" {\n  interface IncomingMessage {\n    rawBody: unknown;\n  }\n}\n\napp.use(\n  express.json({\n    verify: (req, _res, buf) => {\n      req.rawBody = buf;\n    },\n  }),\n);\n\napp.use(express.urlencoded({ extended: false }));\n\n\napp.get(\"/health/db\", async (_req, res) => {\n  try {\n    await pool.query(\"SELECT 1\");\n    res.json({ status: \"ok\", database: \"connected\" });\n  } catch (error) {\n    console.error(\"[DB HEALTH]\", error);\n    res.status(500).json({\n      status: \"error\",\n      message: \"database not connected\",\n    });\n  }\n});\n\n\nexport function log(message: string, source = \"express\") {\n  const formattedTime = new Date().toLocaleTimeString(\"en-US\", {\n    hour: \"numeric\",\n    minute: \"2-digit\",\n    second: \"2-digit\",\n    hour12: true,\n  });\n\n  console.log(`${formattedTime} [${source}] ${message}`);\n}\n\napp.use((req, res, next) => {\n  const start = Date.now();\n  const path = req.path;\n  let capturedJsonResponse: Record<string, any> | undefined = undefined;\n\n  const originalResJson = res.json;\n  res.json = function (bodyJson, ...args) {\n    capturedJsonResponse = bodyJson;\n    return originalResJson.apply(res, [bodyJson, ...args]);\n  };\n\n  res.on(\"finish\", () => {\n    const duration = Date.now() - start;\n    if (path.startsWith(\"/api\")) {\n      let logLine = `${req.method} ${path} ${res.statusCode} in ${duration}ms`;\n      if (capturedJsonResponse) {\n        logLine += ` :: ${JSON.stringify(capturedJsonResponse)}`;\n      }\n\n      log(logLine);\n    }\n  });\n\n  next();\n});\n\n(async () => {\n  await registerRoutes(httpServer, app);\n  \n  // Initialize Bling tokens from database on server startup\n  try {\n    const blingInitialized = await initializeBlingTokens();\n    if (blingInitialized) {\n      console.log(\"[Bling] Connection restored from database\");\n    } else {\n      console.log(\"[Bling] No saved connection found - authorization required\");\n    }\n  } catch (error) {\n    console.error(\"[Bling] Failed to initialize tokens:\", error);\n  }\n\n  app.use((err: any, _req: Request, res: Response, _next: NextFunction) => {\n    const status = err.status || err.statusCode || 500;\n    const message = err.message || \"Internal Server Error\";\n\n    res.status(status).json({ message });\n    throw err;\n  });\n\n  // importantly only setup vite in development and after\n  // setting up all the other routes so the catch-all route\n  // doesn't interfere with the other routes\n  if (process.env.NODE_ENV === \"production\") {\n    serveStatic(app);\n  } else {\n    const { setupVite } = await import(\"./vite\");\n    await setupVite(httpServer, app);\n  }\n\n  // ALWAYS serve the app on the port specified in the environment variable PORT\n  // Other ports are firewalled. Default to 5000 if not specified.\n  // this serves both the API and the client.\n  // It is the only port that is not firewalled.\n  const port = parseInt(process.env.PORT || \"5000\", 10);\n  httpServer.listen(\n    {\n      port,\n      host: \"0.0.0.0\",\n      reusePort: true,\n    },\n    () => {\n      log(`serving on port ${port}`);\n    },\n  );\n})();\n","path":null,"size_bytes":3375,"size_tokens":null},"server/replitAuth.ts":{"content":"import * as client from \"openid-client\";\nimport { Strategy, type VerifyFunction } from \"openid-client/passport\";\n\nimport passport from \"passport\";\nimport session from \"express-session\";\nimport type { Express, RequestHandler } from \"express\";\nimport memoize from \"memoizee\";\nimport connectPg from \"connect-pg-simple\";\nimport { storage } from \"./storage\";\n\nconst getOidcConfig = memoize(\n  async () => {\n    return await client.discovery(\n      new URL(process.env.ISSUER_URL ?? \"https://replit.com/oidc\"),\n      process.env.REPL_ID!\n    );\n  },\n  { maxAge: 3600 * 1000 }\n);\n\nexport function getSession() {\n  const sessionTtl = 7 * 24 * 60 * 60 * 1000; // 1 week\n  const pgStore = connectPg(session);\n  const sessionStore = new pgStore({\n    conString: process.env.DATABASE_URL,\n    createTableIfMissing: false,\n    ttl: sessionTtl,\n    tableName: \"sessions\",\n  });\n  return session({\n    secret: process.env.SESSION_SECRET!,\n    store: sessionStore,\n    resave: false,\n    saveUninitialized: false,\n    cookie: {\n      httpOnly: true,\n      secure: true,\n      maxAge: sessionTtl,\n    },\n  });\n}\n\nfunction updateUserSession(\n  user: any,\n  tokens: client.TokenEndpointResponse & client.TokenEndpointResponseHelpers\n) {\n  user.claims = tokens.claims();\n  user.access_token = tokens.access_token;\n  user.refresh_token = tokens.refresh_token;\n  user.expires_at = user.claims?.exp;\n}\n\nasync function upsertUser(claims: any) {\n  await storage.upsertUser({\n    id: claims[\"sub\"],\n    email: claims[\"email\"],\n    firstName: claims[\"first_name\"],\n    lastName: claims[\"last_name\"],\n    profileImageUrl: claims[\"profile_image_url\"],\n  });\n}\n\nexport async function setupAuth(app: Express) {\n  app.set(\"trust proxy\", 1);\n  app.use(getSession());\n  app.use(passport.initialize());\n  app.use(passport.session());\n\n  const config = await getOidcConfig();\n\n  const verify: VerifyFunction = async (\n    tokens: client.TokenEndpointResponse & client.TokenEndpointResponseHelpers,\n    verified: passport.AuthenticateCallback\n  ) => {\n    const user = {};\n    updateUserSession(user, tokens);\n    await upsertUser(tokens.claims());\n    verified(null, user);\n  };\n\n  const registeredStrategies = new Set<string>();\n\n  const ensureStrategy = (domain: string) => {\n    const strategyName = `replitauth:${domain}`;\n    if (!registeredStrategies.has(strategyName)) {\n      const strategy = new Strategy(\n        {\n          name: strategyName,\n          config,\n          scope: \"openid email profile offline_access\",\n          callbackURL: `https://${domain}/api/callback`,\n        },\n        verify,\n      );\n      passport.use(strategy);\n      registeredStrategies.add(strategyName);\n    }\n  };\n\n  passport.serializeUser((user: Express.User, cb) => cb(null, user));\n  passport.deserializeUser((user: Express.User, cb) => cb(null, user));\n\n  app.get(\"/api/login\", (req, res, next) => {\n    ensureStrategy(req.hostname);\n    passport.authenticate(`replitauth:${req.hostname}`, {\n      prompt: \"login consent\",\n      scope: [\"openid\", \"email\", \"profile\", \"offline_access\"],\n    })(req, res, next);\n  });\n\n  app.get(\"/api/callback\", (req, res, next) => {\n    ensureStrategy(req.hostname);\n    passport.authenticate(`replitauth:${req.hostname}`, {\n      successReturnToOrRedirect: \"/\",\n      failureRedirect: \"/api/login\",\n    })(req, res, next);\n  });\n\n  app.get(\"/api/logout\", (req, res) => {\n    req.logout(() => {\n      res.redirect(\n        client.buildEndSessionUrl(config, {\n          client_id: process.env.REPL_ID!,\n          post_logout_redirect_uri: `${req.protocol}://${req.hostname}`,\n        }).href\n      );\n    });\n  });\n}\n\nexport const isAuthenticated: RequestHandler = async (req, res, next) => {\n  const user = req.user as any;\n\n  if (!req.isAuthenticated() || !user.expires_at) {\n    return res.status(401).json({ message: \"Unauthorized\" });\n  }\n\n  const now = Math.floor(Date.now() / 1000);\n  if (now <= user.expires_at) {\n    return next();\n  }\n\n  const refreshToken = user.refresh_token;\n  if (!refreshToken) {\n    res.status(401).json({ message: \"Unauthorized\" });\n    return;\n  }\n\n  try {\n    const config = await getOidcConfig();\n    const tokenResponse = await client.refreshTokenGrant(config, refreshToken);\n    updateUserSession(user, tokenResponse);\n    return next();\n  } catch (error) {\n    res.status(401).json({ message: \"Unauthorized\" });\n    return;\n  }\n};\n","path":null,"size_bytes":4366,"size_tokens":null},"client/src/pages/settings.tsx":{"content":"import { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Switch } from \"@/components/ui/switch\";\nimport { Separator } from \"@/components/ui/separator\";\nimport { useTheme } from \"@/contexts/ThemeContext\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { useState, useEffect } from \"react\";\nimport { Database, Link2, Bell, Shield, Palette, Check, UserCheck, ShoppingBag, Store, Percent } from \"lucide-react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\n\nconst sidebarThemes = [\n  { \n    id: \"default\", \n    name: \"Padrao (Laranja)\", \n    primary: \"25 95% 53%\", \n    accent: \"25 100% 95%\",\n    sidebar: \"0 0% 98%\",\n    sidebarDark: \"25 30% 10%\"\n  },\n  { \n    id: \"blue\", \n    name: \"Azul Corporativo\", \n    primary: \"217 91% 60%\", \n    accent: \"217 100% 95%\",\n    sidebar: \"217 30% 97%\",\n    sidebarDark: \"217 30% 10%\"\n  },\n  { \n    id: \"green\", \n    name: \"Verde Natureza\", \n    primary: \"142 71% 45%\", \n    accent: \"142 100% 95%\",\n    sidebar: \"142 30% 97%\",\n    sidebarDark: \"142 30% 10%\"\n  },\n  { \n    id: \"purple\", \n    name: \"Roxo Elegante\", \n    primary: \"262 83% 58%\", \n    accent: \"262 100% 95%\",\n    sidebar: \"262 30% 97%\",\n    sidebarDark: \"262 30% 10%\"\n  },\n  { \n    id: \"red\", \n    name: \"Vermelho Vibrante\", \n    primary: \"0 84% 60%\", \n    accent: \"0 100% 95%\",\n    sidebar: \"0 30% 97%\",\n    sidebarDark: \"0 30% 10%\"\n  },\n  { \n    id: \"teal\", \n    name: \"Verde Agua\", \n    primary: \"173 80% 40%\", \n    accent: \"173 100% 95%\",\n    sidebar: \"173 30% 97%\",\n    sidebarDark: \"173 30% 10%\"\n  },\n  { \n    id: \"pink\", \n    name: \"Rosa Moderno\", \n    primary: \"330 80% 60%\", \n    accent: \"330 100% 95%\",\n    sidebar: \"330 30% 97%\",\n    sidebarDark: \"330 30% 10%\"\n  },\n  { \n    id: \"amber\", \n    name: \"Amarelo Dourado\", \n    primary: \"45 93% 47%\", \n    accent: \"45 100% 95%\",\n    sidebar: \"45 30% 97%\",\n    sidebarDark: \"45 30% 10%\"\n  },\n];\n\nexport default function SettingsPage() {\n  const { theme, setTheme } = useTheme();\n  const { toast } = useToast();\n  const [notifications, setNotifications] = useState(true);\n  const [erpEndpoint, setErpEndpoint] = useState(\"\");\n  const [selectedTheme, setSelectedTheme] = useState(\"default\");\n\n  const { data: agePopupSetting } = useQuery<{ key: string; value: string | null }>({\n    queryKey: ['/api/settings/age_verification_popup'],\n  });\n\n  const { data: deliveryModeSetting } = useQuery<{ key: string; value: string | null }>({\n    queryKey: ['/api/settings/delivery_catalog_mode'],\n  });\n\n  const { data: retailModeSetting } = useQuery<{ key: string; value: string | null }>({\n    queryKey: ['/api/settings/retail_mode_enabled'],\n  });\n\n  const { data: retailMarkupSetting } = useQuery<{ key: string; value: string | null }>({\n    queryKey: ['/api/settings/retail_markup_percentage'],\n  });\n\n  const agePopupMutation = useMutation({\n    mutationFn: async (enabled: boolean) => {\n      return apiRequest('POST', '/api/settings/age_verification_popup', { value: enabled ? 'true' : 'false' });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/settings/age_verification_popup'] });\n      toast({ title: \"Configuração salva\", description: \"Popup de verificação de idade atualizado.\" });\n    },\n    onError: () => {\n      toast({ title: \"Erro\", description: \"Não foi possível salvar a configuração.\", variant: \"destructive\" });\n    },\n  });\n\n  const deliveryModeMutation = useMutation({\n    mutationFn: async (enabled: boolean) => {\n      return apiRequest('POST', '/api/settings/delivery_catalog_mode', { value: enabled ? 'true' : 'false' });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/settings/delivery_catalog_mode'] });\n      toast({ title: \"Configuração salva\", description: \"Modo catálogo delivery atualizado.\" });\n    },\n    onError: () => {\n      toast({ title: \"Erro\", description: \"Não foi possível salvar a configuração.\", variant: \"destructive\" });\n    },\n  });\n\n  const retailModeMutation = useMutation({\n    mutationFn: async (enabled: boolean) => {\n      return apiRequest('POST', '/api/settings/retail_mode_enabled', { value: enabled ? 'true' : 'false' });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/settings/retail_mode_enabled'] });\n      toast({ title: \"Configuração salva\", description: \"Modo varejo atualizado.\" });\n    },\n    onError: () => {\n      toast({ title: \"Erro\", description: \"Não foi possível salvar a configuração.\", variant: \"destructive\" });\n    },\n  });\n\n  const retailMarkupMutation = useMutation({\n    mutationFn: async (percentage: string) => {\n      return apiRequest('POST', '/api/settings/retail_markup_percentage', { value: percentage });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/settings/retail_markup_percentage'] });\n      toast({ title: \"Configuração salva\", description: \"Porcentagem de markup atualizada.\" });\n    },\n    onError: () => {\n      toast({ title: \"Erro\", description: \"Não foi possível salvar a configuração.\", variant: \"destructive\" });\n    },\n  });\n\n  const isAgePopupEnabled = agePopupSetting?.value === 'true';\n  const isDeliveryModeEnabled = deliveryModeSetting?.value === 'true';\n  const isRetailModeEnabled = retailModeSetting?.value === 'true';\n  const retailMarkupPercentage = retailMarkupSetting?.value || '30';\n  const [markupInput, setMarkupInput] = useState(retailMarkupPercentage);\n\n  useEffect(() => {\n    const savedTheme = localStorage.getItem(\"sidebarTheme\");\n    if (savedTheme) {\n      setSelectedTheme(savedTheme);\n      applyTheme(savedTheme);\n    }\n  }, []);\n\n  useEffect(() => {\n    if (retailMarkupSetting?.value) {\n      setMarkupInput(retailMarkupSetting.value);\n    }\n  }, [retailMarkupSetting?.value]);\n\n  const applyTheme = (themeId: string) => {\n    const themeConfig = sidebarThemes.find(t => t.id === themeId);\n    if (!themeConfig) return;\n\n    const root = document.documentElement;\n    const isDark = root.classList.contains(\"dark\");\n    \n    root.style.setProperty(\"--primary\", themeConfig.primary);\n    root.style.setProperty(\"--sidebar\", isDark ? themeConfig.sidebarDark : themeConfig.sidebar);\n    root.style.setProperty(\"--sidebar-accent\", themeConfig.accent);\n    root.style.setProperty(\"--ring\", themeConfig.primary);\n  };\n\n  const handleThemeChange = (themeId: string) => {\n    setSelectedTheme(themeId);\n    applyTheme(themeId);\n    localStorage.setItem(\"sidebarTheme\", themeId);\n    toast({ title: \"Tema aplicado\", description: \"As cores do menu foram atualizadas.\" });\n  };\n\n  const handleSaveERP = () => {\n    toast({ title: \"Configurações Salvas\", description: \"Configurações de integração ERP atualizadas.\" });\n    console.log(\"ERP Endpoint:\", erpEndpoint);\n  };\n\n  return (\n    <div className=\"p-6 lg:p-8 space-y-6 max-w-4xl\">\n      <div>\n        <h1 className=\"text-3xl font-semibold\">Configurações</h1>\n        <p className=\"text-muted-foreground mt-1\">Gerencie as preferências do seu aplicativo</p>\n      </div>\n\n      <div className=\"space-y-6\">\n        <Card>\n          <CardHeader>\n            <CardTitle className=\"flex items-center gap-2\">\n              <Shield className=\"h-5 w-5\" />\n              Aparência\n            </CardTitle>\n            <CardDescription>Personalize a aparência do aplicativo</CardDescription>\n          </CardHeader>\n          <CardContent className=\"space-y-4\">\n            <div className=\"flex items-center justify-between\">\n              <div>\n                <Label>Modo Escuro</Label>\n                <p className=\"text-sm text-muted-foreground\">Ativar tema escuro na interface</p>\n              </div>\n              <Switch\n                checked={theme === \"dark\"}\n                onCheckedChange={(checked) => {\n                  setTheme(checked ? \"dark\" : \"light\");\n                  setTimeout(() => applyTheme(selectedTheme), 100);\n                }}\n                data-testid=\"switch-dark-mode\"\n              />\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader>\n            <CardTitle className=\"flex items-center gap-2\">\n              <Palette className=\"h-5 w-5\" />\n              Cores do Menu\n            </CardTitle>\n            <CardDescription>Escolha o esquema de cores para o menu lateral</CardDescription>\n          </CardHeader>\n          <CardContent>\n            <div className=\"grid grid-cols-2 sm:grid-cols-4 gap-3\">\n              {sidebarThemes.map((themeOption) => (\n                <button\n                  key={themeOption.id}\n                  onClick={() => handleThemeChange(themeOption.id)}\n                  className={`relative flex flex-col items-center gap-2 p-3 rounded-lg border-2 transition-all hover-elevate ${\n                    selectedTheme === themeOption.id\n                      ? \"border-primary bg-primary/5\"\n                      : \"border-border\"\n                  }`}\n                  data-testid={`button-theme-${themeOption.id}`}\n                >\n                  <div\n                    className=\"w-10 h-10 rounded-full shadow-sm\"\n                    style={{ backgroundColor: `hsl(${themeOption.primary})` }}\n                  />\n                  <span className=\"text-xs font-medium text-center\">{themeOption.name}</span>\n                  {selectedTheme === themeOption.id && (\n                    <div className=\"absolute top-1 right-1 w-5 h-5 bg-primary rounded-full flex items-center justify-center\">\n                      <Check className=\"w-3 h-3 text-primary-foreground\" />\n                    </div>\n                  )}\n                </button>\n              ))}\n            </div>\n            <p className=\"text-xs text-muted-foreground mt-4\">\n              As cores sao aplicadas ao menu lateral e elementos de destaque da interface.\n            </p>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader>\n            <CardTitle className=\"flex items-center gap-2\">\n              <Bell className=\"h-5 w-5\" />\n              Notificações\n            </CardTitle>\n            <CardDescription>Configure as preferências de notificação</CardDescription>\n          </CardHeader>\n          <CardContent className=\"space-y-4\">\n            <div className=\"flex items-center justify-between\">\n              <div>\n                <Label>Notificações de Pedidos</Label>\n                <p className=\"text-sm text-muted-foreground\">Receber alertas para novos pedidos</p>\n              </div>\n              <Switch\n                checked={notifications}\n                onCheckedChange={setNotifications}\n                data-testid=\"switch-notifications\"\n              />\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader>\n            <CardTitle className=\"flex items-center gap-2\">\n              <UserCheck className=\"h-5 w-5\" />\n              Verificação de Idade\n            </CardTitle>\n            <CardDescription>Configure o popup de verificação 18+ para o site</CardDescription>\n          </CardHeader>\n          <CardContent className=\"space-y-4\">\n            <div className=\"flex items-center justify-between\">\n              <div>\n                <Label>Popup de Verificação 18+</Label>\n                <p className=\"text-sm text-muted-foreground\">\n                  Exibir janela de verificação de idade antes de acessar o site\n                </p>\n              </div>\n              <Switch\n                checked={isAgePopupEnabled}\n                onCheckedChange={(checked) => agePopupMutation.mutate(checked)}\n                disabled={agePopupMutation.isPending}\n                data-testid=\"switch-age-verification\"\n              />\n            </div>\n            <p className=\"text-xs text-muted-foreground\">\n              Quando ativado, visitantes precisarão confirmar que têm mais de 18 anos para acessar o catálogo.\n            </p>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader>\n            <CardTitle className=\"flex items-center gap-2\">\n              <ShoppingBag className=\"h-5 w-5\" />\n              Modo Catálogo Delivery\n            </CardTitle>\n            <CardDescription>Transforme seu catálogo em um app de delivery moderno</CardDescription>\n          </CardHeader>\n          <CardContent className=\"space-y-4\">\n            <div className=\"flex items-center justify-between\">\n              <div>\n                <Label>Ativar Modo Delivery</Label>\n                <p className=\"text-sm text-muted-foreground\">\n                  Visual inspirado em iFood, Zé Delivery e Rappi\n                </p>\n              </div>\n              <Switch\n                checked={isDeliveryModeEnabled}\n                onCheckedChange={(checked) => deliveryModeMutation.mutate(checked)}\n                disabled={deliveryModeMutation.isPending}\n                data-testid=\"switch-delivery-mode\"\n              />\n            </div>\n            <div className=\"bg-muted/50 rounded-lg p-4 space-y-2\">\n              <p className=\"text-sm font-medium\">Recursos do Modo Delivery:</p>\n              <ul className=\"text-xs text-muted-foreground space-y-1 list-disc list-inside\">\n                <li>Cards grandes com fotos em destaque</li>\n                <li>Categorias com scroll horizontal</li>\n                <li>Botão de adicionar ao carrinho rápido</li>\n                <li>Design otimizado para mobile</li>\n                <li>Visual moderno de app de delivery</li>\n              </ul>\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader>\n            <CardTitle className=\"flex items-center gap-2\">\n              <Store className=\"h-5 w-5\" />\n              Modo Varejo\n            </CardTitle>\n            <CardDescription>Configure precos de varejo com markup automatico</CardDescription>\n          </CardHeader>\n          <CardContent className=\"space-y-4\">\n            <div className=\"flex items-center justify-between\">\n              <div>\n                <Label>Ativar Modo Varejo</Label>\n                <p className=\"text-sm text-muted-foreground\">\n                  Exibe preco de varejo calculado automaticamente\n                </p>\n              </div>\n              <Switch\n                checked={isRetailModeEnabled}\n                onCheckedChange={(checked) => retailModeMutation.mutate(checked)}\n                disabled={retailModeMutation.isPending}\n                data-testid=\"switch-retail-mode\"\n              />\n            </div>\n            \n            {isRetailModeEnabled && (\n              <>\n                <Separator />\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"markup-percentage\" className=\"flex items-center gap-2\">\n                    <Percent className=\"h-4 w-4\" />\n                    Porcentagem de Markup\n                  </Label>\n                  <div className=\"flex gap-2\">\n                    <Input\n                      id=\"markup-percentage\"\n                      type=\"number\"\n                      min=\"0\"\n                      max=\"500\"\n                      step=\"1\"\n                      value={markupInput}\n                      onChange={(e) => setMarkupInput(e.target.value)}\n                      className=\"w-24\"\n                      data-testid=\"input-markup-percentage\"\n                    />\n                    <span className=\"flex items-center text-muted-foreground\">%</span>\n                    <Button\n                      variant=\"outline\"\n                      size=\"sm\"\n                      onClick={() => retailMarkupMutation.mutate(markupInput)}\n                      disabled={retailMarkupMutation.isPending || markupInput === retailMarkupPercentage}\n                      data-testid=\"button-save-markup\"\n                    >\n                      Salvar\n                    </Button>\n                  </div>\n                  <p className=\"text-xs text-muted-foreground\">\n                    O preco de varejo sera calculado como: Preco Atacado + {markupInput}%\n                  </p>\n                </div>\n              </>\n            )}\n            \n            <div className=\"bg-muted/50 rounded-lg p-4 space-y-2\">\n              <p className=\"text-sm font-medium\">Como funciona:</p>\n              <ul className=\"text-xs text-muted-foreground space-y-1 list-disc list-inside\">\n                <li>Clientes atacado veem os dois precos ao clicar no produto</li>\n                <li>O preco de varejo e calculado automaticamente</li>\n                <li>Ideal para lojistas que revendem seus produtos</li>\n              </ul>\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader>\n            <CardTitle className=\"flex items-center gap-2\">\n              <Link2 className=\"h-5 w-5\" />\n              Integração ERP\n            </CardTitle>\n            <CardDescription>Configure conexões com sistemas ERP externos</CardDescription>\n          </CardHeader>\n          <CardContent className=\"space-y-4\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"erp-endpoint\">Endpoint da API Bling ERP</Label>\n              <Input\n                id=\"erp-endpoint\"\n                placeholder=\"https://api.bling.com.br/v3\"\n                value={erpEndpoint}\n                onChange={(e) => setErpEndpoint(e.target.value)}\n                data-testid=\"input-erp-endpoint\"\n              />\n              <p className=\"text-xs text-muted-foreground\">\n                Insira o endpoint da API Bling para sincronização de produtos e pedidos\n              </p>\n            </div>\n            <Separator />\n            <div className=\"flex items-center justify-between\">\n              <div>\n                <p className=\"text-sm font-medium\">Status da Conexão</p>\n                <p className=\"text-sm text-muted-foreground\">Não conectado</p>\n              </div>\n              <Button variant=\"outline\" onClick={handleSaveERP} data-testid=\"button-test-connection\">\n                Testar Conexão\n              </Button>\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader>\n            <CardTitle className=\"flex items-center gap-2\">\n              <Database className=\"h-5 w-5\" />\n              Gerenciamento de Dados\n            </CardTitle>\n            <CardDescription>Gerencie os dados do seu aplicativo</CardDescription>\n          </CardHeader>\n          <CardContent className=\"space-y-4\">\n            <div className=\"flex items-center justify-between\">\n              <div>\n                <p className=\"text-sm font-medium\">Exportar Todos os Dados</p>\n                <p className=\"text-sm text-muted-foreground\">Baixar produtos, pedidos e usuários como CSV</p>\n              </div>\n              <Button variant=\"outline\" data-testid=\"button-export-data\">\n                Exportar\n              </Button>\n            </div>\n            <Separator />\n            <div className=\"flex items-center justify-between\">\n              <div>\n                <p className=\"text-sm font-medium\">Backup do Banco de Dados</p>\n                <p className=\"text-sm text-muted-foreground\">Criar um backup completo do banco de dados</p>\n              </div>\n              <Button variant=\"outline\" data-testid=\"button-backup\">\n                Backup\n              </Button>\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":19666,"size_tokens":null},"client/src/components/ui/alert.tsx":{"content":"import * as React from \"react\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst alertVariants = cva(\n  \"relative w-full rounded-lg border p-4 [&>svg~*]:pl-7 [&>svg+div]:translate-y-[-3px] [&>svg]:absolute [&>svg]:left-4 [&>svg]:top-4 [&>svg]:text-foreground\",\n  {\n    variants: {\n      variant: {\n        default: \"bg-background text-foreground\",\n        destructive:\n          \"border-destructive/50 text-destructive dark:border-destructive [&>svg]:text-destructive\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  }\n)\n\nconst Alert = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement> & VariantProps<typeof alertVariants>\n>(({ className, variant, ...props }, ref) => (\n  <div\n    ref={ref}\n    role=\"alert\"\n    className={cn(alertVariants({ variant }), className)}\n    {...props}\n  />\n))\nAlert.displayName = \"Alert\"\n\nconst AlertTitle = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLHeadingElement>\n>(({ className, ...props }, ref) => (\n  <h5\n    ref={ref}\n    className={cn(\"mb-1 font-medium leading-none tracking-tight\", className)}\n    {...props}\n  />\n))\nAlertTitle.displayName = \"AlertTitle\"\n\nconst AlertDescription = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLParagraphElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"text-sm [&_p]:leading-relaxed\", className)}\n    {...props}\n  />\n))\nAlertDescription.displayName = \"AlertDescription\"\n\nexport { Alert, AlertTitle, AlertDescription }\n","path":null,"size_bytes":1584,"size_tokens":null},"client/src/App.tsx":{"content":"import { Switch, Route } from \"wouter\";\nimport { queryClient } from \"./lib/queryClient\";\nimport { QueryClientProvider, useQuery } from \"@tanstack/react-query\";\nimport { Toaster } from \"@/components/ui/toaster\";\nimport { TooltipProvider } from \"@/components/ui/tooltip\";\nimport { SidebarProvider, SidebarTrigger } from \"@/components/ui/sidebar\";\nimport { AuthProvider, useAuth } from \"@/contexts/AuthContext\";\nimport { CartProvider, useCart } from \"@/contexts/CartContext\";\nimport { ThemeProvider } from \"@/contexts/ThemeContext\";\nimport { ThemeToggle } from \"@/components/ThemeToggle\";\nimport { AppSidebar } from \"@/components/AppSidebar\";\nimport { CartDrawer } from \"@/components/CartDrawer\";\nimport { AgeVerificationPopup } from \"@/components/AgeVerificationPopup\";\nimport { Button } from \"@/components/ui/button\";\nimport { ShoppingCart, Loader2 } from \"lucide-react\";\nimport NotFound from \"@/pages/not-found\";\nimport LandingPage from \"@/pages/landing\";\nimport RegisterPage from \"@/pages/register\";\nimport LoginPage from \"@/pages/login\";\nimport DashboardPage from \"@/pages/dashboard\";\nimport CatalogPage from \"@/pages/catalog\";\nimport OrdersPage from \"@/pages/orders\";\nimport ProductsPage from \"@/pages/products\";\nimport UsersPage from \"@/pages/users\";\nimport SettingsPage from \"@/pages/settings\";\nimport CustomersPage from \"@/pages/customers\";\nimport CategoriesPage from \"@/pages/categories\";\nimport BlingPage from \"@/pages/bling\";\nimport CouponsPage from \"@/pages/coupons\";\nimport OrderDetailsPage from \"@/pages/order-details\";\nimport CustomerAnalyticsPage from \"@/pages/customer-analytics\";\nimport ProductAnalyticsPage from \"@/pages/product-analytics\";\nimport PurchasesDashboardPage from \"@/pages/purchases-dashboard\";\nimport BrandAnalyticsPage from \"@/pages/brand-analytics\";\nimport EmployeeAnalyticsPage from \"@/pages/employee-analytics\";\nimport PublicCatalogPage from \"@/pages/public-catalog\";\nimport CheckoutPage from \"@/pages/checkout\";\nimport AgendaPage from \"@/pages/agenda\";\nimport CatalogCustomizationPage from \"@/pages/catalog-customization\";\nimport PDVPage from \"@/pages/pdv\";\nimport ContasReceberPage from \"@/pages/contas-receber\";\nimport ContasPagarPage from \"@/pages/contas-pagar\";\nimport AppearancePage from \"@/pages/appearance\";\nimport SuppliersPage from \"@/pages/suppliers\";\nimport PaymentsPage from \"@/pages/payments\";\nimport { PWAInstallPrompt } from \"@/components/PWAInstallPrompt\";\n\nfunction AuthenticatedApp() {\n  const { user, logout, isAdmin, isSupplier, isSales, isApproved } = useAuth();\n  const { openCart, itemCount } = useCart();\n\n  const displayName = user?.firstName && user?.lastName \n    ? `${user.firstName} ${user.lastName}` \n    : user?.email || \"User\";\n\n  const sidebarStyle = {\n    \"--sidebar-width\": \"16rem\",\n    \"--sidebar-width-icon\": \"3rem\",\n  };\n\n  // Show pending approval message for non-approved users\n  if (!isApproved) {\n    return (\n      <div className=\"flex items-center justify-center min-h-screen bg-background\">\n        <div className=\"text-center p-8 max-w-md\">\n          <h1 className=\"text-2xl font-bold mb-4\">Account Pending Approval</h1>\n          <p className=\"text-muted-foreground mb-6\">\n            Your account is currently pending approval by an administrator. \n            Please check back later or contact support.\n          </p>\n          <Button onClick={logout} variant=\"outline\" data-testid=\"button-logout-pending\">\n            Sign Out\n          </Button>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <SidebarProvider style={sidebarStyle as React.CSSProperties}>\n      <div className=\"flex h-screen w-full\">\n        <AppSidebar\n          userRole={(user?.role as \"admin\" | \"sales\" | \"customer\" | \"supplier\") || \"customer\"}\n          userName={displayName}\n          onLogout={logout}\n        />\n        <div className=\"flex flex-col flex-1 overflow-hidden\">\n          <header className=\"flex items-center justify-between gap-4 p-3 border-b bg-background sticky top-0 z-50\">\n            <SidebarTrigger data-testid=\"button-sidebar-toggle\" />\n            <div className=\"flex items-center gap-2\">\n              <Button\n                variant=\"outline\"\n                size=\"sm\"\n                onClick={openCart}\n                data-testid=\"button-header-cart\"\n              >\n                <ShoppingCart className=\"h-4 w-4 mr-2\" />\n                Cart ({itemCount})\n              </Button>\n              <ThemeToggle />\n            </div>\n          </header>\n          <main className=\"flex-1 overflow-auto\">\n            <Switch>\n              <Route path=\"/\" component={DashboardPage} />\n              <Route path=\"/categories\" component={CategoriesPage} />\n              <Route path=\"/catalog\" component={CatalogPage} />\n              <Route path=\"/orders\" component={OrdersPage} />\n              <Route path=\"/orders/:id\" component={OrderDetailsPage} />\n              <Route path=\"/pdv\" component={PDVPage} />\n              {isAdmin && <Route path=\"/products\" component={ProductsPage} />}\n              {isAdmin && <Route path=\"/suppliers\" component={SuppliersPage} />}\n              {isAdmin && <Route path=\"/customers\" component={CustomersPage} />}\n              {isAdmin && <Route path=\"/users\" component={UsersPage} />}\n              {isAdmin && <Route path=\"/settings\" component={SettingsPage} />}\n              {isAdmin && <Route path=\"/bling\" component={BlingPage} />}\n              {isAdmin && <Route path=\"/coupons\" component={CouponsPage} />}\n              {isAdmin && <Route path=\"/customer-analytics\" component={CustomerAnalyticsPage} />}\n              {isAdmin && <Route path=\"/product-analytics\" component={ProductAnalyticsPage} />}\n              {isAdmin && <Route path=\"/employee-analytics\" component={EmployeeAnalyticsPage} />}\n              {isAdmin && <Route path=\"/purchases\" component={PurchasesDashboardPage} />}\n              {(isAdmin || isSales || isSupplier) && <Route path=\"/brand-analytics\" component={BrandAnalyticsPage} />}\n              {isAdmin && <Route path=\"/agenda\" component={AgendaPage} />}\n              {isAdmin && <Route path=\"/catalog-customization\" component={CatalogCustomizationPage} />}\n              {isAdmin && <Route path=\"/appearance\" component={AppearancePage} />}\n              {isAdmin && <Route path=\"/payments\" component={PaymentsPage} />}\n              <Route path=\"/contas-receber\" component={ContasReceberPage} />\n              <Route path=\"/contas-pagar\" component={ContasPagarPage} />\n              <Route component={NotFound} />\n            </Switch>\n          </main>\n        </div>\n        <CartDrawer isAuthenticated={true} />\n      </div>\n    </SidebarProvider>\n  );\n}\n\nfunction AppContent() {\n  const { isAuthenticated, isLoading } = useAuth();\n\n  if (isLoading) {\n    return (\n      <div className=\"flex items-center justify-center min-h-screen bg-background\">\n        <Loader2 className=\"h-8 w-8 animate-spin text-muted-foreground\" />\n      </div>\n    );\n  }\n\n  if (!isAuthenticated) {\n    return (\n      <CartProvider>\n        <Switch>\n          <Route path=\"/register\" component={RegisterPage} />\n          <Route path=\"/login\" component={LoginPage} />\n          <Route path=\"/catalogo\" component={PublicCatalogPage} />\n          <Route path=\"/checkout\" component={CheckoutPage} />\n          <Route component={LandingPage} />\n        </Switch>\n        <CartDrawer isAuthenticated={false} />\n      </CartProvider>\n    );\n  }\n\n  return (\n    <CartProvider>\n      <AuthenticatedApp />\n    </CartProvider>\n  );\n}\n\nfunction AgeVerificationWrapper() {\n  const { data: agePopupSetting } = useQuery<{ key: string; value: string | null }>({\n    queryKey: ['/api/settings/age_verification_popup'],\n  });\n\n  const isAgePopupEnabled = agePopupSetting?.value === 'true';\n\n  return <AgeVerificationPopup enabled={isAgePopupEnabled} />;\n}\n\nfunction App() {\n  return (\n    <QueryClientProvider client={queryClient}>\n      <ThemeProvider>\n        <TooltipProvider>\n          <AuthProvider>\n            <AppContent />\n          </AuthProvider>\n          <AgeVerificationWrapper />\n          <PWAInstallPrompt />\n          <Toaster />\n        </TooltipProvider>\n      </ThemeProvider>\n    </QueryClientProvider>\n  );\n}\n\nexport default App;\n","path":null,"size_bytes":8186,"size_tokens":null},"client/src/components/StatusBadge.tsx":{"content":"import { Badge } from \"@/components/ui/badge\";\nimport { cn } from \"@/lib/utils\";\nimport { FileText, Package, Receipt, XCircle } from \"lucide-react\";\n\nexport type OrderStatus = \n  | \"ORCAMENTO\"\n  | \"ORCAMENTO_ABERTO\" \n  | \"ORCAMENTO_CONCLUIDO\" \n  | \"PEDIDO_GERADO\" \n  | \"PEDIDO_FATURADO\"\n  | \"FATURADO\" \n  | \"PEDIDO_CANCELADO\"\n  | \"CANCELADO\"\n  | \"pending\" | \"approved\" | \"processing\" | \"completed\" | \"cancelled\";\n\nexport type OrderStage =\n  | \"AGUARDANDO_IMPRESSAO\"\n  | \"IMPRESSO\";\n\nexport type UserStatus = \"pending\" | \"approved\" | \"rejected\";\n\ninterface StatusBadgeProps {\n  status: OrderStatus | UserStatus;\n  className?: string;\n}\n\nconst statusConfig: Record<string, { \n  label: string; \n  bgColor: string;\n  textColor: string;\n  borderColor: string;\n  icon?: typeof FileText;\n}> = {\n  ORCAMENTO: { \n    label: \"Orçamento\", \n    bgColor: \"bg-slate-100 dark:bg-slate-800/50\",\n    textColor: \"text-slate-700 dark:text-slate-300\",\n    borderColor: \"border-slate-300 dark:border-slate-600\",\n    icon: FileText\n  },\n  ORCAMENTO_ABERTO: { \n    label: \"Orçamento Aberto\", \n    bgColor: \"bg-slate-100 dark:bg-slate-800/50\",\n    textColor: \"text-slate-700 dark:text-slate-300\",\n    borderColor: \"border-slate-300 dark:border-slate-600\",\n    icon: FileText\n  },\n  ORCAMENTO_CONCLUIDO: { \n    label: \"Orçamento Concluído\", \n    bgColor: \"bg-blue-100 dark:bg-blue-900/40\",\n    textColor: \"text-blue-700 dark:text-blue-300\",\n    borderColor: \"border-blue-300 dark:border-blue-700\",\n    icon: FileText\n  },\n  PEDIDO_GERADO: { \n    label: \"Pedido Gerado\", \n    bgColor: \"bg-amber-100 dark:bg-amber-900/40\",\n    textColor: \"text-amber-700 dark:text-amber-300\",\n    borderColor: \"border-amber-300 dark:border-amber-700\",\n    icon: Package\n  },\n  PEDIDO_FATURADO: { \n    label: \"Faturado\", \n    bgColor: \"bg-emerald-100 dark:bg-emerald-900/40\",\n    textColor: \"text-emerald-700 dark:text-emerald-300\",\n    borderColor: \"border-emerald-300 dark:border-emerald-700\",\n    icon: Receipt\n  },\n  FATURADO: { \n    label: \"Faturado\", \n    bgColor: \"bg-emerald-100 dark:bg-emerald-900/40\",\n    textColor: \"text-emerald-700 dark:text-emerald-300\",\n    borderColor: \"border-emerald-300 dark:border-emerald-700\",\n    icon: Receipt\n  },\n  PEDIDO_CANCELADO: { \n    label: \"Cancelado\", \n    bgColor: \"bg-red-100 dark:bg-red-900/40\",\n    textColor: \"text-red-700 dark:text-red-300\",\n    borderColor: \"border-red-300 dark:border-red-700\",\n    icon: XCircle\n  },\n  CANCELADO: { \n    label: \"Cancelado\", \n    bgColor: \"bg-red-100 dark:bg-red-900/40\",\n    textColor: \"text-red-700 dark:text-red-300\",\n    borderColor: \"border-red-300 dark:border-red-700\",\n    icon: XCircle\n  },\n  pending: { \n    label: \"Pendente\", \n    bgColor: \"bg-yellow-100 dark:bg-yellow-900/40\",\n    textColor: \"text-yellow-700 dark:text-yellow-300\",\n    borderColor: \"border-yellow-300 dark:border-yellow-700\"\n  },\n  approved: { \n    label: \"Aprovado\", \n    bgColor: \"bg-emerald-100 dark:bg-emerald-900/40\",\n    textColor: \"text-emerald-700 dark:text-emerald-300\",\n    borderColor: \"border-emerald-300 dark:border-emerald-700\"\n  },\n  processing: { \n    label: \"Processando\", \n    bgColor: \"bg-blue-100 dark:bg-blue-900/40\",\n    textColor: \"text-blue-700 dark:text-blue-300\",\n    borderColor: \"border-blue-300 dark:border-blue-700\"\n  },\n  completed: { \n    label: \"Concluído\", \n    bgColor: \"bg-emerald-100 dark:bg-emerald-900/40\",\n    textColor: \"text-emerald-700 dark:text-emerald-300\",\n    borderColor: \"border-emerald-300 dark:border-emerald-700\"\n  },\n  cancelled: { \n    label: \"Cancelado\", \n    bgColor: \"bg-red-100 dark:bg-red-900/40\",\n    textColor: \"text-red-700 dark:text-red-300\",\n    borderColor: \"border-red-300 dark:border-red-700\"\n  },\n  rejected: { \n    label: \"Rejeitado\", \n    bgColor: \"bg-red-100 dark:bg-red-900/40\",\n    textColor: \"text-red-700 dark:text-red-300\",\n    borderColor: \"border-red-300 dark:border-red-700\"\n  },\n};\n\nexport function StatusBadge({ status, className }: StatusBadgeProps) {\n  const config = statusConfig[status] || { \n    label: status, \n    bgColor: \"bg-muted\",\n    textColor: \"text-muted-foreground\",\n    borderColor: \"border-muted\"\n  };\n\n  const Icon = config.icon;\n\n  return (\n    <Badge \n      variant=\"outline\"\n      className={cn(\n        \"text-xs font-semibold gap-1 border\",\n        config.bgColor,\n        config.textColor,\n        config.borderColor,\n        className\n      )}\n      data-testid={`badge-status-${status}`}\n    >\n      {Icon && <Icon className=\"h-3 w-3\" />}\n      {config.label}\n    </Badge>\n  );\n}\n\ninterface StageBadgeProps {\n  printed: boolean;\n  className?: string;\n}\n\nexport function StageBadge({ printed, className }: StageBadgeProps) {\n  if (printed) {\n    return (\n      <Badge \n        variant=\"outline\"\n        className={cn(\n          \"text-xs font-semibold gap-1 border\",\n          \"bg-emerald-100 dark:bg-emerald-900/40\",\n          \"text-emerald-700 dark:text-emerald-300\",\n          \"border-emerald-300 dark:border-emerald-700\",\n          className\n        )}\n        data-testid=\"badge-stage-impresso\"\n      >\n        Impresso\n      </Badge>\n    );\n  }\n\n  return (\n    <Badge \n      variant=\"outline\"\n      className={cn(\n        \"text-xs font-semibold gap-1 border\",\n        \"bg-amber-100 dark:bg-amber-900/40\",\n        \"text-amber-700 dark:text-amber-300\",\n        \"border-amber-300 dark:border-amber-700\",\n        className\n      )}\n      data-testid=\"badge-stage-aguardando\"\n    >\n      Aguardando impressão\n    </Badge>\n  );\n}\n","path":null,"size_bytes":5465,"size_tokens":null},"client/src/components/ui/radio-group.tsx":{"content":"import * as React from \"react\"\nimport * as RadioGroupPrimitive from \"@radix-ui/react-radio-group\"\nimport { Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst RadioGroup = React.forwardRef<\n  React.ElementRef<typeof RadioGroupPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof RadioGroupPrimitive.Root>\n>(({ className, ...props }, ref) => {\n  return (\n    <RadioGroupPrimitive.Root\n      className={cn(\"grid gap-2\", className)}\n      {...props}\n      ref={ref}\n    />\n  )\n})\nRadioGroup.displayName = RadioGroupPrimitive.Root.displayName\n\nconst RadioGroupItem = React.forwardRef<\n  React.ElementRef<typeof RadioGroupPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof RadioGroupPrimitive.Item>\n>(({ className, ...props }, ref) => {\n  return (\n    <RadioGroupPrimitive.Item\n      ref={ref}\n      className={cn(\n        \"aspect-square h-4 w-4 rounded-full border border-primary text-primary ring-offset-background focus:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50\",\n        className\n      )}\n      {...props}\n    >\n      <RadioGroupPrimitive.Indicator className=\"flex items-center justify-center\">\n        <Circle className=\"h-2.5 w-2.5 fill-current text-current\" />\n      </RadioGroupPrimitive.Indicator>\n    </RadioGroupPrimitive.Item>\n  )\n})\nRadioGroupItem.displayName = RadioGroupPrimitive.Item.displayName\n\nexport { RadioGroup, RadioGroupItem }\n","path":null,"size_bytes":1467,"size_tokens":null},"shared/schema.ts":{"content":"// Re-export everything from schema folder for backwards compatibility\nexport * from \"./schema/index\";\n","path":null,"size_bytes":103,"size_tokens":null},"tailwind.config.ts":{"content":"import type { Config } from \"tailwindcss\";\n\nexport default {\n  darkMode: [\"class\"],\n  content: [\"./client/index.html\", \"./client/src/**/*.{js,jsx,ts,tsx}\"],\n  theme: {\n    extend: {\n      borderRadius: {\n        lg: \".5625rem\", /* 9px */\n        md: \".375rem\", /* 6px */\n        sm: \".1875rem\", /* 3px */\n      },\n      colors: {\n        // Flat / base colors (regular buttons)\n        background: \"hsl(var(--background) / <alpha-value>)\",\n        foreground: \"hsl(var(--foreground) / <alpha-value>)\",\n        border: \"hsl(var(--border) / <alpha-value>)\",\n        input: \"hsl(var(--input) / <alpha-value>)\",\n        card: {\n          DEFAULT: \"hsl(var(--card) / <alpha-value>)\",\n          foreground: \"hsl(var(--card-foreground) / <alpha-value>)\",\n          border: \"hsl(var(--card-border) / <alpha-value>)\",\n        },\n        popover: {\n          DEFAULT: \"hsl(var(--popover) / <alpha-value>)\",\n          foreground: \"hsl(var(--popover-foreground) / <alpha-value>)\",\n          border: \"hsl(var(--popover-border) / <alpha-value>)\",\n        },\n        primary: {\n          DEFAULT: \"hsl(var(--primary) / <alpha-value>)\",\n          foreground: \"hsl(var(--primary-foreground) / <alpha-value>)\",\n          border: \"var(--primary-border)\",\n        },\n        secondary: {\n          DEFAULT: \"hsl(var(--secondary) / <alpha-value>)\",\n          foreground: \"hsl(var(--secondary-foreground) / <alpha-value>)\",\n          border: \"var(--secondary-border)\",\n        },\n        muted: {\n          DEFAULT: \"hsl(var(--muted) / <alpha-value>)\",\n          foreground: \"hsl(var(--muted-foreground) / <alpha-value>)\",\n          border: \"var(--muted-border)\",\n        },\n        accent: {\n          DEFAULT: \"hsl(var(--accent) / <alpha-value>)\",\n          foreground: \"hsl(var(--accent-foreground) / <alpha-value>)\",\n          border: \"var(--accent-border)\",\n        },\n        destructive: {\n          DEFAULT: \"hsl(var(--destructive) / <alpha-value>)\",\n          foreground: \"hsl(var(--destructive-foreground) / <alpha-value>)\",\n          border: \"var(--destructive-border)\",\n        },\n        ring: \"hsl(var(--ring) / <alpha-value>)\",\n        chart: {\n          \"1\": \"hsl(var(--chart-1) / <alpha-value>)\",\n          \"2\": \"hsl(var(--chart-2) / <alpha-value>)\",\n          \"3\": \"hsl(var(--chart-3) / <alpha-value>)\",\n          \"4\": \"hsl(var(--chart-4) / <alpha-value>)\",\n          \"5\": \"hsl(var(--chart-5) / <alpha-value>)\",\n        },\n        sidebar: {\n          ring: \"hsl(var(--sidebar-ring) / <alpha-value>)\",\n          DEFAULT: \"hsl(var(--sidebar) / <alpha-value>)\",\n          foreground: \"hsl(var(--sidebar-foreground) / <alpha-value>)\",\n          border: \"hsl(var(--sidebar-border) / <alpha-value>)\",\n        },\n        \"sidebar-primary\": {\n          DEFAULT: \"hsl(var(--sidebar-primary) / <alpha-value>)\",\n          foreground: \"hsl(var(--sidebar-primary-foreground) / <alpha-value>)\",\n          border: \"var(--sidebar-primary-border)\",\n        },\n        \"sidebar-accent\": {\n          DEFAULT: \"hsl(var(--sidebar-accent) / <alpha-value>)\",\n          foreground: \"hsl(var(--sidebar-accent-foreground) / <alpha-value>)\",\n          border: \"var(--sidebar-accent-border)\"\n        },\n        status: {\n          online: \"rgb(34 197 94)\",\n          away: \"rgb(245 158 11)\",\n          busy: \"rgb(239 68 68)\",\n          offline: \"rgb(156 163 175)\",\n        },\n      },\n      fontFamily: {\n        sans: [\"var(--font-sans)\"],\n        serif: [\"var(--font-serif)\"],\n        mono: [\"var(--font-mono)\"],\n      },\n      keyframes: {\n        \"accordion-down\": {\n          from: { height: \"0\" },\n          to: { height: \"var(--radix-accordion-content-height)\" },\n        },\n        \"accordion-up\": {\n          from: { height: \"var(--radix-accordion-content-height)\" },\n          to: { height: \"0\" },\n        },\n      },\n      animation: {\n        \"accordion-down\": \"accordion-down 0.2s ease-out\",\n        \"accordion-up\": \"accordion-up 0.2s ease-out\",\n      },\n    },\n  },\n  plugins: [require(\"tailwindcss-animate\"), require(\"@tailwindcss/typography\")],\n} satisfies Config;\n","path":null,"size_bytes":4050,"size_tokens":null},"client/src/components/ui/navigation-menu.tsx":{"content":"import * as React from \"react\"\nimport * as NavigationMenuPrimitive from \"@radix-ui/react-navigation-menu\"\nimport { cva } from \"class-variance-authority\"\nimport { ChevronDown } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst NavigationMenu = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Root>\n>(({ className, children, ...props }, ref) => (\n  <NavigationMenuPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"relative z-10 flex max-w-max flex-1 items-center justify-center\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <NavigationMenuViewport />\n  </NavigationMenuPrimitive.Root>\n))\nNavigationMenu.displayName = NavigationMenuPrimitive.Root.displayName\n\nconst NavigationMenuList = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.List>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.List>\n>(({ className, ...props }, ref) => (\n  <NavigationMenuPrimitive.List\n    ref={ref}\n    className={cn(\n      \"group flex flex-1 list-none items-center justify-center space-x-1\",\n      className\n    )}\n    {...props}\n  />\n))\nNavigationMenuList.displayName = NavigationMenuPrimitive.List.displayName\n\nconst NavigationMenuItem = NavigationMenuPrimitive.Item\n\nconst navigationMenuTriggerStyle = cva(\n  \"group inline-flex h-10 w-max items-center justify-center rounded-md bg-background px-4 py-2 text-sm font-medium transition-colors hover:bg-accent hover:text-accent-foreground focus:bg-accent focus:text-accent-foreground focus:outline-none disabled:pointer-events-none disabled:opacity-50 data-[state=open]:text-accent-foreground data-[state=open]:bg-accent/50 data-[state=open]:hover:bg-accent data-[state=open]:focus:bg-accent\"\n)\n\nconst NavigationMenuTrigger = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Trigger>\n>(({ className, children, ...props }, ref) => (\n  <NavigationMenuPrimitive.Trigger\n    ref={ref}\n    className={cn(navigationMenuTriggerStyle(), \"group\", className)}\n    {...props}\n  >\n    {children}{\" \"}\n    <ChevronDown\n      className=\"relative top-[1px] ml-1 h-3 w-3 transition duration-200 group-data-[state=open]:rotate-180\"\n      aria-hidden=\"true\"\n    />\n  </NavigationMenuPrimitive.Trigger>\n))\nNavigationMenuTrigger.displayName = NavigationMenuPrimitive.Trigger.displayName\n\nconst NavigationMenuContent = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <NavigationMenuPrimitive.Content\n    ref={ref}\n    className={cn(\n      \"left-0 top-0 w-full data-[motion^=from-]:animate-in data-[motion^=to-]:animate-out data-[motion^=from-]:fade-in data-[motion^=to-]:fade-out data-[motion=from-end]:slide-in-from-right-52 data-[motion=from-start]:slide-in-from-left-52 data-[motion=to-end]:slide-out-to-right-52 data-[motion=to-start]:slide-out-to-left-52 md:absolute md:w-auto \",\n      className\n    )}\n    {...props}\n  />\n))\nNavigationMenuContent.displayName = NavigationMenuPrimitive.Content.displayName\n\nconst NavigationMenuLink = NavigationMenuPrimitive.Link\n\nconst NavigationMenuViewport = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Viewport>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Viewport>\n>(({ className, ...props }, ref) => (\n  <div className={cn(\"absolute left-0 top-full flex justify-center\")}>\n    <NavigationMenuPrimitive.Viewport\n      className={cn(\n        \"origin-top-center relative mt-1.5 h-[var(--radix-navigation-menu-viewport-height)] w-full overflow-hidden rounded-md border bg-popover text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-90 md:w-[var(--radix-navigation-menu-viewport-width)]\",\n        className\n      )}\n      ref={ref}\n      {...props}\n    />\n  </div>\n))\nNavigationMenuViewport.displayName =\n  NavigationMenuPrimitive.Viewport.displayName\n\nconst NavigationMenuIndicator = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Indicator>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Indicator>\n>(({ className, ...props }, ref) => (\n  <NavigationMenuPrimitive.Indicator\n    ref={ref}\n    className={cn(\n      \"top-full z-[1] flex h-1.5 items-end justify-center overflow-hidden data-[state=visible]:animate-in data-[state=hidden]:animate-out data-[state=hidden]:fade-out data-[state=visible]:fade-in\",\n      className\n    )}\n    {...props}\n  >\n    <div className=\"relative top-[60%] h-2 w-2 rotate-45 rounded-tl-sm bg-border shadow-md\" />\n  </NavigationMenuPrimitive.Indicator>\n))\nNavigationMenuIndicator.displayName =\n  NavigationMenuPrimitive.Indicator.displayName\n\nexport {\n  navigationMenuTriggerStyle,\n  NavigationMenu,\n  NavigationMenuList,\n  NavigationMenuItem,\n  NavigationMenuContent,\n  NavigationMenuTrigger,\n  NavigationMenuLink,\n  NavigationMenuIndicator,\n  NavigationMenuViewport,\n}\n","path":null,"size_bytes":5128,"size_tokens":null},"client/src/components/examples/ThemeToggleExample.tsx":{"content":"import { ThemeToggle } from \"../ThemeToggle\";\nimport { ThemeProvider } from \"@/contexts/ThemeContext\";\n\nexport default function ThemeToggleExample() {\n  return (\n    <ThemeProvider>\n      <div className=\"flex items-center gap-4\">\n        <ThemeToggle />\n        <span className=\"text-sm text-muted-foreground\">Toggle theme</span>\n      </div>\n    </ThemeProvider>\n  );\n}\n","path":null,"size_bytes":371,"size_tokens":null},"client/src/lib/queryClient.ts":{"content":"import { QueryClient, QueryFunction } from \"@tanstack/react-query\";\n\nasync function throwIfResNotOk(res: Response) {\n  if (!res.ok) {\n    const text = (await res.text()) || res.statusText;\n    throw new Error(`${res.status}: ${text}`);\n  }\n}\n\nexport async function apiRequest(\n  method: string,\n  url: string,\n  data?: unknown | undefined,\n): Promise<Response> {\n  const res = await fetch(url, {\n    method,\n    headers: data ? { \"Content-Type\": \"application/json\" } : {},\n    body: data ? JSON.stringify(data) : undefined,\n    credentials: \"include\",\n  });\n\n  await throwIfResNotOk(res);\n  return res;\n}\n\ntype UnauthorizedBehavior = \"returnNull\" | \"throw\";\nexport const getQueryFn: <T>(options: {\n  on401: UnauthorizedBehavior;\n}) => QueryFunction<T> =\n  ({ on401: unauthorizedBehavior }) =>\n  async ({ queryKey }) => {\n    const res = await fetch(queryKey.join(\"/\") as string, {\n      credentials: \"include\",\n    });\n\n    if (unauthorizedBehavior === \"returnNull\" && res.status === 401) {\n      return null;\n    }\n\n    await throwIfResNotOk(res);\n    return await res.json();\n  };\n\nexport const queryClient = new QueryClient({\n  defaultOptions: {\n    queries: {\n      queryFn: getQueryFn({ on401: \"throw\" }),\n      refetchInterval: false,\n      refetchOnWindowFocus: false,\n      staleTime: Infinity,\n      retry: false,\n    },\n    mutations: {\n      retry: false,\n    },\n  },\n});\n","path":null,"size_bytes":1383,"size_tokens":null},"design_guidelines.md":{"content":"# Design Guidelines: B2B Wholesale Catalog & Order Management System\n\n## Design Philosophy\n\n**Enterprise Corporate Design**: Clean, modern, and professional interface that conveys trust, scale, and credibility. Optimized for daily operational use with focus on data clarity and efficient workflows.\n\n**Key Principles**:\n- **Confidence**: Professional appearance that builds trust\n- **Clarity**: Clean layouts with clear visual hierarchy\n- **Efficiency**: Optimized for daily operational use\n- **Scalability**: Design that works for growing businesses\n\n---\n\n## Color System\n\n### Primary Palette (Neutral/Corporate)\n- **Background**: Off-white to light gray (#F8F9FA to #F1F3F5)\n- **Cards/Surfaces**: Pure white (#FFFFFF) with subtle shadows\n- **Text Primary**: Graphite/Dark gray (#1F2937)\n- **Text Secondary**: Medium gray (#6B7280)\n- **Text Tertiary**: Light gray (#9CA3AF)\n- **Borders**: Very light gray (#E5E7EB)\n\n### Accent Colors (Used Sparingly)\n- **Primary Action (Blue)**: #2563EB - For primary buttons and key CTAs\n- **Success (Green)**: #059669 - For positive states, confirmations\n- **Warning (Amber)**: #D97706 - For attention, pending states\n- **Destructive (Red)**: #DC2626 - For errors, deletions\n- **Info (Slate Blue)**: #6366F1 - For informational badges\n\n### Dark Mode\n- **Background**: Deep charcoal (#111827)\n- **Cards/Surfaces**: Dark gray (#1F2937)\n- **Text Primary**: Off-white (#F9FAFB)\n- **Text Secondary**: Light gray (#D1D5DB)\n- **Borders**: Medium gray (#374151)\n\n---\n\n## Typography\n\n**Font Stack**: Inter (primary), system-ui fallback\n\n### Scale\n- **H1**: text-2xl (24px), font-semibold - Page titles\n- **H2**: text-xl (20px), font-semibold - Section headers\n- **H3**: text-lg (18px), font-medium - Card titles\n- **Body**: text-sm (14px), font-normal - General content\n- **Small**: text-xs (12px) - Labels, timestamps, badges\n\n### Guidelines\n- Use font-medium for labels and important text\n- Use font-normal for body content\n- Maintain consistent line heights (1.5 for body, 1.2 for headings)\n\n---\n\n## Spacing System\n\n**Base Unit**: 4px (Tailwind default)\n\n### Component Spacing\n- **Cards**: p-5 to p-6 internal padding\n- **Sections**: gap-6 between major sections\n- **Form Groups**: gap-4 between form elements\n- **Inline Elements**: gap-2 to gap-3\n\n### Page Layout\n- **Page Padding**: p-6 on desktop, p-4 on mobile\n- **Max Content Width**: max-w-7xl for wide content\n- **Container Gaps**: gap-6 for grid layouts\n\n---\n\n## Component Guidelines\n\n### Cards\n- White background (bg-card)\n- Subtle border (border border-border/50)\n- Light shadow (shadow-sm)\n- Rounded corners (rounded-lg)\n- Consistent padding (p-5 or p-6)\n\n### Buttons\n- **Primary**: Blue background, white text - Main actions\n- **Secondary**: Light gray background - Alternative actions\n- **Ghost**: Transparent with hover state - Subtle actions\n- **Outline**: Border only - Secondary options\n- **Destructive**: Red - Delete/dangerous actions\n\n### Status Badges\n- Rounded-full with text-xs font-medium\n- Subtle background colors with matching text\n- Consistent padding (px-2.5 py-0.5)\n\n### Form Inputs\n- Light background (bg-muted/30 or transparent)\n- Subtle border that darkens on focus\n- Consistent height (h-9 or h-10)\n- Focus ring with primary color\n\n### Tables\n- Clean headers with subtle background\n- Zebra striping optional (use for data-heavy tables)\n- Hover state on rows\n- Right-aligned numbers\n\n### Navigation\n- Sidebar: Clean design with subtle active states\n- Icons: 18-20px, consistent stroke width\n- Active indicator: Subtle background + left border accent\n\n---\n\n## Shadows & Depth\n\n### Shadow Scale\n- **shadow-sm**: Cards, inputs - subtle depth\n- **shadow-md**: Dropdowns, popovers - moderate depth\n- **shadow-lg**: Modals, floating elements - pronounced depth\n\n### Guidelines\n- Use shadows sparingly\n- Cards should use shadow-sm or just borders\n- Floating elements (modals, dropdowns) use shadow-lg\n\n---\n\n## Icons\n\n- **Library**: Lucide React\n- **Size**: 16-20px for UI, 24px for empty states\n- **Stroke**: 1.5-2px weight\n- **Color**: Match text hierarchy (muted-foreground for secondary)\n\n---\n\n## Responsive Design\n\n### Breakpoints\n- **Mobile**: < 768px - Single column, simplified nav\n- **Tablet**: 768-1024px - 2 columns, collapsible sidebar\n- **Desktop**: > 1024px - Full layout, expanded sidebar\n\n### Mobile Adaptations\n- Hamburger menu for navigation\n- Stack columns vertically\n- Full-width cards and buttons\n- Larger touch targets (min 44px)\n- Bottom sheet for modals when appropriate\n\n---\n\n## Animation & Transitions\n\n- **Duration**: 150-200ms for most interactions\n- **Easing**: ease-out for exits, ease-in-out for transforms\n- **What to animate**: Opacity, transforms, background colors\n- **What NOT to animate**: Layout-affecting properties during interaction\n\n---\n\n## Performance Notes\n\n- Lazy load images below the fold\n- Use skeleton loaders for async content\n- Paginate tables (20-50 items per page)\n- Virtualize long lists when necessary\n","path":null,"size_bytes":4963,"size_tokens":null},"client/src/pages/products.tsx":{"content":"import { useState } from \"react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from \"@/components/ui/table\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport { Separator } from \"@/components/ui/separator\";\nimport {\n  Form,\n  FormControl,\n  FormField,\n  FormItem,\n  FormLabel,\n  FormMessage,\n} from \"@/components/ui/form\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport {\n  Popover,\n  PopoverContent,\n  PopoverTrigger,\n} from \"@/components/ui/popover\";\nimport {\n  Command,\n  CommandEmpty,\n  CommandGroup,\n  CommandInput,\n  CommandItem,\n  CommandList,\n} from \"@/components/ui/command\";\nimport { Switch } from \"@/components/ui/switch\";\nimport { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { z } from \"zod\";\nimport { \n  Plus, \n  Search, \n  Pencil, \n  Trash2, \n  Loader2, \n  Upload, \n  Image as ImageIcon, \n  X, \n  Copy, \n  Star,\n  ArrowLeft,\n  Package,\n  DollarSign,\n  Boxes,\n  Save,\n  Ruler,\n  FileText,\n  Barcode,\n  Check,\n  ChevronsUpDown,\n  ChevronLeft,\n  ChevronRight\n} from \"lucide-react\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { useAuth } from \"@/contexts/AuthContext\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\nimport type { Product as SchemaProduct, Category } from \"@shared/schema\";\n\ninterface ProductData {\n  id: string;\n  name: string;\n  sku: string;\n  category: string;\n  categoryId: number | null;\n  brand: string;\n  price: number;\n  cost: number | null;\n  stock: number;\n  description: string | null;\n  image: string | null;\n  images: string[] | null;\n  featured: boolean;\n  weight: number | null;\n  width: number | null;\n  height: number | null;\n  depth: number | null;\n}\n\nconst productSchema = z.object({\n  name: z.string().min(1, \"Nome e obrigatorio\"),\n  sku: z.string().min(1, \"SKU e obrigatorio\"),\n  categoryId: z.string().optional(),\n  brand: z.string().optional(),\n  price: z.coerce.number().min(0, \"Preco deve ser positivo\"),\n  cost: z.coerce.number().min(0, \"Custo deve ser positivo\").optional().or(z.literal(\"\")),\n  stock: z.coerce.number().int().min(0, \"Estoque deve ser 0 ou mais\"),\n  description: z.string().optional(),\n  featured: z.boolean().default(false),\n  weight: z.coerce.number().min(0, \"Peso deve ser positivo\").optional().or(z.literal(\"\")),\n  width: z.coerce.number().min(0, \"Largura deve ser positiva\").optional().or(z.literal(\"\")),\n  height: z.coerce.number().min(0, \"Altura deve ser positiva\").optional().or(z.literal(\"\")),\n  depth: z.coerce.number().min(0, \"Profundidade deve ser positiva\").optional().or(z.literal(\"\")),\n  gtin: z.string().optional(),\n  gtinTributario: z.string().optional(),\n  ncm: z.string().optional(),\n  cest: z.string().optional(),\n  taxOrigin: z.string().optional(),\n  icmsCst: z.string().optional(),\n  icmsAliquota: z.coerce.number().min(0).optional().or(z.literal(\"\")),\n  ipiCst: z.string().optional(),\n  ipiAliquota: z.coerce.number().min(0).optional().or(z.literal(\"\")),\n  pisCst: z.string().optional(),\n  pisAliquota: z.coerce.number().min(0).optional().or(z.literal(\"\")),\n  cofinsCst: z.string().optional(),\n  cofinsAliquota: z.coerce.number().min(0).optional().or(z.literal(\"\")),\n});\n\ntype ProductFormValues = z.infer<typeof productSchema>;\n\nconst PRODUCTS_PER_PAGE = 50;\n\nexport default function ProductsPage() {\n  const { toast } = useToast();\n  const { isAdmin } = useAuth();\n  const [searchQuery, setSearchQuery] = useState(\"\");\n  const [currentPage, setCurrentPage] = useState(1);\n  const [filterCategory, setFilterCategory] = useState<string>(\"\");\n  const [filterBrand, setFilterBrand] = useState<string>(\"\");\n  const [viewMode, setViewMode] = useState<\"list\" | \"form\">(\"list\");\n  const [editingProduct, setEditingProduct] = useState<ProductData | null>(null);\n  const [imageUrls, setImageUrls] = useState<string[]>([]);\n  const [isUploading, setIsUploading] = useState(false);\n  const [activeFormTab, setActiveFormTab] = useState(\"dados\");\n  const [brandPopoverOpen, setBrandPopoverOpen] = useState(false);\n  const [brandSearch, setBrandSearch] = useState(\"\");\n  const MAX_IMAGES = 5;\n\n  const { data: productsResponse, isLoading } = useQuery<{ products: SchemaProduct[]; total: number }>({\n    queryKey: ['/api/products'],\n    queryFn: async () => {\n      const res = await fetch('/api/products?limit=10000', { credentials: 'include' });\n      if (!res.ok) throw new Error('Failed to fetch products');\n      return res.json();\n    },\n  });\n  \n  const productsData = productsResponse?.products || [];\n\n  const { data: categoriesData = [] } = useQuery<Category[]>({\n    queryKey: ['/api/categories'],\n    queryFn: async () => {\n      const res = await fetch('/api/categories?limit=1000', { credentials: 'include' });\n      if (!res.ok) throw new Error('Failed to fetch categories');\n      return res.json();\n    },\n  });\n\n  const { data: brandsData = [] } = useQuery<string[]>({\n    queryKey: ['/api/brands'],\n    queryFn: async () => {\n      const res = await fetch('/api/brands', { credentials: 'include' });\n      if (!res.ok) throw new Error('Failed to fetch brands');\n      return res.json();\n    },\n  });\n\n  const categoryMap: Record<number, string> = {};\n  categoriesData.forEach(cat => {\n    categoryMap[cat.id] = cat.name;\n  });\n\n  const products: ProductData[] = productsData.map((p) => ({\n    id: String(p.id),\n    name: p.name,\n    sku: p.sku,\n    category: p.categoryId ? categoryMap[p.categoryId] || \"Sem categoria\" : \"Sem categoria\",\n    categoryId: p.categoryId,\n    brand: p.brand || \"\",\n    price: parseFloat(p.price),\n    cost: p.cost ? parseFloat(p.cost) : null,\n    stock: p.stock,\n    description: p.description,\n    image: p.image,\n    images: p.images || null,\n    featured: p.featured || false,\n    weight: p.weight ? parseFloat(p.weight) : null,\n    width: p.width ? parseFloat(p.width) : null,\n    height: p.height ? parseFloat(p.height) : null,\n    depth: p.depth ? parseFloat(p.depth) : null,\n  }));\n\n  const form = useForm<ProductFormValues>({\n    resolver: zodResolver(productSchema),\n    defaultValues: {\n      name: \"\",\n      sku: \"\",\n      categoryId: \"\",\n      brand: \"\",\n      price: 0,\n      cost: \"\",\n      stock: 0,\n      description: \"\",\n      featured: false,\n      weight: \"\",\n      width: \"\",\n      height: \"\",\n      depth: \"\",\n    },\n  });\n\n  const filteredProducts = products.filter((p) => {\n    const matchesSearch = \n      p.name.toLowerCase().includes(searchQuery.toLowerCase()) ||\n      p.sku.toLowerCase().includes(searchQuery.toLowerCase());\n    const matchesCategory = !filterCategory || String(p.categoryId) === filterCategory;\n    const matchesBrand = !filterBrand || p.brand.toLowerCase() === filterBrand.toLowerCase();\n    return matchesSearch && matchesCategory && matchesBrand;\n  });\n\n  // Pagination logic\n  const totalPages = Math.ceil(filteredProducts.length / PRODUCTS_PER_PAGE);\n  const startIndex = (currentPage - 1) * PRODUCTS_PER_PAGE;\n  const endIndex = startIndex + PRODUCTS_PER_PAGE;\n  const paginatedProducts = filteredProducts.slice(startIndex, endIndex);\n\n  // Reset to page 1 when filters change\n  const handleSearchChange = (value: string) => {\n    setSearchQuery(value);\n    setCurrentPage(1);\n  };\n\n  const handleCategoryFilter = (value: string) => {\n    setFilterCategory(value === \"all\" ? \"\" : value);\n    setCurrentPage(1);\n  };\n\n  const handleBrandFilter = (value: string) => {\n    setFilterBrand(value === \"all\" ? \"\" : value);\n    setCurrentPage(1);\n  };\n\n  const handleImageUpload = async (file: File) => {\n    if (imageUrls.length >= MAX_IMAGES) {\n      toast({ \n        title: \"Limite atingido\", \n        description: `Maximo de ${MAX_IMAGES} imagens por produto.`, \n        variant: \"destructive\" \n      });\n      return;\n    }\n    \n    setIsUploading(true);\n    try {\n      const formData = new FormData();\n      formData.append('file', file);\n      \n      const response = await fetch('/api/upload', {\n        method: 'POST',\n        body: formData,\n        credentials: 'include',\n      });\n      \n      if (!response.ok) {\n        const error = await response.json();\n        throw new Error(error.message || 'Falha no upload');\n      }\n      \n      const data = await response.json();\n      setImageUrls(prev => [...prev, data.url]);\n      toast({ title: \"Imagem enviada\" });\n    } catch (error: any) {\n      toast({ \n        title: \"Erro no upload\", \n        description: error.message || \"Falha ao enviar imagem\", \n        variant: \"destructive\" \n      });\n    } finally {\n      setIsUploading(false);\n    }\n  };\n\n  const removeImage = (index: number) => {\n    setImageUrls(prev => prev.filter((_, i) => i !== index));\n  };\n\n  const createProductMutation = useMutation({\n    mutationFn: async (data: ProductFormValues) => {\n      const payload = {\n        name: data.name,\n        sku: data.sku,\n        categoryId: data.categoryId ? parseInt(data.categoryId) : null,\n        brand: data.brand || null,\n        price: data.price.toFixed(2),\n        cost: data.cost && typeof data.cost === 'number' ? data.cost.toFixed(2) : null,\n        stock: data.stock,\n        description: data.description || null,\n        image: imageUrls[0] || null,\n        images: imageUrls.length > 0 ? imageUrls : null,\n        featured: data.featured,\n        gtin: data.gtin || null,\n        gtinTributario: data.gtinTributario || null,\n        ncm: data.ncm || null,\n        cest: data.cest || null,\n        origem: data.taxOrigin || null,\n        icmsCst: data.icmsCst || null,\n        icmsAliquota: data.icmsAliquota && typeof data.icmsAliquota === 'number' ? data.icmsAliquota.toFixed(2) : null,\n        ipiCst: data.ipiCst || null,\n        ipiAliquota: data.ipiAliquota && typeof data.ipiAliquota === 'number' ? data.ipiAliquota.toFixed(2) : null,\n        pisCst: data.pisCst || null,\n        pisAliquota: data.pisAliquota && typeof data.pisAliquota === 'number' ? data.pisAliquota.toFixed(2) : null,\n        cofinsCst: data.cofinsCst || null,\n        cofinsAliquota: data.cofinsAliquota && typeof data.cofinsAliquota === 'number' ? data.cofinsAliquota.toFixed(2) : null,\n      };\n      await apiRequest(\"POST\", \"/api/products\", payload);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/products'] });\n      queryClient.invalidateQueries({ queryKey: ['/api/brands'] });\n    },\n  });\n\n  const updateProductMutation = useMutation({\n    mutationFn: async ({ id, data }: { id: string; data: ProductFormValues }) => {\n      const payload = {\n        name: data.name,\n        sku: data.sku,\n        categoryId: data.categoryId ? parseInt(data.categoryId) : null,\n        brand: data.brand || null,\n        price: data.price.toFixed(2),\n        cost: data.cost && typeof data.cost === 'number' ? data.cost.toFixed(2) : null,\n        stock: data.stock,\n        description: data.description || null,\n        image: imageUrls[0] || null,\n        images: imageUrls.length > 0 ? imageUrls : null,\n        featured: data.featured,\n        gtin: data.gtin || null,\n        gtinTributario: data.gtinTributario || null,\n        ncm: data.ncm || null,\n        cest: data.cest || null,\n        origem: data.taxOrigin || null,\n        icmsCst: data.icmsCst || null,\n        icmsAliquota: data.icmsAliquota && typeof data.icmsAliquota === 'number' ? data.icmsAliquota.toFixed(2) : null,\n        ipiCst: data.ipiCst || null,\n        ipiAliquota: data.ipiAliquota && typeof data.ipiAliquota === 'number' ? data.ipiAliquota.toFixed(2) : null,\n        pisCst: data.pisCst || null,\n        pisAliquota: data.pisAliquota && typeof data.pisAliquota === 'number' ? data.pisAliquota.toFixed(2) : null,\n        cofinsCst: data.cofinsCst || null,\n        cofinsAliquota: data.cofinsAliquota && typeof data.cofinsAliquota === 'number' ? data.cofinsAliquota.toFixed(2) : null,\n      };\n      await apiRequest(\"PATCH\", `/api/products/${id}`, payload);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/products'] });\n      queryClient.invalidateQueries({ queryKey: ['/api/brands'] });\n    },\n  });\n\n  const deleteProductMutation = useMutation({\n    mutationFn: async (id: string) => {\n      await apiRequest(\"DELETE\", `/api/products/${id}`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/products'] });\n    },\n  });\n\n  const toggleFeaturedMutation = useMutation({\n    mutationFn: async (id: string) => {\n      await apiRequest(\"PATCH\", `/api/products/${id}/toggle-featured`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/products'] });\n    },\n  });\n\n  const handleToggleFeatured = (product: ProductData) => {\n    toggleFeaturedMutation.mutate(product.id, {\n      onSuccess: () => {\n        toast({ \n          title: product.featured ? \"Removido dos destaques\" : \"Adicionado aos destaques\",\n          description: product.name,\n        });\n      },\n      onError: (error: Error) => {\n        const desc = isAdmin ? `Falha ao alterar destaque: ${error.message}` : \"Falha ao alterar destaque\";\n        toast({ title: \"Erro\", description: desc, variant: \"destructive\" });\n      },\n    });\n  };\n\n  const openAddForm = () => {\n    form.reset({ name: \"\", sku: \"\", categoryId: \"\", brand: \"\", price: 0, cost: \"\", stock: 0, description: \"\", featured: false, weight: \"\", width: \"\", height: \"\", depth: \"\", gtin: \"\", gtinTributario: \"\", ncm: \"\", cest: \"\", taxOrigin: \"\", icmsCst: \"\", icmsAliquota: \"\", ipiCst: \"\", ipiAliquota: \"\", pisCst: \"\", pisAliquota: \"\", cofinsCst: \"\", cofinsAliquota: \"\" });\n    setEditingProduct(null);\n    setImageUrls([]);\n    setActiveFormTab(\"dados\");\n    setViewMode(\"form\");\n  };\n\n  const openEditForm = (product: ProductData) => {\n    const schemaProduct = productsData.find(p => p.id === parseInt(product.id));\n    form.reset({\n      name: product.name,\n      sku: product.sku,\n      categoryId: product.categoryId ? String(product.categoryId) : \"\",\n      brand: product.brand,\n      price: product.price,\n      cost: product.cost ?? \"\",\n      stock: product.stock,\n      description: product.description || \"\",\n      featured: product.featured,\n      weight: product.weight ?? \"\",\n      width: product.width ?? \"\",\n      height: product.height ?? \"\",\n      depth: product.depth ?? \"\",\n      gtin: schemaProduct?.gtin || \"\",\n      gtinTributario: schemaProduct?.gtinTributario || \"\",\n      ncm: schemaProduct?.ncm || \"\",\n      cest: schemaProduct?.cest || \"\",\n      taxOrigin: schemaProduct?.origem || \"\",\n      icmsCst: schemaProduct?.icmsCst || \"\",\n      icmsAliquota: schemaProduct?.icmsAliquota ? parseFloat(schemaProduct.icmsAliquota) : \"\",\n      ipiCst: schemaProduct?.ipiCst || \"\",\n      ipiAliquota: schemaProduct?.ipiAliquota ? parseFloat(schemaProduct.ipiAliquota) : \"\",\n      pisCst: schemaProduct?.pisCst || \"\",\n      pisAliquota: schemaProduct?.pisAliquota ? parseFloat(schemaProduct.pisAliquota) : \"\",\n      cofinsCst: schemaProduct?.cofinsCst || \"\",\n      cofinsAliquota: schemaProduct?.cofinsAliquota ? parseFloat(schemaProduct.cofinsAliquota) : \"\",\n    });\n    setEditingProduct(product);\n    const existingImages = product.images || (product.image ? [product.image] : []);\n    setImageUrls(existingImages);\n    setActiveFormTab(\"dados\");\n    setViewMode(\"form\");\n  };\n\n  const openCloneForm = (product: ProductData) => {\n    const baseSku = product.sku.replace(/-\\d+$/, '');\n    const existingSkus = products.map(p => p.sku);\n    let counter = 1;\n    let newSku = `${baseSku}-${counter}`;\n    while (existingSkus.includes(newSku)) {\n      counter++;\n      newSku = `${baseSku}-${counter}`;\n    }\n    const schemaProductDup = productsData.find(p => p.id === parseInt(product.id));\n    form.reset({\n      name: product.name + \" (Copia)\",\n      sku: newSku,\n      categoryId: product.categoryId ? String(product.categoryId) : \"\",\n      brand: product.brand,\n      price: product.price,\n      cost: product.cost ?? \"\",\n      stock: product.stock,\n      description: product.description || \"\",\n      featured: false,\n      weight: product.weight ?? \"\",\n      width: product.width ?? \"\",\n      height: product.height ?? \"\",\n      depth: product.depth ?? \"\",\n      gtin: \"\",\n      gtinTributario: \"\",\n      ncm: schemaProductDup?.ncm || \"\",\n      cest: schemaProductDup?.cest || \"\",\n      taxOrigin: schemaProductDup?.origem || \"\",\n      icmsCst: schemaProductDup?.icmsCst || \"\",\n      icmsAliquota: schemaProductDup?.icmsAliquota ? parseFloat(schemaProductDup.icmsAliquota) : \"\",\n      ipiCst: schemaProductDup?.ipiCst || \"\",\n      ipiAliquota: schemaProductDup?.ipiAliquota ? parseFloat(schemaProductDup.ipiAliquota) : \"\",\n      pisCst: schemaProductDup?.pisCst || \"\",\n      pisAliquota: schemaProductDup?.pisAliquota ? parseFloat(schemaProductDup.pisAliquota) : \"\",\n      cofinsCst: schemaProductDup?.cofinsCst || \"\",\n      cofinsAliquota: schemaProductDup?.cofinsAliquota ? parseFloat(schemaProductDup.cofinsAliquota) : \"\",\n    });\n    setEditingProduct(null);\n    const existingImages = product.images || (product.image ? [product.image] : []);\n    setImageUrls(existingImages);\n    setActiveFormTab(\"dados\");\n    setViewMode(\"form\");\n  };\n\n  const handleSubmit = (values: ProductFormValues) => {\n    if (editingProduct) {\n      updateProductMutation.mutate(\n        { id: editingProduct.id, data: values },\n        {\n          onSuccess: () => {\n            toast({ title: \"Produto atualizado\", description: values.name });\n            setViewMode(\"list\");\n          },\n          onError: (error: Error) => {\n            const desc = isAdmin ? `Falha ao atualizar produto: ${error.message}` : \"Falha ao atualizar produto\";\n            toast({ title: \"Erro\", description: desc, variant: \"destructive\" });\n          },\n        }\n      );\n    } else {\n      createProductMutation.mutate(values, {\n        onSuccess: () => {\n          toast({ title: \"Produto criado\", description: values.name });\n          setViewMode(\"list\");\n        },\n        onError: (error: Error) => {\n          const desc = isAdmin ? `Falha ao criar produto: ${error.message}` : \"Falha ao criar produto\";\n          toast({ title: \"Erro\", description: desc, variant: \"destructive\" });\n        },\n      });\n    }\n  };\n\n  const handleDelete = (product: ProductData) => {\n    if (!window.confirm(`Excluir \"${product.name}\"?`)) return;\n    deleteProductMutation.mutate(product.id, {\n      onSuccess: () => {\n        toast({ title: \"Produto excluido\", description: product.name });\n      },\n      onError: (error: Error) => {\n        const desc = isAdmin ? `Falha ao excluir produto: ${error.message}` : \"Falha ao excluir produto\";\n        toast({ title: \"Erro\", description: desc, variant: \"destructive\" });\n      },\n    });\n  };\n\n  const formatPrice = (price: number) => {\n    return new Intl.NumberFormat('pt-BR', {\n      style: 'currency',\n      currency: 'BRL'\n    }).format(price);\n  };\n\n  const isPending = createProductMutation.isPending || updateProductMutation.isPending;\n\n  if (viewMode === \"form\") {\n    return (\n      <div className=\"h-full flex flex-col bg-background\">\n        <div className=\"border-b p-4\">\n          <div className=\"flex items-center gap-4\">\n            <Button \n              variant=\"ghost\" \n              size=\"icon\" \n              onClick={() => setViewMode(\"list\")}\n              data-testid=\"button-back-products\"\n            >\n              <ArrowLeft className=\"h-5 w-5\" />\n            </Button>\n            <div className=\"flex-1\">\n              <h1 className=\"text-xl font-bold\">\n                {editingProduct ? \"Editar Produto\" : \"Novo Produto\"}\n              </h1>\n              <p className=\"text-sm text-muted-foreground\">\n                {editingProduct ? `Editando: ${editingProduct.name}` : \"Preencha os dados do produto\"}\n              </p>\n            </div>\n            <Button \n              onClick={form.handleSubmit(handleSubmit)}\n              disabled={isPending}\n              className=\"bg-orange-500 hover:bg-orange-600\"\n              data-testid=\"button-save-product\"\n            >\n              {isPending ? (\n                <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />\n              ) : (\n                <Save className=\"h-4 w-4 mr-2\" />\n              )}\n              Salvar\n            </Button>\n          </div>\n        </div>\n\n        <div className=\"flex-1 flex overflow-hidden\">\n          <div className=\"flex-1 overflow-auto p-6\">\n            <Form {...form}>\n              <form className=\"space-y-6 max-w-4xl\">\n                <Tabs value={activeFormTab} onValueChange={setActiveFormTab}>\n                  <TabsList className=\"mb-4\">\n                    <TabsTrigger value=\"dados\" className=\"gap-2\">\n                      <Package className=\"h-4 w-4\" />\n                      Dados\n                    </TabsTrigger>\n                    <TabsTrigger value=\"precos\" className=\"gap-2\">\n                      <DollarSign className=\"h-4 w-4\" />\n                      Precos\n                    </TabsTrigger>\n                    <TabsTrigger value=\"estoque\" className=\"gap-2\">\n                      <Boxes className=\"h-4 w-4\" />\n                      Estoque\n                    </TabsTrigger>\n                    <TabsTrigger value=\"imagens\" className=\"gap-2\">\n                      <ImageIcon className=\"h-4 w-4\" />\n                      Imagens\n                    </TabsTrigger>\n                    <TabsTrigger value=\"dimensoes\" className=\"gap-2\">\n                      <Ruler className=\"h-4 w-4\" />\n                      Dimensoes\n                    </TabsTrigger>\n                    <TabsTrigger value=\"fiscal\" className=\"gap-2\">\n                      <FileText className=\"h-4 w-4\" />\n                      Fiscal\n                    </TabsTrigger>\n                  </TabsList>\n\n                  <TabsContent value=\"dados\" className=\"space-y-4\">\n                    <Card>\n                      <CardHeader className=\"pb-4\">\n                        <CardTitle className=\"text-base\">Informacoes Basicas</CardTitle>\n                      </CardHeader>\n                      <CardContent className=\"space-y-4\">\n                        <FormField\n                          control={form.control}\n                          name=\"name\"\n                          render={({ field }) => (\n                            <FormItem>\n                              <FormLabel>Nome do Produto *</FormLabel>\n                              <FormControl>\n                                <Input \n                                  {...field} \n                                  placeholder=\"Ex: Camiseta Polo Masculina\"\n                                  data-testid=\"input-product-name\" \n                                />\n                              </FormControl>\n                              <FormMessage />\n                            </FormItem>\n                          )}\n                        />\n\n                        <div className=\"grid grid-cols-2 gap-4\">\n                          <FormField\n                            control={form.control}\n                            name=\"sku\"\n                            render={({ field }) => (\n                              <FormItem>\n                                <FormLabel>Codigo (SKU) *</FormLabel>\n                                <FormControl>\n                                  <Input \n                                    {...field} \n                                    placeholder=\"Ex: CAM-001\"\n                                    data-testid=\"input-product-sku\" \n                                  />\n                                </FormControl>\n                                <FormMessage />\n                              </FormItem>\n                            )}\n                          />\n\n                          <FormField\n                            control={form.control}\n                            name=\"brand\"\n                            render={({ field }) => (\n                              <FormItem className=\"flex flex-col\">\n                                <FormLabel>Marca</FormLabel>\n                                <Popover open={brandPopoverOpen} onOpenChange={setBrandPopoverOpen}>\n                                  <PopoverTrigger asChild>\n                                    <FormControl>\n                                      <Button\n                                        variant=\"outline\"\n                                        role=\"combobox\"\n                                        aria-expanded={brandPopoverOpen}\n                                        className=\"justify-between font-normal\"\n                                        data-testid=\"input-product-brand\"\n                                      >\n                                        {field.value || \"Selecione ou crie uma marca\"}\n                                        <ChevronsUpDown className=\"ml-2 h-4 w-4 shrink-0 opacity-50\" />\n                                      </Button>\n                                    </FormControl>\n                                  </PopoverTrigger>\n                                  <PopoverContent className=\"w-[300px] p-0\" align=\"start\">\n                                    <Command>\n                                      <CommandInput \n                                        placeholder=\"Buscar ou criar marca...\" \n                                        value={brandSearch}\n                                        onValueChange={setBrandSearch}\n                                      />\n                                      <CommandList>\n                                        <CommandEmpty>\n                                          {brandSearch.trim() && (\n                                            <div \n                                              className=\"cursor-pointer p-2 hover-elevate rounded-md mx-1\"\n                                              onClick={() => {\n                                                field.onChange(brandSearch.trim());\n                                                setBrandSearch(\"\");\n                                                setBrandPopoverOpen(false);\n                                              }}\n                                            >\n                                              <div className=\"flex items-center gap-2\">\n                                                <Plus className=\"h-4 w-4\" />\n                                                <span>Criar marca \"{brandSearch.trim()}\"</span>\n                                              </div>\n                                            </div>\n                                          )}\n                                        </CommandEmpty>\n                                        <CommandGroup>\n                                          {brandsData\n                                            .filter(brand => \n                                              brand.toLowerCase().includes(brandSearch.toLowerCase())\n                                            )\n                                            .map((brand) => (\n                                              <CommandItem\n                                                key={brand}\n                                                value={brand}\n                                                onSelect={() => {\n                                                  field.onChange(brand);\n                                                  setBrandSearch(\"\");\n                                                  setBrandPopoverOpen(false);\n                                                }}\n                                              >\n                                                <Check\n                                                  className={`mr-2 h-4 w-4 ${\n                                                    field.value === brand ? \"opacity-100\" : \"opacity-0\"\n                                                  }`}\n                                                />\n                                                {brand}\n                                              </CommandItem>\n                                            ))}\n                                          {brandSearch.trim() && !brandsData.some(b => b.toLowerCase() === brandSearch.trim().toLowerCase()) && (\n                                            <CommandItem\n                                              value={`create-${brandSearch}`}\n                                              onSelect={() => {\n                                                field.onChange(brandSearch.trim());\n                                                setBrandSearch(\"\");\n                                                setBrandPopoverOpen(false);\n                                              }}\n                                            >\n                                              <Plus className=\"mr-2 h-4 w-4\" />\n                                              Criar \"{brandSearch.trim()}\"\n                                            </CommandItem>\n                                          )}\n                                        </CommandGroup>\n                                      </CommandList>\n                                    </Command>\n                                  </PopoverContent>\n                                </Popover>\n                                {field.value && (\n                                  <Button\n                                    type=\"button\"\n                                    variant=\"ghost\"\n                                    size=\"sm\"\n                                    className=\"w-fit h-6 px-2 text-xs text-muted-foreground\"\n                                    onClick={() => field.onChange(\"\")}\n                                  >\n                                    <X className=\"h-3 w-3 mr-1\" />\n                                    Limpar marca\n                                  </Button>\n                                )}\n                                <FormMessage />\n                              </FormItem>\n                            )}\n                          />\n                        </div>\n\n                        <FormField\n                          control={form.control}\n                          name=\"categoryId\"\n                          render={({ field }) => (\n                            <FormItem>\n                              <FormLabel>Categoria</FormLabel>\n                              <Select onValueChange={field.onChange} value={field.value}>\n                                <FormControl>\n                                  <SelectTrigger data-testid=\"select-product-category\">\n                                    <SelectValue placeholder=\"Selecione uma categoria\" />\n                                  </SelectTrigger>\n                                </FormControl>\n                                <SelectContent>\n                                  {categoriesData.map((cat) => (\n                                    <SelectItem key={cat.id} value={String(cat.id)}>\n                                      {cat.name}\n                                    </SelectItem>\n                                  ))}\n                                </SelectContent>\n                              </Select>\n                              <FormMessage />\n                            </FormItem>\n                          )}\n                        />\n\n                        <FormField\n                          control={form.control}\n                          name=\"description\"\n                          render={({ field }) => (\n                            <FormItem>\n                              <FormLabel>Descricao</FormLabel>\n                              <FormControl>\n                                <Textarea \n                                  {...field} \n                                  placeholder=\"Descreva as caracteristicas do produto...\"\n                                  className=\"min-h-[120px]\"\n                                  data-testid=\"input-product-description\" \n                                />\n                              </FormControl>\n                              <FormMessage />\n                            </FormItem>\n                          )}\n                        />\n\n                        <FormField\n                          control={form.control}\n                          name=\"featured\"\n                          render={({ field }) => (\n                            <FormItem className=\"flex items-center justify-between rounded-lg border p-3\">\n                              <div className=\"space-y-0.5\">\n                                <FormLabel>Produto em Destaque</FormLabel>\n                                <p className=\"text-sm text-muted-foreground\">\n                                  Exibir na secao de destaques do catalogo\n                                </p>\n                              </div>\n                              <FormControl>\n                                <Switch\n                                  checked={field.value}\n                                  onCheckedChange={field.onChange}\n                                  data-testid=\"switch-product-featured\"\n                                />\n                              </FormControl>\n                            </FormItem>\n                          )}\n                        />\n                      </CardContent>\n                    </Card>\n                  </TabsContent>\n\n                  <TabsContent value=\"precos\" className=\"space-y-4\">\n                    <Card>\n                      <CardHeader className=\"pb-4\">\n                        <CardTitle className=\"text-base\">Valores</CardTitle>\n                      </CardHeader>\n                      <CardContent className=\"space-y-4\">\n                        <div className=\"grid grid-cols-2 gap-4\">\n                          <FormField\n                            control={form.control}\n                            name=\"price\"\n                            render={({ field }) => (\n                              <FormItem>\n                                <FormLabel>Preco de Venda *</FormLabel>\n                                <FormControl>\n                                  <div className=\"relative\">\n                                    <span className=\"absolute left-3 top-1/2 -translate-y-1/2 text-muted-foreground\">R$</span>\n                                    <Input \n                                      {...field} \n                                      type=\"number\"\n                                      step=\"0.01\"\n                                      min=\"0\"\n                                      className=\"pl-10\"\n                                      data-testid=\"input-product-price\" \n                                    />\n                                  </div>\n                                </FormControl>\n                                <FormMessage />\n                              </FormItem>\n                            )}\n                          />\n\n                          <FormField\n                            control={form.control}\n                            name=\"cost\"\n                            render={({ field }) => (\n                              <FormItem>\n                                <FormLabel>Custo</FormLabel>\n                                <FormControl>\n                                  <div className=\"relative\">\n                                    <span className=\"absolute left-3 top-1/2 -translate-y-1/2 text-muted-foreground\">R$</span>\n                                    <Input \n                                      {...field} \n                                      type=\"number\"\n                                      step=\"0.01\"\n                                      min=\"0\"\n                                      className=\"pl-10\"\n                                      placeholder=\"0.00\"\n                                      data-testid=\"input-product-cost\" \n                                    />\n                                  </div>\n                                </FormControl>\n                                <FormMessage />\n                              </FormItem>\n                            )}\n                          />\n                        </div>\n\n                        {form.watch(\"price\") > 0 && form.watch(\"cost\") && typeof form.watch(\"cost\") === 'number' && (form.watch(\"cost\") as number) > 0 && (\n                          <div className=\"rounded-lg bg-muted/50 p-4\">\n                            <p className=\"text-sm text-muted-foreground\">Margem de Lucro</p>\n                            <p className=\"text-2xl font-bold text-green-600\">\n                              {(((form.watch(\"price\") - (form.watch(\"cost\") as number)) / form.watch(\"price\")) * 100).toFixed(1)}%\n                            </p>\n                            <p className=\"text-sm text-muted-foreground\">\n                              Lucro: {formatPrice(form.watch(\"price\") - (form.watch(\"cost\") as number))}\n                            </p>\n                          </div>\n                        )}\n                      </CardContent>\n                    </Card>\n                  </TabsContent>\n\n                  <TabsContent value=\"estoque\" className=\"space-y-4\">\n                    <Card>\n                      <CardHeader className=\"pb-4\">\n                        <CardTitle className=\"text-base\">Controle de Estoque</CardTitle>\n                      </CardHeader>\n                      <CardContent className=\"space-y-4\">\n                        <FormField\n                          control={form.control}\n                          name=\"stock\"\n                          render={({ field }) => (\n                            <FormItem>\n                              <FormLabel>Quantidade em Estoque</FormLabel>\n                              <FormControl>\n                                <Input \n                                  {...field} \n                                  type=\"number\"\n                                  min=\"0\"\n                                  className=\"max-w-[200px]\"\n                                  data-testid=\"input-product-stock\" \n                                />\n                              </FormControl>\n                              <FormMessage />\n                            </FormItem>\n                          )}\n                        />\n                      </CardContent>\n                    </Card>\n                  </TabsContent>\n\n                  <TabsContent value=\"imagens\" className=\"space-y-4\">\n                    <Card>\n                      <CardHeader className=\"pb-4\">\n                        <CardTitle className=\"text-base\">Imagens do Produto</CardTitle>\n                      </CardHeader>\n                      <CardContent className=\"space-y-4\">\n                        <div className=\"grid grid-cols-5 gap-4\">\n                          {imageUrls.map((url, index) => (\n                            <div \n                              key={index} \n                              className=\"relative aspect-square rounded-lg border-2 overflow-hidden bg-muted group\"\n                            >\n                              <img \n                                src={url} \n                                alt={`Imagem ${index + 1}`} \n                                className=\"w-full h-full object-cover\"\n                              />\n                              <Button\n                                type=\"button\"\n                                variant=\"destructive\"\n                                size=\"icon\"\n                                className=\"absolute top-2 right-2 h-6 w-6 opacity-0 group-hover:opacity-100 transition-opacity\"\n                                onClick={() => removeImage(index)}\n                                data-testid={`button-remove-image-${index}`}\n                              >\n                                <X className=\"h-4 w-4\" />\n                              </Button>\n                              {index === 0 && (\n                                <Badge className=\"absolute bottom-2 left-2 text-xs bg-orange-500\">\n                                  Principal\n                                </Badge>\n                              )}\n                            </div>\n                          ))}\n                          \n                          {imageUrls.length < MAX_IMAGES && (\n                            <label className=\"cursor-pointer aspect-square rounded-lg border-2 border-dashed flex flex-col items-center justify-center gap-2 text-muted-foreground hover:border-orange-500 hover:text-orange-500 transition-colors\">\n                              <input\n                                type=\"file\"\n                                accept=\"image/jpeg,image/png,image/webp,image/gif\"\n                                className=\"sr-only\"\n                                onChange={(e) => {\n                                  const file = e.target.files?.[0];\n                                  if (file) handleImageUpload(file);\n                                  e.target.value = '';\n                                }}\n                                data-testid=\"input-product-image\"\n                              />\n                              {isUploading ? (\n                                <Loader2 className=\"h-8 w-8 animate-spin\" />\n                              ) : (\n                                <>\n                                  <Upload className=\"h-8 w-8\" />\n                                  <span className=\"text-xs text-center\">Adicionar<br/>imagem</span>\n                                </>\n                              )}\n                            </label>\n                          )}\n                        </div>\n                        \n                        <p className=\"text-xs text-muted-foreground\">\n                          Formatos: JPG, PNG, WebP, GIF. Maximo 5 imagens. A primeira sera a imagem principal.\n                        </p>\n                      </CardContent>\n                    </Card>\n                  </TabsContent>\n\n                  <TabsContent value=\"dimensoes\" className=\"space-y-4\">\n                    <Card>\n                      <CardHeader className=\"pb-4\">\n                        <CardTitle className=\"text-base\">Medidas e Peso</CardTitle>\n                        <p className=\"text-sm text-muted-foreground\">\n                          Informacoes para calculo de frete e logistica\n                        </p>\n                      </CardHeader>\n                      <CardContent className=\"space-y-4\">\n                        <FormField\n                          control={form.control}\n                          name=\"weight\"\n                          render={({ field }) => (\n                            <FormItem>\n                              <FormLabel>Peso (kg)</FormLabel>\n                              <FormControl>\n                                <Input \n                                  {...field} \n                                  type=\"number\"\n                                  step=\"0.001\"\n                                  min=\"0\"\n                                  placeholder=\"Ex: 0.500\"\n                                  className=\"max-w-[200px]\"\n                                  data-testid=\"input-product-weight\" \n                                />\n                              </FormControl>\n                              <FormMessage />\n                            </FormItem>\n                          )}\n                        />\n\n                        <Separator />\n\n                        <div className=\"grid grid-cols-3 gap-4\">\n                          <FormField\n                            control={form.control}\n                            name=\"width\"\n                            render={({ field }) => (\n                              <FormItem>\n                                <FormLabel>Largura (cm)</FormLabel>\n                                <FormControl>\n                                  <Input \n                                    {...field} \n                                    type=\"number\"\n                                    step=\"0.01\"\n                                    min=\"0\"\n                                    placeholder=\"Ex: 20\"\n                                    data-testid=\"input-product-width\" \n                                  />\n                                </FormControl>\n                                <FormMessage />\n                              </FormItem>\n                            )}\n                          />\n\n                          <FormField\n                            control={form.control}\n                            name=\"height\"\n                            render={({ field }) => (\n                              <FormItem>\n                                <FormLabel>Altura (cm)</FormLabel>\n                                <FormControl>\n                                  <Input \n                                    {...field} \n                                    type=\"number\"\n                                    step=\"0.01\"\n                                    min=\"0\"\n                                    placeholder=\"Ex: 15\"\n                                    data-testid=\"input-product-height\" \n                                  />\n                                </FormControl>\n                                <FormMessage />\n                              </FormItem>\n                            )}\n                          />\n\n                          <FormField\n                            control={form.control}\n                            name=\"depth\"\n                            render={({ field }) => (\n                              <FormItem>\n                                <FormLabel>Profundidade (cm)</FormLabel>\n                                <FormControl>\n                                  <Input \n                                    {...field} \n                                    type=\"number\"\n                                    step=\"0.01\"\n                                    min=\"0\"\n                                    placeholder=\"Ex: 10\"\n                                    data-testid=\"input-product-depth\" \n                                  />\n                                </FormControl>\n                                <FormMessage />\n                              </FormItem>\n                            )}\n                          />\n                        </div>\n                      </CardContent>\n                    </Card>\n                  </TabsContent>\n\n                  <TabsContent value=\"fiscal\" className=\"space-y-4\">\n                    <Card>\n                      <CardHeader className=\"pb-4\">\n                        <CardTitle className=\"text-base flex items-center gap-2\">\n                          <Barcode className=\"h-4 w-4\" />\n                          Codigos de Barras\n                        </CardTitle>\n                      </CardHeader>\n                      <CardContent className=\"space-y-4\">\n                        <div className=\"grid grid-cols-2 gap-4\">\n                          <FormField\n                            control={form.control}\n                            name=\"gtin\"\n                            render={({ field }) => (\n                              <FormItem>\n                                <FormLabel>GTIN/EAN</FormLabel>\n                                <FormControl>\n                                  <Input \n                                    {...field} \n                                    placeholder=\"Ex: 7891234567890\"\n                                    data-testid=\"input-product-gtin\" \n                                  />\n                                </FormControl>\n                                <FormMessage />\n                              </FormItem>\n                            )}\n                          />\n                          <FormField\n                            control={form.control}\n                            name=\"gtinTributario\"\n                            render={({ field }) => (\n                              <FormItem>\n                                <FormLabel>GTIN/EAN Tributario</FormLabel>\n                                <FormControl>\n                                  <Input \n                                    {...field} \n                                    placeholder=\"Ex: 7891234567890\"\n                                    data-testid=\"input-product-gtin-tributario\" \n                                  />\n                                </FormControl>\n                                <FormMessage />\n                              </FormItem>\n                            )}\n                          />\n                        </div>\n                      </CardContent>\n                    </Card>\n\n                    <Card>\n                      <CardHeader className=\"pb-4\">\n                        <CardTitle className=\"text-base\">Classificacao Fiscal</CardTitle>\n                      </CardHeader>\n                      <CardContent className=\"space-y-4\">\n                        <div className=\"grid grid-cols-2 gap-4\">\n                          <FormField\n                            control={form.control}\n                            name=\"ncm\"\n                            render={({ field }) => (\n                              <FormItem>\n                                <FormLabel>NCM</FormLabel>\n                                <FormControl>\n                                  <Input \n                                    {...field} \n                                    placeholder=\"Ex: 6109.10.00\"\n                                    data-testid=\"input-product-ncm\" \n                                  />\n                                </FormControl>\n                                <FormMessage />\n                              </FormItem>\n                            )}\n                          />\n                          <FormField\n                            control={form.control}\n                            name=\"cest\"\n                            render={({ field }) => (\n                              <FormItem>\n                                <FormLabel>CEST</FormLabel>\n                                <FormControl>\n                                  <Input \n                                    {...field} \n                                    placeholder=\"Ex: 28.038.00\"\n                                    data-testid=\"input-product-cest\" \n                                  />\n                                </FormControl>\n                                <FormMessage />\n                              </FormItem>\n                            )}\n                          />\n                        </div>\n                        <FormField\n                          control={form.control}\n                          name=\"taxOrigin\"\n                          render={({ field }) => (\n                            <FormItem>\n                              <FormLabel>Origem</FormLabel>\n                              <Select onValueChange={field.onChange} value={field.value || \"\"}>\n                                <FormControl>\n                                  <SelectTrigger data-testid=\"select-product-tax-origin\">\n                                    <SelectValue placeholder=\"Selecione a origem\" />\n                                  </SelectTrigger>\n                                </FormControl>\n                                <SelectContent>\n                                  <SelectItem value=\"0\">0 - Nacional</SelectItem>\n                                  <SelectItem value=\"1\">1 - Estrangeira - Importacao direta</SelectItem>\n                                  <SelectItem value=\"2\">2 - Estrangeira - Adquirida no mercado interno</SelectItem>\n                                  <SelectItem value=\"3\">3 - Nacional - Mercadoria ou bem com conteudo de importacao superior a 40%</SelectItem>\n                                  <SelectItem value=\"4\">4 - Nacional - Producao em conformidade com PPB</SelectItem>\n                                  <SelectItem value=\"5\">5 - Nacional - Mercadoria ou bem com conteudo de importacao inferior ou igual a 40%</SelectItem>\n                                  <SelectItem value=\"6\">6 - Estrangeira - Importacao direta, sem similar nacional, constante em lista da CAMEX</SelectItem>\n                                  <SelectItem value=\"7\">7 - Estrangeira - Adquirida no mercado interno, sem similar nacional, constante em lista da CAMEX</SelectItem>\n                                  <SelectItem value=\"8\">8 - Nacional - Mercadoria ou bem com conteudo de importacao superior a 70%</SelectItem>\n                                </SelectContent>\n                              </Select>\n                              <FormMessage />\n                            </FormItem>\n                          )}\n                        />\n                      </CardContent>\n                    </Card>\n\n                    <Card>\n                      <CardHeader className=\"pb-4\">\n                        <CardTitle className=\"text-base\">ICMS</CardTitle>\n                      </CardHeader>\n                      <CardContent className=\"space-y-4\">\n                        <div className=\"grid grid-cols-2 gap-4\">\n                          <FormField\n                            control={form.control}\n                            name=\"icmsCst\"\n                            render={({ field }) => (\n                              <FormItem>\n                                <FormLabel>CST ICMS</FormLabel>\n                                <Select onValueChange={field.onChange} value={field.value || \"\"}>\n                                  <FormControl>\n                                    <SelectTrigger data-testid=\"select-product-icms-cst\">\n                                      <SelectValue placeholder=\"Selecione CST\" />\n                                    </SelectTrigger>\n                                  </FormControl>\n                                  <SelectContent>\n                                    <SelectItem value=\"00\">00 - Tributada integralmente</SelectItem>\n                                    <SelectItem value=\"10\">10 - Tributada com cobranca de ICMS por ST</SelectItem>\n                                    <SelectItem value=\"20\">20 - Com reducao de base de calculo</SelectItem>\n                                    <SelectItem value=\"30\">30 - Isenta ou nao tributada com cobranca de ICMS por ST</SelectItem>\n                                    <SelectItem value=\"40\">40 - Isenta</SelectItem>\n                                    <SelectItem value=\"41\">41 - Nao tributada</SelectItem>\n                                    <SelectItem value=\"50\">50 - Suspensao</SelectItem>\n                                    <SelectItem value=\"51\">51 - Diferimento</SelectItem>\n                                    <SelectItem value=\"60\">60 - ICMS cobrado anteriormente por ST</SelectItem>\n                                    <SelectItem value=\"70\">70 - Com reducao de base de calculo e cobranca de ICMS por ST</SelectItem>\n                                    <SelectItem value=\"90\">90 - Outras</SelectItem>\n                                  </SelectContent>\n                                </Select>\n                                <FormMessage />\n                              </FormItem>\n                            )}\n                          />\n                          <FormField\n                            control={form.control}\n                            name=\"icmsAliquota\"\n                            render={({ field }) => (\n                              <FormItem>\n                                <FormLabel>Aliquota ICMS (%)</FormLabel>\n                                <FormControl>\n                                  <Input \n                                    {...field} \n                                    type=\"number\"\n                                    step=\"0.01\"\n                                    min=\"0\"\n                                    placeholder=\"Ex: 18\"\n                                    data-testid=\"input-product-icms-aliquota\" \n                                  />\n                                </FormControl>\n                                <FormMessage />\n                              </FormItem>\n                            )}\n                          />\n                        </div>\n                      </CardContent>\n                    </Card>\n\n                    <Card>\n                      <CardHeader className=\"pb-4\">\n                        <CardTitle className=\"text-base\">IPI</CardTitle>\n                      </CardHeader>\n                      <CardContent className=\"space-y-4\">\n                        <div className=\"grid grid-cols-2 gap-4\">\n                          <FormField\n                            control={form.control}\n                            name=\"ipiCst\"\n                            render={({ field }) => (\n                              <FormItem>\n                                <FormLabel>CST IPI</FormLabel>\n                                <Select onValueChange={field.onChange} value={field.value || \"\"}>\n                                  <FormControl>\n                                    <SelectTrigger data-testid=\"select-product-ipi-cst\">\n                                      <SelectValue placeholder=\"Selecione CST\" />\n                                    </SelectTrigger>\n                                  </FormControl>\n                                  <SelectContent>\n                                    <SelectItem value=\"00\">00 - Entrada com recuperacao de credito</SelectItem>\n                                    <SelectItem value=\"01\">01 - Entrada tributada com aliquota zero</SelectItem>\n                                    <SelectItem value=\"02\">02 - Entrada isenta</SelectItem>\n                                    <SelectItem value=\"03\">03 - Entrada nao tributada</SelectItem>\n                                    <SelectItem value=\"04\">04 - Entrada imune</SelectItem>\n                                    <SelectItem value=\"05\">05 - Entrada com suspensao</SelectItem>\n                                    <SelectItem value=\"49\">49 - Outras entradas</SelectItem>\n                                    <SelectItem value=\"50\">50 - Saida tributada</SelectItem>\n                                    <SelectItem value=\"51\">51 - Saida tributada com aliquota zero</SelectItem>\n                                    <SelectItem value=\"52\">52 - Saida isenta</SelectItem>\n                                    <SelectItem value=\"53\">53 - Saida nao tributada</SelectItem>\n                                    <SelectItem value=\"54\">54 - Saida imune</SelectItem>\n                                    <SelectItem value=\"55\">55 - Saida com suspensao</SelectItem>\n                                    <SelectItem value=\"99\">99 - Outras saidas</SelectItem>\n                                  </SelectContent>\n                                </Select>\n                                <FormMessage />\n                              </FormItem>\n                            )}\n                          />\n                          <FormField\n                            control={form.control}\n                            name=\"ipiAliquota\"\n                            render={({ field }) => (\n                              <FormItem>\n                                <FormLabel>Aliquota IPI (%)</FormLabel>\n                                <FormControl>\n                                  <Input \n                                    {...field} \n                                    type=\"number\"\n                                    step=\"0.01\"\n                                    min=\"0\"\n                                    placeholder=\"Ex: 5\"\n                                    data-testid=\"input-product-ipi-aliquota\" \n                                  />\n                                </FormControl>\n                                <FormMessage />\n                              </FormItem>\n                            )}\n                          />\n                        </div>\n                      </CardContent>\n                    </Card>\n\n                    <Card>\n                      <CardHeader className=\"pb-4\">\n                        <CardTitle className=\"text-base\">PIS/COFINS</CardTitle>\n                      </CardHeader>\n                      <CardContent className=\"space-y-4\">\n                        <div className=\"grid grid-cols-2 gap-4\">\n                          <FormField\n                            control={form.control}\n                            name=\"pisCst\"\n                            render={({ field }) => (\n                              <FormItem>\n                                <FormLabel>CST PIS</FormLabel>\n                                <Select onValueChange={field.onChange} value={field.value || \"\"}>\n                                  <FormControl>\n                                    <SelectTrigger data-testid=\"select-product-pis-cst\">\n                                      <SelectValue placeholder=\"Selecione CST\" />\n                                    </SelectTrigger>\n                                  </FormControl>\n                                  <SelectContent>\n                                    <SelectItem value=\"01\">01 - Operacao tributavel com aliquota basica</SelectItem>\n                                    <SelectItem value=\"02\">02 - Operacao tributavel com aliquota diferenciada</SelectItem>\n                                    <SelectItem value=\"03\">03 - Operacao tributavel com aliquota por unidade de medida de produto</SelectItem>\n                                    <SelectItem value=\"04\">04 - Operacao tributavel monofasica - revenda a aliquota zero</SelectItem>\n                                    <SelectItem value=\"05\">05 - Operacao tributavel por ST</SelectItem>\n                                    <SelectItem value=\"06\">06 - Operacao tributavel a aliquota zero</SelectItem>\n                                    <SelectItem value=\"07\">07 - Operacao isenta da contribuicao</SelectItem>\n                                    <SelectItem value=\"08\">08 - Operacao sem incidencia da contribuicao</SelectItem>\n                                    <SelectItem value=\"09\">09 - Operacao com suspensao da contribuicao</SelectItem>\n                                    <SelectItem value=\"49\">49 - Outras operacoes de saida</SelectItem>\n                                    <SelectItem value=\"99\">99 - Outras operacoes</SelectItem>\n                                  </SelectContent>\n                                </Select>\n                                <FormMessage />\n                              </FormItem>\n                            )}\n                          />\n                          <FormField\n                            control={form.control}\n                            name=\"pisAliquota\"\n                            render={({ field }) => (\n                              <FormItem>\n                                <FormLabel>Aliquota PIS (%)</FormLabel>\n                                <FormControl>\n                                  <Input \n                                    {...field} \n                                    type=\"number\"\n                                    step=\"0.01\"\n                                    min=\"0\"\n                                    placeholder=\"Ex: 1.65\"\n                                    data-testid=\"input-product-pis-aliquota\" \n                                  />\n                                </FormControl>\n                                <FormMessage />\n                              </FormItem>\n                            )}\n                          />\n                        </div>\n                        <div className=\"grid grid-cols-2 gap-4\">\n                          <FormField\n                            control={form.control}\n                            name=\"cofinsCst\"\n                            render={({ field }) => (\n                              <FormItem>\n                                <FormLabel>CST COFINS</FormLabel>\n                                <Select onValueChange={field.onChange} value={field.value || \"\"}>\n                                  <FormControl>\n                                    <SelectTrigger data-testid=\"select-product-cofins-cst\">\n                                      <SelectValue placeholder=\"Selecione CST\" />\n                                    </SelectTrigger>\n                                  </FormControl>\n                                  <SelectContent>\n                                    <SelectItem value=\"01\">01 - Operacao tributavel com aliquota basica</SelectItem>\n                                    <SelectItem value=\"02\">02 - Operacao tributavel com aliquota diferenciada</SelectItem>\n                                    <SelectItem value=\"03\">03 - Operacao tributavel com aliquota por unidade de medida de produto</SelectItem>\n                                    <SelectItem value=\"04\">04 - Operacao tributavel monofasica - revenda a aliquota zero</SelectItem>\n                                    <SelectItem value=\"05\">05 - Operacao tributavel por ST</SelectItem>\n                                    <SelectItem value=\"06\">06 - Operacao tributavel a aliquota zero</SelectItem>\n                                    <SelectItem value=\"07\">07 - Operacao isenta da contribuicao</SelectItem>\n                                    <SelectItem value=\"08\">08 - Operacao sem incidencia da contribuicao</SelectItem>\n                                    <SelectItem value=\"09\">09 - Operacao com suspensao da contribuicao</SelectItem>\n                                    <SelectItem value=\"49\">49 - Outras operacoes de saida</SelectItem>\n                                    <SelectItem value=\"99\">99 - Outras operacoes</SelectItem>\n                                  </SelectContent>\n                                </Select>\n                                <FormMessage />\n                              </FormItem>\n                            )}\n                          />\n                          <FormField\n                            control={form.control}\n                            name=\"cofinsAliquota\"\n                            render={({ field }) => (\n                              <FormItem>\n                                <FormLabel>Aliquota COFINS (%)</FormLabel>\n                                <FormControl>\n                                  <Input \n                                    {...field} \n                                    type=\"number\"\n                                    step=\"0.01\"\n                                    min=\"0\"\n                                    placeholder=\"Ex: 7.6\"\n                                    data-testid=\"input-product-cofins-aliquota\" \n                                  />\n                                </FormControl>\n                                <FormMessage />\n                              </FormItem>\n                            )}\n                          />\n                        </div>\n                      </CardContent>\n                    </Card>\n                  </TabsContent>\n                </Tabs>\n              </form>\n            </Form>\n          </div>\n\n          <div className=\"w-80 border-l bg-muted/30 p-4 hidden lg:block\">\n            <h3 className=\"font-semibold mb-4\">Preview</h3>\n            <Card>\n              <CardContent className=\"p-3\">\n                <div className=\"aspect-square rounded-md bg-muted mb-3 flex items-center justify-center overflow-hidden\">\n                  {imageUrls[0] ? (\n                    <img src={imageUrls[0]} alt=\"Preview\" className=\"w-full h-full object-cover\" />\n                  ) : (\n                    <Package className=\"h-12 w-12 text-muted-foreground\" />\n                  )}\n                </div>\n                <h4 className=\"font-medium text-sm truncate\">\n                  {form.watch(\"name\") || \"Nome do produto\"}\n                </h4>\n                <p className=\"text-xs text-muted-foreground truncate\">\n                  {form.watch(\"sku\") || \"SKU\"}\n                </p>\n                <p className=\"font-bold text-orange-500 mt-2\">\n                  {formatPrice(form.watch(\"price\") || 0)}\n                </p>\n                {form.watch(\"featured\") && (\n                  <Badge className=\"mt-2 bg-yellow-500/20 text-yellow-600\">\n                    <Star className=\"h-3 w-3 mr-1 fill-current\" />\n                    Destaque\n                  </Badge>\n                )}\n              </CardContent>\n            </Card>\n          </div>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"p-6 lg:p-8 space-y-6\">\n      <div className=\"flex items-center justify-between gap-4 flex-wrap\">\n        <div>\n          <h1 className=\"text-2xl font-bold\">Produtos</h1>\n          <p className=\"text-muted-foreground\">Gerencie seu catalogo de produtos</p>\n        </div>\n        <Button \n          onClick={openAddForm} \n          className=\"bg-orange-500 hover:bg-orange-600\"\n          data-testid=\"button-add-product\"\n        >\n          <Plus className=\"h-4 w-4 mr-2\" />\n          Novo Produto\n        </Button>\n      </div>\n\n      <div className=\"flex items-center gap-4 flex-wrap\">\n        <div className=\"relative flex-1 min-w-[200px] max-w-md\">\n          <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\n          <Input\n            placeholder=\"Buscar por nome ou codigo...\"\n            value={searchQuery}\n            onChange={(e) => handleSearchChange(e.target.value)}\n            className=\"pl-9\"\n            data-testid=\"input-search-products\"\n          />\n        </div>\n        <Select value={filterCategory || \"all\"} onValueChange={handleCategoryFilter}>\n          <SelectTrigger className=\"w-[180px]\" data-testid=\"filter-category\">\n            <SelectValue placeholder=\"Categoria\" />\n          </SelectTrigger>\n          <SelectContent>\n            <SelectItem value=\"all\">Todas Categorias</SelectItem>\n            {categoriesData.map((cat) => (\n              <SelectItem key={cat.id} value={String(cat.id)}>{cat.name}</SelectItem>\n            ))}\n          </SelectContent>\n        </Select>\n        <Select value={filterBrand || \"all\"} onValueChange={handleBrandFilter}>\n          <SelectTrigger className=\"w-[180px]\" data-testid=\"filter-brand\">\n            <SelectValue placeholder=\"Marca\" />\n          </SelectTrigger>\n          <SelectContent>\n            <SelectItem value=\"all\">Todas Marcas</SelectItem>\n            {brandsData.map((brand) => (\n              <SelectItem key={brand} value={brand}>{brand}</SelectItem>\n            ))}\n          </SelectContent>\n        </Select>\n        <p className=\"text-sm text-muted-foreground\">\n          {filteredProducts.length} produto(s)\n          {totalPages > 1 && ` - Pagina ${currentPage} de ${totalPages}`}\n        </p>\n      </div>\n\n      {isLoading ? (\n        <div className=\"flex items-center justify-center py-12\">\n          <Loader2 className=\"h-8 w-8 animate-spin text-muted-foreground\" />\n        </div>\n      ) : filteredProducts.length === 0 ? (\n        <Card>\n          <CardContent className=\"flex flex-col items-center justify-center py-12 text-center\">\n            <Package className=\"h-12 w-12 text-muted-foreground mb-4\" />\n            <h3 className=\"font-semibold mb-2\">Nenhum produto encontrado</h3>\n            <p className=\"text-muted-foreground text-sm mb-4\">\n              {searchQuery ? \"Tente buscar por outro termo\" : \"Adicione seu primeiro produto\"}\n            </p>\n            {!searchQuery && (\n              <Button onClick={openAddForm} className=\"bg-orange-500 hover:bg-orange-600\">\n                <Plus className=\"h-4 w-4 mr-2\" />\n                Adicionar Produto\n              </Button>\n            )}\n          </CardContent>\n        </Card>\n      ) : (\n        <div className=\"rounded-lg border overflow-hidden\">\n          <Table>\n            <TableHeader>\n              <TableRow className=\"bg-muted/50\">\n                <TableHead className=\"w-16\"></TableHead>\n                <TableHead>Codigo</TableHead>\n                <TableHead>Produto</TableHead>\n                <TableHead>Categoria</TableHead>\n                <TableHead className=\"text-right\">Preco</TableHead>\n                <TableHead className=\"text-right\">Estoque</TableHead>\n                <TableHead className=\"w-[120px]\"></TableHead>\n              </TableRow>\n            </TableHeader>\n            <TableBody>\n              {paginatedProducts.map((product) => (\n                <TableRow \n                  key={product.id}\n                  className=\"hover-elevate cursor-pointer\"\n                  onClick={() => openEditForm(product)}\n                  data-testid={`row-product-${product.id}`}\n                >\n                  <TableCell onClick={(e) => e.stopPropagation()}>\n                    <div className=\"w-10 h-10 rounded bg-muted flex items-center justify-center overflow-hidden\">\n                      {product.image ? (\n                        <img src={product.image} alt={product.name} className=\"w-full h-full object-cover\" />\n                      ) : (\n                        <ImageIcon className=\"h-4 w-4 text-muted-foreground\" />\n                      )}\n                    </div>\n                  </TableCell>\n                  <TableCell>\n                    <Badge variant=\"outline\">{product.sku}</Badge>\n                  </TableCell>\n                  <TableCell>\n                    <div className=\"flex items-center gap-2\">\n                      <span className=\"font-medium\">{product.name}</span>\n                      {product.featured && (\n                        <Star className=\"h-4 w-4 fill-yellow-500 text-yellow-500\" />\n                      )}\n                    </div>\n                  </TableCell>\n                  <TableCell className=\"text-muted-foreground\">{product.category}</TableCell>\n                  <TableCell className=\"text-right font-medium\">{formatPrice(product.price)}</TableCell>\n                  <TableCell className=\"text-right\">\n                    <span className={product.stock === 0 ? \"text-destructive font-medium\" : \"\"}>\n                      {product.stock}\n                    </span>\n                  </TableCell>\n                  <TableCell onClick={(e) => e.stopPropagation()}>\n                    <div className=\"flex items-center gap-1 justify-end\">\n                      <Button\n                        variant=\"ghost\"\n                        size=\"icon\"\n                        onClick={() => handleToggleFeatured(product)}\n                        title={product.featured ? \"Remover destaque\" : \"Adicionar destaque\"}\n                        data-testid={`button-featured-${product.id}`}\n                      >\n                        <Star className={`h-4 w-4 ${product.featured ? \"fill-yellow-500 text-yellow-500\" : \"\"}`} />\n                      </Button>\n                      <Button\n                        variant=\"ghost\"\n                        size=\"icon\"\n                        onClick={() => openCloneForm(product)}\n                        title=\"Duplicar\"\n                        data-testid={`button-clone-${product.id}`}\n                      >\n                        <Copy className=\"h-4 w-4\" />\n                      </Button>\n                      <Button\n                        variant=\"ghost\"\n                        size=\"icon\"\n                        onClick={() => openEditForm(product)}\n                        data-testid={`button-edit-${product.id}`}\n                      >\n                        <Pencil className=\"h-4 w-4\" />\n                      </Button>\n                      <Button\n                        variant=\"ghost\"\n                        size=\"icon\"\n                        onClick={() => handleDelete(product)}\n                        className=\"text-destructive\"\n                        data-testid={`button-delete-${product.id}`}\n                      >\n                        <Trash2 className=\"h-4 w-4\" />\n                      </Button>\n                    </div>\n                  </TableCell>\n                </TableRow>\n              ))}\n            </TableBody>\n          </Table>\n        </div>\n      )}\n\n      {/* Pagination Controls */}\n      {totalPages > 1 && (\n        <div className=\"flex items-center justify-between gap-4 pt-4\">\n          <p className=\"text-sm text-muted-foreground\">\n            Mostrando {startIndex + 1}-{Math.min(endIndex, filteredProducts.length)} de {filteredProducts.length} produtos\n          </p>\n          <div className=\"flex items-center gap-2\">\n            <Button\n              variant=\"outline\"\n              onClick={() => setCurrentPage(p => Math.max(1, p - 1))}\n              disabled={currentPage === 1}\n              data-testid=\"button-prev-page\"\n            >\n              <ChevronLeft className=\"h-4 w-4 mr-1\" />\n              Anterior\n            </Button>\n            <div className=\"flex items-center gap-1\">\n              {Array.from({ length: Math.min(5, totalPages) }, (_, i) => {\n                let pageNum: number;\n                if (totalPages <= 5) {\n                  pageNum = i + 1;\n                } else if (currentPage <= 3) {\n                  pageNum = i + 1;\n                } else if (currentPage >= totalPages - 2) {\n                  pageNum = totalPages - 4 + i;\n                } else {\n                  pageNum = currentPage - 2 + i;\n                }\n                return (\n                  <Button\n                    key={pageNum}\n                    variant={currentPage === pageNum ? \"default\" : \"outline\"}\n                    size=\"icon\"\n                    onClick={() => setCurrentPage(pageNum)}\n                    data-testid={`button-page-${pageNum}`}\n                  >\n                    {pageNum}\n                  </Button>\n                );\n              })}\n            </div>\n            <Button\n              variant=\"outline\"\n              onClick={() => setCurrentPage(p => Math.min(totalPages, p + 1))}\n              disabled={currentPage === totalPages}\n              data-testid=\"button-next-page\"\n            >\n              Proxima\n              <ChevronRight className=\"h-4 w-4 ml-1\" />\n            </Button>\n          </div>\n        </div>\n      )}\n    </div>\n  );\n}\n","path":null,"size_bytes":78740,"size_tokens":null},"client/src/components/ui/calendar.tsx":{"content":"import * as React from \"react\"\nimport { ChevronLeft, ChevronRight } from \"lucide-react\"\nimport { DayPicker } from \"react-day-picker\"\n\nimport { cn } from \"@/lib/utils\"\nimport { buttonVariants } from \"@/components/ui/button\"\n\nexport type CalendarProps = React.ComponentProps<typeof DayPicker>\n\nfunction Calendar({\n  className,\n  classNames,\n  showOutsideDays = true,\n  ...props\n}: CalendarProps) {\n  return (\n    <DayPicker\n      showOutsideDays={showOutsideDays}\n      className={cn(\"p-3\", className)}\n      classNames={{\n        months: \"flex flex-col sm:flex-row space-y-4 sm:space-x-4 sm:space-y-0\",\n        month: \"space-y-4\",\n        caption: \"flex justify-center pt-1 relative items-center\",\n        caption_label: \"text-sm font-medium\",\n        nav: \"space-x-1 flex items-center\",\n        nav_button: cn(\n          buttonVariants({ variant: \"outline\" }),\n          \"h-7 w-7 bg-transparent p-0 opacity-50 hover:opacity-100\"\n        ),\n        nav_button_previous: \"absolute left-1\",\n        nav_button_next: \"absolute right-1\",\n        table: \"w-full border-collapse space-y-1\",\n        head_row: \"flex\",\n        head_cell:\n          \"text-muted-foreground rounded-md w-9 font-normal text-[0.8rem]\",\n        row: \"flex w-full mt-2\",\n        cell: \"h-9 w-9 text-center text-sm p-0 relative [&:has([aria-selected].day-range-end)]:rounded-r-md [&:has([aria-selected].day-outside)]:bg-accent/50 [&:has([aria-selected])]:bg-accent first:[&:has([aria-selected])]:rounded-l-md last:[&:has([aria-selected])]:rounded-r-md focus-within:relative focus-within:z-20\",\n        day: cn(\n          buttonVariants({ variant: \"ghost\" }),\n          \"h-9 w-9 p-0 font-normal aria-selected:opacity-100\"\n        ),\n        day_range_end: \"day-range-end\",\n        day_selected:\n          \"bg-primary text-primary-foreground hover:bg-primary hover:text-primary-foreground focus:bg-primary focus:text-primary-foreground\",\n        day_today: \"bg-accent text-accent-foreground\",\n        day_outside:\n          \"day-outside text-muted-foreground aria-selected:bg-accent/50 aria-selected:text-muted-foreground\",\n        day_disabled: \"text-muted-foreground opacity-50\",\n        day_range_middle:\n          \"aria-selected:bg-accent aria-selected:text-accent-foreground\",\n        day_hidden: \"invisible\",\n        ...classNames,\n      }}\n      components={{\n        IconLeft: ({ className, ...props }) => (\n          <ChevronLeft className={cn(\"h-4 w-4\", className)} {...props} />\n        ),\n        IconRight: ({ className, ...props }) => (\n          <ChevronRight className={cn(\"h-4 w-4\", className)} {...props} />\n        ),\n      }}\n      {...props}\n    />\n  )\n}\nCalendar.displayName = \"Calendar\"\n\nexport { Calendar }\n","path":null,"size_bytes":2695,"size_tokens":null},"client/src/components/LoginForm.tsx":{"content":"import { useState } from \"react\";\nimport { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { z } from \"zod\";\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport {\n  Form,\n  FormControl,\n  FormField,\n  FormItem,\n  FormLabel,\n  FormMessage,\n} from \"@/components/ui/form\";\nimport { Alert, AlertDescription } from \"@/components/ui/alert\";\nimport { Loader2, Lock, AlertCircle } from \"lucide-react\";\n\nconst loginSchema = z.object({\n  email: z.string().email(\"Please enter a valid email\"),\n  password: z.string().min(1, \"Password is required\"),\n});\n\ntype LoginFormValues = z.infer<typeof loginSchema>;\n\ninterface LoginFormProps {\n  onSubmit: (email: string, password: string) => Promise<boolean>;\n  isLoading?: boolean;\n}\n\nexport function LoginForm({ onSubmit, isLoading = false }: LoginFormProps) {\n  const [error, setError] = useState<string | null>(null);\n\n  const form = useForm<LoginFormValues>({\n    resolver: zodResolver(loginSchema),\n    defaultValues: {\n      email: \"\",\n      password: \"\",\n    },\n  });\n\n  const handleSubmit = async (values: LoginFormValues) => {\n    setError(null);\n    const success = await onSubmit(values.email, values.password);\n    if (!success) {\n      setError(\"Invalid email or password. Please try again.\");\n    }\n  };\n\n  return (\n    <Card className=\"w-full max-w-md\">\n      <CardHeader className=\"text-center\">\n        <div className=\"mx-auto mb-4 p-3 bg-primary/10 rounded-full w-fit\">\n          <Lock className=\"h-6 w-6 text-primary\" />\n        </div>\n        <CardTitle className=\"text-2xl\">B2B Wholesale Portal</CardTitle>\n        <CardDescription>\n          Sign in to access the catalog and place orders\n        </CardDescription>\n      </CardHeader>\n      <CardContent>\n        <Form {...form}>\n          <form onSubmit={form.handleSubmit(handleSubmit)} className=\"space-y-4\">\n            {error && (\n              <Alert variant=\"destructive\">\n                <AlertCircle className=\"h-4 w-4\" />\n                <AlertDescription>{error}</AlertDescription>\n              </Alert>\n            )}\n            <FormField\n              control={form.control}\n              name=\"email\"\n              render={({ field }) => (\n                <FormItem>\n                  <FormLabel>Email</FormLabel>\n                  <FormControl>\n                    <Input \n                      placeholder=\"you@company.com\" \n                      type=\"email\" \n                      {...field} \n                      data-testid=\"input-email\"\n                    />\n                  </FormControl>\n                  <FormMessage />\n                </FormItem>\n              )}\n            />\n            <FormField\n              control={form.control}\n              name=\"password\"\n              render={({ field }) => (\n                <FormItem>\n                  <FormLabel>Password</FormLabel>\n                  <FormControl>\n                    <Input \n                      type=\"password\" \n                      {...field} \n                      data-testid=\"input-password\"\n                    />\n                  </FormControl>\n                  <FormMessage />\n                </FormItem>\n              )}\n            />\n            <Button type=\"submit\" className=\"w-full\" disabled={isLoading} data-testid=\"button-login\">\n              {isLoading && <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />}\n              Sign In\n            </Button>\n          </form>\n        </Form>\n        <div className=\"mt-6 p-4 bg-muted rounded-lg\">\n          <p className=\"text-xs text-muted-foreground text-center\">\n            This is a private B2B portal. New accounts require admin approval.\n          </p>\n        </div>\n      </CardContent>\n    </Card>\n  );\n}\n","path":null,"size_bytes":3884,"size_tokens":null},"client/src/components/ui/command.tsx":{"content":"import * as React from \"react\"\nimport { type DialogProps } from \"@radix-ui/react-dialog\"\nimport { Command as CommandPrimitive } from \"cmdk\"\nimport { Search } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Dialog, DialogContent } from \"@/components/ui/dialog\"\n\nconst Command = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive\n    ref={ref}\n    className={cn(\n      \"flex h-full w-full flex-col overflow-hidden rounded-md bg-popover text-popover-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\nCommand.displayName = CommandPrimitive.displayName\n\nconst CommandDialog = ({ children, ...props }: DialogProps) => {\n  return (\n    <Dialog {...props}>\n      <DialogContent className=\"overflow-hidden p-0 shadow-lg\">\n        <Command className=\"[&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground [&_[cmdk-group]:not([hidden])_~[cmdk-group]]:pt-0 [&_[cmdk-group]]:px-2 [&_[cmdk-input-wrapper]_svg]:h-5 [&_[cmdk-input-wrapper]_svg]:w-5 [&_[cmdk-input]]:h-12 [&_[cmdk-item]]:px-2 [&_[cmdk-item]]:py-3 [&_[cmdk-item]_svg]:h-5 [&_[cmdk-item]_svg]:w-5\">\n          {children}\n        </Command>\n      </DialogContent>\n    </Dialog>\n  )\n}\n\nconst CommandInput = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Input>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Input>\n>(({ className, ...props }, ref) => (\n  <div className=\"flex items-center border-b px-3\" cmdk-input-wrapper=\"\">\n    <Search className=\"mr-2 h-4 w-4 shrink-0 opacity-50\" />\n    <CommandPrimitive.Input\n      ref={ref}\n      className={cn(\n        \"flex h-11 w-full rounded-md bg-transparent py-3 text-sm outline-none placeholder:text-muted-foreground disabled:cursor-not-allowed disabled:opacity-50\",\n        className\n      )}\n      {...props}\n    />\n  </div>\n))\n\nCommandInput.displayName = CommandPrimitive.Input.displayName\n\nconst CommandList = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.List>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.List>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.List\n    ref={ref}\n    className={cn(\"max-h-[300px] overflow-y-auto overflow-x-hidden\", className)}\n    {...props}\n  />\n))\n\nCommandList.displayName = CommandPrimitive.List.displayName\n\nconst CommandEmpty = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Empty>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Empty>\n>((props, ref) => (\n  <CommandPrimitive.Empty\n    ref={ref}\n    className=\"py-6 text-center text-sm\"\n    {...props}\n  />\n))\n\nCommandEmpty.displayName = CommandPrimitive.Empty.displayName\n\nconst CommandGroup = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Group>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Group>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.Group\n    ref={ref}\n    className={cn(\n      \"overflow-hidden p-1 text-foreground [&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:py-1.5 [&_[cmdk-group-heading]]:text-xs [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\n\nCommandGroup.displayName = CommandPrimitive.Group.displayName\n\nconst CommandSeparator = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 h-px bg-border\", className)}\n    {...props}\n  />\n))\nCommandSeparator.displayName = CommandPrimitive.Separator.displayName\n\nconst CommandItem = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Item>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default gap-2 select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none data-[disabled=true]:pointer-events-none data-[selected='true']:bg-accent data-[selected=true]:text-accent-foreground data-[disabled=true]:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\n      className\n    )}\n    {...props}\n  />\n))\n\nCommandItem.displayName = CommandPrimitive.Item.displayName\n\nconst CommandShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\n        \"ml-auto text-xs tracking-widest text-muted-foreground\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\nCommandShortcut.displayName = \"CommandShortcut\"\n\nexport {\n  Command,\n  CommandDialog,\n  CommandInput,\n  CommandList,\n  CommandEmpty,\n  CommandGroup,\n  CommandItem,\n  CommandShortcut,\n  CommandSeparator,\n}\n","path":null,"size_bytes":4885,"size_tokens":null},"postcss.config.js":{"content":"export default {\n  plugins: {\n    tailwindcss: {},\n    autoprefixer: {},\n  },\n}\n","path":null,"size_bytes":80,"size_tokens":null},"client/src/components/ui/collapsible.tsx":{"content":"\"use client\"\n\nimport * as CollapsiblePrimitive from \"@radix-ui/react-collapsible\"\n\nconst Collapsible = CollapsiblePrimitive.Root\n\nconst CollapsibleTrigger = CollapsiblePrimitive.CollapsibleTrigger\n\nconst CollapsibleContent = CollapsiblePrimitive.CollapsibleContent\n\nexport { Collapsible, CollapsibleTrigger, CollapsibleContent }\n","path":null,"size_bytes":329,"size_tokens":null},"server/storage.ts":{"content":"import { \n  type User, type InsertUser, type UpsertUser,\n  type Category, type InsertCategory,\n  type Supplier, type InsertSupplier,\n  type Product, type InsertProduct,\n  type Order, type InsertOrder,\n  type OrderItem, type InsertOrderItem,\n  type PriceTable, type InsertPriceTable,\n  type CustomerPrice, type InsertCustomerPrice,\n  type Coupon, type InsertCoupon,\n  type AgendaEvent, type InsertAgendaEvent,\n  type SiteSetting,\n  type CatalogBanner, type InsertCatalogBanner,\n  type CatalogSlide, type InsertCatalogSlide,\n  type CatalogConfig,\n  type CustomerCredit, type InsertCustomerCredit,\n  type CreditPayment, type InsertCreditPayment,\n  type AccountPayable, type InsertAccountPayable,\n  type PayablePayment, type InsertPayablePayment,\n  type Module, type InsertModule,\n  type UserModulePermission, type InsertUserModulePermission,\n  type PaymentType, type InsertPaymentType,\n  type PaymentIntegration, type InsertPaymentIntegration,\n  users, categories, suppliers, products, orders, orderItems, priceTables, customerPrices, coupons, agendaEvents, siteSettings, catalogBanners, catalogSlides, catalogConfig, customerCredits, creditPayments, accountsPayable, payablePayments, modules, userModulePermissions, paymentTypes, paymentIntegrations\n} from \"@shared/schema\";\nimport { db } from \"./db\";\nimport { eq, desc, ilike, and, or, sql, count } from \"drizzle-orm\";\n\nexport interface IStorage {\n  // Users\n  getUser(id: string): Promise<User | undefined>;\n  getUserByEmail(email: string): Promise<User | undefined>;\n  getUsers(): Promise<User[]>;\n  upsertUser(user: UpsertUser): Promise<User>;\n  updateUser(id: string, user: Partial<InsertUser>): Promise<User | undefined>;\n  deleteUser(id: string): Promise<boolean>;\n\n  // Categories\n  getCategories(): Promise<Category[]>;\n  getCategory(id: number): Promise<Category | undefined>;\n  getCategoryByBlingId(blingId: number): Promise<Category | undefined>;\n  createCategory(category: InsertCategory): Promise<Category>;\n  updateCategory(id: number, category: Partial<InsertCategory>): Promise<Category | undefined>;\n  deleteCategory(id: number): Promise<boolean>;\n\n  // Suppliers\n  getSuppliers(): Promise<Supplier[]>;\n  getSupplier(id: number): Promise<Supplier | undefined>;\n  createSupplier(supplier: InsertSupplier): Promise<Supplier>;\n  updateSupplier(id: number, supplier: Partial<InsertSupplier>): Promise<Supplier | undefined>;\n  deleteSupplier(id: number): Promise<boolean>;\n\n  // Products\n  getProducts(filters?: { categoryId?: number; search?: string; page?: number; limit?: number; sort?: string }): Promise<{ products: Product[]; total: number; page: number; totalPages: number }>;\n  getProduct(id: number): Promise<Product | undefined>;\n  getProductBySku(sku: string): Promise<Product | undefined>;\n  createProduct(product: InsertProduct): Promise<Product>;\n  updateProduct(id: number, product: Partial<InsertProduct>): Promise<Product | undefined>;\n  deleteProduct(id: number): Promise<boolean>;\n\n  // Orders\n  getOrders(userId?: string): Promise<Order[]>;\n  getOrder(id: number): Promise<Order | undefined>;\n  getOrderWithDetails(id: number): Promise<{\n    order: Order;\n    items: Array<OrderItem & { product: { id: number; name: string; sku: string; image: string | null; price: string } }>;\n    customer: { \n      id: string; \n      firstName: string | null; \n      lastName: string | null; \n      company: string | null; \n      tradingName: string | null;\n      stateRegistration: string | null;\n      email: string | null; \n      phone: string | null; \n      personType: string | null;\n      cnpj: string | null;\n      cpf: string | null;\n      cep: string | null;\n      address: string | null;\n      addressNumber: string | null;\n      complement: string | null;\n      neighborhood: string | null;\n      city: string | null; \n      state: string | null;\n    };\n  } | undefined>;\n  getNextOrderNumber(): Promise<number>;\n  createOrder(order: InsertOrder): Promise<Order>;\n  updateOrder(id: number, order: Partial<InsertOrder>): Promise<Order | undefined>;\n\n  // Order Items\n  getOrderItems(orderId: number): Promise<OrderItem[]>;\n  createOrderItem(item: InsertOrderItem): Promise<OrderItem>;\n\n  // Price Tables\n  getPriceTables(): Promise<PriceTable[]>;\n  getPriceTable(id: number): Promise<PriceTable | undefined>;\n  createPriceTable(table: InsertPriceTable): Promise<PriceTable>;\n  updatePriceTable(id: number, table: Partial<InsertPriceTable>): Promise<PriceTable | undefined>;\n  deletePriceTable(id: number): Promise<boolean>;\n\n  // Customer Prices\n  getCustomerPrices(userId: string): Promise<CustomerPrice[]>;\n  setCustomerPrice(price: InsertCustomerPrice): Promise<CustomerPrice>;\n  deleteCustomerPrice(id: number): Promise<boolean>;\n\n  // Coupons\n  getCoupons(): Promise<Coupon[]>;\n  getCoupon(id: number): Promise<Coupon | undefined>;\n  getCouponByCode(code: string): Promise<Coupon | undefined>;\n  createCoupon(coupon: InsertCoupon): Promise<Coupon>;\n  updateCoupon(id: number, coupon: Partial<InsertCoupon>): Promise<Coupon | undefined>;\n  deleteCoupon(id: number): Promise<boolean>;\n  incrementCouponUsage(id: number): Promise<void>;\n\n  // Customer Analytics\n  getCustomerAnalytics(): Promise<CustomerAnalyticsData>;\n\n  // Product Analytics\n  getProductAnalytics(): Promise<ProductAnalyticsData>;\n\n  // Purchases Analytics (for purchasing/restocking decisions)\n  getPurchasesAnalytics(): Promise<PurchasesAnalyticsData>;\n\n  // Brand Analytics (for supplier dashboard)\n  getBrandAnalytics(allowedBrands?: string[]): Promise<BrandAnalyticsData>;\n\n  // Employee Analytics\n  getEmployeeAnalytics(): Promise<EmployeeAnalyticsData>;\n\n  // Stock Management\n  reserveStockForOrder(orderId: number, userId: string): Promise<{ success: boolean; error?: string }>;\n  releaseStockForOrder(orderId: number): Promise<{ success: boolean; error?: string }>;\n  deductStockForOrder(orderId: number, userId: string): Promise<{ success: boolean; error?: string }>;\n  \n  // Stage Management\n  updateOrderStage(orderId: number, stage: string): Promise<{ success: boolean; error?: string }>;\n\n  // Agenda Events\n  getAgendaEvents(filters?: { startDate?: Date; endDate?: Date }): Promise<AgendaEvent[]>;\n  getAgendaEvent(id: number): Promise<AgendaEvent | undefined>;\n  createAgendaEvent(event: InsertAgendaEvent): Promise<AgendaEvent>;\n  updateAgendaEvent(id: number, event: Partial<InsertAgendaEvent>): Promise<AgendaEvent | undefined>;\n  deleteAgendaEvent(id: number): Promise<boolean>;\n\n  // Site Settings\n  getSiteSetting(key: string): Promise<SiteSetting | undefined>;\n  setSiteSetting(key: string, value: string): Promise<SiteSetting>;\n\n  // Catalog Banners\n  getCatalogBanners(position?: string): Promise<CatalogBanner[]>;\n  getCatalogBanner(id: number): Promise<CatalogBanner | undefined>;\n  createCatalogBanner(banner: InsertCatalogBanner): Promise<CatalogBanner>;\n  updateCatalogBanner(id: number, banner: Partial<InsertCatalogBanner>): Promise<CatalogBanner | undefined>;\n  deleteCatalogBanner(id: number): Promise<boolean>;\n\n  // Catalog Slides\n  getCatalogSlides(): Promise<CatalogSlide[]>;\n  getCatalogSlide(id: number): Promise<CatalogSlide | undefined>;\n  createCatalogSlide(slide: InsertCatalogSlide): Promise<CatalogSlide>;\n  updateCatalogSlide(id: number, slide: Partial<InsertCatalogSlide>): Promise<CatalogSlide | undefined>;\n  deleteCatalogSlide(id: number): Promise<boolean>;\n\n  // Catalog Config\n  getCatalogConfig(key: string): Promise<CatalogConfig | undefined>;\n  setCatalogConfig(key: string, value: string): Promise<CatalogConfig>;\n\n  // Customer Credits (Fiado)\n  getCustomerCredits(userId: string): Promise<CustomerCredit[]>;\n  getAllCredits(): Promise<CustomerCredit[]>;\n  getCustomerCredit(id: number): Promise<CustomerCredit | undefined>;\n  createCustomerCredit(credit: InsertCustomerCredit): Promise<CustomerCredit>;\n  updateCustomerCredit(id: number, credit: Partial<InsertCustomerCredit>): Promise<CustomerCredit | undefined>;\n  deleteCustomerCredit(id: number): Promise<boolean>;\n  getCustomerCreditBalance(userId: string): Promise<{ total: number; pending: number; paid: number }>;\n  getCreditsDashboard(): Promise<CreditsDashboardData>;\n\n  // Credit Payments\n  getCreditPayments(creditId: number): Promise<CreditPayment[]>;\n  createCreditPayment(payment: InsertCreditPayment): Promise<CreditPayment>;\n\n  // Modules (Permission System)\n  getModules(): Promise<Module[]>;\n  getModule(key: string): Promise<Module | undefined>;\n  createModule(module: InsertModule): Promise<Module>;\n  \n  // User Module Permissions\n  getUserPermissions(userId: string): Promise<UserModulePermission[]>;\n  getUserPermissionKeys(userId: string): Promise<string[]>;\n  setUserPermissions(userId: string, moduleKeys: string[]): Promise<void>;\n  hasModuleAccess(userId: string, moduleKey: string): Promise<boolean>;\n\n  // Payment Types\n  getPaymentTypes(): Promise<PaymentType[]>;\n  getPaymentType(id: number): Promise<PaymentType | undefined>;\n  createPaymentType(paymentType: InsertPaymentType): Promise<PaymentType>;\n  updatePaymentType(id: number, paymentType: Partial<InsertPaymentType>): Promise<PaymentType | undefined>;\n  deletePaymentType(id: number): Promise<boolean>;\n\n  // Payment Integrations\n  getPaymentIntegrations(): Promise<PaymentIntegration[]>;\n  getPaymentIntegration(id: number): Promise<PaymentIntegration | undefined>;\n  createPaymentIntegration(integration: InsertPaymentIntegration): Promise<PaymentIntegration>;\n  updatePaymentIntegration(id: number, integration: Partial<InsertPaymentIntegration>): Promise<PaymentIntegration | undefined>;\n  deletePaymentIntegration(id: number): Promise<boolean>;\n}\n\n// Customer Analytics Types\nexport interface CustomerRanking {\n  userId: string;\n  name: string;\n  company: string | null;\n  email: string | null;\n  totalRevenue: number;\n  orderCount: number;\n  avgTicket: number;\n  lastOrderDate: Date | null;\n  daysSinceLastOrder: number;\n  firstOrderDate: Date | null;\n}\n\nexport interface RFMSegment {\n  userId: string;\n  name: string;\n  company: string | null;\n  recency: number;\n  frequency: number;\n  monetary: number;\n  rfmScore: string;\n  segment: string;\n}\n\nexport interface InactiveCustomer {\n  userId: string;\n  name: string;\n  company: string | null;\n  email: string | null;\n  lastOrderDate: Date;\n  daysSinceLastOrder: number;\n  avgDaysBetweenOrders: number;\n  churnRisk: 'low' | 'medium' | 'high';\n  totalSpent: number;\n  orderCount: number;\n}\n\nexport interface ConversionMetric {\n  userId: string;\n  name: string;\n  company: string | null;\n  email: string | null;\n  totalQuotes: number;\n  convertedOrders: number;\n  conversionRate: number;\n  totalRevenue: number;\n}\n\nexport interface CustomerAnalyticsData {\n  topCustomersByRevenue: {\n    month: CustomerRanking[];\n    quarter: CustomerRanking[];\n    year: CustomerRanking[];\n  };\n  topCustomersByFrequency: CustomerRanking[];\n  abcAnalysis: {\n    a: CustomerRanking[];\n    b: CustomerRanking[];\n    c: CustomerRanking[];\n  };\n  inactiveCustomers: {\n    days7: InactiveCustomer[];\n    days15: InactiveCustomer[];\n    days30: InactiveCustomer[];\n    days60: InactiveCustomer[];\n    days90: InactiveCustomer[];\n  };\n  reactivatedThisMonth: CustomerRanking[];\n  newCustomersThisMonth: CustomerRanking[];\n  rfmSegments: RFMSegment[];\n  avgDaysBetweenOrders: number;\n  cohortRetention: {\n    days30: number;\n    days60: number;\n    days90: number;\n  };\n  conversionMetrics: ConversionMetric[];\n}\n\n// Product Analytics Types\nexport interface ProductRanking {\n  productId: number;\n  name: string;\n  sku: string;\n  brand: string | null;\n  categoryId: number | null;\n  categoryName: string | null;\n  totalRevenue: number;\n  totalQuantity: number;\n  orderCount: number;\n  avgPrice: number;\n  revenueShare: number;\n  growthPercent: number;\n}\n\nexport interface ProductABC {\n  productId: number;\n  name: string;\n  sku: string;\n  categoryName: string | null;\n  totalRevenue: number;\n  revenueShare: number;\n  cumulativeShare: number;\n  abcClass: 'A' | 'B' | 'C';\n}\n\nexport interface ProductVelocity {\n  productId: number;\n  name: string;\n  sku: string;\n  avgSalesPerDay: number;\n  totalQuantity: number;\n  daysSinceLastSale: number;\n  status: 'fast' | 'normal' | 'slow' | 'stopped';\n}\n\nexport interface ProductRepurchase {\n  productId: number;\n  name: string;\n  sku: string;\n  uniqueCustomers: number;\n  repeatCustomers: number;\n  repurchaseRate: number;\n  avgDaysBetweenPurchases: number;\n  singlePurchaseCustomers: number;\n}\n\nexport interface ProductCrossSell {\n  productId: number;\n  name: string;\n  pairedProducts: Array<{\n    productId: number;\n    name: string;\n    coOccurrence: number;\n  }>;\n  isLeader: boolean;\n}\n\nexport interface CategoryPerformance {\n  categoryId: number;\n  categoryName: string;\n  totalRevenue: number;\n  totalQuantity: number;\n  productCount: number;\n  topProducts: Array<{\n    productId: number;\n    name: string;\n    revenue: number;\n  }>;\n}\n\nexport interface ProblematicProduct {\n  productId: number;\n  name: string;\n  sku: string;\n  issue: 'low_turnover' | 'declining' | 'no_sales';\n  metric: number;\n  description: string;\n}\n\nexport interface ProductAnalyticsData {\n  overview: {\n    totalRevenue: number;\n    totalQuantitySold: number;\n    avgTicketPerProduct: number;\n    uniqueProductsSold: number;\n  };\n  rankingByRevenue: {\n    days7: ProductRanking[];\n    days30: ProductRanking[];\n    days60: ProductRanking[];\n    days90: ProductRanking[];\n  };\n  rankingByVolume: {\n    days7: ProductRanking[];\n    days30: ProductRanking[];\n    days60: ProductRanking[];\n    days90: ProductRanking[];\n  };\n  topGrowing: ProductRanking[];\n  topDeclining: ProductRanking[];\n  abcAnalysis: {\n    a: ProductABC[];\n    b: ProductABC[];\n    c: ProductABC[];\n  };\n  velocity: ProductVelocity[];\n  repurchase: ProductRepurchase[];\n  crossSell: ProductCrossSell[];\n  categoryPerformance: CategoryPerformance[];\n  problematicProducts: ProblematicProduct[];\n}\n\n// Purchases Analytics Types (for purchasing/restocking decisions)\nexport interface LowStockProduct {\n  productId: number;\n  name: string;\n  sku: string;\n  categoryName: string | null;\n  currentStock: number;\n  reservedStock: number;\n  availableStock: number;\n  avgDailySales: number;\n  daysOfStock: number;\n  suggestedPurchaseQty: number;\n  urgency: 'critical' | 'high' | 'medium' | 'low';\n}\n\nexport interface SlowMovingProduct {\n  productId: number;\n  name: string;\n  sku: string;\n  categoryName: string | null;\n  currentStock: number;\n  stockValue: number;\n  daysSinceLastSale: number;\n  totalSalesLast90Days: number;\n  avgDailySales: number;\n  recommendation: string;\n}\n\nexport interface FastMovingProduct {\n  productId: number;\n  name: string;\n  sku: string;\n  categoryName: string | null;\n  currentStock: number;\n  avgDailySales: number;\n  daysOfStock: number;\n  salesLast30Days: number;\n  growthPercent: number;\n  suggestedPurchaseQty: number;\n}\n\nexport interface PurchaseSuggestion {\n  productId: number;\n  name: string;\n  sku: string;\n  categoryName: string | null;\n  currentStock: number;\n  suggestedQty: number;\n  estimatedCost: number;\n  reason: string;\n  priority: 'urgent' | 'high' | 'normal';\n}\n\nexport interface PurchasesAnalyticsData {\n  overview: {\n    totalLowStockProducts: number;\n    totalSlowMovingProducts: number;\n    totalFastMovingProducts: number;\n    estimatedPurchaseValue: number;\n    criticalItems: number;\n  };\n  lowStock: LowStockProduct[];\n  slowMoving: SlowMovingProduct[];\n  fastMoving: FastMovingProduct[];\n  suggestions: PurchaseSuggestion[];\n}\n\n// Brand Analytics Types (for supplier dashboard)\nexport interface BrandSummary {\n  brand: string;\n  totalProducts: number;\n  totalStock: number;\n  lowStockCount: number;\n  outOfStockCount: number;\n  totalSales30d: number;\n  totalRevenue30d: number;\n  avgTurnover: number;\n}\n\nexport interface BrandProductDetail {\n  productId: number;\n  name: string;\n  sku: string;\n  brand: string;\n  stock: number;\n  sales30d: number;\n  sales60d: number;\n  sales90d: number;\n  revenue30d: number;\n  lastSaleDate: Date | null;\n  turnoverDays: number | null;\n  status: 'critical' | 'low' | 'ok' | 'overstock';\n  suggestedPurchase: number;\n}\n\nexport interface BrandAnalyticsData {\n  brands: BrandSummary[];\n  productsByBrand: Record<string, BrandProductDetail[]>;\n  overview: {\n    totalBrands: number;\n    totalProducts: number;\n    totalLowStock: number;\n    totalOutOfStock: number;\n    topSellingBrand: string | null;\n    topSellingBrandRevenue: number;\n  };\n}\n\n// Employee Analytics Types\nexport interface EmployeeMetrics {\n  userId: string;\n  name: string;\n  email: string | null;\n  role: string;\n  totalOrders: number;\n  totalRevenue: number;\n  avgTicket: number;\n  ordersThisMonth: number;\n  revenueThisMonth: number;\n  ordersThisQuarter: number;\n  revenueThisQuarter: number;\n  lastActivity: Date | null;\n}\n\nexport interface EmployeeAnalyticsData {\n  employees: EmployeeMetrics[];\n  overview: {\n    totalEmployees: number;\n    totalOrdersThisMonth: number;\n    totalRevenueThisMonth: number;\n    avgOrdersPerEmployee: number;\n    topPerformer: string | null;\n  };\n  periodComparison: {\n    thisMonth: { orders: number; revenue: number };\n    lastMonth: { orders: number; revenue: number };\n    thisQuarter: { orders: number; revenue: number };\n    lastQuarter: { orders: number; revenue: number };\n  };\n}\n\n// Credits Dashboard Types\nexport interface CustomerCreditSummary {\n  userId: string;\n  userName: string;\n  company: string | null;\n  totalDebt: number;\n  paidAmount: number;\n  pendingAmount: number;\n  overdueAmount: number;\n  nextDueDate: Date | null;\n  creditCount: number;\n}\n\nexport interface UpcomingPayment {\n  creditId: number;\n  userId: string;\n  userName: string;\n  company: string | null;\n  amount: number;\n  pendingAmount: number;\n  dueDate: Date;\n  daysUntilDue: number;\n  status: string;\n}\n\nexport interface CreditsDashboardData {\n  overview: {\n    totalInCirculation: number;\n    totalPending: number;\n    totalPaid: number;\n    totalOverdue: number;\n    customersWithDebt: number;\n    averageDebtPerCustomer: number;\n  };\n  customerSummaries: CustomerCreditSummary[];\n  upcomingPayments: UpcomingPayment[];\n  overduePayments: UpcomingPayment[];\n  recentPayments: Array<{\n    paymentId: number;\n    creditId: number;\n    userId: string;\n    userName: string;\n    amount: number;\n    paymentMethod: string | null;\n    createdAt: Date;\n  }>;\n}\n\nexport class DatabaseStorage implements IStorage {\n  // Users\n  async getUser(id: string): Promise<User | undefined> {\n    const [user] = await db.select().from(users).where(eq(users.id, id));\n    return user;\n  }\n\n  async getUserByEmail(email: string): Promise<User | undefined> {\n    const [user] = await db.select().from(users).where(eq(users.email, email));\n    return user;\n  }\n\n  async getUsers(): Promise<User[]> {\n    return db.select().from(users).orderBy(desc(users.createdAt));\n  }\n\n  async upsertUser(userData: UpsertUser): Promise<User> {\n    const [user] = await db\n      .insert(users)\n      .values(userData)\n      .onConflictDoUpdate({\n        target: users.id,\n        set: {\n          ...userData,\n          updatedAt: new Date(),\n        },\n      })\n      .returning();\n    return user;\n  }\n\n  async updateUser(id: string, userData: Partial<InsertUser>): Promise<User | undefined> {\n    const [user] = await db.update(users).set({ ...userData, updatedAt: new Date() }).where(eq(users.id, id)).returning();\n    return user;\n  }\n\n  async deleteUser(id: string): Promise<boolean> {\n    await db.delete(users).where(eq(users.id, id));\n    return true;\n  }\n\n  // Categories\n  async getCategories(): Promise<Category[]> {\n    return db.select().from(categories);\n  }\n\n  async getCategory(id: number): Promise<Category | undefined> {\n    const [category] = await db.select().from(categories).where(eq(categories.id, id));\n    return category;\n  }\n\n  async getCategoryByBlingId(blingId: number): Promise<Category | undefined> {\n    const [category] = await db.select().from(categories).where(eq(categories.blingId, blingId));\n    return category;\n  }\n\n  async createCategory(insertCategory: InsertCategory): Promise<Category> {\n    const [category] = await db.insert(categories).values(insertCategory).returning();\n    return category;\n  }\n\n  async updateCategory(id: number, categoryData: Partial<InsertCategory>): Promise<Category | undefined> {\n    const [category] = await db.update(categories).set(categoryData).where(eq(categories.id, id)).returning();\n    return category;\n  }\n\n  async deleteCategory(id: number): Promise<boolean> {\n    await db.delete(categories).where(eq(categories.id, id));\n    return true;\n  }\n\n  // Suppliers\n  async getSuppliers(): Promise<Supplier[]> {\n    return db.select().from(suppliers).orderBy(suppliers.name);\n  }\n\n  async getSupplier(id: number): Promise<Supplier | undefined> {\n    const [supplier] = await db.select().from(suppliers).where(eq(suppliers.id, id));\n    return supplier;\n  }\n\n  async createSupplier(insertSupplier: InsertSupplier): Promise<Supplier> {\n    const [supplier] = await db.insert(suppliers).values(insertSupplier).returning();\n    return supplier;\n  }\n\n  async updateSupplier(id: number, supplierData: Partial<InsertSupplier>): Promise<Supplier | undefined> {\n    const [supplier] = await db.update(suppliers).set(supplierData).where(eq(suppliers.id, id)).returning();\n    return supplier;\n  }\n\n  async deleteSupplier(id: number): Promise<boolean> {\n    await db.delete(suppliers).where(eq(suppliers.id, id));\n    return true;\n  }\n\n  // Products\n  async getProducts(filters?: { categoryId?: number; search?: string; page?: number; limit?: number; sort?: string }): Promise<{ products: Product[]; total: number; page: number; totalPages: number }> {\n    const page = filters?.page || 1;\n    const limit = filters?.limit || 50;\n    const offset = (page - 1) * limit;\n    \n    const conditions = [];\n    if (filters?.categoryId) {\n      conditions.push(eq(products.categoryId, filters.categoryId));\n    }\n    if (filters?.search) {\n      conditions.push(\n        or(\n          ilike(products.name, `%${filters.search}%`),\n          ilike(products.sku, `%${filters.search}%`),\n          ilike(products.brand, `%${filters.search}%`)\n        )\n      );\n    }\n\n    const orderByClause = filters?.sort === 'newest' ? desc(products.createdAt) : products.name;\n\n    let productList: Product[];\n    let totalResult: { count: number }[];\n    \n    if (conditions.length > 0) {\n      const whereClause = and(...conditions);\n      productList = await db.select().from(products).where(whereClause).orderBy(orderByClause).limit(limit).offset(offset);\n      totalResult = await db.select({ count: count() }).from(products).where(whereClause);\n    } else {\n      productList = await db.select().from(products).orderBy(orderByClause).limit(limit).offset(offset);\n      totalResult = await db.select({ count: count() }).from(products);\n    }\n    \n    const total = totalResult[0]?.count || 0;\n    const totalPages = Math.ceil(total / limit);\n    \n    return { products: productList, total, page, totalPages };\n  }\n\n  async getProduct(id: number): Promise<Product | undefined> {\n    const [product] = await db.select().from(products).where(eq(products.id, id));\n    return product;\n  }\n\n  async getProductBySku(sku: string): Promise<Product | undefined> {\n    const [product] = await db.select().from(products).where(eq(products.sku, sku));\n    return product;\n  }\n\n  async createProduct(insertProduct: InsertProduct): Promise<Product> {\n    const [product] = await db.insert(products).values(insertProduct).returning();\n    return product;\n  }\n\n  async updateProduct(id: number, productData: Partial<InsertProduct>): Promise<Product | undefined> {\n    const [product] = await db.update(products).set(productData).where(eq(products.id, id)).returning();\n    return product;\n  }\n\n  async deleteProduct(id: number): Promise<boolean> {\n    await db.delete(products).where(eq(products.id, id));\n    return true;\n  }\n\n  // Orders\n  async getOrders(userId?: string): Promise<Order[]> {\n    if (userId) {\n      return db.select().from(orders).where(eq(orders.userId, userId)).orderBy(desc(orders.createdAt));\n    }\n    return db.select().from(orders).orderBy(desc(orders.createdAt));\n  }\n\n  async getOrder(id: number): Promise<Order | undefined> {\n    const [order] = await db.select().from(orders).where(eq(orders.id, id));\n    return order;\n  }\n\n  async getNextOrderNumber(): Promise<number> {\n    // Get the maximum order number from existing orders\n    const maxResult = await db.execute(sql`SELECT MAX(CAST(order_number AS INTEGER)) as max_num FROM orders WHERE order_number ~ '^[0-9]+$'`);\n    const maxNum = Number((maxResult.rows[0] as any)?.max_num) || 7999;\n    \n    // Create sequence if not exists\n    await db.execute(sql`CREATE SEQUENCE IF NOT EXISTS order_number_seq START WITH 8000`);\n    \n    // Get current sequence value\n    const seqResult = await db.execute(sql`SELECT last_value FROM order_number_seq`);\n    const seqVal = Number((seqResult.rows[0] as any).last_value);\n    \n    // If max order number is >= sequence value, reset sequence to max+1\n    if (maxNum >= seqVal) {\n      await db.execute(sql`SELECT setval('order_number_seq', ${maxNum + 1}, false)`);\n    }\n    \n    const result = await db.execute(sql`SELECT nextval('order_number_seq') as num`);\n    return Number((result.rows[0] as any).num);\n  }\n\n  async getOrderWithDetails(id: number): Promise<{\n    order: Order;\n    items: Array<OrderItem & { product: { id: number; name: string; sku: string; image: string | null; price: string } }>;\n    customer: { \n      id: string; \n      firstName: string | null; \n      lastName: string | null; \n      company: string | null; \n      tradingName: string | null;\n      stateRegistration: string | null;\n      email: string | null; \n      phone: string | null; \n      personType: string | null;\n      cnpj: string | null;\n      cpf: string | null;\n      cep: string | null;\n      address: string | null;\n      addressNumber: string | null;\n      complement: string | null;\n      neighborhood: string | null;\n      city: string | null; \n      state: string | null;\n    };\n    printedByUser: { id: string; firstName: string | null; lastName: string | null; email: string | null } | null;\n  } | undefined> {\n    const [order] = await db.select().from(orders).where(eq(orders.id, id));\n    if (!order) return undefined;\n\n    const [customer] = await db.select({\n      id: users.id,\n      firstName: users.firstName,\n      lastName: users.lastName,\n      company: users.company,\n      tradingName: users.tradingName,\n      stateRegistration: users.stateRegistration,\n      email: users.email,\n      phone: users.phone,\n      personType: users.personType,\n      cnpj: users.cnpj,\n      cpf: users.cpf,\n      cep: users.cep,\n      address: users.address,\n      addressNumber: users.addressNumber,\n      complement: users.complement,\n      neighborhood: users.neighborhood,\n      city: users.city,\n      state: users.state,\n    }).from(users).where(eq(users.id, order.userId));\n\n    let printedByUser = null;\n    if (order.printedBy) {\n      const [pUser] = await db.select({\n        id: users.id,\n        firstName: users.firstName,\n        lastName: users.lastName,\n        email: users.email,\n      }).from(users).where(eq(users.id, order.printedBy));\n      printedByUser = pUser || null;\n    }\n\n    const itemsWithProducts = await db.select({\n      id: orderItems.id,\n      orderId: orderItems.orderId,\n      productId: orderItems.productId,\n      quantity: orderItems.quantity,\n      price: orderItems.price,\n      product: {\n        id: products.id,\n        name: products.name,\n        sku: products.sku,\n        image: products.image,\n        price: products.price,\n      },\n    }).from(orderItems)\n      .leftJoin(products, eq(orderItems.productId, products.id))\n      .where(eq(orderItems.orderId, id));\n\n    const items = itemsWithProducts.map(item => ({\n      id: item.id,\n      orderId: item.orderId,\n      productId: item.productId,\n      quantity: item.quantity,\n      price: item.price,\n      product: item.product || { id: item.productId, name: 'Produto não encontrado', sku: '', image: null, price: item.price },\n    }));\n\n    return {\n      order,\n      items,\n      customer: customer || { \n        id: order.userId, \n        firstName: null, \n        lastName: null, \n        company: null, \n        email: null, \n        phone: null, \n        personType: null,\n        cnpj: null,\n        cpf: null,\n        cep: null,\n        address: null,\n        addressNumber: null,\n        complement: null,\n        neighborhood: null,\n        city: null, \n        state: null \n      },\n      printedByUser,\n    };\n  }\n\n  async createOrder(insertOrder: InsertOrder): Promise<Order> {\n    const [order] = await db.insert(orders).values(insertOrder).returning();\n    return order;\n  }\n\n  async updateOrder(id: number, orderData: Partial<InsertOrder>): Promise<Order | undefined> {\n    const [order] = await db.update(orders).set(orderData).where(eq(orders.id, id)).returning();\n    return order;\n  }\n\n  // Order Items\n  async getOrderItems(orderId: number): Promise<OrderItem[]> {\n    return db.select().from(orderItems).where(eq(orderItems.orderId, orderId));\n  }\n\n  async createOrderItem(insertItem: InsertOrderItem): Promise<OrderItem> {\n    const [item] = await db.insert(orderItems).values(insertItem).returning();\n    return item;\n  }\n\n  // Price Tables\n  async getPriceTables(): Promise<PriceTable[]> {\n    return db.select().from(priceTables).orderBy(priceTables.name);\n  }\n\n  async getPriceTable(id: number): Promise<PriceTable | undefined> {\n    const [table] = await db.select().from(priceTables).where(eq(priceTables.id, id));\n    return table;\n  }\n\n  async createPriceTable(table: InsertPriceTable): Promise<PriceTable> {\n    const [created] = await db.insert(priceTables).values(table).returning();\n    return created;\n  }\n\n  async updatePriceTable(id: number, tableData: Partial<InsertPriceTable>): Promise<PriceTable | undefined> {\n    const [updated] = await db.update(priceTables).set(tableData).where(eq(priceTables.id, id)).returning();\n    return updated;\n  }\n\n  async deletePriceTable(id: number): Promise<boolean> {\n    await db.delete(priceTables).where(eq(priceTables.id, id));\n    return true;\n  }\n\n  // Customer Prices\n  async getCustomerPrices(userId: string): Promise<CustomerPrice[]> {\n    return db.select().from(customerPrices).where(eq(customerPrices.userId, userId));\n  }\n\n  async setCustomerPrice(priceData: InsertCustomerPrice): Promise<CustomerPrice> {\n    const existing = await db.select().from(customerPrices)\n      .where(and(eq(customerPrices.userId, priceData.userId), eq(customerPrices.productId, priceData.productId)));\n    \n    if (existing.length > 0) {\n      const [updated] = await db.update(customerPrices)\n        .set({ customPrice: priceData.customPrice })\n        .where(eq(customerPrices.id, existing[0].id))\n        .returning();\n      return updated;\n    }\n    \n    const [created] = await db.insert(customerPrices).values(priceData).returning();\n    return created;\n  }\n\n  async deleteCustomerPrice(id: number): Promise<boolean> {\n    await db.delete(customerPrices).where(eq(customerPrices.id, id));\n    return true;\n  }\n\n  // Coupons\n  async getCoupons(): Promise<Coupon[]> {\n    return db.select().from(coupons).orderBy(desc(coupons.createdAt));\n  }\n\n  async getCoupon(id: number): Promise<Coupon | undefined> {\n    const [coupon] = await db.select().from(coupons).where(eq(coupons.id, id));\n    return coupon;\n  }\n\n  async getCouponByCode(code: string): Promise<Coupon | undefined> {\n    const [coupon] = await db.select().from(coupons).where(eq(coupons.code, code.toUpperCase()));\n    return coupon;\n  }\n\n  async createCoupon(couponData: InsertCoupon): Promise<Coupon> {\n    const [created] = await db.insert(coupons).values({ ...couponData, code: couponData.code.toUpperCase() }).returning();\n    return created;\n  }\n\n  async updateCoupon(id: number, couponData: Partial<InsertCoupon>): Promise<Coupon | undefined> {\n    const updateData = couponData.code ? { ...couponData, code: couponData.code.toUpperCase() } : couponData;\n    const [updated] = await db.update(coupons).set(updateData).where(eq(coupons.id, id)).returning();\n    return updated;\n  }\n\n  async deleteCoupon(id: number): Promise<boolean> {\n    await db.delete(coupons).where(eq(coupons.id, id));\n    return true;\n  }\n\n  async incrementCouponUsage(id: number): Promise<void> {\n    await db.update(coupons).set({ usedCount: sql`${coupons.usedCount} + 1` }).where(eq(coupons.id, id));\n  }\n\n  async getCustomerPurchaseStats(userId: string): Promise<{\n    totalSpent: number;\n    totalOrders: number;\n    completedOrders: number;\n    monthlyStats: Array<{ month: string; total: number; count: number }>;\n    topProducts: Array<{ productId: number; name: string; totalQuantity: number; totalValue: number }>;\n    lastMonthProducts: Array<{ productId: number; name: string; quantity: number; totalValue: number }>;\n  }> {\n    const userOrders = await db.select().from(orders).where(eq(orders.userId, userId));\n    \n    const totalSpent = userOrders.reduce((sum, o) => sum + parseFloat(o.total), 0);\n    const totalOrders = userOrders.length;\n    const completedStatuses = ['FATURADO', 'completed'];\n    const completedOrders = userOrders.filter(o => completedStatuses.includes(o.status)).length;\n\n    const monthlyMap = new Map<string, { total: number; count: number }>();\n    for (const o of userOrders) {\n      const date = new Date(o.createdAt);\n      const key = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;\n      const curr = monthlyMap.get(key) || { total: 0, count: 0 };\n      curr.total += parseFloat(o.total);\n      curr.count += 1;\n      monthlyMap.set(key, curr);\n    }\n    const monthlyStats = Array.from(monthlyMap.entries())\n      .map(([month, data]) => ({ month, ...data }))\n      .sort((a, b) => b.month.localeCompare(a.month))\n      .slice(0, 6);\n\n    const orderIds = userOrders.map(o => o.id);\n    let topProducts: Array<{ productId: number; name: string; totalQuantity: number; totalValue: number }> = [];\n    let lastMonthProducts: Array<{ productId: number; name: string; quantity: number; totalValue: number }> = [];\n    \n    if (orderIds.length > 0) {\n      const items = await db.select({\n        productId: orderItems.productId,\n        quantity: orderItems.quantity,\n        price: orderItems.price,\n        name: products.name,\n        orderId: orderItems.orderId,\n      }).from(orderItems)\n        .leftJoin(products, eq(orderItems.productId, products.id))\n        .where(sql`${orderItems.orderId} = ANY(${orderIds})`);\n\n      const productMap = new Map<number, { name: string; totalQuantity: number; totalValue: number }>();\n      for (const item of items) {\n        const curr = productMap.get(item.productId) || { name: item.name || 'Produto', totalQuantity: 0, totalValue: 0 };\n        curr.totalQuantity += item.quantity;\n        curr.totalValue += item.quantity * parseFloat(item.price);\n        productMap.set(item.productId, curr);\n      }\n      topProducts = Array.from(productMap.entries())\n        .map(([productId, data]) => ({ productId, ...data }))\n        .sort((a, b) => b.totalQuantity - a.totalQuantity)\n        .slice(0, 5);\n\n      // Get last month's orders for prediction\n      const now = new Date();\n      const lastMonthStart = new Date(now.getFullYear(), now.getMonth() - 1, 1);\n      const currentMonthStart = new Date(now.getFullYear(), now.getMonth(), 1);\n      \n      const lastMonthOrders = userOrders.filter(o => {\n        const orderDate = new Date(o.createdAt);\n        return orderDate >= lastMonthStart && orderDate < currentMonthStart;\n      });\n      \n      if (lastMonthOrders.length > 0) {\n        const lastMonthOrderIds = lastMonthOrders.map(o => o.id);\n        const lastMonthItems = items.filter(item => lastMonthOrderIds.includes(item.orderId));\n        \n        const lastMonthMap = new Map<number, { name: string; quantity: number; totalValue: number }>();\n        for (const item of lastMonthItems) {\n          const itemValue = item.quantity * parseFloat(item.price);\n          const curr = lastMonthMap.get(item.productId);\n          if (curr) {\n            curr.quantity += item.quantity;\n            curr.totalValue += itemValue;\n          } else {\n            lastMonthMap.set(item.productId, { \n              name: item.name || 'Produto', \n              quantity: item.quantity, \n              totalValue: itemValue\n            });\n          }\n        }\n        lastMonthProducts = Array.from(lastMonthMap.entries())\n          .map(([productId, data]) => ({ productId, ...data }))\n          .sort((a, b) => b.quantity - a.quantity);\n      }\n    }\n\n    return { totalSpent, totalOrders, completedOrders, monthlyStats, topProducts, lastMonthProducts };\n  }\n\n  async getAdminSalesStats(period?: 'day' | 'week' | 'month' | 'year' | 'all'): Promise<{\n    totalRevenue: number;\n    totalCost: number;\n    totalProfit: number;\n    totalOrders: number;\n    completedOrders: number;\n    pendingOrders: number;\n    averageOrderValue: number;\n    monthlyRevenue: Array<{ month: string; revenue: number; orders: number }>;\n    topProducts: Array<{ productId: number; name: string; totalQuantity: number; totalValue: number }>;\n    ordersByStatus: Array<{ status: string; count: number }>;\n    dailySales: Array<{ day: string; revenue: number; orders: number }>;\n    salesByCategory: Array<{ categoryId: number; categoryName: string; totalValue: number; totalQuantity: number }>;\n    customerPositivation: { totalCustomers: number; activeThisPeriod: number; newThisPeriod: number };\n    salesEvolution: Array<{ month: string; revenue: number; orders: number; avgTicket: number }>;\n    periodLabel: string;\n  }> {\n    // Calculate period start date\n    const now = new Date();\n    let periodStart: Date;\n    let periodLabel: string;\n    \n    switch (period) {\n      case 'day':\n        periodStart = new Date(now.getFullYear(), now.getMonth(), now.getDate());\n        periodLabel = 'Hoje';\n        break;\n      case 'week':\n        const dayOfWeek = now.getDay();\n        periodStart = new Date(now.getFullYear(), now.getMonth(), now.getDate() - dayOfWeek);\n        periodLabel = 'Esta Semana';\n        break;\n      case 'month':\n        periodStart = new Date(now.getFullYear(), now.getMonth(), 1);\n        periodLabel = 'Este Mes';\n        break;\n      case 'year':\n        periodStart = new Date(now.getFullYear(), 0, 1);\n        periodLabel = 'Este Ano';\n        break;\n      default:\n        periodStart = new Date(0); // All time\n        periodLabel = 'Todo Periodo';\n    }\n    \n    // Considerar apenas pedidos faturados para todas as métricas de análise\n    const allFaturadoOrders = await db.select().from(orders).where(eq(orders.status, 'FATURADO'));\n    \n    // Filter orders by period\n    const faturadoOrders = allFaturadoOrders.filter(o => new Date(o.createdAt) >= periodStart);\n    \n    const totalRevenue = faturadoOrders.reduce((sum, o) => sum + parseFloat(o.total), 0);\n    const totalOrders = faturadoOrders.length;\n    const completedOrders = faturadoOrders.length;\n    const pendingOrders = 0; // Não há pedidos pendentes na análise (apenas faturados)\n    const averageOrderValue = totalOrders > 0 ? totalRevenue / totalOrders : 0;\n\n    const monthlyMap = new Map<string, { revenue: number; orders: number }>();\n    for (const o of faturadoOrders) {\n      const date = new Date(o.createdAt);\n      const key = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;\n      const curr = monthlyMap.get(key) || { revenue: 0, orders: 0 };\n      curr.revenue += parseFloat(o.total);\n      curr.orders += 1;\n      monthlyMap.set(key, curr);\n    }\n    const monthlyRevenue = Array.from(monthlyMap.entries())\n      .map(([month, data]) => ({ month, ...data }))\n      .sort((a, b) => a.month.localeCompare(b.month))\n      .slice(-6);\n\n    // Apenas pedidos faturados - status único\n    const ordersByStatus = [{ status: 'FATURADO', count: faturadoOrders.length }];\n\n    const faturadoOrderIds = faturadoOrders.map(o => o.id);\n    let topProducts: Array<{ productId: number; name: string; totalQuantity: number; totalValue: number }> = [];\n    let totalCost = 0;\n    \n    if (faturadoOrderIds.length > 0) {\n      const items = await db.select({\n        productId: orderItems.productId,\n        quantity: orderItems.quantity,\n        price: orderItems.price,\n        name: products.name,\n        cost: products.cost,\n      }).from(orderItems)\n        .leftJoin(products, eq(orderItems.productId, products.id))\n        .where(sql`${orderItems.orderId} IN (${sql.join(faturadoOrderIds.map(id => sql`${id}`), sql`, `)})`);\n\n      const productMap = new Map<number, { name: string; totalQuantity: number; totalValue: number }>();\n      for (const item of items) {\n        const curr = productMap.get(item.productId) || { name: item.name || 'Produto', totalQuantity: 0, totalValue: 0 };\n        curr.totalQuantity += item.quantity;\n        curr.totalValue += item.quantity * parseFloat(item.price);\n        productMap.set(item.productId, curr);\n        \n        // Calculate total cost\n        const itemCost = item.cost ? parseFloat(item.cost) : 0;\n        totalCost += item.quantity * itemCost;\n      }\n      topProducts = Array.from(productMap.entries())\n        .map(([productId, data]) => ({ productId, ...data }))\n        .sort((a, b) => b.totalValue - a.totalValue)\n        .slice(0, 10);\n    }\n    \n    const totalProfit = totalRevenue - totalCost;\n\n    // Daily sales (within period)\n    const dailyMap = new Map<string, { revenue: number; orders: number }>();\n    for (const o of faturadoOrders) {\n      const date = new Date(o.createdAt);\n      const key = `${date.getDate()}`;\n      const curr = dailyMap.get(key) || { revenue: 0, orders: 0 };\n      curr.revenue += parseFloat(o.total);\n      curr.orders += 1;\n      dailyMap.set(key, curr);\n    }\n    const dailySales = Array.from(dailyMap.entries())\n      .map(([day, data]) => ({ day, ...data }))\n      .sort((a, b) => parseInt(a.day) - parseInt(b.day));\n\n    // Sales by category\n    const allCategories = await db.select().from(categories);\n    const categoryNameMap = new Map<number, string>();\n    allCategories.forEach(c => categoryNameMap.set(c.id, c.name));\n    \n    let salesByCategory: Array<{ categoryId: number; categoryName: string; totalValue: number; totalQuantity: number }> = [];\n    if (faturadoOrderIds.length > 0) {\n      const itemsWithCategory = await db.select({\n        productId: orderItems.productId,\n        quantity: orderItems.quantity,\n        price: orderItems.price,\n        categoryId: products.categoryId,\n      }).from(orderItems)\n        .leftJoin(products, eq(orderItems.productId, products.id))\n        .where(sql`${orderItems.orderId} IN (${sql.join(faturadoOrderIds.map(id => sql`${id}`), sql`, `)})`);\n\n      const catMap = new Map<number, { totalValue: number; totalQuantity: number }>();\n      for (const item of itemsWithCategory) {\n        const catId = item.categoryId || 0;\n        const curr = catMap.get(catId) || { totalValue: 0, totalQuantity: 0 };\n        curr.totalQuantity += item.quantity;\n        curr.totalValue += item.quantity * parseFloat(item.price);\n        catMap.set(catId, curr);\n      }\n      salesByCategory = Array.from(catMap.entries())\n        .map(([categoryId, data]) => ({ \n          categoryId, \n          categoryName: categoryNameMap.get(categoryId) || 'Sem Categoria',\n          ...data \n        }))\n        .sort((a, b) => b.totalValue - a.totalValue)\n        .slice(0, 10);\n    }\n\n    // Customer positivation (customers who made orders in the period) - apenas pedidos faturados\n    const allUsers = await db.select().from(users).where(eq(users.role, 'customer'));\n    const totalCustomers = allUsers.length;\n    \n    const periodFaturadoOrders = faturadoOrders.filter(o => {\n      const date = new Date(o.createdAt);\n      return date >= periodStart && o.userId;\n    });\n    const activeCustomersPeriod = new Set(periodFaturadoOrders.map(o => o.userId));\n    const activeThisPeriod = activeCustomersPeriod.size;\n    \n    const newCustomersPeriod = allUsers.filter(u => {\n      const created = new Date(u.createdAt);\n      return created >= periodStart;\n    });\n    const newThisPeriod = newCustomersPeriod.length;\n    \n    const customerPositivation = { totalCustomers, activeThisPeriod, newThisPeriod };\n\n    // Sales evolution (last 12 months for comparison)\n    const salesEvolutionMap = new Map<string, { revenue: number; orders: number }>();\n    for (const o of faturadoOrders) {\n      const date = new Date(o.createdAt);\n      const key = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;\n      const curr = salesEvolutionMap.get(key) || { revenue: 0, orders: 0 };\n      curr.revenue += parseFloat(o.total);\n      curr.orders += 1;\n      salesEvolutionMap.set(key, curr);\n    }\n    const salesEvolution = Array.from(salesEvolutionMap.entries())\n      .map(([month, data]) => ({ \n        month, \n        revenue: data.revenue, \n        orders: data.orders,\n        avgTicket: data.orders > 0 ? data.revenue / data.orders : 0\n      }))\n      .sort((a, b) => a.month.localeCompare(b.month))\n      .slice(-12);\n\n    return { \n      totalRevenue, totalCost, totalProfit, totalOrders, completedOrders, pendingOrders, averageOrderValue, \n      monthlyRevenue, topProducts, ordersByStatus,\n      dailySales, salesByCategory, customerPositivation, salesEvolution, periodLabel\n    };\n  }\n\n  async getCustomerAnalytics(): Promise<CustomerAnalyticsData> {\n    const now = new Date();\n    const oneMonthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);\n    const threeMonthsAgo = new Date(now.getTime() - 90 * 24 * 60 * 60 * 1000);\n    const oneYearAgo = new Date(now.getTime() - 365 * 24 * 60 * 60 * 1000);\n    const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);\n\n    const allOrders = await db.select().from(orders).where(eq(orders.status, 'FATURADO'));\n    \n    // Get all users who have made orders, not just role='customer'\n    const userIdsWithOrders = [...new Set(allOrders.map(o => o.userId))];\n    const allUsers = await db.select().from(users);\n    const allCustomers = allUsers.filter(u => userIdsWithOrders.includes(u.id) || u.role === 'customer');\n\n    const customerOrdersMap = new Map<string, Order[]>();\n    for (const order of allOrders) {\n      const existing = customerOrdersMap.get(order.userId) || [];\n      existing.push(order);\n      customerOrdersMap.set(order.userId, existing);\n    }\n\n    const buildRanking = (customerOrders: Order[], user: User): CustomerRanking => {\n      const totalRevenue = customerOrders.reduce((sum, o) => sum + parseFloat(o.total), 0);\n      const orderCount = customerOrders.length;\n      const avgTicket = orderCount > 0 ? totalRevenue / orderCount : 0;\n      const sortedOrders = [...customerOrders].sort((a, b) => \n        new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime()\n      );\n      const lastOrderDate = sortedOrders.length > 0 ? new Date(sortedOrders[0].createdAt) : null;\n      const firstOrderDate = sortedOrders.length > 0 ? new Date(sortedOrders[sortedOrders.length - 1].createdAt) : null;\n      const daysSinceLastOrder = lastOrderDate ? Math.floor((now.getTime() - lastOrderDate.getTime()) / (24 * 60 * 60 * 1000)) : 9999;\n\n      return {\n        userId: user.id,\n        name: [user.firstName, user.lastName].filter(Boolean).join(' ') || user.email || 'Cliente',\n        company: user.company,\n        email: user.email,\n        totalRevenue,\n        orderCount,\n        avgTicket,\n        lastOrderDate,\n        daysSinceLastOrder,\n        firstOrderDate,\n      };\n    };\n\n    const customerRankings: CustomerRanking[] = [];\n    for (const user of allCustomers) {\n      const customerOrders = customerOrdersMap.get(user.id) || [];\n      if (customerOrders.length > 0) {\n        customerRankings.push(buildRanking(customerOrders, user));\n      }\n    }\n\n    const filterByDate = (rankings: CustomerRanking[], since: Date) => {\n      return allCustomers.map(user => {\n        const customerOrders = (customerOrdersMap.get(user.id) || [])\n          .filter(o => new Date(o.createdAt) >= since);\n        if (customerOrders.length === 0) return null;\n        return buildRanking(customerOrders, user);\n      }).filter((r): r is CustomerRanking => r !== null)\n        .sort((a, b) => b.totalRevenue - a.totalRevenue)\n        .slice(0, 20);\n    };\n\n    const topCustomersByRevenue = {\n      month: filterByDate(customerRankings, oneMonthAgo),\n      quarter: filterByDate(customerRankings, threeMonthsAgo),\n      year: filterByDate(customerRankings, oneYearAgo),\n    };\n\n    const topCustomersByFrequency = [...customerRankings]\n      .sort((a, b) => b.orderCount - a.orderCount)\n      .slice(0, 20);\n\n    const sortedByRevenue = [...customerRankings].sort((a, b) => b.totalRevenue - a.totalRevenue);\n    const totalRevenue = sortedByRevenue.reduce((sum, c) => sum + c.totalRevenue, 0);\n    let cumulative = 0;\n    const abcAnalysis = { a: [] as CustomerRanking[], b: [] as CustomerRanking[], c: [] as CustomerRanking[] };\n    for (const customer of sortedByRevenue) {\n      cumulative += customer.totalRevenue;\n      const percent = (cumulative / totalRevenue) * 100;\n      if (percent <= 80) abcAnalysis.a.push(customer);\n      else if (percent <= 95) abcAnalysis.b.push(customer);\n      else abcAnalysis.c.push(customer);\n    }\n\n    const calculateAvgDaysBetween = (customerOrders: Order[]): number => {\n      if (customerOrders.length < 2) return 0;\n      const sorted = [...customerOrders].sort((a, b) => \n        new Date(a.createdAt).getTime() - new Date(b.createdAt).getTime()\n      );\n      let totalDays = 0;\n      for (let i = 1; i < sorted.length; i++) {\n        totalDays += (new Date(sorted[i].createdAt).getTime() - new Date(sorted[i-1].createdAt).getTime()) / (24 * 60 * 60 * 1000);\n      }\n      return totalDays / (sorted.length - 1);\n    };\n\n    const buildInactiveCustomer = (ranking: CustomerRanking, avgDays: number): InactiveCustomer => {\n      let churnRisk: 'low' | 'medium' | 'high' = 'low';\n      if (avgDays > 0 && ranking.daysSinceLastOrder > avgDays * 1.5) churnRisk = 'high';\n      else if (avgDays > 0 && ranking.daysSinceLastOrder > avgDays) churnRisk = 'medium';\n      else if (ranking.daysSinceLastOrder > 60) churnRisk = 'high';\n      else if (ranking.daysSinceLastOrder > 30) churnRisk = 'medium';\n\n      return {\n        userId: ranking.userId,\n        name: ranking.name,\n        company: ranking.company,\n        email: ranking.email,\n        lastOrderDate: ranking.lastOrderDate!,\n        daysSinceLastOrder: ranking.daysSinceLastOrder,\n        avgDaysBetweenOrders: avgDays,\n        churnRisk,\n        totalSpent: ranking.totalRevenue,\n        orderCount: ranking.orderCount,\n      };\n    };\n\n    const inactiveCustomers = { days7: [] as InactiveCustomer[], days15: [] as InactiveCustomer[], days30: [] as InactiveCustomer[], days60: [] as InactiveCustomer[], days90: [] as InactiveCustomer[] };\n    for (const ranking of customerRankings) {\n      if (ranking.lastOrderDate) {\n        const avgDays = calculateAvgDaysBetween(customerOrdersMap.get(ranking.userId) || []);\n        const inactive = buildInactiveCustomer(ranking, avgDays);\n        if (ranking.daysSinceLastOrder >= 7) inactiveCustomers.days7.push(inactive);\n        if (ranking.daysSinceLastOrder >= 15) inactiveCustomers.days15.push(inactive);\n        if (ranking.daysSinceLastOrder >= 30) inactiveCustomers.days30.push(inactive);\n        if (ranking.daysSinceLastOrder >= 60) inactiveCustomers.days60.push(inactive);\n        if (ranking.daysSinceLastOrder >= 90) inactiveCustomers.days90.push(inactive);\n      }\n    }\n    Object.values(inactiveCustomers).forEach(list => list.sort((a, b) => b.daysSinceLastOrder - a.daysSinceLastOrder));\n\n    const newCustomersThisMonth = allCustomers\n      .filter(u => new Date(u.createdAt) >= startOfMonth)\n      .map(user => {\n        const customerOrders = customerOrdersMap.get(user.id) || [];\n        return buildRanking(customerOrders, user);\n      })\n      .filter(r => r.orderCount > 0);\n\n    const reactivatedThisMonth: CustomerRanking[] = [];\n    for (const user of allCustomers) {\n      const customerOrders = customerOrdersMap.get(user.id) || [];\n      if (customerOrders.length < 2) continue;\n      const sorted = [...customerOrders].sort((a, b) => \n        new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime()\n      );\n      const lastOrder = new Date(sorted[0].createdAt);\n      const previousOrder = new Date(sorted[1].createdAt);\n      if (lastOrder >= startOfMonth && (lastOrder.getTime() - previousOrder.getTime()) > 60 * 24 * 60 * 60 * 1000) {\n        reactivatedThisMonth.push(buildRanking(customerOrders, user));\n      }\n    }\n\n    const maxRecency = Math.max(...customerRankings.map(c => c.daysSinceLastOrder).filter(d => d < 9999), 1);\n    const maxFrequency = Math.max(...customerRankings.map(c => c.orderCount), 1);\n    const maxMonetary = Math.max(...customerRankings.map(c => c.totalRevenue), 1);\n\n    const rfmSegments: RFMSegment[] = customerRankings.map(c => {\n      const rScore = Math.ceil(5 - (c.daysSinceLastOrder / maxRecency) * 4);\n      const fScore = Math.ceil((c.orderCount / maxFrequency) * 5);\n      const mScore = Math.ceil((c.totalRevenue / maxMonetary) * 5);\n      const rfmScore = `${Math.max(1, Math.min(5, rScore))}${Math.max(1, Math.min(5, fScore))}${Math.max(1, Math.min(5, mScore))}`;\n      \n      let segment = 'Regular';\n      const r = Math.max(1, Math.min(5, rScore));\n      const f = Math.max(1, Math.min(5, fScore));\n      const m = Math.max(1, Math.min(5, mScore));\n      \n      if (r >= 4 && f >= 4 && m >= 4) segment = 'VIP';\n      else if (r >= 4 && f >= 3) segment = 'Recente e Frequente';\n      else if (r <= 2 && m >= 4) segment = 'Alto Valor Sumido';\n      else if (r <= 2 && f <= 2 && m <= 2) segment = 'Baixo Engajamento';\n      else if (r >= 4) segment = 'Novo/Recente';\n      else if (m >= 4) segment = 'Alto Valor';\n      else if (f >= 4) segment = 'Frequente';\n\n      return {\n        userId: c.userId,\n        name: c.name,\n        company: c.company,\n        recency: c.daysSinceLastOrder,\n        frequency: c.orderCount,\n        monetary: c.totalRevenue,\n        rfmScore,\n        segment,\n      };\n    });\n\n    let totalAvgDays = 0;\n    let countWithMultiple = 0;\n    for (const [, customerOrders] of customerOrdersMap) {\n      if (customerOrders.length >= 2) {\n        totalAvgDays += calculateAvgDaysBetween(customerOrders);\n        countWithMultiple++;\n      }\n    }\n    const avgDaysBetweenOrders = countWithMultiple > 0 ? totalAvgDays / countWithMultiple : 0;\n\n    const firstTimeCustomers = allCustomers.filter(u => {\n      const customerOrders = customerOrdersMap.get(u.id) || [];\n      return customerOrders.length === 1;\n    });\n    \n    const cohortRetention = { days30: 0, days60: 0, days90: 0 };\n    for (const user of allCustomers) {\n      const customerOrders = customerOrdersMap.get(user.id) || [];\n      if (customerOrders.length < 1) continue;\n      const sorted = [...customerOrders].sort((a, b) => \n        new Date(a.createdAt).getTime() - new Date(b.createdAt).getTime()\n      );\n      const firstOrder = new Date(sorted[0].createdAt);\n      if (customerOrders.length >= 2) {\n        const secondOrder = new Date(sorted[1].createdAt);\n        const daysBetween = (secondOrder.getTime() - firstOrder.getTime()) / (24 * 60 * 60 * 1000);\n        if (daysBetween <= 30) cohortRetention.days30++;\n        if (daysBetween <= 60) cohortRetention.days60++;\n        if (daysBetween <= 90) cohortRetention.days90++;\n      }\n    }\n    const totalWithOrders = customerRankings.length;\n    if (totalWithOrders > 0) {\n      cohortRetention.days30 = Math.round((cohortRetention.days30 / totalWithOrders) * 100);\n      cohortRetention.days60 = Math.round((cohortRetention.days60 / totalWithOrders) * 100);\n      cohortRetention.days90 = Math.round((cohortRetention.days90 / totalWithOrders) * 100);\n    }\n\n    // Calculate conversion metrics (ORCAMENTO -> FATURADO)\n    const allOrdersIncludingQuotes = await db.select().from(orders);\n    const customerAllOrdersMap = new Map<string, Order[]>();\n    for (const order of allOrdersIncludingQuotes) {\n      const existing = customerAllOrdersMap.get(order.userId) || [];\n      existing.push(order);\n      customerAllOrdersMap.set(order.userId, existing);\n    }\n\n    const conversionMetrics: ConversionMetric[] = [];\n    for (const user of allCustomers) {\n      const customerOrders = customerAllOrdersMap.get(user.id) || [];\n      if (customerOrders.length === 0) continue;\n      \n      const quotes = customerOrders.filter(o => o.status === 'ORCAMENTO' || o.status === 'ORCAMENTO_ABERTO' || o.status === 'ORCAMENTO_CONCLUIDO');\n      const converted = customerOrders.filter(o => o.status === 'FATURADO' || o.status === 'PEDIDO_FATURADO');\n      const totalRevenue = converted.reduce((sum, o) => sum + parseFloat(o.total), 0);\n      \n      // Only include customers who have activity (either quotes or converted orders)\n      const totalActivity = quotes.length + converted.length;\n      if (totalActivity === 0) continue;\n      \n      // Conversion rate: If customer has only faturado orders (no quotes), they converted 100%\n      // If they have quotes, rate = converted / (quotes + converted) * 100\n      const conversionRate = totalActivity > 0 ? (converted.length / totalActivity) * 100 : 0;\n      \n      conversionMetrics.push({\n        userId: user.id,\n        name: [user.firstName, user.lastName].filter(Boolean).join(' ') || user.email || 'Cliente',\n        company: user.company,\n        email: user.email,\n        totalQuotes: quotes.length,\n        convertedOrders: converted.length,\n        conversionRate,\n        totalRevenue,\n      });\n    }\n    \n    // Sort by conversion rate (descending), then by converted orders count\n    conversionMetrics.sort((a, b) => {\n      if (b.conversionRate !== a.conversionRate) return b.conversionRate - a.conversionRate;\n      return b.convertedOrders - a.convertedOrders;\n    });\n\n    return {\n      topCustomersByRevenue,\n      topCustomersByFrequency,\n      abcAnalysis,\n      inactiveCustomers,\n      reactivatedThisMonth,\n      newCustomersThisMonth,\n      rfmSegments,\n      avgDaysBetweenOrders,\n      cohortRetention,\n      conversionMetrics,\n    };\n  }\n\n  async getProductAnalytics(): Promise<ProductAnalyticsData> {\n    const now = new Date();\n    const days7Ago = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);\n    const days30Ago = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);\n    const days60Ago = new Date(now.getTime() - 60 * 24 * 60 * 60 * 1000);\n    const days90Ago = new Date(now.getTime() - 90 * 24 * 60 * 60 * 1000);\n\n    const allProducts = await db.select().from(products);\n    const allCategories = await db.select().from(categories);\n    const allOrders = await db.select().from(orders).where(eq(orders.status, 'FATURADO'));\n    const faturadoOrderIds = new Set(allOrders.map(o => o.id));\n    const allOrderItems = (await db.select().from(orderItems)).filter(item => faturadoOrderIds.has(item.orderId));\n\n    const categoryMap = new Map<number, string>();\n    for (const cat of allCategories) {\n      categoryMap.set(cat.id, cat.name);\n    }\n\n    const productMap = new Map<number, typeof allProducts[0]>();\n    for (const prod of allProducts) {\n      productMap.set(prod.id, prod);\n    }\n\n    const orderDateMap = new Map<number, Date>();\n    for (const order of allOrders) {\n      orderDateMap.set(order.id, new Date(order.createdAt));\n    }\n\n    const orderUserMap = new Map<number, string>();\n    for (const order of allOrders) {\n      orderUserMap.set(order.id, order.userId);\n    }\n\n    interface ProductStats {\n      productId: number;\n      name: string;\n      sku: string;\n      brand: string | null;\n      categoryId: number | null;\n      categoryName: string | null;\n      totalRevenue: number;\n      totalQuantity: number;\n      orderCount: number;\n      orderIds: Set<number>;\n      customerIds: Set<string>;\n      salesDates: Date[];\n    }\n\n    const buildStats = (items: typeof allOrderItems, sinceDate?: Date): Map<number, ProductStats> => {\n      const stats = new Map<number, ProductStats>();\n      for (const item of items) {\n        const orderDate = orderDateMap.get(item.orderId);\n        if (!orderDate) continue;\n        if (sinceDate && orderDate < sinceDate) continue;\n\n        const product = productMap.get(item.productId);\n        if (!product) continue;\n\n        const existing = stats.get(item.productId) || {\n          productId: item.productId,\n          name: product.name,\n          sku: product.sku,\n          brand: product.brand,\n          categoryId: product.categoryId,\n          categoryName: product.categoryId ? categoryMap.get(product.categoryId) || null : null,\n          totalRevenue: 0,\n          totalQuantity: 0,\n          orderCount: 0,\n          orderIds: new Set<number>(),\n          customerIds: new Set<string>(),\n          salesDates: [],\n        };\n\n        existing.totalRevenue += item.quantity * parseFloat(item.price);\n        existing.totalQuantity += item.quantity;\n        existing.orderIds.add(item.orderId);\n        existing.salesDates.push(orderDate);\n        const userId = orderUserMap.get(item.orderId);\n        if (userId) existing.customerIds.add(userId);\n\n        stats.set(item.productId, existing);\n      }\n\n      for (const [, s] of stats) {\n        s.orderCount = s.orderIds.size;\n      }\n\n      return stats;\n    };\n\n    const allTimeStats = buildStats(allOrderItems);\n    const stats7d = buildStats(allOrderItems, days7Ago);\n    const stats30d = buildStats(allOrderItems, days30Ago);\n    const stats60d = buildStats(allOrderItems, days60Ago);\n    const stats90d = buildStats(allOrderItems, days90Ago);\n\n    const totalRevenue = Array.from(allTimeStats.values()).reduce((sum, s) => sum + s.totalRevenue, 0);\n    const totalQuantitySold = Array.from(allTimeStats.values()).reduce((sum, s) => sum + s.totalQuantity, 0);\n    const uniqueProductsSold = allTimeStats.size;\n    const avgTicketPerProduct = uniqueProductsSold > 0 ? totalRevenue / uniqueProductsSold : 0;\n\n    const overview = { totalRevenue, totalQuantitySold, avgTicketPerProduct, uniqueProductsSold };\n\n    const toRanking = (stats: Map<number, ProductStats>, totalRev: number): ProductRanking[] => {\n      return Array.from(stats.values()).map(s => ({\n        productId: s.productId,\n        name: s.name,\n        sku: s.sku,\n        brand: s.brand,\n        categoryId: s.categoryId,\n        categoryName: s.categoryName,\n        totalRevenue: s.totalRevenue,\n        totalQuantity: s.totalQuantity,\n        orderCount: s.orderCount,\n        avgPrice: s.totalQuantity > 0 ? s.totalRevenue / s.totalQuantity : 0,\n        revenueShare: totalRev > 0 ? (s.totalRevenue / totalRev) * 100 : 0,\n        growthPercent: 0,\n      }));\n    };\n\n    const sortByRevenue = (arr: ProductRanking[]) => [...arr].sort((a, b) => b.totalRevenue - a.totalRevenue).slice(0, 20);\n    const sortByVolume = (arr: ProductRanking[]) => [...arr].sort((a, b) => b.totalQuantity - a.totalQuantity).slice(0, 20);\n\n    const total7d = Array.from(stats7d.values()).reduce((sum, s) => sum + s.totalRevenue, 0);\n    const total30d = Array.from(stats30d.values()).reduce((sum, s) => sum + s.totalRevenue, 0);\n    const total60d = Array.from(stats60d.values()).reduce((sum, s) => sum + s.totalRevenue, 0);\n    const total90d = Array.from(stats90d.values()).reduce((sum, s) => sum + s.totalRevenue, 0);\n\n    const rankingByRevenue = {\n      days7: sortByRevenue(toRanking(stats7d, total7d)),\n      days30: sortByRevenue(toRanking(stats30d, total30d)),\n      days60: sortByRevenue(toRanking(stats60d, total60d)),\n      days90: sortByRevenue(toRanking(stats90d, total90d)),\n    };\n\n    const rankingByVolume = {\n      days7: sortByVolume(toRanking(stats7d, total7d)),\n      days30: sortByVolume(toRanking(stats30d, total30d)),\n      days60: sortByVolume(toRanking(stats60d, total60d)),\n      days90: sortByVolume(toRanking(stats90d, total90d)),\n    };\n\n    const prev30to60Stats = buildStats(allOrderItems.filter(item => {\n      const d = orderDateMap.get(item.orderId);\n      return d && d >= days60Ago && d < days30Ago;\n    }));\n\n    const growthData: ProductRanking[] = [];\n    for (const [productId, current] of stats30d) {\n      const prev = prev30to60Stats.get(productId);\n      const prevRev = prev?.totalRevenue || 0;\n      const growthPercent = prevRev > 0 ? ((current.totalRevenue - prevRev) / prevRev) * 100 : (current.totalRevenue > 0 ? 100 : 0);\n      const product = productMap.get(productId);\n      if (product) {\n        growthData.push({\n          productId,\n          name: product.name,\n          sku: product.sku,\n          brand: product.brand,\n          categoryId: product.categoryId,\n          categoryName: product.categoryId ? categoryMap.get(product.categoryId) || null : null,\n          totalRevenue: current.totalRevenue,\n          totalQuantity: current.totalQuantity,\n          orderCount: current.orderCount,\n          avgPrice: current.totalQuantity > 0 ? current.totalRevenue / current.totalQuantity : 0,\n          revenueShare: total30d > 0 ? (current.totalRevenue / total30d) * 100 : 0,\n          growthPercent,\n        });\n      }\n    }\n\n    const topGrowing = [...growthData].filter(p => p.growthPercent > 0).sort((a, b) => b.growthPercent - a.growthPercent).slice(0, 10);\n    const topDeclining = [...growthData].filter(p => p.growthPercent < 0).sort((a, b) => a.growthPercent - b.growthPercent).slice(0, 10);\n\n    const abcSorted = [...toRanking(allTimeStats, totalRevenue)].sort((a, b) => b.totalRevenue - a.totalRevenue);\n    let cumulative = 0;\n    const abcProducts: ProductABC[] = abcSorted.map(p => {\n      cumulative += p.revenueShare;\n      return {\n        productId: p.productId,\n        name: p.name,\n        sku: p.sku,\n        categoryName: p.categoryName,\n        totalRevenue: p.totalRevenue,\n        revenueShare: p.revenueShare,\n        cumulativeShare: cumulative,\n        abcClass: cumulative <= 80 ? 'A' : cumulative <= 95 ? 'B' : 'C',\n      };\n    });\n\n    const abcAnalysis = {\n      a: abcProducts.filter(p => p.abcClass === 'A'),\n      b: abcProducts.filter(p => p.abcClass === 'B'),\n      c: abcProducts.filter(p => p.abcClass === 'C'),\n    };\n\n    const daysSinceStart = allOrders.length > 0 \n      ? Math.max(1, Math.ceil((now.getTime() - Math.min(...allOrders.map(o => new Date(o.createdAt).getTime()))) / (24 * 60 * 60 * 1000)))\n      : 1;\n\n    const velocity: ProductVelocity[] = Array.from(allTimeStats.values()).map(s => {\n      const avgSalesPerDay = s.totalQuantity / daysSinceStart;\n      const lastSaleDate = s.salesDates.length > 0 ? Math.max(...s.salesDates.map(d => d.getTime())) : 0;\n      const daysSinceLastSale = lastSaleDate > 0 ? Math.ceil((now.getTime() - lastSaleDate) / (24 * 60 * 60 * 1000)) : 9999;\n      \n      let status: 'fast' | 'normal' | 'slow' | 'stopped' = 'normal';\n      if (daysSinceLastSale > 60) status = 'stopped';\n      else if (daysSinceLastSale > 30) status = 'slow';\n      else if (avgSalesPerDay >= 1) status = 'fast';\n\n      return {\n        productId: s.productId,\n        name: s.name,\n        sku: s.sku,\n        avgSalesPerDay,\n        totalQuantity: s.totalQuantity,\n        daysSinceLastSale,\n        status,\n      };\n    }).sort((a, b) => b.avgSalesPerDay - a.avgSalesPerDay);\n\n    const productCustomerOrders = new Map<number, Map<string, Date[]>>();\n    for (const item of allOrderItems) {\n      const orderDate = orderDateMap.get(item.orderId);\n      const userId = orderUserMap.get(item.orderId);\n      if (!orderDate || !userId) continue;\n\n      if (!productCustomerOrders.has(item.productId)) {\n        productCustomerOrders.set(item.productId, new Map());\n      }\n      const customerMap = productCustomerOrders.get(item.productId)!;\n      if (!customerMap.has(userId)) {\n        customerMap.set(userId, []);\n      }\n      customerMap.get(userId)!.push(orderDate);\n    }\n\n    const repurchase: ProductRepurchase[] = Array.from(allTimeStats.values()).map(s => {\n      const customerOrders = productCustomerOrders.get(s.productId) || new Map();\n      const uniqueCustomers = customerOrders.size;\n      let repeatCustomers = 0;\n      let totalDaysBetween = 0;\n      let countWithRepeat = 0;\n\n      for (const [, dates] of customerOrders) {\n        if (dates.length > 1) {\n          repeatCustomers++;\n          const sorted = dates.sort((a, b) => a.getTime() - b.getTime());\n          for (let i = 1; i < sorted.length; i++) {\n            totalDaysBetween += (sorted[i].getTime() - sorted[i - 1].getTime()) / (24 * 60 * 60 * 1000);\n            countWithRepeat++;\n          }\n        }\n      }\n\n      return {\n        productId: s.productId,\n        name: s.name,\n        sku: s.sku,\n        uniqueCustomers,\n        repeatCustomers,\n        repurchaseRate: uniqueCustomers > 0 ? (repeatCustomers / uniqueCustomers) * 100 : 0,\n        avgDaysBetweenPurchases: countWithRepeat > 0 ? totalDaysBetween / countWithRepeat : 0,\n        singlePurchaseCustomers: uniqueCustomers - repeatCustomers,\n      };\n    }).sort((a, b) => b.repurchaseRate - a.repurchaseRate);\n\n    const orderProductsMap = new Map<number, number[]>();\n    for (const item of allOrderItems) {\n      if (!orderProductsMap.has(item.orderId)) {\n        orderProductsMap.set(item.orderId, []);\n      }\n      orderProductsMap.get(item.orderId)!.push(item.productId);\n    }\n\n    const coOccurrence = new Map<string, number>();\n    for (const [, prods] of orderProductsMap) {\n      if (prods.length < 2) continue;\n      for (let i = 0; i < prods.length; i++) {\n        for (let j = i + 1; j < prods.length; j++) {\n          const key = [prods[i], prods[j]].sort((a, b) => a - b).join('-');\n          coOccurrence.set(key, (coOccurrence.get(key) || 0) + 1);\n        }\n      }\n    }\n\n    const productCoOccurrence = new Map<number, Map<number, number>>();\n    for (const [key, count] of coOccurrence) {\n      const [a, b] = key.split('-').map(Number);\n      if (!productCoOccurrence.has(a)) productCoOccurrence.set(a, new Map());\n      if (!productCoOccurrence.has(b)) productCoOccurrence.set(b, new Map());\n      productCoOccurrence.get(a)!.set(b, count);\n      productCoOccurrence.get(b)!.set(a, count);\n    }\n\n    const crossSell: ProductCrossSell[] = Array.from(allTimeStats.values())\n      .sort((a, b) => b.totalRevenue - a.totalRevenue)\n      .slice(0, 20)\n      .map(s => {\n        const pairs = productCoOccurrence.get(s.productId) || new Map();\n        const pairedProducts = Array.from(pairs.entries())\n          .sort((a, b) => b[1] - a[1])\n          .slice(0, 5)\n          .map(([pid, count]) => ({\n            productId: pid,\n            name: productMap.get(pid)?.name || 'Produto',\n            coOccurrence: count,\n          }));\n\n        return {\n          productId: s.productId,\n          name: s.name,\n          pairedProducts,\n          isLeader: s.totalRevenue === Math.max(...Array.from(allTimeStats.values()).map(x => x.totalRevenue)),\n        };\n      });\n\n    const categoryStats = new Map<number, { revenue: number; quantity: number; products: Map<number, number> }>();\n    for (const [productId, stats] of allTimeStats) {\n      const product = productMap.get(productId);\n      if (!product?.categoryId) continue;\n      \n      const existing = categoryStats.get(product.categoryId) || { revenue: 0, quantity: 0, products: new Map() };\n      existing.revenue += stats.totalRevenue;\n      existing.quantity += stats.totalQuantity;\n      existing.products.set(productId, stats.totalRevenue);\n      categoryStats.set(product.categoryId, existing);\n    }\n\n    const categoryPerformance: CategoryPerformance[] = Array.from(categoryStats.entries())\n      .map(([categoryId, stats]) => ({\n        categoryId,\n        categoryName: categoryMap.get(categoryId) || 'Sem Categoria',\n        totalRevenue: stats.revenue,\n        totalQuantity: stats.quantity,\n        productCount: stats.products.size,\n        topProducts: Array.from(stats.products.entries())\n          .sort((a, b) => b[1] - a[1])\n          .slice(0, 5)\n          .map(([pid, rev]) => ({\n            productId: pid,\n            name: productMap.get(pid)?.name || 'Produto',\n            revenue: rev,\n          })),\n      }))\n      .sort((a, b) => b.totalRevenue - a.totalRevenue);\n\n    const problematicProducts: ProblematicProduct[] = [];\n    \n    for (const v of velocity) {\n      if (v.status === 'stopped') {\n        const product = productMap.get(v.productId);\n        if (product) {\n          problematicProducts.push({\n            productId: v.productId,\n            name: v.name,\n            sku: v.sku,\n            issue: 'no_sales',\n            metric: v.daysSinceLastSale,\n            description: `Sem vendas há ${v.daysSinceLastSale} dias`,\n          });\n        }\n      } else if (v.status === 'slow') {\n        const product = productMap.get(v.productId);\n        if (product) {\n          problematicProducts.push({\n            productId: v.productId,\n            name: v.name,\n            sku: v.sku,\n            issue: 'low_turnover',\n            metric: v.avgSalesPerDay,\n            description: `Giro lento: ${v.avgSalesPerDay.toFixed(2)} un/dia`,\n          });\n        }\n      }\n    }\n\n    for (const p of topDeclining.slice(0, 5)) {\n      if (p.growthPercent < -30) {\n        problematicProducts.push({\n          productId: p.productId,\n          name: p.name,\n          sku: p.sku,\n          issue: 'declining',\n          metric: p.growthPercent,\n          description: `Queda de ${Math.abs(p.growthPercent).toFixed(0)}% vs período anterior`,\n        });\n      }\n    }\n\n    return {\n      overview,\n      rankingByRevenue,\n      rankingByVolume,\n      topGrowing,\n      topDeclining,\n      abcAnalysis,\n      velocity,\n      repurchase,\n      crossSell,\n      categoryPerformance,\n      problematicProducts,\n    };\n  }\n\n  async reserveStockForOrder(orderId: number, userId: string): Promise<{ success: boolean; error?: string }> {\n    try {\n      const orderItems = await this.getOrderItems(orderId);\n      const order = await this.getOrder(orderId);\n      if (!order) return { success: false, error: 'Pedido não encontrado' };\n      if (order.status === 'PEDIDO_GERADO' || order.status === 'PEDIDO_FATURADO') {\n        return { success: false, error: 'Estoque já reservado para este pedido' };\n      }\n      \n      for (const item of orderItems) {\n        const product = await this.getProduct(item.productId);\n        if (!product) return { success: false, error: `Produto ${item.productId} não encontrado` };\n        const available = product.stock - (product.reservedStock || 0);\n        if (available < item.quantity) {\n          return { success: false, error: `Estoque insuficiente para ${product.name}. Disponível: ${available}, Necessário: ${item.quantity}` };\n        }\n      }\n      \n      for (const item of orderItems) {\n        await db.update(products)\n          .set({ reservedStock: sql`reserved_stock + ${item.quantity}` })\n          .where(eq(products.id, item.productId));\n      }\n      \n      await db.update(orders)\n        .set({ status: 'PEDIDO_GERADO', stage: 'SEPARADO', reservedAt: new Date(), reservedBy: userId })\n        .where(eq(orders.id, orderId));\n      \n      return { success: true };\n    } catch (error) {\n      return { success: false, error: 'Erro ao reservar estoque' };\n    }\n  }\n\n  async releaseStockForOrder(orderId: number): Promise<{ success: boolean; error?: string }> {\n    try {\n      const order = await this.getOrder(orderId);\n      if (!order) return { success: false, error: 'Pedido não encontrado' };\n      if (order.status !== 'PEDIDO_GERADO') {\n        return { success: false, error: 'Pedido não está com estoque reservado' };\n      }\n      \n      const orderItems = await this.getOrderItems(orderId);\n      for (const item of orderItems) {\n        await db.update(products)\n          .set({ reservedStock: sql`GREATEST(reserved_stock - ${item.quantity}, 0)` })\n          .where(eq(products.id, item.productId));\n      }\n      \n      await db.update(orders)\n        .set({ status: 'ORCAMENTO', reservedAt: null, reservedBy: null })\n        .where(eq(orders.id, orderId));\n      \n      return { success: true };\n    } catch (error) {\n      return { success: false, error: 'Erro ao liberar estoque' };\n    }\n  }\n\n  async deductStockForOrder(orderId: number, userId: string): Promise<{ success: boolean; error?: string }> {\n    try {\n      const order = await this.getOrder(orderId);\n      if (!order) return { success: false, error: 'Pedido não encontrado' };\n      if (order.status !== 'PEDIDO_GERADO') {\n        return { success: false, error: 'Pedido precisa estar com estoque reservado (PEDIDO_GERADO) antes de faturar' };\n      }\n      \n      const orderItems = await this.getOrderItems(orderId);\n      for (const item of orderItems) {\n        await db.update(products)\n          .set({ \n            stock: sql`stock - ${item.quantity}`,\n            reservedStock: sql`GREATEST(reserved_stock - ${item.quantity}, 0)`\n          })\n          .where(eq(products.id, item.productId));\n      }\n      \n      await db.update(orders)\n        .set({ status: 'FATURADO', stage: 'FINALIZADO', invoicedAt: new Date(), invoicedBy: userId })\n        .where(eq(orders.id, orderId));\n      \n      return { success: true };\n    } catch (error) {\n      return { success: false, error: 'Erro ao faturar pedido' };\n    }\n  }\n\n  async updateOrderStage(orderId: number, stage: string): Promise<{ success: boolean; error?: string }> {\n    const validStages = ['PENDENTE_IMPRESSAO', 'IMPRESSO', 'SEPARADO', 'COBRADO', 'FINALIZADO'];\n    if (!validStages.includes(stage)) {\n      return { success: false, error: 'Etapa inválida' };\n    }\n    \n    try {\n      const order = await this.getOrder(orderId);\n      if (!order) return { success: false, error: 'Pedido não encontrado' };\n      \n      await db.update(orders)\n        .set({ stage })\n        .where(eq(orders.id, orderId));\n      \n      return { success: true };\n    } catch (error) {\n      return { success: false, error: 'Erro ao atualizar etapa' };\n    }\n  }\n\n  async getPurchasesAnalytics(): Promise<PurchasesAnalyticsData> {\n    const now = new Date();\n    const days30Ago = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);\n    const days60Ago = new Date(now.getTime() - 60 * 24 * 60 * 60 * 1000);\n    const days90Ago = new Date(now.getTime() - 90 * 24 * 60 * 60 * 1000);\n\n    const allProducts = await db.select().from(products);\n    const allCategories = await db.select().from(categories);\n    const faturadoOrders = await db.select().from(orders).where(eq(orders.status, 'FATURADO'));\n    const faturadoOrderIds = new Set(faturadoOrders.map(o => o.id));\n    const allOrderItems = (await db.select().from(orderItems)).filter(item => faturadoOrderIds.has(item.orderId));\n\n    const categoryMap = new Map<number, string>();\n    for (const cat of allCategories) {\n      categoryMap.set(cat.id, cat.name);\n    }\n\n    const orderDateMap = new Map<number, Date>();\n    for (const order of faturadoOrders) {\n      orderDateMap.set(order.id, new Date(order.createdAt));\n    }\n\n    interface ProductSalesData {\n      productId: number;\n      totalQuantity30d: number;\n      totalQuantity60d: number;\n      totalQuantity90d: number;\n      lastSaleDate: Date | null;\n      salesDates: Date[];\n    }\n\n    const salesDataMap = new Map<number, ProductSalesData>();\n\n    for (const item of allOrderItems) {\n      const orderDate = orderDateMap.get(item.orderId);\n      if (!orderDate) continue;\n\n      const existing = salesDataMap.get(item.productId) || {\n        productId: item.productId,\n        totalQuantity30d: 0,\n        totalQuantity60d: 0,\n        totalQuantity90d: 0,\n        lastSaleDate: null,\n        salesDates: [],\n      };\n\n      if (orderDate >= days30Ago) {\n        existing.totalQuantity30d += item.quantity;\n      }\n      if (orderDate >= days60Ago) {\n        existing.totalQuantity60d += item.quantity;\n      }\n      if (orderDate >= days90Ago) {\n        existing.totalQuantity90d += item.quantity;\n      }\n      existing.salesDates.push(orderDate);\n      if (!existing.lastSaleDate || orderDate > existing.lastSaleDate) {\n        existing.lastSaleDate = orderDate;\n      }\n\n      salesDataMap.set(item.productId, existing);\n    }\n\n    const lowStock: LowStockProduct[] = [];\n    const slowMoving: SlowMovingProduct[] = [];\n    const fastMoving: FastMovingProduct[] = [];\n    const suggestions: PurchaseSuggestion[] = [];\n\n    for (const product of allProducts) {\n      const salesData = salesDataMap.get(product.id);\n      const categoryName = product.categoryId ? categoryMap.get(product.categoryId) || null : null;\n      \n      const avgDailySales30d = salesData ? salesData.totalQuantity30d / 30 : 0;\n      const avgDailySales60d = salesData ? salesData.totalQuantity60d / 60 : 0;\n      const avgDailySales90d = salesData ? salesData.totalQuantity90d / 90 : 0;\n      const avgDailySales = Math.max(avgDailySales30d, avgDailySales60d, avgDailySales90d);\n      \n      const availableStock = product.stock - (product.reservedStock || 0);\n      const daysOfStock = avgDailySales > 0 ? Math.floor(availableStock / avgDailySales) : availableStock > 0 ? 999 : 0;\n      \n      const daysSinceLastSale = salesData?.lastSaleDate \n        ? Math.floor((now.getTime() - salesData.lastSaleDate.getTime()) / (24 * 60 * 60 * 1000))\n        : 999;\n\n      // Low stock logic - products that need replenishment\n      if (avgDailySales > 0 && daysOfStock <= 30) {\n        let urgency: 'critical' | 'high' | 'medium' | 'low' = 'low';\n        if (daysOfStock <= 3) urgency = 'critical';\n        else if (daysOfStock <= 7) urgency = 'high';\n        else if (daysOfStock <= 14) urgency = 'medium';\n\n        const suggestedPurchaseQty = Math.ceil(avgDailySales * 30) - availableStock;\n\n        lowStock.push({\n          productId: product.id,\n          name: product.name,\n          sku: product.sku,\n          categoryName,\n          currentStock: product.stock,\n          reservedStock: product.reservedStock || 0,\n          availableStock,\n          avgDailySales: Math.round(avgDailySales * 100) / 100,\n          daysOfStock,\n          suggestedPurchaseQty: Math.max(0, suggestedPurchaseQty),\n          urgency,\n        });\n\n        if (urgency === 'critical' || urgency === 'high') {\n          suggestions.push({\n            productId: product.id,\n            name: product.name,\n            sku: product.sku,\n            categoryName,\n            currentStock: product.stock,\n            suggestedQty: Math.max(0, suggestedPurchaseQty),\n            estimatedCost: Math.max(0, suggestedPurchaseQty) * parseFloat(product.wholesalePrice),\n            reason: urgency === 'critical' \n              ? `Estoque critico - apenas ${daysOfStock} dias de estoque` \n              : `Estoque baixo - ${daysOfStock} dias de estoque`,\n            priority: urgency === 'critical' ? 'urgent' : 'high',\n          });\n        }\n      }\n\n      // Slow moving logic - products with stock but low sales\n      const stockValue = product.stock * parseFloat(product.wholesalePrice);\n      if (product.stock > 0 && (daysSinceLastSale > 30 || avgDailySales90d < 0.1)) {\n        let recommendation = '';\n        if (daysSinceLastSale > 60) {\n          recommendation = 'Considerar promocao ou liquidacao';\n        } else if (daysSinceLastSale > 30) {\n          recommendation = 'Revisar estrategia de vendas';\n        } else if (avgDailySales90d < 0.1) {\n          recommendation = 'Produto com giro muito lento';\n        }\n\n        slowMoving.push({\n          productId: product.id,\n          name: product.name,\n          sku: product.sku,\n          categoryName,\n          currentStock: product.stock,\n          stockValue: Math.round(stockValue * 100) / 100,\n          daysSinceLastSale,\n          totalSalesLast90Days: salesData?.totalQuantity90d || 0,\n          avgDailySales: Math.round(avgDailySales90d * 100) / 100,\n          recommendation,\n        });\n      }\n\n      // Fast moving logic - products selling well that need restocking\n      const prev30to60Sales = salesData ? salesData.totalQuantity60d - salesData.totalQuantity30d : 0;\n      const growthPercent = prev30to60Sales > 0 \n        ? ((salesData?.totalQuantity30d || 0) - prev30to60Sales) / prev30to60Sales * 100 \n        : salesData?.totalQuantity30d ? 100 : 0;\n\n      if (avgDailySales30d >= 1 || (avgDailySales30d >= 0.5 && growthPercent > 20)) {\n        const suggestedPurchaseQty = Math.ceil(avgDailySales30d * 45) - availableStock;\n        \n        fastMoving.push({\n          productId: product.id,\n          name: product.name,\n          sku: product.sku,\n          categoryName,\n          currentStock: product.stock,\n          avgDailySales: Math.round(avgDailySales30d * 100) / 100,\n          daysOfStock,\n          salesLast30Days: salesData?.totalQuantity30d || 0,\n          growthPercent: Math.round(growthPercent * 10) / 10,\n          suggestedPurchaseQty: Math.max(0, suggestedPurchaseQty),\n        });\n\n        if (daysOfStock <= 14 && suggestedPurchaseQty > 0) {\n          suggestions.push({\n            productId: product.id,\n            name: product.name,\n            sku: product.sku,\n            categoryName,\n            currentStock: product.stock,\n            suggestedQty: suggestedPurchaseQty,\n            estimatedCost: suggestedPurchaseQty * parseFloat(product.wholesalePrice),\n            reason: `Produto com alta demanda - ${salesData?.totalQuantity30d || 0} vendas nos ultimos 30 dias`,\n            priority: daysOfStock <= 7 ? 'urgent' : 'normal',\n          });\n        }\n      }\n    }\n\n    // Sort arrays\n    lowStock.sort((a, b) => {\n      const urgencyOrder = { critical: 0, high: 1, medium: 2, low: 3 };\n      return urgencyOrder[a.urgency] - urgencyOrder[b.urgency];\n    });\n\n    slowMoving.sort((a, b) => b.stockValue - a.stockValue);\n    fastMoving.sort((a, b) => b.avgDailySales - a.avgDailySales);\n    suggestions.sort((a, b) => {\n      const priorityOrder = { urgent: 0, high: 1, normal: 2 };\n      return priorityOrder[a.priority] - priorityOrder[b.priority];\n    });\n\n    const estimatedPurchaseValue = suggestions.reduce((sum, s) => sum + s.estimatedCost, 0);\n    const criticalItems = lowStock.filter(p => p.urgency === 'critical').length;\n\n    return {\n      overview: {\n        totalLowStockProducts: lowStock.length,\n        totalSlowMovingProducts: slowMoving.length,\n        totalFastMovingProducts: fastMoving.length,\n        estimatedPurchaseValue: Math.round(estimatedPurchaseValue * 100) / 100,\n        criticalItems,\n      },\n      lowStock: lowStock.slice(0, 50),\n      slowMoving: slowMoving.slice(0, 50),\n      fastMoving: fastMoving.slice(0, 50),\n      suggestions: suggestions.slice(0, 30),\n    };\n  }\n\n  async getBrandAnalytics(allowedBrands?: string[]): Promise<BrandAnalyticsData> {\n    const now = new Date();\n    const days30Ago = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);\n    const days60Ago = new Date(now.getTime() - 60 * 24 * 60 * 60 * 1000);\n    const days90Ago = new Date(now.getTime() - 90 * 24 * 60 * 60 * 1000);\n\n    let allProducts = await db.select().from(products);\n    \n    // Filter by allowed brands if specified\n    if (allowedBrands && allowedBrands.length > 0) {\n      allProducts = allProducts.filter(p => p.brand && allowedBrands.includes(p.brand));\n    }\n\n    const faturadoOrders = await db.select().from(orders).where(eq(orders.status, 'FATURADO'));\n    const faturadoOrderIds = new Set(faturadoOrders.map(o => o.id));\n    const allOrderItems = (await db.select().from(orderItems)).filter(item => faturadoOrderIds.has(item.orderId));\n\n    const orderDateMap = new Map<number, Date>();\n    for (const order of faturadoOrders) {\n      orderDateMap.set(order.id, new Date(order.createdAt));\n    }\n\n    // Build sales data per product\n    const salesDataMap = new Map<number, {\n      sales30d: number;\n      sales60d: number;\n      sales90d: number;\n      revenue30d: number;\n      lastSaleDate: Date | null;\n      salesDates: Date[];\n    }>();\n\n    for (const item of allOrderItems) {\n      const orderDate = orderDateMap.get(item.orderId);\n      if (!orderDate) continue;\n\n      const existing = salesDataMap.get(item.productId) || {\n        sales30d: 0,\n        sales60d: 0,\n        sales90d: 0,\n        revenue30d: 0,\n        lastSaleDate: null,\n        salesDates: [],\n      };\n\n      const itemPrice = parseFloat(item.price) * item.quantity;\n\n      if (orderDate >= days30Ago) {\n        existing.sales30d += item.quantity;\n        existing.revenue30d += itemPrice;\n      }\n      if (orderDate >= days60Ago) {\n        existing.sales60d += item.quantity;\n      }\n      if (orderDate >= days90Ago) {\n        existing.sales90d += item.quantity;\n      }\n\n      existing.salesDates.push(orderDate);\n      if (!existing.lastSaleDate || orderDate > existing.lastSaleDate) {\n        existing.lastSaleDate = orderDate;\n      }\n\n      salesDataMap.set(item.productId, existing);\n    }\n\n    // Build brand summaries\n    const brandMap = new Map<string, {\n      totalProducts: number;\n      totalStock: number;\n      lowStockCount: number;\n      outOfStockCount: number;\n      totalSales30d: number;\n      totalRevenue30d: number;\n      turnoverDays: number[];\n    }>();\n\n    const productsByBrand: Record<string, BrandProductDetail[]> = {};\n\n    for (const product of allProducts) {\n      const brand = product.brand || 'Sem Marca';\n      const salesData = salesDataMap.get(product.id);\n      const availableStock = product.stock - (product.reservedStock || 0);\n\n      // Calculate turnover days\n      const avgDailySales = (salesData?.sales30d || 0) / 30;\n      const turnoverDays = avgDailySales > 0 ? Math.round(availableStock / avgDailySales) : null;\n\n      // Determine stock status\n      let status: 'critical' | 'low' | 'ok' | 'overstock' = 'ok';\n      if (availableStock <= 0) {\n        status = 'critical';\n      } else if (turnoverDays !== null && turnoverDays <= 7) {\n        status = 'critical';\n      } else if (turnoverDays !== null && turnoverDays <= 14) {\n        status = 'low';\n      } else if (turnoverDays !== null && turnoverDays > 90) {\n        status = 'overstock';\n      }\n\n      // Calculate suggested purchase quantity\n      const suggestedPurchase = avgDailySales > 0 \n        ? Math.max(0, Math.ceil(avgDailySales * 30) - availableStock) \n        : 0;\n\n      // Add product detail\n      if (!productsByBrand[brand]) {\n        productsByBrand[brand] = [];\n      }\n      productsByBrand[brand].push({\n        productId: product.id,\n        name: product.name,\n        sku: product.sku,\n        brand,\n        stock: product.stock,\n        sales30d: salesData?.sales30d || 0,\n        sales60d: salesData?.sales60d || 0,\n        sales90d: salesData?.sales90d || 0,\n        revenue30d: salesData?.revenue30d || 0,\n        lastSaleDate: salesData?.lastSaleDate || null,\n        turnoverDays,\n        status,\n        suggestedPurchase,\n      });\n\n      // Update brand summary\n      const brandData = brandMap.get(brand) || {\n        totalProducts: 0,\n        totalStock: 0,\n        lowStockCount: 0,\n        outOfStockCount: 0,\n        totalSales30d: 0,\n        totalRevenue30d: 0,\n        turnoverDays: [],\n      };\n\n      brandData.totalProducts++;\n      brandData.totalStock += product.stock;\n      if (status === 'critical' || status === 'low') brandData.lowStockCount++;\n      if (availableStock <= 0) brandData.outOfStockCount++;\n      brandData.totalSales30d += salesData?.sales30d || 0;\n      brandData.totalRevenue30d += salesData?.revenue30d || 0;\n      if (turnoverDays !== null) brandData.turnoverDays.push(turnoverDays);\n\n      brandMap.set(brand, brandData);\n    }\n\n    // Create brand summaries array\n    const brands: BrandSummary[] = [];\n    let topSellingBrand: string | null = null;\n    let topSellingBrandRevenue = 0;\n\n    for (const [brand, data] of brandMap.entries()) {\n      const avgTurnover = data.turnoverDays.length > 0\n        ? data.turnoverDays.reduce((a, b) => a + b, 0) / data.turnoverDays.length\n        : 0;\n\n      brands.push({\n        brand,\n        totalProducts: data.totalProducts,\n        totalStock: data.totalStock,\n        lowStockCount: data.lowStockCount,\n        outOfStockCount: data.outOfStockCount,\n        totalSales30d: data.totalSales30d,\n        totalRevenue30d: Math.round(data.totalRevenue30d * 100) / 100,\n        avgTurnover: Math.round(avgTurnover),\n      });\n\n      if (data.totalRevenue30d > topSellingBrandRevenue) {\n        topSellingBrandRevenue = data.totalRevenue30d;\n        topSellingBrand = brand;\n      }\n    }\n\n    // Sort brands by revenue\n    brands.sort((a, b) => b.totalRevenue30d - a.totalRevenue30d);\n\n    // Sort products within each brand by sales\n    for (const brand of Object.keys(productsByBrand)) {\n      productsByBrand[brand].sort((a, b) => b.sales30d - a.sales30d);\n    }\n\n    const totalLowStock = brands.reduce((sum, b) => sum + b.lowStockCount, 0);\n    const totalOutOfStock = brands.reduce((sum, b) => sum + b.outOfStockCount, 0);\n\n    return {\n      brands,\n      productsByBrand,\n      overview: {\n        totalBrands: brands.length,\n        totalProducts: allProducts.length,\n        totalLowStock,\n        totalOutOfStock,\n        topSellingBrand,\n        topSellingBrandRevenue: Math.round(topSellingBrandRevenue * 100) / 100,\n      },\n    };\n  }\n\n  async getEmployeeAnalytics(): Promise<EmployeeAnalyticsData> {\n    const now = new Date();\n    const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);\n    const startOfLastMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1);\n    const endOfLastMonth = new Date(now.getFullYear(), now.getMonth(), 0);\n    const startOfQuarter = new Date(now.getFullYear(), Math.floor(now.getMonth() / 3) * 3, 1);\n    const startOfLastQuarter = new Date(now.getFullYear(), Math.floor(now.getMonth() / 3) * 3 - 3, 1);\n    const endOfLastQuarter = new Date(now.getFullYear(), Math.floor(now.getMonth() / 3) * 3, 0);\n\n    const allUsers = await db.select().from(users);\n    const employees = allUsers.filter(u => u.role === 'admin' || u.role === 'sales');\n    \n    const allOrders = await db.select().from(orders).where(eq(orders.status, 'FATURADO'));\n\n    const employeeMetrics: EmployeeMetrics[] = [];\n\n    for (const emp of employees) {\n      // Attribution: orders where employee is listed as invoicedBy OR reservedBy (they processed the order)\n      const empOrders = allOrders.filter(o => o.invoicedBy === emp.id || o.reservedBy === emp.id);\n      \n      // Use invoicedAt for period comparisons (when employee actually processed the order)\n      // Fall back to createdAt if invoicedAt is not available\n      const getOrderDate = (o: typeof allOrders[0]) => o.invoicedAt ? new Date(o.invoicedAt) : new Date(o.createdAt);\n      \n      const ordersThisMonth = empOrders.filter(o => getOrderDate(o) >= startOfMonth);\n      const ordersLastMonth = empOrders.filter(o => {\n        const orderDate = getOrderDate(o);\n        return orderDate >= startOfLastMonth && orderDate <= endOfLastMonth;\n      });\n      const ordersThisQuarter = empOrders.filter(o => getOrderDate(o) >= startOfQuarter);\n      const ordersLastQuarter = empOrders.filter(o => {\n        const orderDate = getOrderDate(o);\n        return orderDate >= startOfLastQuarter && orderDate <= endOfLastQuarter;\n      });\n\n      const totalRevenue = empOrders.reduce((sum, o) => sum + parseFloat(o.total), 0);\n      const revenueThisMonth = ordersThisMonth.reduce((sum, o) => sum + parseFloat(o.total), 0);\n      const revenueThisQuarter = ordersThisQuarter.reduce((sum, o) => sum + parseFloat(o.total), 0);\n      \n      // Sort by invoicedAt for last activity\n      const sortedOrders = [...empOrders].sort((a, b) => \n        getOrderDate(b).getTime() - getOrderDate(a).getTime()\n      );\n\n      employeeMetrics.push({\n        userId: emp.id,\n        name: [emp.firstName, emp.lastName].filter(Boolean).join(' ') || emp.email || 'Funcionario',\n        email: emp.email,\n        role: emp.role,\n        totalOrders: empOrders.length,\n        totalRevenue: Math.round(totalRevenue * 100) / 100,\n        avgTicket: empOrders.length > 0 ? Math.round((totalRevenue / empOrders.length) * 100) / 100 : 0,\n        ordersThisMonth: ordersThisMonth.length,\n        revenueThisMonth: Math.round(revenueThisMonth * 100) / 100,\n        ordersThisQuarter: ordersThisQuarter.length,\n        revenueThisQuarter: Math.round(revenueThisQuarter * 100) / 100,\n        lastActivity: sortedOrders.length > 0 ? getOrderDate(sortedOrders[0]) : null,\n      });\n    }\n\n    employeeMetrics.sort((a, b) => b.revenueThisMonth - a.revenueThisMonth);\n\n    // Use invoicedAt for period comparisons (fallback to createdAt)\n    const getOrderDateGlobal = (o: typeof allOrders[0]) => o.invoicedAt ? new Date(o.invoicedAt) : new Date(o.createdAt);\n    \n    const totalOrdersThisMonth = employeeMetrics.reduce((sum, e) => sum + e.ordersThisMonth, 0);\n    const totalRevenueThisMonth = employeeMetrics.reduce((sum, e) => sum + e.revenueThisMonth, 0);\n    const totalOrdersLastMonth = allOrders.filter(o => {\n      const orderDate = getOrderDateGlobal(o);\n      return orderDate >= startOfLastMonth && orderDate <= endOfLastMonth;\n    }).length;\n    const totalRevenueLastMonth = allOrders.filter(o => {\n      const orderDate = getOrderDateGlobal(o);\n      return orderDate >= startOfLastMonth && orderDate <= endOfLastMonth;\n    }).reduce((sum, o) => sum + parseFloat(o.total), 0);\n    const totalOrdersThisQuarter = employeeMetrics.reduce((sum, e) => sum + e.ordersThisQuarter, 0);\n    const totalRevenueThisQuarter = employeeMetrics.reduce((sum, e) => sum + e.revenueThisQuarter, 0);\n    const totalOrdersLastQuarter = allOrders.filter(o => {\n      const orderDate = getOrderDateGlobal(o);\n      return orderDate >= startOfLastQuarter && orderDate <= endOfLastQuarter;\n    }).length;\n    const totalRevenueLastQuarter = allOrders.filter(o => {\n      const orderDate = getOrderDateGlobal(o);\n      return orderDate >= startOfLastQuarter && orderDate <= endOfLastQuarter;\n    }).reduce((sum, o) => sum + parseFloat(o.total), 0);\n\n    return {\n      employees: employeeMetrics,\n      overview: {\n        totalEmployees: employees.length,\n        totalOrdersThisMonth,\n        totalRevenueThisMonth: Math.round(totalRevenueThisMonth * 100) / 100,\n        avgOrdersPerEmployee: employees.length > 0 ? Math.round((totalOrdersThisMonth / employees.length) * 10) / 10 : 0,\n        topPerformer: employeeMetrics.length > 0 ? employeeMetrics[0].name : null,\n      },\n      periodComparison: {\n        thisMonth: { orders: totalOrdersThisMonth, revenue: Math.round(totalRevenueThisMonth * 100) / 100 },\n        lastMonth: { orders: totalOrdersLastMonth, revenue: Math.round(totalRevenueLastMonth * 100) / 100 },\n        thisQuarter: { orders: totalOrdersThisQuarter, revenue: Math.round(totalRevenueThisQuarter * 100) / 100 },\n        lastQuarter: { orders: totalOrdersLastQuarter, revenue: Math.round(totalRevenueLastQuarter * 100) / 100 },\n      },\n    };\n  }\n\n  // ========== AGENDA EVENTS ==========\n  async getAgendaEvents(filters?: { startDate?: Date; endDate?: Date }): Promise<AgendaEvent[]> {\n    const conditions = [];\n    \n    if (filters?.startDate) {\n      conditions.push(sql`${agendaEvents.date} >= ${filters.startDate}`);\n    }\n    if (filters?.endDate) {\n      conditions.push(sql`${agendaEvents.date} <= ${filters.endDate}`);\n    }\n    \n    if (conditions.length > 0) {\n      return db.select().from(agendaEvents)\n        .where(and(...conditions))\n        .orderBy(agendaEvents.date);\n    }\n    \n    return db.select().from(agendaEvents).orderBy(agendaEvents.date);\n  }\n\n  async getAgendaEvent(id: number): Promise<AgendaEvent | undefined> {\n    const [event] = await db.select().from(agendaEvents).where(eq(agendaEvents.id, id));\n    return event;\n  }\n\n  async createAgendaEvent(event: InsertAgendaEvent): Promise<AgendaEvent> {\n    const [newEvent] = await db.insert(agendaEvents).values(event).returning();\n    return newEvent;\n  }\n\n  async updateAgendaEvent(id: number, event: Partial<InsertAgendaEvent>): Promise<AgendaEvent | undefined> {\n    const [updated] = await db.update(agendaEvents).set(event).where(eq(agendaEvents.id, id)).returning();\n    return updated;\n  }\n\n  async deleteAgendaEvent(id: number): Promise<boolean> {\n    const result = await db.delete(agendaEvents).where(eq(agendaEvents.id, id)).returning();\n    return result.length > 0;\n  }\n\n  // ========== SITE SETTINGS ==========\n  async getSiteSetting(key: string): Promise<SiteSetting | undefined> {\n    const [setting] = await db.select().from(siteSettings).where(eq(siteSettings.key, key));\n    return setting;\n  }\n\n  async setSiteSetting(key: string, value: string): Promise<SiteSetting> {\n    const existing = await this.getSiteSetting(key);\n    if (existing) {\n      const [updated] = await db.update(siteSettings)\n        .set({ value, updatedAt: new Date() })\n        .where(eq(siteSettings.key, key))\n        .returning();\n      return updated;\n    } else {\n      const [created] = await db.insert(siteSettings)\n        .values({ key, value })\n        .returning();\n      return created;\n    }\n  }\n\n  // ========== CATALOG BANNERS ==========\n  async getCatalogBanners(position?: string): Promise<CatalogBanner[]> {\n    if (position) {\n      return db.select().from(catalogBanners)\n        .where(eq(catalogBanners.position, position))\n        .orderBy(catalogBanners.order);\n    }\n    return db.select().from(catalogBanners).orderBy(catalogBanners.order);\n  }\n\n  async getCatalogBanner(id: number): Promise<CatalogBanner | undefined> {\n    const [banner] = await db.select().from(catalogBanners).where(eq(catalogBanners.id, id));\n    return banner;\n  }\n\n  async createCatalogBanner(banner: InsertCatalogBanner): Promise<CatalogBanner> {\n    const [newBanner] = await db.insert(catalogBanners).values(banner).returning();\n    return newBanner;\n  }\n\n  async updateCatalogBanner(id: number, banner: Partial<InsertCatalogBanner>): Promise<CatalogBanner | undefined> {\n    const [updated] = await db.update(catalogBanners)\n      .set({ ...banner, updatedAt: new Date() })\n      .where(eq(catalogBanners.id, id))\n      .returning();\n    return updated;\n  }\n\n  async deleteCatalogBanner(id: number): Promise<boolean> {\n    const result = await db.delete(catalogBanners).where(eq(catalogBanners.id, id)).returning();\n    return result.length > 0;\n  }\n\n  // ========== CATALOG SLIDES ==========\n  async getCatalogSlides(): Promise<CatalogSlide[]> {\n    return db.select().from(catalogSlides).orderBy(catalogSlides.order);\n  }\n\n  async getCatalogSlide(id: number): Promise<CatalogSlide | undefined> {\n    const [slide] = await db.select().from(catalogSlides).where(eq(catalogSlides.id, id));\n    return slide;\n  }\n\n  async createCatalogSlide(slide: InsertCatalogSlide): Promise<CatalogSlide> {\n    const [newSlide] = await db.insert(catalogSlides).values(slide).returning();\n    return newSlide;\n  }\n\n  async updateCatalogSlide(id: number, slide: Partial<InsertCatalogSlide>): Promise<CatalogSlide | undefined> {\n    const [updated] = await db.update(catalogSlides)\n      .set(slide)\n      .where(eq(catalogSlides.id, id))\n      .returning();\n    return updated;\n  }\n\n  async deleteCatalogSlide(id: number): Promise<boolean> {\n    const result = await db.delete(catalogSlides).where(eq(catalogSlides.id, id)).returning();\n    return result.length > 0;\n  }\n\n  // ========== CATALOG CONFIG ==========\n  async getCatalogConfig(key: string): Promise<CatalogConfig | undefined> {\n    const [config] = await db.select().from(catalogConfig).where(eq(catalogConfig.key, key));\n    return config;\n  }\n\n  async setCatalogConfig(key: string, value: string): Promise<CatalogConfig> {\n    const existing = await this.getCatalogConfig(key);\n    if (existing) {\n      const [updated] = await db.update(catalogConfig)\n        .set({ value, updatedAt: new Date() })\n        .where(eq(catalogConfig.key, key))\n        .returning();\n      return updated;\n    } else {\n      const [created] = await db.insert(catalogConfig)\n        .values({ key, value })\n        .returning();\n      return created;\n    }\n  }\n\n  // ========== CUSTOMER CREDITS (FIADO) ==========\n  async getCustomerCredits(userId: string): Promise<CustomerCredit[]> {\n    return db.select().from(customerCredits)\n      .where(eq(customerCredits.userId, userId))\n      .orderBy(desc(customerCredits.createdAt));\n  }\n\n  async getAllCredits(): Promise<CustomerCredit[]> {\n    return db.select().from(customerCredits)\n      .orderBy(desc(customerCredits.createdAt));\n  }\n\n  async getCustomerCredit(id: number): Promise<CustomerCredit | undefined> {\n    const [credit] = await db.select().from(customerCredits).where(eq(customerCredits.id, id));\n    return credit;\n  }\n\n  async createCustomerCredit(credit: InsertCustomerCredit): Promise<CustomerCredit> {\n    const [newCredit] = await db.insert(customerCredits).values(credit).returning();\n    return newCredit;\n  }\n\n  async updateCustomerCredit(id: number, credit: Partial<InsertCustomerCredit>): Promise<CustomerCredit | undefined> {\n    const [updated] = await db.update(customerCredits)\n      .set({ ...credit, updatedAt: new Date() })\n      .where(eq(customerCredits.id, id))\n      .returning();\n    return updated;\n  }\n\n  async deleteCustomerCredit(id: number): Promise<boolean> {\n    await db.delete(creditPayments).where(eq(creditPayments.creditId, id));\n    const result = await db.delete(customerCredits).where(eq(customerCredits.id, id)).returning();\n    return result.length > 0;\n  }\n\n  async getCustomerCreditBalance(userId: string): Promise<{ total: number; pending: number; paid: number }> {\n    const credits = await this.getCustomerCredits(userId);\n    \n    let total = 0;\n    let paid = 0;\n    \n    for (const credit of credits) {\n      if (credit.type === 'DEBITO' && credit.status !== 'CANCELADO') {\n        total += parseFloat(credit.amount);\n        paid += parseFloat(credit.paidAmount);\n      }\n    }\n    \n    return {\n      total,\n      pending: total - paid,\n      paid\n    };\n  }\n\n  async getCreditsDashboard(): Promise<CreditsDashboardData> {\n    const allCredits = await db.select({\n      credit: customerCredits,\n      user: {\n        id: users.id,\n        firstName: users.firstName,\n        lastName: users.lastName,\n        company: users.company,\n      }\n    })\n    .from(customerCredits)\n    .leftJoin(users, eq(customerCredits.userId, users.id))\n    .orderBy(desc(customerCredits.createdAt));\n\n    const now = new Date();\n    let totalInCirculation = 0;\n    let totalPending = 0;\n    let totalPaid = 0;\n    let totalOverdue = 0;\n    const customerDebts: Map<string, CustomerCreditSummary> = new Map();\n    const upcomingPayments: UpcomingPayment[] = [];\n    const overduePayments: UpcomingPayment[] = [];\n\n    for (const { credit, user } of allCredits) {\n      if (credit.type !== 'DEBITO' || credit.status === 'CANCELADO') continue;\n\n      const amount = parseFloat(credit.amount);\n      const paidAmount = parseFloat(credit.paidAmount);\n      const pendingAmount = amount - paidAmount;\n      const userName = `${user?.firstName || ''} ${user?.lastName || ''}`.trim() || 'Cliente';\n\n      totalInCirculation += amount;\n      totalPaid += paidAmount;\n\n      if (credit.status === 'PAGO') {\n        // Already fully paid\n      } else if (credit.dueDate && new Date(credit.dueDate) < now) {\n        totalOverdue += pendingAmount;\n        overduePayments.push({\n          creditId: credit.id,\n          userId: credit.userId,\n          userName,\n          company: user?.company || null,\n          amount,\n          pendingAmount,\n          dueDate: new Date(credit.dueDate),\n          daysUntilDue: Math.floor((new Date(credit.dueDate).getTime() - now.getTime()) / (1000 * 60 * 60 * 24)),\n          status: 'VENCIDO'\n        });\n      } else {\n        totalPending += pendingAmount;\n        if (credit.dueDate) {\n          upcomingPayments.push({\n            creditId: credit.id,\n            userId: credit.userId,\n            userName,\n            company: user?.company || null,\n            amount,\n            pendingAmount,\n            dueDate: new Date(credit.dueDate),\n            daysUntilDue: Math.floor((new Date(credit.dueDate).getTime() - now.getTime()) / (1000 * 60 * 60 * 24)),\n            status: credit.status\n          });\n        }\n      }\n\n      // Customer summary\n      const existing = customerDebts.get(credit.userId);\n      if (existing) {\n        existing.totalDebt += amount;\n        existing.paidAmount += paidAmount;\n        existing.pendingAmount += pendingAmount;\n        existing.creditCount += 1;\n        if (credit.dueDate && new Date(credit.dueDate) < now) {\n          existing.overdueAmount += pendingAmount;\n        }\n        if (credit.dueDate && (!existing.nextDueDate || new Date(credit.dueDate) < existing.nextDueDate)) {\n          if (credit.status !== 'PAGO') {\n            existing.nextDueDate = new Date(credit.dueDate);\n          }\n        }\n      } else {\n        customerDebts.set(credit.userId, {\n          userId: credit.userId,\n          userName,\n          company: user?.company || null,\n          totalDebt: amount,\n          paidAmount,\n          pendingAmount,\n          overdueAmount: credit.dueDate && new Date(credit.dueDate) < now ? pendingAmount : 0,\n          nextDueDate: credit.dueDate && credit.status !== 'PAGO' ? new Date(credit.dueDate) : null,\n          creditCount: 1\n        });\n      }\n    }\n\n    // Get recent payments\n    const recentPaymentsResult = await db.select({\n      payment: creditPayments,\n      credit: customerCredits,\n      user: {\n        id: users.id,\n        firstName: users.firstName,\n        lastName: users.lastName,\n      }\n    })\n    .from(creditPayments)\n    .leftJoin(customerCredits, eq(creditPayments.creditId, customerCredits.id))\n    .leftJoin(users, eq(customerCredits.userId, users.id))\n    .orderBy(desc(creditPayments.createdAt))\n    .limit(10);\n\n    const recentPayments = recentPaymentsResult.map(({ payment, credit, user }) => ({\n      paymentId: payment.id,\n      creditId: payment.creditId,\n      userId: credit?.userId || '',\n      userName: `${user?.firstName || ''} ${user?.lastName || ''}`.trim() || 'Cliente',\n      amount: parseFloat(payment.amount),\n      paymentMethod: payment.paymentMethod,\n      createdAt: payment.createdAt\n    }));\n\n    const customersWithDebt = Array.from(customerDebts.values()).filter(c => c.pendingAmount > 0).length;\n\n    return {\n      overview: {\n        totalInCirculation,\n        totalPending,\n        totalPaid,\n        totalOverdue,\n        customersWithDebt,\n        averageDebtPerCustomer: customersWithDebt > 0 ? totalPending / customersWithDebt : 0\n      },\n      customerSummaries: Array.from(customerDebts.values()).sort((a, b) => b.pendingAmount - a.pendingAmount),\n      upcomingPayments: upcomingPayments.sort((a, b) => a.daysUntilDue - b.daysUntilDue).slice(0, 20),\n      overduePayments: overduePayments.sort((a, b) => a.daysUntilDue - b.daysUntilDue),\n      recentPayments\n    };\n  }\n\n  // ========== CREDIT PAYMENTS ==========\n  async getCreditPayments(creditId: number): Promise<CreditPayment[]> {\n    return db.select().from(creditPayments)\n      .where(eq(creditPayments.creditId, creditId))\n      .orderBy(desc(creditPayments.createdAt));\n  }\n\n  async createCreditPayment(payment: InsertCreditPayment): Promise<CreditPayment> {\n    const [newPayment] = await db.insert(creditPayments).values(payment).returning();\n    \n    // Update credit's paid amount\n    const credit = await this.getCustomerCredit(payment.creditId);\n    if (credit) {\n      const newPaidAmount = parseFloat(credit.paidAmount) + parseFloat(payment.amount);\n      const totalAmount = parseFloat(credit.amount);\n      \n      let newStatus = credit.status;\n      if (newPaidAmount >= totalAmount) {\n        newStatus = 'PAGO';\n      } else if (newPaidAmount > 0) {\n        newStatus = 'PARCIAL';\n      }\n      \n      await this.updateCustomerCredit(payment.creditId, {\n        paidAmount: newPaidAmount.toFixed(2),\n        status: newStatus,\n        paidAt: newStatus === 'PAGO' ? new Date() : undefined\n      });\n    }\n    \n    return newPayment;\n  }\n\n  // ========== ACCOUNTS PAYABLE ==========\n  async getAccountsPayable(): Promise<AccountPayable[]> {\n    return db.select().from(accountsPayable).orderBy(desc(accountsPayable.createdAt));\n  }\n\n  async getAccountPayable(id: number): Promise<AccountPayable | undefined> {\n    const [payable] = await db.select().from(accountsPayable).where(eq(accountsPayable.id, id));\n    return payable;\n  }\n\n  async createAccountPayable(payable: InsertAccountPayable): Promise<AccountPayable> {\n    const [newPayable] = await db.insert(accountsPayable).values(payable).returning();\n    return newPayable;\n  }\n\n  async updateAccountPayable(id: number, updates: Partial<AccountPayable>): Promise<AccountPayable | undefined> {\n    const [updated] = await db.update(accountsPayable)\n      .set({ ...updates, updatedAt: new Date() })\n      .where(eq(accountsPayable.id, id))\n      .returning();\n    return updated;\n  }\n\n  async deleteAccountPayable(id: number): Promise<void> {\n    await db.delete(accountsPayable).where(eq(accountsPayable.id, id));\n  }\n\n  async getPayablesDashboard(): Promise<any> {\n    const allPayables = await db.select().from(accountsPayable);\n    \n    const now = new Date();\n    let totalPayables = 0;\n    let totalPending = 0;\n    let totalPaid = 0;\n    let totalOverdue = 0;\n    let pendingCount = 0;\n    \n    const upcomingPayables: any[] = [];\n    const overduePayables: any[] = [];\n    const categoryTotals = new Map<string, { total: number; pending: number; count: number }>();\n    \n    for (const payable of allPayables) {\n      const amount = parseFloat(payable.amount);\n      const paidAmount = parseFloat(payable.paidAmount);\n      const pending = amount - paidAmount;\n      \n      totalPayables += amount;\n      totalPaid += paidAmount;\n      \n      if (payable.status !== 'PAGO' && payable.status !== 'CANCELADO') {\n        totalPending += pending;\n        pendingCount++;\n        \n        const category = payable.category || 'Outros';\n        const catData = categoryTotals.get(category) || { total: 0, pending: 0, count: 0 };\n        catData.total += amount;\n        catData.pending += pending;\n        catData.count++;\n        categoryTotals.set(category, catData);\n        \n        if (payable.dueDate) {\n          const dueDate = new Date(payable.dueDate);\n          const daysUntilDue = Math.ceil((dueDate.getTime() - now.getTime()) / (1000 * 60 * 60 * 24));\n          \n          const payableInfo = {\n            id: payable.id,\n            supplierName: payable.supplierName,\n            category: payable.category,\n            description: payable.description,\n            amount,\n            pendingAmount: pending,\n            dueDate,\n            daysUntilDue,\n            status: payable.status\n          };\n          \n          if (daysUntilDue < 0) {\n            totalOverdue += pending;\n            overduePayables.push(payableInfo);\n          } else if (daysUntilDue <= 30) {\n            upcomingPayables.push(payableInfo);\n          }\n        }\n      }\n    }\n    \n    return {\n      overview: {\n        totalPayables,\n        totalPending,\n        totalPaid,\n        totalOverdue,\n        payablesCount: pendingCount\n      },\n      upcomingPayables: upcomingPayables.sort((a, b) => a.daysUntilDue - b.daysUntilDue),\n      overduePayables: overduePayables.sort((a, b) => a.daysUntilDue - b.daysUntilDue),\n      recentPayments: [],\n      byCategory: Array.from(categoryTotals.entries()).map(([category, data]) => ({\n        category,\n        ...data\n      })).sort((a, b) => b.pending - a.pending)\n    };\n  }\n\n  // ========== PAYABLE PAYMENTS ==========\n  async getPayablePayments(payableId: number): Promise<PayablePayment[]> {\n    return db.select().from(payablePayments)\n      .where(eq(payablePayments.payableId, payableId))\n      .orderBy(desc(payablePayments.createdAt));\n  }\n\n  async createPayablePayment(payment: InsertPayablePayment): Promise<PayablePayment> {\n    const [newPayment] = await db.insert(payablePayments).values(payment).returning();\n    \n    // Update payable's paid amount\n    const payable = await this.getAccountPayable(payment.payableId);\n    if (payable) {\n      const newPaidAmount = parseFloat(payable.paidAmount) + parseFloat(payment.amount);\n      const totalAmount = parseFloat(payable.amount);\n      \n      let newStatus = payable.status;\n      if (newPaidAmount >= totalAmount) {\n        newStatus = 'PAGO';\n      }\n      \n      await this.updateAccountPayable(payment.payableId, {\n        paidAmount: newPaidAmount.toFixed(2),\n        status: newStatus,\n        paidAt: newStatus === 'PAGO' ? new Date() : undefined\n      });\n    }\n    \n    return newPayment;\n  }\n\n  // ========== MODULES (PERMISSION SYSTEM) ==========\n  async getModules(): Promise<Module[]> {\n    return db.select().from(modules).orderBy(modules.sortOrder);\n  }\n\n  async getModule(key: string): Promise<Module | undefined> {\n    const [module] = await db.select().from(modules).where(eq(modules.key, key));\n    return module;\n  }\n\n  async createModule(module: InsertModule): Promise<Module> {\n    const [newModule] = await db.insert(modules).values(module).returning();\n    return newModule;\n  }\n\n  // ========== USER MODULE PERMISSIONS ==========\n  async getUserPermissions(userId: string): Promise<UserModulePermission[]> {\n    return db.select().from(userModulePermissions)\n      .where(eq(userModulePermissions.userId, userId));\n  }\n\n  async getUserPermissionKeys(userId: string): Promise<string[]> {\n    const permissions = await db.select().from(userModulePermissions)\n      .where(and(\n        eq(userModulePermissions.userId, userId),\n        eq(userModulePermissions.allowed, true)\n      ));\n    return permissions.map(p => p.moduleKey);\n  }\n\n  async setUserPermissions(userId: string, moduleKeys: string[]): Promise<void> {\n    // Delete existing permissions\n    await db.delete(userModulePermissions)\n      .where(eq(userModulePermissions.userId, userId));\n    \n    // Insert new permissions\n    if (moduleKeys.length > 0) {\n      await db.insert(userModulePermissions).values(\n        moduleKeys.map(key => ({\n          userId,\n          moduleKey: key,\n          allowed: true\n        }))\n      );\n    }\n  }\n\n  async hasModuleAccess(userId: string, moduleKey: string): Promise<boolean> {\n    // First check if user is admin - admins have access to everything\n    const user = await this.getUser(userId);\n    if (user?.role === 'admin') return true;\n    \n    // Check explicit permissions\n    const [permission] = await db.select().from(userModulePermissions)\n      .where(and(\n        eq(userModulePermissions.userId, userId),\n        eq(userModulePermissions.moduleKey, moduleKey),\n        eq(userModulePermissions.allowed, true)\n      ));\n    \n    return !!permission;\n  }\n\n  // ========== PAYMENT TYPES ==========\n  async getPaymentTypes(): Promise<PaymentType[]> {\n    return db.select().from(paymentTypes).orderBy(paymentTypes.sortOrder);\n  }\n\n  async getPaymentType(id: number): Promise<PaymentType | undefined> {\n    const [paymentType] = await db.select().from(paymentTypes).where(eq(paymentTypes.id, id));\n    return paymentType;\n  }\n\n  async createPaymentType(paymentType: InsertPaymentType): Promise<PaymentType> {\n    const [newPaymentType] = await db.insert(paymentTypes).values(paymentType).returning();\n    return newPaymentType;\n  }\n\n  async updatePaymentType(id: number, paymentType: Partial<InsertPaymentType>): Promise<PaymentType | undefined> {\n    const [updated] = await db.update(paymentTypes)\n      .set({ ...paymentType, updatedAt: new Date() })\n      .where(eq(paymentTypes.id, id))\n      .returning();\n    return updated;\n  }\n\n  async deletePaymentType(id: number): Promise<boolean> {\n    const result = await db.delete(paymentTypes).where(eq(paymentTypes.id, id));\n    return true;\n  }\n\n  // ========== PAYMENT INTEGRATIONS ==========\n  async getPaymentIntegrations(): Promise<PaymentIntegration[]> {\n    return db.select().from(paymentIntegrations);\n  }\n\n  async getPaymentIntegration(id: number): Promise<PaymentIntegration | undefined> {\n    const [integration] = await db.select().from(paymentIntegrations).where(eq(paymentIntegrations.id, id));\n    return integration;\n  }\n\n  async createPaymentIntegration(integration: InsertPaymentIntegration): Promise<PaymentIntegration> {\n    const [newIntegration] = await db.insert(paymentIntegrations).values(integration).returning();\n    return newIntegration;\n  }\n\n  async updatePaymentIntegration(id: number, integration: Partial<InsertPaymentIntegration>): Promise<PaymentIntegration | undefined> {\n    const [updated] = await db.update(paymentIntegrations)\n      .set({ ...integration, updatedAt: new Date() })\n      .where(eq(paymentIntegrations.id, id))\n      .returning();\n    return updated;\n  }\n\n  async deletePaymentIntegration(id: number): Promise<boolean> {\n    const result = await db.delete(paymentIntegrations).where(eq(paymentIntegrations.id, id));\n    return true;\n  }\n}\n\nexport const storage = new DatabaseStorage();\n","path":null,"size_bytes":121246,"size_tokens":null},"client/src/pages/users.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { UserCard, type UserData, type UserRole, type CustomerType } from \"@/components/UserCard\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { Search, RefreshCw, Loader2, Plus, Settings, Shield, Tag, Instagram, StickyNote } from \"lucide-react\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\nimport type { User, Module } from \"@shared/schema\";\nimport { Checkbox } from \"@/components/ui/checkbox\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogHeader,\n  DialogTitle,\n  DialogTrigger,\n} from \"@/components/ui/dialog\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport { Label } from \"@/components/ui/label\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Textarea } from \"@/components/ui/textarea\";\n\ntype UserStatus = \"pending\" | \"approved\" | \"rejected\";\n\nexport default function UsersPage() {\n  const { toast } = useToast();\n  const [searchQuery, setSearchQuery] = useState(\"\");\n  const [activeTab, setActiveTab] = useState(\"all\");\n  const [isCreateOpen, setIsCreateOpen] = useState(false);\n  const [isPermissionsOpen, setIsPermissionsOpen] = useState(false);\n  const [isExtrasOpen, setIsExtrasOpen] = useState(false);\n  const [selectedUser, setSelectedUser] = useState<UserData | null>(null);\n  const [extrasTag, setExtrasTag] = useState(\"\");\n  const [extrasInstagram, setExtrasInstagram] = useState(\"\");\n  const [extrasNotes, setExtrasNotes] = useState(\"\");\n  const [newUserName, setNewUserName] = useState(\"\");\n  const [newUserEmail, setNewUserEmail] = useState(\"\");\n  const [newUserPassword, setNewUserPassword] = useState(\"\");\n  const [newUserRole, setNewUserRole] = useState<UserRole>(\"customer\");\n  const [selectedModules, setSelectedModules] = useState<string[]>([]);\n  const [selectedBrands, setSelectedBrands] = useState<string[]>([]);\n\n  const { data: usersData = [], isLoading, refetch } = useQuery<User[]>({\n    queryKey: ['/api/users'],\n  });\n\n  const { data: modulesData = [], isLoading: modulesLoading } = useQuery<Module[]>({\n    queryKey: ['/api/modules'],\n  });\n\n  const { data: brandsData = [] } = useQuery<string[]>({\n    queryKey: ['/api/admin/all-brands'],\n  });\n\n  const { data: userPermissions } = useQuery<{ userId: string; modules: string[] }>({\n    queryKey: ['/api/users', selectedUser?.id, 'permissions'],\n    queryFn: async () => {\n      if (!selectedUser?.id) return { userId: '', modules: [] };\n      const res = await fetch(`/api/users/${selectedUser.id}/permissions`, { credentials: 'include' });\n      if (!res.ok) throw new Error('Failed to fetch permissions');\n      return res.json();\n    },\n    enabled: !!selectedUser?.id && isPermissionsOpen,\n  });\n\n  useEffect(() => {\n    if (userPermissions?.modules) {\n      setSelectedModules(userPermissions.modules);\n    }\n  }, [userPermissions]);\n\n\n  const getDefaultModulesForRole = (role: UserRole): string[] => {\n    const roleDefaults: Record<string, string[]> = {\n      admin: modulesData.map(m => m.key),\n      sales: modulesData.filter(m => m.defaultRoles?.includes('sales')).map(m => m.key),\n      customer: modulesData.filter(m => m.defaultRoles?.includes('customer')).map(m => m.key),\n    };\n    return roleDefaults[role] || [];\n  };\n\n  useEffect(() => {\n    if (isCreateOpen && modulesData.length > 0) {\n      setSelectedModules(getDefaultModulesForRole(newUserRole));\n    }\n  }, [newUserRole, isCreateOpen, modulesData]);\n\n  const createUserMutation = useMutation({\n    mutationFn: async (data: { firstName: string; email: string; password: string; role: string; allowedBrands?: string[] }) => {\n      const response = await apiRequest(\"POST\", \"/api/users\", data);\n      return response.json();\n    },\n    onSuccess: async (newUser) => {\n      if (selectedModules.length > 0 && newUser?.id) {\n        await apiRequest(\"POST\", `/api/users/${newUser.id}/permissions`, { modules: selectedModules });\n      }\n      queryClient.invalidateQueries({ queryKey: ['/api/users'] });\n      setIsCreateOpen(false);\n      setNewUserName(\"\");\n      setNewUserEmail(\"\");\n      setNewUserPassword(\"\");\n      setNewUserRole(\"customer\");\n      setSelectedModules([]);\n      setSelectedBrands([]);\n      toast({ title: \"Sucesso\", description: \"Usuario criado com sucesso\" });\n    },\n    onError: (err: Error) => {\n      toast({ title: \"Erro\", description: err.message || \"Falha ao criar usuario\", variant: \"destructive\" });\n    },\n  });\n\n  const updatePermissionsMutation = useMutation({\n    mutationFn: async ({ userId, modules }: { userId: string; modules: string[] }) => {\n      await apiRequest(\"POST\", `/api/users/${userId}/permissions`, { modules });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/users', selectedUser?.id, 'permissions'] });\n      toast({ title: \"Sucesso\", description: \"Permissoes atualizadas com sucesso\" });\n      setIsPermissionsOpen(false);\n      setSelectedUser(null);\n    },\n    onError: (err: Error) => {\n      toast({ title: \"Erro\", description: err.message || \"Falha ao atualizar permissoes\", variant: \"destructive\" });\n    },\n  });\n\n  const isValidEmail = (email: string): boolean => {\n    const emailRegex = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/;\n    return emailRegex.test(email);\n  };\n\n  const handleCreateUser = () => {\n    if (!newUserName || !newUserEmail || !newUserPassword) {\n      toast({ title: \"Erro\", description: \"Preencha todos os campos\", variant: \"destructive\" });\n      return;\n    }\n    if (!isValidEmail(newUserEmail)) {\n      toast({ title: \"Erro\", description: \"Digite um email valido (ex: usuario@empresa.com)\", variant: \"destructive\" });\n      return;\n    }\n    createUserMutation.mutate({\n      firstName: newUserName,\n      email: newUserEmail,\n      password: newUserPassword,\n      role: newUserRole,\n      allowedBrands: newUserRole === \"supplier\" ? selectedBrands : undefined,\n    });\n  };\n\n  const handleSavePermissions = () => {\n    if (selectedUser) {\n      updatePermissionsMutation.mutate({ userId: selectedUser.id, modules: selectedModules });\n    }\n  };\n\n  const handleOpenPermissions = (user: UserData) => {\n    setSelectedUser(user);\n    setSelectedModules([]);\n    setIsPermissionsOpen(true);\n  };\n\n  const toggleModule = (moduleKey: string) => {\n    setSelectedModules(prev => \n      prev.includes(moduleKey) \n        ? prev.filter(k => k !== moduleKey)\n        : [...prev, moduleKey]\n    );\n  };\n\n  const users: UserData[] = usersData.map((u) => ({\n    id: u.id,\n    name: `${u.firstName || \"\"} ${u.lastName || \"\"}`.trim() || u.email || \"Unknown\",\n    email: u.email || \"\",\n    company: u.company || undefined,\n    role: u.role as UserRole,\n    customerType: (u.customerType || \"varejo\") as CustomerType,\n    status: u.approved ? \"approved\" : \"pending\" as UserStatus,\n    tag: u.tag || undefined,\n    instagram: u.instagram || undefined,\n    notes: u.notes || undefined,\n  }));\n\n  const filteredUsers = users.filter((user) => {\n    const matchesSearch =\n      user.name.toLowerCase().includes(searchQuery.toLowerCase()) ||\n      user.email.toLowerCase().includes(searchQuery.toLowerCase()) ||\n      user.company?.toLowerCase().includes(searchQuery.toLowerCase());\n    \n    if (activeTab === \"all\") return matchesSearch;\n    if (activeTab === \"pending\") return matchesSearch && user.status === \"pending\";\n    if (activeTab === \"customers\") return matchesSearch && user.role === \"customer\";\n    if (activeTab === \"staff\") return matchesSearch && (user.role === \"admin\" || user.role === \"sales\");\n    return matchesSearch;\n  });\n\n  const updateUserMutation = useMutation({\n    mutationFn: async ({ id, data }: { id: string; data: Partial<User> }) => {\n      await apiRequest(\"PATCH\", `/api/users/${id}`, data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/users'] });\n    },\n  });\n\n  const handleApprove = (user: UserData) => {\n    updateUserMutation.mutate(\n      { id: user.id, data: { approved: true } },\n      {\n        onSuccess: () => {\n          toast({ title: \"Usuario Aprovado\", description: `${user.name} foi aprovado.` });\n        },\n        onError: () => {\n          toast({ title: \"Erro\", description: \"Falha ao aprovar usuario\", variant: \"destructive\" });\n        },\n      }\n    );\n  };\n\n  const handleReject = (user: UserData) => {\n    updateUserMutation.mutate(\n      { id: user.id, data: { approved: false } },\n      {\n        onSuccess: () => {\n          toast({ title: \"Usuario Rejeitado\", description: `${user.name} foi rejeitado.` });\n        },\n        onError: () => {\n          toast({ title: \"Erro\", description: \"Falha ao rejeitar usuario\", variant: \"destructive\" });\n        },\n      }\n    );\n  };\n\n  const handleChangeRole = (user: UserData, role: UserRole) => {\n    updateUserMutation.mutate(\n      { id: user.id, data: { role } },\n      {\n        onSuccess: () => {\n          toast({ title: \"Funcao Atualizada\", description: `${user.name} agora e ${role}.` });\n        },\n        onError: () => {\n          toast({ title: \"Erro\", description: \"Falha ao atualizar funcao\", variant: \"destructive\" });\n        },\n      }\n    );\n  };\n\n  const handleChangeCustomerType = (user: UserData, customerType: CustomerType) => {\n    updateUserMutation.mutate(\n      { id: user.id, data: { customerType } },\n      {\n        onSuccess: () => {\n          toast({ title: \"Tipo Atualizado\", description: `${user.name} agora e ${customerType === \"atacado\" ? \"Atacado\" : \"Varejo\"}.` });\n        },\n        onError: () => {\n          toast({ title: \"Erro\", description: \"Falha ao atualizar tipo de cliente\", variant: \"destructive\" });\n        },\n      }\n    );\n  };\n\n  const handleOpenExtras = (user: UserData) => {\n    setSelectedUser(user);\n    setExtrasTag(user.tag || \"\");\n    setExtrasInstagram(user.instagram || \"\");\n    setExtrasNotes(user.notes || \"\");\n    setIsExtrasOpen(true);\n  };\n\n  const handleSaveExtras = () => {\n    if (selectedUser) {\n      updateUserMutation.mutate(\n        { \n          id: selectedUser.id, \n          data: { \n            tag: extrasTag || null, \n            instagram: extrasInstagram || null, \n            notes: extrasNotes || null \n          } \n        },\n        {\n          onSuccess: () => {\n            toast({ title: \"Extras Salvos\", description: \"Informacoes extras atualizadas com sucesso.\" });\n            setIsExtrasOpen(false);\n            setSelectedUser(null);\n          },\n          onError: () => {\n            toast({ title: \"Erro\", description: \"Falha ao salvar extras\", variant: \"destructive\" });\n          },\n        }\n      );\n    }\n  };\n\n  const pendingCount = users.filter((u) => u.status === \"pending\").length;\n\n  return (\n    <div className=\"p-6 lg:p-8 space-y-6\">\n      <div className=\"flex items-center justify-between gap-4 flex-wrap\">\n        <div>\n          <h1 className=\"text-3xl font-semibold\">Gerenciamento de Usuarios</h1>\n          <p className=\"text-muted-foreground mt-1\">Gerencie contas de clientes e membros da equipe</p>\n        </div>\n        <div className=\"flex gap-2\">\n          <Dialog open={isCreateOpen} onOpenChange={setIsCreateOpen}>\n            <DialogTrigger asChild>\n              <Button data-testid=\"button-create-user\">\n                <Plus className=\"h-4 w-4 mr-2\" />\n                Cadastrar Usuario\n              </Button>\n            </DialogTrigger>\n            <DialogContent className=\"max-w-2xl max-h-[90vh] overflow-y-auto\">\n              <DialogHeader>\n                <DialogTitle>Cadastrar Novo Usuario</DialogTitle>\n                <DialogDescription>\n                  Preencha os dados e selecione os modulos que o usuario pode acessar\n                </DialogDescription>\n              </DialogHeader>\n              <div className=\"space-y-4 py-4\">\n                <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                  <div className=\"space-y-2\">\n                    <Label htmlFor=\"name\">Nome *</Label>\n                    <Input\n                      id=\"name\"\n                      value={newUserName}\n                      onChange={(e) => setNewUserName(e.target.value)}\n                      placeholder=\"Nome do usuario\"\n                      data-testid=\"input-create-name\"\n                    />\n                  </div>\n                  <div className=\"space-y-2\">\n                    <Label htmlFor=\"email\">E-mail *</Label>\n                    <Input\n                      id=\"email\"\n                      type=\"email\"\n                      value={newUserEmail}\n                      onChange={(e) => setNewUserEmail(e.target.value)}\n                      placeholder=\"email@exemplo.com\"\n                      data-testid=\"input-create-email\"\n                    />\n                  </div>\n                  <div className=\"space-y-2\">\n                    <Label htmlFor=\"password\">Senha *</Label>\n                    <Input\n                      id=\"password\"\n                      type=\"password\"\n                      value={newUserPassword}\n                      onChange={(e) => setNewUserPassword(e.target.value)}\n                      placeholder=\"Senha de acesso\"\n                      data-testid=\"input-create-password\"\n                    />\n                  </div>\n                  <div className=\"space-y-2\">\n                    <Label htmlFor=\"role\">Funcao</Label>\n                    <Select value={newUserRole} onValueChange={(v) => setNewUserRole(v as UserRole)}>\n                      <SelectTrigger data-testid=\"select-create-role\">\n                        <SelectValue />\n                      </SelectTrigger>\n                      <SelectContent>\n                        <SelectItem value=\"customer\">Cliente</SelectItem>\n                        <SelectItem value=\"sales\">Vendedor</SelectItem>\n                        <SelectItem value=\"supplier\">Fornecedor</SelectItem>\n                        <SelectItem value=\"admin\">Administrador</SelectItem>\n                      </SelectContent>\n                    </Select>\n                  </div>\n                </div>\n\n                {newUserRole === \"supplier\" && (\n                  <div className=\"space-y-3\">\n                    <div className=\"flex items-center gap-2\">\n                      <Tag className=\"h-4 w-4 text-primary\" />\n                      <Label className=\"text-base font-medium\">Marcas Permitidas</Label>\n                    </div>\n                    <p className=\"text-sm text-muted-foreground\">\n                      Selecione quais marcas este fornecedor pode visualizar\n                    </p>\n                    {brandsData.length === 0 ? (\n                      <p className=\"text-sm text-muted-foreground py-2\">Nenhuma marca cadastrada.</p>\n                    ) : (\n                      <div className=\"grid grid-cols-2 md:grid-cols-3 gap-2 max-h-48 overflow-y-auto\">\n                        {brandsData.map((brand) => (\n                          <div\n                            key={brand}\n                            className=\"flex items-center space-x-2 p-2 rounded-lg border bg-muted/30 hover-elevate cursor-pointer\"\n                            onClick={() => {\n                              setSelectedBrands(prev => \n                                prev.includes(brand) \n                                  ? prev.filter(b => b !== brand) \n                                  : [...prev, brand]\n                              );\n                            }}\n                            data-testid={`checkbox-brand-${brand}`}\n                          >\n                            <Checkbox\n                              checked={selectedBrands.includes(brand)}\n                              onCheckedChange={() => {\n                                setSelectedBrands(prev => \n                                  prev.includes(brand) \n                                    ? prev.filter(b => b !== brand) \n                                    : [...prev, brand]\n                                );\n                              }}\n                            />\n                            <span className=\"text-sm\">{brand}</span>\n                          </div>\n                        ))}\n                      </div>\n                    )}\n                  </div>\n                )}\n\n                <div className=\"space-y-3\">\n                  <div className=\"flex items-center gap-2\">\n                    <Shield className=\"h-4 w-4 text-primary\" />\n                    <Label className=\"text-base font-medium\">Permissoes de Modulos</Label>\n                  </div>\n                  <p className=\"text-sm text-muted-foreground\">\n                    Selecione quais areas do sistema este usuario pode acessar\n                  </p>\n                  \n                  {modulesLoading ? (\n                    <div className=\"flex items-center justify-center py-4\">\n                      <Loader2 className=\"h-5 w-5 animate-spin\" />\n                    </div>\n                  ) : (\n                    <div className=\"grid grid-cols-1 md:grid-cols-2 gap-2\">\n                      {modulesData.map((module) => (\n                        <div\n                          key={module.key}\n                          className=\"flex items-center space-x-3 p-3 rounded-lg border bg-muted/30 hover-elevate cursor-pointer\"\n                          onClick={() => toggleModule(module.key)}\n                          data-testid={`checkbox-module-${module.key}`}\n                        >\n                          <Checkbox\n                            checked={selectedModules.includes(module.key)}\n                            onCheckedChange={() => toggleModule(module.key)}\n                          />\n                          <div className=\"flex-1\">\n                            <p className=\"text-sm font-medium\">{module.label}</p>\n                            <p className=\"text-xs text-muted-foreground\">{module.description}</p>\n                          </div>\n                        </div>\n                      ))}\n                    </div>\n                  )}\n                </div>\n\n                <Button \n                  className=\"w-full\" \n                  onClick={handleCreateUser}\n                  disabled={createUserMutation.isPending}\n                  data-testid=\"button-submit-create-user\"\n                >\n                  {createUserMutation.isPending ? (\n                    <>\n                      <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />\n                      Criando...\n                    </>\n                  ) : (\n                    \"Criar Usuario\"\n                  )}\n                </Button>\n              </div>\n            </DialogContent>\n          </Dialog>\n          <Button variant=\"outline\" onClick={() => refetch()} data-testid=\"button-refresh-users\">\n            <RefreshCw className=\"h-4 w-4 mr-2\" />\n            Atualizar\n          </Button>\n        </div>\n      </div>\n\n      <div className=\"relative max-w-sm\">\n        <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\n        <Input\n          placeholder=\"Buscar usuarios...\"\n          value={searchQuery}\n          onChange={(e) => setSearchQuery(e.target.value)}\n          className=\"pl-9\"\n          data-testid=\"input-search-users\"\n        />\n      </div>\n\n      <Tabs value={activeTab} onValueChange={setActiveTab}>\n        <TabsList>\n          <TabsTrigger value=\"all\" data-testid=\"tab-all-users\">Todos ({users.length})</TabsTrigger>\n          <TabsTrigger value=\"pending\" data-testid=\"tab-pending-users\">\n            Pendentes ({pendingCount})\n          </TabsTrigger>\n          <TabsTrigger value=\"customers\" data-testid=\"tab-customers\">\n            Clientes ({users.filter(u => u.role === \"customer\").length})\n          </TabsTrigger>\n          <TabsTrigger value=\"staff\" data-testid=\"tab-staff\">\n            Equipe ({users.filter(u => u.role === \"admin\" || u.role === \"sales\").length})\n          </TabsTrigger>\n        </TabsList>\n\n        <TabsContent value={activeTab} className=\"mt-6\">\n          {isLoading ? (\n            <div className=\"flex items-center justify-center py-12\">\n              <Loader2 className=\"h-8 w-8 animate-spin text-muted-foreground\" />\n            </div>\n          ) : filteredUsers.length === 0 ? (\n            <div className=\"text-center py-12\">\n              <p className=\"text-muted-foreground\">Nenhum usuario encontrado</p>\n            </div>\n          ) : (\n            <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4\">\n              {filteredUsers.map((user) => (\n                <div key={user.id} className=\"relative\">\n                  <UserCard\n                    user={user}\n                    onApprove={handleApprove}\n                    onReject={handleReject}\n                    onChangeRole={handleChangeRole}\n                    onChangeCustomerType={handleChangeCustomerType}\n                    onEditExtras={handleOpenExtras}\n                  />\n                  {user.role !== \"admin\" && (\n                    <Button\n                      size=\"sm\"\n                      variant=\"outline\"\n                      className=\"absolute top-2 right-2 gap-1\"\n                      onClick={() => handleOpenPermissions(user)}\n                      data-testid={`button-permissions-${user.id}`}\n                    >\n                      <Settings className=\"h-3.5 w-3.5\" />\n                      Permissoes\n                    </Button>\n                  )}\n                </div>\n              ))}\n            </div>\n          )}\n        </TabsContent>\n      </Tabs>\n\n      <Dialog open={isPermissionsOpen} onOpenChange={setIsPermissionsOpen}>\n        <DialogContent className=\"max-w-lg\">\n          <DialogHeader>\n            <DialogTitle className=\"flex items-center gap-2\">\n              <Shield className=\"h-5 w-5\" />\n              Permissoes de {selectedUser?.name}\n            </DialogTitle>\n            <DialogDescription>\n              Configure quais modulos este usuario pode acessar no sistema\n            </DialogDescription>\n          </DialogHeader>\n          \n          <ScrollArea className=\"max-h-[400px] pr-4\">\n            <div className=\"space-y-2\">\n              {modulesData.map((module) => (\n                <div\n                  key={module.key}\n                  className=\"flex items-center space-x-3 p-3 rounded-lg border bg-muted/30 hover-elevate cursor-pointer\"\n                  onClick={() => toggleModule(module.key)}\n                >\n                  <Checkbox\n                    checked={selectedModules.includes(module.key)}\n                    onCheckedChange={() => toggleModule(module.key)}\n                    data-testid={`checkbox-edit-module-${module.key}`}\n                  />\n                  <div className=\"flex-1\">\n                    <p className=\"text-sm font-medium\">{module.label}</p>\n                    <p className=\"text-xs text-muted-foreground\">{module.description}</p>\n                  </div>\n                </div>\n              ))}\n            </div>\n          </ScrollArea>\n\n          <div className=\"flex justify-end gap-2 pt-4\">\n            <Button variant=\"outline\" onClick={() => setIsPermissionsOpen(false)}>\n              Cancelar\n            </Button>\n            <Button \n              onClick={handleSavePermissions}\n              disabled={updatePermissionsMutation.isPending}\n              data-testid=\"button-save-permissions\"\n            >\n              {updatePermissionsMutation.isPending ? (\n                <>\n                  <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />\n                  Salvando...\n                </>\n              ) : (\n                \"Salvar Permissoes\"\n              )}\n            </Button>\n          </div>\n        </DialogContent>\n      </Dialog>\n\n      <Dialog open={isExtrasOpen} onOpenChange={setIsExtrasOpen}>\n        <DialogContent className=\"max-w-md\">\n          <DialogHeader>\n            <DialogTitle className=\"flex items-center gap-2\">\n              <Tag className=\"h-5 w-5\" />\n              Extras de {selectedUser?.name}\n            </DialogTitle>\n            <DialogDescription>\n              Adicione informacoes extras como tag, Instagram e notas\n            </DialogDescription>\n          </DialogHeader>\n          \n          <div className=\"space-y-4 py-4\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"extras-tag\" className=\"flex items-center gap-2\">\n                <Tag className=\"h-4 w-4\" />\n                Tag\n              </Label>\n              <Input\n                id=\"extras-tag\"\n                value={extrasTag}\n                onChange={(e) => setExtrasTag(e.target.value)}\n                placeholder=\"Ex: VIP, Parceiro, Novo\"\n                data-testid=\"input-extras-tag\"\n              />\n              <p className=\"text-xs text-muted-foreground\">\n                Uma etiqueta para identificar o cliente rapidamente\n              </p>\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"extras-instagram\" className=\"flex items-center gap-2\">\n                <Instagram className=\"h-4 w-4\" />\n                Instagram\n              </Label>\n              <Input\n                id=\"extras-instagram\"\n                value={extrasInstagram}\n                onChange={(e) => setExtrasInstagram(e.target.value)}\n                placeholder=\"@usuario\"\n                data-testid=\"input-extras-instagram\"\n              />\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"extras-notes\" className=\"flex items-center gap-2\">\n                <StickyNote className=\"h-4 w-4\" />\n                Notas\n              </Label>\n              <Textarea\n                id=\"extras-notes\"\n                value={extrasNotes}\n                onChange={(e) => setExtrasNotes(e.target.value)}\n                placeholder=\"Observacoes sobre o cliente...\"\n                rows={4}\n                data-testid=\"input-extras-notes\"\n              />\n            </div>\n          </div>\n\n          <div className=\"flex justify-end gap-2\">\n            <Button variant=\"outline\" onClick={() => setIsExtrasOpen(false)}>\n              Cancelar\n            </Button>\n            <Button \n              onClick={handleSaveExtras}\n              disabled={updateUserMutation.isPending}\n              data-testid=\"button-save-extras\"\n            >\n              {updateUserMutation.isPending ? (\n                <>\n                  <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />\n                  Salvando...\n                </>\n              ) : (\n                \"Salvar Extras\"\n              )}\n            </Button>\n          </div>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n","path":null,"size_bytes":27092,"size_tokens":null},"client/src/components/ui/select.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as SelectPrimitive from \"@radix-ui/react-select\"\nimport { Check, ChevronDown, ChevronUp } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Select = SelectPrimitive.Root\n\nconst SelectGroup = SelectPrimitive.Group\n\nconst SelectValue = SelectPrimitive.Value\n\nconst SelectTrigger = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Trigger>\n>(({ className, children, ...props }, ref) => (\n  <SelectPrimitive.Trigger\n    ref={ref}\n    className={cn(\n      \"flex h-9 w-full items-center justify-between rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background data-[placeholder]:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 [&>span]:line-clamp-1\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <SelectPrimitive.Icon asChild>\n      <ChevronDown className=\"h-4 w-4 opacity-50\" />\n    </SelectPrimitive.Icon>\n  </SelectPrimitive.Trigger>\n))\nSelectTrigger.displayName = SelectPrimitive.Trigger.displayName\n\nconst SelectScrollUpButton = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.ScrollUpButton>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.ScrollUpButton>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.ScrollUpButton\n    ref={ref}\n    className={cn(\n      \"flex cursor-default items-center justify-center py-1\",\n      className\n    )}\n    {...props}\n  >\n    <ChevronUp className=\"h-4 w-4\" />\n  </SelectPrimitive.ScrollUpButton>\n))\nSelectScrollUpButton.displayName = SelectPrimitive.ScrollUpButton.displayName\n\nconst SelectScrollDownButton = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.ScrollDownButton>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.ScrollDownButton>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.ScrollDownButton\n    ref={ref}\n    className={cn(\n      \"flex cursor-default items-center justify-center py-1\",\n      className\n    )}\n    {...props}\n  >\n    <ChevronDown className=\"h-4 w-4\" />\n  </SelectPrimitive.ScrollDownButton>\n))\nSelectScrollDownButton.displayName =\n  SelectPrimitive.ScrollDownButton.displayName\n\nconst SelectContent = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Content>\n>(({ className, children, position = \"popper\", ...props }, ref) => (\n  <SelectPrimitive.Portal>\n    <SelectPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"relative z-50 max-h-[--radix-select-content-available-height] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-select-content-transform-origin]\",\n        position === \"popper\" &&\n          \"data-[side=bottom]:translate-y-1 data-[side=left]:-translate-x-1 data-[side=right]:translate-x-1 data-[side=top]:-translate-y-1\",\n        className\n      )}\n      position={position}\n      {...props}\n    >\n      <SelectScrollUpButton />\n      <SelectPrimitive.Viewport\n        className={cn(\n          \"p-1\",\n          position === \"popper\" &&\n            \"h-[var(--radix-select-trigger-height)] w-full min-w-[var(--radix-select-trigger-width)]\"\n        )}\n      >\n        {children}\n      </SelectPrimitive.Viewport>\n      <SelectScrollDownButton />\n    </SelectPrimitive.Content>\n  </SelectPrimitive.Portal>\n))\nSelectContent.displayName = SelectPrimitive.Content.displayName\n\nconst SelectLabel = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Label>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.Label\n    ref={ref}\n    className={cn(\"py-1.5 pl-8 pr-2 text-sm font-semibold\", className)}\n    {...props}\n  />\n))\nSelectLabel.displayName = SelectPrimitive.Label.displayName\n\nconst SelectItem = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Item>\n>(({ className, children, ...props }, ref) => (\n  <SelectPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex w-full cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <SelectPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </SelectPrimitive.ItemIndicator>\n    </span>\n\n    <SelectPrimitive.ItemText>{children}</SelectPrimitive.ItemText>\n  </SelectPrimitive.Item>\n))\nSelectItem.displayName = SelectPrimitive.Item.displayName\n\nconst SelectSeparator = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-muted\", className)}\n    {...props}\n  />\n))\nSelectSeparator.displayName = SelectPrimitive.Separator.displayName\n\nexport {\n  Select,\n  SelectGroup,\n  SelectValue,\n  SelectTrigger,\n  SelectContent,\n  SelectLabel,\n  SelectItem,\n  SelectSeparator,\n  SelectScrollUpButton,\n  SelectScrollDownButton,\n}\n","path":null,"size_bytes":5741,"size_tokens":null},"client/src/components/ui/sheet.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as SheetPrimitive from \"@radix-ui/react-dialog\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\nimport { X } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Sheet = SheetPrimitive.Root\n\nconst SheetTrigger = SheetPrimitive.Trigger\n\nconst SheetClose = SheetPrimitive.Close\n\nconst SheetPortal = SheetPrimitive.Portal\n\nconst SheetOverlay = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <SheetPrimitive.Overlay\n    className={cn(\n      \"fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0\",\n      className\n    )}\n    {...props}\n    ref={ref}\n  />\n))\nSheetOverlay.displayName = SheetPrimitive.Overlay.displayName\n\nconst sheetVariants = cva(\n  \"fixed z-50 gap-4 bg-background p-6 shadow-lg transition ease-in-out data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:duration-300 data-[state=open]:duration-500\",\n  {\n    variants: {\n      side: {\n        top: \"inset-x-0 top-0 border-b data-[state=closed]:slide-out-to-top data-[state=open]:slide-in-from-top\",\n        bottom:\n          \"inset-x-0 bottom-0 border-t data-[state=closed]:slide-out-to-bottom data-[state=open]:slide-in-from-bottom\",\n        left: \"inset-y-0 left-0 h-full w-3/4 border-r data-[state=closed]:slide-out-to-left data-[state=open]:slide-in-from-left sm:max-w-sm\",\n        right:\n          \"inset-y-0 right-0 h-full w-3/4  border-l data-[state=closed]:slide-out-to-right data-[state=open]:slide-in-from-right sm:max-w-sm\",\n      },\n    },\n    defaultVariants: {\n      side: \"right\",\n    },\n  }\n)\n\ninterface SheetContentProps\n  extends React.ComponentPropsWithoutRef<typeof SheetPrimitive.Content>,\n    VariantProps<typeof sheetVariants> {}\n\nconst SheetContent = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Content>,\n  SheetContentProps\n>(({ side = \"right\", className, children, ...props }, ref) => (\n  <SheetPortal>\n    <SheetOverlay />\n    <SheetPrimitive.Content\n      ref={ref}\n      className={cn(sheetVariants({ side }), className)}\n      {...props}\n    >\n      {children}\n      <SheetPrimitive.Close className=\"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-secondary\">\n        <X className=\"h-4 w-4\" />\n        <span className=\"sr-only\">Close</span>\n      </SheetPrimitive.Close>\n    </SheetPrimitive.Content>\n  </SheetPortal>\n))\nSheetContent.displayName = SheetPrimitive.Content.displayName\n\nconst SheetHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col space-y-2 text-center sm:text-left\",\n      className\n    )}\n    {...props}\n  />\n)\nSheetHeader.displayName = \"SheetHeader\"\n\nconst SheetFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2\",\n      className\n    )}\n    {...props}\n  />\n)\nSheetFooter.displayName = \"SheetFooter\"\n\nconst SheetTitle = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <SheetPrimitive.Title\n    ref={ref}\n    className={cn(\"text-lg font-semibold text-foreground\", className)}\n    {...props}\n  />\n))\nSheetTitle.displayName = SheetPrimitive.Title.displayName\n\nconst SheetDescription = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <SheetPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nSheetDescription.displayName = SheetPrimitive.Description.displayName\n\nexport {\n  Sheet,\n  SheetPortal,\n  SheetOverlay,\n  SheetTrigger,\n  SheetClose,\n  SheetContent,\n  SheetHeader,\n  SheetFooter,\n  SheetTitle,\n  SheetDescription,\n}\n","path":null,"size_bytes":4281,"size_tokens":null},"client/src/components/ProductCard.tsx":{"content":"import { Card, CardContent } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger } from \"@/components/ui/dialog\";\nimport { Package, Plus, Minus, ShoppingCart, Tag, Store } from \"lucide-react\";\nimport { useState } from \"react\";\nimport { useQuery } from \"@tanstack/react-query\";\n\nexport interface Product {\n  id: string;\n  name: string;\n  sku: string;\n  category: string;\n  brand?: string;\n  price: number;\n  stock?: number;\n  image?: string;\n  showPrice?: boolean;\n  featured?: boolean;\n  description?: string;\n}\n\ninterface ProductCardProps {\n  product: Product;\n  onAddToCart?: (product: Product, quantity: number) => void;\n  showPrice?: boolean;\n}\n\nexport function ProductCard({ product, onAddToCart, showPrice = true }: ProductCardProps) {\n  const [quantity, setQuantity] = useState(1);\n  const [dialogQuantity, setDialogQuantity] = useState(1);\n  const [isOpen, setIsOpen] = useState(false);\n  const inStock = product.stock === undefined || product.stock > 0;\n  const maxStock = product.stock ?? 999;\n\n  const { data: retailModeSetting } = useQuery<{ key: string; value: string | null }>({\n    queryKey: ['/api/settings/retail_mode_enabled'],\n  });\n\n  const { data: retailMarkupSetting } = useQuery<{ key: string; value: string | null }>({\n    queryKey: ['/api/settings/retail_markup_percentage'],\n  });\n\n  const isRetailModeEnabled = retailModeSetting?.value === 'true';\n  const retailMarkupPercentage = parseFloat(retailMarkupSetting?.value || '30');\n  const retailPrice = product.price * (1 + retailMarkupPercentage / 100);\n\n  const formatPrice = (price: number) => {\n    return new Intl.NumberFormat('pt-BR', {\n      style: 'currency',\n      currency: 'BRL'\n    }).format(price);\n  };\n\n  const handleIncrement = () => {\n    if (quantity < maxStock) {\n      setQuantity(q => q + 1);\n    }\n  };\n\n  const handleDecrement = () => {\n    if (quantity > 1) {\n      setQuantity(q => q - 1);\n    }\n  };\n\n  const handleDialogIncrement = () => {\n    if (dialogQuantity < maxStock) {\n      setDialogQuantity(q => q + 1);\n    }\n  };\n\n  const handleDialogDecrement = () => {\n    if (dialogQuantity > 1) {\n      setDialogQuantity(q => q - 1);\n    }\n  };\n\n  const handleAddToCart = () => {\n    onAddToCart?.(product, quantity);\n    setQuantity(1);\n  };\n\n  const handleDialogAddToCart = () => {\n    onAddToCart?.(product, dialogQuantity);\n    setDialogQuantity(1);\n    setIsOpen(false);\n  };\n\n  return (\n    <Dialog open={isOpen} onOpenChange={setIsOpen}>\n      <DialogTrigger asChild>\n        <Card \n          className=\"overflow-hidden group hover-elevate transition-all duration-200 cursor-pointer\"\n          data-testid={`card-product-${product.id}`}\n        >\n          <div className=\"aspect-[4/3] bg-muted/30 flex items-center justify-center relative overflow-hidden\">\n            {product.image ? (\n              <img\n                src={product.image}\n                alt={product.name}\n                className=\"w-full h-full object-cover transition-transform duration-300 group-hover:scale-105\"\n              />\n            ) : (\n              <Package className=\"h-16 w-16 text-muted-foreground/20\" />\n            )}\n            {!inStock && (\n              <div className=\"absolute inset-0 bg-background/80 flex items-center justify-center backdrop-blur-sm\">\n                <Badge variant=\"destructive\">Indisponivel</Badge>\n              </div>\n            )}\n            {product.brand && (\n              <div className=\"absolute top-2 left-2\">\n                <Badge variant=\"secondary\" className=\"text-xs font-medium bg-background/90 backdrop-blur-sm\">\n                  {product.brand}\n                </Badge>\n              </div>\n            )}\n          </div>\n          <CardContent className=\"p-3\">\n            <div className=\"mb-3\">\n              <p className=\"text-xs text-muted-foreground mb-1 font-mono\">\n                {product.sku}\n              </p>\n              <h3 className=\"font-medium text-sm line-clamp-2 min-h-[2.5rem] leading-tight\" data-testid={`text-product-name-${product.id}`}>\n                {product.name}\n              </h3>\n              <p className=\"text-xs text-muted-foreground mt-1\">\n                {product.category}\n              </p>\n            </div>\n            \n            <div className=\"space-y-3\">\n              <div className=\"flex items-baseline gap-1\">\n                {showPrice ? (\n                  <>\n                    <span className=\"text-xl font-bold\" data-testid={`text-product-price-${product.id}`}>\n                      {formatPrice(product.price)}\n                    </span>\n                    <span className=\"text-xs text-muted-foreground\">/un</span>\n                  </>\n                ) : (\n                  <span className=\"text-sm text-muted-foreground\">Faca login para ver precos</span>\n                )}\n              </div>\n              \n              {product.stock !== undefined && inStock && (\n                <p className=\"text-xs text-muted-foreground\">\n                  {product.stock} disponiveis\n                </p>\n              )}\n              \n              {showPrice && inStock && (\n                <div className=\"flex items-center gap-2\" onClick={(e) => e.stopPropagation()}>\n                  <div className=\"flex items-center border rounded-md\">\n                    <Button\n                      size=\"icon\"\n                      variant=\"ghost\"\n                      className=\"h-8 w-8 rounded-r-none\"\n                      onClick={(e) => { e.stopPropagation(); handleDecrement(); }}\n                      disabled={quantity <= 1}\n                      data-testid={`button-decrement-${product.id}`}\n                    >\n                      <Minus className=\"h-3 w-3\" />\n                    </Button>\n                    <span className=\"w-10 text-center text-sm font-medium\" data-testid={`text-quantity-${product.id}`}>\n                      {quantity}\n                    </span>\n                    <Button\n                      size=\"icon\"\n                      variant=\"ghost\"\n                      className=\"h-8 w-8 rounded-l-none\"\n                      onClick={(e) => { e.stopPropagation(); handleIncrement(); }}\n                      disabled={quantity >= maxStock}\n                      data-testid={`button-increment-${product.id}`}\n                    >\n                      <Plus className=\"h-3 w-3\" />\n                    </Button>\n                  </div>\n                  <Button\n                    size=\"sm\"\n                    className=\"flex-1 gap-1\"\n                    onClick={(e) => { e.stopPropagation(); handleAddToCart(); }}\n                    disabled={!inStock}\n                    data-testid={`button-add-to-cart-${product.id}`}\n                  >\n                    <ShoppingCart className=\"h-3.5 w-3.5\" />\n                    Adicionar\n                  </Button>\n                </div>\n              )}\n              \n              {showPrice && !inStock && (\n                <Button\n                  size=\"sm\"\n                  variant=\"secondary\"\n                  className=\"w-full\"\n                  disabled\n                >\n                  Indisponivel\n                </Button>\n              )}\n            </div>\n          </CardContent>\n        </Card>\n      </DialogTrigger>\n\n      <DialogContent className=\"max-w-lg\">\n        <DialogHeader>\n          <DialogTitle className=\"text-lg\">{product.name}</DialogTitle>\n        </DialogHeader>\n        \n        <div className=\"space-y-4\">\n          <div className=\"aspect-video bg-muted/30 rounded-lg flex items-center justify-center overflow-hidden\">\n            {product.image ? (\n              <img\n                src={product.image}\n                alt={product.name}\n                className=\"w-full h-full object-cover\"\n              />\n            ) : (\n              <Package className=\"h-20 w-20 text-muted-foreground/20\" />\n            )}\n          </div>\n\n          <div className=\"flex flex-wrap gap-2\">\n            <Badge variant=\"outline\">{product.sku}</Badge>\n            <Badge variant=\"secondary\">{product.category}</Badge>\n            {product.brand && <Badge>{product.brand}</Badge>}\n          </div>\n\n          {product.description && (\n            <p className=\"text-sm text-muted-foreground\">{product.description}</p>\n          )}\n\n          {showPrice && (\n            <div className=\"space-y-3 p-4 bg-muted/30 rounded-lg\">\n              <div className=\"flex items-center gap-2\">\n                <Tag className=\"h-5 w-5 text-primary\" />\n                <span className=\"font-medium\">Preco Atacado:</span>\n                <span className=\"text-2xl font-bold text-primary\" data-testid=\"text-wholesale-price\">\n                  {formatPrice(product.price)}\n                </span>\n              </div>\n              \n              {isRetailModeEnabled && (\n                <div className=\"flex items-center gap-2 pt-2 border-t\">\n                  <Store className=\"h-5 w-5 text-muted-foreground\" />\n                  <span className=\"font-medium text-muted-foreground\">Preco Varejo (+{retailMarkupPercentage}%):</span>\n                  <span className=\"text-xl font-semibold text-muted-foreground\" data-testid=\"text-retail-price\">\n                    {formatPrice(retailPrice)}\n                  </span>\n                </div>\n              )}\n            </div>\n          )}\n\n          {product.stock !== undefined && (\n            <p className=\"text-sm text-muted-foreground\">\n              Estoque: <span className={inStock ? \"text-green-600 dark:text-green-400 font-medium\" : \"text-destructive font-medium\"}>\n                {inStock ? `${product.stock} unidades` : 'Indisponivel'}\n              </span>\n            </p>\n          )}\n\n          {showPrice && inStock && (\n            <div className=\"flex items-center gap-3 pt-2\">\n              <div className=\"flex items-center border rounded-md\">\n                <Button\n                  size=\"icon\"\n                  variant=\"ghost\"\n                  onClick={handleDialogDecrement}\n                  disabled={dialogQuantity <= 1}\n                  data-testid=\"button-dialog-decrement\"\n                >\n                  <Minus className=\"h-4 w-4\" />\n                </Button>\n                <span className=\"w-12 text-center font-medium\" data-testid=\"text-dialog-quantity\">\n                  {dialogQuantity}\n                </span>\n                <Button\n                  size=\"icon\"\n                  variant=\"ghost\"\n                  onClick={handleDialogIncrement}\n                  disabled={dialogQuantity >= maxStock}\n                  data-testid=\"button-dialog-increment\"\n                >\n                  <Plus className=\"h-4 w-4\" />\n                </Button>\n              </div>\n              <Button\n                className=\"flex-1 gap-2\"\n                onClick={handleDialogAddToCart}\n                data-testid=\"button-dialog-add-to-cart\"\n              >\n                <ShoppingCart className=\"h-4 w-4\" />\n                Adicionar ao Carrinho\n              </Button>\n            </div>\n          )}\n        </div>\n      </DialogContent>\n    </Dialog>\n  );\n}\n","path":null,"size_bytes":11230,"size_tokens":null},"client/src/components/UserCard.tsx":{"content":"import { Card, CardContent } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Avatar, AvatarFallback } from \"@/components/ui/avatar\";\nimport { StatusBadge, type UserStatus } from \"./StatusBadge\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Check, X, MoreHorizontal, Edit, Instagram, Tag, StickyNote } from \"lucide-react\";\nimport {\n  DropdownMenu,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuTrigger,\n} from \"@/components/ui/dropdown-menu\";\n\nexport type UserRole = \"admin\" | \"sales\" | \"customer\" | \"supplier\";\nexport type CustomerType = \"atacado\" | \"varejo\";\n\nexport interface UserData {\n  id: string;\n  name: string;\n  email: string;\n  company?: string;\n  role: UserRole;\n  customerType: CustomerType;\n  status: UserStatus;\n  tag?: string;\n  instagram?: string;\n  notes?: string;\n}\n\ninterface UserCardProps {\n  user: UserData;\n  onApprove?: (user: UserData) => void;\n  onReject?: (user: UserData) => void;\n  onChangeRole?: (user: UserData, role: UserRole) => void;\n  onChangeCustomerType?: (user: UserData, customerType: CustomerType) => void;\n  onEditExtras?: (user: UserData) => void;\n}\n\nexport function UserCard({ user, onApprove, onReject, onChangeRole, onChangeCustomerType, onEditExtras }: UserCardProps) {\n  const initials = user.name\n    .split(\" \")\n    .map((n) => n[0])\n    .join(\"\")\n    .toUpperCase()\n    .slice(0, 2);\n\n  return (\n    <Card className=\"hover-elevate\" data-testid={`card-user-${user.id}`}>\n      <CardContent className=\"p-4\">\n        <div className=\"flex items-start gap-4\">\n          <Avatar className=\"h-12 w-12\">\n            <AvatarFallback className=\"bg-primary/10 text-primary font-semibold\">\n              {initials}\n            </AvatarFallback>\n          </Avatar>\n          <div className=\"flex-1 min-w-0\">\n            <div className=\"flex items-center gap-2 mb-1 flex-wrap\">\n              <h3 className=\"font-medium truncate\" data-testid={`text-user-name-${user.id}`}>\n                {user.name}\n              </h3>\n              <StatusBadge status={user.status} />\n              {user.tag && (\n                <Badge variant=\"secondary\" className=\"text-xs\">\n                  <Tag className=\"h-3 w-3 mr-1\" />\n                  {user.tag}\n                </Badge>\n              )}\n            </div>\n            <p className=\"text-sm text-muted-foreground truncate\">{user.email}</p>\n            {user.company && (\n              <p className=\"text-sm text-muted-foreground\">{user.company}</p>\n            )}\n            {user.instagram && (\n              <p className=\"text-xs text-muted-foreground flex items-center gap-1 mt-0.5\">\n                <Instagram className=\"h-3 w-3\" />\n                @{user.instagram.replace('@', '')}\n              </p>\n            )}\n            <p className=\"text-xs text-muted-foreground mt-1 capitalize\">Funcao: {user.role}</p>\n            {user.role === \"customer\" && (\n              <p className=\"text-xs text-muted-foreground capitalize\">\n                Tipo: {user.customerType === \"atacado\" ? \"Atacado\" : \"Varejo\"}\n              </p>\n            )}\n            {user.notes && (\n              <p className=\"text-xs text-muted-foreground mt-1 flex items-start gap-1\">\n                <StickyNote className=\"h-3 w-3 mt-0.5 flex-shrink-0\" />\n                <span className=\"line-clamp-2\">{user.notes}</span>\n              </p>\n            )}\n          </div>\n          <div className=\"flex items-center gap-1\">\n            {user.status === \"pending\" && (\n              <>\n                <Button\n                  variant=\"ghost\"\n                  size=\"icon\"\n                  onClick={() => onApprove?.(user)}\n                  className=\"text-green-600 dark:text-green-400\"\n                  data-testid={`button-approve-user-${user.id}`}\n                >\n                  <Check className=\"h-4 w-4\" />\n                </Button>\n                <Button\n                  variant=\"ghost\"\n                  size=\"icon\"\n                  onClick={() => onReject?.(user)}\n                  className=\"text-destructive\"\n                  data-testid={`button-reject-user-${user.id}`}\n                >\n                  <X className=\"h-4 w-4\" />\n                </Button>\n              </>\n            )}\n            <DropdownMenu>\n              <DropdownMenuTrigger asChild>\n                <Button variant=\"ghost\" size=\"icon\" data-testid={`button-user-menu-${user.id}`}>\n                  <MoreHorizontal className=\"h-4 w-4\" />\n                </Button>\n              </DropdownMenuTrigger>\n              <DropdownMenuContent align=\"end\">\n                <DropdownMenuItem onClick={() => onChangeRole?.(user, \"admin\")}>\n                  Definir como Administrador\n                </DropdownMenuItem>\n                <DropdownMenuItem onClick={() => onChangeRole?.(user, \"sales\")}>\n                  Definir como Vendedor\n                </DropdownMenuItem>\n                <DropdownMenuItem onClick={() => onChangeRole?.(user, \"customer\")}>\n                  Definir como Cliente\n                </DropdownMenuItem>\n                {user.role === \"customer\" && (\n                  <>\n                    <DropdownMenuItem onClick={() => onChangeCustomerType?.(user, \"atacado\")}>\n                      Tipo: Atacado\n                    </DropdownMenuItem>\n                    <DropdownMenuItem onClick={() => onChangeCustomerType?.(user, \"varejo\")}>\n                      Tipo: Varejo\n                    </DropdownMenuItem>\n                  </>\n                )}\n                <DropdownMenuItem onClick={() => onEditExtras?.(user)} data-testid={`button-extras-${user.id}`}>\n                  <Edit className=\"h-4 w-4 mr-2\" />\n                  Editar Extras\n                </DropdownMenuItem>\n              </DropdownMenuContent>\n            </DropdownMenu>\n          </div>\n        </div>\n      </CardContent>\n    </Card>\n  );\n}\n","path":null,"size_bytes":5878,"size_tokens":null},"client/src/components/ui/skeleton.tsx":{"content":"import { cn } from \"@/lib/utils\"\n\nfunction Skeleton({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) {\n  return (\n    <div\n      className={cn(\"animate-pulse rounded-md bg-muted\", className)}\n      {...props}\n    />\n  )\n}\n\nexport { Skeleton }\n","path":null,"size_bytes":261,"size_tokens":null},"client/src/components/ui/input-otp.tsx":{"content":"import * as React from \"react\"\nimport { OTPInput, OTPInputContext } from \"input-otp\"\nimport { Dot } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst InputOTP = React.forwardRef<\n  React.ElementRef<typeof OTPInput>,\n  React.ComponentPropsWithoutRef<typeof OTPInput>\n>(({ className, containerClassName, ...props }, ref) => (\n  <OTPInput\n    ref={ref}\n    containerClassName={cn(\n      \"flex items-center gap-2 has-[:disabled]:opacity-50\",\n      containerClassName\n    )}\n    className={cn(\"disabled:cursor-not-allowed\", className)}\n    {...props}\n  />\n))\nInputOTP.displayName = \"InputOTP\"\n\nconst InputOTPGroup = React.forwardRef<\n  React.ElementRef<\"div\">,\n  React.ComponentPropsWithoutRef<\"div\">\n>(({ className, ...props }, ref) => (\n  <div ref={ref} className={cn(\"flex items-center\", className)} {...props} />\n))\nInputOTPGroup.displayName = \"InputOTPGroup\"\n\nconst InputOTPSlot = React.forwardRef<\n  React.ElementRef<\"div\">,\n  React.ComponentPropsWithoutRef<\"div\"> & { index: number }\n>(({ index, className, ...props }, ref) => {\n  const inputOTPContext = React.useContext(OTPInputContext)\n  const { char, hasFakeCaret, isActive } = inputOTPContext.slots[index]\n\n  return (\n    <div\n      ref={ref}\n      className={cn(\n        \"relative flex h-10 w-10 items-center justify-center border-y border-r border-input text-sm transition-all first:rounded-l-md first:border-l last:rounded-r-md\",\n        isActive && \"z-10 ring-2 ring-ring ring-offset-background\",\n        className\n      )}\n      {...props}\n    >\n      {char}\n      {hasFakeCaret && (\n        <div className=\"pointer-events-none absolute inset-0 flex items-center justify-center\">\n          <div className=\"h-4 w-px animate-caret-blink bg-foreground duration-1000\" />\n        </div>\n      )}\n    </div>\n  )\n})\nInputOTPSlot.displayName = \"InputOTPSlot\"\n\nconst InputOTPSeparator = React.forwardRef<\n  React.ElementRef<\"div\">,\n  React.ComponentPropsWithoutRef<\"div\">\n>(({ ...props }, ref) => (\n  <div ref={ref} role=\"separator\" {...props}>\n    <Dot />\n  </div>\n))\nInputOTPSeparator.displayName = \"InputOTPSeparator\"\n\nexport { InputOTP, InputOTPGroup, InputOTPSlot, InputOTPSeparator }\n","path":null,"size_bytes":2154,"size_tokens":null},"server/routes.ts":{"content":"import express, { type Express } from \"express\";\nimport { createServer, type Server } from \"http\";\nimport { storage } from \"./storage\";\nimport { db } from \"./db\";\nimport { products, orderItems, orders } from \"@shared/schema\";\nimport { eq, sql } from \"drizzle-orm\";\nimport { setupAuth, isAuthenticated } from \"./replitAuth\";\nimport { insertCategorySchema, insertProductSchema, insertOrderSchema, insertOrderItemSchema, insertCouponSchema, insertCatalogBannerSchema, insertCatalogSlideSchema, insertAccountPayableSchema, insertPayablePaymentSchema, insertSupplierSchema } from \"@shared/schema\";\nimport { z } from \"zod\";\nimport multer from \"multer\";\nimport { Client } from \"@replit/object-storage\";\nimport * as blingService from \"./services/bling\";\nimport bcrypt from \"bcryptjs\";\nimport PDFDocument from \"pdfkit\";\n\nasync function fetchImageBuffer(url: string): Promise<Buffer | null> {\n  try {\n    const response = await fetch(url);\n    if (!response.ok) return null;\n    const arrayBuffer = await response.arrayBuffer();\n    return Buffer.from(arrayBuffer);\n  } catch (error) {\n    console.error(\"Error fetching image:\", error);\n    return null;\n  }\n}\n\nconst upload = multer({ \n  storage: multer.memoryStorage(),\n  limits: { fileSize: 5 * 1024 * 1024 }\n});\n\nlet objectStorageClient: Client | null = null;\n\nasync function getObjectStorage(): Promise<Client> {\n  if (!objectStorageClient) {\n    const bucketId = process.env.DEFAULT_OBJECT_STORAGE_BUCKET_ID;\n    if (!bucketId) {\n      throw new Error(\"Object storage not configured. DEFAULT_OBJECT_STORAGE_BUCKET_ID is missing.\");\n    }\n    objectStorageClient = new Client({ bucketId });\n  }\n  return objectStorageClient;\n}\n\n// Helper to generate sequential order numbers starting from 8000\nasync function generateOrderNumber(): Promise<string> {\n  const nextNumber = await storage.getNextOrderNumber();\n  return nextNumber.toString();\n}\n\n// Middleware to check if user is admin or sales\nfunction isAdminOrSales(req: any, res: any, next: any) {\n  const userId = req.user?.claims?.sub;\n  if (!userId) {\n    return res.status(401).json({ message: \"Unauthorized\" });\n  }\n  \n  storage.getUser(userId).then(user => {\n    if (!user || (user.role !== 'admin' && user.role !== 'sales')) {\n      return res.status(403).json({ message: \"Forbidden - Admin or Sales access required\" });\n    }\n    next();\n  }).catch(() => {\n    res.status(500).json({ message: \"Server error\" });\n  });\n}\n\n// Middleware to check if user is admin only\nfunction isAdmin(req: any, res: any, next: any) {\n  const userId = req.user?.claims?.sub;\n  if (!userId) {\n    return res.status(401).json({ message: \"Unauthorized\" });\n  }\n  \n  storage.getUser(userId).then(user => {\n    if (!user || user.role !== 'admin') {\n      return res.status(403).json({ message: \"Forbidden - Admin access required\" });\n    }\n    next();\n  }).catch(() => {\n    res.status(500).json({ message: \"Server error\" });\n  });\n}\n\n// Middleware to check if user is approved\nfunction isApproved(req: any, res: any, next: any) {\n  const userId = req.user?.claims?.sub;\n  if (!userId) {\n    return res.status(401).json({ message: \"Unauthorized\" });\n  }\n  \n  storage.getUser(userId).then(user => {\n    if (!user) {\n      return res.status(401).json({ message: \"User not found\" });\n    }\n    if (!user.approved && user.role !== 'admin') {\n      return res.status(403).json({ message: \"Account pending approval\" });\n    }\n    next();\n  }).catch(() => {\n    res.status(500).json({ message: \"Server error\" });\n  });\n}\n\nexport async function registerRoutes(\n  httpServer: Server,\n  app: Express\n): Promise<Server> {\n  // Setup Replit Auth\n  await setupAuth(app);\n\n  // Public registration endpoint\n  app.post('/api/register', async (req, res) => {\n    try {\n      const data = req.body;\n      \n      // Check if email already exists\n      const existingUser = await storage.getUserByEmail(data.email);\n      if (existingUser) {\n        return res.status(400).json({ message: \"E-mail já cadastrado\" });\n      }\n\n      // Hash password if provided\n      let hashedPassword = null;\n      if (data.password) {\n        hashedPassword = await bcrypt.hash(data.password, 10);\n      }\n\n      // Auto-approve retail customers (personType = fisica)\n      const isRetailCustomer = data.personType === 'fisica';\n      \n      // Create new user with pending approval (auto-approved for retail)\n      const newUser = await storage.upsertUser({\n        id: crypto.randomUUID(),\n        email: data.email,\n        password: hashedPassword,\n        firstName: data.firstName,\n        lastName: null,\n        profileImageUrl: null,\n        role: \"customer\",\n        company: data.company || null,\n        approved: isRetailCustomer,\n        phone: data.phone || null,\n        personType: data.personType || null,\n        cnpj: data.cnpj || null,\n        cpf: data.cpf || null,\n        tradingName: data.tradingName || null,\n        stateRegistration: data.stateRegistration || null,\n        cep: data.cep || null,\n        address: data.address || null,\n        addressNumber: data.addressNumber || null,\n        complement: data.complement || null,\n        neighborhood: data.neighborhood || null,\n        city: data.city || null,\n        state: data.state || null,\n      });\n\n      const message = isRetailCustomer \n        ? \"Cadastro realizado com sucesso! Voce ja pode fazer login.\"\n        : \"Cadastro realizado com sucesso! Aguarde aprovacao do administrador.\";\n      \n      res.status(201).json({ \n        message, \n        userId: newUser.id,\n        approved: newUser.approved \n      });\n    } catch (error) {\n      console.error(\"Error registering user:\", error);\n      res.status(500).json({ message: \"Erro ao criar cadastro\" });\n    }\n  });\n\n  // Local login endpoint (email/password)\n  app.post('/api/auth/login', async (req: any, res) => {\n    try {\n      const { email, password } = req.body;\n      \n      if (!email || !password) {\n        return res.status(400).json({ message: \"E-mail e senha são obrigatórios\" });\n      }\n\n      const user = await storage.getUserByEmail(email);\n      if (!user) {\n        return res.status(401).json({ message: \"E-mail ou senha incorretos\" });\n      }\n\n      if (!user.password) {\n        return res.status(401).json({ message: \"Esta conta não possui senha cadastrada\" });\n      }\n\n      const isValidPassword = await bcrypt.compare(password, user.password);\n      if (!isValidPassword) {\n        return res.status(401).json({ message: \"E-mail ou senha incorretos\" });\n      }\n\n      // Create session for local user with expires_at for compatibility with isAuthenticated\n      const sessionExpiry = Math.floor(Date.now() / 1000) + (7 * 24 * 60 * 60); // 1 week\n      const sessionUser = {\n        claims: { sub: user.id },\n        expires_at: sessionExpiry,\n        isLocalAuth: true,\n      };\n      \n      req.login(sessionUser, (err: any) => {\n        if (err) {\n          console.error(\"Login error:\", err);\n          return res.status(500).json({ message: \"Erro ao fazer login\" });\n        }\n        res.json({ message: \"Login realizado com sucesso\", user });\n      });\n    } catch (error) {\n      console.error(\"Login error:\", error);\n      res.status(500).json({ message: \"Erro ao fazer login\" });\n    }\n  });\n\n  // Local logout endpoint\n  app.post('/api/auth/logout', (req: any, res) => {\n    req.logout((err: any) => {\n      if (err) {\n        return res.status(500).json({ message: \"Erro ao fazer logout\" });\n      }\n      res.json({ message: \"Logout realizado com sucesso\" });\n    });\n  });\n\n  // Auth routes\n  app.get('/api/auth/user', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      res.json(user);\n    } catch (error) {\n      console.error(\"Error fetching user:\", error);\n      res.status(500).json({ message: \"Failed to fetch user\" });\n    }\n  });\n\n  // ========== CATEGORIES ==========\n  app.get('/api/categories', isAuthenticated, isApproved, async (req, res) => {\n    try {\n      const categories = await storage.getCategories();\n      res.json(categories);\n    } catch (error) {\n      console.error(\"Error fetching categories:\", error);\n      res.status(500).json({ message: \"Failed to fetch categories\" });\n    }\n  });\n\n  app.get('/api/categories/:id', isAuthenticated, isApproved, async (req, res) => {\n    try {\n      const category = await storage.getCategory(parseInt(req.params.id));\n      if (!category) {\n        return res.status(404).json({ message: \"Category not found\" });\n      }\n      res.json(category);\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to fetch category\" });\n    }\n  });\n\n  app.post('/api/categories', isAuthenticated, isAdminOrSales, async (req, res) => {\n    try {\n      const data = insertCategorySchema.parse(req.body);\n      const category = await storage.createCategory(data);\n      res.status(201).json(category);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ message: \"Invalid data\", errors: error.errors });\n      }\n      res.status(500).json({ message: \"Failed to create category\" });\n    }\n  });\n\n  app.patch('/api/categories/:id', isAuthenticated, isAdminOrSales, async (req, res) => {\n    try {\n      const category = await storage.updateCategory(parseInt(req.params.id), req.body);\n      if (!category) {\n        return res.status(404).json({ message: \"Category not found\" });\n      }\n      res.json(category);\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to update category\" });\n    }\n  });\n\n  app.delete('/api/categories/:id', isAuthenticated, isAdmin, async (req, res) => {\n    try {\n      await storage.deleteCategory(parseInt(req.params.id));\n      res.status(204).send();\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to delete category\" });\n    }\n  });\n\n  // ========== PUBLIC CATALOG (no auth required) ==========\n  // Retail markup: 40% on top of base price\n  const RETAIL_MARKUP = 0.40;\n  \n  app.get('/api/public/products', async (req, res) => {\n    try {\n      const categoryId = req.query.categoryId ? parseInt(req.query.categoryId as string) : undefined;\n      const search = req.query.search as string | undefined;\n      const page = req.query.page ? parseInt(req.query.page as string) : 1;\n      const limit = req.query.limit ? parseInt(req.query.limit as string) : 50;\n      const sort = req.query.sort as string | undefined;\n      const result = await storage.getProducts({ categoryId, search, page, limit, sort });\n      \n      // Get categories hidden from varejo\n      const allCategories = await storage.getCategories();\n      const hiddenCategoryIds = new Set(\n        allCategories.filter(c => c.hideFromVarejo).map(c => c.id)\n      );\n      \n      // Filter out products from hidden categories\n      const visibleProducts = result.products.filter(p => \n        !p.categoryId || !hiddenCategoryIds.has(p.categoryId)\n      );\n      \n      // Apply retail markup (40%) to all prices for public view\n      const productsWithRetailPrice = visibleProducts.map(p => ({\n        ...p,\n        price: (parseFloat(p.price) * (1 + RETAIL_MARKUP)).toFixed(2),\n      }));\n      \n      res.json({\n        ...result,\n        products: productsWithRetailPrice,\n        total: visibleProducts.length,\n      });\n    } catch (error) {\n      console.error(\"Error fetching public products:\", error);\n      res.status(500).json({ message: \"Failed to fetch products\" });\n    }\n  });\n\n  app.get('/api/public/categories', async (req, res) => {\n    try {\n      const categories = await storage.getCategories();\n      // Filter out categories hidden from varejo\n      const publicCategories = categories.filter(c => !c.hideFromVarejo);\n      res.json(publicCategories);\n    } catch (error) {\n      console.error(\"Error fetching public categories:\", error);\n      res.status(500).json({ message: \"Failed to fetch categories\" });\n    }\n  });\n\n  // ========== PRODUCTS ==========\n  app.get('/api/products', isAuthenticated, isApproved, async (req: any, res) => {\n    try {\n      const categoryId = req.query.categoryId ? parseInt(req.query.categoryId as string) : undefined;\n      const search = req.query.search as string | undefined;\n      const page = req.query.page ? parseInt(req.query.page as string) : 1;\n      const limit = req.query.limit ? parseInt(req.query.limit as string) : 50;\n      const result = await storage.getProducts({ categoryId, search, page, limit });\n      \n      // Get user to check customer type\n      const userId = req.user?.claims?.sub;\n      const user = userId ? await storage.getUser(userId) : null;\n      \n      // Atacado customers see base price, varejo customers see price + 40%\n      const isAtacado = user?.customerType === 'atacado' || user?.role === 'admin' || user?.role === 'sales';\n      \n      if (isAtacado) {\n        // Atacado: show base price (no markup)\n        res.json(result);\n      } else {\n        // Varejo: apply 40% markup\n        const productsWithRetailPrice = result.products.map(p => ({\n          ...p,\n          price: (parseFloat(p.price) * (1 + RETAIL_MARKUP)).toFixed(2),\n        }));\n        res.json({\n          ...result,\n          products: productsWithRetailPrice,\n        });\n      }\n    } catch (error) {\n      console.error(\"Error fetching products:\", error);\n      res.status(500).json({ message: \"Failed to fetch products\" });\n    }\n  });\n\n  app.get('/api/products/:id', isAuthenticated, isApproved, async (req, res) => {\n    try {\n      const product = await storage.getProduct(parseInt(req.params.id));\n      if (!product) {\n        return res.status(404).json({ message: \"Product not found\" });\n      }\n      res.json(product);\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to fetch product\" });\n    }\n  });\n\n  app.post('/api/products', isAuthenticated, isAdminOrSales, async (req, res) => {\n    try {\n      const data = insertProductSchema.parse(req.body);\n      const product = await storage.createProduct(data);\n      res.status(201).json(product);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ message: \"Invalid data\", errors: error.errors });\n      }\n      console.error(\"Error creating product:\", error);\n      res.status(500).json({ message: \"Failed to create product\" });\n    }\n  });\n\n  app.patch('/api/products/:id', isAuthenticated, isAdminOrSales, async (req, res) => {\n    try {\n      const product = await storage.updateProduct(parseInt(req.params.id), req.body);\n      if (!product) {\n        return res.status(404).json({ message: \"Product not found\" });\n      }\n      res.json(product);\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to update product\" });\n    }\n  });\n\n  app.delete('/api/products/:id', isAuthenticated, isAdmin, async (req, res) => {\n    try {\n      await storage.deleteProduct(parseInt(req.params.id));\n      res.status(204).send();\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to delete product\" });\n    }\n  });\n\n  app.patch('/api/products/:id/toggle-featured', isAuthenticated, isAdminOrSales, async (req, res) => {\n    try {\n      const productId = parseInt(req.params.id);\n      const product = await storage.getProduct(productId);\n      if (!product) {\n        return res.status(404).json({ message: \"Product not found\" });\n      }\n      const updated = await storage.updateProduct(productId, { featured: !product.featured });\n      res.json(updated);\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to toggle featured status\" });\n    }\n  });\n\n  // ========== ORDERS ==========\n  app.get('/api/orders', isAuthenticated, isApproved, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      let ordersData;\n      // Customers can only see their own orders\n      if (user?.role === 'customer') {\n        ordersData = await storage.getOrders(userId);\n      } else {\n        // Admin and sales can see all orders\n        ordersData = await storage.getOrders();\n      }\n      \n      // Fetch customer info and item count for each order\n      const ordersWithCustomers = await Promise.all(\n        ordersData.map(async (order) => {\n          const customer = order.userId ? await storage.getUser(order.userId) : null;\n          const orderItems = await storage.getOrderItems(order.id);\n          return {\n            ...order,\n            customerName: customer ? \n              (customer.tradingName || customer.company || `${customer.firstName || ''} ${customer.lastName || ''}`.trim() || customer.email) \n              : (order.userId?.substring(0, 8) || 'Guest') + \"...\",\n            items: orderItems,\n          };\n        })\n      );\n      \n      res.json(ordersWithCustomers);\n    } catch (error) {\n      console.error(\"Error fetching orders:\", error);\n      res.status(500).json({ message: \"Failed to fetch orders\" });\n    }\n  });\n\n  app.get('/api/orders/:id', isAuthenticated, isApproved, async (req: any, res) => {\n    try {\n      const orderDetails = await storage.getOrderWithDetails(parseInt(req.params.id));\n      if (!orderDetails) {\n        return res.status(404).json({ message: \"Order not found\" });\n      }\n      \n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      // Customers can only see their own orders\n      if (user?.role === 'customer' && orderDetails.order.userId !== userId) {\n        return res.status(403).json({ message: \"Forbidden\" });\n      }\n      \n      res.json({\n        ...orderDetails.order,\n        items: orderDetails.items,\n        customer: orderDetails.customer,\n        printedByUser: orderDetails.printedByUser,\n      });\n    } catch (error) {\n      console.error(\"Error fetching order details:\", error);\n      res.status(500).json({ message: \"Failed to fetch order\" });\n    }\n  });\n\n  app.post('/api/orders', isAuthenticated, isApproved, async (req: any, res) => {\n    try {\n      const loggedUserId = req.user.claims.sub;\n      const loggedUser = await storage.getUser(loggedUserId);\n      const { items, notes, subtotal, shippingCost, shippingAddress, shippingMethod, paymentMethod, paymentNotes, userId: targetUserId } = req.body;\n      \n      // Admin/Sales can create orders for other customers\n      const userId = (loggedUser?.role === 'admin' || loggedUser?.role === 'sales') && targetUserId \n        ? targetUserId \n        : loggedUserId;\n      \n      if (!items || !Array.isArray(items) || items.length === 0) {\n        return res.status(400).json({ message: \"Order must have at least one item\" });\n      }\n      \n      // Calculate total from items\n      let calculatedSubtotal = 0;\n      for (const item of items) {\n        const product = await storage.getProduct(item.productId);\n        if (!product) {\n          return res.status(400).json({ message: `Product ${item.productId} not found` });\n        }\n        calculatedSubtotal += parseFloat(product.price) * item.quantity;\n      }\n      \n      // Use calculated subtotal or provided subtotal\n      const finalSubtotal = subtotal || calculatedSubtotal;\n      const finalShippingCost = shippingCost || 0;\n      const total = finalSubtotal + finalShippingCost;\n      \n      // Format shipping address as string if it's an object\n      let shippingAddressStr = null;\n      if (shippingAddress) {\n        if (typeof shippingAddress === 'object' && shippingAddress.fullAddress) {\n          shippingAddressStr = shippingAddress.fullAddress;\n        } else if (typeof shippingAddress === 'string') {\n          shippingAddressStr = shippingAddress;\n        }\n      }\n      \n      // Create order with ORCAMENTO status\n      const order = await storage.createOrder({\n        userId,\n        orderNumber: await generateOrderNumber(),\n        status: 'ORCAMENTO',\n        subtotal: finalSubtotal.toFixed(2),\n        shippingCost: finalShippingCost.toFixed(2),\n        total: total.toFixed(2),\n        shippingAddress: shippingAddressStr,\n        shippingMethod: shippingMethod || null,\n        paymentMethod: paymentMethod || null,\n        paymentNotes: paymentNotes || null,\n        notes: notes || null,\n        isGuestOrder: false,\n      });\n      \n      // Create order items and collect for Bling\n      const blingItems: blingService.BlingOrderItem[] = [];\n      for (const item of items) {\n        const product = await storage.getProduct(item.productId);\n        await storage.createOrderItem({\n          orderId: order.id,\n          productId: item.productId,\n          quantity: item.quantity,\n          price: product!.price,\n        });\n        blingItems.push({\n          codigo: product!.sku,\n          descricao: product!.name,\n          quantidade: item.quantity,\n          valorUnidade: parseFloat(product!.price),\n        });\n      }\n      \n      // Send order to Bling (async, don't block response)\n      const user = await storage.getUser(userId);\n      blingService.createBlingOrder({\n        orderNumber: order.orderNumber,\n        customerCpfCnpj: user?.cnpj || user?.cpf || undefined,\n        customerName: user?.tradingName || user?.company || `${user?.firstName || ''} ${user?.lastName || ''}`.trim() || undefined,\n        items: blingItems,\n        frete: finalShippingCost,\n        observacoes: notes || undefined,\n      }).then(result => {\n        if (result.success) {\n          console.log(`Order ${order.orderNumber} synced to Bling: ID ${result.blingId}`);\n        } else {\n          console.log(`Order ${order.orderNumber} Bling sync failed: ${result.error}`);\n        }\n      }).catch(err => console.error(\"Bling sync error:\", err));\n      \n      const orderItems = await storage.getOrderItems(order.id);\n      res.status(201).json({ ...order, items: orderItems });\n    } catch (error) {\n      console.error(\"Error creating order:\", error);\n      res.status(500).json({ message: \"Failed to create order\" });\n    }\n  });\n\n  // Guest checkout - no authentication required\n  app.post('/api/orders/guest', async (req: any, res) => {\n    try {\n      const { items, notes, subtotal, shippingCost, shippingAddress, shippingMethod, paymentMethod, paymentNotes, guestCpf, guestName, guestEmail, guestPhone } = req.body;\n      \n      if (!items || !Array.isArray(items) || items.length === 0) {\n        return res.status(400).json({ message: \"Order must have at least one item\" });\n      }\n      \n      // Validate guest CPF (required)\n      if (!guestCpf || guestCpf.replace(/\\D/g, '').length !== 11) {\n        return res.status(400).json({ message: \"CPF valido e obrigatorio\" });\n      }\n      \n      // Calculate total from items\n      let calculatedSubtotal = 0;\n      for (const item of items) {\n        const product = await storage.getProduct(item.productId);\n        if (!product) {\n          return res.status(400).json({ message: `Product ${item.productId} not found` });\n        }\n        calculatedSubtotal += parseFloat(product.price) * item.quantity;\n      }\n      \n      // Use calculated subtotal or provided subtotal\n      const finalSubtotal = subtotal || calculatedSubtotal;\n      const finalShippingCost = shippingCost || 0;\n      const total = finalSubtotal + finalShippingCost;\n      \n      // Format shipping address as string if it's an object\n      let shippingAddressStr = null;\n      if (shippingAddress) {\n        if (typeof shippingAddress === 'object' && shippingAddress.fullAddress) {\n          shippingAddressStr = shippingAddress.fullAddress;\n        } else if (typeof shippingAddress === 'string') {\n          shippingAddressStr = shippingAddress;\n        }\n      }\n      \n      // Create guest order with ORCAMENTO status\n      const order = await storage.createOrder({\n        userId: null, // No user for guest orders\n        orderNumber: await generateOrderNumber(),\n        status: 'ORCAMENTO',\n        subtotal: finalSubtotal.toFixed(2),\n        shippingCost: finalShippingCost.toFixed(2),\n        total: total.toFixed(2),\n        shippingAddress: shippingAddressStr,\n        shippingMethod: shippingMethod || null,\n        paymentMethod: paymentMethod || null,\n        paymentNotes: paymentNotes || null,\n        notes: notes || null,\n        isGuestOrder: true,\n        guestCpf: guestCpf.replace(/\\D/g, ''),\n        guestName: guestName || null,\n        guestEmail: guestEmail || null,\n        guestPhone: guestPhone || null,\n      });\n      \n      // Create order items and collect for Bling\n      const blingItems: blingService.BlingOrderItem[] = [];\n      for (const item of items) {\n        const product = await storage.getProduct(item.productId);\n        await storage.createOrderItem({\n          orderId: order.id,\n          productId: item.productId,\n          quantity: item.quantity,\n          price: product!.price,\n        });\n        blingItems.push({\n          codigo: product!.sku,\n          descricao: product!.name,\n          quantidade: item.quantity,\n          valorUnidade: parseFloat(product!.price),\n        });\n      }\n      \n      // Send order to Bling (async, don't block response)\n      blingService.createBlingOrder({\n        orderNumber: order.orderNumber,\n        customerCpfCnpj: guestCpf?.replace(/\\D/g, ''),\n        customerName: guestName || undefined,\n        items: blingItems,\n        frete: finalShippingCost,\n        observacoes: notes || undefined,\n      }).then(result => {\n        if (result.success) {\n          console.log(`Guest Order ${order.orderNumber} synced to Bling: ID ${result.blingId}`);\n        } else {\n          console.log(`Guest Order ${order.orderNumber} Bling sync failed: ${result.error}`);\n        }\n      }).catch(err => console.error(\"Bling sync error:\", err));\n      \n      const orderItems = await storage.getOrderItems(order.id);\n      res.status(201).json({ ...order, items: orderItems });\n    } catch (error) {\n      console.error(\"Error creating guest order:\", error);\n      res.status(500).json({ message: \"Failed to create order\" });\n    }\n  });\n\n  app.patch('/api/orders/:id', isAuthenticated, isAdminOrSales, async (req, res) => {\n    try {\n      const orderId = parseInt(req.params.id);\n      const { status } = req.body;\n      \n      // Check if order exists and prevent changes from FATURADO\n      const existingOrder = await storage.getOrder(orderId);\n      if (!existingOrder) {\n        return res.status(404).json({ message: \"Order not found\" });\n      }\n      \n      // FATURADO orders cannot change to any other status\n      if (existingOrder.status === 'FATURADO' && status) {\n        return res.status(400).json({ message: \"Pedidos faturados não podem ter o status alterado\" });\n      }\n      \n      // Handle cancellation with stock return (only from PEDIDO_GERADO or ORCAMENTO)\n      if (status === 'CANCELADO') {\n        const items = await storage.getOrderItems(orderId);\n        \n        // If order was in PEDIDO_GERADO (stock reserved), release reserved stock\n        if (existingOrder.status === 'PEDIDO_GERADO') {\n          for (const item of items) {\n            await db.update(products)\n              .set({ reservedStock: sql`GREATEST(reserved_stock - ${item.quantity}, 0)` })\n              .where(eq(products.id, item.productId));\n          }\n        }\n        \n        // Update order to cancelled\n        const order = await storage.updateOrder(orderId, { \n          status: 'CANCELADO',\n          reservedAt: null,\n          reservedBy: null\n        });\n        return res.json(order);\n      }\n      \n      const order = await storage.updateOrder(orderId, req.body);\n      if (!order) {\n        return res.status(404).json({ message: \"Order not found\" });\n      }\n      res.json(order);\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to update order\" });\n    }\n  });\n\n  app.patch('/api/orders/:id/print', isAuthenticated, isAdminOrSales, async (req: any, res) => {\n    try {\n      const userId = req.user?.claims?.sub;\n      const order = await storage.updateOrder(parseInt(req.params.id), {\n        printed: true,\n        printedAt: new Date(),\n        printedBy: userId,\n        stage: 'IMPRESSO',\n      });\n      if (!order) {\n        return res.status(404).json({ message: \"Order not found\" });\n      }\n      res.json(order);\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to mark order as printed\" });\n    }\n  });\n\n  // Update order stage (etapa operacional)\n  app.patch('/api/orders/:id/stage', isAuthenticated, isAdminOrSales, async (req: any, res) => {\n    try {\n      const orderId = parseInt(req.params.id);\n      const { stage } = req.body;\n      \n      if (!stage) {\n        return res.status(400).json({ message: \"Stage is required\" });\n      }\n      \n      const result = await storage.updateOrderStage(orderId, stage);\n      if (!result.success) {\n        return res.status(400).json({ message: result.error });\n      }\n      \n      const order = await storage.getOrder(orderId);\n      res.json(order);\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to update order stage\" });\n    }\n  });\n\n  app.post('/api/orders/:id/reserve', isAuthenticated, isAdminOrSales, async (req: any, res) => {\n    try {\n      const userId = req.user?.claims?.sub;\n      const orderId = parseInt(req.params.id);\n      const result = await storage.reserveStockForOrder(orderId, userId);\n      if (!result.success) {\n        return res.status(400).json({ message: result.error });\n      }\n      const order = await storage.getOrder(orderId);\n      res.json(order);\n    } catch (error) {\n      res.status(500).json({ message: \"Erro ao reservar estoque\" });\n    }\n  });\n\n  app.post('/api/orders/:id/release', isAuthenticated, isAdminOrSales, async (req: any, res) => {\n    try {\n      const orderId = parseInt(req.params.id);\n      const result = await storage.releaseStockForOrder(orderId);\n      if (!result.success) {\n        return res.status(400).json({ message: result.error });\n      }\n      const order = await storage.getOrder(orderId);\n      res.json(order);\n    } catch (error) {\n      res.status(500).json({ message: \"Erro ao liberar estoque\" });\n    }\n  });\n\n  app.post('/api/orders/:id/unreserve', isAuthenticated, isAdminOrSales, async (req: any, res) => {\n    try {\n      const orderId = parseInt(req.params.id);\n      const order = await storage.getOrder(orderId);\n      \n      if (!order) {\n        return res.status(404).json({ message: \"Pedido não encontrado\" });\n      }\n      \n      if (order.status !== 'PEDIDO_GERADO') {\n        return res.status(400).json({ message: \"Apenas pedidos com status 'Pedido Gerado' podem retornar para Orçamento\" });\n      }\n      \n      const releaseResult = await storage.releaseStockForOrder(orderId);\n      if (!releaseResult.success) {\n        return res.status(400).json({ message: releaseResult.error });\n      }\n      \n      const updatedOrder = await storage.updateOrder(orderId, { \n        status: 'ORCAMENTO',\n        reservedAt: null,\n        reservedBy: null,\n      });\n      \n      res.json(updatedOrder);\n    } catch (error) {\n      console.error(\"Error unreserving order:\", error);\n      res.status(500).json({ message: \"Erro ao retornar pedido para orçamento\" });\n    }\n  });\n\n  app.put('/api/orders/:id/items', isAuthenticated, isAdminOrSales, async (req: any, res) => {\n    try {\n      const orderId = parseInt(req.params.id);\n      const { items } = req.body;\n      \n      if (!items || !Array.isArray(items) || items.length === 0) {\n        return res.status(400).json({ message: \"O pedido deve ter pelo menos um item\" });\n      }\n      \n      const existingOrder = await storage.getOrder(orderId);\n      if (!existingOrder) {\n        return res.status(404).json({ message: \"Pedido não encontrado\" });\n      }\n      \n      if (existingOrder.status === 'PEDIDO_FATURADO') {\n        return res.status(400).json({ message: \"Pedidos faturados não podem ser modificados\" });\n      }\n      \n      if (existingOrder.status === 'PEDIDO_GERADO') {\n        return res.status(400).json({ message: \"Pedidos com estoque reservado não podem ser editados. Retorne para Orçamento Enviado primeiro.\" });\n      }\n      \n      if (existingOrder.status !== 'ORCAMENTO_CONCLUIDO' && existingOrder.status !== 'ORCAMENTO_ABERTO') {\n        return res.status(400).json({ message: \"Apenas orçamentos podem ser editados\" });\n      }\n      \n      const validatedItems: { productId: number; quantity: number; price: string }[] = [];\n      let newTotal = 0;\n      \n      for (const item of items) {\n        if (!item.productId || typeof item.productId !== 'number') {\n          return res.status(400).json({ message: \"ID do produto inválido\" });\n        }\n        if (!item.quantity || typeof item.quantity !== 'number' || item.quantity < 1 || !Number.isInteger(item.quantity)) {\n          return res.status(400).json({ message: \"Quantidade deve ser um número inteiro positivo\" });\n        }\n        \n        const product = await storage.getProduct(item.productId);\n        if (!product) {\n          return res.status(400).json({ message: `Produto ${item.productId} não encontrado` });\n        }\n        \n        const price = product.price;\n        validatedItems.push({ productId: item.productId, quantity: item.quantity, price });\n        newTotal += parseFloat(price) * item.quantity;\n      }\n      \n      await db.delete(orderItems).where(eq(orderItems.orderId, orderId));\n      \n      for (const item of validatedItems) {\n        await db.insert(orderItems).values({\n          orderId,\n          productId: item.productId,\n          quantity: item.quantity,\n          price: item.price,\n        });\n      }\n      \n      await storage.updateOrder(orderId, { total: newTotal.toFixed(2) });\n      \n      const updatedOrder = await storage.getOrder(orderId);\n      const updatedItems = await storage.getOrderItems(orderId);\n      res.json({ ...updatedOrder, items: updatedItems });\n    } catch (error) {\n      console.error(\"Error updating order items:\", error);\n      res.status(500).json({ message: \"Falha ao atualizar itens do pedido\" });\n    }\n  });\n\n  app.post('/api/orders/:id/invoice', isAuthenticated, isAdminOrSales, async (req: any, res) => {\n    try {\n      const userId = req.user?.claims?.sub;\n      const orderId = parseInt(req.params.id);\n      const result = await storage.deductStockForOrder(orderId, userId);\n      if (!result.success) {\n        return res.status(400).json({ message: result.error });\n      }\n      const order = await storage.getOrder(orderId);\n      res.json(order);\n    } catch (error) {\n      res.status(500).json({ message: \"Erro ao faturar pedido\" });\n    }\n  });\n\n  // Admin-only: Delete order with stock return if applicable\n  app.delete('/api/orders/:id', isAuthenticated, isAdmin, async (req: any, res) => {\n    try {\n      const orderId = parseInt(req.params.id);\n      const existingOrder = await storage.getOrder(orderId);\n      \n      if (!existingOrder) {\n        return res.status(404).json({ message: \"Pedido não encontrado\" });\n      }\n      \n      // FATURADO orders cannot be deleted\n      if (existingOrder.status === 'FATURADO') {\n        return res.status(400).json({ message: \"Pedidos faturados não podem ser excluídos\" });\n      }\n      \n      const items = await storage.getOrderItems(orderId);\n      \n      // If order has reserved stock (PEDIDO_GERADO), release it back\n      if (existingOrder.status === 'PEDIDO_GERADO') {\n        for (const item of items) {\n          await db.update(products)\n            .set({ reservedStock: sql`GREATEST(reserved_stock - ${item.quantity}, 0)` })\n            .where(eq(products.id, item.productId));\n        }\n      }\n      \n      // Delete order items first\n      await db.delete(orderItems).where(eq(orderItems.orderId, orderId));\n      \n      // Delete the order\n      await db.delete(orders).where(eq(orders.id, orderId));\n      \n      res.json({ success: true, message: \"Pedido excluído com sucesso\" });\n    } catch (error) {\n      console.error(\"Error deleting order:\", error);\n      res.status(500).json({ message: \"Erro ao excluir pedido\" });\n    }\n  });\n\n  app.get('/api/me/purchase-stats', isAuthenticated, isApproved, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const stats = await storage.getCustomerPurchaseStats(userId);\n      res.json(stats);\n    } catch (error) {\n      console.error(\"Error fetching purchase stats:\", error);\n      res.status(500).json({ message: \"Failed to fetch purchase statistics\" });\n    }\n  });\n\n  app.get('/api/admin/sales-stats', isAuthenticated, isAdminOrSales, async (req: any, res) => {\n    try {\n      const period = req.query.period as 'day' | 'week' | 'month' | 'year' | 'all' | undefined;\n      const stats = await storage.getAdminSalesStats(period);\n      res.json(stats);\n    } catch (error) {\n      console.error(\"Error fetching admin sales stats:\", error);\n      res.status(500).json({ message: \"Failed to fetch sales statistics\" });\n    }\n  });\n\n  app.get('/api/admin/customer-analytics', isAuthenticated, isAdminOrSales, async (req: any, res) => {\n    try {\n      const analytics = await storage.getCustomerAnalytics();\n      res.json(analytics);\n    } catch (error) {\n      console.error(\"Error fetching customer analytics:\", error);\n      res.status(500).json({ message: \"Failed to fetch customer analytics\" });\n    }\n  });\n\n  app.get('/api/admin/employee-analytics', isAuthenticated, isAdminOrSales, async (req: any, res) => {\n    try {\n      const analytics = await storage.getEmployeeAnalytics();\n      res.json(analytics);\n    } catch (error) {\n      console.error(\"Error fetching employee analytics:\", error);\n      res.status(500).json({ message: \"Failed to fetch employee analytics\" });\n    }\n  });\n\n  app.get('/api/admin/customers-by-location', isAuthenticated, isAdminOrSales, async (req: any, res) => {\n    try {\n      const allUsers = await storage.getUsers();\n      const customers = allUsers.filter(u => u.role === 'customer');\n      \n      const byState: Record<string, { count: number; customers: { id: string; name: string; city: string | null }[] }> = {};\n      const cityMap: Map<string, { city: string; state: string | null; count: number }> = new Map();\n      \n      for (const customer of customers) {\n        const state = customer.state || 'Não informado';\n        const city = customer.city || 'Não informado';\n        const name = customer.tradingName || customer.company || `${customer.firstName || ''} ${customer.lastName || ''}`.trim() || customer.email || 'Cliente';\n        \n        if (!byState[state]) {\n          byState[state] = { count: 0, customers: [] };\n        }\n        byState[state].count++;\n        byState[state].customers.push({ id: customer.id, name, city: customer.city });\n        \n        const cityKey = JSON.stringify({ city, state });\n        const existing = cityMap.get(cityKey);\n        if (existing) {\n          existing.count++;\n        } else {\n          cityMap.set(cityKey, { city, state: customer.state, count: 1 });\n        }\n      }\n      \n      const statesSorted = Object.entries(byState)\n        .map(([state, data]) => ({ state, ...data }))\n        .sort((a, b) => b.count - a.count);\n      \n      const citiesSorted = Array.from(cityMap.values())\n        .sort((a, b) => b.count - a.count)\n        .slice(0, 20);\n      \n      res.json({\n        totalCustomers: customers.length,\n        customersWithLocation: customers.filter(c => c.state || c.city).length,\n        byState: statesSorted,\n        byCity: citiesSorted,\n      });\n    } catch (error) {\n      console.error(\"Error fetching customers by location:\", error);\n      res.status(500).json({ message: \"Failed to fetch customers by location\" });\n    }\n  });\n\n  app.get('/api/admin/product-analytics', isAuthenticated, isAdminOrSales, async (req: any, res) => {\n    try {\n      const analytics = await storage.getProductAnalytics();\n      console.log(\"Product analytics overview:\", JSON.stringify(analytics.overview));\n      console.log(\"Product analytics ranking30d:\", JSON.stringify(analytics.rankingByRevenue.days30));\n      res.json(analytics);\n    } catch (error) {\n      console.error(\"Error fetching product analytics:\", error);\n      res.status(500).json({ message: \"Failed to fetch product analytics\" });\n    }\n  });\n\n  app.get('/api/admin/purchases-analytics', isAuthenticated, isAdminOrSales, async (req: any, res) => {\n    try {\n      const analytics = await storage.getPurchasesAnalytics();\n      res.json(analytics);\n    } catch (error) {\n      console.error(\"Error fetching purchases analytics:\", error);\n      res.status(500).json({ message: \"Failed to fetch purchases analytics\" });\n    }\n  });\n\n  // Brand Analytics - for admin/sales and supplier users\n  app.get('/api/admin/brand-analytics', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user?.claims?.sub;\n      const user = await storage.getUser(userId);\n      \n      if (!user) {\n        return res.status(401).json({ message: \"User not found\" });\n      }\n\n      // Admin and sales can see all brands (with optional filter)\n      if (user.role === 'admin' || user.role === 'sales') {\n        const brandsFilter = req.query.brands ? (req.query.brands as string).split(',') : undefined;\n        const analytics = await storage.getBrandAnalytics(brandsFilter);\n        return res.json(analytics);\n      }\n\n      // Supplier can ONLY see their allowed brands - ignore any query params\n      if (user.role === 'supplier') {\n        const allowedBrands = user.allowedBrands || [];\n        if (allowedBrands.length === 0) {\n          return res.json({\n            brands: [],\n            productsByBrand: {},\n            overview: { totalBrands: 0, totalProducts: 0, totalLowStock: 0, totalOutOfStock: 0, topSellingBrand: null, topSellingBrandRevenue: 0 }\n          });\n        }\n        // Force supplier to only see their assigned brands - never trust client input\n        const analytics = await storage.getBrandAnalytics(allowedBrands);\n        return res.json(analytics);\n      }\n\n      return res.status(403).json({ message: \"Access denied\" });\n    } catch (error) {\n      console.error(\"Error fetching brand analytics:\", error);\n      res.status(500).json({ message: \"Failed to fetch brand analytics\" });\n    }\n  });\n\n  // Get all unique brands (for filter selection) - filtered by role\n  app.get('/api/brands', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user?.claims?.sub;\n      const user = await storage.getUser(userId);\n      \n      if (!user) {\n        return res.status(401).json({ message: \"User not found\" });\n      }\n\n      const productsResult = await storage.getProducts();\n      const allProducts = productsResult.products;\n      const brandsSet = new Set<string>();\n      allProducts.forEach((p: { brand: string | null }) => {\n        if (p.brand) brandsSet.add(p.brand);\n      });\n      \n      let brands = Array.from(brandsSet).sort();\n      \n      // Supplier can only see their allowed brands\n      if (user.role === 'supplier') {\n        const allowedBrands = user.allowedBrands || [];\n        brands = brands.filter(b => allowedBrands.includes(b));\n      }\n      \n      res.json(brands);\n    } catch (error) {\n      console.error(\"Error fetching brands:\", error);\n      res.status(500).json({ message: \"Failed to fetch brands\" });\n    }\n  });\n\n  // Get all brands (admin only - for user management)\n  app.get('/api/admin/all-brands', isAuthenticated, isAdmin, async (req: any, res) => {\n    try {\n      const productsResult = await storage.getProducts();\n      const allProducts = productsResult.products;\n      const brandsSet = new Set<string>();\n      allProducts.forEach((p: { brand: string | null }) => {\n        if (p.brand) brandsSet.add(p.brand);\n      });\n      \n      const brands = Array.from(brandsSet).sort();\n      res.json(brands);\n    } catch (error) {\n      console.error(\"Error fetching all brands:\", error);\n      res.status(500).json({ message: \"Failed to fetch brands\" });\n    }\n  });\n\n  // ========== USERS (Admin Only) ==========\n  app.get('/api/users', isAuthenticated, isAdmin, async (req, res) => {\n    try {\n      const users = await storage.getUsers();\n      res.json(users);\n    } catch (error) {\n      console.error(\"Error fetching users:\", error);\n      res.status(500).json({ message: \"Failed to fetch users\" });\n    }\n  });\n\n  // Create user with email/password (admin only)\n  app.post('/api/users', isAuthenticated, isAdmin, async (req, res) => {\n    try {\n      const { firstName, email, password, role } = req.body;\n      \n      if (!firstName || !email || !password) {\n        return res.status(400).json({ message: \"Nome, email e senha são obrigatórios\" });\n      }\n\n      // Validate email format\n      const emailRegex = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/;\n      if (!emailRegex.test(email)) {\n        return res.status(400).json({ message: \"E-mail inválido. Use o formato: usuario@empresa.com\" });\n      }\n\n      const existingUser = await storage.getUserByEmail(email);\n      if (existingUser) {\n        return res.status(400).json({ message: \"E-mail já cadastrado\" });\n      }\n\n      const hashedPassword = await bcrypt.hash(password, 10);\n      \n      const newUser = await storage.upsertUser({\n        id: crypto.randomUUID(),\n        email,\n        password: hashedPassword,\n        firstName,\n        lastName: null,\n        profileImageUrl: null,\n        role: role || \"customer\",\n        company: null,\n        approved: true,\n        phone: null,\n        personType: null,\n        cnpj: null,\n        cpf: null,\n        cep: null,\n        address: null,\n        addressNumber: null,\n        complement: null,\n        neighborhood: null,\n        city: null,\n        state: null,\n      });\n\n      res.status(201).json({ message: \"Usuário criado com sucesso\", userId: newUser.id });\n    } catch (error) {\n      console.error(\"Error creating user:\", error);\n      res.status(500).json({ message: \"Erro ao criar usuário\" });\n    }\n  });\n\n  app.patch('/api/users/:id', isAuthenticated, isAdmin, async (req, res) => {\n    try {\n      const user = await storage.updateUser(req.params.id, req.body);\n      if (!user) {\n        return res.status(404).json({ message: \"User not found\" });\n      }\n      res.json(user);\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to update user\" });\n    }\n  });\n\n  app.delete('/api/users/:id', isAuthenticated, isAdmin, async (req, res) => {\n    try {\n      await storage.deleteUser(req.params.id);\n      res.status(204).send();\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to delete user\" });\n    }\n  });\n\n  // ========== AGENDA EVENTS ==========\n  app.get('/api/agenda', isAuthenticated, isAdminOrSales, async (req: any, res) => {\n    try {\n      const startDate = req.query.startDate ? new Date(req.query.startDate) : undefined;\n      const endDate = req.query.endDate ? new Date(req.query.endDate) : undefined;\n      const events = await storage.getAgendaEvents({ startDate, endDate });\n      res.json(events);\n    } catch (error) {\n      console.error(\"Error fetching agenda events:\", error);\n      res.status(500).json({ message: \"Failed to fetch agenda events\" });\n    }\n  });\n\n  app.get('/api/agenda/:id', isAuthenticated, isAdminOrSales, async (req: any, res) => {\n    try {\n      const event = await storage.getAgendaEvent(parseInt(req.params.id));\n      if (!event) {\n        return res.status(404).json({ message: \"Event not found\" });\n      }\n      res.json(event);\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to fetch event\" });\n    }\n  });\n\n  const agendaEventSchema = z.object({\n    title: z.string().min(1, \"Title is required\"),\n    description: z.string().optional().nullable(),\n    date: z.string().min(1, \"Date is required\"),\n    time: z.string().optional().nullable(),\n    type: z.enum([\"note\", \"meeting\", \"task\", \"reminder\"]).default(\"note\"),\n    completed: z.boolean().optional(),\n  });\n\n  app.post('/api/agenda', isAuthenticated, isAdminOrSales, async (req: any, res) => {\n    try {\n      const validation = agendaEventSchema.safeParse(req.body);\n      if (!validation.success) {\n        return res.status(400).json({ message: \"Invalid data\", errors: validation.error.errors });\n      }\n      const eventData = {\n        title: validation.data.title,\n        description: validation.data.description || null,\n        date: new Date(validation.data.date),\n        time: validation.data.time || null,\n        type: validation.data.type,\n        completed: validation.data.completed || false,\n        createdBy: req.user?.id,\n      };\n      const event = await storage.createAgendaEvent(eventData);\n      res.status(201).json(event);\n    } catch (error) {\n      console.error(\"Error creating agenda event:\", error);\n      res.status(500).json({ message: \"Failed to create event\" });\n    }\n  });\n\n  app.patch('/api/agenda/:id', isAuthenticated, isAdminOrSales, async (req: any, res) => {\n    try {\n      const partialSchema = agendaEventSchema.partial();\n      const validation = partialSchema.safeParse(req.body);\n      if (!validation.success) {\n        return res.status(400).json({ message: \"Invalid data\", errors: validation.error.errors });\n      }\n      const updateData: any = { ...validation.data };\n      if (updateData.date) {\n        updateData.date = new Date(updateData.date);\n      }\n      const event = await storage.updateAgendaEvent(parseInt(req.params.id), updateData);\n      if (!event) {\n        return res.status(404).json({ message: \"Event not found\" });\n      }\n      res.json(event);\n    } catch (error) {\n      console.error(\"Error updating agenda event:\", error);\n      res.status(500).json({ message: \"Failed to update event\" });\n    }\n  });\n\n  app.delete('/api/agenda/:id', isAuthenticated, isAdminOrSales, async (req: any, res) => {\n    try {\n      const success = await storage.deleteAgendaEvent(parseInt(req.params.id));\n      if (!success) {\n        return res.status(404).json({ message: \"Event not found\" });\n      }\n      res.status(204).send();\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to delete event\" });\n    }\n  });\n\n  // ========== CUSTOMER CREDITS (FIADO) ==========\n  \n  // Get credits dashboard (admin/sales only)\n  app.get('/api/credits/dashboard', isAuthenticated, isAdminOrSales, async (req: any, res) => {\n    try {\n      const dashboard = await storage.getCreditsDashboard();\n      res.json(dashboard);\n    } catch (error) {\n      console.error(\"Error fetching credits dashboard:\", error);\n      res.status(500).json({ message: \"Failed to fetch credits dashboard\" });\n    }\n  });\n\n  // Get all credits (admin/sales only)\n  app.get('/api/credits', isAuthenticated, isAdminOrSales, async (req: any, res) => {\n    try {\n      const credits = await storage.getAllCredits();\n      res.json(credits);\n    } catch (error) {\n      console.error(\"Error fetching credits:\", error);\n      res.status(500).json({ message: \"Failed to fetch credits\" });\n    }\n  });\n\n  // Get credits for a specific customer\n  app.get('/api/credits/customer/:userId', isAuthenticated, isAdminOrSales, async (req: any, res) => {\n    try {\n      const credits = await storage.getCustomerCredits(req.params.userId);\n      const balance = await storage.getCustomerCreditBalance(req.params.userId);\n      res.json({ credits, balance });\n    } catch (error) {\n      console.error(\"Error fetching customer credits:\", error);\n      res.status(500).json({ message: \"Failed to fetch customer credits\" });\n    }\n  });\n\n  // Get single credit with payments\n  app.get('/api/credits/:id', isAuthenticated, isAdminOrSales, async (req: any, res) => {\n    try {\n      const credit = await storage.getCustomerCredit(parseInt(req.params.id));\n      if (!credit) {\n        return res.status(404).json({ message: \"Credit not found\" });\n      }\n      const payments = await storage.getCreditPayments(credit.id);\n      res.json({ credit, payments });\n    } catch (error) {\n      console.error(\"Error fetching credit:\", error);\n      res.status(500).json({ message: \"Failed to fetch credit\" });\n    }\n  });\n\n  // Create a new credit entry (debt or credit)\n  app.post('/api/credits', isAuthenticated, isAdminOrSales, async (req: any, res) => {\n    try {\n      const { userId, type, amount, description, dueDate, orderId } = req.body;\n      \n      if (!userId || !type || !amount) {\n        return res.status(400).json({ message: \"userId, type and amount are required\" });\n      }\n      \n      if (!['DEBITO', 'CREDITO'].includes(type)) {\n        return res.status(400).json({ message: \"type must be DEBITO or CREDITO\" });\n      }\n      \n      const credit = await storage.createCustomerCredit({\n        userId,\n        type,\n        amount: parseFloat(amount).toFixed(2),\n        paidAmount: \"0\",\n        description: description || null,\n        status: 'PENDENTE',\n        dueDate: dueDate ? new Date(dueDate) : null,\n        orderId: orderId || null,\n        createdBy: req.user.id\n      });\n      \n      res.status(201).json(credit);\n    } catch (error) {\n      console.error(\"Error creating credit:\", error);\n      res.status(500).json({ message: \"Failed to create credit\" });\n    }\n  });\n\n  // Update credit entry\n  app.patch('/api/credits/:id', isAuthenticated, isAdminOrSales, async (req: any, res) => {\n    try {\n      const { description, dueDate, status } = req.body;\n      \n      const updateData: any = {};\n      if (description !== undefined) updateData.description = description;\n      if (dueDate !== undefined) updateData.dueDate = dueDate ? new Date(dueDate) : null;\n      if (status !== undefined) updateData.status = status;\n      \n      const credit = await storage.updateCustomerCredit(parseInt(req.params.id), updateData);\n      if (!credit) {\n        return res.status(404).json({ message: \"Credit not found\" });\n      }\n      \n      res.json(credit);\n    } catch (error) {\n      console.error(\"Error updating credit:\", error);\n      res.status(500).json({ message: \"Failed to update credit\" });\n    }\n  });\n\n  // Delete credit entry\n  app.delete('/api/credits/:id', isAuthenticated, isAdmin, async (req: any, res) => {\n    try {\n      const success = await storage.deleteCustomerCredit(parseInt(req.params.id));\n      if (!success) {\n        return res.status(404).json({ message: \"Credit not found\" });\n      }\n      res.status(204).send();\n    } catch (error) {\n      console.error(\"Error deleting credit:\", error);\n      res.status(500).json({ message: \"Failed to delete credit\" });\n    }\n  });\n\n  // Register a payment for a credit\n  app.post('/api/credits/:id/payments', isAuthenticated, isAdminOrSales, async (req: any, res) => {\n    try {\n      const creditId = parseInt(req.params.id);\n      const { amount, paymentMethod, notes } = req.body;\n      \n      if (!amount || parseFloat(amount) <= 0) {\n        return res.status(400).json({ message: \"Valid amount is required\" });\n      }\n      \n      const credit = await storage.getCustomerCredit(creditId);\n      if (!credit) {\n        return res.status(404).json({ message: \"Credit not found\" });\n      }\n      \n      const payment = await storage.createCreditPayment({\n        creditId,\n        amount: parseFloat(amount).toFixed(2),\n        paymentMethod: paymentMethod || null,\n        notes: notes || null,\n        receivedBy: req.user.id\n      });\n      \n      // Fetch updated credit\n      const updatedCredit = await storage.getCustomerCredit(creditId);\n      \n      res.status(201).json({ payment, credit: updatedCredit });\n    } catch (error) {\n      console.error(\"Error registering payment:\", error);\n      res.status(500).json({ message: \"Failed to register payment\" });\n    }\n  });\n\n  // Get payments for a credit\n  app.get('/api/credits/:id/payments', isAuthenticated, isAdminOrSales, async (req: any, res) => {\n    try {\n      const payments = await storage.getCreditPayments(parseInt(req.params.id));\n      res.json(payments);\n    } catch (error) {\n      console.error(\"Error fetching payments:\", error);\n      res.status(500).json({ message: \"Failed to fetch payments\" });\n    }\n  });\n\n  // ========== ACCOUNTS PAYABLE (CONTAS A PAGAR) ==========\n  // All endpoints require admin role for full access control\n  \n  // Get all payables\n  app.get('/api/payables', isAuthenticated, isAdmin, async (req: any, res) => {\n    try {\n      const payables = await storage.getAccountsPayable();\n      res.json(payables);\n    } catch (error) {\n      console.error(\"Error fetching payables:\", error);\n      res.status(500).json({ message: \"Failed to fetch payables\" });\n    }\n  });\n\n  // Get payables dashboard\n  app.get('/api/payables/dashboard', isAuthenticated, isAdmin, async (req: any, res) => {\n    try {\n      const dashboard = await storage.getPayablesDashboard();\n      res.json(dashboard);\n    } catch (error) {\n      console.error(\"Error fetching payables dashboard:\", error);\n      res.status(500).json({ message: \"Failed to fetch payables dashboard\" });\n    }\n  });\n\n  // Get single payable\n  app.get('/api/payables/:id', isAuthenticated, isAdmin, async (req: any, res) => {\n    try {\n      const payable = await storage.getAccountPayable(parseInt(req.params.id));\n      if (!payable) {\n        return res.status(404).json({ message: \"Payable not found\" });\n      }\n      res.json(payable);\n    } catch (error) {\n      console.error(\"Error fetching payable:\", error);\n      res.status(500).json({ message: \"Failed to fetch payable\" });\n    }\n  });\n\n  // Create new payable with validation\n  const createPayableSchema = z.object({\n    supplierName: z.string().optional().nullable(),\n    category: z.string().optional().nullable(),\n    description: z.string().min(1, \"Descrição é obrigatória\"),\n    amount: z.union([z.string(), z.number()]).transform(v => {\n      const num = typeof v === 'string' ? parseFloat(v) : v;\n      if (isNaN(num) || num <= 0) throw new Error(\"Valor inválido\");\n      return num.toFixed(2);\n    }),\n    dueDate: z.string().optional().nullable().transform(v => v ? new Date(v) : null),\n    documentNumber: z.string().optional().nullable(),\n    notes: z.string().optional().nullable()\n  });\n\n  app.post('/api/payables', isAuthenticated, isAdmin, async (req: any, res) => {\n    try {\n      const validation = createPayableSchema.safeParse(req.body);\n      if (!validation.success) {\n        return res.status(400).json({ \n          message: \"Dados inválidos\", \n          errors: validation.error.errors \n        });\n      }\n      \n      const data = validation.data;\n      const payable = await storage.createAccountPayable({\n        supplierName: data.supplierName || null,\n        category: data.category || null,\n        description: data.description,\n        amount: data.amount,\n        paidAmount: \"0\",\n        status: 'PENDENTE',\n        dueDate: data.dueDate,\n        documentNumber: data.documentNumber || null,\n        notes: data.notes || null,\n        createdBy: req.user.id\n      });\n      \n      res.status(201).json(payable);\n    } catch (error) {\n      console.error(\"Error creating payable:\", error);\n      res.status(500).json({ message: \"Failed to create payable\" });\n    }\n  });\n\n  // Update payable\n  app.patch('/api/payables/:id', isAuthenticated, isAdmin, async (req: any, res) => {\n    try {\n      const updates: any = {};\n      if (req.body.description !== undefined) updates.description = req.body.description;\n      if (req.body.supplierName !== undefined) updates.supplierName = req.body.supplierName;\n      if (req.body.category !== undefined) updates.category = req.body.category;\n      if (req.body.status !== undefined) updates.status = req.body.status;\n      if (req.body.notes !== undefined) updates.notes = req.body.notes;\n      if (req.body.dueDate !== undefined) {\n        updates.dueDate = req.body.dueDate ? new Date(req.body.dueDate) : null;\n      }\n      \n      const payable = await storage.updateAccountPayable(parseInt(req.params.id), updates);\n      if (!payable) {\n        return res.status(404).json({ message: \"Payable not found\" });\n      }\n      res.json(payable);\n    } catch (error) {\n      console.error(\"Error updating payable:\", error);\n      res.status(500).json({ message: \"Failed to update payable\" });\n    }\n  });\n\n  // Delete payable\n  app.delete('/api/payables/:id', isAuthenticated, isAdmin, async (req: any, res) => {\n    try {\n      await storage.deleteAccountPayable(parseInt(req.params.id));\n      res.status(204).send();\n    } catch (error) {\n      console.error(\"Error deleting payable:\", error);\n      res.status(500).json({ message: \"Failed to delete payable\" });\n    }\n  });\n\n  // Register payment for payable with validation\n  const createPayablePaymentSchema = z.object({\n    amount: z.union([z.string(), z.number()]).transform(v => {\n      const num = typeof v === 'string' ? parseFloat(v) : v;\n      if (isNaN(num) || num <= 0) throw new Error(\"Valor inválido\");\n      return num.toFixed(2);\n    }),\n    paymentMethod: z.string().optional().nullable(),\n    notes: z.string().optional().nullable()\n  });\n\n  app.post('/api/payables/:id/payments', isAuthenticated, isAdmin, async (req: any, res) => {\n    try {\n      const payableId = parseInt(req.params.id);\n      \n      const validation = createPayablePaymentSchema.safeParse(req.body);\n      if (!validation.success) {\n        return res.status(400).json({ \n          message: \"Dados inválidos\", \n          errors: validation.error.errors \n        });\n      }\n      \n      const data = validation.data;\n      const payable = await storage.getAccountPayable(payableId);\n      if (!payable) {\n        return res.status(404).json({ message: \"Payable not found\" });\n      }\n      \n      const payment = await storage.createPayablePayment({\n        payableId,\n        amount: data.amount,\n        paymentMethod: data.paymentMethod || null,\n        notes: data.notes || null,\n        paidBy: req.user.id\n      });\n      \n      const updatedPayable = await storage.getAccountPayable(payableId);\n      \n      res.status(201).json({ payment, payable: updatedPayable });\n    } catch (error) {\n      console.error(\"Error registering payable payment:\", error);\n      res.status(500).json({ message: \"Failed to register payment\" });\n    }\n  });\n\n  // Get payments for payable\n  app.get('/api/payables/:id/payments', isAuthenticated, isAdmin, async (req: any, res) => {\n    try {\n      const payments = await storage.getPayablePayments(parseInt(req.params.id));\n      res.json(payments);\n    } catch (error) {\n      console.error(\"Error fetching payable payments:\", error);\n      res.status(500).json({ message: \"Failed to fetch payments\" });\n    }\n  });\n\n  // ========== SITE SETTINGS ==========\n  app.get('/api/settings/:key', async (req, res) => {\n    try {\n      const setting = await storage.getSiteSetting(req.params.key);\n      res.json({ key: req.params.key, value: setting?.value || null });\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to fetch setting\" });\n    }\n  });\n\n  app.post('/api/settings/:key', isAuthenticated, isAdmin, async (req: any, res) => {\n    try {\n      console.log('[SETTINGS] Saving key:', req.params.key, 'value:', req.body.value);\n      const { value } = req.body;\n      const setting = await storage.setSiteSetting(req.params.key, value);\n      console.log('[SETTINGS] Saved:', setting);\n      res.json(setting);\n    } catch (error) {\n      console.error('[SETTINGS] Error saving setting:', error);\n      res.status(500).json({ message: \"Failed to save setting\" });\n    }\n  });\n\n  // ========== CATALOG BANNERS ==========\n  app.get('/api/catalog/banners', async (req, res) => {\n    try {\n      const position = req.query.position as string | undefined;\n      const banners = await storage.getCatalogBanners(position);\n      res.json(banners);\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to fetch banners\" });\n    }\n  });\n\n  app.get('/api/catalog/banners/:id', async (req, res) => {\n    try {\n      const banner = await storage.getCatalogBanner(parseInt(req.params.id));\n      if (!banner) {\n        return res.status(404).json({ message: \"Banner not found\" });\n      }\n      res.json(banner);\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to fetch banner\" });\n    }\n  });\n\n  app.post('/api/catalog/banners', isAuthenticated, isAdmin, async (req: any, res) => {\n    try {\n      const banner = await storage.createCatalogBanner(req.body);\n      res.status(201).json(banner);\n    } catch (error) {\n      console.error(\"Error creating banner:\", error);\n      res.status(500).json({ message: \"Failed to create banner\" });\n    }\n  });\n\n  app.patch('/api/catalog/banners/:id', isAuthenticated, isAdmin, async (req: any, res) => {\n    try {\n      const banner = await storage.updateCatalogBanner(parseInt(req.params.id), req.body);\n      if (!banner) {\n        return res.status(404).json({ message: \"Banner not found\" });\n      }\n      res.json(banner);\n    } catch (error) {\n      console.error(\"Error updating banner:\", error);\n      res.status(500).json({ message: \"Failed to update banner\" });\n    }\n  });\n\n  app.delete('/api/catalog/banners/:id', isAuthenticated, isAdmin, async (req: any, res) => {\n    try {\n      const success = await storage.deleteCatalogBanner(parseInt(req.params.id));\n      if (!success) {\n        return res.status(404).json({ message: \"Banner not found\" });\n      }\n      res.status(204).send();\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to delete banner\" });\n    }\n  });\n\n  // ========== CATALOG SLIDES ==========\n  app.get('/api/catalog/slides', async (req, res) => {\n    try {\n      const slides = await storage.getCatalogSlides();\n      res.json(slides);\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to fetch slides\" });\n    }\n  });\n\n  app.get('/api/catalog/slides/:id', async (req, res) => {\n    try {\n      const slide = await storage.getCatalogSlide(parseInt(req.params.id));\n      if (!slide) {\n        return res.status(404).json({ message: \"Slide not found\" });\n      }\n      res.json(slide);\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to fetch slide\" });\n    }\n  });\n\n  app.post('/api/catalog/slides', isAuthenticated, isAdmin, async (req: any, res) => {\n    try {\n      const slide = await storage.createCatalogSlide(req.body);\n      res.status(201).json(slide);\n    } catch (error) {\n      console.error(\"Error creating slide:\", error);\n      res.status(500).json({ message: \"Failed to create slide\" });\n    }\n  });\n\n  app.patch('/api/catalog/slides/:id', isAuthenticated, isAdmin, async (req: any, res) => {\n    try {\n      const slide = await storage.updateCatalogSlide(parseInt(req.params.id), req.body);\n      if (!slide) {\n        return res.status(404).json({ message: \"Slide not found\" });\n      }\n      res.json(slide);\n    } catch (error) {\n      console.error(\"Error updating slide:\", error);\n      res.status(500).json({ message: \"Failed to update slide\" });\n    }\n  });\n\n  app.delete('/api/catalog/slides/:id', isAuthenticated, isAdmin, async (req: any, res) => {\n    try {\n      const success = await storage.deleteCatalogSlide(parseInt(req.params.id));\n      if (!success) {\n        return res.status(404).json({ message: \"Slide not found\" });\n      }\n      res.status(204).send();\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to delete slide\" });\n    }\n  });\n\n  // ========== CATALOG CONFIG ==========\n  app.get('/api/catalog/config/:key', async (req, res) => {\n    try {\n      const config = await storage.getCatalogConfig(req.params.key);\n      res.json({ key: req.params.key, value: config?.value || null });\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to fetch config\" });\n    }\n  });\n\n  app.post('/api/catalog/config/:key', isAuthenticated, isAdmin, async (req: any, res) => {\n    try {\n      const { value } = req.body;\n      const config = await storage.setCatalogConfig(req.params.key, value);\n      res.json(config);\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to save config\" });\n    }\n  });\n\n  // ========== CSV Export ==========\n  app.get('/api/orders/export/csv', isAuthenticated, isAdminOrSales, async (req: any, res) => {\n    try {\n      const orders = await storage.getOrders();\n      \n      // Build CSV content\n      const headers = ['Order Number', 'User ID', 'Status', 'Total', 'Notes', 'Created At'];\n      let csv = headers.join(',') + '\\n';\n      \n      for (const order of orders) {\n        const row = [\n          order.orderNumber,\n          order.userId,\n          order.status,\n          order.total,\n          `\"${(order.notes || '').replace(/\"/g, '\"\"')}\"`,\n          order.createdAt.toISOString()\n        ];\n        csv += row.join(',') + '\\n';\n      }\n      \n      res.setHeader('Content-Type', 'text/csv');\n      res.setHeader('Content-Disposition', 'attachment; filename=\"orders.csv\"');\n      res.send(csv);\n    } catch (error) {\n      console.error(\"Error exporting orders:\", error);\n      res.status(500).json({ message: \"Failed to export orders\" });\n    }\n  });\n\n  // ========== FILE SERVING (public endpoint to serve object storage files) ==========\n  app.get('/api/files/*', async (req: any, res) => {\n    try {\n      const filePath = req.params[0] as string;\n      console.log('[FILE SERVE] Requested:', filePath);\n      if (!filePath) {\n        return res.status(400).json({ message: \"File path required\" });\n      }\n\n      const objectStorage = await getObjectStorage();\n      const result = await objectStorage.downloadAsBytes(filePath);\n      \n      if (!result || !result.ok || !result.value) {\n        console.log('[FILE SERVE] File not found or error:', filePath, 'result:', result);\n        return res.status(404).json({ message: \"File not found\" });\n      }\n      \n      const rawBytes = result.value;\n      let buffer: Buffer;\n      \n      if (Buffer.isBuffer(rawBytes)) {\n        buffer = rawBytes;\n      } else if (rawBytes instanceof Uint8Array) {\n        buffer = Buffer.from(rawBytes);\n      } else if (ArrayBuffer.isView(rawBytes)) {\n        buffer = Buffer.from((rawBytes as any).buffer, (rawBytes as any).byteOffset, (rawBytes as any).byteLength);\n      } else if (rawBytes instanceof ArrayBuffer) {\n        buffer = Buffer.from(rawBytes);\n      } else if (Array.isArray(rawBytes)) {\n        if (rawBytes.length === 1 && Buffer.isBuffer(rawBytes[0])) {\n          buffer = rawBytes[0];\n        } else if (rawBytes.length > 0 && typeof rawBytes[0] === 'number') {\n          buffer = Buffer.from(new Uint8Array(rawBytes as unknown as number[]));\n        } else {\n          buffer = Buffer.concat(rawBytes.filter(Buffer.isBuffer));\n        }\n      } else if (typeof rawBytes === 'object' && rawBytes !== null) {\n        if ('buffer' in rawBytes && 'byteOffset' in rawBytes && 'byteLength' in rawBytes) {\n          const typed = rawBytes as { buffer: ArrayBuffer; byteOffset: number; byteLength: number };\n          buffer = Buffer.from(typed.buffer, typed.byteOffset, typed.byteLength);\n        } else if ('data' in rawBytes) {\n          const data = (rawBytes as any).data;\n          if (Buffer.isBuffer(data)) {\n            buffer = data;\n          } else if (Array.isArray(data)) {\n            buffer = Buffer.from(new Uint8Array(data));\n          } else {\n            buffer = Buffer.from(new Uint8Array(Object.values(data)));\n          }\n        } else {\n          const keys = Object.keys(rawBytes);\n          if (keys.length > 0 && keys.every(k => !isNaN(Number(k)))) {\n            const values = Object.values(rawBytes as unknown as Record<string, number>);\n            buffer = Buffer.from(new Uint8Array(values));\n          } else {\n            console.log('[FILE SERVE] Unknown object structure:', Object.keys(rawBytes).slice(0, 10));\n            return res.status(500).json({ message: \"Invalid file data format\" });\n          }\n        }\n      } else {\n        console.log('[FILE SERVE] Unknown bytes type:', typeof rawBytes);\n        return res.status(500).json({ message: \"Invalid file data format\" });\n      }\n      \n      console.log('[FILE SERVE] Success - path:', filePath, 'bytes:', buffer.length);\n\n      const ext = filePath.split('.').pop()?.toLowerCase() || '';\n      const mimeTypes: Record<string, string> = {\n        'jpg': 'image/jpeg',\n        'jpeg': 'image/jpeg',\n        'png': 'image/png',\n        'webp': 'image/webp',\n        'gif': 'image/gif',\n        'bmp': 'image/bmp',\n        'tiff': 'image/tiff',\n        'tif': 'image/tiff',\n        'heic': 'image/heic',\n        'heif': 'image/heif',\n        'avif': 'image/avif',\n        'svg': 'image/svg+xml',\n      };\n      \n      const contentType = mimeTypes[ext] || 'application/octet-stream';\n      res.setHeader('Content-Type', contentType);\n      res.setHeader('Content-Length', buffer.length);\n      res.setHeader('Cache-Control', 'public, max-age=31536000');\n      res.end(buffer);\n    } catch (error: any) {\n      console.error(\"[FILE SERVE] Error:\", error);\n      if (error.message?.includes('not found') || error.message?.includes('NotFound')) {\n        return res.status(404).json({ message: \"File not found\" });\n      }\n      res.status(500).json({ message: \"Failed to serve file\" });\n    }\n  });\n\n  // ========== FILE UPLOAD ==========\n  app.post('/api/upload', isAuthenticated, isAdminOrSales, upload.single('file'), async (req: any, res) => {\n    try {\n      if (!req.file) {\n        return res.status(400).json({ message: \"No file uploaded\" });\n      }\n\n      const file = req.file;\n      const allowedTypes = [\n        'image/jpeg', \n        'image/jpg',\n        'image/png', \n        'image/webp', \n        'image/gif',\n        'image/bmp',\n        'image/tiff',\n        'image/heic',\n        'image/heif',\n        'image/avif',\n        'image/svg+xml',\n        'application/octet-stream',\n      ];\n      \n      const fileExt = (file.originalname.split('.').pop() || '').toLowerCase();\n      const allowedExtensions = ['jpg', 'jpeg', 'png', 'webp', 'gif', 'bmp', 'tiff', 'tif', 'heic', 'heif', 'avif', 'svg'];\n      \n      const isValidMime = allowedTypes.includes(file.mimetype) || file.mimetype.startsWith('image/');\n      const isValidExt = allowedExtensions.includes(fileExt);\n      \n      if (!isValidMime && !isValidExt) {\n        return res.status(400).json({ \n          message: `Tipo de arquivo invalido (${file.mimetype}). Formatos aceitos: JPG, PNG, WebP, GIF, BMP, TIFF, HEIC, AVIF.` \n        });\n      }\n\n      const ext = file.originalname.split('.').pop() || 'jpg';\n      const filename = `public/products/${Date.now()}-${Math.random().toString(36).substring(2, 8)}.${ext}`;\n\n      const objectStorage = await getObjectStorage();\n      \n      // Convert Node.js Buffer to Uint8Array for object storage compatibility\n      console.log('[UPLOAD] File size:', file.buffer.length, 'bytes');\n      const uint8Array = new Uint8Array(file.buffer.buffer, file.buffer.byteOffset, file.buffer.length);\n      await objectStorage.uploadFromBytes(filename, uint8Array as any);\n      console.log('[UPLOAD] File uploaded successfully:', filename);\n\n      const publicUrl = `/api/files/${filename}`;\n      \n      res.json({ \n        url: publicUrl,\n        filename: filename\n      });\n    } catch (error) {\n      console.error(\"Error uploading file:\", error);\n      res.status(500).json({ message: \"Failed to upload file\" });\n    }\n  });\n\n  // ========== CATALOG IMAGE UPLOAD ==========\n  app.post('/api/upload/catalog', isAuthenticated, isAdmin, upload.single('file'), async (req: any, res) => {\n    try {\n      if (!req.file) {\n        return res.status(400).json({ message: \"No file uploaded\" });\n      }\n\n      const file = req.file;\n      const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/webp', 'image/gif'];\n      const fileExt = (file.originalname.split('.').pop() || '').toLowerCase();\n      const allowedExtensions = ['jpg', 'jpeg', 'png', 'webp', 'gif'];\n      \n      const isValidMime = allowedTypes.includes(file.mimetype) || file.mimetype.startsWith('image/');\n      const isValidExt = allowedExtensions.includes(fileExt);\n      \n      if (!isValidMime && !isValidExt) {\n        return res.status(400).json({ message: \"Tipo de arquivo invalido. Formatos aceitos: JPG, PNG, WebP, GIF.\" });\n      }\n\n      const ext = file.originalname.split('.').pop() || 'jpg';\n      const filename = `public/catalog/${Date.now()}-${Math.random().toString(36).substring(2, 8)}.${ext}`;\n\n      const objectStorage = await getObjectStorage();\n      const uint8Array = new Uint8Array(file.buffer.buffer, file.buffer.byteOffset, file.buffer.length);\n      await objectStorage.uploadFromBytes(filename, uint8Array as any);\n\n      const publicUrl = `/api/files/${filename}`;\n      res.json({ url: publicUrl, filename: filename });\n    } catch (error) {\n      console.error(\"Error uploading catalog image:\", error);\n      res.status(500).json({ message: \"Failed to upload file\" });\n    }\n  });\n\n  // ========== COUPONS ==========\n  app.get(\"/api/coupons\", isAuthenticated, isAdmin, async (req, res) => {\n    try {\n      const couponsList = await storage.getCoupons();\n      res.json(couponsList);\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to fetch coupons\" });\n    }\n  });\n\n  app.get(\"/api/coupons/:id\", isAuthenticated, isAdmin, async (req, res) => {\n    try {\n      const coupon = await storage.getCoupon(parseInt(req.params.id));\n      if (!coupon) {\n        return res.status(404).json({ message: \"Coupon not found\" });\n      }\n      res.json(coupon);\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to fetch coupon\" });\n    }\n  });\n\n  app.post(\"/api/coupons\", isAuthenticated, isAdmin, async (req, res) => {\n    try {\n      const data = insertCouponSchema.parse(req.body);\n      const coupon = await storage.createCoupon(data);\n      res.status(201).json(coupon);\n    } catch (error) {\n      res.status(400).json({ message: \"Invalid coupon data\" });\n    }\n  });\n\n  app.patch(\"/api/coupons/:id\", isAuthenticated, isAdmin, async (req, res) => {\n    try {\n      const coupon = await storage.updateCoupon(parseInt(req.params.id), req.body);\n      if (!coupon) {\n        return res.status(404).json({ message: \"Coupon not found\" });\n      }\n      res.json(coupon);\n    } catch (error) {\n      res.status(400).json({ message: \"Failed to update coupon\" });\n    }\n  });\n\n  app.delete(\"/api/coupons/:id\", isAuthenticated, isAdmin, async (req, res) => {\n    try {\n      await storage.deleteCoupon(parseInt(req.params.id));\n      res.status(204).send();\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to delete coupon\" });\n    }\n  });\n\n  app.post(\"/api/coupons/validate\", isAuthenticated, isApproved, async (req, res) => {\n    try {\n      const { code, orderTotal } = req.body;\n      const coupon = await storage.getCouponByCode(code);\n      \n      if (!coupon) {\n        return res.status(404).json({ valid: false, message: \"Cupom não encontrado\" });\n      }\n      \n      if (!coupon.active) {\n        return res.status(400).json({ valid: false, message: \"Cupom inativo\" });\n      }\n      \n      const now = new Date();\n      if (coupon.validFrom && new Date(coupon.validFrom) > now) {\n        return res.status(400).json({ valid: false, message: \"Cupom ainda não está válido\" });\n      }\n      if (coupon.validUntil && new Date(coupon.validUntil) < now) {\n        return res.status(400).json({ valid: false, message: \"Cupom expirado\" });\n      }\n      \n      if (coupon.maxUses && coupon.usedCount >= coupon.maxUses) {\n        return res.status(400).json({ valid: false, message: \"Cupom esgotado\" });\n      }\n      \n      if (coupon.minOrderValue && parseFloat(coupon.minOrderValue) > orderTotal) {\n        return res.status(400).json({ \n          valid: false, \n          message: `Pedido mínimo de R$ ${parseFloat(coupon.minOrderValue).toFixed(2)}` \n        });\n      }\n      \n      let discount = 0;\n      if (coupon.discountType === \"percent\") {\n        discount = orderTotal * (parseFloat(coupon.discountValue) / 100);\n      } else {\n        discount = Math.min(parseFloat(coupon.discountValue), orderTotal);\n      }\n      \n      res.json({\n        valid: true,\n        coupon: {\n          id: coupon.id,\n          code: coupon.code,\n          name: coupon.name,\n          discountType: coupon.discountType,\n          discountValue: coupon.discountValue,\n        },\n        discount: discount.toFixed(2),\n      });\n    } catch (error) {\n      res.status(500).json({ valid: false, message: \"Erro ao validar cupom\" });\n    }\n  });\n\n  // ========== BLING INTEGRATION ==========\n  app.get(\"/api/bling/status\", isAuthenticated, isAdmin, async (req, res) => {\n    res.json(blingService.getStatus());\n  });\n\n  app.post(\"/api/bling/webhook\", async (req: any, res) => {\n    const signature = req.headers[\"x-bling-signature-256\"] as string;\n    // Use rawBody captured by express.json() middleware in index.ts\n    const rawBody = req.rawBody ? req.rawBody.toString(\"utf8\") : JSON.stringify(req.body);\n\n    console.log(\"Bling webhook received:\");\n    console.log(\"- Signature header:\", signature ? `${signature.substring(0, 20)}...` : \"MISSING\");\n    console.log(\"- Payload preview:\", rawBody.substring(0, 300));\n\n    // Verify signature\n    if (signature) {\n      const isValid = blingService.verifyWebhookSignature(rawBody, signature);\n      console.log(\"- Signature valid:\", isValid);\n    }\n\n    try {\n      const payload = req.rawBody ? JSON.parse(rawBody) : req.body;\n      console.log(\"- Event:\", payload.event, \"- EventId:\", payload.eventId);\n      const result = await blingService.handleWebhook(payload);\n      console.log(\"- Result:\", result);\n      res.status(200).json(result);\n    } catch (error) {\n      console.error(\"Webhook processing error:\", error);\n      res.status(200).json({ success: false, message: \"Processing error\" });\n    }\n  });\n\n  app.get(\"/api/bling/auth\", isAuthenticated, isAdmin, (req, res) => {\n    const redirectUri = process.env.BLING_REDIRECT_URI || `https://${req.get(\"host\")}/api/bling/callback`;\n    console.log(\"Bling OAuth redirect_uri:\", redirectUri);\n    const authUrl = blingService.getAuthorizationUrl(redirectUri);\n    res.redirect(authUrl);\n  });\n\n  app.get(\"/api/bling/callback\", async (req, res) => {\n    const { code } = req.query;\n    const redirectUri = process.env.BLING_REDIRECT_URI || `https://${req.get(\"host\")}/api/bling/callback`;\n    try {\n      await blingService.exchangeCodeForTokens(code as string, redirectUri);\n      res.redirect(\"/bling?success=true\");\n    } catch (error) {\n      console.error(\"Bling callback error:\", error);\n      res.redirect(\"/bling?error=auth_failed\");\n    }\n  });\n\n  app.post(\"/api/bling/sync/categories\", isAuthenticated, isAdmin, async (req, res) => {\n    try {\n      const result = await blingService.syncCategories();\n      res.json(result);\n    } catch (error: any) {\n      console.error(\"Bling sync categories error:\", error);\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  app.post(\"/api/bling/sync/products\", isAuthenticated, isAdmin, async (req, res) => {\n    try {\n      const result = await blingService.syncProducts();\n      res.json(result);\n    } catch (error: any) {\n      console.error(\"Bling sync products error:\", error);\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  app.get(\"/api/bling/sync/progress\", isAuthenticated, isAdmin, (req, res) => {\n    res.setHeader(\"Content-Type\", \"text/event-stream\");\n    res.setHeader(\"Cache-Control\", \"no-cache\");\n    res.setHeader(\"Connection\", \"keep-alive\");\n    res.flushHeaders();\n\n    const sendProgress = (progress: blingService.SyncProgress) => {\n      res.write(`data: ${JSON.stringify(progress)}\\n\\n`);\n    };\n\n    const unsubscribe = blingService.subscribeSyncProgress(sendProgress);\n\n    req.on(\"close\", () => {\n      unsubscribe();\n    });\n  });\n\n  app.post(\"/api/bling/disconnect\", isAuthenticated, isAdmin, async (req, res) => {\n    try {\n      // Clear the access token to disconnect\n      delete process.env.BLING_ACCESS_TOKEN;\n      delete process.env.BLING_REFRESH_TOKEN;\n      res.json({ success: true, message: \"Desconectado do Bling\" });\n    } catch (error: any) {\n      console.error(\"Bling disconnect error:\", error);\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  // ========== BLING MANUAL IMPORT ==========\n  \n  // Preview Bling categories (without importing)\n  app.get(\"/api/bling/categories/preview\", isAuthenticated, isAdmin, async (req, res) => {\n    try {\n      const categories = await blingService.fetchBlingCategories();\n      res.json({ categories });\n    } catch (error: any) {\n      console.error(\"Bling fetch categories error:\", error);\n      res.status(500).json({ error: \"Falha ao buscar categorias do Bling\" });\n    }\n  });\n\n  // Import selected Bling categories\n  app.post(\"/api/bling/categories/import\", isAuthenticated, isAdmin, async (req, res) => {\n    try {\n      const { categoryIds } = req.body;\n      if (!categoryIds || !Array.isArray(categoryIds) || categoryIds.length === 0) {\n        return res.status(400).json({ error: \"categoryIds é obrigatório\" });\n      }\n      \n      const allCategories = await blingService.fetchBlingCategories();\n      const selectedCategories = allCategories.filter(c => categoryIds.includes(c.id));\n      \n      let created = 0;\n      let updated = 0;\n      \n      // Build map for parent resolution\n      const blingCatMap = new Map<number, typeof allCategories[0]>();\n      allCategories.forEach(c => blingCatMap.set(c.id, c));\n      const blingIdToLocalId: Record<number, number> = {};\n      \n      // Load existing categories\n      const existingCategories = await storage.getCategories();\n      existingCategories.forEach(c => {\n        if (c.blingId) {\n          blingIdToLocalId[c.blingId] = c.id;\n        }\n      });\n      \n      // Topological sort to process parents first\n      const topologicalSort = (cats: typeof selectedCategories): typeof selectedCategories => {\n        const sorted: typeof selectedCategories = [];\n        const visited = new Set<number>();\n        \n        function visit(cat: typeof cats[0]) {\n          if (visited.has(cat.id)) return;\n          visited.add(cat.id);\n          \n          const parentBlingId = cat.categoriaPai?.id;\n          if (parentBlingId && blingCatMap.has(parentBlingId)) {\n            const parent = blingCatMap.get(parentBlingId)!;\n            if (categoryIds.includes(parent.id)) {\n              visit(parent);\n            }\n          }\n          \n          sorted.push(cat);\n        }\n        \n        cats.forEach(c => visit(c));\n        return sorted;\n      }\n      \n      const sortedCategories = topologicalSort(selectedCategories);\n      \n      for (const cat of sortedCategories) {\n        const slug = cat.descricao\n          .toLowerCase()\n          .normalize(\"NFD\")\n          .replace(/[\\u0300-\\u036f]/g, \"\")\n          .replace(/[^a-z0-9]+/g, \"-\")\n          .replace(/(^-|-$)/g, \"\") || `cat-${cat.id}`;\n        \n        const parentBlingId = cat.categoriaPai?.id;\n        const parentLocalId = parentBlingId ? blingIdToLocalId[parentBlingId] || null : null;\n        \n        const existing = await storage.getCategoryByBlingId(cat.id);\n        \n        if (!existing) {\n          const newCat = await storage.createCategory({\n            name: cat.descricao,\n            slug,\n            parentId: parentLocalId,\n            blingId: cat.id,\n          });\n          blingIdToLocalId[cat.id] = newCat.id;\n          created++;\n        } else {\n          await storage.updateCategory(existing.id, {\n            name: cat.descricao,\n            slug,\n            parentId: parentLocalId,\n            blingId: cat.id,\n          });\n          blingIdToLocalId[cat.id] = existing.id;\n          updated++;\n        }\n      }\n      \n      res.json({ created, updated });\n    } catch (error: any) {\n      console.error(\"Bling import categories error:\", error);\n      res.status(500).json({ error: \"Falha ao importar categorias\" });\n    }\n  });\n\n  // Preview products from Bling (optionally filtered by category)\n  app.get(\"/api/bling/products/preview\", isAuthenticated, isAdmin, async (req, res) => {\n    try {\n      const allProducts: any[] = [];\n      let page = 1;\n      const limit = 100;\n      \n      // Fetch all product pages\n      while (true) {\n        await new Promise(resolve => setTimeout(resolve, 600));\n        const pageProducts = await blingService.fetchBlingProductsList(page, limit);\n        if (pageProducts.length === 0) break;\n        \n        // Only include active products\n        for (const p of pageProducts) {\n          if (p.situacao === \"A\") {\n            allProducts.push(p);\n          }\n        }\n        \n        if (pageProducts.length < limit) break;\n        page++;\n      }\n      \n      res.json({ products: allProducts });\n    } catch (error: any) {\n      console.error(\"Bling fetch products error:\", error);\n      res.status(500).json({ error: \"Falha ao buscar produtos do Bling\" });\n    }\n  });\n\n  // Import selected Bling products\n  app.post(\"/api/bling/products/import\", isAuthenticated, isAdmin, async (req, res) => {\n    try {\n      const { productIds } = req.body;\n      if (!productIds || !Array.isArray(productIds) || productIds.length === 0) {\n        return res.status(400).json({ error: \"productIds é obrigatório\" });\n      }\n      \n      // Load category mappings\n      const existingCategories = await storage.getCategories();\n      const blingIdToCategoryId: Record<number, number> = {};\n      const categoryMap: Record<string, number> = {};\n      existingCategories.forEach(c => {\n        categoryMap[c.name.toLowerCase()] = c.id;\n        if (c.blingId) {\n          blingIdToCategoryId[c.blingId] = c.id;\n        }\n      });\n      \n      let created = 0;\n      let updated = 0;\n      const errors: string[] = [];\n      \n      // Fetch stock from dedicated endpoint (more reliable)\n      console.log(`[import] Fetching stock for ${productIds.length} products...`);\n      const stockMap = await blingService.fetchBlingStock(productIds);\n      console.log(`[import] Got stock for ${stockMap.size} products. Non-zero: ${Array.from(stockMap.values()).filter(v => v > 0).length}`);\n      \n      for (const productId of productIds) {\n        await new Promise(resolve => setTimeout(resolve, 600));\n        \n        try {\n          const blingProduct = await blingService.fetchBlingProductDetails(productId);\n          if (!blingProduct) {\n            errors.push(`Produto ${productId}: Falha ao buscar detalhes`);\n            continue;\n          }\n          \n          let categoryId: number | null = null;\n          const blingCat = blingProduct.categoria;\n          if (blingCat && blingCat.id) {\n            categoryId = blingIdToCategoryId[blingCat.id] || null;\n            if (!categoryId && blingCat.descricao) {\n              categoryId = categoryMap[blingCat.descricao.toLowerCase()] || null;\n            }\n          }\n          \n          let imageUrl: string | null = null;\n          if (blingProduct.imagens && blingProduct.imagens.length > 0) {\n            const sortedImages = [...blingProduct.imagens].sort((a: any, b: any) => (a.ordem || 0) - (b.ordem || 0));\n            imageUrl = sortedImages[0]?.linkExterno || sortedImages[0]?.link || null;\n          }\n          if (!imageUrl && blingProduct.midia?.imagens?.externas?.[0]?.link) {\n            imageUrl = blingProduct.midia.imagens.externas[0].link;\n          }\n          if (!imageUrl && blingProduct.midia?.imagens?.internas?.[0]?.link) {\n            imageUrl = blingProduct.midia.imagens.internas[0].link;\n          }\n          \n          const description = blingProduct.descricaoComplementar || blingProduct.descricaoCurta || null;\n          // Get stock from dedicated endpoint first, fallback to product details\n          const stock = stockMap.get(productId) ?? blingProduct.estoque?.saldoVirtual ?? blingProduct.estoque?.saldoFisico ?? 0;\n          \n          const productData = {\n            name: blingProduct.nome,\n            sku: blingProduct.codigo || `BLING-${blingProduct.id}`,\n            categoryId,\n            brand: blingProduct.marca || null,\n            description,\n            price: String(blingProduct.preco || 0),\n            stock,\n            image: imageUrl,\n          };\n          \n          const existing = await storage.getProductBySku(productData.sku);\n          \n          if (!existing) {\n            await storage.createProduct(productData);\n            created++;\n          } else {\n            await storage.updateProduct(existing.id, productData);\n            updated++;\n          }\n        } catch (err: any) {\n          errors.push(`Produto ${productId}: ${err.message}`);\n        }\n      }\n      \n      res.json({ created, updated, errors });\n    } catch (error: any) {\n      console.error(\"Bling import products error:\", error);\n      res.status(500).json({ error: \"Falha ao importar produtos\" });\n    }\n  });\n\n  // ========== PDF GENERATION ==========\n  \n  // Helper function to draw standard PDF header\n  function drawPdfHeader(doc: typeof PDFDocument.prototype, pdfType: string, orderNumber: string) {\n    const titles: Record<string, string> = {\n      separacao: 'PEDIDO - SEPARACAO',\n      cobranca: 'PEDIDO - COBRANCA',\n      conferencia: 'PEDIDO - CONFERENCIA'\n    };\n    \n    doc.fontSize(14).font('Helvetica-Bold').text('LOJAMADRUGADAO SAO PAULO', { align: 'center' });\n    doc.fontSize(10).font('Helvetica').text('CNPJ: 00.000.000/0001-00 | WhatsApp: (11) 99284-5596', { align: 'center' });\n    doc.moveDown(0.3);\n    doc.moveTo(40, doc.y).lineTo(555, doc.y).stroke();\n    doc.moveDown(0.5);\n    doc.fontSize(16).font('Helvetica-Bold').text(`${titles[pdfType] || 'PEDIDO'}`, { align: 'center' });\n    doc.fontSize(12).text(`N. ${orderNumber}`, { align: 'center' });\n    doc.moveDown();\n  }\n\n  // Batch PDF - generates a single PDF with multiple orders\n  app.post('/api/orders/pdf/batch', isAuthenticated, isApproved, async (req: any, res) => {\n    try {\n      const { orderIds, type } = req.body;\n      \n      if (!orderIds || !Array.isArray(orderIds) || orderIds.length === 0) {\n        return res.status(400).json({ message: \"orderIds array is required\" });\n      }\n\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      const pdfType = type || 'cobranca';\n      \n      const pdfFileNames: Record<string, string> = {\n        separacao: 'SEPARACAO',\n        cobranca: 'COBRANCA',\n        conferencia: 'CONFERENCIA'\n      };\n\n      const doc = new PDFDocument({ margin: 40, size: 'A4' });\n      \n      const fileName = `${pdfFileNames[pdfType] || 'PDF'}_Lote_${new Date().toISOString().slice(0,10)}.pdf`;\n      res.setHeader('Content-Type', 'application/pdf');\n      res.setHeader('Content-Disposition', `attachment; filename=\"${fileName}\"`);\n      doc.pipe(res);\n\n      for (let i = 0; i < orderIds.length; i++) {\n        const orderId = orderIds[i];\n        const orderDetails = await storage.getOrderWithDetails(parseInt(orderId));\n        \n        if (!orderDetails) continue;\n        \n        if (user?.role === 'customer' && orderDetails.order.userId !== userId) {\n          continue;\n        }\n\n        const { order, items, customer } = orderDetails;\n\n        if (i > 0) {\n          doc.addPage();\n        }\n\n        // ========== PDF DE SEPARACAO ==========\n        if (pdfType === 'separacao') {\n          drawPdfHeader(doc, pdfType, order.orderNumber);\n          \n          // Info basica\n          doc.fontSize(10).font('Helvetica');\n          doc.text(`Cliente: ${customer?.tradingName || customer?.company || `${customer?.firstName || ''} ${customer?.lastName || ''}`.trim() || '-'}`, 40);\n          doc.text(`Data do Pedido: ${new Date(order.createdAt).toLocaleDateString('pt-BR')}`);\n          if (order.notes) {\n            doc.moveDown(0.3);\n            doc.font('Helvetica-Bold').text('Obs: ', { continued: true });\n            doc.font('Helvetica').text(order.notes);\n          }\n          doc.moveDown();\n\n          // Tabela de itens\n          doc.font('Helvetica-Bold').fontSize(10);\n          doc.moveTo(40, doc.y).lineTo(555, doc.y).stroke();\n          doc.moveDown(0.3);\n\n          const tableTop = doc.y;\n          const colCheck = 40;\n          const colImg = 65;\n          const colCode = 115;\n          const colProduct = 165;\n          const colQty = 480;\n\n          doc.text('OK', colCheck, tableTop);\n          doc.text('Foto', colImg, tableTop);\n          doc.text('SKU', colCode, tableTop);\n          doc.text('Produto', colProduct, tableTop);\n          doc.text('QTD', colQty, tableTop);\n\n          doc.moveTo(40, doc.y + 3).lineTo(555, doc.y + 3).stroke();\n          doc.moveDown(0.5);\n\n          doc.font('Helvetica').fontSize(9);\n          let totalQty = 0;\n          const imgHeight = 22;\n\n          for (const item of items) {\n            totalQty += item.quantity;\n\n            if (doc.y > 700) {\n              doc.addPage();\n            }\n\n            const rowY = doc.y;\n\n            // Checkbox grande\n            doc.rect(colCheck, rowY, 12, 12).stroke();\n            \n            // Foto do produto\n            if (item.product?.image) {\n              try {\n                const imgBuffer = await fetchImageBuffer(item.product.image);\n                if (imgBuffer) {\n                  doc.image(imgBuffer, colImg, rowY, { width: 22, height: imgHeight, fit: [22, imgHeight] });\n                }\n              } catch (e) {\n                doc.rect(colImg, rowY, 22, imgHeight).stroke();\n              }\n            } else {\n              doc.rect(colImg, rowY, 22, imgHeight).stroke();\n            }\n            \n            doc.text(item.product?.sku || '-', colCode, rowY + 6, { width: 45 });\n            doc.text(item.product?.name || `Produto #${item.productId}`, colProduct, rowY + 6, { width: 305 });\n            \n            // Quantidade em fonte grande e destacada\n            doc.font('Helvetica-Bold').fontSize(12);\n            doc.text(item.quantity.toString(), colQty, rowY + 4);\n            doc.font('Helvetica').fontSize(9);\n\n            doc.y = rowY + imgHeight + 3;\n          }\n\n          doc.moveTo(40, doc.y).lineTo(555, doc.y).stroke();\n          doc.moveDown();\n\n          doc.font('Helvetica-Bold').fontSize(11);\n          doc.text(`TOTAL DE ITENS: ${totalQty}`);\n          \n          // Rodape de separacao\n          doc.moveDown(3);\n          doc.fontSize(10).font('Helvetica');\n          doc.moveTo(40, doc.y).lineTo(555, doc.y).stroke();\n          doc.moveDown(0.5);\n          doc.text('Separado por: ________________________________     Data: ____/____/________');\n        }\n\n        // ========== PDF DE COBRANCA ==========\n        else if (pdfType === 'cobranca') {\n          drawPdfHeader(doc, pdfType, order.orderNumber);\n\n          // Dados do cliente completos\n          if (customer) {\n            doc.fontSize(10).font('Helvetica-Bold').text('DADOS DO CLIENTE');\n            doc.moveTo(40, doc.y).lineTo(555, doc.y).stroke();\n            doc.moveDown(0.3);\n\n            doc.font('Helvetica');\n            const col1X = 40;\n            const col2X = 300;\n\n            let y = doc.y;\n            const clientName = customer.tradingName || customer.company || `${customer.firstName || ''} ${customer.lastName || ''}`.trim();\n            doc.text(`Cliente: ${clientName}`, col1X, y);\n            \n            y = doc.y + 3;\n            if (customer.personType === 'juridica' && customer.cnpj) {\n              doc.text(`CNPJ: ${customer.cnpj}`, col1X, y);\n            } else if (customer.cpf) {\n              doc.text(`CPF: ${customer.cpf}`, col1X, y);\n            }\n            if (customer.stateRegistration) {\n              doc.text(`IE: ${customer.stateRegistration}`, col2X, y);\n            }\n\n            y = doc.y + 3;\n            let addressLine = '';\n            if (customer.address) {\n              addressLine = customer.address;\n              if (customer.addressNumber) addressLine += `, ${customer.addressNumber}`;\n              if (customer.complement) addressLine += ` - ${customer.complement}`;\n              if (customer.neighborhood) addressLine += ` - ${customer.neighborhood}`;\n            }\n            if (addressLine) {\n              doc.text(`Endereco: ${addressLine}`, col1X, y);\n            }\n\n            y = doc.y + 3;\n            if (customer.city || customer.state) {\n              doc.text(`${customer.city || ''} - ${customer.state || ''}`, col1X, y);\n            }\n            if (customer.cep) {\n              doc.text(`CEP: ${customer.cep}`, col2X, y);\n            }\n\n            y = doc.y + 3;\n            if (customer.phone) {\n              doc.text(`Tel: ${customer.phone}`, col1X, y);\n            }\n            if (customer.email) {\n              doc.text(`Email: ${customer.email}`, col2X, y);\n            }\n\n            doc.moveDown();\n          }\n\n          // Tabela de itens com precos\n          doc.font('Helvetica-Bold').fontSize(10);\n          doc.text('ITENS DO PEDIDO');\n          doc.moveTo(40, doc.y).lineTo(555, doc.y).stroke();\n          doc.moveDown(0.3);\n\n          const tableTop = doc.y;\n          const colCode = 40;\n          const colProduct = 90;\n          const colQty = 350;\n          const colPrice = 410;\n          const colSubtotal = 490;\n\n          doc.text('SKU', colCode, tableTop);\n          doc.text('Produto', colProduct, tableTop);\n          doc.text('Qtd', colQty, tableTop);\n          doc.text('Preco', colPrice, tableTop);\n          doc.text('Subtotal', colSubtotal, tableTop);\n\n          doc.moveTo(40, doc.y + 3).lineTo(555, doc.y + 3).stroke();\n          doc.moveDown(0.5);\n\n          doc.font('Helvetica').fontSize(9);\n          let totalQty = 0;\n\n          for (const item of items) {\n            const itemSubtotal = parseFloat(item.price) * item.quantity;\n            totalQty += item.quantity;\n\n            if (doc.y > 680) {\n              doc.addPage();\n            }\n\n            const rowY = doc.y;\n\n            doc.text(item.product?.sku || '-', colCode, rowY, { width: 45 });\n            doc.text(item.product?.name || `Produto #${item.productId}`, colProduct, rowY, { width: 255 });\n            doc.text(item.quantity.toString(), colQty, rowY);\n            doc.text(`R$ ${parseFloat(item.price).toFixed(2)}`, colPrice, rowY);\n            doc.text(`R$ ${itemSubtotal.toFixed(2)}`, colSubtotal, rowY);\n\n            doc.y = rowY + 15;\n          }\n\n          doc.moveTo(40, doc.y).lineTo(555, doc.y).stroke();\n          doc.moveDown();\n\n          // Box de totais destacado\n          doc.font('Helvetica').fontSize(10);\n          doc.text(`Quantidade Total: ${totalQty} itens`, 40);\n          doc.moveDown(0.5);\n\n          const boxX = 350;\n          const boxY = doc.y;\n          const boxWidth = 205;\n          const boxHeight = 70;\n          \n          doc.rect(boxX, boxY, boxWidth, boxHeight).stroke();\n          \n          doc.text(`Subtotal:`, boxX + 10, boxY + 8);\n          doc.text(`R$ ${parseFloat(order.subtotal || '0').toFixed(2)}`, boxX + 120, boxY + 8);\n          \n          doc.text(`Frete:`, boxX + 10, boxY + 23);\n          doc.text(`R$ ${parseFloat(order.shippingCost || '0').toFixed(2)}`, boxX + 120, boxY + 23);\n          \n          doc.moveTo(boxX + 5, boxY + 40).lineTo(boxX + boxWidth - 5, boxY + 40).stroke();\n          \n          doc.font('Helvetica-Bold').fontSize(12);\n          doc.text(`TOTAL:`, boxX + 10, boxY + 48);\n          doc.text(`R$ ${parseFloat(order.total).toFixed(2)}`, boxX + 100, boxY + 48);\n\n          doc.y = boxY + boxHeight + 15;\n\n          // Forma de pagamento\n          if (order.paymentMethod || order.paymentNotes) {\n            doc.font('Helvetica-Bold').fontSize(10).text('FORMA DE PAGAMENTO');\n            doc.font('Helvetica').fontSize(9);\n            if (order.paymentMethod) doc.text(order.paymentMethod);\n            if (order.paymentNotes) doc.text(order.paymentNotes);\n            doc.moveDown();\n          }\n\n          // Observacoes\n          if (order.notes) {\n            doc.font('Helvetica-Bold').fontSize(10).text('OBSERVACOES');\n            doc.font('Helvetica').fontSize(9).text(order.notes);\n            doc.moveDown();\n          }\n\n          // Rodape\n          doc.moveDown();\n          doc.fontSize(8).font('Helvetica');\n          doc.text(`Emissao: ${new Date(order.createdAt).toLocaleDateString('pt-BR')} | Este documento nao e fiscal.`, { align: 'center' });\n        }\n\n        // ========== PDF DE CONFERENCIA ==========\n        else if (pdfType === 'conferencia') {\n          drawPdfHeader(doc, pdfType, order.orderNumber);\n          \n          // Info basica\n          doc.fontSize(10).font('Helvetica');\n          doc.text(`Cliente: ${customer?.tradingName || customer?.company || `${customer?.firstName || ''} ${customer?.lastName || ''}`.trim() || '-'}`);\n          doc.text(`Data do Pedido: ${new Date(order.createdAt).toLocaleDateString('pt-BR')}`);\n          doc.moveDown();\n\n          // Tabela com 3 colunas\n          doc.font('Helvetica-Bold').fontSize(10);\n          doc.moveTo(40, doc.y).lineTo(555, doc.y).stroke();\n          doc.moveDown(0.3);\n\n          const tableTop = doc.y;\n          const colImg = 40;\n          const colCode = 90;\n          const colProduct = 140;\n          const colQtyPedido = 400;\n          const colQtyConferido = 490;\n\n          doc.text('Foto', colImg, tableTop);\n          doc.text('SKU', colCode, tableTop);\n          doc.text('Produto', colProduct, tableTop);\n          doc.text('Qtd', colQtyPedido, tableTop);\n          doc.text('Conferido', colQtyConferido, tableTop);\n\n          doc.moveTo(40, doc.y + 3).lineTo(555, doc.y + 3).stroke();\n          doc.moveDown(0.5);\n\n          doc.font('Helvetica').fontSize(9);\n          let totalQty = 0;\n          const imgHeight = 22;\n\n          for (const item of items) {\n            totalQty += item.quantity;\n\n            if (doc.y > 700) {\n              doc.addPage();\n            }\n\n            const rowY = doc.y;\n\n            // Foto do produto\n            if (item.product?.image) {\n              try {\n                const imgBuffer = await fetchImageBuffer(item.product.image);\n                if (imgBuffer) {\n                  doc.image(imgBuffer, colImg, rowY, { width: 22, height: imgHeight, fit: [22, imgHeight] });\n                }\n              } catch (e) {\n                doc.rect(colImg, rowY, 22, imgHeight).stroke();\n              }\n            } else {\n              doc.rect(colImg, rowY, 22, imgHeight).stroke();\n            }\n\n            doc.text(item.product?.sku || '-', colCode, rowY + 6, { width: 45 });\n            doc.text(item.product?.name || `Produto #${item.productId}`, colProduct, rowY + 6, { width: 250 });\n            \n            doc.font('Helvetica-Bold').fontSize(10);\n            doc.text(item.quantity.toString(), colQtyPedido + 10, rowY + 6);\n            doc.font('Helvetica').fontSize(9);\n            \n            // Campo vazio para preencher manualmente\n            doc.rect(colQtyConferido, rowY + 2, 35, 16).stroke();\n\n            doc.y = rowY + imgHeight + 3;\n          }\n\n          doc.moveTo(40, doc.y).lineTo(555, doc.y).stroke();\n          doc.moveDown();\n\n          doc.font('Helvetica-Bold').fontSize(10);\n          doc.text(`TOTAL DE ITENS: ${totalQty}`);\n\n          // Observacoes do pedido\n          if (order.notes) {\n            doc.moveDown();\n            doc.font('Helvetica-Bold').text('Observacoes do Pedido:');\n            doc.font('Helvetica').fontSize(9).text(order.notes);\n          }\n\n          // Area de conferencia\n          doc.moveDown(2);\n          doc.moveTo(40, doc.y).lineTo(555, doc.y).stroke();\n          doc.moveDown(0.5);\n\n          // Checkbox de conferencia\n          doc.rect(40, doc.y, 15, 15).stroke();\n          doc.font('Helvetica').fontSize(10).text('  Pedido conferido sem divergencias', 60, doc.y + 2);\n          \n          doc.moveDown(1.5);\n          doc.text('Conferido por: ________________________________');\n          doc.moveDown(0.5);\n          doc.text('Data/Hora: ____/____/________ - ____:____');\n          \n          doc.moveDown(1.5);\n          doc.fontSize(8).font('Helvetica-Bold');\n          doc.text('ATENCAO: Somente apos a conferencia o pedido pode ser enviado.', { align: 'center' });\n        }\n      }\n\n      doc.end();\n    } catch (error) {\n      console.error(\"Error generating batch PDF:\", error);\n      res.status(500).json({ message: \"Failed to generate batch PDF\" });\n    }\n  });\n\n  app.get('/api/orders/:id/pdf', isAuthenticated, isApproved, async (req: any, res) => {\n    try {\n      const orderDetails = await storage.getOrderWithDetails(parseInt(req.params.id));\n      if (!orderDetails) {\n        return res.status(404).json({ message: \"Order not found\" });\n      }\n\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n\n      // Customers can only see their own orders\n      if (user?.role === 'customer' && orderDetails.order.userId !== userId) {\n        return res.status(403).json({ message: \"Forbidden\" });\n      }\n\n      const { order, items, customer } = orderDetails;\n      \n      // PDF type: separacao, cobranca (default), conferencia\n      const pdfType = (req.query.type as string) || 'cobranca';\n      const showPrices = pdfType === 'cobranca';\n      const showCustomerDetails = pdfType !== 'conferencia';\n      \n      const pdfTitles: Record<string, string> = {\n        separacao: 'SEPARACAO',\n        cobranca: 'ORCAMENTO',\n        conferencia: 'CONFERENCIA'\n      };\n\n      // Create PDF document\n      const doc = new PDFDocument({ margin: 40, size: 'A4' });\n\n      const fileName = pdfType === 'cobranca' \n        ? `Orcamento_${order.orderNumber}.pdf`\n        : `${pdfTitles[pdfType] || 'PDF'}_${order.orderNumber}.pdf`;\n      \n      res.setHeader('Content-Type', 'application/pdf');\n      res.setHeader('Content-Disposition', `attachment; filename=\"${fileName}\"`);\n\n      doc.pipe(res);\n\n      // Header\n      doc.fontSize(16).font('Helvetica-Bold').text('LOJAMADRUGADAO SAO PAULO', { align: 'center' });\n      doc.fontSize(12).font('Helvetica').text('11 99284-5596', { align: 'center' });\n      doc.moveDown(0.5);\n      doc.fontSize(14).font('Helvetica-Bold').text(`${pdfTitles[pdfType] || 'ORCAMENTO'} N. ${order.orderNumber}`, { align: 'center' });\n      doc.moveDown();\n\n      // Customer Info (only for separacao and cobranca)\n      if (showCustomerDetails) {\n        doc.fontSize(10).font('Helvetica-Bold').text('DADOS DO CLIENTE');\n        doc.moveTo(40, doc.y).lineTo(555, doc.y).stroke();\n        doc.moveDown(0.3);\n\n        doc.font('Helvetica');\n        if (customer) {\n          const col1X = 40;\n          const col2X = 300;\n\n          let y = doc.y;\n          doc.text(`Cliente: ${customer.firstName || ''} ${customer.lastName || ''}`, col1X, y);\n          if (customer.company) {\n            doc.text(`Razao Social: ${customer.company}`, col2X, y);\n          }\n\n          y = doc.y + 5;\n          if (customer.tradingName) {\n            doc.text(`Nome Fantasia: ${customer.tradingName}`, col1X, y);\n          }\n          \n          y = doc.y + 5;\n          if (customer.personType === 'juridica' && customer.cnpj) {\n            doc.text(`CNPJ: ${customer.cnpj}`, col1X, y);\n          } else if (customer.cpf) {\n            doc.text(`CPF: ${customer.cpf}`, col1X, y);\n          }\n          if (customer.stateRegistration) {\n            doc.text(`Inscricao Estadual: ${customer.stateRegistration}`, col2X, y);\n          }\n\n          y = doc.y + 5;\n          let addressLine = '';\n          if (customer.address) {\n            addressLine = customer.address;\n            if (customer.addressNumber) addressLine += `, ${customer.addressNumber}`;\n            if (customer.complement) addressLine += ` - ${customer.complement}`;\n          }\n          if (addressLine) {\n            doc.text(`Endereco: ${addressLine}`, col1X, y);\n          }\n\n          y = doc.y + 5;\n          if (customer.neighborhood) {\n            doc.text(`Bairro: ${customer.neighborhood}`, col1X, y);\n          }\n          if (customer.cep) {\n            doc.text(`CEP: ${customer.cep}`, col2X, y);\n          }\n\n          y = doc.y + 5;\n          if (customer.city) {\n            doc.text(`Cidade: ${customer.city}`, col1X, y);\n          }\n          if (customer.state) {\n            doc.text(`Estado: ${customer.state}`, col2X, y);\n          }\n\n          y = doc.y + 5;\n          if (customer.phone) {\n            doc.text(`Telefone: ${customer.phone}`, col1X, y);\n          }\n          if (customer.email) {\n            doc.text(`E-mail: ${customer.email}`, col2X, y);\n          }\n        }\n\n        doc.moveDown(1.5);\n      }\n\n      // Items Table Header\n      doc.font('Helvetica-Bold').fontSize(10);\n      doc.text('ITENS DO PEDIDO');\n      doc.moveTo(40, doc.y).lineTo(555, doc.y).stroke();\n      doc.moveDown(0.3);\n\n      // Table header - adjusted columns for image\n      const tableTop = doc.y;\n      const colImg = 40;\n      const colCode = 90;\n      const colProduct = 140;\n      const colQty = showPrices ? 350 : 450;\n      const colPrice = 410;\n      const colSubtotal = 480;\n      const imgSize = 40;\n\n      doc.text('Img', colImg, tableTop);\n      doc.text('#', colCode, tableTop);\n      doc.text('Produto', colProduct, tableTop);\n      doc.text('Qtde.', colQty, tableTop);\n      if (showPrices) {\n        doc.text('Preco', colPrice, tableTop);\n        doc.text('Subtotal', colSubtotal, tableTop);\n      }\n\n      doc.moveTo(40, doc.y + 3).lineTo(555, doc.y + 3).stroke();\n      doc.moveDown(0.5);\n\n      // Items\n      doc.font('Helvetica').fontSize(9);\n      let totalQty = 0;\n\n      for (const item of items) {\n        const y = doc.y;\n        const itemSubtotal = parseFloat(item.price) * item.quantity;\n        totalQty += item.quantity;\n\n        // Check if we need a new page\n        if (y > 700) {\n          doc.addPage();\n        }\n\n        const rowY = doc.y;\n\n        // Try to add product image\n        if (item.product?.image) {\n          try {\n            const imageBuffer = await fetchImageBuffer(item.product.image);\n            if (imageBuffer) {\n              doc.image(imageBuffer, colImg, rowY, { width: imgSize, height: imgSize, fit: [imgSize, imgSize] });\n            }\n          } catch (imgErr) {\n            // If image fails, just skip it\n          }\n        }\n\n        doc.text(item.product?.sku || '-', colCode, rowY + 15, { width: 45 });\n        doc.text(item.product?.name || `Produto #${item.productId}`, colProduct, rowY + 15, { width: showPrices ? 205 : 305 });\n        doc.text(item.quantity.toString(), colQty, rowY + 15);\n        if (showPrices) {\n          doc.text(`R$ ${parseFloat(item.price).toFixed(2)}`, colPrice, rowY + 15);\n          doc.text(`R$ ${itemSubtotal.toFixed(2)}`, colSubtotal, rowY + 15);\n        }\n\n        // Move down based on image size\n        doc.y = rowY + imgSize + 5;\n      }\n\n      doc.moveTo(40, doc.y).lineTo(555, doc.y).stroke();\n      doc.moveDown();\n\n      // Totals (only for cobranca)\n      doc.font('Helvetica-Bold').fontSize(10);\n      doc.text(`Qtde. Total: ${totalQty}`, 40, doc.y);\n      \n      if (showPrices) {\n        const totalsX = 380;\n        doc.moveDown(0.3);\n        doc.text(`Total de Descontos: R$ 0,00`, totalsX);\n        doc.moveDown(0.3);\n        doc.text(`Valor do frete: R$ 0,00`, totalsX);\n        doc.moveDown(0.3);\n        doc.fontSize(12).text(`Valor Total: R$ ${parseFloat(order.total).toFixed(2)}`, totalsX);\n      }\n\n      doc.moveDown(2);\n\n      // Footer\n      doc.fontSize(9).font('Helvetica');\n      const footerY = doc.y;\n      doc.text(`Data de Emissao: ${new Date(order.createdAt).toLocaleDateString('pt-BR')}`, 40, footerY);\n      doc.text(`Status: ${order.status}`, 300, footerY);\n\n      if (order.notes) {\n        doc.moveDown();\n        doc.font('Helvetica-Bold').text('Observacoes:');\n        doc.font('Helvetica').text(order.notes);\n      }\n\n      doc.end();\n    } catch (error) {\n      console.error(\"Error generating PDF:\", error);\n      res.status(500).json({ message: \"Failed to generate PDF\" });\n    }\n  });\n\n  // ========== CATALOG BANNERS ==========\n  app.get(\"/api/catalog/banners\", async (req, res) => {\n    try {\n      const position = req.query.position as string | undefined;\n      const banners = await storage.getCatalogBanners(position);\n      res.json(banners);\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to fetch banners\" });\n    }\n  });\n\n  app.get(\"/api/catalog/banners/:id\", isAuthenticated, isAdmin, async (req, res) => {\n    try {\n      const banner = await storage.getCatalogBanner(parseInt(req.params.id));\n      if (!banner) {\n        return res.status(404).json({ message: \"Banner not found\" });\n      }\n      res.json(banner);\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to fetch banner\" });\n    }\n  });\n\n  app.post(\"/api/catalog/banners\", isAuthenticated, isAdmin, async (req, res) => {\n    try {\n      const data = insertCatalogBannerSchema.parse(req.body);\n      const banner = await storage.createCatalogBanner(data);\n      res.status(201).json(banner);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ message: \"Invalid banner data\", errors: error.errors });\n      }\n      res.status(500).json({ message: \"Failed to create banner\" });\n    }\n  });\n\n  app.patch(\"/api/catalog/banners/:id\", isAuthenticated, isAdmin, async (req, res) => {\n    try {\n      const banner = await storage.updateCatalogBanner(parseInt(req.params.id), req.body);\n      if (!banner) {\n        return res.status(404).json({ message: \"Banner not found\" });\n      }\n      res.json(banner);\n    } catch (error) {\n      res.status(400).json({ message: \"Failed to update banner\" });\n    }\n  });\n\n  app.delete(\"/api/catalog/banners/:id\", isAuthenticated, isAdmin, async (req, res) => {\n    try {\n      await storage.deleteCatalogBanner(parseInt(req.params.id));\n      res.status(204).send();\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to delete banner\" });\n    }\n  });\n\n  // ========== CATALOG SLIDES ==========\n  app.get(\"/api/catalog/slides\", async (req, res) => {\n    try {\n      const slides = await storage.getCatalogSlides();\n      res.json(slides);\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to fetch slides\" });\n    }\n  });\n\n  app.get(\"/api/catalog/slides/:id\", isAuthenticated, isAdmin, async (req, res) => {\n    try {\n      const slide = await storage.getCatalogSlide(parseInt(req.params.id));\n      if (!slide) {\n        return res.status(404).json({ message: \"Slide not found\" });\n      }\n      res.json(slide);\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to fetch slide\" });\n    }\n  });\n\n  app.post(\"/api/catalog/slides\", isAuthenticated, isAdmin, async (req, res) => {\n    try {\n      const data = insertCatalogSlideSchema.parse(req.body);\n      const slide = await storage.createCatalogSlide(data);\n      res.status(201).json(slide);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ message: \"Invalid slide data\", errors: error.errors });\n      }\n      res.status(500).json({ message: \"Failed to create slide\" });\n    }\n  });\n\n  app.patch(\"/api/catalog/slides/:id\", isAuthenticated, isAdmin, async (req, res) => {\n    try {\n      const slide = await storage.updateCatalogSlide(parseInt(req.params.id), req.body);\n      if (!slide) {\n        return res.status(404).json({ message: \"Slide not found\" });\n      }\n      res.json(slide);\n    } catch (error) {\n      res.status(400).json({ message: \"Failed to update slide\" });\n    }\n  });\n\n  app.delete(\"/api/catalog/slides/:id\", isAuthenticated, isAdmin, async (req, res) => {\n    try {\n      await storage.deleteCatalogSlide(parseInt(req.params.id));\n      res.status(204).send();\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to delete slide\" });\n    }\n  });\n\n  // ========== SUPPLIERS ==========\n  \n  app.get(\"/api/suppliers\", isAuthenticated, isAdminOrSales, async (req, res) => {\n    try {\n      const allSuppliers = await storage.getSuppliers();\n      res.json(allSuppliers);\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to fetch suppliers\" });\n    }\n  });\n\n  app.get(\"/api/suppliers/:id\", isAuthenticated, isAdminOrSales, async (req, res) => {\n    try {\n      const supplier = await storage.getSupplier(parseInt(req.params.id));\n      if (!supplier) {\n        return res.status(404).json({ message: \"Supplier not found\" });\n      }\n      res.json(supplier);\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to fetch supplier\" });\n    }\n  });\n\n  app.post(\"/api/suppliers\", isAuthenticated, isAdmin, async (req, res) => {\n    try {\n      const data = insertSupplierSchema.parse(req.body);\n      const supplier = await storage.createSupplier(data);\n      res.status(201).json(supplier);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ message: \"Invalid supplier data\", errors: error.errors });\n      }\n      res.status(500).json({ message: \"Failed to create supplier\" });\n    }\n  });\n\n  app.patch(\"/api/suppliers/:id\", isAuthenticated, isAdmin, async (req, res) => {\n    try {\n      const supplier = await storage.updateSupplier(parseInt(req.params.id), req.body);\n      if (!supplier) {\n        return res.status(404).json({ message: \"Supplier not found\" });\n      }\n      res.json(supplier);\n    } catch (error) {\n      res.status(400).json({ message: \"Failed to update supplier\" });\n    }\n  });\n\n  app.delete(\"/api/suppliers/:id\", isAuthenticated, isAdmin, async (req, res) => {\n    try {\n      await storage.deleteSupplier(parseInt(req.params.id));\n      res.status(204).send();\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to delete supplier\" });\n    }\n  });\n\n  // ========== MODULES (PERMISSION SYSTEM) ==========\n  \n  // Seed modules on server startup (internal function, not exposed to API)\n  async function seedModulesOnStartup() {\n    try {\n      const existingModules = await storage.getModules();\n      if (existingModules.length > 0) {\n        console.log(\"[MODULES] Modules already seeded, skipping...\");\n        return;\n      }\n\n      const defaultModules = [\n        { key: \"catalog\", label: \"Catalogo\", description: \"Visualizar catalogo de produtos\", icon: \"ShoppingBag\", defaultRoles: [\"admin\", \"sales\", \"customer\"], sortOrder: 1 },\n        { key: \"orders\", label: \"Pedidos\", description: \"Gerenciar pedidos\", icon: \"ShoppingCart\", defaultRoles: [\"admin\", \"sales\", \"customer\"], sortOrder: 2 },\n        { key: \"products\", label: \"Produtos\", description: \"Gerenciar produtos do catalogo\", icon: \"Package\", defaultRoles: [\"admin\", \"sales\"], sortOrder: 3 },\n        { key: \"customers\", label: \"Clientes\", description: \"Gerenciar clientes e usuarios\", icon: \"Users\", defaultRoles: [\"admin\", \"sales\"], sortOrder: 4 },\n        { key: \"financial_receivables\", label: \"Contas a Receber\", description: \"Gerenciar creditos e fiados\", icon: \"TrendingUp\", defaultRoles: [\"admin\", \"sales\"], sortOrder: 5 },\n        { key: \"financial_payables\", label: \"Contas a Pagar\", description: \"Gerenciar despesas e dividas\", icon: \"TrendingDown\", defaultRoles: [\"admin\"], sortOrder: 6 },\n        { key: \"reports\", label: \"Relatorios\", description: \"Visualizar relatorios e dashboards\", icon: \"BarChart3\", defaultRoles: [\"admin\"], sortOrder: 7 },\n        { key: \"settings\", label: \"Configuracoes\", description: \"Configuracoes do sistema\", icon: \"Settings\", defaultRoles: [\"admin\"], sortOrder: 8 },\n        { key: \"appearance\", label: \"Aparencia\", description: \"Personalizar aparencia do sistema\", icon: \"Palette\", defaultRoles: [\"admin\"], sortOrder: 9 },\n        { key: \"pdv\", label: \"PDV\", description: \"Ponto de Venda / Orcamento rapido\", icon: \"Monitor\", defaultRoles: [\"admin\", \"sales\"], sortOrder: 10 },\n        { key: \"agenda\", label: \"Agenda\", description: \"Calendario de eventos\", icon: \"Calendar\", defaultRoles: [\"admin\", \"sales\"], sortOrder: 11 },\n        { key: \"brands\", label: \"Marcas\", description: \"Visualizar analytics de marcas\", icon: \"Tag\", defaultRoles: [\"admin\", \"supplier\"], sortOrder: 12 },\n        { key: \"payments\", label: \"Pagamentos\", description: \"Gerenciar tipos de pagamento e integracoes\", icon: \"CreditCard\", defaultRoles: [\"admin\"], sortOrder: 13 },\n      ];\n\n      for (const mod of defaultModules) {\n        await storage.createModule(mod);\n      }\n      console.log(\"[MODULES] Default modules seeded successfully\");\n    } catch (error) {\n      console.error(\"[MODULES] Error seeding modules:\", error);\n    }\n  }\n  \n  // Run module seeding on startup\n  seedModulesOnStartup();\n\n  // Get all available modules\n  app.get(\"/api/modules\", isAuthenticated, isAdmin, async (req, res) => {\n    try {\n      const allModules = await storage.getModules();\n      res.json(allModules);\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to fetch modules\" });\n    }\n  });\n\n  // Get user's module permissions\n  app.get(\"/api/users/:id/permissions\", isAuthenticated, isAdmin, async (req, res) => {\n    try {\n      const userId = req.params.id;\n      const permissionKeys = await storage.getUserPermissionKeys(userId);\n      res.json({ userId, modules: permissionKeys });\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to fetch user permissions\" });\n    }\n  });\n\n  // Set user's module permissions\n  app.post(\"/api/users/:id/permissions\", isAuthenticated, isAdmin, async (req, res) => {\n    try {\n      const userId = req.params.id;\n      const { modules: moduleKeys } = req.body;\n      \n      if (!Array.isArray(moduleKeys)) {\n        return res.status(400).json({ message: \"modules must be an array of module keys\" });\n      }\n\n      await storage.setUserPermissions(userId, moduleKeys);\n      const updatedPermissions = await storage.getUserPermissionKeys(userId);\n      res.json({ userId, modules: updatedPermissions });\n    } catch (error) {\n      console.error(\"Error setting user permissions:\", error);\n      res.status(500).json({ message: \"Failed to set user permissions\" });\n    }\n  });\n\n  // Get current user's permissions (for frontend menu filtering)\n  app.get(\"/api/auth/permissions\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.id;\n      const user = await storage.getUser(userId);\n      \n      // Admin has access to everything\n      if (user?.role === \"admin\") {\n        const allModules = await storage.getModules();\n        return res.json({ modules: allModules.map(m => m.key), role: \"admin\" });\n      }\n\n      // Check if user has specific permissions set\n      const permissionKeys = await storage.getUserPermissionKeys(userId);\n      \n      // If user has specific permissions, use them\n      if (permissionKeys.length > 0) {\n        return res.json({ modules: permissionKeys, role: user?.role || \"customer\" });\n      }\n      \n      // Otherwise, use default roles from modules\n      const userRole = user?.role || \"customer\";\n      const allModules = await storage.getModules();\n      const defaultModules = allModules\n        .filter(m => m.defaultRoles?.includes(userRole))\n        .map(m => m.key);\n      \n      res.json({ modules: defaultModules, role: userRole });\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to fetch permissions\" });\n    }\n  });\n\n  // ========== PAYMENT TYPES ==========\n  \n  app.get(\"/api/payment-types\", isAuthenticated, async (req, res) => {\n    try {\n      const paymentTypes = await storage.getPaymentTypes();\n      res.json(paymentTypes);\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to fetch payment types\" });\n    }\n  });\n\n  app.get(\"/api/payment-types/:id\", isAuthenticated, isAdmin, async (req, res) => {\n    try {\n      const paymentType = await storage.getPaymentType(parseInt(req.params.id));\n      if (!paymentType) {\n        return res.status(404).json({ message: \"Payment type not found\" });\n      }\n      res.json(paymentType);\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to fetch payment type\" });\n    }\n  });\n\n  app.post(\"/api/payment-types\", isAuthenticated, isAdmin, async (req, res) => {\n    try {\n      const paymentType = await storage.createPaymentType(req.body);\n      res.status(201).json(paymentType);\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to create payment type\" });\n    }\n  });\n\n  app.patch(\"/api/payment-types/:id\", isAuthenticated, isAdmin, async (req, res) => {\n    try {\n      const paymentType = await storage.updatePaymentType(parseInt(req.params.id), req.body);\n      if (!paymentType) {\n        return res.status(404).json({ message: \"Payment type not found\" });\n      }\n      res.json(paymentType);\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to update payment type\" });\n    }\n  });\n\n  app.delete(\"/api/payment-types/:id\", isAuthenticated, isAdmin, async (req, res) => {\n    try {\n      await storage.deletePaymentType(parseInt(req.params.id));\n      res.status(204).send();\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to delete payment type\" });\n    }\n  });\n\n  // ========== PAYMENT INTEGRATIONS ==========\n  \n  app.get(\"/api/payment-integrations\", isAuthenticated, isAdmin, async (req, res) => {\n    try {\n      const integrations = await storage.getPaymentIntegrations();\n      res.json(integrations);\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to fetch payment integrations\" });\n    }\n  });\n\n  app.get(\"/api/payment-integrations/:id\", isAuthenticated, isAdmin, async (req, res) => {\n    try {\n      const integration = await storage.getPaymentIntegration(parseInt(req.params.id));\n      if (!integration) {\n        return res.status(404).json({ message: \"Integration not found\" });\n      }\n      res.json(integration);\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to fetch integration\" });\n    }\n  });\n\n  app.post(\"/api/payment-integrations\", isAuthenticated, isAdmin, async (req, res) => {\n    try {\n      const integration = await storage.createPaymentIntegration(req.body);\n      res.status(201).json(integration);\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to create integration\" });\n    }\n  });\n\n  app.patch(\"/api/payment-integrations/:id\", isAuthenticated, isAdmin, async (req, res) => {\n    try {\n      const integration = await storage.updatePaymentIntegration(parseInt(req.params.id), req.body);\n      if (!integration) {\n        return res.status(404).json({ message: \"Integration not found\" });\n      }\n      res.json(integration);\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to update integration\" });\n    }\n  });\n\n  app.delete(\"/api/payment-integrations/:id\", isAuthenticated, isAdmin, async (req, res) => {\n    try {\n      await storage.deletePaymentIntegration(parseInt(req.params.id));\n      res.status(204).send();\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to delete integration\" });\n    }\n  });\n\n  return httpServer;\n}\n","path":null,"size_bytes":130951,"size_tokens":null},"client/src/components/examples/OrderTableExample.tsx":{"content":"import { OrderTable } from \"../OrderTable\";\n\n// todo: remove mock functionality\nconst mockOrders = [\n  { id: \"1\", orderNumber: \"ORD-2024-001\", customer: \"Acme Corp\", date: \"Dec 10, 2024\", status: \"pending\" as const, total: 1250.00, itemCount: 5 },\n  { id: \"2\", orderNumber: \"ORD-2024-002\", customer: \"TechStart Inc\", date: \"Dec 9, 2024\", status: \"approved\" as const, total: 890.50, itemCount: 3 },\n  { id: \"3\", orderNumber: \"ORD-2024-003\", customer: \"BuildRight LLC\", date: \"Dec 8, 2024\", status: \"completed\" as const, total: 2340.00, itemCount: 12 },\n  { id: \"4\", orderNumber: \"ORD-2024-004\", customer: \"SafeWorks Co\", date: \"Dec 7, 2024\", status: \"cancelled\" as const, total: 450.00, itemCount: 2 },\n];\n\nexport default function OrderTableExample() {\n  return (\n    <OrderTable\n      orders={mockOrders}\n      onViewOrder={(o) => console.log(\"View:\", o.orderNumber)}\n      onEditOrder={(o) => console.log(\"Edit:\", o.orderNumber)}\n      onUpdateStatus={(o, s) => console.log(\"Update:\", o.orderNumber, \"to\", s)}\n    />\n  );\n}\n","path":null,"size_bytes":1025,"size_tokens":null},"server/vite.ts":{"content":"import { type Express } from \"express\";\nimport { createServer as createViteServer, createLogger } from \"vite\";\nimport { type Server } from \"http\";\nimport viteConfig from \"../vite.config\";\nimport fs from \"fs\";\nimport path from \"path\";\nimport { nanoid } from \"nanoid\";\n\nconst viteLogger = createLogger();\n\nexport async function setupVite(server: Server, app: Express) {\n  const serverOptions = {\n    middlewareMode: true,\n    hmr: { server, path: \"/vite-hmr\" },\n    allowedHosts: true as const,\n  };\n\n  const vite = await createViteServer({\n    ...viteConfig,\n    configFile: false,\n    customLogger: {\n      ...viteLogger,\n      error: (msg, options) => {\n        viteLogger.error(msg, options);\n        process.exit(1);\n      },\n    },\n    server: serverOptions,\n    appType: \"custom\",\n  });\n\n  app.use(vite.middlewares);\n\n  app.use(\"*\", async (req, res, next) => {\n    const url = req.originalUrl;\n\n    try {\n      const clientTemplate = path.resolve(\n        import.meta.dirname,\n        \"..\",\n        \"client\",\n        \"index.html\",\n      );\n\n      // always reload the index.html file from disk incase it changes\n      let template = await fs.promises.readFile(clientTemplate, \"utf-8\");\n      template = template.replace(\n        `src=\"/src/main.tsx\"`,\n        `src=\"/src/main.tsx?v=${nanoid()}\"`,\n      );\n      const page = await vite.transformIndexHtml(url, template);\n      res.status(200).set({ \"Content-Type\": \"text/html\" }).end(page);\n    } catch (e) {\n      vite.ssrFixStacktrace(e as Error);\n      next(e);\n    }\n  });\n}\n","path":null,"size_bytes":1534,"size_tokens":null},"client/src/components/ui/label.tsx":{"content":"import * as React from \"react\"\nimport * as LabelPrimitive from \"@radix-ui/react-label\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst labelVariants = cva(\n  \"text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70\"\n)\n\nconst Label = React.forwardRef<\n  React.ElementRef<typeof LabelPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof LabelPrimitive.Root> &\n    VariantProps<typeof labelVariants>\n>(({ className, ...props }, ref) => (\n  <LabelPrimitive.Root\n    ref={ref}\n    className={cn(labelVariants(), className)}\n    {...props}\n  />\n))\nLabel.displayName = LabelPrimitive.Root.displayName\n\nexport { Label }\n","path":null,"size_bytes":710,"size_tokens":null},"client/src/components/ui/slider.tsx":{"content":"import * as React from \"react\"\nimport * as SliderPrimitive from \"@radix-ui/react-slider\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Slider = React.forwardRef<\n  React.ElementRef<typeof SliderPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof SliderPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <SliderPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"relative flex w-full touch-none select-none items-center\",\n      className\n    )}\n    {...props}\n  >\n    <SliderPrimitive.Track className=\"relative h-2 w-full grow overflow-hidden rounded-full bg-secondary\">\n      <SliderPrimitive.Range className=\"absolute h-full bg-primary\" />\n    </SliderPrimitive.Track>\n    <SliderPrimitive.Thumb className=\"block h-5 w-5 rounded-full border-2 border-primary bg-background ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50\" />\n  </SliderPrimitive.Root>\n))\nSlider.displayName = SliderPrimitive.Root.displayName\n\nexport { Slider }\n","path":null,"size_bytes":1077,"size_tokens":null},"client/src/index.css":{"content":"@tailwind base;\n@tailwind components;\n@tailwind utilities;\n\n/* LIGHT MODE - Corporate Clean Design */\n:root {\n  --button-outline: rgba(0,0,0, .08);\n  --badge-outline: rgba(0,0,0, .04);\n  --opaque-button-border-intensity: -6;\n  --elevate-1: rgba(0,0,0, .025);\n  --elevate-2: rgba(0,0,0, .06);\n  --background: 220 14% 96%;\n  --foreground: 220 13% 13%;\n  --border: 220 13% 91%;\n  --card: 0 0% 100%;\n  --card-foreground: 220 13% 13%;\n  --card-border: 220 13% 90%;\n  --sidebar: 220 14% 98%;\n  --sidebar-foreground: 220 13% 13%;\n  --sidebar-border: 220 13% 91%;\n  --sidebar-primary: 221 83% 53%;\n  --sidebar-primary-foreground: 0 0% 100%;\n  --sidebar-accent: 220 14% 92%;\n  --sidebar-accent-foreground: 220 13% 13%;\n  --sidebar-ring: 221 83% 53%;\n  --popover: 0 0% 100%;\n  --popover-foreground: 220 13% 13%;\n  --popover-border: 220 13% 90%;\n  --primary: 221 83% 53%;\n  --primary-foreground: 0 0% 100%;\n  --secondary: 220 14% 94%;\n  --secondary-foreground: 220 13% 26%;\n  --muted: 220 14% 94%;\n  --muted-foreground: 220 9% 46%;\n  --accent: 220 14% 92%;\n  --accent-foreground: 220 13% 13%;\n  --destructive: 0 72% 51%;\n  --destructive-foreground: 0 0% 100%;\n  --success: 160 84% 39%;\n  --success-foreground: 0 0% 100%;\n  --warning: 38 92% 50%;\n  --warning-foreground: 0 0% 100%;\n  --input: 220 13% 91%;\n  --ring: 221 83% 53%;\n  --chart-1: 221 83% 53%;\n  --chart-2: 160 84% 39%;\n  --chart-3: 38 92% 50%;\n  --chart-4: 262 83% 58%;\n  --chart-5: 340 82% 52%;\n  --font-sans: 'Inter', system-ui, sans-serif;\n  --font-serif: 'Inter', system-ui, sans-serif;\n  --font-mono: 'JetBrains Mono', Menlo, monospace;\n  --radius: 0.5rem;\n  --shadow-2xs: 0 1px 2px 0 rgb(0 0 0 / 0.03);\n  --shadow-xs: 0 1px 2px 0 rgb(0 0 0 / 0.04);\n  --shadow-sm: 0 1px 3px 0 rgb(0 0 0 / 0.06), 0 1px 2px -1px rgb(0 0 0 / 0.06);\n  --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.08), 0 1px 2px -1px rgb(0 0 0 / 0.08);\n  --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.08), 0 2px 4px -2px rgb(0 0 0 / 0.06);\n  --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.08), 0 4px 6px -4px rgb(0 0 0 / 0.06);\n  --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.08), 0 8px 10px -6px rgb(0 0 0 / 0.06);\n  --shadow-2xl: 0 25px 50px -12px rgb(0 0 0 / 0.2);\n  --tracking-normal: 0em;\n  --spacing: 0.25rem;\n\n  --sidebar-primary-border: hsl(var(--sidebar-primary));\n  --sidebar-primary-border: hsl(from hsl(var(--sidebar-primary)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n  --sidebar-accent-border: hsl(var(--sidebar-accent));\n  --sidebar-accent-border: hsl(from hsl(var(--sidebar-accent)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n  --primary-border: hsl(var(--primary));\n  --primary-border: hsl(from hsl(var(--primary)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n  --secondary-border: hsl(var(--secondary));\n  --secondary-border: hsl(from hsl(var(--secondary)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n  --muted-border: hsl(var(--muted));\n  --muted-border: hsl(from hsl(var(--muted)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n  --accent-border: hsl(var(--accent));\n  --accent-border: hsl(from hsl(var(--accent)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n  --destructive-border: hsl(var(--destructive));\n  --destructive-border: hsl(from hsl(var(--destructive)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n}\n\n/* DARK MODE - Corporate Dark Design */\n.dark {\n  --button-outline: rgba(255,255,255, .08);\n  --badge-outline: rgba(255,255,255, .04);\n  --opaque-button-border-intensity: 8;\n  --elevate-1: rgba(255,255,255, .03);\n  --elevate-2: rgba(255,255,255, .07);\n  --background: 222 47% 11%;\n  --foreground: 210 40% 98%;\n  --border: 217 33% 17%;\n  --card: 222 47% 13%;\n  --card-foreground: 210 40% 98%;\n  --card-border: 217 33% 20%;\n  --sidebar: 222 47% 11%;\n  --sidebar-foreground: 210 40% 98%;\n  --sidebar-border: 217 33% 17%;\n  --sidebar-primary: 217 91% 60%;\n  --sidebar-primary-foreground: 0 0% 100%;\n  --sidebar-accent: 217 33% 17%;\n  --sidebar-accent-foreground: 210 40% 98%;\n  --sidebar-ring: 217 91% 60%;\n  --popover: 222 47% 13%;\n  --popover-foreground: 210 40% 98%;\n  --popover-border: 217 33% 20%;\n  --primary: 217 91% 60%;\n  --primary-foreground: 0 0% 100%;\n  --secondary: 217 33% 17%;\n  --secondary-foreground: 210 40% 98%;\n  --muted: 217 33% 17%;\n  --muted-foreground: 215 20% 65%;\n  --accent: 217 33% 17%;\n  --accent-foreground: 210 40% 98%;\n  --destructive: 0 72% 51%;\n  --destructive-foreground: 0 0% 100%;\n  --success: 160 84% 39%;\n  --success-foreground: 0 0% 100%;\n  --warning: 38 92% 50%;\n  --warning-foreground: 0 0% 100%;\n  --input: 217 33% 17%;\n  --ring: 217 91% 60%;\n  --chart-1: 217 91% 60%;\n  --chart-2: 160 84% 45%;\n  --chart-3: 38 92% 55%;\n  --chart-4: 262 83% 65%;\n  --chart-5: 340 82% 60%;\n  --shadow-2xs: 0 1px 2px 0 rgb(0 0 0 / 0.2);\n  --shadow-xs: 0 1px 2px 0 rgb(0 0 0 / 0.25);\n  --shadow-sm: 0 1px 3px 0 rgb(0 0 0 / 0.3), 0 1px 2px -1px rgb(0 0 0 / 0.3);\n  --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.35), 0 1px 2px -1px rgb(0 0 0 / 0.35);\n  --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.4), 0 2px 4px -2px rgb(0 0 0 / 0.35);\n  --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.45), 0 4px 6px -4px rgb(0 0 0 / 0.4);\n  --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.5), 0 8px 10px -6px rgb(0 0 0 / 0.45);\n  --shadow-2xl: 0 25px 50px -12px rgb(0 0 0 / 0.6);\n\n  --sidebar-primary-border: hsl(var(--sidebar-primary));\n  --sidebar-primary-border: hsl(from hsl(var(--sidebar-primary)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n  --sidebar-accent-border: hsl(var(--sidebar-accent));\n  --sidebar-accent-border: hsl(from hsl(var(--sidebar-accent)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n  --primary-border: hsl(var(--primary));\n  --primary-border: hsl(from hsl(var(--primary)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n  --secondary-border: hsl(var(--secondary));\n  --secondary-border: hsl(from hsl(var(--secondary)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n  --muted-border: hsl(var(--muted));\n  --muted-border: hsl(from hsl(var(--muted)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n  --accent-border: hsl(var(--accent));\n  --accent-border: hsl(from hsl(var(--accent)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n  --destructive-border: hsl(var(--destructive));\n  --destructive-border: hsl(from hsl(var(--destructive)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n}\n\n@layer base {\n  * {\n    @apply border-border;\n  }\n\n  body {\n    @apply font-sans antialiased bg-background text-foreground;\n  }\n\n  /* Improved scrollbar styling */\n  ::-webkit-scrollbar {\n    width: 8px;\n    height: 8px;\n  }\n\n  ::-webkit-scrollbar-track {\n    @apply bg-transparent;\n  }\n\n  ::-webkit-scrollbar-thumb {\n    @apply bg-muted-foreground/20 rounded-full;\n  }\n\n  ::-webkit-scrollbar-thumb:hover {\n    @apply bg-muted-foreground/30;\n  }\n}\n\n/**\n * Using the elevate system.\n * Automatic contrast adjustment.\n *\n * <element className=\"hover-elevate\" />\n * <element className=\"active-elevate-2\" />\n *\n * // Using the tailwind utility when a data attribute is \"on\"\n * <element className=\"toggle-elevate data-[state=on]:toggle-elevated\" />\n * // Or manually controlling the toggle state\n * <element className=\"toggle-elevate toggle-elevated\" />\n *\n * Elevation systems have to handle many states.\n * - not-hovered, vs. hovered vs. active  (three mutually exclusive states)\n * - toggled or not\n * - focused or not (this is not handled with these utilities)\n *\n * Even without handling focused or not, this is six possible combinations that\n * need to be distinguished from eachother visually.\n */\n@layer utilities {\n\n  /* Hide ugly search cancel button in Chrome until we can style it properly */\n  input[type=\"search\"]::-webkit-search-cancel-button {\n    @apply hidden;\n  }\n\n  /* Placeholder styling for contentEditable div */\n  [contenteditable][data-placeholder]:empty::before {\n    content: attr(data-placeholder);\n    color: hsl(var(--muted-foreground));\n    pointer-events: none;\n  }\n\n  /* .no-default-hover-elevate/no-default-active-elevate is an escape hatch so consumers of\n   * buttons/badges can remove the automatic brightness adjustment on interactions\n   * and program their own. */\n  .no-default-hover-elevate {}\n\n  .no-default-active-elevate {}\n\n\n  /**\n   * Toggleable backgrounds go behind the content. Hoverable/active goes on top.\n   * This way they can stack/compound. Both will overlap the parent's borders!\n   * So borders will be automatically adjusted both on toggle, and hover/active,\n   * and they will be compounded.\n   */\n  .toggle-elevate::before,\n  .toggle-elevate-2::before {\n    content: \"\";\n    pointer-events: none;\n    position: absolute;\n    inset: 0px;\n    /*border-radius: inherit;   match rounded corners */\n    border-radius: inherit;\n    z-index: -1;\n    /* sits behind content but above backdrop */\n  }\n\n  .toggle-elevate.toggle-elevated::before {\n    background-color: var(--elevate-2);\n  }\n\n  /* If there's a 1px border, adjust the inset so that it covers that parent's border */\n  .border.toggle-elevate::before {\n    inset: -1px;\n  }\n\n  /* Does not work on elements with overflow:hidden! */\n  .hover-elevate:not(.no-default-hover-elevate),\n  .active-elevate:not(.no-default-active-elevate),\n  .hover-elevate-2:not(.no-default-hover-elevate),\n  .active-elevate-2:not(.no-default-active-elevate) {\n    position: relative;\n    z-index: 0;\n  }\n\n  .hover-elevate:not(.no-default-hover-elevate)::after,\n  .active-elevate:not(.no-default-active-elevate)::after,\n  .hover-elevate-2:not(.no-default-hover-elevate)::after,\n  .active-elevate-2:not(.no-default-active-elevate)::after {\n    content: \"\";\n    pointer-events: none;\n    position: absolute;\n    inset: 0px;\n    /*border-radius: inherit;   match rounded corners */\n    border-radius: inherit;\n    z-index: 999;\n    /* sits in front of content */\n  }\n\n  .hover-elevate:hover:not(.no-default-hover-elevate)::after,\n  .active-elevate:active:not(.no-default-active-elevate)::after {\n    background-color: var(--elevate-1);\n  }\n\n  .hover-elevate-2:hover:not(.no-default-hover-elevate)::after,\n  .active-elevate-2:active:not(.no-default-active-elevate)::after {\n    background-color: var(--elevate-2);\n  }\n\n  /* If there's a 1px border, adjust the inset so that it covers that parent's border */\n  .border.hover-elevate:not(.no-hover-interaction-elevate)::after,\n  .border.active-elevate:not(.no-active-interaction-elevate)::after,\n  .border.hover-elevate-2:not(.no-hover-interaction-elevate)::after,\n  .border.active-elevate-2:not(.no-active-interaction-elevate)::after,\n  .border.hover-elevate:not(.no-hover-interaction-elevate)::after {\n    inset: -1px;\n  }\n\n  /* Smooth transitions for interactive elements */\n  .transition-colors {\n    transition-property: color, background-color, border-color;\n    transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);\n    transition-duration: 150ms;\n  }\n}\n","path":null,"size_bytes":10950,"size_tokens":null},"client/src/components/ui/table.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Table = React.forwardRef<\n  HTMLTableElement,\n  React.HTMLAttributes<HTMLTableElement>\n>(({ className, ...props }, ref) => (\n  <div className=\"relative w-full overflow-auto\">\n    <table\n      ref={ref}\n      className={cn(\"w-full caption-bottom text-sm\", className)}\n      {...props}\n    />\n  </div>\n))\nTable.displayName = \"Table\"\n\nconst TableHeader = React.forwardRef<\n  HTMLTableSectionElement,\n  React.HTMLAttributes<HTMLTableSectionElement>\n>(({ className, ...props }, ref) => (\n  <thead ref={ref} className={cn(\"[&_tr]:border-b\", className)} {...props} />\n))\nTableHeader.displayName = \"TableHeader\"\n\nconst TableBody = React.forwardRef<\n  HTMLTableSectionElement,\n  React.HTMLAttributes<HTMLTableSectionElement>\n>(({ className, ...props }, ref) => (\n  <tbody\n    ref={ref}\n    className={cn(\"[&_tr:last-child]:border-0\", className)}\n    {...props}\n  />\n))\nTableBody.displayName = \"TableBody\"\n\nconst TableFooter = React.forwardRef<\n  HTMLTableSectionElement,\n  React.HTMLAttributes<HTMLTableSectionElement>\n>(({ className, ...props }, ref) => (\n  <tfoot\n    ref={ref}\n    className={cn(\n      \"border-t bg-muted/50 font-medium [&>tr]:last:border-b-0\",\n      className\n    )}\n    {...props}\n  />\n))\nTableFooter.displayName = \"TableFooter\"\n\nconst TableRow = React.forwardRef<\n  HTMLTableRowElement,\n  React.HTMLAttributes<HTMLTableRowElement>\n>(({ className, ...props }, ref) => (\n  <tr\n    ref={ref}\n    className={cn(\n      \"border-b transition-colors hover:bg-muted/50 data-[state=selected]:bg-muted\",\n      className\n    )}\n    {...props}\n  />\n))\nTableRow.displayName = \"TableRow\"\n\nconst TableHead = React.forwardRef<\n  HTMLTableCellElement,\n  React.ThHTMLAttributes<HTMLTableCellElement>\n>(({ className, ...props }, ref) => (\n  <th\n    ref={ref}\n    className={cn(\n      \"h-12 px-4 text-left align-middle font-medium text-muted-foreground [&:has([role=checkbox])]:pr-0\",\n      className\n    )}\n    {...props}\n  />\n))\nTableHead.displayName = \"TableHead\"\n\nconst TableCell = React.forwardRef<\n  HTMLTableCellElement,\n  React.TdHTMLAttributes<HTMLTableCellElement>\n>(({ className, ...props }, ref) => (\n  <td\n    ref={ref}\n    className={cn(\"p-4 align-middle [&:has([role=checkbox])]:pr-0\", className)}\n    {...props}\n  />\n))\nTableCell.displayName = \"TableCell\"\n\nconst TableCaption = React.forwardRef<\n  HTMLTableCaptionElement,\n  React.HTMLAttributes<HTMLTableCaptionElement>\n>(({ className, ...props }, ref) => (\n  <caption\n    ref={ref}\n    className={cn(\"mt-4 text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nTableCaption.displayName = \"TableCaption\"\n\nexport {\n  Table,\n  TableHeader,\n  TableBody,\n  TableFooter,\n  TableHead,\n  TableRow,\n  TableCell,\n  TableCaption,\n}\n","path":null,"size_bytes":2765,"size_tokens":null},"client/src/pages/catalog.tsx":{"content":"import { useState, useMemo, useEffect } from \"react\";\nimport { useSearch } from \"wouter\";\nimport { CatalogFilters } from \"@/components/CatalogFilters\";\nimport { ProductGrid } from \"@/components/ProductGrid\";\nimport { DeliveryCatalog } from \"@/components/DeliveryCatalog\";\nimport { Loader2, Package, ChevronLeft, ChevronRight, Star } from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\nimport type { Product } from \"@/components/ProductCard\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport type { Product as SchemaProduct, Category, CatalogSlide, CatalogBanner } from \"@shared/schema\";\nimport { useCart } from \"@/contexts/CartContext\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport useEmblaCarousel from 'embla-carousel-react';\nimport Autoplay from 'embla-carousel-autoplay';\n\ninterface ProductsResponse {\n  products: SchemaProduct[];\n  total: number;\n  page: number;\n  totalPages: number;\n}\n\nexport default function CatalogPage() {\n  const searchString = useSearch();\n  const [searchQuery, setSearchQuery] = useState(\"\");\n  const [category, setCategory] = useState(\"all\");\n  const [brand, setBrand] = useState(\"all\");\n  const [page, setPage] = useState(1);\n  const [selectedCategoryId, setSelectedCategoryId] = useState<number | undefined>(undefined);\n  const { addItem } = useCart();\n  const { toast } = useToast();\n\n  const [emblaRef, emblaApi] = useEmblaCarousel({ loop: true }, [Autoplay({ delay: 5000 })]);\n  const [selectedSlideIndex, setSelectedSlideIndex] = useState(0);\n\n  const { data: slides = [] } = useQuery<CatalogSlide[]>({\n    queryKey: ['/api/catalog/slides'],\n  });\n\n  const { data: deliveryModeSetting } = useQuery<{ key: string; value: string | null }>({\n    queryKey: ['/api/settings/delivery_catalog_mode'],\n  });\n\n  const isDeliveryMode = deliveryModeSetting?.value === 'true';\n\n  const activeSlides = slides.filter(s => s.active);\n\n  useEffect(() => {\n    if (!emblaApi) return;\n    emblaApi.on('select', () => {\n      setSelectedSlideIndex(emblaApi.selectedScrollSnap());\n    });\n  }, [emblaApi]);\n\n  const handleAddToCart = (product: Product, quantity: number) => {\n    if (quantity <= 0) {\n      toast({\n        title: \"Informe a quantidade\",\n        description: \"Digite a quantidade desejada\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n    \n    addItem({\n      productId: product.id,\n      name: product.name,\n      sku: product.sku,\n      price: product.price,\n      quantity: quantity,\n      image: product.image || undefined,\n    });\n\n    toast({\n      title: \"Adicionado ao carrinho\",\n      description: `${quantity}x ${product.name}`,\n    });\n  };\n\n  const { data: categoriesData = [] } = useQuery<Category[]>({\n    queryKey: ['/api/categories'],\n  });\n\n  useEffect(() => {\n    const params = new URLSearchParams(searchString);\n    const categoryParam = params.get(\"category\");\n    if (categoryParam) {\n      const decodedCategory = decodeURIComponent(categoryParam);\n      setCategory(decodedCategory);\n      const cat = categoriesData.find(c => c.name === decodedCategory);\n      if (cat) {\n        setSelectedCategoryId(cat.id);\n      }\n    }\n  }, [searchString, categoriesData]);\n\n  useEffect(() => {\n    if (category === \"all\") {\n      setSelectedCategoryId(undefined);\n    } else {\n      const cat = categoriesData.find(c => c.name === category);\n      setSelectedCategoryId(cat?.id);\n    }\n    setPage(1);\n  }, [category, categoriesData]);\n\n  useEffect(() => {\n    setPage(1);\n  }, [searchQuery, brand]);\n\n  const queryParams = useMemo(() => {\n    const params = new URLSearchParams();\n    params.set('page', String(page));\n    params.set('limit', '50');\n    if (selectedCategoryId) params.set('categoryId', String(selectedCategoryId));\n    if (searchQuery) params.set('search', searchQuery);\n    return params.toString();\n  }, [page, selectedCategoryId, searchQuery]);\n\n  const { data: productsResponse, isLoading: productsLoading } = useQuery<ProductsResponse>({\n    queryKey: ['/api/products', queryParams],\n    queryFn: async () => {\n      const res = await fetch(`/api/products?${queryParams}`, { credentials: 'include' });\n      if (!res.ok) throw new Error('Failed to fetch products');\n      return res.json();\n    },\n  });\n\n  const productsData = productsResponse?.products || [];\n  const totalPages = productsResponse?.totalPages || 1;\n\n  const categoryMap = useMemo(() => {\n    const map: Record<number, string> = {};\n    categoriesData.forEach(cat => {\n      map[cat.id] = cat.name;\n    });\n    return map;\n  }, [categoriesData]);\n\n  const products: Product[] = useMemo(() => {\n    return productsData.map((p) => ({\n      id: String(p.id),\n      name: p.name,\n      sku: p.sku,\n      category: p.categoryId ? categoryMap[p.categoryId] || \"Sem categoria\" : \"Sem categoria\",\n      brand: p.brand || undefined,\n      price: parseFloat(p.price),\n      stock: p.stock,\n      image: p.image || undefined,\n      featured: p.featured || false,\n    }));\n  }, [productsData, categoryMap]);\n\n  const featuredProducts = useMemo(() => {\n    return products.filter(p => p.featured);\n  }, [products]);\n\n  const categories = useMemo(() => {\n    return categoriesData.map(c => c.name);\n  }, [categoriesData]);\n\n  const brands = useMemo(() => {\n    const brandSet = new Set<string>();\n    productsData.forEach(p => {\n      if (p.brand) brandSet.add(p.brand);\n    });\n    return Array.from(brandSet);\n  }, [productsData]);\n\n  const filteredProducts = useMemo(() => {\n    return products.filter((product) => {\n      const matchesBrand = brand === \"all\" || product.brand === brand;\n      const notFeatured = !product.featured;\n      return matchesBrand && notFeatured;\n    });\n  }, [products, brand]);\n\n  const filteredFeaturedProducts = useMemo(() => {\n    return featuredProducts.filter((product) => {\n      const matchesBrand = brand === \"all\" || product.brand === brand;\n      return matchesBrand;\n    });\n  }, [featuredProducts, brand]);\n\n  const clearFilters = () => {\n    setSearchQuery(\"\");\n    setCategory(\"all\");\n    setBrand(\"all\");\n  };\n\n  if (isDeliveryMode) {\n    return <DeliveryCatalog isPublic={false} />;\n  }\n\n  return (\n    <div className=\"space-y-4\">\n      {activeSlides.length > 0 && (\n        <div className=\"relative overflow-hidden\" ref={emblaRef}>\n          <div className=\"flex\">\n            {activeSlides.map((slide) => (\n              <div key={slide.id} className=\"flex-shrink-0 w-full relative\">\n                <div className=\"relative h-48 md:h-64 lg:h-80 w-full\">\n                  <img\n                    src={slide.imageUrl}\n                    alt={slide.title || 'Banner'}\n                    className=\"w-full h-full object-cover\"\n                    data-testid={`slide-image-${slide.id}`}\n                  />\n                  <div className=\"absolute inset-0 bg-gradient-to-r from-black/60 to-transparent\" />\n                  <div className=\"absolute inset-0 flex flex-col justify-center p-6 md:p-10 lg:p-16\">\n                    {slide.title && (\n                      <h2 className=\"text-white text-xl md:text-3xl lg:text-4xl font-bold mb-2\"\n                          data-testid={`slide-title-${slide.id}`}>\n                        {slide.title}\n                      </h2>\n                    )}\n                    {slide.subtitle && (\n                      <p className=\"text-white/90 text-sm md:text-base lg:text-lg mb-4 max-w-xl\"\n                         data-testid={`slide-subtitle-${slide.id}`}>\n                        {slide.subtitle}\n                      </p>\n                    )}\n                    {slide.buttonText && slide.buttonLink && (\n                      <a href={slide.buttonLink} data-testid={`slide-button-${slide.id}`}>\n                        <Button variant=\"default\" size=\"lg\">\n                          {slide.buttonText}\n                        </Button>\n                      </a>\n                    )}\n                  </div>\n                </div>\n              </div>\n            ))}\n          </div>\n          {activeSlides.length > 1 && (\n            <div className=\"absolute bottom-4 left-1/2 -translate-x-1/2 flex gap-2\">\n              {activeSlides.map((slide, index) => (\n                <button\n                  key={index}\n                  className={`w-2.5 h-2.5 rounded-full transition-colors ${\n                    index === selectedSlideIndex ? 'bg-white' : 'bg-white/50'\n                  }`}\n                  onClick={() => emblaApi?.scrollTo(index)}\n                  data-testid={`button-slide-indicator-${index}`}\n                  aria-label={`Ir para slide ${index + 1}: ${slide.title || 'Banner'}`}\n                />\n              ))}\n            </div>\n          )}\n        </div>\n      )}\n\n      <div className=\"p-4 lg:p-6 space-y-4\">\n        <div className=\"flex items-center justify-between gap-4 flex-wrap\">\n          <div>\n            <h1 className=\"text-2xl lg:text-3xl font-bold\">Catálogo</h1>\n            <p className=\"text-sm text-muted-foreground mt-0.5\">\n              Consulta de preços - {products.length} produtos disponíveis\n            </p>\n          </div>\n        </div>\n\n        <CatalogFilters\n          searchQuery={searchQuery}\n          onSearchChange={setSearchQuery}\n          category={category}\n          onCategoryChange={setCategory}\n          brand={brand}\n          onBrandChange={setBrand}\n          categories={categories}\n          brands={brands}\n          onClearFilters={clearFilters}\n        />\n\n        <div className=\"flex items-center justify-between text-sm\">\n          <p className=\"text-muted-foreground\">\n            {filteredProducts.length === products.length \n              ? `${products.length} produtos` \n              : `${filteredProducts.length} de ${products.length} produtos`}\n          </p>\n        </div>\n\n        {productsLoading ? (\n          <div className=\"flex flex-col items-center justify-center py-20\">\n            <Loader2 className=\"h-10 w-10 animate-spin text-primary mb-4\" />\n            <p className=\"text-muted-foreground\">Carregando produtos...</p>\n          </div>\n        ) : products.length === 0 ? (\n          <div className=\"flex flex-col items-center justify-center py-20 text-center\">\n            <div className=\"w-20 h-20 rounded-full bg-muted/50 flex items-center justify-center mb-4\">\n              <Package className=\"h-10 w-10 text-muted-foreground/50\" />\n            </div>\n            <h3 className=\"font-semibold text-lg mb-2\">Nenhum produto disponível</h3>\n            <p className=\"text-muted-foreground text-sm\">\n              Os produtos serão exibidos aqui quando forem cadastrados\n            </p>\n          </div>\n        ) : (\n          <>\n            {filteredFeaturedProducts.length > 0 && (\n              <div className=\"space-y-3 mb-6\">\n                <div className=\"flex items-center gap-2\">\n                  <Star className=\"h-5 w-5 fill-yellow-500 text-yellow-500\" />\n                  <h2 className=\"text-xl font-semibold\">Produtos em Destaque</h2>\n                </div>\n                <ProductGrid products={filteredFeaturedProducts} onAddToCart={handleAddToCart} />\n              </div>\n            )}\n            \n            <ProductGrid products={filteredProducts} onAddToCart={handleAddToCart} />\n            \n            {totalPages > 1 && (\n              <div className=\"flex items-center justify-center gap-2 pt-6\">\n                <Button\n                  variant=\"outline\"\n                  size=\"sm\"\n                  onClick={() => setPage(p => Math.max(1, p - 1))}\n                  disabled={page === 1}\n                  data-testid=\"button-prev-page\"\n                >\n                  <ChevronLeft className=\"h-4 w-4\" />\n                  Anterior\n                </Button>\n                <span className=\"text-sm text-muted-foreground px-4\">\n                  Página {page} de {totalPages}\n                </span>\n                <Button\n                  variant=\"outline\"\n                  size=\"sm\"\n                  onClick={() => setPage(p => Math.min(totalPages, p + 1))}\n                  disabled={page === totalPages}\n                  data-testid=\"button-next-page\"\n                >\n                  Próxima\n                  <ChevronRight className=\"h-4 w-4\" />\n                </Button>\n              </div>\n            )}\n          </>\n        )}\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":12328,"size_tokens":null},"client/src/components/ui/avatar.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as AvatarPrimitive from \"@radix-ui/react-avatar\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Avatar = React.forwardRef<\n  React.ElementRef<typeof AvatarPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <AvatarPrimitive.Root\n    ref={ref}\n    className={cn(`\n      after:content-[''] after:block after:absolute after:inset-0 after:rounded-full after:pointer-events-none after:border after:border-black/10 dark:after:border-white/10\n      relative flex h-10 w-10 shrink-0 overflow-hidden rounded-full`,\n      className\n    )}\n    {...props}\n  />\n))\nAvatar.displayName = AvatarPrimitive.Root.displayName\n\nconst AvatarImage = React.forwardRef<\n  React.ElementRef<typeof AvatarPrimitive.Image>,\n  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Image>\n>(({ className, ...props }, ref) => (\n  <AvatarPrimitive.Image\n    ref={ref}\n    className={cn(\"aspect-square h-full w-full\", className)}\n    {...props}\n  />\n))\nAvatarImage.displayName = AvatarPrimitive.Image.displayName\n\nconst AvatarFallback = React.forwardRef<\n  React.ElementRef<typeof AvatarPrimitive.Fallback>,\n  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Fallback>\n>(({ className, ...props }, ref) => (\n  <AvatarPrimitive.Fallback\n    ref={ref}\n    className={cn(\n      \"flex h-full w-full items-center justify-center rounded-full bg-muted\",\n      className\n    )}\n    {...props}\n  />\n))\nAvatarFallback.displayName = AvatarPrimitive.Fallback.displayName\n\nexport { Avatar, AvatarImage, AvatarFallback }\n","path":null,"size_bytes":1592,"size_tokens":null},"client/src/components/ThemeToggle.tsx":{"content":"import { Moon, Sun } from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\nimport { useTheme } from \"@/contexts/ThemeContext\";\n\nexport function ThemeToggle() {\n  const { theme, toggleTheme } = useTheme();\n\n  return (\n    <Button\n      variant=\"ghost\"\n      size=\"icon\"\n      onClick={toggleTheme}\n      data-testid=\"button-theme-toggle\"\n    >\n      {theme === \"light\" ? (\n        <Moon className=\"h-5 w-5\" />\n      ) : (\n        <Sun className=\"h-5 w-5\" />\n      )}\n    </Button>\n  );\n}\n","path":null,"size_bytes":503,"size_tokens":null},"client/src/components/examples/AppSidebarExample.tsx":{"content":"import { AppSidebar } from \"../AppSidebar\";\nimport { SidebarProvider, SidebarTrigger } from \"@/components/ui/sidebar\";\n\nexport default function AppSidebarExample() {\n  return (\n    <SidebarProvider>\n      <div className=\"flex h-[400px] w-full\">\n        <AppSidebar \n          userRole=\"admin\" \n          userName=\"John Admin\"\n          onLogout={() => console.log(\"Logout clicked\")}\n        />\n        <div className=\"flex-1 p-4\">\n          <SidebarTrigger />\n          <p className=\"mt-4 text-muted-foreground\">Main content area</p>\n        </div>\n      </div>\n    </SidebarProvider>\n  );\n}\n","path":null,"size_bytes":592,"size_tokens":null},"client/src/main.tsx":{"content":"import { createRoot } from \"react-dom/client\";\nimport App from \"./App\";\nimport \"./index.css\";\n\ncreateRoot(document.getElementById(\"root\")!).render(<App />);\n","path":null,"size_bytes":157,"size_tokens":null},"client/src/components/ui/carousel.tsx":{"content":"import * as React from \"react\"\nimport useEmblaCarousel, {\n  type UseEmblaCarouselType,\n} from \"embla-carousel-react\"\nimport { ArrowLeft, ArrowRight } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Button } from \"@/components/ui/button\"\n\ntype CarouselApi = UseEmblaCarouselType[1]\ntype UseCarouselParameters = Parameters<typeof useEmblaCarousel>\ntype CarouselOptions = UseCarouselParameters[0]\ntype CarouselPlugin = UseCarouselParameters[1]\n\ntype CarouselProps = {\n  opts?: CarouselOptions\n  plugins?: CarouselPlugin\n  orientation?: \"horizontal\" | \"vertical\"\n  setApi?: (api: CarouselApi) => void\n}\n\ntype CarouselContextProps = {\n  carouselRef: ReturnType<typeof useEmblaCarousel>[0]\n  api: ReturnType<typeof useEmblaCarousel>[1]\n  scrollPrev: () => void\n  scrollNext: () => void\n  canScrollPrev: boolean\n  canScrollNext: boolean\n} & CarouselProps\n\nconst CarouselContext = React.createContext<CarouselContextProps | null>(null)\n\nfunction useCarousel() {\n  const context = React.useContext(CarouselContext)\n\n  if (!context) {\n    throw new Error(\"useCarousel must be used within a <Carousel />\")\n  }\n\n  return context\n}\n\nconst Carousel = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement> & CarouselProps\n>(\n  (\n    {\n      orientation = \"horizontal\",\n      opts,\n      setApi,\n      plugins,\n      className,\n      children,\n      ...props\n    },\n    ref\n  ) => {\n    const [carouselRef, api] = useEmblaCarousel(\n      {\n        ...opts,\n        axis: orientation === \"horizontal\" ? \"x\" : \"y\",\n      },\n      plugins\n    )\n    const [canScrollPrev, setCanScrollPrev] = React.useState(false)\n    const [canScrollNext, setCanScrollNext] = React.useState(false)\n\n    const onSelect = React.useCallback((api: CarouselApi) => {\n      if (!api) {\n        return\n      }\n\n      setCanScrollPrev(api.canScrollPrev())\n      setCanScrollNext(api.canScrollNext())\n    }, [])\n\n    const scrollPrev = React.useCallback(() => {\n      api?.scrollPrev()\n    }, [api])\n\n    const scrollNext = React.useCallback(() => {\n      api?.scrollNext()\n    }, [api])\n\n    const handleKeyDown = React.useCallback(\n      (event: React.KeyboardEvent<HTMLDivElement>) => {\n        if (event.key === \"ArrowLeft\") {\n          event.preventDefault()\n          scrollPrev()\n        } else if (event.key === \"ArrowRight\") {\n          event.preventDefault()\n          scrollNext()\n        }\n      },\n      [scrollPrev, scrollNext]\n    )\n\n    React.useEffect(() => {\n      if (!api || !setApi) {\n        return\n      }\n\n      setApi(api)\n    }, [api, setApi])\n\n    React.useEffect(() => {\n      if (!api) {\n        return\n      }\n\n      onSelect(api)\n      api.on(\"reInit\", onSelect)\n      api.on(\"select\", onSelect)\n\n      return () => {\n        api?.off(\"select\", onSelect)\n      }\n    }, [api, onSelect])\n\n    return (\n      <CarouselContext.Provider\n        value={{\n          carouselRef,\n          api: api,\n          opts,\n          orientation:\n            orientation || (opts?.axis === \"y\" ? \"vertical\" : \"horizontal\"),\n          scrollPrev,\n          scrollNext,\n          canScrollPrev,\n          canScrollNext,\n        }}\n      >\n        <div\n          ref={ref}\n          onKeyDownCapture={handleKeyDown}\n          className={cn(\"relative\", className)}\n          role=\"region\"\n          aria-roledescription=\"carousel\"\n          {...props}\n        >\n          {children}\n        </div>\n      </CarouselContext.Provider>\n    )\n  }\n)\nCarousel.displayName = \"Carousel\"\n\nconst CarouselContent = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => {\n  const { carouselRef, orientation } = useCarousel()\n\n  return (\n    <div ref={carouselRef} className=\"overflow-hidden\">\n      <div\n        ref={ref}\n        className={cn(\n          \"flex\",\n          orientation === \"horizontal\" ? \"-ml-4\" : \"-mt-4 flex-col\",\n          className\n        )}\n        {...props}\n      />\n    </div>\n  )\n})\nCarouselContent.displayName = \"CarouselContent\"\n\nconst CarouselItem = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => {\n  const { orientation } = useCarousel()\n\n  return (\n    <div\n      ref={ref}\n      role=\"group\"\n      aria-roledescription=\"slide\"\n      className={cn(\n        \"min-w-0 shrink-0 grow-0 basis-full\",\n        orientation === \"horizontal\" ? \"pl-4\" : \"pt-4\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nCarouselItem.displayName = \"CarouselItem\"\n\nconst CarouselPrevious = React.forwardRef<\n  HTMLButtonElement,\n  React.ComponentProps<typeof Button>\n>(({ className, variant = \"outline\", size = \"icon\", ...props }, ref) => {\n  const { orientation, scrollPrev, canScrollPrev } = useCarousel()\n\n  return (\n    <Button\n      ref={ref}\n      variant={variant}\n      size={size}\n      className={cn(\n        \"absolute  h-8 w-8 rounded-full\",\n        orientation === \"horizontal\"\n          ? \"-left-12 top-1/2 -translate-y-1/2\"\n          : \"-top-12 left-1/2 -translate-x-1/2 rotate-90\",\n        className\n      )}\n      disabled={!canScrollPrev}\n      onClick={scrollPrev}\n      {...props}\n    >\n      <ArrowLeft className=\"h-4 w-4\" />\n      <span className=\"sr-only\">Previous slide</span>\n    </Button>\n  )\n})\nCarouselPrevious.displayName = \"CarouselPrevious\"\n\nconst CarouselNext = React.forwardRef<\n  HTMLButtonElement,\n  React.ComponentProps<typeof Button>\n>(({ className, variant = \"outline\", size = \"icon\", ...props }, ref) => {\n  const { orientation, scrollNext, canScrollNext } = useCarousel()\n\n  return (\n    <Button\n      ref={ref}\n      variant={variant}\n      size={size}\n      className={cn(\n        \"absolute h-8 w-8 rounded-full\",\n        orientation === \"horizontal\"\n          ? \"-right-12 top-1/2 -translate-y-1/2\"\n          : \"-bottom-12 left-1/2 -translate-x-1/2 rotate-90\",\n        className\n      )}\n      disabled={!canScrollNext}\n      onClick={scrollNext}\n      {...props}\n    >\n      <ArrowRight className=\"h-4 w-4\" />\n      <span className=\"sr-only\">Next slide</span>\n    </Button>\n  )\n})\nCarouselNext.displayName = \"CarouselNext\"\n\nexport {\n  type CarouselApi,\n  Carousel,\n  CarouselContent,\n  CarouselItem,\n  CarouselPrevious,\n  CarouselNext,\n}\n","path":null,"size_bytes":6210,"size_tokens":null},"client/src/hooks/use-toast.ts":{"content":"import * as React from \"react\"\n\nimport type {\n  ToastActionElement,\n  ToastProps,\n} from \"@/components/ui/toast\"\n\nconst TOAST_LIMIT = 1\nconst TOAST_REMOVE_DELAY = 1000000\n\ntype ToasterToast = ToastProps & {\n  id: string\n  title?: React.ReactNode\n  description?: React.ReactNode\n  action?: ToastActionElement\n}\n\nconst actionTypes = {\n  ADD_TOAST: \"ADD_TOAST\",\n  UPDATE_TOAST: \"UPDATE_TOAST\",\n  DISMISS_TOAST: \"DISMISS_TOAST\",\n  REMOVE_TOAST: \"REMOVE_TOAST\",\n} as const\n\nlet count = 0\n\nfunction genId() {\n  count = (count + 1) % Number.MAX_SAFE_INTEGER\n  return count.toString()\n}\n\ntype ActionType = typeof actionTypes\n\ntype Action =\n  | {\n      type: ActionType[\"ADD_TOAST\"]\n      toast: ToasterToast\n    }\n  | {\n      type: ActionType[\"UPDATE_TOAST\"]\n      toast: Partial<ToasterToast>\n    }\n  | {\n      type: ActionType[\"DISMISS_TOAST\"]\n      toastId?: ToasterToast[\"id\"]\n    }\n  | {\n      type: ActionType[\"REMOVE_TOAST\"]\n      toastId?: ToasterToast[\"id\"]\n    }\n\ninterface State {\n  toasts: ToasterToast[]\n}\n\nconst toastTimeouts = new Map<string, ReturnType<typeof setTimeout>>()\n\nconst addToRemoveQueue = (toastId: string) => {\n  if (toastTimeouts.has(toastId)) {\n    return\n  }\n\n  const timeout = setTimeout(() => {\n    toastTimeouts.delete(toastId)\n    dispatch({\n      type: \"REMOVE_TOAST\",\n      toastId: toastId,\n    })\n  }, TOAST_REMOVE_DELAY)\n\n  toastTimeouts.set(toastId, timeout)\n}\n\nexport const reducer = (state: State, action: Action): State => {\n  switch (action.type) {\n    case \"ADD_TOAST\":\n      return {\n        ...state,\n        toasts: [action.toast, ...state.toasts].slice(0, TOAST_LIMIT),\n      }\n\n    case \"UPDATE_TOAST\":\n      return {\n        ...state,\n        toasts: state.toasts.map((t) =>\n          t.id === action.toast.id ? { ...t, ...action.toast } : t\n        ),\n      }\n\n    case \"DISMISS_TOAST\": {\n      const { toastId } = action\n\n      // ! Side effects ! - This could be extracted into a dismissToast() action,\n      // but I'll keep it here for simplicity\n      if (toastId) {\n        addToRemoveQueue(toastId)\n      } else {\n        state.toasts.forEach((toast) => {\n          addToRemoveQueue(toast.id)\n        })\n      }\n\n      return {\n        ...state,\n        toasts: state.toasts.map((t) =>\n          t.id === toastId || toastId === undefined\n            ? {\n                ...t,\n                open: false,\n              }\n            : t\n        ),\n      }\n    }\n    case \"REMOVE_TOAST\":\n      if (action.toastId === undefined) {\n        return {\n          ...state,\n          toasts: [],\n        }\n      }\n      return {\n        ...state,\n        toasts: state.toasts.filter((t) => t.id !== action.toastId),\n      }\n  }\n}\n\nconst listeners: Array<(state: State) => void> = []\n\nlet memoryState: State = { toasts: [] }\n\nfunction dispatch(action: Action) {\n  memoryState = reducer(memoryState, action)\n  listeners.forEach((listener) => {\n    listener(memoryState)\n  })\n}\n\ntype Toast = Omit<ToasterToast, \"id\">\n\nfunction toast({ ...props }: Toast) {\n  const id = genId()\n\n  const update = (props: ToasterToast) =>\n    dispatch({\n      type: \"UPDATE_TOAST\",\n      toast: { ...props, id },\n    })\n  const dismiss = () => dispatch({ type: \"DISMISS_TOAST\", toastId: id })\n\n  dispatch({\n    type: \"ADD_TOAST\",\n    toast: {\n      ...props,\n      id,\n      open: true,\n      onOpenChange: (open) => {\n        if (!open) dismiss()\n      },\n    },\n  })\n\n  return {\n    id: id,\n    dismiss,\n    update,\n  }\n}\n\nfunction useToast() {\n  const [state, setState] = React.useState<State>(memoryState)\n\n  React.useEffect(() => {\n    listeners.push(setState)\n    return () => {\n      const index = listeners.indexOf(setState)\n      if (index > -1) {\n        listeners.splice(index, 1)\n      }\n    }\n  }, [state])\n\n  return {\n    ...state,\n    toast,\n    dismiss: (toastId?: string) => dispatch({ type: \"DISMISS_TOAST\", toastId }),\n  }\n}\n\nexport { useToast, toast }\n","path":null,"size_bytes":3895,"size_tokens":null},"client/src/components/ui/button.tsx":{"content":"import * as React from \"react\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst buttonVariants = cva(\n  \"inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\" +\n  \" hover-elevate active-elevate-2\",\n  {\n    variants: {\n      variant: {\n        default:\n          \"bg-primary text-primary-foreground border border-primary-border\",\n        destructive:\n          \"bg-destructive text-destructive-foreground border border-destructive-border\",\n        outline:\n          // Shows the background color of whatever card / sidebar / accent background it is inside of.\n          // Inherits the current text color.\n          \" border [border-color:var(--button-outline)]  shadow-xs active:shadow-none \",\n        secondary: \"border bg-secondary text-secondary-foreground border border-secondary-border \",\n        // Add a transparent border so that when someone toggles a border on later, it doesn't shift layout/size.\n        ghost: \"border border-transparent\",\n      },\n      // Heights are set as \"min\" heights, because sometimes Ai will place large amount of content\n      // inside buttons. With a min-height they will look appropriate with small amounts of content,\n      // but will expand to fit large amounts of content.\n      size: {\n        default: \"min-h-9 px-4 py-2\",\n        sm: \"min-h-8 rounded-md px-3 text-xs\",\n        lg: \"min-h-10 rounded-md px-8\",\n        icon: \"h-9 w-9\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n      size: \"default\",\n    },\n  },\n)\n\nexport interface ButtonProps\n  extends React.ButtonHTMLAttributes<HTMLButtonElement>,\n    VariantProps<typeof buttonVariants> {\n  asChild?: boolean\n}\n\nconst Button = React.forwardRef<HTMLButtonElement, ButtonProps>(\n  ({ className, variant, size, asChild = false, ...props }, ref) => {\n    const Comp = asChild ? Slot : \"button\"\n    return (\n      <Comp\n        className={cn(buttonVariants({ variant, size, className }))}\n        ref={ref}\n        {...props}\n      />\n    )\n  },\n)\nButton.displayName = \"Button\"\n\nexport { Button, buttonVariants }\n","path":null,"size_bytes":2359,"size_tokens":null},"client/src/pages/orders.tsx":{"content":"import { useState } from \"react\";\nimport { OrderTable, type Order } from \"@/components/OrderTable\";\nimport { useAuth } from \"@/contexts/AuthContext\";\nimport { Button } from \"@/components/ui/button\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Download, RefreshCw, Loader2, Package, Eye, Plus, Trash2, Search, X, User as UserIcon, Printer, Edit2, ShoppingCart } from \"lucide-react\";\nimport { SiWhatsapp } from \"react-icons/si\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\nimport type { Order as SchemaOrder, Product, User } from \"@shared/schema\";\nimport { format } from \"date-fns\";\nimport { ptBR } from \"date-fns/locale\";\nimport { Link } from \"wouter\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogHeader,\n  DialogTitle,\n  DialogTrigger,\n} from \"@/components/ui/dialog\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport {\n  DropdownMenu,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuTrigger,\n} from \"@/components/ui/dropdown-menu\";\n\nconst STORE_WHATSAPP = \"5511992845596\";\n\nfunction getWhatsAppLink(orderNumber: string): string {\n  const message = `Olá! Gostaria de falar sobre o pedido #${orderNumber}`;\n  return `https://wa.me/${STORE_WHATSAPP}?text=${encodeURIComponent(message)}`;\n}\n\ninterface OrderWithItems extends SchemaOrder {\n  items?: { id: number; quantity: number }[];\n}\n\nfunction getCustomerStatusLabel(status: string): string {\n  if (status === \"ORCAMENTO\") return \"Orçamento\";\n  if (status === \"PEDIDO_GERADO\") return \"Pedido Gerado\";\n  if (status === \"FATURADO\" || status === \"completed\") return \"Faturado\";\n  if (status === \"CANCELADO\" || status === \"cancelled\") return \"Cancelado\";\n  return \"Processando\";\n}\n\nfunction getCustomerStatusVariant(status: string): \"default\" | \"secondary\" | \"destructive\" {\n  if (status === \"FATURADO\" || status === \"completed\") return \"default\";\n  if (status === \"CANCELADO\" || status === \"cancelled\") return \"destructive\";\n  return \"secondary\";\n}\n\ninterface CartItem {\n  productId: number;\n  product: Product;\n  quantity: number;\n}\n\nexport default function OrdersPage() {\n  const { isAdmin, isSales } = useAuth();\n  const { toast } = useToast();\n  const [activeTab, setActiveTab] = useState(\"all\");\n  const [isCreateOpen, setIsCreateOpen] = useState(false);\n  const [selectedCustomerId, setSelectedCustomerId] = useState<string>(\"\");\n  const [selectedCustomer, setSelectedCustomer] = useState<User | null>(null);\n  const [customerSearch, setCustomerSearch] = useState(\"\");\n  const [cartItems, setCartItems] = useState<CartItem[]>([]);\n  const [productSearch, setProductSearch] = useState(\"\");\n  const [selectedOrders, setSelectedOrders] = useState<Set<string>>(new Set());\n  const [orderSearch, setOrderSearch] = useState(\"\");\n\n  const showAllOrders = isAdmin || isSales;\n\n  const { data: ordersData = [], isLoading, refetch } = useQuery<OrderWithItems[]>({\n    queryKey: ['/api/orders'],\n  });\n\n  const { data: customersData = [] } = useQuery<User[]>({\n    queryKey: ['/api/users'],\n    enabled: showAllOrders,\n  });\n\n  const { data: productsResponse } = useQuery<{ products: Product[]; total: number }>({\n    queryKey: ['/api/products'],\n    enabled: showAllOrders,\n  });\n\n  const productsData = productsResponse?.products || [];\n  const approvedCustomers = customersData.filter(u => u.approved && u.role === \"customer\");\n  const filteredCustomers = customerSearch.length > 0 \n    ? approvedCustomers.filter(c => \n        (c.firstName?.toLowerCase().includes(customerSearch.toLowerCase())) ||\n        (c.lastName?.toLowerCase().includes(customerSearch.toLowerCase())) ||\n        (c.company?.toLowerCase().includes(customerSearch.toLowerCase())) ||\n        (c.email?.toLowerCase().includes(customerSearch.toLowerCase())) ||\n        (c.tradingName?.toLowerCase().includes(customerSearch.toLowerCase()))\n      ).slice(0, 10)\n    : [];\n  const filteredProducts = productsData.filter(p => \n    p.name.toLowerCase().includes(productSearch.toLowerCase()) ||\n    p.sku.toLowerCase().includes(productSearch.toLowerCase())\n  ).slice(0, 10);\n\n  const createOrderMutation = useMutation({\n    mutationFn: async (data: { userId: string; items: { productId: number; quantity: number }[] }) => {\n      await apiRequest(\"POST\", \"/api/orders\", data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/orders'] });\n      setIsCreateOpen(false);\n      setSelectedCustomerId(\"\");\n      setSelectedCustomer(null);\n      setCustomerSearch(\"\");\n      setCartItems([]);\n      setProductSearch(\"\");\n      toast({ title: \"Sucesso\", description: \"Pedido criado com sucesso\" });\n    },\n    onError: (err: Error) => {\n      toast({ title: \"Erro\", description: err.message || \"Falha ao criar pedido\", variant: \"destructive\" });\n    },\n  });\n\n  const handleSelectCustomer = (customer: User) => {\n    setSelectedCustomerId(customer.id);\n    setSelectedCustomer(customer);\n    setCustomerSearch(\"\");\n  };\n\n  const handleClearCustomer = () => {\n    setSelectedCustomerId(\"\");\n    setSelectedCustomer(null);\n    setCustomerSearch(\"\");\n  };\n\n  const handleAddProduct = (product: Product) => {\n    const existing = cartItems.find(item => item.productId === product.id);\n    if (existing) {\n      setCartItems(cartItems.map(item => \n        item.productId === product.id \n          ? { ...item, quantity: item.quantity + 1 }\n          : item\n      ));\n    } else {\n      setCartItems([...cartItems, { productId: product.id, product, quantity: 1 }]);\n    }\n    setProductSearch(\"\");\n  };\n\n  const handleUpdateQuantity = (productId: number, quantity: number) => {\n    if (quantity <= 0) {\n      setCartItems(cartItems.filter(item => item.productId !== productId));\n    } else {\n      setCartItems(cartItems.map(item => \n        item.productId === productId ? { ...item, quantity } : item\n      ));\n    }\n  };\n\n  const handleRemoveItem = (productId: number) => {\n    setCartItems(cartItems.filter(item => item.productId !== productId));\n  };\n\n  const handleCreateOrder = () => {\n    if (!selectedCustomerId) {\n      toast({ title: \"Erro\", description: \"Selecione um cliente\", variant: \"destructive\" });\n      return;\n    }\n    if (cartItems.length === 0) {\n      toast({ title: \"Erro\", description: \"Adicione pelo menos um produto\", variant: \"destructive\" });\n      return;\n    }\n    createOrderMutation.mutate({\n      userId: selectedCustomerId,\n      items: cartItems.map(item => ({ productId: item.productId, quantity: item.quantity })),\n    });\n  };\n\n  const cartTotal = cartItems.reduce((sum, item) => sum + (parseFloat(item.product.price) * item.quantity), 0);\n\n  const orders: Order[] = ordersData.map((order: any) => ({\n    id: String(order.id),\n    orderNumber: order.orderNumber,\n    customer: order.customerName || order.userId.substring(0, 8) + \"...\",\n    date: format(new Date(order.createdAt), \"dd/MM/yyyy\", { locale: ptBR }),\n    status: order.status as Order[\"status\"],\n    stage: order.printed ? \"IMPRESSO\" : \"AGUARDANDO_IMPRESSAO\",\n    total: parseFloat(order.total),\n    itemCount: order.items?.reduce((sum: number, item: any) => sum + (item.quantity || 1), 0) || 0,\n    printed: order.printed || false,\n  }));\n\n  const newStatuses = [\"ORCAMENTO\", \"PEDIDO_GERADO\", \"COBRADO\", \"FATURADO\", \"PEDIDO_FATURADO\", \"CANCELADO\", \"PEDIDO_CANCELADO\"];\n  \n  const filteredOrders = orders.filter((order) => {\n    if (orderSearch.trim()) {\n      const search = orderSearch.toLowerCase();\n      const matchesSearch = \n        order.orderNumber.toLowerCase().includes(search) ||\n        order.customer.toLowerCase().includes(search);\n      if (!matchesSearch) return false;\n    }\n    if (activeTab === \"all\") return true;\n    if (activeTab === \"legacy\") return !newStatuses.includes(order.status);\n    if (activeTab === \"FATURADO\") return order.status === \"FATURADO\" || order.status === \"PEDIDO_FATURADO\";\n    if (activeTab === \"CANCELADO\") return order.status === \"CANCELADO\" || order.status === \"PEDIDO_CANCELADO\";\n    return order.status === activeTab;\n  });\n\n  const updateStatusMutation = useMutation({\n    mutationFn: async ({ orderId, status }: { orderId: string; status: string }) => {\n      await apiRequest(\"PATCH\", `/api/orders/${orderId}`, { status });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/orders'] });\n    },\n  });\n\n  const printOrderMutation = useMutation({\n    mutationFn: async (orderId: string) => {\n      await apiRequest(\"PATCH\", `/api/orders/${orderId}/print`, {});\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/orders'] });\n      toast({ title: \"Sucesso\", description: \"Pedido marcado como impresso\" });\n    },\n    onError: () => {\n      toast({ title: \"Erro\", description: \"Falha ao marcar como impresso\", variant: \"destructive\" });\n    },\n  });\n\n  const reserveStockMutation = useMutation({\n    mutationFn: async (orderId: string) => {\n      await apiRequest(\"POST\", `/api/orders/${orderId}/reserve`, {});\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/orders'] });\n      toast({ title: \"Sucesso\", description: \"Estoque reservado - Pedido gerado\" });\n    },\n    onError: (err: Error) => {\n      toast({ title: \"Erro\", description: err.message || \"Falha ao reservar estoque\", variant: \"destructive\" });\n    },\n  });\n\n  const invoiceMutation = useMutation({\n    mutationFn: async (orderId: string) => {\n      await apiRequest(\"POST\", `/api/orders/${orderId}/invoice`, {});\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/orders'] });\n      toast({ title: \"Sucesso\", description: \"Pedido faturado com sucesso\" });\n    },\n    onError: (err: Error) => {\n      toast({ title: \"Erro\", description: err.message || \"Falha ao faturar pedido\", variant: \"destructive\" });\n    },\n  });\n\n  const unreserveMutation = useMutation({\n    mutationFn: async (orderId: string) => {\n      await apiRequest(\"POST\", `/api/orders/${orderId}/unreserve`, {});\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/orders'] });\n      queryClient.invalidateQueries({ queryKey: ['/api/products'] });\n      toast({ title: \"Sucesso\", description: \"Pedido retornado para Orçamento - Estoque liberado\" });\n    },\n    onError: (err: Error) => {\n      toast({ title: \"Erro\", description: err.message || \"Falha ao retornar pedido\", variant: \"destructive\" });\n    },\n  });\n\n  const updateStageMutation = useMutation({\n    mutationFn: async ({ orderId, stage }: { orderId: string; stage: string }) => {\n      await apiRequest(\"PATCH\", `/api/orders/${orderId}/stage`, { stage });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/orders'] });\n      toast({ title: \"Sucesso\", description: \"Etapa atualizada\" });\n    },\n    onError: (err: Error) => {\n      toast({ title: \"Erro\", description: err.message || \"Falha ao atualizar etapa\", variant: \"destructive\" });\n    },\n  });\n\n  const handlePrintOrder = (order: Order) => {\n    printOrderMutation.mutate(order.id);\n  };\n\n  const handleReserveStock = (order: Order) => {\n    reserveStockMutation.mutate(order.id);\n  };\n\n  const handleInvoice = (order: Order) => {\n    invoiceMutation.mutate(order.id);\n  };\n\n  const handleUnreserve = (order: Order) => {\n    unreserveMutation.mutate(order.id);\n  };\n\n  const handleUpdateStage = (order: Order, stage: string) => {\n    updateStageMutation.mutate({ orderId: order.id, stage });\n  };\n\n  const handleSelectionChange = (orderId: string, selected: boolean) => {\n    setSelectedOrders(prev => {\n      const newSet = new Set(prev);\n      if (selected) {\n        newSet.add(orderId);\n      } else {\n        newSet.delete(orderId);\n      }\n      return newSet;\n    });\n  };\n\n  const handleSelectAll = (selected: boolean) => {\n    if (selected) {\n      setSelectedOrders(new Set(filteredOrders.map(o => o.id)));\n    } else {\n      setSelectedOrders(new Set());\n    }\n  };\n\n  const handleBatchPrint = async (pdfType: 'separacao' | 'cobranca' | 'conferencia') => {\n    if (selectedOrders.size === 0) {\n      toast({ title: \"Aviso\", description: \"Selecione pelo menos um pedido\", variant: \"destructive\" });\n      return;\n    }\n    const orderIds = Array.from(selectedOrders);\n    \n    try {\n      const response = await fetch('/api/orders/pdf/batch', {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        credentials: 'include',\n        body: JSON.stringify({ orderIds, type: pdfType })\n      });\n      \n      if (!response.ok) throw new Error('Failed to generate PDF');\n      \n      const blob = await response.blob();\n      const url = window.URL.createObjectURL(blob);\n      window.open(url, '_blank');\n      \n      await Promise.all(orderIds.map(orderId => \n        apiRequest(\"PATCH\", `/api/orders/${orderId}/print`, {})\n      ));\n      queryClient.invalidateQueries({ queryKey: ['/api/orders'] });\n      setSelectedOrders(new Set());\n      toast({ title: \"Sucesso\", description: `PDF gerado com ${orderIds.length} pedido(s)` });\n    } catch (e) {\n      toast({ title: \"Erro\", description: \"Falha ao gerar PDF\", variant: \"destructive\" });\n    }\n  };\n\n  const [isBatchStatusLoading, setIsBatchStatusLoading] = useState(false);\n  const [isBatchDeleteLoading, setIsBatchDeleteLoading] = useState(false);\n\n  const handleBatchDelete = async () => {\n    if (selectedOrders.size === 0) {\n      toast({ title: \"Aviso\", description: \"Selecione pelo menos um pedido\", variant: \"destructive\" });\n      return;\n    }\n    \n    if (!confirm(`Tem certeza que deseja excluir ${selectedOrders.size} pedido(s)? Esta ação não pode ser desfeita.`)) {\n      return;\n    }\n    \n    setIsBatchDeleteLoading(true);\n    const orderIds = Array.from(selectedOrders);\n    let successCount = 0;\n    let errorCount = 0;\n\n    for (const orderId of orderIds) {\n      try {\n        await apiRequest(\"DELETE\", `/api/orders/${orderId}`);\n        successCount++;\n      } catch (e) {\n        errorCount++;\n      }\n    }\n\n    queryClient.invalidateQueries({ queryKey: ['/api/orders'] });\n    queryClient.invalidateQueries({ queryKey: ['/api/products'] });\n    setSelectedOrders(new Set());\n    setIsBatchDeleteLoading(false);\n\n    if (errorCount === 0) {\n      toast({ title: \"Sucesso\", description: `${successCount} pedido(s) excluído(s) com sucesso` });\n    } else {\n      toast({ \n        title: \"Aviso\", \n        description: `${successCount} excluído(s), ${errorCount} erro(s)`,\n        variant: errorCount > 0 && successCount === 0 ? \"destructive\" : \"default\"\n      });\n    }\n  };\n\n  const handleBatchStatusChange = async (newStatus: string) => {\n    if (selectedOrders.size === 0) {\n      toast({ title: \"Aviso\", description: \"Selecione pelo menos um pedido\", variant: \"destructive\" });\n      return;\n    }\n    \n    setIsBatchStatusLoading(true);\n    const orderIds = Array.from(selectedOrders);\n    let successCount = 0;\n    let errorCount = 0;\n    const errorMessages: string[] = [];\n\n    for (const orderId of orderIds) {\n      try {\n        if (newStatus === \"PEDIDO_GERADO\") {\n          await apiRequest(\"POST\", `/api/orders/${orderId}/reserve`, {});\n        } else if (newStatus === \"FATURADO\") {\n          await apiRequest(\"POST\", `/api/orders/${orderId}/invoice`, {});\n        } else {\n          await apiRequest(\"PATCH\", `/api/orders/${orderId}`, { status: newStatus });\n        }\n        successCount++;\n      } catch (e: any) {\n        errorCount++;\n        const errorMsg = e.message || \"Erro desconhecido\";\n        const match = errorMsg.match(/\\d+:\\s*(.+)/);\n        if (match) {\n          try {\n            const parsed = JSON.parse(match[1]);\n            if (parsed.message) {\n              errorMessages.push(parsed.message);\n            }\n          } catch {\n            errorMessages.push(match[1]);\n          }\n        } else {\n          errorMessages.push(errorMsg);\n        }\n      }\n    }\n\n    queryClient.invalidateQueries({ queryKey: ['/api/orders'] });\n    queryClient.invalidateQueries({ queryKey: ['/api/products'] });\n    setSelectedOrders(new Set());\n    setIsBatchStatusLoading(false);\n\n    if (errorCount === 0) {\n      toast({ title: \"Sucesso\", description: `${successCount} pedido(s) atualizado(s) com sucesso` });\n    } else {\n      const uniqueErrors = [...new Set(errorMessages)].slice(0, 3);\n      toast({ \n        title: \"Erro ao gerar pedido\", \n        description: uniqueErrors.join(\" | \") || `${errorCount} pedido(s) com erro`,\n        variant: \"destructive\"\n      });\n    }\n  };\n\n  const handleUpdateStatus = (order: Order, status: string) => {\n    updateStatusMutation.mutate(\n      { orderId: order.id, status },\n      {\n        onSuccess: () => {\n          toast({\n            title: \"Pedido Atualizado\",\n            description: `Pedido ${order.orderNumber} marcado como ${status}`,\n          });\n        },\n        onError: () => {\n          toast({\n            title: \"Erro\",\n            description: \"Falha ao atualizar status do pedido\",\n            variant: \"destructive\",\n          });\n        },\n      }\n    );\n  };\n\n  const handleExport = async () => {\n    try {\n      const response = await fetch(\"/api/orders/export/csv\", {\n        credentials: \"include\",\n      });\n      \n      if (!response.ok) {\n        throw new Error(\"Export failed\");\n      }\n      \n      const blob = await response.blob();\n      const url = window.URL.createObjectURL(blob);\n      const a = document.createElement(\"a\");\n      a.href = url;\n      a.download = \"orders.csv\";\n      document.body.appendChild(a);\n      a.click();\n      window.URL.revokeObjectURL(url);\n      document.body.removeChild(a);\n      \n      toast({\n        title: \"Exportação Concluída\",\n        description: \"Os pedidos foram exportados para CSV\",\n      });\n    } catch (error) {\n      toast({\n        title: \"Falha na Exportação\",\n        description: \"Não foi possível exportar os pedidos\",\n        variant: \"destructive\",\n      });\n    }\n  };\n\n  if (!showAllOrders) {\n    return (\n      <div className=\"p-6 lg:p-8 space-y-6\">\n        <div className=\"flex items-center justify-between gap-4 flex-wrap\">\n          <div>\n            <h1 className=\"text-3xl font-semibold\">Meus Pedidos</h1>\n            <p className=\"text-muted-foreground mt-1\">\n              Visualize e acompanhe seu histórico de pedidos\n            </p>\n          </div>\n          <Button variant=\"outline\" onClick={() => refetch()} data-testid=\"button-refresh-orders\">\n            <RefreshCw className=\"h-4 w-4 mr-2\" />\n            Atualizar\n          </Button>\n        </div>\n\n        {isLoading ? (\n          <div className=\"flex items-center justify-center py-12\">\n            <Loader2 className=\"h-8 w-8 animate-spin text-muted-foreground\" />\n          </div>\n        ) : orders.length === 0 ? (\n          <div className=\"text-center py-12 text-muted-foreground\">\n            <Package className=\"h-12 w-12 mx-auto mb-4 opacity-50\" />\n            <p>Você ainda não tem pedidos</p>\n            <p className=\"text-sm mt-1\">Adicione produtos ao carrinho para fazer seu primeiro pedido</p>\n          </div>\n        ) : (\n          <div className=\"space-y-4\">\n            {orders.map((order) => (\n              <Card key={order.id} data-testid={`card-order-${order.id}`}>\n                <CardContent className=\"p-4\">\n                  <div className=\"flex items-center justify-between gap-4 flex-wrap\">\n                    <div className=\"flex-1 min-w-0\">\n                      <div className=\"flex items-center gap-3 flex-wrap\">\n                        <span className=\"font-semibold\" data-testid={`text-order-number-${order.id}`}>\n                          {order.orderNumber}\n                        </span>\n                        <Badge \n                          variant={getCustomerStatusVariant(order.status)}\n                          data-testid={`badge-status-${order.id}`}\n                        >\n                          {getCustomerStatusLabel(order.status)}\n                        </Badge>\n                      </div>\n                      <p className=\"text-sm text-muted-foreground mt-1\">\n                        {format(new Date(ordersData.find(o => String(o.id) === order.id)?.createdAt || new Date()), \"dd 'de' MMMM 'de' yyyy\", { locale: ptBR })}\n                      </p>\n                    </div>\n                    <div className=\"text-right\">\n                      <p className=\"font-semibold text-lg\">R$ {order.total.toFixed(2)}</p>\n                      <p className=\"text-sm text-muted-foreground\">{order.itemCount} itens</p>\n                    </div>\n                    <div className=\"flex items-center gap-2\">\n                      <Link href={`/orders/${order.id}`}>\n                        <Button variant=\"outline\" size=\"sm\" data-testid={`button-view-order-${order.id}`}>\n                          <Eye className=\"h-4 w-4 mr-2\" />\n                          Ver detalhes\n                        </Button>\n                      </Link>\n                      <a \n                        href={getWhatsAppLink(order.orderNumber)} \n                        target=\"_blank\" \n                        rel=\"noopener noreferrer\"\n                      >\n                        <Button \n                          variant=\"outline\" \n                          size=\"sm\" \n                          className=\"text-green-600 dark:text-green-500 border-green-600 dark:border-green-500\"\n                          data-testid={`button-whatsapp-order-${order.id}`}\n                        >\n                          <SiWhatsapp className=\"h-4 w-4 mr-2\" />\n                          WhatsApp\n                        </Button>\n                      </a>\n                    </div>\n                  </div>\n                </CardContent>\n              </Card>\n            ))}\n          </div>\n        )}\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"p-6 lg:p-8 space-y-6\">\n      <div className=\"flex items-center justify-between gap-4 flex-wrap\">\n        <div>\n          <h1 className=\"text-3xl font-semibold\">Todos os Pedidos</h1>\n          <p className=\"text-muted-foreground mt-1\">\n            Gerencie e acompanhe todos os pedidos de clientes\n          </p>\n        </div>\n        <div className=\"flex gap-2 flex-wrap\">\n          <Link href=\"/pdv\">\n            <Button variant=\"default\" className=\"bg-orange-500 hover:bg-orange-600\" data-testid=\"button-pdv\">\n              <ShoppingCart className=\"h-4 w-4 mr-2\" />\n              Gerar Pedido PDV\n            </Button>\n          </Link>\n          <Dialog open={isCreateOpen} onOpenChange={setIsCreateOpen}>\n            <DialogTrigger asChild>\n              <Button variant=\"outline\" data-testid=\"button-create-order\">\n                <Plus className=\"h-4 w-4 mr-2\" />\n                Criar Pedido\n              </Button>\n            </DialogTrigger>\n            <DialogContent className=\"max-w-2xl max-h-[90vh] overflow-hidden flex flex-col\">\n              <DialogHeader>\n                <DialogTitle>Criar Novo Pedido</DialogTitle>\n                <DialogDescription>\n                  Selecione o cliente e adicione os produtos\n                </DialogDescription>\n              </DialogHeader>\n              <div className=\"flex-1 overflow-auto space-y-4 py-4\">\n                <div className=\"space-y-2\">\n                  <Label>Cliente *</Label>\n                  {selectedCustomer ? (\n                    <div className=\"flex items-center gap-2 p-3 border rounded-md bg-muted/50\">\n                      <UserIcon className=\"h-4 w-4 text-muted-foreground\" />\n                      <div className=\"flex-1 min-w-0\">\n                        <p className=\"text-sm font-medium truncate\" data-testid=\"text-selected-customer\">\n                          {selectedCustomer.firstName} {selectedCustomer.lastName}\n                        </p>\n                        <p className=\"text-xs text-muted-foreground truncate\">\n                          {selectedCustomer.company || selectedCustomer.tradingName || selectedCustomer.email}\n                        </p>\n                      </div>\n                      <Button\n                        variant=\"ghost\"\n                        size=\"icon\"\n                        onClick={handleClearCustomer}\n                        data-testid=\"button-clear-customer\"\n                      >\n                        <X className=\"h-4 w-4\" />\n                      </Button>\n                    </div>\n                  ) : (\n                    <div className=\"relative\">\n                      <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\n                      <Input\n                        placeholder=\"Digite o nome do cliente...\"\n                        value={customerSearch}\n                        onChange={(e) => setCustomerSearch(e.target.value)}\n                        className=\"pl-9\"\n                        data-testid=\"input-search-customer\"\n                      />\n                    </div>\n                  )}\n                  {!selectedCustomer && customerSearch && filteredCustomers.length > 0 && (\n                    <div className=\"border rounded-md max-h-40 overflow-y-auto\">\n                      {filteredCustomers.map((customer) => (\n                        <div \n                          key={customer.id}\n                          className=\"p-2 hover-elevate cursor-pointer flex items-center gap-2\"\n                          onClick={() => handleSelectCustomer(customer)}\n                          data-testid={`customer-option-${customer.id}`}\n                        >\n                          <UserIcon className=\"h-4 w-4 text-muted-foreground flex-shrink-0\" />\n                          <div className=\"flex-1 min-w-0\">\n                            <p className=\"text-sm font-medium truncate\">\n                              {customer.firstName} {customer.lastName}\n                            </p>\n                            <p className=\"text-xs text-muted-foreground truncate\">\n                              {customer.company || customer.tradingName || customer.email}\n                            </p>\n                          </div>\n                        </div>\n                      ))}\n                    </div>\n                  )}\n                  {!selectedCustomer && customerSearch && filteredCustomers.length === 0 && (\n                    <p className=\"text-sm text-muted-foreground text-center py-2\">\n                      Nenhum cliente encontrado\n                    </p>\n                  )}\n                </div>\n\n                <div className=\"space-y-2\">\n                  <Label>Adicionar Produtos</Label>\n                  <div className=\"relative\">\n                    <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\n                    <Input\n                      placeholder=\"Buscar produto por nome ou SKU...\"\n                      value={productSearch}\n                      onChange={(e) => setProductSearch(e.target.value)}\n                      className=\"pl-9\"\n                      data-testid=\"input-search-product\"\n                    />\n                  </div>\n                  {productSearch && filteredProducts.length > 0 && (\n                    <div className=\"border rounded-md max-h-40 overflow-y-auto\">\n                      {filteredProducts.map((product) => (\n                        <div \n                          key={product.id}\n                          className=\"p-2 hover-elevate cursor-pointer flex items-center justify-between gap-2\"\n                          onClick={() => handleAddProduct(product)}\n                          data-testid={`product-option-${product.id}`}\n                        >\n                          <div className=\"flex-1 min-w-0\">\n                            <p className=\"text-sm font-medium truncate\">{product.name}</p>\n                            <p className=\"text-xs text-muted-foreground\">SKU: {product.sku}</p>\n                          </div>\n                          <span className=\"text-sm font-semibold\">R$ {parseFloat(product.price).toFixed(2)}</span>\n                        </div>\n                      ))}\n                    </div>\n                  )}\n                </div>\n\n                {cartItems.length > 0 && (\n                  <div className=\"space-y-2\">\n                    <Label>Itens do Pedido ({cartItems.length})</Label>\n                    <ScrollArea className=\"h-48 border rounded-md\">\n                      <div className=\"p-2 space-y-2\">\n                        {cartItems.map((item) => (\n                          <div \n                            key={item.productId}\n                            className=\"flex items-center justify-between gap-2 p-2 bg-muted/50 rounded-md\"\n                            data-testid={`cart-item-${item.productId}`}\n                          >\n                            <div className=\"flex-1 min-w-0\">\n                              <p className=\"text-sm font-medium truncate\">{item.product.name}</p>\n                              <p className=\"text-xs text-muted-foreground\">\n                                R$ {parseFloat(item.product.price).toFixed(2)} un.\n                              </p>\n                            </div>\n                            <div className=\"flex items-center gap-2\">\n                              <Input\n                                type=\"number\"\n                                min=\"1\"\n                                value={item.quantity}\n                                onChange={(e) => handleUpdateQuantity(item.productId, parseInt(e.target.value) || 0)}\n                                className=\"w-16 text-center\"\n                                data-testid={`input-qty-${item.productId}`}\n                              />\n                              <Button\n                                variant=\"ghost\"\n                                size=\"icon\"\n                                onClick={() => handleRemoveItem(item.productId)}\n                                data-testid={`button-remove-${item.productId}`}\n                              >\n                                <Trash2 className=\"h-4 w-4 text-destructive\" />\n                              </Button>\n                            </div>\n                          </div>\n                        ))}\n                      </div>\n                    </ScrollArea>\n                  </div>\n                )}\n\n                <div className=\"flex items-center justify-between p-3 bg-muted rounded-md\">\n                  <span className=\"font-semibold\">Total:</span>\n                  <span className=\"text-lg font-bold\" data-testid=\"text-cart-total\">\n                    R$ {cartTotal.toFixed(2)}\n                  </span>\n                </div>\n\n                <Button \n                  className=\"w-full\" \n                  onClick={handleCreateOrder}\n                  disabled={createOrderMutation.isPending || !selectedCustomerId || cartItems.length === 0}\n                  data-testid=\"button-submit-order\"\n                >\n                  {createOrderMutation.isPending ? (\n                    <>\n                      <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />\n                      Criando...\n                    </>\n                  ) : (\n                    \"Criar Pedido\"\n                  )}\n                </Button>\n              </div>\n            </DialogContent>\n          </Dialog>\n          <DropdownMenu>\n            <DropdownMenuTrigger asChild>\n              <Button \n                variant={selectedOrders.size > 0 ? \"default\" : \"outline\"}\n                data-testid=\"button-batch-print\"\n              >\n                <Printer className=\"h-4 w-4 mr-2\" />\n                Imprimir {selectedOrders.size > 0 ? `(${selectedOrders.size})` : \"Selecionados\"}\n              </Button>\n            </DropdownMenuTrigger>\n            <DropdownMenuContent align=\"end\">\n              <DropdownMenuItem \n                onClick={() => handleBatchPrint('separacao')}\n                data-testid=\"menu-print-separacao\"\n              >\n                Separação\n              </DropdownMenuItem>\n              <DropdownMenuItem \n                onClick={() => handleBatchPrint('cobranca')}\n                data-testid=\"menu-print-cobranca\"\n              >\n                Cobrança\n              </DropdownMenuItem>\n              <DropdownMenuItem \n                onClick={() => handleBatchPrint('conferencia')}\n                data-testid=\"menu-print-conferencia\"\n              >\n                Conferência\n              </DropdownMenuItem>\n            </DropdownMenuContent>\n          </DropdownMenu>\n          <DropdownMenu>\n            <DropdownMenuTrigger asChild>\n              <Button \n                variant={selectedOrders.size > 0 ? \"default\" : \"outline\"}\n                disabled={isBatchStatusLoading}\n                data-testid=\"button-batch-status\"\n              >\n                {isBatchStatusLoading ? (\n                  <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />\n                ) : (\n                  <Edit2 className=\"h-4 w-4 mr-2\" />\n                )}\n                Alterar Status {selectedOrders.size > 0 ? `(${selectedOrders.size})` : \"\"}\n              </Button>\n            </DropdownMenuTrigger>\n            <DropdownMenuContent align=\"end\">\n              <DropdownMenuItem \n                onClick={() => handleBatchStatusChange('PEDIDO_GERADO')}\n                data-testid=\"batch-status-pedido-gerado\"\n              >\n                Gerar Pedido (Reservar Estoque)\n              </DropdownMenuItem>\n              <DropdownMenuItem \n                onClick={() => handleBatchStatusChange('FATURADO')}\n                data-testid=\"batch-status-faturado\"\n              >\n                Faturar (Baixar Estoque)\n              </DropdownMenuItem>\n              <DropdownMenuItem \n                onClick={() => handleBatchStatusChange('CANCELADO')}\n                data-testid=\"batch-status-cancelado\"\n                className=\"text-destructive\"\n              >\n                Cancelar Pedido\n              </DropdownMenuItem>\n            </DropdownMenuContent>\n          </DropdownMenu>\n          {isAdmin && (\n            <Button \n              variant=\"destructive\" \n              onClick={handleBatchDelete}\n              disabled={selectedOrders.size === 0 || isBatchDeleteLoading}\n              data-testid=\"button-batch-delete\"\n            >\n              {isBatchDeleteLoading ? (\n                <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />\n              ) : (\n                <Trash2 className=\"h-4 w-4 mr-2\" />\n              )}\n              Excluir {selectedOrders.size > 0 ? `(${selectedOrders.size})` : \"Selecionados\"}\n            </Button>\n          )}\n          <Button variant=\"outline\" onClick={() => refetch()} data-testid=\"button-refresh-orders\">\n            <RefreshCw className=\"h-4 w-4 mr-2\" />\n            Atualizar\n          </Button>\n          <Button onClick={handleExport} data-testid=\"button-export-orders\">\n            <Download className=\"h-4 w-4 mr-2\" />\n            Exportar CSV\n          </Button>\n        </div>\n      </div>\n\n      <div className=\"flex items-center gap-2 mb-4\">\n        <div className=\"relative flex-1 max-w-sm\">\n          <Search className=\"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\n          <Input\n            placeholder=\"Pesquisar por número ou cliente...\"\n            value={orderSearch}\n            onChange={(e) => setOrderSearch(e.target.value)}\n            className=\"pl-10\"\n            data-testid=\"input-order-search\"\n          />\n          {orderSearch && (\n            <Button\n              variant=\"ghost\"\n              size=\"icon\"\n              className=\"absolute right-1 top-1/2 transform -translate-y-1/2 h-7 w-7\"\n              onClick={() => setOrderSearch(\"\")}\n              data-testid=\"button-clear-search\"\n            >\n              <X className=\"h-4 w-4\" />\n            </Button>\n          )}\n        </div>\n      </div>\n\n      <Tabs value={activeTab} onValueChange={setActiveTab}>\n        <TabsList className=\"flex-wrap\">\n          <TabsTrigger value=\"all\" data-testid=\"tab-all\">Todos ({orders.length})</TabsTrigger>\n          <TabsTrigger value=\"ORCAMENTO\" data-testid=\"tab-orcamento\">\n            Orçamentos ({orders.filter(o => o.status === \"ORCAMENTO\").length})\n          </TabsTrigger>\n          <TabsTrigger value=\"PEDIDO_GERADO\" data-testid=\"tab-pedido-gerado\">\n            Pedidos Gerados ({orders.filter(o => o.status === \"PEDIDO_GERADO\").length})\n          </TabsTrigger>\n          <TabsTrigger value=\"FATURADO\" data-testid=\"tab-faturado\">\n            Faturados ({orders.filter(o => o.status === \"FATURADO\" || o.status === \"PEDIDO_FATURADO\").length})\n          </TabsTrigger>\n          <TabsTrigger value=\"CANCELADO\" data-testid=\"tab-cancelado\">\n            Cancelados ({orders.filter(o => o.status === \"CANCELADO\" || o.status === \"PEDIDO_CANCELADO\").length})\n          </TabsTrigger>\n          <TabsTrigger value=\"legacy\" data-testid=\"tab-legacy\">\n            Outros ({orders.filter(o => !newStatuses.includes(o.status)).length})\n          </TabsTrigger>\n        </TabsList>\n\n        <TabsContent value={activeTab} className=\"mt-6\">\n          {isLoading ? (\n            <div className=\"flex items-center justify-center py-12\">\n              <Loader2 className=\"h-8 w-8 animate-spin text-muted-foreground\" />\n            </div>\n          ) : filteredOrders.length === 0 ? (\n            <div className=\"text-center py-12 text-muted-foreground\">\n              Nenhum pedido encontrado\n            </div>\n          ) : (\n            <OrderTable\n              orders={filteredOrders}\n              showCustomer={true}\n              selectedOrderIds={selectedOrders}\n              onSelectionChange={handleSelectionChange}\n              onSelectAll={handleSelectAll}\n              onPrintOrder={handlePrintOrder}\n              canEdit={showAllOrders}\n              onEditOrder={(order) => { window.location.href = `/orders/${order.id}`; }}\n            />\n          )}\n        </TabsContent>\n      </Tabs>\n    </div>\n  );\n}\n","path":null,"size_bytes":38528,"size_tokens":null},"client/src/components/ui/drawer.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport { Drawer as DrawerPrimitive } from \"vaul\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Drawer = ({\n  shouldScaleBackground = true,\n  ...props\n}: React.ComponentProps<typeof DrawerPrimitive.Root>) => (\n  <DrawerPrimitive.Root\n    shouldScaleBackground={shouldScaleBackground}\n    {...props}\n  />\n)\nDrawer.displayName = \"Drawer\"\n\nconst DrawerTrigger = DrawerPrimitive.Trigger\n\nconst DrawerPortal = DrawerPrimitive.Portal\n\nconst DrawerClose = DrawerPrimitive.Close\n\nconst DrawerOverlay = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <DrawerPrimitive.Overlay\n    ref={ref}\n    className={cn(\"fixed inset-0 z-50 bg-black/80\", className)}\n    {...props}\n  />\n))\nDrawerOverlay.displayName = DrawerPrimitive.Overlay.displayName\n\nconst DrawerContent = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Content>\n>(({ className, children, ...props }, ref) => (\n  <DrawerPortal>\n    <DrawerOverlay />\n    <DrawerPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"fixed inset-x-0 bottom-0 z-50 mt-24 flex h-auto flex-col rounded-t-[10px] border bg-background\",\n        className\n      )}\n      {...props}\n    >\n      <div className=\"mx-auto mt-4 h-2 w-[100px] rounded-full bg-muted\" />\n      {children}\n    </DrawerPrimitive.Content>\n  </DrawerPortal>\n))\nDrawerContent.displayName = \"DrawerContent\"\n\nconst DrawerHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\"grid gap-1.5 p-4 text-center sm:text-left\", className)}\n    {...props}\n  />\n)\nDrawerHeader.displayName = \"DrawerHeader\"\n\nconst DrawerFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\"mt-auto flex flex-col gap-2 p-4\", className)}\n    {...props}\n  />\n)\nDrawerFooter.displayName = \"DrawerFooter\"\n\nconst DrawerTitle = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <DrawerPrimitive.Title\n    ref={ref}\n    className={cn(\n      \"text-lg font-semibold leading-none tracking-tight\",\n      className\n    )}\n    {...props}\n  />\n))\nDrawerTitle.displayName = DrawerPrimitive.Title.displayName\n\nconst DrawerDescription = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <DrawerPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nDrawerDescription.displayName = DrawerPrimitive.Description.displayName\n\nexport {\n  Drawer,\n  DrawerPortal,\n  DrawerOverlay,\n  DrawerTrigger,\n  DrawerClose,\n  DrawerContent,\n  DrawerHeader,\n  DrawerFooter,\n  DrawerTitle,\n  DrawerDescription,\n}\n","path":null,"size_bytes":3021,"size_tokens":null},"client/src/components/examples/CatalogFiltersExample.tsx":{"content":"import { CatalogFilters } from \"../CatalogFilters\";\nimport { useState } from \"react\";\n\n// todo: remove mock functionality\nconst categories = [\"Machinery\", \"Hydraulics\", \"Materials\", \"Safety\"];\nconst brands = [\"TechParts\", \"FlowMax\", \"SteelCo\", \"SafeFlow\"];\n\nexport default function CatalogFiltersExample() {\n  const [search, setSearch] = useState(\"\");\n  const [category, setCategory] = useState(\"all\");\n  const [brand, setBrand] = useState(\"all\");\n\n  return (\n    <CatalogFilters\n      searchQuery={search}\n      onSearchChange={setSearch}\n      category={category}\n      onCategoryChange={setCategory}\n      brand={brand}\n      onBrandChange={setBrand}\n      categories={categories}\n      brands={brands}\n      onClearFilters={() => {\n        setSearch(\"\");\n        setCategory(\"all\");\n        setBrand(\"all\");\n      }}\n    />\n  );\n}\n","path":null,"size_bytes":835,"size_tokens":null},"client/src/components/examples/CartDrawerExample.tsx":{"content":"import { CartDrawer } from \"../CartDrawer\";\nimport { CartProvider, useCart } from \"@/contexts/CartContext\";\nimport { Button } from \"@/components/ui/button\";\nimport { ShoppingCart } from \"lucide-react\";\nimport { useEffect } from \"react\";\n\nfunction CartDemo() {\n  const { addItem, openCart, itemCount } = useCart();\n\n  useEffect(() => {\n    // todo: remove mock functionality\n    addItem({ productId: \"1\", name: \"Industrial Bearing\", sku: \"BRG-001\", price: 149.99, quantity: 2 });\n    addItem({ productId: \"2\", name: \"Hydraulic Pump\", sku: \"HYD-102\", price: 599.00, quantity: 1 });\n  }, []);\n\n  return (\n    <div className=\"flex items-center gap-4\">\n      <Button onClick={openCart} data-testid=\"button-open-cart\">\n        <ShoppingCart className=\"h-4 w-4 mr-2\" />\n        Open Cart ({itemCount})\n      </Button>\n      <CartDrawer onGenerateOrder={() => console.log(\"Order generated!\")} />\n    </div>\n  );\n}\n\nexport default function CartDrawerExample() {\n  return (\n    <CartProvider>\n      <CartDemo />\n    </CartProvider>\n  );\n}\n","path":null,"size_bytes":1029,"size_tokens":null},"client/src/components/OrderTable.tsx":{"content":"import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from \"@/components/ui/table\";\nimport { Button } from \"@/components/ui/button\";\nimport { StatusBadge, StageBadge } from \"./StatusBadge\";\nimport { Eye, Printer, Edit2 } from \"lucide-react\";\nimport { SiWhatsapp } from \"react-icons/si\";\nimport { Link } from \"wouter\";\nimport { Checkbox } from \"@/components/ui/checkbox\";\n\nconst STORE_WHATSAPP = \"5511992845596\";\n\nfunction getWhatsAppLink(order: Order): string {\n  const message = `Olá! Gostaria de falar sobre o pedido #${order.orderNumber}`;\n  return `https://wa.me/${STORE_WHATSAPP}?text=${encodeURIComponent(message)}`;\n}\n\nexport interface Order {\n  id: string;\n  orderNumber: string;\n  customer: string;\n  date: string;\n  status: string;\n  stage: string;\n  total: number;\n  itemCount: number;\n  printed?: boolean;\n}\n\ninterface OrderTableProps {\n  orders: Order[];\n  showCustomer?: boolean;\n  selectedOrderIds?: Set<string>;\n  onSelectionChange?: (orderId: string, selected: boolean) => void;\n  onSelectAll?: (selected: boolean) => void;\n  onPrintOrder?: (order: Order) => void;\n  onEditOrder?: (order: Order) => void;\n  canEdit?: boolean;\n}\n\n\nexport function OrderTable({ \n  orders, \n  showCustomer = true,\n  selectedOrderIds,\n  onSelectionChange,\n  onSelectAll,\n  onPrintOrder,\n  onEditOrder,\n  canEdit = false,\n}: OrderTableProps) {\n  const allSelected = orders.length > 0 && selectedOrderIds && orders.every(o => selectedOrderIds.has(o.id));\n  const someSelected = selectedOrderIds && orders.some(o => selectedOrderIds.has(o.id)) && !allSelected;\n\n  return (\n    <div className=\"rounded-lg border overflow-hidden\">\n      <Table>\n        <TableHeader>\n          <TableRow className=\"bg-muted/50\">\n            {onSelectionChange && (\n              <TableHead className=\"w-[50px]\">\n                <Checkbox\n                  checked={allSelected}\n                  onCheckedChange={(checked) => onSelectAll?.(!!checked)}\n                  data-testid=\"checkbox-select-all\"\n                  className={someSelected ? \"data-[state=checked]:bg-primary/50\" : \"\"}\n                />\n              </TableHead>\n            )}\n            <TableHead className=\"font-semibold\">Pedido #</TableHead>\n            {showCustomer && <TableHead className=\"font-semibold\">Cliente</TableHead>}\n            <TableHead className=\"font-semibold\">Data</TableHead>\n            <TableHead className=\"font-semibold\">Itens</TableHead>\n            <TableHead className=\"font-semibold\">Status</TableHead>\n            <TableHead className=\"font-semibold\">Etapa</TableHead>\n            <TableHead className=\"font-semibold text-right\">Total</TableHead>\n            <TableHead className=\"w-[80px]\"></TableHead>\n          </TableRow>\n        </TableHeader>\n        <TableBody>\n          {orders.map((order, idx) => (\n            <TableRow \n              key={order.id} \n              className={idx % 2 === 0 ? \"bg-background\" : \"bg-muted/30\"}\n              data-testid={`row-order-${order.id}`}\n            >\n              {onSelectionChange && (\n                <TableCell>\n                  <Checkbox\n                    checked={selectedOrderIds?.has(order.id) || false}\n                    onCheckedChange={(checked) => onSelectionChange(order.id, !!checked)}\n                    data-testid={`checkbox-order-${order.id}`}\n                  />\n                </TableCell>\n              )}\n              <TableCell className=\"font-medium\" data-testid={`text-order-number-${order.id}`}>\n                {order.orderNumber}\n              </TableCell>\n              {showCustomer && (\n                <TableCell>{order.customer}</TableCell>\n              )}\n              <TableCell className=\"text-muted-foreground\">{order.date}</TableCell>\n              <TableCell>{order.itemCount} itens</TableCell>\n              <TableCell>\n                <StatusBadge status={order.status as any} />\n              </TableCell>\n              <TableCell>\n                <div className=\"flex items-center gap-2\">\n                  <StageBadge printed={order.printed || false} />\n                  {!order.printed && onPrintOrder && (\n                    <Button\n                      variant=\"outline\"\n                      size=\"sm\"\n                      onClick={() => onPrintOrder(order)}\n                      className=\"gap-1\"\n                      data-testid={`button-print-${order.id}`}\n                    >\n                      <Printer className=\"h-3 w-3\" />\n                      <span className=\"hidden sm:inline\">Imprimir</span>\n                    </Button>\n                  )}\n                </div>\n              </TableCell>\n              <TableCell className=\"text-right font-medium\">\n                R$ {order.total.toFixed(2)}\n              </TableCell>\n              <TableCell>\n                <div className=\"flex items-center gap-1 justify-end\">\n                  {canEdit && onEditOrder && (\n                    <Button\n                      variant=\"ghost\"\n                      size=\"icon\"\n                      onClick={() => onEditOrder(order)}\n                      data-testid={`button-edit-order-${order.id}`}\n                    >\n                      <Edit2 className=\"h-4 w-4\" />\n                    </Button>\n                  )}\n                  <Link href={`/orders/${order.id}`}>\n                    <Button\n                      variant=\"ghost\"\n                      size=\"icon\"\n                      data-testid={`button-view-order-${order.id}`}\n                    >\n                      <Eye className=\"h-4 w-4\" />\n                    </Button>\n                  </Link>\n                  <a \n                    href={getWhatsAppLink(order)} \n                    target=\"_blank\" \n                    rel=\"noopener noreferrer\"\n                  >\n                    <Button\n                      variant=\"ghost\"\n                      size=\"icon\"\n                      className=\"text-green-600 dark:text-green-500\"\n                      data-testid={`button-whatsapp-order-${order.id}`}\n                    >\n                      <SiWhatsapp className=\"h-4 w-4\" />\n                    </Button>\n                  </a>\n                </div>\n              </TableCell>\n            </TableRow>\n          ))}\n        </TableBody>\n      </Table>\n    </div>\n  );\n}\n","path":null,"size_bytes":6295,"size_tokens":null},"client/src/hooks/use-mobile.tsx":{"content":"import * as React from \"react\"\n\nconst MOBILE_BREAKPOINT = 768\n\nexport function useIsMobile() {\n  const [isMobile, setIsMobile] = React.useState<boolean | undefined>(undefined)\n\n  React.useEffect(() => {\n    const mql = window.matchMedia(`(max-width: ${MOBILE_BREAKPOINT - 1}px)`)\n    const onChange = () => {\n      setIsMobile(window.innerWidth < MOBILE_BREAKPOINT)\n    }\n    mql.addEventListener(\"change\", onChange)\n    setIsMobile(window.innerWidth < MOBILE_BREAKPOINT)\n    return () => mql.removeEventListener(\"change\", onChange)\n  }, [])\n\n  return !!isMobile\n}\n","path":null,"size_bytes":565,"size_tokens":null},"client/src/hooks/useAuth.ts":{"content":"import { useQuery } from \"@tanstack/react-query\";\nimport type { User } from \"@shared/schema\";\n\nexport function useAuth() {\n  const { data: user, isLoading } = useQuery<User>({\n    queryKey: [\"/api/auth/user\"],\n    retry: false,\n  });\n\n  return {\n    user,\n    isLoading,\n    isAuthenticated: !!user,\n  };\n}\n","path":null,"size_bytes":307,"size_tokens":null},"client/src/components/ui/scroll-area.tsx":{"content":"import * as React from \"react\"\nimport * as ScrollAreaPrimitive from \"@radix-ui/react-scroll-area\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ScrollArea = React.forwardRef<\n  React.ElementRef<typeof ScrollAreaPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof ScrollAreaPrimitive.Root>\n>(({ className, children, ...props }, ref) => (\n  <ScrollAreaPrimitive.Root\n    ref={ref}\n    className={cn(\"relative overflow-hidden\", className)}\n    {...props}\n  >\n    <ScrollAreaPrimitive.Viewport className=\"h-full w-full rounded-[inherit]\">\n      {children}\n    </ScrollAreaPrimitive.Viewport>\n    <ScrollBar />\n    <ScrollAreaPrimitive.Corner />\n  </ScrollAreaPrimitive.Root>\n))\nScrollArea.displayName = ScrollAreaPrimitive.Root.displayName\n\nconst ScrollBar = React.forwardRef<\n  React.ElementRef<typeof ScrollAreaPrimitive.ScrollAreaScrollbar>,\n  React.ComponentPropsWithoutRef<typeof ScrollAreaPrimitive.ScrollAreaScrollbar>\n>(({ className, orientation = \"vertical\", ...props }, ref) => (\n  <ScrollAreaPrimitive.ScrollAreaScrollbar\n    ref={ref}\n    orientation={orientation}\n    className={cn(\n      \"flex touch-none select-none transition-colors\",\n      orientation === \"vertical\" &&\n        \"h-full w-2.5 border-l border-l-transparent p-[1px]\",\n      orientation === \"horizontal\" &&\n        \"h-2.5 flex-col border-t border-t-transparent p-[1px]\",\n      className\n    )}\n    {...props}\n  >\n    <ScrollAreaPrimitive.ScrollAreaThumb className=\"relative flex-1 rounded-full bg-border\" />\n  </ScrollAreaPrimitive.ScrollAreaScrollbar>\n))\nScrollBar.displayName = ScrollAreaPrimitive.ScrollAreaScrollbar.displayName\n\nexport { ScrollArea, ScrollBar }\n","path":null,"size_bytes":1642,"size_tokens":null},"client/src/components/ui/accordion.tsx":{"content":"import * as React from \"react\"\nimport * as AccordionPrimitive from \"@radix-ui/react-accordion\"\nimport { ChevronDown } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Accordion = AccordionPrimitive.Root\n\nconst AccordionItem = React.forwardRef<\n  React.ElementRef<typeof AccordionPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Item>\n>(({ className, ...props }, ref) => (\n  <AccordionPrimitive.Item\n    ref={ref}\n    className={cn(\"border-b\", className)}\n    {...props}\n  />\n))\nAccordionItem.displayName = \"AccordionItem\"\n\nconst AccordionTrigger = React.forwardRef<\n  React.ElementRef<typeof AccordionPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Trigger>\n>(({ className, children, ...props }, ref) => (\n  <AccordionPrimitive.Header className=\"flex\">\n    <AccordionPrimitive.Trigger\n      ref={ref}\n      className={cn(\n        \"flex flex-1 items-center justify-between py-4 font-medium transition-all hover:underline [&[data-state=open]>svg]:rotate-180\",\n        className\n      )}\n      {...props}\n    >\n      {children}\n      <ChevronDown className=\"h-4 w-4 shrink-0 transition-transform duration-200\" />\n    </AccordionPrimitive.Trigger>\n  </AccordionPrimitive.Header>\n))\nAccordionTrigger.displayName = AccordionPrimitive.Trigger.displayName\n\nconst AccordionContent = React.forwardRef<\n  React.ElementRef<typeof AccordionPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Content>\n>(({ className, children, ...props }, ref) => (\n  <AccordionPrimitive.Content\n    ref={ref}\n    className=\"overflow-hidden text-sm transition-all data-[state=closed]:animate-accordion-up data-[state=open]:animate-accordion-down\"\n    {...props}\n  >\n    <div className={cn(\"pb-4 pt-0\", className)}>{children}</div>\n  </AccordionPrimitive.Content>\n))\n\nAccordionContent.displayName = AccordionPrimitive.Content.displayName\n\nexport { Accordion, AccordionItem, AccordionTrigger, AccordionContent }\n","path":null,"size_bytes":1977,"size_tokens":null},"client/src/components/ui/alert-dialog.tsx":{"content":"import * as React from \"react\"\nimport * as AlertDialogPrimitive from \"@radix-ui/react-alert-dialog\"\n\nimport { cn } from \"@/lib/utils\"\nimport { buttonVariants } from \"@/components/ui/button\"\n\nconst AlertDialog = AlertDialogPrimitive.Root\n\nconst AlertDialogTrigger = AlertDialogPrimitive.Trigger\n\nconst AlertDialogPortal = AlertDialogPrimitive.Portal\n\nconst AlertDialogOverlay = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Overlay\n    className={cn(\n      \"fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0\",\n      className\n    )}\n    {...props}\n    ref={ref}\n  />\n))\nAlertDialogOverlay.displayName = AlertDialogPrimitive.Overlay.displayName\n\nconst AlertDialogContent = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPortal>\n    <AlertDialogOverlay />\n    <AlertDialogPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg\",\n        className\n      )}\n      {...props}\n    />\n  </AlertDialogPortal>\n))\nAlertDialogContent.displayName = AlertDialogPrimitive.Content.displayName\n\nconst AlertDialogHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col space-y-2 text-center sm:text-left\",\n      className\n    )}\n    {...props}\n  />\n)\nAlertDialogHeader.displayName = \"AlertDialogHeader\"\n\nconst AlertDialogFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2\",\n      className\n    )}\n    {...props}\n  />\n)\nAlertDialogFooter.displayName = \"AlertDialogFooter\"\n\nconst AlertDialogTitle = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Title\n    ref={ref}\n    className={cn(\"text-lg font-semibold\", className)}\n    {...props}\n  />\n))\nAlertDialogTitle.displayName = AlertDialogPrimitive.Title.displayName\n\nconst AlertDialogDescription = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nAlertDialogDescription.displayName =\n  AlertDialogPrimitive.Description.displayName\n\nconst AlertDialogAction = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Action>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Action>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Action\n    ref={ref}\n    className={cn(buttonVariants(), className)}\n    {...props}\n  />\n))\nAlertDialogAction.displayName = AlertDialogPrimitive.Action.displayName\n\nconst AlertDialogCancel = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Cancel>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Cancel>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Cancel\n    ref={ref}\n    className={cn(\n      buttonVariants({ variant: \"outline\" }),\n      \"mt-2 sm:mt-0\",\n      className\n    )}\n    {...props}\n  />\n))\nAlertDialogCancel.displayName = AlertDialogPrimitive.Cancel.displayName\n\nexport {\n  AlertDialog,\n  AlertDialogPortal,\n  AlertDialogOverlay,\n  AlertDialogTrigger,\n  AlertDialogContent,\n  AlertDialogHeader,\n  AlertDialogFooter,\n  AlertDialogTitle,\n  AlertDialogDescription,\n  AlertDialogAction,\n  AlertDialogCancel,\n}\n","path":null,"size_bytes":4420,"size_tokens":null},"client/src/components/StatCard.tsx":{"content":"import { Card, CardContent } from \"@/components/ui/card\";\nimport { cn } from \"@/lib/utils\";\nimport { type LucideIcon, TrendingUp, TrendingDown } from \"lucide-react\";\n\ninterface StatCardProps {\n  title: string;\n  value: string | number;\n  icon: LucideIcon;\n  trend?: {\n    value: number;\n    isPositive: boolean;\n  };\n  className?: string;\n}\n\nexport function StatCard({ title, value, icon: Icon, trend, className }: StatCardProps) {\n  return (\n    <Card className={cn(\"\", className)} data-testid={`card-stat-${title.toLowerCase().replace(/\\s+/g, \"-\")}`}>\n      <CardContent className=\"p-6\">\n        <div className=\"flex items-center justify-between gap-4\">\n          <div className=\"flex-1 min-w-0\">\n            <p className=\"text-sm font-medium text-muted-foreground truncate\">{title}</p>\n            <p className=\"text-3xl font-bold mt-1\">{value}</p>\n            {trend && (\n              <div className={cn(\n                \"flex items-center gap-1 mt-2 text-xs font-medium\",\n                trend.isPositive ? \"text-green-600 dark:text-green-400\" : \"text-red-600 dark:text-red-400\"\n              )}>\n                {trend.isPositive ? (\n                  <TrendingUp className=\"h-3 w-3\" />\n                ) : (\n                  <TrendingDown className=\"h-3 w-3\" />\n                )}\n                <span>{trend.value}% from last month</span>\n              </div>\n            )}\n          </div>\n          <div className=\"flex-shrink-0 p-3 bg-emerald-100 dark:bg-emerald-900/30 rounded-lg\">\n            <Icon className=\"h-6 w-6 text-emerald-600 dark:text-emerald-400\" />\n          </div>\n        </div>\n      </CardContent>\n    </Card>\n  );\n}\n","path":null,"size_bytes":1650,"size_tokens":null},"client/src/components/examples/StatCardExample.tsx":{"content":"import { StatCard } from \"../StatCard\";\nimport { ShoppingCart, Package, Users } from \"lucide-react\";\n\nexport default function StatCardExample() {\n  return (\n    <div className=\"grid grid-cols-1 md:grid-cols-3 gap-6\">\n      <StatCard\n        title=\"Total Orders\"\n        value={142}\n        icon={ShoppingCart}\n        trend={{ value: 12, isPositive: true }}\n      />\n      <StatCard\n        title=\"Products\"\n        value={856}\n        icon={Package}\n        trend={{ value: 5, isPositive: true }}\n      />\n      <StatCard\n        title=\"Customers\"\n        value={1248}\n        icon={Users}\n        trend={{ value: 8, isPositive: true }}\n      />\n    </div>\n  );\n}\n","path":null,"size_bytes":665,"size_tokens":null},"client/src/lib/utils.ts":{"content":"import { clsx, type ClassValue } from \"clsx\"\nimport { twMerge } from \"tailwind-merge\"\n\nexport function cn(...inputs: ClassValue[]) {\n  return twMerge(clsx(inputs))\n}\n","path":null,"size_bytes":166,"size_tokens":null},"client/src/components/ui/sidebar.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport { cva, VariantProps } from \"class-variance-authority\"\nimport { PanelLeftIcon } from \"lucide-react\"\n\nimport { useIsMobile } from \"@/hooks/use-mobile\"\nimport { cn } from \"@/lib/utils\"\nimport { Button } from \"@/components/ui/button\"\nimport { Input } from \"@/components/ui/input\"\nimport { Separator } from \"@/components/ui/separator\"\nimport {\n  Sheet,\n  SheetContent,\n  SheetDescription,\n  SheetHeader,\n  SheetTitle,\n} from \"@/components/ui/sheet\"\nimport { Skeleton } from \"@/components/ui/skeleton\"\nimport {\n  Tooltip,\n  TooltipContent,\n  TooltipProvider,\n  TooltipTrigger,\n} from \"@/components/ui/tooltip\"\n\nconst SIDEBAR_COOKIE_NAME = \"sidebar_state\"\nconst SIDEBAR_COOKIE_MAX_AGE = 60 * 60 * 24 * 7\nconst SIDEBAR_WIDTH = \"16rem\"\nconst SIDEBAR_WIDTH_MOBILE = \"18rem\"\nconst SIDEBAR_WIDTH_ICON = \"3rem\"\nconst SIDEBAR_KEYBOARD_SHORTCUT = \"b\"\n\ntype SidebarContextProps = {\n  state: \"expanded\" | \"collapsed\"\n  open: boolean\n  setOpen: (open: boolean) => void\n  openMobile: boolean\n  setOpenMobile: (open: boolean) => void\n  isMobile: boolean\n  toggleSidebar: () => void\n}\n\nconst SidebarContext = React.createContext<SidebarContextProps | null>(null)\n\nfunction useSidebar() {\n  const context = React.useContext(SidebarContext)\n  if (!context) {\n    throw new Error(\"useSidebar must be used within a SidebarProvider.\")\n  }\n\n  return context\n}\n\nfunction SidebarProvider({\n  defaultOpen = true,\n  open: openProp,\n  onOpenChange: setOpenProp,\n  className,\n  style,\n  children,\n  ...props\n}: React.ComponentProps<\"div\"> & {\n  defaultOpen?: boolean\n  open?: boolean\n  onOpenChange?: (open: boolean) => void\n}) {\n  const isMobile = useIsMobile()\n  const [openMobile, setOpenMobile] = React.useState(false)\n\n  // This is the internal state of the sidebar.\n  // We use openProp and setOpenProp for control from outside the component.\n  const [_open, _setOpen] = React.useState(defaultOpen)\n  const open = openProp ?? _open\n  const setOpen = React.useCallback(\n    (value: boolean | ((value: boolean) => boolean)) => {\n      const openState = typeof value === \"function\" ? value(open) : value\n      if (setOpenProp) {\n        setOpenProp(openState)\n      } else {\n        _setOpen(openState)\n      }\n\n      // This sets the cookie to keep the sidebar state.\n      document.cookie = `${SIDEBAR_COOKIE_NAME}=${openState}; path=/; max-age=${SIDEBAR_COOKIE_MAX_AGE}`\n    },\n    [setOpenProp, open]\n  )\n\n  // Helper to toggle the sidebar.\n  const toggleSidebar = React.useCallback(() => {\n    return isMobile ? setOpenMobile((open) => !open) : setOpen((open) => !open)\n  }, [isMobile, setOpen, setOpenMobile])\n\n  // Adds a keyboard shortcut to toggle the sidebar.\n  React.useEffect(() => {\n    const handleKeyDown = (event: KeyboardEvent) => {\n      if (\n        event.key === SIDEBAR_KEYBOARD_SHORTCUT &&\n        (event.metaKey || event.ctrlKey)\n      ) {\n        event.preventDefault()\n        toggleSidebar()\n      }\n    }\n\n    window.addEventListener(\"keydown\", handleKeyDown)\n    return () => window.removeEventListener(\"keydown\", handleKeyDown)\n  }, [toggleSidebar])\n\n  // We add a state so that we can do data-state=\"expanded\" or \"collapsed\".\n  // This makes it easier to style the sidebar with Tailwind classes.\n  const state = open ? \"expanded\" : \"collapsed\"\n\n  const contextValue = React.useMemo<SidebarContextProps>(\n    () => ({\n      state,\n      open,\n      setOpen,\n      isMobile,\n      openMobile,\n      setOpenMobile,\n      toggleSidebar,\n    }),\n    [state, open, setOpen, isMobile, openMobile, setOpenMobile, toggleSidebar]\n  )\n\n  return (\n    <SidebarContext.Provider value={contextValue}>\n      <TooltipProvider delayDuration={0}>\n        <div\n          data-slot=\"sidebar-wrapper\"\n          style={\n            {\n              \"--sidebar-width\": SIDEBAR_WIDTH,\n              \"--sidebar-width-icon\": SIDEBAR_WIDTH_ICON,\n              ...style,\n            } as React.CSSProperties\n          }\n          className={cn(\n            \"group/sidebar-wrapper has-data-[variant=inset]:bg-sidebar flex min-h-svh w-full\",\n            className\n          )}\n          {...props}\n        >\n          {children}\n        </div>\n      </TooltipProvider>\n    </SidebarContext.Provider>\n  )\n}\n\nfunction Sidebar({\n  side = \"left\",\n  variant = \"sidebar\",\n  collapsible = \"offcanvas\",\n  className,\n  children,\n  ...props\n}: React.ComponentProps<\"div\"> & {\n  side?: \"left\" | \"right\"\n  variant?: \"sidebar\" | \"floating\" | \"inset\"\n  collapsible?: \"offcanvas\" | \"icon\" | \"none\"\n}) {\n  const { isMobile, state, openMobile, setOpenMobile } = useSidebar()\n\n  if (collapsible === \"none\") {\n    return (\n      <div\n        data-slot=\"sidebar\"\n        className={cn(\n          \"bg-sidebar text-sidebar-foreground flex h-full w-[var(--sidebar-width)] flex-col\",\n          className\n        )}\n        {...props}\n      >\n        {children}\n      </div>\n    )\n  }\n\n  if (isMobile) {\n    return (\n      <Sheet open={openMobile} onOpenChange={setOpenMobile} {...props}>\n        <SheetContent\n          data-sidebar=\"sidebar\"\n          data-slot=\"sidebar\"\n          data-mobile=\"true\"\n          className=\"bg-sidebar text-sidebar-foreground w-[var(--sidebar-width)] p-0 [&>button]:hidden\"\n          style={\n            {\n              \"--sidebar-width\": SIDEBAR_WIDTH_MOBILE,\n            } as React.CSSProperties\n          }\n          side={side}\n        >\n          <SheetHeader className=\"sr-only\">\n            <SheetTitle>Sidebar</SheetTitle>\n            <SheetDescription>Displays the mobile sidebar.</SheetDescription>\n          </SheetHeader>\n          <div className=\"flex h-full w-full flex-col\">{children}</div>\n        </SheetContent>\n      </Sheet>\n    )\n  }\n\n  return (\n    <div\n      className=\"group peer text-sidebar-foreground hidden md:block\"\n      data-state={state}\n      data-collapsible={state === \"collapsed\" ? collapsible : \"\"}\n      data-variant={variant}\n      data-side={side}\n      data-slot=\"sidebar\"\n    >\n      {/* This is what handles the sidebar gap on desktop */}\n      <div\n        data-slot=\"sidebar-gap\"\n        className={cn(\n          \"relative w-[var(--sidebar-width)] bg-transparent transition-[width] duration-200 ease-linear\",\n          \"group-data-[collapsible=offcanvas]:w-0\",\n          \"group-data-[side=right]:rotate-180\",\n          variant === \"floating\" || variant === \"inset\"\n            ? \"group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)+var(--spacing-4))]\"\n            : \"group-data-[collapsible=icon]:w-[var(--sidebar-width-icon)]\"\n        )}\n      />\n      <div\n        data-slot=\"sidebar-container\"\n        className={cn(\n          \"fixed inset-y-0 z-10 hidden h-svh w-[var(--sidebar-width)] transition-[left,right,width] duration-200 ease-linear md:flex\",\n          side === \"left\"\n            ? \"left-0 group-data-[collapsible=offcanvas]:left-[calc(var(--sidebar-width)*-1)]\"\n            : \"right-0 group-data-[collapsible=offcanvas]:right-[calc(var(--sidebar-width)*-1)]\",\n          // Adjust the padding for floating and inset variants.\n          variant === \"floating\" || variant === \"inset\"\n            ? \"p-2 group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)+var(--spacing-4)+2px)]\"\n            : \"group-data-[collapsible=icon]:w-[var(--sidebar-width-icon)] group-data-[side=left]:border-r group-data-[side=right]:border-l\",\n          className\n        )}\n        {...props}\n      >\n        <div\n          data-sidebar=\"sidebar\"\n          data-slot=\"sidebar-inner\"\n          className=\"bg-sidebar group-data-[variant=floating]:border-sidebar-border flex h-full w-full flex-col group-data-[variant=floating]:rounded-lg group-data-[variant=floating]:border group-data-[variant=floating]:shadow-sm\"\n        >\n          {children}\n        </div>\n      </div>\n    </div>\n  )\n}\n\nfunction SidebarTrigger({\n  className,\n  onClick,\n  ...props\n}: React.ComponentProps<typeof Button>) {\n  const { toggleSidebar } = useSidebar()\n\n  return (\n    <Button\n      data-sidebar=\"trigger\"\n      data-slot=\"sidebar-trigger\"\n      variant=\"ghost\"\n      size=\"icon\"\n      className={cn(\"h-7 w-7\", className)}\n      onClick={(event) => {\n        onClick?.(event)\n        toggleSidebar()\n      }}\n      {...props}\n    >\n      <PanelLeftIcon />\n      <span className=\"sr-only\">Toggle Sidebar</span>\n    </Button>\n  )\n}\n\nfunction SidebarRail({ className, ...props }: React.ComponentProps<\"button\">) {\n  const { toggleSidebar } = useSidebar()\n\n  // Note: Tailwind v3.4 doesn't support \"in-\" selectors. So the rail won't work perfectly.\n  return (\n    <button\n      data-sidebar=\"rail\"\n      data-slot=\"sidebar-rail\"\n      aria-label=\"Toggle Sidebar\"\n      tabIndex={-1}\n      onClick={toggleSidebar}\n      title=\"Toggle Sidebar\"\n      className={cn(\n        \"hover:after:bg-sidebar-border absolute inset-y-0 z-20 hidden w-4 -translate-x-1/2 transition-all ease-linear group-data-[side=left]:-right-4 group-data-[side=right]:left-0 after:absolute after:inset-y-0 after:left-1/2 after:w-[2px] sm:flex\",\n        \"in-data-[side=left]:cursor-w-resize in-data-[side=right]:cursor-e-resize\",\n        \"[[data-side=left][data-state=collapsed]_&]:cursor-e-resize [[data-side=right][data-state=collapsed]_&]:cursor-w-resize\",\n        \"hover:group-data-[collapsible=offcanvas]:bg-sidebar group-data-[collapsible=offcanvas]:translate-x-0 group-data-[collapsible=offcanvas]:after:left-full\",\n        \"[[data-side=left][data-collapsible=offcanvas]_&]:-right-2\",\n        \"[[data-side=right][data-collapsible=offcanvas]_&]:-left-2\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarInset({ className, ...props }: React.ComponentProps<\"main\">) {\n  return (\n    <main\n      data-slot=\"sidebar-inset\"\n      className={cn(\n        \"bg-background relative flex w-full flex-1 flex-col\",\n        \"md:peer-data-[variant=inset]:m-2 md:peer-data-[variant=inset]:ml-0 md:peer-data-[variant=inset]:rounded-xl md:peer-data-[variant=inset]:shadow-sm md:peer-data-[variant=inset]:peer-data-[state=collapsed]:ml-2\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarInput({\n  className,\n  ...props\n}: React.ComponentProps<typeof Input>) {\n  return (\n    <Input\n      data-slot=\"sidebar-input\"\n      data-sidebar=\"input\"\n      className={cn(\"bg-background h-8 w-full shadow-none\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarHeader({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-header\"\n      data-sidebar=\"header\"\n      className={cn(\"flex flex-col gap-2 p-2\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarFooter({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-footer\"\n      data-sidebar=\"footer\"\n      className={cn(\"flex flex-col gap-2 p-2\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarSeparator({\n  className,\n  ...props\n}: React.ComponentProps<typeof Separator>) {\n  return (\n    <Separator\n      data-slot=\"sidebar-separator\"\n      data-sidebar=\"separator\"\n      className={cn(\"bg-sidebar-border mx-2 w-auto\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarContent({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-content\"\n      data-sidebar=\"content\"\n      className={cn(\n        \"flex min-h-0 flex-1 flex-col gap-2 overflow-auto group-data-[collapsible=icon]:overflow-hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarGroup({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-group\"\n      data-sidebar=\"group\"\n      className={cn(\"relative flex w-full min-w-0 flex-col p-2\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarGroupLabel({\n  className,\n  asChild = false,\n  ...props\n}: React.ComponentProps<\"div\"> & { asChild?: boolean }) {\n  const Comp = asChild ? Slot : \"div\"\n\n  return (\n    <Comp\n      data-slot=\"sidebar-group-label\"\n      data-sidebar=\"group-label\"\n      className={cn(\n        \"text-sidebar-foreground/70 ring-sidebar-ring flex h-8 shrink-0 items-center rounded-md px-2 text-xs font-medium outline-hidden transition-[margin,opacity] duration-200 ease-linear focus-visible:ring-2 [&>svg]:h-4 [&>svg]:w-4 [&>svg]:shrink-0\",\n        \"group-data-[collapsible=icon]:-mt-8 group-data-[collapsible=icon]:opacity-0\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarGroupAction({\n  className,\n  asChild = false,\n  ...props\n}: React.ComponentProps<\"button\"> & { asChild?: boolean }) {\n  const Comp = asChild ? Slot : \"button\"\n\n  return (\n    <Comp\n      data-slot=\"sidebar-group-action\"\n      data-sidebar=\"group-action\"\n      className={cn(\n        \"text-sidebar-foreground ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground absolute top-3.5 right-3 flex aspect-square w-5 items-center justify-center rounded-md p-0 outline-hidden transition-transform focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0\",\n        // Increases the hit area of the button on mobile.\n        \"after:absolute after:-inset-2 md:after:hidden\",\n        \"group-data-[collapsible=icon]:hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarGroupContent({\n  className,\n  ...props\n}: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-group-content\"\n      data-sidebar=\"group-content\"\n      className={cn(\"w-full text-sm\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenu({ className, ...props }: React.ComponentProps<\"ul\">) {\n  return (\n    <ul\n      data-slot=\"sidebar-menu\"\n      data-sidebar=\"menu\"\n      className={cn(\"flex w-full min-w-0 flex-col gap-1\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenuItem({ className, ...props }: React.ComponentProps<\"li\">) {\n  return (\n    <li\n      data-slot=\"sidebar-menu-item\"\n      data-sidebar=\"menu-item\"\n      className={cn(\"group/menu-item relative\", className)}\n      {...props}\n    />\n  )\n}\n\nconst sidebarMenuButtonVariants = cva(\n  \"peer/menu-button flex w-full items-center gap-2 overflow-hidden rounded-md p-2 text-left text-sm outline-hidden ring-sidebar-ring transition-[width,height,padding] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 group-has-data-[sidebar=menu-action]/menu-item:pr-8 aria-disabled:pointer-events-none aria-disabled:opacity-50 data-[active=true]:bg-sidebar-accent data-[active=true]:font-medium data-[active=true]:text-sidebar-accent-foreground data-[state=open]:hover:bg-sidebar-accent data-[state=open]:hover:text-sidebar-accent-foreground group-data-[collapsible=icon]:w-8! group-data-[collapsible=icon]:h-8! group-data-[collapsible=icon]:p-2! [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0\",\n  {\n    variants: {\n      variant: {\n        default: \"hover:bg-sidebar-accent hover:text-sidebar-accent-foreground\",\n        outline:\n          \"bg-background shadow-[0_0_0_1px_hsl(var(--sidebar-border))] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground hover:shadow-[0_0_0_1px_hsl(var(--sidebar-accent))]\",\n      },\n      size: {\n        default: \"h-8 text-sm\",\n        sm: \"h-7 text-xs\",\n        lg: \"h-12 text-sm group-data-[collapsible=icon]:p-0!\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n      size: \"default\",\n    },\n  }\n)\n\nfunction SidebarMenuButton({\n  asChild = false,\n  isActive = false,\n  variant = \"default\",\n  size = \"default\",\n  tooltip,\n  className,\n  ...props\n}: React.ComponentProps<\"button\"> & {\n  asChild?: boolean\n  isActive?: boolean\n  tooltip?: string | React.ComponentProps<typeof TooltipContent>\n} & VariantProps<typeof sidebarMenuButtonVariants>) {\n  const Comp = asChild ? Slot : \"button\"\n  const { isMobile, state } = useSidebar()\n\n  const button = (\n    <Comp\n      data-slot=\"sidebar-menu-button\"\n      data-sidebar=\"menu-button\"\n      data-size={size}\n      data-active={isActive}\n      className={cn(sidebarMenuButtonVariants({ variant, size }), className)}\n      {...props}\n    />\n  )\n\n  if (!tooltip) {\n    return button\n  }\n\n  if (typeof tooltip === \"string\") {\n    tooltip = {\n      children: tooltip,\n    }\n  }\n\n  return (\n    <Tooltip>\n      <TooltipTrigger asChild>{button}</TooltipTrigger>\n      <TooltipContent\n        side=\"right\"\n        align=\"center\"\n        hidden={state !== \"collapsed\" || isMobile}\n        {...tooltip}\n      />\n    </Tooltip>\n  )\n}\n\nfunction SidebarMenuAction({\n  className,\n  asChild = false,\n  showOnHover = false,\n  ...props\n}: React.ComponentProps<\"button\"> & {\n  asChild?: boolean\n  showOnHover?: boolean\n}) {\n  const Comp = asChild ? Slot : \"button\"\n\n  return (\n    <Comp\n      data-slot=\"sidebar-menu-action\"\n      data-sidebar=\"menu-action\"\n      className={cn(\n        \"text-sidebar-foreground ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground peer-hover/menu-button:text-sidebar-accent-foreground absolute top-1.5 right-1 flex aspect-square w-5 items-center justify-center rounded-md p-0 outline-hidden transition-transform focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0\",\n        // Increases the hit area of the button on mobile.\n        \"after:absolute after:-inset-2 md:after:hidden\",\n        \"peer-data-[size=sm]/menu-button:top-1\",\n        \"peer-data-[size=default]/menu-button:top-1.5\",\n        \"peer-data-[size=lg]/menu-button:top-2.5\",\n        \"group-data-[collapsible=icon]:hidden\",\n        showOnHover &&\n          \"peer-data-[active=true]/menu-button:text-sidebar-accent-foreground group-focus-within/menu-item:opacity-100 group-hover/menu-item:opacity-100 data-[state=open]:opacity-100 md:opacity-0\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenuBadge({\n  className,\n  ...props\n}: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-menu-badge\"\n      data-sidebar=\"menu-badge\"\n      className={cn(\n        \"text-sidebar-foreground pointer-events-none absolute right-1 flex h-5 min-w-5 items-center justify-center rounded-md px-1 text-xs font-medium tabular-nums select-none\",\n        \"peer-hover/menu-button:text-sidebar-accent-foreground peer-data-[active=true]/menu-button:text-sidebar-accent-foreground\",\n        \"peer-data-[size=sm]/menu-button:top-1\",\n        \"peer-data-[size=default]/menu-button:top-1.5\",\n        \"peer-data-[size=lg]/menu-button:top-2.5\",\n        \"group-data-[collapsible=icon]:hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenuSkeleton({\n  className,\n  showIcon = false,\n  ...props\n}: React.ComponentProps<\"div\"> & {\n  showIcon?: boolean\n}) {\n  // Random width between 50 to 90%.\n  const width = React.useMemo(() => {\n    return `${Math.floor(Math.random() * 40) + 50}%`\n  }, [])\n\n  return (\n    <div\n      data-slot=\"sidebar-menu-skeleton\"\n      data-sidebar=\"menu-skeleton\"\n      className={cn(\"flex h-8 items-center gap-2 rounded-md px-2\", className)}\n      {...props}\n    >\n      {showIcon && (\n        <Skeleton\n          className=\"size-4 rounded-md\"\n          data-sidebar=\"menu-skeleton-icon\"\n        />\n      )}\n      <Skeleton\n        className=\"h-4 max-w-[var(--skeleton-width)] flex-1\"\n        data-sidebar=\"menu-skeleton-text\"\n        style={\n          {\n            \"--skeleton-width\": width,\n          } as React.CSSProperties\n        }\n      />\n    </div>\n  )\n}\n\nfunction SidebarMenuSub({ className, ...props }: React.ComponentProps<\"ul\">) {\n  return (\n    <ul\n      data-slot=\"sidebar-menu-sub\"\n      data-sidebar=\"menu-sub\"\n      className={cn(\n        \"border-sidebar-border mx-3.5 flex min-w-0 translate-x-px flex-col gap-1 border-l px-2.5 py-0.5\",\n        \"group-data-[collapsible=icon]:hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenuSubItem({\n  className,\n  ...props\n}: React.ComponentProps<\"li\">) {\n  return (\n    <li\n      data-slot=\"sidebar-menu-sub-item\"\n      data-sidebar=\"menu-sub-item\"\n      className={cn(\"group/menu-sub-item relative\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenuSubButton({\n  asChild = false,\n  size = \"md\",\n  isActive = false,\n  className,\n  ...props\n}: React.ComponentProps<\"a\"> & {\n  asChild?: boolean\n  size?: \"sm\" | \"md\"\n  isActive?: boolean\n}) {\n  const Comp = asChild ? Slot : \"a\"\n\n  return (\n    <Comp\n      data-slot=\"sidebar-menu-sub-button\"\n      data-sidebar=\"menu-sub-button\"\n      data-size={size}\n      data-active={isActive}\n      className={cn(\n        \"text-sidebar-foreground ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground active:bg-sidebar-accent active:text-sidebar-accent-foreground [&>svg]:text-sidebar-accent-foreground flex h-7 min-w-0 -translate-x-px items-center gap-2 overflow-hidden rounded-md px-2 outline outline-2 outline-transparent outline-offset-2 focus-visible:ring-2 disabled:pointer-events-none disabled:opacity-50 aria-disabled:pointer-events-none aria-disabled:opacity-50 [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0\",\n        \"data-[active=true]:bg-sidebar-accent data-[active=true]:text-sidebar-accent-foreground\",\n        size === \"sm\" && \"text-xs\",\n        size === \"md\" && \"text-sm\",\n        \"group-data-[collapsible=icon]:hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nexport {\n  Sidebar,\n  SidebarContent,\n  SidebarFooter,\n  SidebarGroup,\n  SidebarGroupAction,\n  SidebarGroupContent,\n  SidebarGroupLabel,\n  SidebarHeader,\n  SidebarInput,\n  SidebarInset,\n  SidebarMenu,\n  SidebarMenuAction,\n  SidebarMenuBadge,\n  SidebarMenuButton,\n  SidebarMenuItem,\n  SidebarMenuSkeleton,\n  SidebarMenuSub,\n  SidebarMenuSubButton,\n  SidebarMenuSubItem,\n  SidebarProvider,\n  SidebarRail,\n  SidebarSeparator,\n  SidebarTrigger,\n  useSidebar,\n}\n","path":null,"size_bytes":21846,"size_tokens":null},"client/src/pages/landing.tsx":{"content":"import { useState, useMemo, useEffect, useCallback, useRef } from \"react\";\nimport { useLocation } from \"wouter\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Input } from \"@/components/ui/input\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogHeader,\n  DialogTitle,\n} from \"@/components/ui/dialog\";\nimport { \n  Carousel,\n  CarouselContent,\n  CarouselItem,\n  CarouselPrevious,\n  CarouselNext,\n  type CarouselApi\n} from \"@/components/ui/carousel\";\nimport Autoplay from \"embla-carousel-autoplay\";\nimport { \n  Phone, \n  Store, \n  Search, \n  Package,\n  ChevronRight,\n  Loader2,\n  ShoppingBag,\n  Sparkles,\n  Truck,\n  CreditCard,\n  Shield,\n  Percent,\n  ShoppingCart,\n  User,\n  UserPlus\n} from \"lucide-react\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { ThemeToggle } from \"@/components/ThemeToggle\";\nimport { SiWhatsapp, SiMercadopago } from \"react-icons/si\";\nimport type { Product as SchemaProduct, Category } from \"@shared/schema\";\nimport { useCart } from \"@/contexts/CartContext\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport logoImage from \"@assets/image_1765659931449.png\";\nimport bannerImage1 from \"@assets/image_1765676126936.png\";\nimport bannerImage2 from \"@assets/image_1765676145067.png\";\n\ninterface ProductsResponse {\n  products: SchemaProduct[];\n  total: number;\n  page: number;\n  totalPages: number;\n}\n\nexport default function LandingPage() {\n  const [, setLocation] = useLocation();\n  const [searchQuery, setSearchQuery] = useState(\"\");\n  const [quantities, setQuantities] = useState<Record<number, number>>({});\n  const [showEmployeeLogin, setShowEmployeeLogin] = useState(false);\n  const logoClickCount = useRef(0);\n  const logoClickTimer = useRef<NodeJS.Timeout | null>(null);\n  const { addItem, itemCount, openCart } = useCart();\n  const { toast } = useToast();\n\n  const handleLogoClick = useCallback(() => {\n    logoClickCount.current += 1;\n    \n    if (logoClickTimer.current) {\n      clearTimeout(logoClickTimer.current);\n    }\n    \n    if (logoClickCount.current >= 3) {\n      setShowEmployeeLogin(true);\n      logoClickCount.current = 0;\n    } else {\n      logoClickTimer.current = setTimeout(() => {\n        logoClickCount.current = 0;\n      }, 1000);\n    }\n  }, []);\n\n  const { data: categoriesData = [], isLoading: categoriesLoading } = useQuery<Category[]>({\n    queryKey: ['/api/public/categories'],\n    queryFn: async () => {\n      const res = await fetch('/api/public/categories');\n      if (!res.ok) throw new Error('Failed to fetch categories');\n      return res.json();\n    },\n  });\n\n  const { data: newProductsResponse, isLoading: newProductsLoading } = useQuery<ProductsResponse>({\n    queryKey: ['/api/public/products', 'new'],\n    queryFn: async () => {\n      const res = await fetch('/api/public/products?limit=6&sort=newest');\n      if (!res.ok) throw new Error('Failed to fetch products');\n      return res.json();\n    },\n  });\n\n  const { data: productsResponse, isLoading: productsLoading } = useQuery<ProductsResponse>({\n    queryKey: ['/api/public/products', 'featured'],\n    queryFn: async () => {\n      const res = await fetch('/api/public/products?limit=12');\n      if (!res.ok) throw new Error('Failed to fetch products');\n      return res.json();\n    },\n  });\n\n  const newProductsData = newProductsResponse?.products || [];\n  const productsData = productsResponse?.products || [];\n\n  const categoryMap = useMemo(() => {\n    const map: Record<number, string> = {};\n    categoriesData.forEach(cat => {\n      map[cat.id] = cat.name;\n    });\n    return map;\n  }, [categoriesData]);\n\n  const formatPrice = (price: string | number) => {\n    const numPrice = typeof price === 'string' ? parseFloat(price) : price;\n    return new Intl.NumberFormat('pt-BR', {\n      style: 'currency',\n      currency: 'BRL'\n    }).format(numPrice);\n  };\n\n  const handleSearch = (e: React.FormEvent) => {\n    e.preventDefault();\n    if (searchQuery.trim()) {\n      setLocation(`/catalogo?search=${encodeURIComponent(searchQuery)}`);\n    }\n  };\n\n  const getQuantity = (productId: number) => quantities[productId] ?? 0;\n\n  const setQuantity = (productId: number, qty: number) => {\n    if (qty < 0) qty = 0;\n    if (qty > 999) qty = 999;\n    setQuantities(prev => ({ ...prev, [productId]: qty }));\n  };\n\n  const handleAddToCart = (product: SchemaProduct) => {\n    const qty = getQuantity(product.id);\n    if (qty <= 0) {\n      toast({\n        title: \"Informe a quantidade\",\n        description: \"Digite a quantidade desejada\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n    \n    const price = typeof product.price === 'string' ? parseFloat(product.price) : product.price;\n    \n    addItem({\n      productId: String(product.id),\n      name: product.name,\n      sku: product.sku,\n      price: price,\n      quantity: qty,\n      image: product.image || undefined,\n    });\n\n    toast({\n      title: \"Adicionado ao carrinho\",\n      description: `${qty}x ${product.name}`,\n    });\n\n    setQuantities(prev => ({ ...prev, [product.id]: 0 }));\n  };\n\n  return (\n    <div className=\"min-h-screen bg-background flex flex-col\">\n      <header className=\"sticky top-0 z-50 bg-zinc-900 text-white\">\n        <div className=\"container mx-auto px-4 py-3\">\n          <div className=\"flex items-center justify-between gap-4\">\n            <div className=\"flex items-center gap-3\">\n              <img \n                src={logoImage} \n                alt=\"Lojamadrugadao\" \n                className=\"h-12 w-12 rounded-full border-2 border-white/20 cursor-pointer select-none\"\n                onClick={handleLogoClick}\n                data-testid=\"img-logo\"\n              />\n              <div className=\"hidden sm:block\">\n                <h1 className=\"font-bold text-lg tracking-wide\">LOJAMADRUGADAO</h1>\n                <div \n                  className=\"flex items-center gap-1 text-zinc-400 text-xs cursor-pointer select-none\"\n                  onDoubleClick={() => setLocation(\"/login\")}\n                  data-testid=\"phone-employee-login\"\n                >\n                  <Phone className=\"h-3 w-3\" />\n                  <span>11 99294-0168</span>\n                </div>\n              </div>\n            </div>\n\n            <form onSubmit={handleSearch} className=\"hidden md:flex flex-1 max-w-md mx-4\">\n              <div className=\"relative w-full\">\n                <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-zinc-400\" />\n                <Input\n                  placeholder=\"Buscar produtos...\"\n                  value={searchQuery}\n                  onChange={(e) => setSearchQuery(e.target.value)}\n                  className=\"pl-10 bg-zinc-800 border-zinc-700 text-white placeholder:text-zinc-500\"\n                  data-testid=\"input-search\"\n                />\n              </div>\n            </form>\n\n            <div className=\"flex items-center gap-2\">\n              <Button \n                variant=\"ghost\"\n                size=\"icon\"\n                onClick={openCart}\n                className=\"text-white hover:bg-zinc-800 relative\"\n                data-testid=\"button-cart\"\n              >\n                <ShoppingCart className=\"h-5 w-5\" />\n                {itemCount > 0 && (\n                  <span className=\"absolute -top-1 -right-1 bg-orange-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center font-medium\">\n                    {itemCount > 99 ? \"99+\" : itemCount}\n                  </span>\n                )}\n              </Button>\n              \n              <Button \n                variant=\"ghost\"\n                size=\"sm\"\n                onClick={() => setLocation(\"/login\")}\n                className=\"text-white hover:bg-zinc-800 hidden sm:flex\"\n                data-testid=\"button-login\"\n              >\n                <User className=\"h-4 w-4 mr-1\" />\n                Entrar\n              </Button>\n              \n              <Button \n                variant=\"ghost\"\n                size=\"sm\"\n                onClick={() => setLocation(\"/register\")}\n                className=\"text-white hover:bg-zinc-800 hidden sm:flex\"\n                data-testid=\"button-register\"\n              >\n                <UserPlus className=\"h-4 w-4 mr-1\" />\n                Cadastrar\n              </Button>\n              \n              <Button \n                onClick={() => setLocation(\"/login\")}\n                className=\"bg-orange-500 hover:bg-orange-600 text-white\"\n                data-testid=\"button-atacado-login\"\n              >\n                <Store className=\"h-4 w-4 mr-2\" />\n                <span className=\"hidden sm:inline\">Atacado</span>\n              </Button>\n              <ThemeToggle />\n            </div>\n          </div>\n        </div>\n      </header>\n\n      <section className=\"relative\">\n        <Carousel \n          opts={{ loop: true }} \n          plugins={[Autoplay({ delay: 4000, stopOnInteraction: false })]}\n          className=\"w-full\"\n          data-testid=\"carousel-banner\"\n        >\n          <CarouselContent>\n            <CarouselItem>\n              <div className=\"relative aspect-[21/9] md:aspect-[3/1] w-full overflow-hidden\">\n                <img \n                  src={bannerImage1} \n                  alt=\"Promocao Bem Bolado\" \n                  className=\"w-full h-full object-cover\"\n                  data-testid=\"img-banner-1\"\n                />\n              </div>\n            </CarouselItem>\n            <CarouselItem>\n              <div className=\"relative aspect-[21/9] md:aspect-[3/1] w-full overflow-hidden\">\n                <img \n                  src={bannerImage2} \n                  alt=\"Promocao Especial\" \n                  className=\"w-full h-full object-cover\"\n                  data-testid=\"img-banner-2\"\n                />\n              </div>\n            </CarouselItem>\n            <CarouselItem>\n              <div className=\"relative aspect-[21/9] md:aspect-[3/1] w-full overflow-hidden bg-gradient-to-r from-zinc-900 to-zinc-800\">\n                <div className=\"absolute inset-0 flex items-center\">\n                  <div className=\"container mx-auto px-4\">\n                    <div className=\"flex flex-col md:flex-row items-center justify-between gap-6\">\n                      <div className=\"max-w-lg text-center md:text-left\">\n                        <h2 className=\"text-2xl md:text-4xl font-bold text-white mb-2\">\n                          Compre no Atacado\n                        </h2>\n                        <p className=\"text-white/80 text-sm md:text-base mb-4\">\n                          Precos exclusivos para revendedores. Cadastre-se e economize ate 40% nos produtos!\n                        </p>\n                        <div className=\"flex flex-col sm:flex-row gap-3 justify-center md:justify-start\">\n                          <Button \n                            size=\"lg\"\n                            onClick={() => setLocation(\"/register\")}\n                            className=\"bg-orange-500 hover:bg-orange-600\"\n                            data-testid=\"button-cadastrar-atacado\"\n                          >\n                            <Store className=\"h-5 w-5 mr-2\" />\n                            Solicitar Cadastro\n                          </Button>\n                          <Button \n                            size=\"lg\"\n                            variant=\"outline\"\n                            onClick={() => setLocation(\"/login\")}\n                            className=\"border-white/30 text-white hover:bg-white/10\"\n                            data-testid=\"button-ja-tenho-conta\"\n                          >\n                            Ja tenho conta\n                          </Button>\n                        </div>\n                      </div>\n                      <div className=\"hidden md:flex items-center gap-4\">\n                        <div className=\"text-center p-4 bg-white/10 rounded-lg\">\n                          <p className=\"text-3xl font-bold text-orange-500\">40%</p>\n                          <p className=\"text-white/80 text-sm\">de desconto</p>\n                        </div>\n                        <div className=\"text-center p-4 bg-white/10 rounded-lg\">\n                          <p className=\"text-3xl font-bold text-orange-500\">12x</p>\n                          <p className=\"text-white/80 text-sm\">sem juros</p>\n                        </div>\n                        <div className=\"text-center p-4 bg-white/10 rounded-lg\">\n                          <p className=\"text-3xl font-bold text-orange-500\">Frete</p>\n                          <p className=\"text-white/80 text-sm\">Gratis SP</p>\n                        </div>\n                      </div>\n                    </div>\n                  </div>\n                </div>\n              </div>\n            </CarouselItem>\n          </CarouselContent>\n          <CarouselPrevious className=\"left-4\" />\n          <CarouselNext className=\"right-4\" />\n        </Carousel>\n      </section>\n\n      <form onSubmit={handleSearch} className=\"md:hidden container mx-auto px-4 py-4\">\n        <div className=\"relative\">\n          <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\n          <Input\n            placeholder=\"Buscar produtos...\"\n            value={searchQuery}\n            onChange={(e) => setSearchQuery(e.target.value)}\n            className=\"pl-10\"\n            data-testid=\"input-search-mobile\"\n          />\n        </div>\n      </form>\n\n      {categoriesData.length > 0 && (\n        <section className=\"container mx-auto px-4 py-6\">\n          <div className=\"flex items-center justify-between mb-4\">\n            <h2 className=\"text-xl font-bold\">Categorias</h2>\n            <Button \n              variant=\"ghost\" \n              size=\"sm\"\n              onClick={() => setLocation(\"/catalogo\")}\n              data-testid=\"button-ver-categorias\"\n            >\n              Ver todas\n              <ChevronRight className=\"h-4 w-4 ml-1\" />\n            </Button>\n          </div>\n          \n          {categoriesLoading ? (\n            <div className=\"flex justify-center py-8\">\n              <Loader2 className=\"h-6 w-6 animate-spin text-muted-foreground\" />\n            </div>\n          ) : (\n            <div className=\"flex gap-3 overflow-x-auto pb-2 scrollbar-hide\">\n              {categoriesData.slice(0, 10).map(category => (\n                <Button\n                  key={category.id}\n                  variant=\"outline\"\n                  className=\"shrink-0 px-4\"\n                  onClick={() => setLocation(`/catalogo?category=${encodeURIComponent(category.name)}`)}\n                  data-testid={`button-category-${category.id}`}\n                >\n                  {category.name}\n                </Button>\n              ))}\n            </div>\n          )}\n        </section>\n      )}\n\n      <section className=\"bg-muted/50 py-4 border-y\">\n        <div className=\"container mx-auto px-4\">\n          <div className=\"flex flex-wrap justify-center gap-6 md:gap-12 text-sm\">\n            <div className=\"flex items-center gap-2\">\n              <Truck className=\"h-5 w-5 text-orange-500\" />\n              <div>\n                <p className=\"font-semibold\">Frete Gratis</p>\n                <p className=\"text-xs text-muted-foreground\">Acima de R$299</p>\n              </div>\n            </div>\n            <div className=\"flex items-center gap-2\">\n              <CreditCard className=\"h-5 w-5 text-orange-500\" />\n              <div>\n                <p className=\"font-semibold\">12x no Cartao</p>\n                <p className=\"text-xs text-muted-foreground\">Sem juros</p>\n              </div>\n            </div>\n            <div className=\"flex items-center gap-2\">\n              <Shield className=\"h-5 w-5 text-orange-500\" />\n              <div>\n                <p className=\"font-semibold\">100% Seguro</p>\n                <p className=\"text-xs text-muted-foreground\">Compra protegida</p>\n              </div>\n            </div>\n            <div className=\"flex items-center gap-2\">\n              <Percent className=\"h-5 w-5 text-orange-500\" />\n              <div>\n                <p className=\"font-semibold\">5% Desconto</p>\n                <p className=\"text-xs text-muted-foreground\">Pagamento via PIX</p>\n              </div>\n            </div>\n          </div>\n          <p className=\"text-center text-xs text-muted-foreground mt-3\">\n            *Condicoes validas apenas para compras no varejo\n          </p>\n        </div>\n      </section>\n\n      {categoriesData.length >= 3 && (\n        <section className=\"container mx-auto px-4 py-6\">\n          <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n            {categoriesData.slice(0, 3).map((category, index) => (\n              <Card \n                key={category.id}\n                className=\"overflow-hidden cursor-pointer group hover-elevate\"\n                onClick={() => setLocation(`/catalogo?category=${encodeURIComponent(category.name)}`)}\n                data-testid={`banner-category-${category.id}`}\n              >\n                <div className=\"relative h-32 md:h-40 bg-gradient-to-br from-zinc-800 to-zinc-900 flex items-center justify-center\">\n                  <div className=\"absolute inset-0 bg-gradient-to-t from-black/60 to-transparent\" />\n                  <h3 className=\"relative text-xl md:text-2xl font-bold text-white text-center px-4 group-hover:scale-105 transition-transform\">\n                    {category.name.toUpperCase()}\n                  </h3>\n                </div>\n              </Card>\n            ))}\n          </div>\n        </section>\n      )}\n\n      {newProductsData.length > 0 && (\n        <section className=\"container mx-auto px-4 py-6\">\n          <div className=\"flex items-center justify-between mb-4\">\n            <div className=\"flex items-center gap-2\">\n              <Sparkles className=\"h-5 w-5 text-orange-500\" />\n              <h2 className=\"text-xl font-bold\">Lancamentos</h2>\n            </div>\n            <Button \n              variant=\"ghost\" \n              size=\"sm\"\n              onClick={() => setLocation(\"/catalogo\")}\n              data-testid=\"button-ver-lancamentos\"\n            >\n              Ver todos\n              <ChevronRight className=\"h-4 w-4 ml-1\" />\n            </Button>\n          </div>\n          \n          {newProductsLoading ? (\n            <div className=\"flex justify-center py-8\">\n              <Loader2 className=\"h-6 w-6 animate-spin text-muted-foreground\" />\n            </div>\n          ) : (\n            <div className=\"grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-3\">\n              {newProductsData.map(product => (\n                <Card \n                  key={product.id}\n                  className=\"overflow-hidden group hover-elevate transition-all duration-200 ring-2 ring-orange-500/20\"\n                  data-testid={`card-new-product-${product.id}`}\n                >\n                  <div className=\"aspect-square bg-muted/30 flex items-center justify-center relative overflow-hidden\">\n                    {product.image ? (\n                      <img\n                        src={product.image}\n                        alt={product.name}\n                        className=\"w-full h-full object-cover transition-transform duration-300 group-hover:scale-105\"\n                      />\n                    ) : (\n                      <Package className=\"h-12 w-12 text-muted-foreground/20\" />\n                    )}\n                    <div className=\"absolute top-1.5 right-1.5\">\n                      <Badge className=\"text-xs font-medium bg-orange-500 text-white\">\n                        Novo\n                      </Badge>\n                    </div>\n                    {product.stock === 0 && (\n                      <div className=\"absolute inset-0 bg-background/80 flex items-center justify-center backdrop-blur-sm\">\n                        <Badge variant=\"destructive\">Indisponivel</Badge>\n                      </div>\n                    )}\n                    {product.brand && (\n                      <div className=\"absolute top-1.5 left-1.5\">\n                        <Badge variant=\"secondary\" className=\"text-xs font-medium bg-background/90 backdrop-blur-sm\">\n                          {product.brand}\n                        </Badge>\n                      </div>\n                    )}\n                  </div>\n                  <CardContent className=\"p-2\">\n                    <p className=\"text-xs text-muted-foreground mb-0.5 font-mono\">\n                      {product.sku}\n                    </p>\n                    <h3 className=\"font-medium text-xs line-clamp-2 min-h-[2rem] leading-tight mb-1\">\n                      {product.name}\n                    </h3>\n                    <p className=\"text-sm font-bold text-orange-600 dark:text-orange-500 mb-2\">\n                      {formatPrice(product.price)}\n                    </p>\n                    {product.stock > 0 && (\n                      <div className=\"flex items-center gap-1\">\n                        <Input\n                          type=\"number\"\n                          min=\"0\"\n                          max=\"999\"\n                          value={getQuantity(product.id)}\n                          onChange={(e) => setQuantity(product.id, parseInt(e.target.value) || 0)}\n                          onClick={(e) => e.stopPropagation()}\n                          className=\"h-8 w-14 text-center text-sm\"\n                          data-testid={`input-qty-new-${product.id}`}\n                        />\n                        <Button\n                          className=\"flex-1 bg-orange-500 hover:bg-orange-600 text-white h-8 font-semibold text-xs\"\n                          onClick={(e) => {\n                            e.stopPropagation();\n                            handleAddToCart(product);\n                          }}\n                          data-testid={`button-add-cart-new-${product.id}`}\n                        >\n                          COMPRAR\n                        </Button>\n                      </div>\n                    )}\n                  </CardContent>\n                </Card>\n              ))}\n            </div>\n          )}\n        </section>\n      )}\n\n      <section className=\"container mx-auto px-4 py-6 flex-1\">\n        <div className=\"flex items-center justify-between mb-4\">\n          <h2 className=\"text-xl font-bold\">Produtos em Destaque</h2>\n          <Button \n            variant=\"ghost\" \n            size=\"sm\"\n            onClick={() => setLocation(\"/catalogo\")}\n            data-testid=\"button-ver-produtos\"\n          >\n            Ver todos\n            <ChevronRight className=\"h-4 w-4 ml-1\" />\n          </Button>\n        </div>\n\n        {productsLoading ? (\n          <div className=\"flex flex-col items-center justify-center py-16\">\n            <Loader2 className=\"h-8 w-8 animate-spin text-primary mb-4\" />\n            <p className=\"text-muted-foreground\">Carregando produtos...</p>\n          </div>\n        ) : productsData.length === 0 ? (\n          <div className=\"flex flex-col items-center justify-center py-16 text-center\">\n            <div className=\"w-20 h-20 rounded-full bg-muted/50 flex items-center justify-center mb-4\">\n              <Package className=\"h-10 w-10 text-muted-foreground/50\" />\n            </div>\n            <h3 className=\"font-semibold text-lg mb-2\">Nenhum produto disponivel</h3>\n            <p className=\"text-muted-foreground text-sm\">\n              Os produtos serao exibidos aqui quando forem cadastrados\n            </p>\n          </div>\n        ) : (\n          <div className=\"grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-3\">\n            {productsData.map(product => (\n              <Card \n                key={product.id}\n                className=\"overflow-hidden group hover-elevate transition-all duration-200\"\n                data-testid={`card-product-${product.id}`}\n              >\n                <div className=\"aspect-square bg-muted/30 flex items-center justify-center relative overflow-hidden\">\n                  {product.image ? (\n                    <img\n                      src={product.image}\n                      alt={product.name}\n                      className=\"w-full h-full object-cover transition-transform duration-300 group-hover:scale-105\"\n                    />\n                  ) : (\n                    <Package className=\"h-12 w-12 text-muted-foreground/20\" />\n                  )}\n                  {product.stock === 0 && (\n                    <div className=\"absolute inset-0 bg-background/80 flex items-center justify-center backdrop-blur-sm\">\n                      <Badge variant=\"destructive\">Indisponivel</Badge>\n                    </div>\n                  )}\n                  {product.brand && (\n                    <div className=\"absolute top-1.5 left-1.5\">\n                      <Badge variant=\"secondary\" className=\"text-xs font-medium bg-background/90 backdrop-blur-sm\">\n                        {product.brand}\n                      </Badge>\n                    </div>\n                  )}\n                </div>\n                <CardContent className=\"p-2\">\n                  <p className=\"text-xs text-muted-foreground mb-0.5 font-mono\">\n                    {product.sku}\n                  </p>\n                  <h3 className=\"font-medium text-xs line-clamp-2 min-h-[2rem] leading-tight mb-1\">\n                    {product.name}\n                  </h3>\n                  <p className=\"text-sm font-bold text-orange-600 dark:text-orange-500 mb-2\" data-testid={`text-price-${product.id}`}>\n                    {formatPrice(product.price)}\n                  </p>\n                  {product.stock > 0 && (\n                    <div className=\"flex items-center gap-1\">\n                      <Input\n                        type=\"number\"\n                        min=\"0\"\n                        max=\"999\"\n                        value={getQuantity(product.id)}\n                        onChange={(e) => setQuantity(product.id, parseInt(e.target.value) || 0)}\n                        onClick={(e) => e.stopPropagation()}\n                        className=\"h-8 w-14 text-center text-sm\"\n                        data-testid={`input-qty-${product.id}`}\n                      />\n                      <Button\n                        className=\"flex-1 bg-orange-500 hover:bg-orange-600 text-white h-8 font-semibold text-xs\"\n                        onClick={(e) => {\n                          e.stopPropagation();\n                          handleAddToCart(product);\n                        }}\n                        data-testid={`button-add-cart-${product.id}`}\n                      >\n                        COMPRAR\n                      </Button>\n                    </div>\n                  )}\n                </CardContent>\n              </Card>\n            ))}\n          </div>\n        )}\n      </section>\n\n      <section className=\"bg-black text-white py-16\">\n        <div className=\"container mx-auto px-4\">\n          <div className=\"text-center max-w-2xl mx-auto\">\n            <img \n              src={logoImage} \n              alt=\"Lojamadrugadao\" \n              className=\"h-20 w-20 rounded-full mx-auto mb-6 border-2 border-white/20\"\n            />\n            <h2 className=\"text-3xl md:text-4xl font-bold mb-4\">@LOJAMADRUGADAO</h2>\n            <p className=\"text-zinc-400 mb-8\">\n              Siga a gente e fique por dentro das novidades.\n            </p>\n            <Button \n              size=\"lg\"\n              onClick={() => window.open(\"https://instagram.com/lojamadrugadao\", \"_blank\")}\n              className=\"bg-green-500 hover:bg-green-600 text-white font-bold px-8\"\n              data-testid=\"button-seguir-instagram\"\n            >\n              SEGUIR NO INSTAGRAM\n            </Button>\n          </div>\n        </div>\n      </section>\n\n      <section className=\"bg-fuchsia-600 py-12\">\n        <div className=\"container mx-auto px-4\">\n          <div className=\"flex flex-col sm:flex-row items-center justify-center gap-4\">\n            <Button \n              size=\"lg\"\n              onClick={() => window.open(\"https://www.mercadolivre.com.br/pagina/loja420#from=share_eshop\", \"_blank\")}\n              className=\"bg-white hover:bg-gray-100 text-indigo-900 font-bold px-8 py-6 text-base border-2 border-black min-w-[280px]\"\n              data-testid=\"button-mercado-livre\"\n            >\n              COMPRE NO MERCADO LIVRE\n            </Button>\n            <Button \n              size=\"lg\"\n              onClick={() => window.open(\"https://wa.me/5511992845596\", \"_blank\")}\n              className=\"bg-emerald-500 hover:bg-emerald-600 text-white font-bold px-8 py-6 text-base border-2 border-black min-w-[280px]\"\n              data-testid=\"button-whatsapp\"\n            >\n              <SiWhatsapp className=\"h-5 w-5 mr-2\" />\n              FALAR COM DISTRIBUIDOR\n            </Button>\n          </div>\n        </div>\n      </section>\n\n      <footer className=\"border-t py-4 bg-zinc-900 text-white\">\n        <div className=\"container mx-auto px-4\">\n          <div className=\"flex flex-col md:flex-row items-center justify-between gap-4\">\n            <div className=\"flex items-center gap-3\">\n              <img \n                src={logoImage} \n                alt=\"Lojamadrugadao\" \n                className=\"h-8 w-8 rounded-full\"\n              />\n              <div>\n                <p className=\"font-semibold text-sm\">LOJAMADRUGADAO SAO PAULO</p>\n                <div className=\"flex items-center gap-1 text-zinc-400 text-xs\">\n                  <Phone className=\"h-3 w-3\" />\n                  <span>11 99294-0168</span>\n                </div>\n              </div>\n            </div>\n            <p className=\"text-xs text-zinc-400\">\n              Precos de varejo. Para precos de atacado, faca login.\n            </p>\n          </div>\n        </div>\n      </footer>\n\n      <Dialog open={showEmployeeLogin} onOpenChange={setShowEmployeeLogin}>\n        <DialogContent className=\"sm:max-w-md\">\n          <DialogHeader>\n            <DialogTitle>Acesso Funcionario</DialogTitle>\n          </DialogHeader>\n          <div className=\"flex flex-col gap-4 py-4\">\n            <p className=\"text-sm text-muted-foreground\">\n              Area restrita para funcionarios da empresa.\n            </p>\n            <Button \n              onClick={() => {\n                setShowEmployeeLogin(false);\n                setLocation(\"/login\");\n              }}\n              className=\"w-full\"\n              data-testid=\"button-employee-login-confirm\"\n            >\n              <User className=\"h-4 w-4 mr-2\" />\n              Entrar como Funcionario\n            </Button>\n          </div>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n","path":null,"size_bytes":30728,"size_tokens":null},"client/src/components/ui/tooltip.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as TooltipPrimitive from \"@radix-ui/react-tooltip\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst TooltipProvider = TooltipPrimitive.Provider\n\nconst Tooltip = TooltipPrimitive.Root\n\nconst TooltipTrigger = TooltipPrimitive.Trigger\n\nconst TooltipContent = React.forwardRef<\n  React.ElementRef<typeof TooltipPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof TooltipPrimitive.Content>\n>(({ className, sideOffset = 4, ...props }, ref) => (\n  <TooltipPrimitive.Content\n    ref={ref}\n    sideOffset={sideOffset}\n    className={cn(\n      \"z-50 overflow-hidden rounded-md border bg-popover px-3 py-1.5 text-sm text-popover-foreground shadow-md animate-in fade-in-0 zoom-in-95 data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=closed]:zoom-out-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-tooltip-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nTooltipContent.displayName = TooltipPrimitive.Content.displayName\n\nexport { Tooltip, TooltipTrigger, TooltipContent, TooltipProvider }\n","path":null,"size_bytes":1209,"size_tokens":null},"client/src/components/ui/resizable.tsx":{"content":"\"use client\"\n\nimport { GripVertical } from \"lucide-react\"\nimport * as ResizablePrimitive from \"react-resizable-panels\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ResizablePanelGroup = ({\n  className,\n  ...props\n}: React.ComponentProps<typeof ResizablePrimitive.PanelGroup>) => (\n  <ResizablePrimitive.PanelGroup\n    className={cn(\n      \"flex h-full w-full data-[panel-group-direction=vertical]:flex-col\",\n      className\n    )}\n    {...props}\n  />\n)\n\nconst ResizablePanel = ResizablePrimitive.Panel\n\nconst ResizableHandle = ({\n  withHandle,\n  className,\n  ...props\n}: React.ComponentProps<typeof ResizablePrimitive.PanelResizeHandle> & {\n  withHandle?: boolean\n}) => (\n  <ResizablePrimitive.PanelResizeHandle\n    className={cn(\n      \"relative flex w-px items-center justify-center bg-border after:absolute after:inset-y-0 after:left-1/2 after:w-1 after:-translate-x-1/2 focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring focus-visible:ring-offset-1 data-[panel-group-direction=vertical]:h-px data-[panel-group-direction=vertical]:w-full data-[panel-group-direction=vertical]:after:left-0 data-[panel-group-direction=vertical]:after:h-1 data-[panel-group-direction=vertical]:after:w-full data-[panel-group-direction=vertical]:after:-translate-y-1/2 data-[panel-group-direction=vertical]:after:translate-x-0 [&[data-panel-group-direction=vertical]>div]:rotate-90\",\n      className\n    )}\n    {...props}\n  >\n    {withHandle && (\n      <div className=\"z-10 flex h-4 w-3 items-center justify-center rounded-sm border bg-border\">\n        <GripVertical className=\"h-2.5 w-2.5\" />\n      </div>\n    )}\n  </ResizablePrimitive.PanelResizeHandle>\n)\n\nexport { ResizablePanelGroup, ResizablePanel, ResizableHandle }\n","path":null,"size_bytes":1723,"size_tokens":null},"client/src/components/ui/checkbox.tsx":{"content":"import * as React from \"react\"\nimport * as CheckboxPrimitive from \"@radix-ui/react-checkbox\"\nimport { Check } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Checkbox = React.forwardRef<\n  React.ElementRef<typeof CheckboxPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof CheckboxPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <CheckboxPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"peer h-4 w-4 shrink-0 rounded-sm border border-primary ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=checked]:text-primary-foreground\",\n      className\n    )}\n    {...props}\n  >\n    <CheckboxPrimitive.Indicator\n      className={cn(\"flex items-center justify-center text-current\")}\n    >\n      <Check className=\"h-4 w-4\" />\n    </CheckboxPrimitive.Indicator>\n  </CheckboxPrimitive.Root>\n))\nCheckbox.displayName = CheckboxPrimitive.Root.displayName\n\nexport { Checkbox }\n","path":null,"size_bytes":1056,"size_tokens":null},"client/src/components/ui/pagination.tsx":{"content":"import * as React from \"react\"\nimport { ChevronLeft, ChevronRight, MoreHorizontal } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\nimport { ButtonProps, buttonVariants } from \"@/components/ui/button\"\n\nconst Pagination = ({ className, ...props }: React.ComponentProps<\"nav\">) => (\n  <nav\n    role=\"navigation\"\n    aria-label=\"pagination\"\n    className={cn(\"mx-auto flex w-full justify-center\", className)}\n    {...props}\n  />\n)\nPagination.displayName = \"Pagination\"\n\nconst PaginationContent = React.forwardRef<\n  HTMLUListElement,\n  React.ComponentProps<\"ul\">\n>(({ className, ...props }, ref) => (\n  <ul\n    ref={ref}\n    className={cn(\"flex flex-row items-center gap-1\", className)}\n    {...props}\n  />\n))\nPaginationContent.displayName = \"PaginationContent\"\n\nconst PaginationItem = React.forwardRef<\n  HTMLLIElement,\n  React.ComponentProps<\"li\">\n>(({ className, ...props }, ref) => (\n  <li ref={ref} className={cn(\"\", className)} {...props} />\n))\nPaginationItem.displayName = \"PaginationItem\"\n\ntype PaginationLinkProps = {\n  isActive?: boolean\n} & Pick<ButtonProps, \"size\"> &\n  React.ComponentProps<\"a\">\n\nconst PaginationLink = ({\n  className,\n  isActive,\n  size = \"icon\",\n  ...props\n}: PaginationLinkProps) => (\n  <a\n    aria-current={isActive ? \"page\" : undefined}\n    className={cn(\n      buttonVariants({\n        variant: isActive ? \"outline\" : \"ghost\",\n        size,\n      }),\n      className\n    )}\n    {...props}\n  />\n)\nPaginationLink.displayName = \"PaginationLink\"\n\nconst PaginationPrevious = ({\n  className,\n  ...props\n}: React.ComponentProps<typeof PaginationLink>) => (\n  <PaginationLink\n    aria-label=\"Go to previous page\"\n    size=\"default\"\n    className={cn(\"gap-1 pl-2.5\", className)}\n    {...props}\n  >\n    <ChevronLeft className=\"h-4 w-4\" />\n    <span>Previous</span>\n  </PaginationLink>\n)\nPaginationPrevious.displayName = \"PaginationPrevious\"\n\nconst PaginationNext = ({\n  className,\n  ...props\n}: React.ComponentProps<typeof PaginationLink>) => (\n  <PaginationLink\n    aria-label=\"Go to next page\"\n    size=\"default\"\n    className={cn(\"gap-1 pr-2.5\", className)}\n    {...props}\n  >\n    <span>Next</span>\n    <ChevronRight className=\"h-4 w-4\" />\n  </PaginationLink>\n)\nPaginationNext.displayName = \"PaginationNext\"\n\nconst PaginationEllipsis = ({\n  className,\n  ...props\n}: React.ComponentProps<\"span\">) => (\n  <span\n    aria-hidden\n    className={cn(\"flex h-9 w-9 items-center justify-center\", className)}\n    {...props}\n  >\n    <MoreHorizontal className=\"h-4 w-4\" />\n    <span className=\"sr-only\">More pages</span>\n  </span>\n)\nPaginationEllipsis.displayName = \"PaginationEllipsis\"\n\nexport {\n  Pagination,\n  PaginationContent,\n  PaginationEllipsis,\n  PaginationItem,\n  PaginationLink,\n  PaginationNext,\n  PaginationPrevious,\n}\n","path":null,"size_bytes":2751,"size_tokens":null},"client/src/components/ui/breadcrumb.tsx":{"content":"import * as React from \"react\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport { ChevronRight, MoreHorizontal } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Breadcrumb = React.forwardRef<\n  HTMLElement,\n  React.ComponentPropsWithoutRef<\"nav\"> & {\n    separator?: React.ReactNode\n  }\n>(({ ...props }, ref) => <nav ref={ref} aria-label=\"breadcrumb\" {...props} />)\nBreadcrumb.displayName = \"Breadcrumb\"\n\nconst BreadcrumbList = React.forwardRef<\n  HTMLOListElement,\n  React.ComponentPropsWithoutRef<\"ol\">\n>(({ className, ...props }, ref) => (\n  <ol\n    ref={ref}\n    className={cn(\n      \"flex flex-wrap items-center gap-1.5 break-words text-sm text-muted-foreground sm:gap-2.5\",\n      className\n    )}\n    {...props}\n  />\n))\nBreadcrumbList.displayName = \"BreadcrumbList\"\n\nconst BreadcrumbItem = React.forwardRef<\n  HTMLLIElement,\n  React.ComponentPropsWithoutRef<\"li\">\n>(({ className, ...props }, ref) => (\n  <li\n    ref={ref}\n    className={cn(\"inline-flex items-center gap-1.5\", className)}\n    {...props}\n  />\n))\nBreadcrumbItem.displayName = \"BreadcrumbItem\"\n\nconst BreadcrumbLink = React.forwardRef<\n  HTMLAnchorElement,\n  React.ComponentPropsWithoutRef<\"a\"> & {\n    asChild?: boolean\n  }\n>(({ asChild, className, ...props }, ref) => {\n  const Comp = asChild ? Slot : \"a\"\n\n  return (\n    <Comp\n      ref={ref}\n      className={cn(\"transition-colors hover:text-foreground\", className)}\n      {...props}\n    />\n  )\n})\nBreadcrumbLink.displayName = \"BreadcrumbLink\"\n\nconst BreadcrumbPage = React.forwardRef<\n  HTMLSpanElement,\n  React.ComponentPropsWithoutRef<\"span\">\n>(({ className, ...props }, ref) => (\n  <span\n    ref={ref}\n    role=\"link\"\n    aria-disabled=\"true\"\n    aria-current=\"page\"\n    className={cn(\"font-normal text-foreground\", className)}\n    {...props}\n  />\n))\nBreadcrumbPage.displayName = \"BreadcrumbPage\"\n\nconst BreadcrumbSeparator = ({\n  children,\n  className,\n  ...props\n}: React.ComponentProps<\"li\">) => (\n  <li\n    role=\"presentation\"\n    aria-hidden=\"true\"\n    className={cn(\"[&>svg]:w-3.5 [&>svg]:h-3.5\", className)}\n    {...props}\n  >\n    {children ?? <ChevronRight />}\n  </li>\n)\nBreadcrumbSeparator.displayName = \"BreadcrumbSeparator\"\n\nconst BreadcrumbEllipsis = ({\n  className,\n  ...props\n}: React.ComponentProps<\"span\">) => (\n  <span\n    role=\"presentation\"\n    aria-hidden=\"true\"\n    className={cn(\"flex h-9 w-9 items-center justify-center\", className)}\n    {...props}\n  >\n    <MoreHorizontal className=\"h-4 w-4\" />\n    <span className=\"sr-only\">More</span>\n  </span>\n)\nBreadcrumbEllipsis.displayName = \"BreadcrumbElipssis\"\n\nexport {\n  Breadcrumb,\n  BreadcrumbList,\n  BreadcrumbItem,\n  BreadcrumbLink,\n  BreadcrumbPage,\n  BreadcrumbSeparator,\n  BreadcrumbEllipsis,\n}\n","path":null,"size_bytes":2712,"size_tokens":null},"client/src/components/ui/toast.tsx":{"content":"import * as React from \"react\"\nimport * as ToastPrimitives from \"@radix-ui/react-toast\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\nimport { X } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ToastProvider = ToastPrimitives.Provider\n\nconst ToastViewport = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Viewport>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Viewport>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Viewport\n    ref={ref}\n    className={cn(\n      \"fixed top-0 z-[100] flex max-h-screen w-full flex-col-reverse p-4 sm:bottom-0 sm:right-0 sm:top-auto sm:flex-col md:max-w-[420px]\",\n      className\n    )}\n    {...props}\n  />\n))\nToastViewport.displayName = ToastPrimitives.Viewport.displayName\n\nconst toastVariants = cva(\n  \"group pointer-events-auto relative flex w-full items-center justify-between space-x-4 overflow-hidden rounded-md border p-6 pr-8 shadow-lg transition-all data-[swipe=cancel]:translate-x-0 data-[swipe=end]:translate-x-[var(--radix-toast-swipe-end-x)] data-[swipe=move]:translate-x-[var(--radix-toast-swipe-move-x)] data-[swipe=move]:transition-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[swipe=end]:animate-out data-[state=closed]:fade-out-80 data-[state=closed]:slide-out-to-right-full data-[state=open]:slide-in-from-top-full data-[state=open]:sm:slide-in-from-bottom-full\",\n  {\n    variants: {\n      variant: {\n        default: \"border bg-background text-foreground\",\n        destructive:\n          \"destructive group border-destructive bg-destructive text-destructive-foreground\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  }\n)\n\nconst Toast = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Root>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Root> &\n    VariantProps<typeof toastVariants>\n>(({ className, variant, ...props }, ref) => {\n  return (\n    <ToastPrimitives.Root\n      ref={ref}\n      className={cn(toastVariants({ variant }), className)}\n      {...props}\n    />\n  )\n})\nToast.displayName = ToastPrimitives.Root.displayName\n\nconst ToastAction = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Action>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Action>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Action\n    ref={ref}\n    className={cn(\n      \"inline-flex h-8 shrink-0 items-center justify-center rounded-md border bg-transparent px-3 text-sm font-medium ring-offset-background transition-colors hover:bg-secondary focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 group-[.destructive]:border-muted/40 group-[.destructive]:hover:border-destructive/30 group-[.destructive]:hover:bg-destructive group-[.destructive]:hover:text-destructive-foreground group-[.destructive]:focus:ring-destructive\",\n      className\n    )}\n    {...props}\n  />\n))\nToastAction.displayName = ToastPrimitives.Action.displayName\n\nconst ToastClose = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Close>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Close>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Close\n    ref={ref}\n    className={cn(\n      \"absolute right-2 top-2 rounded-md p-1 text-foreground/50 opacity-0 transition-opacity hover:text-foreground focus:opacity-100 focus:outline-none focus:ring-2 group-hover:opacity-100 group-[.destructive]:text-red-300 group-[.destructive]:hover:text-red-50 group-[.destructive]:focus:ring-red-400 group-[.destructive]:focus:ring-offset-red-600\",\n      className\n    )}\n    toast-close=\"\"\n    {...props}\n  >\n    <X className=\"h-4 w-4\" />\n  </ToastPrimitives.Close>\n))\nToastClose.displayName = ToastPrimitives.Close.displayName\n\nconst ToastTitle = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Title>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Title>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Title\n    ref={ref}\n    className={cn(\"text-sm font-semibold\", className)}\n    {...props}\n  />\n))\nToastTitle.displayName = ToastPrimitives.Title.displayName\n\nconst ToastDescription = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Description>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Description>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Description\n    ref={ref}\n    className={cn(\"text-sm opacity-90\", className)}\n    {...props}\n  />\n))\nToastDescription.displayName = ToastPrimitives.Description.displayName\n\ntype ToastProps = React.ComponentPropsWithoutRef<typeof Toast>\n\ntype ToastActionElement = React.ReactElement<typeof ToastAction>\n\nexport {\n  type ToastProps,\n  type ToastActionElement,\n  ToastProvider,\n  ToastViewport,\n  Toast,\n  ToastTitle,\n  ToastDescription,\n  ToastClose,\n  ToastAction,\n}\n","path":null,"size_bytes":4845,"size_tokens":null},"client/src/components/ui/menubar.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as MenubarPrimitive from \"@radix-ui/react-menubar\"\nimport { Check, ChevronRight, Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nfunction MenubarMenu({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Menu>) {\n  return <MenubarPrimitive.Menu {...props} />\n}\n\nfunction MenubarGroup({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Group>) {\n  return <MenubarPrimitive.Group {...props} />\n}\n\nfunction MenubarPortal({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Portal>) {\n  return <MenubarPrimitive.Portal {...props} />\n}\n\nfunction MenubarRadioGroup({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.RadioGroup>) {\n  return <MenubarPrimitive.RadioGroup {...props} />\n}\n\nfunction MenubarSub({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Sub>) {\n  return <MenubarPrimitive.Sub data-slot=\"menubar-sub\" {...props} />\n}\n\nconst Menubar = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"flex h-10 items-center space-x-1 rounded-md border bg-background p-1\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubar.displayName = MenubarPrimitive.Root.displayName\n\nconst MenubarTrigger = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Trigger>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.Trigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center rounded-sm px-3 py-1.5 text-sm font-medium outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarTrigger.displayName = MenubarPrimitive.Trigger.displayName\n\nconst MenubarSubTrigger = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.SubTrigger>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.SubTrigger> & {\n    inset?: boolean\n  }\n>(({ className, inset, children, ...props }, ref) => (\n  <MenubarPrimitive.SubTrigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <ChevronRight className=\"ml-auto h-4 w-4\" />\n  </MenubarPrimitive.SubTrigger>\n))\nMenubarSubTrigger.displayName = MenubarPrimitive.SubTrigger.displayName\n\nconst MenubarSubContent = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.SubContent>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.SubContent>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.SubContent\n    ref={ref}\n    className={cn(\n      \"z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-menubar-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarSubContent.displayName = MenubarPrimitive.SubContent.displayName\n\nconst MenubarContent = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Content>\n>(\n  (\n    { className, align = \"start\", alignOffset = -4, sideOffset = 8, ...props },\n    ref\n  ) => (\n    <MenubarPrimitive.Portal>\n      <MenubarPrimitive.Content\n        ref={ref}\n        align={align}\n        alignOffset={alignOffset}\n        sideOffset={sideOffset}\n        className={cn(\n          \"z-50 min-w-[12rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-menubar-content-transform-origin]\",\n          className\n        )}\n        {...props}\n      />\n    </MenubarPrimitive.Portal>\n  )\n)\nMenubarContent.displayName = MenubarPrimitive.Content.displayName\n\nconst MenubarItem = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Item> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <MenubarPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarItem.displayName = MenubarPrimitive.Item.displayName\n\nconst MenubarCheckboxItem = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.CheckboxItem>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.CheckboxItem>\n>(({ className, children, checked, ...props }, ref) => (\n  <MenubarPrimitive.CheckboxItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    checked={checked}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <MenubarPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </MenubarPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </MenubarPrimitive.CheckboxItem>\n))\nMenubarCheckboxItem.displayName = MenubarPrimitive.CheckboxItem.displayName\n\nconst MenubarRadioItem = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.RadioItem>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.RadioItem>\n>(({ className, children, ...props }, ref) => (\n  <MenubarPrimitive.RadioItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <MenubarPrimitive.ItemIndicator>\n        <Circle className=\"h-2 w-2 fill-current\" />\n      </MenubarPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </MenubarPrimitive.RadioItem>\n))\nMenubarRadioItem.displayName = MenubarPrimitive.RadioItem.displayName\n\nconst MenubarLabel = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Label> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <MenubarPrimitive.Label\n    ref={ref}\n    className={cn(\n      \"px-2 py-1.5 text-sm font-semibold\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarLabel.displayName = MenubarPrimitive.Label.displayName\n\nconst MenubarSeparator = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-muted\", className)}\n    {...props}\n  />\n))\nMenubarSeparator.displayName = MenubarPrimitive.Separator.displayName\n\nconst MenubarShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\n        \"ml-auto text-xs tracking-widest text-muted-foreground\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\nMenubarShortcut.displayname = \"MenubarShortcut\"\n\nexport {\n  Menubar,\n  MenubarMenu,\n  MenubarTrigger,\n  MenubarContent,\n  MenubarItem,\n  MenubarSeparator,\n  MenubarLabel,\n  MenubarCheckboxItem,\n  MenubarRadioGroup,\n  MenubarRadioItem,\n  MenubarPortal,\n  MenubarSubContent,\n  MenubarSubTrigger,\n  MenubarGroup,\n  MenubarSub,\n  MenubarShortcut,\n}\n","path":null,"size_bytes":8605,"size_tokens":null},"client/src/pages/customers.tsx":{"content":"import { useState, useMemo } from \"react\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Label } from \"@/components/ui/label\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle } from \"@/components/ui/dialog\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { \n  Search, \n  RefreshCw, \n  Loader2, \n  Users, \n  UserCheck, \n  UserX, \n  Building2,\n  Mail,\n  Phone,\n  MapPin,\n  Pencil,\n  Trash2,\n  Store,\n  ShoppingCart\n} from \"lucide-react\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\nimport type { User } from \"@shared/schema\";\n\nexport default function CustomersPage() {\n  const { toast } = useToast();\n  const [searchQuery, setSearchQuery] = useState(\"\");\n  const [showCreateDialog, setShowCreateDialog] = useState(false);\n  const [showEditDialog, setShowEditDialog] = useState(false);\n  const [editingCustomer, setEditingCustomer] = useState<User | null>(null);\n  const [formLoading, setFormLoading] = useState(false);\n  const [newCustomer, setNewCustomer] = useState({\n    personType: \"juridica\",\n    cnpj: \"\", cpf: \"\", company: \"\", tradingName: \"\", firstName: \"\", email: \"\", phone: \"\",\n    stateRegistration: \"\", cep: \"\", address: \"\", addressNumber: \"\", complement: \"\",\n    neighborhood: \"\", city: \"\", state: \"\",\n  });\n\n  const { data: usersData = [], isLoading, refetch } = useQuery<User[]>({\n    queryKey: ['/api/users'],\n  });\n\n  const customers = useMemo(() => {\n    return usersData.filter(u => u.role === \"customer\");\n  }, [usersData]);\n\n  const stats = useMemo(() => {\n    const total = customers.length;\n    const approved = customers.filter(c => c.approved).length;\n    const pending = customers.filter(c => !c.approved).length;\n    const withCompany = customers.filter(c => c.company).length;\n    const atacado = customers.filter(c => c.customerType === \"atacado\").length;\n    const varejo = customers.filter(c => c.customerType === \"varejo\" || !c.customerType).length;\n    \n    return {\n      total,\n      approved,\n      pending,\n      withCompany,\n      atacado,\n      varejo,\n      approvedPercent: total > 0 ? Math.round((approved / total) * 100) : 0,\n      pendingPercent: total > 0 ? Math.round((pending / total) * 100) : 0,\n    };\n  }, [customers]);\n\n  const filteredCustomers = useMemo(() => {\n    if (!searchQuery) return customers;\n    const query = searchQuery.toLowerCase();\n    return customers.filter(c => \n      c.email?.toLowerCase().includes(query) ||\n      c.firstName?.toLowerCase().includes(query) ||\n      c.lastName?.toLowerCase().includes(query) ||\n      c.company?.toLowerCase().includes(query)\n    );\n  }, [customers, searchQuery]);\n\n  const updateUserMutation = useMutation({\n    mutationFn: async ({ id, data }: { id: string; data: Partial<User> }) => {\n      await apiRequest(\"PATCH\", `/api/users/${id}`, data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/users'] });\n    },\n  });\n\n  const handleEdit = (customer: User) => {\n    setEditingCustomer(customer);\n    setShowEditDialog(true);\n  };\n\n  const handleSaveEdit = () => {\n    if (!editingCustomer) return;\n    updateUserMutation.mutate(\n      { id: editingCustomer.id, data: editingCustomer },\n      {\n        onSuccess: () => {\n          toast({ title: \"Sucesso\", description: \"Cadastro atualizado com sucesso\" });\n          setShowEditDialog(false);\n          setEditingCustomer(null);\n        },\n        onError: () => {\n          toast({ title: \"Erro\", description: \"Falha ao atualizar cadastro\", variant: \"destructive\" });\n        },\n      }\n    );\n  };\n\n  const handleApprove = (user: User) => {\n    updateUserMutation.mutate(\n      { id: user.id, data: { approved: true } },\n      {\n        onSuccess: () => {\n          toast({ title: \"Cliente Aprovado\", description: `${user.email} foi aprovado.` });\n        },\n        onError: () => {\n          toast({ title: \"Erro\", description: \"Falha ao aprovar cliente\", variant: \"destructive\" });\n        },\n      }\n    );\n  };\n\n  const handleReject = (user: User) => {\n    updateUserMutation.mutate(\n      { id: user.id, data: { approved: false } },\n      {\n        onSuccess: () => {\n          toast({ title: \"Cliente Bloqueado\", description: `${user.email} foi bloqueado.` });\n        },\n        onError: () => {\n          toast({ title: \"Erro\", description: \"Falha ao bloquear cliente\", variant: \"destructive\" });\n        },\n      }\n    );\n  };\n\n  const handleToggleCustomerType = (user: User) => {\n    const newType = user.customerType === \"atacado\" ? \"varejo\" : \"atacado\";\n    updateUserMutation.mutate(\n      { id: user.id, data: { customerType: newType } },\n      {\n        onSuccess: () => {\n          toast({ \n            title: \"Tipo Atualizado\", \n            description: `${user.firstName || user.email} agora e ${newType === \"atacado\" ? \"Atacado\" : \"Varejo\"}.` \n          });\n        },\n        onError: () => {\n          toast({ title: \"Erro\", description: \"Falha ao atualizar tipo de cliente\", variant: \"destructive\" });\n        },\n      }\n    );\n  };\n\n  const formatDate = (date: Date | string | null) => {\n    if (!date) return \"-\";\n    return new Intl.DateTimeFormat('pt-BR', {\n      day: '2-digit',\n      month: '2-digit',\n      year: 'numeric'\n    }).format(new Date(date));\n  };\n\n  const fetchCNPJData = async (cnpj: string) => {\n    const cleanCnpj = cnpj.replace(/\\D/g, '');\n    if (cleanCnpj.length !== 14) return;\n    setFormLoading(true);\n    try {\n      const response = await fetch(`https://brasilapi.com.br/api/cnpj/v1/${cleanCnpj}`);\n      if (response.ok) {\n        const data = await response.json();\n        setNewCustomer(prev => ({\n          ...prev,\n          company: data.razao_social || \"\",\n          tradingName: data.nome_fantasia || \"\",\n          firstName: data.nome_fantasia || data.razao_social || \"\",\n          phone: data.ddd_telefone_1 || \"\",\n          cep: data.cep?.replace(/\\D/g, '') || \"\",\n          address: data.logradouro || \"\",\n          addressNumber: data.numero || \"\",\n          complement: data.complemento || \"\",\n          neighborhood: data.bairro || \"\",\n          city: data.municipio || \"\",\n          state: data.uf || \"\",\n        }));\n        toast({ title: \"Dados carregados\", description: \"Dados da empresa preenchidos automaticamente\" });\n      }\n    } catch (e) {\n      toast({ title: \"Erro\", description: \"Falha ao buscar dados do CNPJ\", variant: \"destructive\" });\n    }\n    setFormLoading(false);\n  };\n\n  const fetchCEPData = async (cep: string) => {\n    const cleanCep = cep.replace(/\\D/g, '');\n    if (cleanCep.length !== 8) return;\n    try {\n      const response = await fetch(`https://viacep.com.br/ws/${cleanCep}/json/`);\n      if (response.ok) {\n        const data = await response.json();\n        if (!data.erro) {\n          setNewCustomer(prev => ({\n            ...prev,\n            address: data.logradouro || prev.address,\n            neighborhood: data.bairro || prev.neighborhood,\n            city: data.localidade || prev.city,\n            state: data.uf || prev.state,\n          }));\n        }\n      }\n    } catch (e) {}\n  };\n\n  const createCustomerMutation = useMutation({\n    mutationFn: async (data: typeof newCustomer) => {\n      await apiRequest(\"POST\", \"/api/register\", {\n        ...data,\n        firstName: data.firstName || data.tradingName || data.company,\n      });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/users'] });\n      setShowCreateDialog(false);\n      setNewCustomer({ personType: \"juridica\", cnpj: \"\", cpf: \"\", company: \"\", tradingName: \"\", firstName: \"\", email: \"\", phone: \"\", stateRegistration: \"\", cep: \"\", address: \"\", addressNumber: \"\", complement: \"\", neighborhood: \"\", city: \"\", state: \"\" });\n      toast({ title: \"Sucesso\", description: \"Cliente cadastrado com sucesso\" });\n    },\n    onError: () => {\n      toast({ title: \"Erro\", description: \"Falha ao cadastrar cliente\", variant: \"destructive\" });\n    },\n  });\n\n  return (\n    <div className=\"p-4 lg:p-6 space-y-6\">\n      <div className=\"flex items-center justify-between gap-4 flex-wrap\">\n        <div>\n          <h1 className=\"text-2xl lg:text-3xl font-bold\">Clientes</h1>\n          <p className=\"text-sm text-muted-foreground mt-0.5\">\n            Gerencie sua carteira de clientes\n          </p>\n        </div>\n        <div className=\"flex gap-2\">\n          <Button variant=\"outline\" onClick={() => refetch()} data-testid=\"button-refresh-customers\">\n            <RefreshCw className=\"h-4 w-4 mr-2\" />\n            Atualizar\n          </Button>\n          <Button onClick={() => setShowCreateDialog(true)} data-testid=\"button-add-customer\">\n            Cadastrar Cliente\n          </Button>\n        </div>\n      </div>\n\n      <div className=\"grid grid-cols-2 lg:grid-cols-3 xl:grid-cols-6 gap-4\">\n        <Card>\n          <CardContent className=\"p-4\">\n            <div className=\"flex items-center gap-3\">\n              <div className=\"p-2 rounded-lg bg-primary/10\">\n                <Users className=\"h-5 w-5 text-primary\" />\n              </div>\n              <div>\n                <p className=\"text-2xl font-bold\" data-testid=\"stat-total-customers\">{stats.total}</p>\n                <p className=\"text-xs text-muted-foreground\">Total de Clientes</p>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n        \n        <Card>\n          <CardContent className=\"p-4\">\n            <div className=\"flex items-center gap-3\">\n              <div className=\"p-2 rounded-lg bg-green-500/10\">\n                <UserCheck className=\"h-5 w-5 text-green-500\" />\n              </div>\n              <div>\n                <p className=\"text-2xl font-bold text-green-600\" data-testid=\"stat-approved-customers\">{stats.approved}</p>\n                <p className=\"text-xs text-muted-foreground\">Clientes Ativos</p>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n        \n        <Card>\n          <CardContent className=\"p-4\">\n            <div className=\"flex items-center gap-3\">\n              <div className=\"p-2 rounded-lg bg-yellow-500/10\">\n                <UserX className=\"h-5 w-5 text-yellow-500\" />\n              </div>\n              <div>\n                <p className=\"text-2xl font-bold text-yellow-600\" data-testid=\"stat-pending-customers\">{stats.pending}</p>\n                <p className=\"text-xs text-muted-foreground\">Aguardando Aprovacao</p>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n        \n        <Card>\n          <CardContent className=\"p-4\">\n            <div className=\"flex items-center gap-3\">\n              <div className=\"p-2 rounded-lg bg-purple-500/10\">\n                <Store className=\"h-5 w-5 text-purple-500\" />\n              </div>\n              <div>\n                <p className=\"text-2xl font-bold text-purple-600\" data-testid=\"stat-atacado\">{stats.atacado}</p>\n                <p className=\"text-xs text-muted-foreground\">Atacado</p>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n        \n        <Card>\n          <CardContent className=\"p-4\">\n            <div className=\"flex items-center gap-3\">\n              <div className=\"p-2 rounded-lg bg-orange-500/10\">\n                <ShoppingCart className=\"h-5 w-5 text-orange-500\" />\n              </div>\n              <div>\n                <p className=\"text-2xl font-bold text-orange-600\" data-testid=\"stat-varejo\">{stats.varejo}</p>\n                <p className=\"text-xs text-muted-foreground\">Varejo</p>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n        \n        <Card>\n          <CardContent className=\"p-4\">\n            <div className=\"flex items-center gap-3\">\n              <div className=\"p-2 rounded-lg bg-blue-500/10\">\n                <Building2 className=\"h-5 w-5 text-blue-500\" />\n              </div>\n              <div>\n                <p className=\"text-2xl font-bold text-blue-600\" data-testid=\"stat-companies\">{stats.withCompany}</p>\n                <p className=\"text-xs text-muted-foreground\">Com Empresa</p>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n\n      <div className=\"flex flex-col lg:flex-row gap-6\">\n        <div className=\"flex-1 space-y-4\">\n          <div className=\"flex gap-3 items-center\">\n            <div className=\"relative flex-1 max-w-md\">\n              <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\n              <Input\n                placeholder=\"Pesquisar por nome ou CNPJ...\"\n                value={searchQuery}\n                onChange={(e) => setSearchQuery(e.target.value)}\n                className=\"pl-9\"\n                data-testid=\"input-search-customers\"\n              />\n            </div>\n          </div>\n\n          {isLoading ? (\n            <div className=\"flex items-center justify-center py-12\">\n              <Loader2 className=\"h-8 w-8 animate-spin text-muted-foreground\" />\n            </div>\n          ) : filteredCustomers.length === 0 ? (\n            <div className=\"text-center py-12\">\n              <Users className=\"h-12 w-12 mx-auto text-muted-foreground/50 mb-4\" />\n              <p className=\"text-muted-foreground\">Nenhum cliente encontrado</p>\n            </div>\n          ) : (\n            <div className=\"space-y-2\">\n              {filteredCustomers.map((customer) => (\n                <Card key={customer.id} className=\"hover-elevate\" data-testid={`card-customer-${customer.id}`}>\n                  <CardContent className=\"p-4\">\n                    <div className=\"flex items-start justify-between gap-4\">\n                      <div className=\"flex-1 min-w-0\">\n                        <div className=\"flex items-center gap-2 mb-1 flex-wrap\">\n                          <Badge \n                            variant={customer.approved ? \"default\" : \"secondary\"}\n                            className={customer.approved ? \"bg-green-500\" : \"bg-yellow-500\"}\n                          >\n                            {customer.approved ? \"Ativo\" : \"Pendente\"}\n                          </Badge>\n                          <Badge \n                            variant=\"outline\"\n                            className={customer.customerType === \"atacado\" ? \"border-purple-500 text-purple-600\" : \"border-orange-500 text-orange-600\"}\n                            data-testid={`badge-type-${customer.id}`}\n                          >\n                            {customer.customerType === \"atacado\" ? \"Atacado\" : \"Varejo\"}\n                          </Badge>\n                          {customer.company && (\n                            <span className=\"text-sm font-semibold truncate\">\n                              {customer.company}\n                            </span>\n                          )}\n                        </div>\n                        <p className=\"font-medium\">\n                          {customer.firstName} {customer.lastName}\n                        </p>\n                        <div className=\"flex items-center gap-4 mt-2 text-sm text-muted-foreground\">\n                          <span className=\"flex items-center gap-1\">\n                            <Mail className=\"h-3.5 w-3.5\" />\n                            {customer.email}\n                          </span>\n                          <span className=\"text-xs\">\n                            Cadastro: {formatDate(customer.createdAt)}\n                          </span>\n                        </div>\n                      </div>\n                      <div className=\"flex items-center gap-1\">\n                        <Button\n                          size=\"sm\"\n                          variant=\"outline\"\n                          onClick={() => handleToggleCustomerType(customer)}\n                          disabled={updateUserMutation.isPending}\n                          data-testid={`button-toggle-type-${customer.id}`}\n                          className={customer.customerType === \"atacado\" ? \"border-orange-500 text-orange-600\" : \"border-purple-500 text-purple-600\"}\n                        >\n                          {customer.customerType === \"atacado\" ? \"Mudar p/ Varejo\" : \"Mudar p/ Atacado\"}\n                        </Button>\n                        {!customer.approved && (\n                          <Button\n                            size=\"sm\"\n                            onClick={() => handleApprove(customer)}\n                            disabled={updateUserMutation.isPending}\n                            data-testid={`button-approve-${customer.id}`}\n                          >\n                            Aprovar\n                          </Button>\n                        )}\n                        {customer.approved && (\n                          <Button\n                            size=\"sm\"\n                            variant=\"outline\"\n                            onClick={() => handleReject(customer)}\n                            disabled={updateUserMutation.isPending}\n                            data-testid={`button-reject-${customer.id}`}\n                          >\n                            Bloquear\n                          </Button>\n                        )}\n                        <Button variant=\"ghost\" size=\"icon\" onClick={() => handleEdit(customer)} data-testid={`button-edit-${customer.id}`}>\n                          <Pencil className=\"h-4 w-4\" />\n                        </Button>\n                      </div>\n                    </div>\n                  </CardContent>\n                </Card>\n              ))}\n            </div>\n          )}\n        </div>\n\n        <div className=\"w-full lg:w-80\">\n          <Card>\n            <CardHeader className=\"pb-2\">\n              <CardTitle className=\"text-base\">Carteira de Clientes</CardTitle>\n              <p className=\"text-xs text-muted-foreground\">Dezembro de 2025</p>\n            </CardHeader>\n            <CardContent>\n              <div className=\"relative w-48 h-48 mx-auto\">\n                <svg viewBox=\"0 0 100 100\" className=\"w-full h-full -rotate-90\">\n                  <circle\n                    cx=\"50\"\n                    cy=\"50\"\n                    r=\"40\"\n                    fill=\"none\"\n                    stroke=\"currentColor\"\n                    strokeWidth=\"12\"\n                    className=\"text-muted/30\"\n                  />\n                  <circle\n                    cx=\"50\"\n                    cy=\"50\"\n                    r=\"40\"\n                    fill=\"none\"\n                    stroke=\"currentColor\"\n                    strokeWidth=\"12\"\n                    strokeDasharray={`${stats.approvedPercent * 2.51} 251`}\n                    className=\"text-green-500\"\n                  />\n                  <circle\n                    cx=\"50\"\n                    cy=\"50\"\n                    r=\"40\"\n                    fill=\"none\"\n                    stroke=\"currentColor\"\n                    strokeWidth=\"12\"\n                    strokeDasharray={`${stats.pendingPercent * 2.51} 251`}\n                    strokeDashoffset={`-${stats.approvedPercent * 2.51}`}\n                    className=\"text-yellow-500\"\n                  />\n                </svg>\n                <div className=\"absolute inset-0 flex flex-col items-center justify-center\">\n                  <span className=\"text-3xl font-bold\">{stats.total}</span>\n                  <span className=\"text-xs text-muted-foreground\">Clientes</span>\n                </div>\n              </div>\n              \n              <div className=\"mt-4 space-y-2 text-sm\">\n                <div className=\"flex items-center justify-between\">\n                  <div className=\"flex items-center gap-2\">\n                    <div className=\"w-3 h-3 rounded-full bg-green-500\" />\n                    <span>Ativos</span>\n                  </div>\n                  <span className=\"font-medium\">{stats.approved}</span>\n                </div>\n                <div className=\"flex items-center justify-between\">\n                  <div className=\"flex items-center gap-2\">\n                    <div className=\"w-3 h-3 rounded-full bg-yellow-500\" />\n                    <span>Pendentes</span>\n                  </div>\n                  <span className=\"font-medium\">{stats.pending}</span>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n        </div>\n      </div>\n\n      <Dialog open={showCreateDialog} onOpenChange={setShowCreateDialog}>\n        <DialogContent className=\"max-w-2xl max-h-[90vh] overflow-y-auto\">\n          <DialogHeader>\n            <DialogTitle>Cadastrar Novo Cliente</DialogTitle>\n          </DialogHeader>\n          <div className=\"space-y-4\">\n            <div>\n              <Label>Tipo de Pessoa</Label>\n              <Select value={newCustomer.personType} onValueChange={(v) => setNewCustomer(p => ({ ...p, personType: v }))}>\n                <SelectTrigger data-testid=\"select-person-type\">\n                  <SelectValue />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"juridica\">Pessoa Juridica</SelectItem>\n                  <SelectItem value=\"fisica\">Pessoa Fisica</SelectItem>\n                </SelectContent>\n              </Select>\n            </div>\n\n            {newCustomer.personType === \"juridica\" ? (\n              <div className=\"grid grid-cols-2 gap-4\">\n                <div>\n                  <Label>CNPJ</Label>\n                  <Input\n                    value={newCustomer.cnpj}\n                    onChange={(e) => setNewCustomer(p => ({ ...p, cnpj: e.target.value }))}\n                    onBlur={() => fetchCNPJData(newCustomer.cnpj)}\n                    placeholder=\"00.000.000/0000-00\"\n                    data-testid=\"input-cnpj\"\n                  />\n                </div>\n                <div>\n                  <Label>Inscricao Estadual</Label>\n                  <Input\n                    value={newCustomer.stateRegistration}\n                    onChange={(e) => setNewCustomer(p => ({ ...p, stateRegistration: e.target.value }))}\n                    placeholder=\"Inscricao Estadual\"\n                    data-testid=\"input-state-registration\"\n                  />\n                </div>\n                <div className=\"col-span-2\">\n                  <Label>Razao Social</Label>\n                  <Input\n                    value={newCustomer.company}\n                    onChange={(e) => setNewCustomer(p => ({ ...p, company: e.target.value }))}\n                    placeholder=\"Razao Social\"\n                    data-testid=\"input-company\"\n                  />\n                </div>\n                <div className=\"col-span-2\">\n                  <Label>Nome Fantasia</Label>\n                  <Input\n                    value={newCustomer.tradingName}\n                    onChange={(e) => setNewCustomer(p => ({ ...p, tradingName: e.target.value }))}\n                    placeholder=\"Nome Fantasia\"\n                    data-testid=\"input-trading-name\"\n                  />\n                </div>\n              </div>\n            ) : (\n              <div className=\"grid grid-cols-2 gap-4\">\n                <div>\n                  <Label>CPF</Label>\n                  <Input\n                    value={newCustomer.cpf}\n                    onChange={(e) => setNewCustomer(p => ({ ...p, cpf: e.target.value }))}\n                    placeholder=\"000.000.000-00\"\n                    data-testid=\"input-cpf\"\n                  />\n                </div>\n                <div>\n                  <Label>Nome Completo</Label>\n                  <Input\n                    value={newCustomer.firstName}\n                    onChange={(e) => setNewCustomer(p => ({ ...p, firstName: e.target.value }))}\n                    placeholder=\"Nome Completo\"\n                    data-testid=\"input-first-name\"\n                  />\n                </div>\n              </div>\n            )}\n\n            <div className=\"grid grid-cols-2 gap-4\">\n              <div>\n                <Label>Email</Label>\n                <Input\n                  type=\"email\"\n                  value={newCustomer.email}\n                  onChange={(e) => setNewCustomer(p => ({ ...p, email: e.target.value }))}\n                  placeholder=\"email@exemplo.com\"\n                  data-testid=\"input-email\"\n                />\n              </div>\n              <div>\n                <Label>Telefone</Label>\n                <Input\n                  value={newCustomer.phone}\n                  onChange={(e) => setNewCustomer(p => ({ ...p, phone: e.target.value }))}\n                  placeholder=\"(00) 00000-0000\"\n                  data-testid=\"input-phone\"\n                />\n              </div>\n            </div>\n\n            <div className=\"border-t pt-4\">\n              <h4 className=\"font-medium mb-3\">Endereco</h4>\n              <div className=\"grid grid-cols-3 gap-4\">\n                <div>\n                  <Label>CEP</Label>\n                  <Input\n                    value={newCustomer.cep}\n                    onChange={(e) => setNewCustomer(p => ({ ...p, cep: e.target.value }))}\n                    onBlur={() => fetchCEPData(newCustomer.cep)}\n                    placeholder=\"00000-000\"\n                    data-testid=\"input-cep\"\n                  />\n                </div>\n                <div className=\"col-span-2\">\n                  <Label>Logradouro</Label>\n                  <Input\n                    value={newCustomer.address}\n                    onChange={(e) => setNewCustomer(p => ({ ...p, address: e.target.value }))}\n                    placeholder=\"Rua, Avenida...\"\n                    data-testid=\"input-address\"\n                  />\n                </div>\n                <div>\n                  <Label>Numero</Label>\n                  <Input\n                    value={newCustomer.addressNumber}\n                    onChange={(e) => setNewCustomer(p => ({ ...p, addressNumber: e.target.value }))}\n                    placeholder=\"Numero\"\n                    data-testid=\"input-address-number\"\n                  />\n                </div>\n                <div className=\"col-span-2\">\n                  <Label>Complemento</Label>\n                  <Input\n                    value={newCustomer.complement}\n                    onChange={(e) => setNewCustomer(p => ({ ...p, complement: e.target.value }))}\n                    placeholder=\"Apto, Sala...\"\n                    data-testid=\"input-complement\"\n                  />\n                </div>\n                <div>\n                  <Label>Bairro</Label>\n                  <Input\n                    value={newCustomer.neighborhood}\n                    onChange={(e) => setNewCustomer(p => ({ ...p, neighborhood: e.target.value }))}\n                    placeholder=\"Bairro\"\n                    data-testid=\"input-neighborhood\"\n                  />\n                </div>\n                <div>\n                  <Label>Cidade</Label>\n                  <Input\n                    value={newCustomer.city}\n                    onChange={(e) => setNewCustomer(p => ({ ...p, city: e.target.value }))}\n                    placeholder=\"Cidade\"\n                    data-testid=\"input-city\"\n                  />\n                </div>\n                <div>\n                  <Label>Estado</Label>\n                  <Input\n                    value={newCustomer.state}\n                    onChange={(e) => setNewCustomer(p => ({ ...p, state: e.target.value }))}\n                    placeholder=\"UF\"\n                    data-testid=\"input-state\"\n                  />\n                </div>\n              </div>\n            </div>\n\n            <div className=\"flex justify-end gap-2 pt-4\">\n              <Button variant=\"outline\" onClick={() => setShowCreateDialog(false)} data-testid=\"button-cancel-customer\">\n                Cancelar\n              </Button>\n              <Button \n                onClick={() => createCustomerMutation.mutate(newCustomer)}\n                disabled={createCustomerMutation.isPending || formLoading}\n                data-testid=\"button-save-customer\"\n              >\n                {createCustomerMutation.isPending ? <Loader2 className=\"h-4 w-4 animate-spin mr-2\" /> : null}\n                Cadastrar\n              </Button>\n            </div>\n          </div>\n        </DialogContent>\n      </Dialog>\n\n      <Dialog open={showEditDialog} onOpenChange={setShowEditDialog}>\n        <DialogContent className=\"max-w-2xl max-h-[90vh] overflow-y-auto\">\n          <DialogHeader>\n            <DialogTitle>Editar Cliente</DialogTitle>\n          </DialogHeader>\n          {editingCustomer && (\n            <div className=\"space-y-4\">\n              <div className=\"grid grid-cols-2 gap-4\">\n                <div className=\"col-span-2\">\n                  <Label>Razao Social / Empresa</Label>\n                  <Input\n                    value={editingCustomer.company || \"\"}\n                    onChange={(e) => setEditingCustomer({...editingCustomer, company: e.target.value})}\n                    data-testid=\"input-edit-company\"\n                  />\n                </div>\n                <div>\n                  <Label>Nome</Label>\n                  <Input\n                    value={editingCustomer.firstName || \"\"}\n                    onChange={(e) => setEditingCustomer({...editingCustomer, firstName: e.target.value})}\n                    data-testid=\"input-edit-first-name\"\n                  />\n                </div>\n                <div>\n                  <Label>Sobrenome</Label>\n                  <Input\n                    value={editingCustomer.lastName || \"\"}\n                    onChange={(e) => setEditingCustomer({...editingCustomer, lastName: e.target.value})}\n                    data-testid=\"input-edit-last-name\"\n                  />\n                </div>\n                <div>\n                  <Label>Email</Label>\n                  <Input\n                    type=\"email\"\n                    value={editingCustomer.email || \"\"}\n                    onChange={(e) => setEditingCustomer({...editingCustomer, email: e.target.value})}\n                    data-testid=\"input-edit-email\"\n                  />\n                </div>\n                <div>\n                  <Label>Telefone</Label>\n                  <Input\n                    value={editingCustomer.phone || \"\"}\n                    onChange={(e) => setEditingCustomer({...editingCustomer, phone: e.target.value})}\n                    data-testid=\"input-edit-phone\"\n                  />\n                </div>\n                <div>\n                  <Label>CNPJ</Label>\n                  <Input\n                    value={editingCustomer.cnpj || \"\"}\n                    onChange={(e) => setEditingCustomer({...editingCustomer, cnpj: e.target.value})}\n                    data-testid=\"input-edit-cnpj\"\n                  />\n                </div>\n                <div>\n                  <Label>Inscricao Estadual</Label>\n                  <Input\n                    value={editingCustomer.stateRegistration || \"\"}\n                    onChange={(e) => setEditingCustomer({...editingCustomer, stateRegistration: e.target.value})}\n                    data-testid=\"input-edit-state-registration\"\n                  />\n                </div>\n              </div>\n\n              <div className=\"border-t pt-4\">\n                <h4 className=\"font-medium mb-3\">Endereco</h4>\n                <div className=\"grid grid-cols-3 gap-4\">\n                  <div>\n                    <Label>CEP</Label>\n                    <Input\n                      value={editingCustomer.cep || \"\"}\n                      onChange={(e) => setEditingCustomer({...editingCustomer, cep: e.target.value})}\n                      data-testid=\"input-edit-cep\"\n                    />\n                  </div>\n                  <div className=\"col-span-2\">\n                    <Label>Logradouro</Label>\n                    <Input\n                      value={editingCustomer.address || \"\"}\n                      onChange={(e) => setEditingCustomer({...editingCustomer, address: e.target.value})}\n                      data-testid=\"input-edit-address\"\n                    />\n                  </div>\n                  <div>\n                    <Label>Numero</Label>\n                    <Input\n                      value={editingCustomer.addressNumber || \"\"}\n                      onChange={(e) => setEditingCustomer({...editingCustomer, addressNumber: e.target.value})}\n                      data-testid=\"input-edit-address-number\"\n                    />\n                  </div>\n                  <div className=\"col-span-2\">\n                    <Label>Complemento</Label>\n                    <Input\n                      value={editingCustomer.complement || \"\"}\n                      onChange={(e) => setEditingCustomer({...editingCustomer, complement: e.target.value})}\n                      data-testid=\"input-edit-complement\"\n                    />\n                  </div>\n                  <div>\n                    <Label>Bairro</Label>\n                    <Input\n                      value={editingCustomer.neighborhood || \"\"}\n                      onChange={(e) => setEditingCustomer({...editingCustomer, neighborhood: e.target.value})}\n                      data-testid=\"input-edit-neighborhood\"\n                    />\n                  </div>\n                  <div>\n                    <Label>Cidade</Label>\n                    <Input\n                      value={editingCustomer.city || \"\"}\n                      onChange={(e) => setEditingCustomer({...editingCustomer, city: e.target.value})}\n                      data-testid=\"input-edit-city\"\n                    />\n                  </div>\n                  <div>\n                    <Label>Estado</Label>\n                    <Input\n                      value={editingCustomer.state || \"\"}\n                      onChange={(e) => setEditingCustomer({...editingCustomer, state: e.target.value})}\n                      data-testid=\"input-edit-state\"\n                    />\n                  </div>\n                </div>\n              </div>\n\n              <div className=\"flex justify-end gap-2 pt-4\">\n                <Button variant=\"outline\" onClick={() => { setShowEditDialog(false); setEditingCustomer(null); }} data-testid=\"button-cancel-edit\">\n                  Cancelar\n                </Button>\n                <Button \n                  onClick={handleSaveEdit}\n                  disabled={updateUserMutation.isPending}\n                  data-testid=\"button-save-edit\"\n                >\n                  {updateUserMutation.isPending ? <Loader2 className=\"h-4 w-4 animate-spin mr-2\" /> : null}\n                  Salvar\n                </Button>\n              </div>\n            </div>\n          )}\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n","path":null,"size_bytes":34993,"size_tokens":null},"client/src/pages/categories.tsx":{"content":"import { useMemo, useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { Link } from \"wouter\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Button } from \"@/components/ui/button\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger, DialogFooter, DialogClose } from \"@/components/ui/dialog\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Switch } from \"@/components/ui/switch\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { useAuth } from \"@/contexts/AuthContext\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { Loader2, Package, Grid3X3, Box, Zap, Wrench, Coffee, Heart, Star, Bookmark, Layers, ShoppingBag, ChevronRight, ChevronDown, FolderTree, Plus, Edit, Trash2, EyeOff, Eye } from \"lucide-react\";\nimport type { Category, Product } from \"@shared/schema\";\n\nconst categoryIcons: Record<string, typeof Package> = {\n  eletronicos: Zap,\n  ferramentas: Wrench,\n  bebidas: Coffee,\n  saude: Heart,\n  destaques: Star,\n  favoritos: Bookmark,\n  diversos: Layers,\n  default: Box,\n};\n\nconst categoryColors: Record<string, string> = {\n  eletronicos: \"from-blue-500/20 to-blue-600/10\",\n  ferramentas: \"from-orange-500/20 to-orange-600/10\",\n  bebidas: \"from-amber-500/20 to-amber-600/10\",\n  saude: \"from-rose-500/20 to-rose-600/10\",\n  destaques: \"from-yellow-500/20 to-yellow-600/10\",\n  favoritos: \"from-purple-500/20 to-purple-600/10\",\n  diversos: \"from-emerald-500/20 to-emerald-600/10\",\n  default: \"from-primary/20 to-primary/10\",\n};\n\nconst categoryIconColors: Record<string, string> = {\n  eletronicos: \"text-blue-500\",\n  ferramentas: \"text-orange-500\",\n  bebidas: \"text-amber-600\",\n  saude: \"text-rose-500\",\n  destaques: \"text-yellow-500\",\n  favoritos: \"text-purple-500\",\n  diversos: \"text-emerald-500\",\n  default: \"text-primary\",\n};\n\nfunction getCategoryIcon(slug: string) {\n  const normalizedSlug = slug.toLowerCase().replace(/[^a-z]/g, '');\n  return categoryIcons[normalizedSlug] || categoryIcons.default;\n}\n\nfunction getCategoryColor(slug: string) {\n  const normalizedSlug = slug.toLowerCase().replace(/[^a-z]/g, '');\n  return categoryColors[normalizedSlug] || categoryColors.default;\n}\n\nfunction getCategoryIconColor(slug: string) {\n  const normalizedSlug = slug.toLowerCase().replace(/[^a-z]/g, '');\n  return categoryIconColors[normalizedSlug] || categoryIconColors.default;\n}\n\ninterface CategoryWithHierarchy extends Category {\n  productCount: number;\n  children: CategoryWithHierarchy[];\n  parentName?: string;\n  fullPath: string;\n}\n\nfunction buildCategoryTree(\n  categories: Category[],\n  countMap: Record<number, number>\n): CategoryWithHierarchy[] {\n  const categoryMap = new Map<number, CategoryWithHierarchy>();\n  \n  categories.forEach((cat) => {\n    categoryMap.set(cat.id, {\n      ...cat,\n      productCount: countMap[cat.id] || 0,\n      children: [],\n      fullPath: cat.name,\n    });\n  });\n\n  const rootCategories: CategoryWithHierarchy[] = [];\n\n  categories.forEach((cat) => {\n    const catWithHierarchy = categoryMap.get(cat.id)!;\n    \n    if (cat.parentId && categoryMap.has(cat.parentId)) {\n      const parent = categoryMap.get(cat.parentId)!;\n      catWithHierarchy.parentName = parent.name;\n      catWithHierarchy.fullPath = `${parent.fullPath} > ${cat.name}`;\n      parent.children.push(catWithHierarchy);\n    } else {\n      rootCategories.push(catWithHierarchy);\n    }\n  });\n\n  return rootCategories;\n}\n\nfunction slugify(text: string): string {\n  return text\n    .toLowerCase()\n    .normalize('NFD')\n    .replace(/[\\u0300-\\u036f]/g, '')\n    .replace(/[^a-z0-9]+/g, '-')\n    .replace(/(^-|-$)/g, '');\n}\n\ninterface CategoryDialogProps {\n  category?: Category | null;\n  allCategories: Category[];\n  open: boolean;\n  onOpenChange: (open: boolean) => void;\n  onSuccess: () => void;\n}\n\nfunction CategoryDialog({ category, allCategories, open, onOpenChange, onSuccess }: CategoryDialogProps) {\n  const { toast } = useToast();\n  const [name, setName] = useState(category?.name || \"\");\n  const [slug, setSlug] = useState(category?.slug || \"\");\n  const [parentId, setParentId] = useState<string>(category?.parentId?.toString() || \"none\");\n  const [hideFromVarejo, setHideFromVarejo] = useState(category?.hideFromVarejo || false);\n  const [autoSlug, setAutoSlug] = useState(!category);\n\n  const isEdit = !!category;\n\n  const createMutation = useMutation({\n    mutationFn: async (data: { name: string; slug: string; parentId: number | null; hideFromVarejo: boolean }) => {\n      return apiRequest('POST', '/api/categories', data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/categories'] });\n      toast({ title: \"Categoria criada com sucesso\" });\n      onSuccess();\n      onOpenChange(false);\n    },\n    onError: (error: Error) => {\n      toast({ title: \"Erro ao criar categoria\", description: error.message, variant: \"destructive\" });\n    },\n  });\n\n  const updateMutation = useMutation({\n    mutationFn: async (data: { name: string; slug: string; parentId: number | null; hideFromVarejo: boolean }) => {\n      return apiRequest('PATCH', `/api/categories/${category!.id}`, data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/categories'] });\n      toast({ title: \"Categoria atualizada com sucesso\" });\n      onSuccess();\n      onOpenChange(false);\n    },\n    onError: (error: Error) => {\n      toast({ title: \"Erro ao atualizar categoria\", description: error.message, variant: \"destructive\" });\n    },\n  });\n\n  const handleNameChange = (value: string) => {\n    setName(value);\n    if (autoSlug) {\n      setSlug(slugify(value));\n    }\n  };\n\n  const handleSubmit = () => {\n    if (!name.trim() || !slug.trim()) {\n      toast({ title: \"Preencha nome e slug\", variant: \"destructive\" });\n      return;\n    }\n\n    const data = {\n      name: name.trim(),\n      slug: slug.trim(),\n      parentId: parentId === \"none\" ? null : parseInt(parentId),\n      hideFromVarejo,\n    };\n\n    if (isEdit) {\n      updateMutation.mutate(data);\n    } else {\n      createMutation.mutate(data);\n    }\n  };\n\n  const isPending = createMutation.isPending || updateMutation.isPending;\n\n  const availableParents = allCategories.filter(c => \n    !category || (c.id !== category.id && c.parentId !== category.id)\n  );\n\n  return (\n    <Dialog open={open} onOpenChange={onOpenChange}>\n      <DialogContent className=\"sm:max-w-md\">\n        <DialogHeader>\n          <DialogTitle>{isEdit ? \"Editar Categoria\" : \"Nova Categoria\"}</DialogTitle>\n        </DialogHeader>\n        <div className=\"space-y-4 py-4\">\n          <div className=\"space-y-2\">\n            <Label htmlFor=\"name\">Nome</Label>\n            <Input\n              id=\"name\"\n              value={name}\n              onChange={(e) => handleNameChange(e.target.value)}\n              placeholder=\"Nome da categoria\"\n              data-testid=\"input-category-name\"\n            />\n          </div>\n          <div className=\"space-y-2\">\n            <Label htmlFor=\"slug\">Slug (URL)</Label>\n            <div className=\"flex gap-2\">\n              <Input\n                id=\"slug\"\n                value={slug}\n                onChange={(e) => {\n                  setSlug(e.target.value);\n                  setAutoSlug(false);\n                }}\n                placeholder=\"slug-da-categoria\"\n                data-testid=\"input-category-slug\"\n              />\n            </div>\n          </div>\n          <div className=\"space-y-2\">\n            <Label htmlFor=\"parent\">Categoria Pai (opcional)</Label>\n            <Select value={parentId} onValueChange={setParentId}>\n              <SelectTrigger data-testid=\"select-category-parent\">\n                <SelectValue placeholder=\"Selecione a categoria pai\" />\n              </SelectTrigger>\n              <SelectContent>\n                <SelectItem value=\"none\">Nenhuma (categoria principal)</SelectItem>\n                {availableParents.map((cat) => (\n                  <SelectItem key={cat.id} value={cat.id.toString()}>\n                    {cat.name}\n                  </SelectItem>\n                ))}\n              </SelectContent>\n            </Select>\n          </div>\n          <div className=\"flex items-center justify-between\">\n            <div className=\"space-y-0.5\">\n              <Label htmlFor=\"hideFromVarejo\">Ocultar do Varejo</Label>\n              <p className=\"text-xs text-muted-foreground\">\n                Categoria visivel apenas para atacado\n              </p>\n            </div>\n            <Switch\n              id=\"hideFromVarejo\"\n              checked={hideFromVarejo}\n              onCheckedChange={setHideFromVarejo}\n              data-testid=\"switch-hide-varejo\"\n            />\n          </div>\n        </div>\n        <DialogFooter className=\"gap-2\">\n          <DialogClose asChild>\n            <Button variant=\"outline\" data-testid=\"button-cancel-category\">Cancelar</Button>\n          </DialogClose>\n          <Button onClick={handleSubmit} disabled={isPending} data-testid=\"button-save-category\">\n            {isPending && <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />}\n            {isEdit ? \"Salvar\" : \"Criar\"}\n          </Button>\n        </DialogFooter>\n      </DialogContent>\n    </Dialog>\n  );\n}\n\ninterface DeleteDialogProps {\n  category: Category;\n  open: boolean;\n  onOpenChange: (open: boolean) => void;\n  onSuccess: () => void;\n}\n\nfunction DeleteCategoryDialog({ category, open, onOpenChange, onSuccess }: DeleteDialogProps) {\n  const { toast } = useToast();\n\n  const deleteMutation = useMutation({\n    mutationFn: async () => {\n      return apiRequest('DELETE', `/api/categories/${category.id}`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/categories'] });\n      toast({ title: \"Categoria excluida com sucesso\" });\n      onSuccess();\n      onOpenChange(false);\n    },\n    onError: (error: Error) => {\n      toast({ title: \"Erro ao excluir categoria\", description: error.message, variant: \"destructive\" });\n    },\n  });\n\n  return (\n    <Dialog open={open} onOpenChange={onOpenChange}>\n      <DialogContent className=\"sm:max-w-md\">\n        <DialogHeader>\n          <DialogTitle>Excluir Categoria</DialogTitle>\n        </DialogHeader>\n        <p className=\"py-4\">\n          Tem certeza que deseja excluir a categoria <strong>{category.name}</strong>?\n          Esta acao nao pode ser desfeita.\n        </p>\n        <DialogFooter className=\"gap-2\">\n          <DialogClose asChild>\n            <Button variant=\"outline\" data-testid=\"button-cancel-delete\">Cancelar</Button>\n          </DialogClose>\n          <Button \n            variant=\"destructive\" \n            onClick={() => deleteMutation.mutate()} \n            disabled={deleteMutation.isPending}\n            data-testid=\"button-confirm-delete\"\n          >\n            {deleteMutation.isPending && <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />}\n            Excluir\n          </Button>\n        </DialogFooter>\n      </DialogContent>\n    </Dialog>\n  );\n}\n\nfunction CategoryCard({ \n  category, \n  depth = 0,\n  expandedCategories,\n  toggleExpanded,\n  isAdmin,\n  onEdit,\n  onDelete,\n  onToggleVarejo,\n  isTogglingVarejo,\n}: { \n  category: CategoryWithHierarchy; \n  depth?: number;\n  expandedCategories: Set<number>;\n  toggleExpanded: (id: number) => void;\n  isAdmin: boolean;\n  onEdit: (cat: Category) => void;\n  onDelete: (cat: Category) => void;\n  onToggleVarejo: (cat: Category) => void;\n  isTogglingVarejo: boolean;\n}) {\n  const Icon = getCategoryIcon(category.slug);\n  const bgGradient = getCategoryColor(category.slug);\n  const iconColor = getCategoryIconColor(category.slug);\n  const hasChildren = category.children.length > 0;\n  const isExpanded = expandedCategories.has(category.id);\n  const isSubcategory = depth > 0;\n\n  return (\n    <div className={isSubcategory ? \"ml-6 border-l-2 border-muted pl-4\" : \"\"}>\n      <div className=\"flex items-start gap-2\">\n        {hasChildren && (\n          <Button\n            size=\"icon\"\n            variant=\"ghost\"\n            className=\"shrink-0 mt-2\"\n            onClick={(e) => {\n              e.preventDefault();\n              toggleExpanded(category.id);\n            }}\n            data-testid={`button-toggle-category-${category.id}`}\n          >\n            {isExpanded ? (\n              <ChevronDown className=\"h-4 w-4\" />\n            ) : (\n              <ChevronRight className=\"h-4 w-4\" />\n            )}\n          </Button>\n        )}\n        <div className={`flex-1 ${!hasChildren ? (isSubcategory ? \"\" : \"ml-11\") : \"\"}`}>\n          <Card className={`group overflow-visible hover-elevate active-elevate-2 transition-all duration-200 ${category.hideFromVarejo ? 'ring-2 ring-red-500/50 dark:ring-red-400/50' : ''}`}>\n            <CardContent className=\"p-0\">\n              <Link \n                href={`/catalog?category=${encodeURIComponent(category.name)}`}\n                data-testid={`card-category-${category.id}`}\n              >\n                <div className={`relative ${isSubcategory ? \"h-20\" : \"h-32\"} ${category.hideFromVarejo ? 'bg-gradient-to-br from-red-500/30 to-red-600/20 dark:from-red-500/20 dark:to-red-600/10' : `bg-gradient-to-br ${bgGradient}`} rounded-t-lg overflow-hidden`}>\n                  <div className=\"absolute inset-0 flex items-center justify-center\">\n                    <Icon className={`${isSubcategory ? \"h-10 w-10\" : \"h-16 w-16\"} ${category.hideFromVarejo ? 'text-red-500' : iconColor} opacity-80 group-hover:scale-110 transition-transform duration-300`} />\n                  </div>\n                  <div className=\"absolute bottom-0 left-0 right-0 h-8 bg-gradient-to-t from-background/20 to-transparent\" />\n                  {category.hideFromVarejo && (\n                    <div className=\"absolute top-2 right-2\">\n                      <Badge variant=\"destructive\" className=\"text-xs gap-1\">\n                        <EyeOff className=\"h-3 w-3\" />\n                        Oculto Varejo\n                      </Badge>\n                    </div>\n                  )}\n                </div>\n              </Link>\n              <div className=\"p-4\">\n                <div className=\"flex items-center justify-between gap-2\">\n                  <Link \n                    href={`/catalog?category=${encodeURIComponent(category.name)}`}\n                    className=\"min-w-0 flex-1\"\n                  >\n                    {isSubcategory && category.parentName && (\n                      <p className=\"text-xs text-muted-foreground truncate\">{category.parentName}</p>\n                    )}\n                    <h3 className=\"font-semibold text-base truncate\">{category.name}</h3>\n                  </Link>\n                  <div className=\"flex items-center gap-2 shrink-0\">\n                    {hasChildren && (\n                      <Badge variant=\"outline\" className=\"text-xs\">\n                        {category.children.length} sub\n                      </Badge>\n                    )}\n                    <Badge variant=\"secondary\">\n                      {category.productCount}\n                    </Badge>\n                  </div>\n                </div>\n                <div className=\"flex items-center justify-between mt-1\">\n                  <p className=\"text-xs text-muted-foreground\">\n                    {category.productCount === 0 \n                      ? \"Nenhum produto\" \n                      : category.productCount === 1 \n                        ? \"1 produto disponivel\" \n                        : `${category.productCount} produtos disponiveis`}\n                  </p>\n                  {isAdmin && (\n                    <div className=\"flex items-center gap-1\">\n                      <Button\n                        size=\"icon\"\n                        variant=\"ghost\"\n                        className={`h-7 w-7 ${category.hideFromVarejo ? 'text-green-500' : 'text-muted-foreground'}`}\n                        onClick={(e) => {\n                          e.preventDefault();\n                          e.stopPropagation();\n                          onToggleVarejo(category);\n                        }}\n                        disabled={isTogglingVarejo}\n                        title={category.hideFromVarejo ? \"Mostrar para Varejo\" : \"Ocultar do Varejo\"}\n                        data-testid={`button-toggle-varejo-${category.id}`}\n                      >\n                        {category.hideFromVarejo ? (\n                          <Eye className=\"h-3.5 w-3.5\" />\n                        ) : (\n                          <EyeOff className=\"h-3.5 w-3.5\" />\n                        )}\n                      </Button>\n                      <Button\n                        size=\"icon\"\n                        variant=\"ghost\"\n                        className=\"h-7 w-7\"\n                        onClick={(e) => {\n                          e.preventDefault();\n                          e.stopPropagation();\n                          onEdit(category);\n                        }}\n                        data-testid={`button-edit-category-${category.id}`}\n                      >\n                        <Edit className=\"h-3.5 w-3.5\" />\n                      </Button>\n                      <Button\n                        size=\"icon\"\n                        variant=\"ghost\"\n                        className=\"h-7 w-7 text-destructive\"\n                        onClick={(e) => {\n                          e.preventDefault();\n                          e.stopPropagation();\n                          onDelete(category);\n                        }}\n                        data-testid={`button-delete-category-${category.id}`}\n                      >\n                        <Trash2 className=\"h-3.5 w-3.5\" />\n                      </Button>\n                    </div>\n                  )}\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n        </div>\n      </div>\n\n      {hasChildren && isExpanded && (\n        <div className=\"mt-2 space-y-2\">\n          {category.children.map((child) => (\n            <CategoryCard \n              key={child.id} \n              category={child} \n              depth={depth + 1}\n              expandedCategories={expandedCategories}\n              toggleExpanded={toggleExpanded}\n              isAdmin={isAdmin}\n              onEdit={onEdit}\n              onDelete={onDelete}\n              onToggleVarejo={onToggleVarejo}\n              isTogglingVarejo={isTogglingVarejo}\n            />\n          ))}\n        </div>\n      )}\n    </div>\n  );\n}\n\nexport default function CategoriesPage() {\n  const { user, isAdmin } = useAuth();\n  const [expandedCategories, setExpandedCategories] = useState<Set<number>>(new Set());\n  const [viewMode, setViewMode] = useState<\"hierarchy\" | \"flat\">(\"hierarchy\");\n  const [dialogOpen, setDialogOpen] = useState(false);\n  const [editingCategory, setEditingCategory] = useState<Category | null>(null);\n  const [deletingCategory, setDeletingCategory] = useState<Category | null>(null);\n  const [showFilter, setShowFilter] = useState<\"all\" | \"visible\" | \"hidden\">(\"all\");\n\n  const { data: categoriesData = [], isLoading: categoriesLoading } = useQuery<Category[]>({\n    queryKey: ['/api/categories'],\n  });\n\n  const { data: productsResponse, isLoading: productsLoading } = useQuery<{ products: Product[]; total: number }>({\n    queryKey: ['/api/products', { limit: 10000 }],\n  });\n  \n  const productsData = productsResponse?.products || [];\n\n  const filteredCategories = useMemo(() => {\n    if (showFilter === \"all\") {\n      return categoriesData;\n    } else if (showFilter === \"visible\") {\n      return categoriesData.filter(c => !c.hideFromVarejo);\n    } else {\n      return categoriesData.filter(c => c.hideFromVarejo);\n    }\n  }, [categoriesData, showFilter]);\n\n  const hiddenCount = useMemo(() => {\n    return categoriesData.filter(c => c.hideFromVarejo).length;\n  }, [categoriesData]);\n\n  const countMap = useMemo(() => {\n    const map: Record<number, number> = {};\n    productsData.forEach((p) => {\n      if (p.categoryId) {\n        map[p.categoryId] = (map[p.categoryId] || 0) + 1;\n      }\n    });\n    return map;\n  }, [productsData]);\n\n  const categoryTree = useMemo(() => {\n    return buildCategoryTree(filteredCategories, countMap);\n  }, [filteredCategories, countMap]);\n\n  const flatCategories = useMemo(() => {\n    return filteredCategories.map((cat) => {\n      const parent = cat.parentId ? filteredCategories.find(c => c.id === cat.parentId) : null;\n      return {\n        ...cat,\n        productCount: countMap[cat.id] || 0,\n        children: [],\n        parentName: parent?.name,\n        fullPath: parent ? `${parent.name} > ${cat.name}` : cat.name,\n      } as CategoryWithHierarchy;\n    });\n  }, [filteredCategories, countMap]);\n\n  const toggleExpanded = (id: number) => {\n    setExpandedCategories((prev) => {\n      const next = new Set(prev);\n      if (next.has(id)) {\n        next.delete(id);\n      } else {\n        next.add(id);\n      }\n      return next;\n    });\n  };\n\n  const expandAll = () => {\n    const allIds = new Set(filteredCategories.filter(c => \n      filteredCategories.some(child => child.parentId === c.id)\n    ).map(c => c.id));\n    setExpandedCategories(allIds);\n  };\n\n  const collapseAll = () => {\n    setExpandedCategories(new Set());\n  };\n\n  const handleEdit = (category: Category) => {\n    setEditingCategory(category);\n    setDialogOpen(true);\n  };\n\n  const handleDelete = (category: Category) => {\n    setDeletingCategory(category);\n  };\n\n  const handleCreateNew = () => {\n    setEditingCategory(null);\n    setDialogOpen(true);\n  };\n\n  const { toast } = useToast();\n\n  const toggleVarejoMutation = useMutation({\n    mutationFn: async (category: Category) => {\n      return apiRequest('PATCH', `/api/categories/${category.id}`, { hideFromVarejo: !category.hideFromVarejo });\n    },\n    onSuccess: (_, category) => {\n      queryClient.invalidateQueries({ queryKey: ['/api/categories'] });\n      toast({ \n        title: category.hideFromVarejo \n          ? \"Categoria visivel para varejo\" \n          : \"Categoria oculta do varejo\" \n      });\n    },\n    onError: (error: Error) => {\n      toast({ title: \"Erro ao atualizar categoria\", description: error.message, variant: \"destructive\" });\n    },\n  });\n\n  const handleToggleVarejo = (category: Category) => {\n    toggleVarejoMutation.mutate(category);\n  };\n\n  const rootCategoriesCount = categoryTree.length;\n  const subcategoriesCount = filteredCategories.length - rootCategoriesCount;\n  const totalProducts = productsData.length;\n  const isLoading = categoriesLoading || productsLoading;\n\n  return (\n    <div className=\"p-4 lg:p-6 space-y-6\">\n      <div className=\"flex items-center justify-between gap-4 flex-wrap\">\n        <div>\n          <h1 className=\"text-2xl lg:text-3xl font-bold\">Categorias</h1>\n          <p className=\"text-sm text-muted-foreground mt-0.5\">\n            {rootCategoriesCount} categorias principais, {subcategoriesCount} subcategorias, {totalProducts} produtos\n          </p>\n        </div>\n        <div className=\"flex items-center gap-2 flex-wrap\">\n          {isAdmin && (\n            <Button onClick={handleCreateNew} data-testid=\"button-create-category\">\n              <Plus className=\"h-4 w-4 mr-1\" />\n              Nova Categoria\n            </Button>\n          )}\n          <Button\n            variant={viewMode === \"hierarchy\" ? \"default\" : \"outline\"}\n            size=\"sm\"\n            onClick={() => setViewMode(\"hierarchy\")}\n            data-testid=\"button-view-hierarchy\"\n          >\n            <FolderTree className=\"h-4 w-4 mr-1\" />\n            Hierarquia\n          </Button>\n          <Button\n            variant={viewMode === \"flat\" ? \"default\" : \"outline\"}\n            size=\"sm\"\n            onClick={() => setViewMode(\"flat\")}\n            data-testid=\"button-view-flat\"\n          >\n            <Grid3X3 className=\"h-4 w-4 mr-1\" />\n            Lista\n          </Button>\n          <Link href=\"/catalog\" className=\"inline-flex items-center gap-2 text-sm font-medium text-primary hover:underline ml-2\" data-testid=\"link-view-all-products\">\n            <ShoppingBag className=\"h-4 w-4\" />\n            Ver todos os produtos\n          </Link>\n        </div>\n      </div>\n\n      {viewMode === \"hierarchy\" && categoryTree.length > 0 && (\n        <div className=\"flex items-center gap-2 flex-wrap\">\n          <Button variant=\"outline\" size=\"sm\" onClick={expandAll} data-testid=\"button-expand-all\">\n            Expandir Tudo\n          </Button>\n          <Button variant=\"outline\" size=\"sm\" onClick={collapseAll} data-testid=\"button-collapse-all\">\n            Recolher Tudo\n          </Button>\n        </div>\n      )}\n\n      {isLoading ? (\n        <div className=\"flex flex-col items-center justify-center py-20\">\n          <Loader2 className=\"h-10 w-10 animate-spin text-primary mb-4\" />\n          <p className=\"text-muted-foreground\">Carregando categorias...</p>\n        </div>\n      ) : filteredCategories.length === 0 ? (\n        <div className=\"flex flex-col items-center justify-center py-20 text-center\">\n          <div className=\"w-20 h-20 rounded-full bg-muted/50 flex items-center justify-center mb-4\">\n            <Grid3X3 className=\"h-10 w-10 text-muted-foreground/50\" />\n          </div>\n          <h3 className=\"font-semibold text-lg mb-2\">Nenhuma categoria cadastrada</h3>\n          <p className=\"text-muted-foreground text-sm mb-4\">\n            As categorias serao exibidas aqui quando forem cadastradas\n          </p>\n          {isAdmin && (\n            <Button onClick={handleCreateNew} data-testid=\"button-create-first-category\">\n              <Plus className=\"h-4 w-4 mr-1\" />\n              Criar primeira categoria\n            </Button>\n          )}\n        </div>\n      ) : (\n        <>\n          {/* Filter buttons for both views */}\n          <div className=\"flex items-center gap-2 flex-wrap\">\n            <Button \n              variant={showFilter === \"all\" ? \"default\" : \"outline\"} \n              size=\"sm\" \n              onClick={() => setShowFilter(\"all\")}\n              data-testid=\"button-filter-all-flat\"\n            >\n              Todas ({categoriesData.length})\n            </Button>\n            <Button \n              variant={showFilter === \"visible\" ? \"default\" : \"outline\"} \n              size=\"sm\" \n              onClick={() => setShowFilter(\"visible\")}\n              data-testid=\"button-filter-visible-flat\"\n            >\n              <Eye className=\"h-3.5 w-3.5 mr-1\" />\n              Visiveis ({categoriesData.length - hiddenCount})\n            </Button>\n            <Button \n              variant={showFilter === \"hidden\" ? \"default\" : \"outline\"} \n              size=\"sm\" \n              onClick={() => setShowFilter(\"hidden\")}\n              data-testid=\"button-filter-hidden-flat\"\n            >\n              <EyeOff className=\"h-3.5 w-3.5 mr-1\" />\n              Ocultas ({hiddenCount})\n            </Button>\n          </div>\n          {viewMode === \"hierarchy\" ? (\n        <div className=\"space-y-4\">\n          {categoryTree.map((category) => (\n            <CategoryCard \n              key={category.id} \n              category={category}\n              expandedCategories={expandedCategories}\n              toggleExpanded={toggleExpanded}\n              isAdmin={isAdmin}\n              onEdit={handleEdit}\n              onDelete={handleDelete}\n              onToggleVarejo={handleToggleVarejo}\n              isTogglingVarejo={toggleVarejoMutation.isPending}\n            />\n          ))}\n\n          <Link href=\"/catalog\" className=\"block ml-11\" data-testid=\"card-all-products\">\n            <Card className=\"group overflow-visible hover-elevate active-elevate-2 transition-all duration-200 border-dashed\">\n              <CardContent className=\"p-0\">\n                <div className=\"relative h-20 bg-gradient-to-br from-muted/50 to-muted/30 rounded-t-lg overflow-hidden\">\n                  <div className=\"absolute inset-0 flex items-center justify-center\">\n                    <Package className=\"h-10 w-10 text-muted-foreground/60 group-hover:scale-110 transition-transform duration-300\" />\n                  </div>\n                </div>\n                <div className=\"p-4\">\n                  <div className=\"flex items-center justify-between gap-2\">\n                    <h3 className=\"font-semibold text-base\">Todos os Produtos</h3>\n                    <Badge variant=\"outline\" className=\"shrink-0\">\n                      {totalProducts}\n                    </Badge>\n                  </div>\n                  <p className=\"text-xs text-muted-foreground mt-1\">\n                    Ver catalogo completo\n                  </p>\n                </div>\n              </CardContent>\n            </Card>\n          </Link>\n        </div>\n      ) : (\n        <div className=\"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4\">\n          {flatCategories.map((category) => {\n            const Icon = getCategoryIcon(category.slug);\n            const bgGradient = getCategoryColor(category.slug);\n            const iconColor = getCategoryIconColor(category.slug);\n\n            return (\n              <div key={category.id}>\n                <Card className=\"group overflow-visible hover-elevate active-elevate-2 transition-all duration-200\">\n                  <CardContent className=\"p-0\">\n                    <Link href={`/catalog?category=${encodeURIComponent(category.name)}`} data-testid={`card-category-${category.id}`}>\n                      <div className={`relative h-32 bg-gradient-to-br ${bgGradient} rounded-t-lg overflow-hidden`}>\n                        <div className=\"absolute inset-0 flex items-center justify-center\">\n                          <Icon className={`h-16 w-16 ${iconColor} opacity-80 group-hover:scale-110 transition-transform duration-300`} />\n                        </div>\n                        <div className=\"absolute bottom-0 left-0 right-0 h-8 bg-gradient-to-t from-background/20 to-transparent\" />\n                        {category.hideFromVarejo && (\n                          <div className=\"absolute top-2 right-2\">\n                            <Badge variant=\"secondary\" className=\"text-xs gap-1\">\n                              <EyeOff className=\"h-3 w-3\" />\n                              Atacado\n                            </Badge>\n                          </div>\n                        )}\n                      </div>\n                    </Link>\n                    <div className=\"p-4\">\n                      <div className=\"flex items-center justify-between gap-2\">\n                        <Link \n                          href={`/catalog?category=${encodeURIComponent(category.name)}`}\n                          className=\"min-w-0 flex-1\"\n                        >\n                          {category.parentName && (\n                            <p className=\"text-xs text-muted-foreground truncate\">{category.parentName}</p>\n                          )}\n                          <h3 className=\"font-semibold text-base truncate\">{category.name}</h3>\n                        </Link>\n                        <Badge variant=\"secondary\" className=\"shrink-0\">\n                          {category.productCount}\n                        </Badge>\n                      </div>\n                      <div className=\"flex items-center justify-between mt-1\">\n                        <p className=\"text-xs text-muted-foreground\">\n                          {category.productCount === 0 \n                            ? \"Nenhum produto\" \n                            : category.productCount === 1 \n                              ? \"1 produto disponivel\" \n                              : `${category.productCount} produtos disponiveis`}\n                        </p>\n                        {isAdmin && (\n                          <div className=\"flex items-center gap-1\">\n                            <Button\n                              size=\"icon\"\n                              variant=\"ghost\"\n                              className={`h-7 w-7 ${category.hideFromVarejo ? 'text-orange-500' : 'text-muted-foreground'}`}\n                              onClick={(e) => {\n                                e.preventDefault();\n                                handleToggleVarejo(category);\n                              }}\n                              disabled={toggleVarejoMutation.isPending}\n                              title={category.hideFromVarejo ? \"Mostrar para Varejo\" : \"Ocultar do Varejo\"}\n                              data-testid={`button-toggle-varejo-${category.id}`}\n                            >\n                              <EyeOff className=\"h-3.5 w-3.5\" />\n                            </Button>\n                            <Button\n                              size=\"icon\"\n                              variant=\"ghost\"\n                              className=\"h-7 w-7\"\n                              onClick={(e) => {\n                                e.preventDefault();\n                                handleEdit(category);\n                              }}\n                              data-testid={`button-edit-category-${category.id}`}\n                            >\n                              <Edit className=\"h-3.5 w-3.5\" />\n                            </Button>\n                            <Button\n                              size=\"icon\"\n                              variant=\"ghost\"\n                              className=\"h-7 w-7 text-destructive\"\n                              onClick={(e) => {\n                                e.preventDefault();\n                                handleDelete(category);\n                              }}\n                              data-testid={`button-delete-category-${category.id}`}\n                            >\n                              <Trash2 className=\"h-3.5 w-3.5\" />\n                            </Button>\n                          </div>\n                        )}\n                      </div>\n                    </div>\n                  </CardContent>\n                </Card>\n              </div>\n            );\n          })}\n\n          <Link href=\"/catalog\" className=\"block\" data-testid=\"card-all-products-flat\">\n            <Card className=\"group overflow-visible hover-elevate active-elevate-2 transition-all duration-200 border-dashed\">\n              <CardContent className=\"p-0\">\n                <div className=\"relative h-32 bg-gradient-to-br from-muted/50 to-muted/30 rounded-t-lg overflow-hidden\">\n                  <div className=\"absolute inset-0 flex items-center justify-center\">\n                    <Package className=\"h-16 w-16 text-muted-foreground/60 group-hover:scale-110 transition-transform duration-300\" />\n                  </div>\n                </div>\n                <div className=\"p-4\">\n                  <div className=\"flex items-center justify-between gap-2\">\n                    <h3 className=\"font-semibold text-base\">Todos os Produtos</h3>\n                    <Badge variant=\"outline\" className=\"shrink-0\">\n                      {totalProducts}\n                    </Badge>\n                  </div>\n                  <p className=\"text-xs text-muted-foreground mt-1\">\n                    Ver catalogo completo\n                  </p>\n                </div>\n              </CardContent>\n            </Card>\n          </Link>\n        </div>\n          )}\n        </>\n      )}\n\n      {!isLoading && filteredCategories.length > 0 && (\n        <div className=\"mt-8\">\n          <Card>\n            <CardContent className=\"p-4\">\n              <div className=\"grid grid-cols-2 md:grid-cols-5 gap-4 text-center\">\n                <div>\n                  <p className=\"text-2xl font-bold text-primary\" data-testid=\"stat-root-categories\">{rootCategoriesCount}</p>\n                  <p className=\"text-xs text-muted-foreground\">Categorias</p>\n                </div>\n                <div>\n                  <p className=\"text-2xl font-bold text-secondary-foreground\" data-testid=\"stat-subcategories\">{subcategoriesCount}</p>\n                  <p className=\"text-xs text-muted-foreground\">Subcategorias</p>\n                </div>\n                <div>\n                  <p className=\"text-2xl font-bold\" data-testid=\"stat-total-products\">{totalProducts}</p>\n                  <p className=\"text-xs text-muted-foreground\">Produtos</p>\n                </div>\n                <div>\n                  <p className=\"text-2xl font-bold text-green-600\" data-testid=\"stat-active-categories\">\n                    {flatCategories.filter(c => c.productCount > 0).length}\n                  </p>\n                  <p className=\"text-xs text-muted-foreground\">Com Produtos</p>\n                </div>\n                <div>\n                  <p className=\"text-2xl font-bold text-muted-foreground\" data-testid=\"stat-empty-categories\">\n                    {flatCategories.filter(c => c.productCount === 0).length}\n                  </p>\n                  <p className=\"text-xs text-muted-foreground\">Sem Produtos</p>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n        </div>\n      )}\n\n      <CategoryDialog\n        category={editingCategory}\n        allCategories={categoriesData}\n        open={dialogOpen}\n        onOpenChange={setDialogOpen}\n        onSuccess={() => setEditingCategory(null)}\n      />\n\n      {deletingCategory && (\n        <DeleteCategoryDialog\n          category={deletingCategory}\n          open={!!deletingCategory}\n          onOpenChange={(open) => !open && setDeletingCategory(null)}\n          onSuccess={() => setDeletingCategory(null)}\n        />\n      )}\n    </div>\n  );\n}\n","path":null,"size_bytes":37643,"size_tokens":null},"docs/bling-api-integration.md":{"content":"# Integração com Bling API v3\n\n## Visão Geral\n\nA API do Bling permite importar produtos do ERP Bling para o catálogo B2B. A API v3 usa OAuth 2.0 para autenticação.\n\n## Configuração Necessária\n\n### 1. Criar Aplicativo no Bling\n\n1. Acesse https://developer.bling.com.br/aplicativos\n2. Crie um novo aplicativo OAuth\n3. Obtenha:\n   - `client_id`\n   - `client_secret`\n4. Configure a URL de callback para receber o código de autorização\n\n### 2. Credenciais Necessárias\n\n```env\nBLING_CLIENT_ID=seu_client_id\nBLING_CLIENT_SECRET=seu_client_secret\nBLING_ACCESS_TOKEN=token_de_acesso\nBLING_REFRESH_TOKEN=token_de_refresh\n```\n\n## Endpoints Principais\n\n### Base URL\n```\nhttps://api.bling.com.br/Api/v3\n```\n\n### Listar Produtos\n```\nGET /produtos\n```\n\n**Parâmetros de Query:**\n| Parâmetro | Tipo | Descrição | Padrão |\n|-----------|------|-----------|--------|\n| `pagina` | integer | Número da página | 1 |\n| `limite` | integer | Registros por página (max 100) | 100 |\n| `criterio` | integer | Critérios de listagem | 1 |\n| `tipo` | string | Tipo: P=Produto, S=Serviço, T=Todos | T |\n| `codigo` | string | SKUs separados por vírgula | - |\n\n**Resposta:**\n```json\n{\n  \"data\": [\n    {\n      \"id\": 12345,\n      \"nome\": \"Produto Exemplo\",\n      \"codigo\": \"SKU-001\",\n      \"preco\": 99.90,\n      \"precoCusto\": 50.00,\n      \"tipo\": \"P\",\n      \"situacao\": \"A\",\n      \"formato\": \"S\",\n      \"descricaoCurta\": \"Descrição curta\",\n      \"unidade\": \"UN\",\n      \"pesoLiquido\": 0.5,\n      \"pesoBruto\": 0.6,\n      \"largura\": 10,\n      \"altura\": 5,\n      \"profundidade\": 15,\n      \"volumes\": 1,\n      \"itensPorCaixa\": 1,\n      \"gtin\": \"7891234567890\",\n      \"gtinEmbalagem\": \"\",\n      \"tipoProducao\": \"P\",\n      \"condicao\": 0,\n      \"freteGratis\": false,\n      \"marca\": \"Marca X\",\n      \"dataValidade\": null,\n      \"observacoes\": \"\",\n      \"categoria\": {\n        \"id\": 123,\n        \"descricao\": \"Categoria\"\n      },\n      \"estoque\": {\n        \"minimo\": 5,\n        \"maximo\": 100,\n        \"saldoVirtual\": 50\n      },\n      \"midia\": {\n        \"video\": {\n          \"url\": \"\"\n        },\n        \"imagens\": {\n          \"externas\": [\n            {\n              \"link\": \"https://exemplo.com/imagem.jpg\"\n            }\n          ]\n        }\n      }\n    }\n  ]\n}\n```\n\n### Obter Produto por ID\n```\nGET /produtos/{idProduto}\n```\n\n### Categorias de Produtos\n```\nGET /categorias/produtos\n```\n\n### Estoques\n```\nGET /estoques\nGET /estoques/saldos\n```\n\n## Autenticação OAuth 2.0\n\n### Fluxo de Autorização\n\n1. **Redirecionar usuário para autorização:**\n```\nhttps://www.bling.com.br/Api/v3/oauth/authorize?response_type=code&client_id={CLIENT_ID}&redirect_uri={REDIRECT_URI}&state={STATE}\n```\n\n2. **Trocar código por tokens:**\n```bash\nPOST https://www.bling.com.br/Api/v3/oauth/token\nContent-Type: application/x-www-form-urlencoded\n\ngrant_type=authorization_code&code={CODE}&redirect_uri={REDIRECT_URI}\nAuthorization: Basic base64(client_id:client_secret)\n```\n\n3. **Refresh Token (quando o access_token expirar):**\n```bash\nPOST https://www.bling.com.br/Api/v3/oauth/token\nContent-Type: application/x-www-form-urlencoded\n\ngrant_type=refresh_token&refresh_token={REFRESH_TOKEN}\nAuthorization: Basic base64(client_id:client_secret)\n```\n\n### Headers de Requisição\n```\nAuthorization: Bearer {access_token}\nContent-Type: application/json\nAccept: application/json\n```\n\n## Mapeamento Bling -> Catálogo B2B\n\n| Campo Bling | Campo Catálogo | Notas |\n|-------------|----------------|-------|\n| `id` | - | Armazenar como referência externa |\n| `nome` | `name` | Nome do produto |\n| `codigo` | `sku` | Código/SKU do produto |\n| `preco` | `price` | Preço de venda |\n| `descricaoCurta` | `description` | Descrição do produto |\n| `marca` | `brand` | Marca do produto |\n| `categoria.descricao` | `categoryId` | Buscar/criar categoria |\n| `estoque.saldoVirtual` | `stock` | Quantidade em estoque |\n| `midia.imagens.externas[0].link` | `image` | URL da imagem |\n| `situacao` | `active` | A=Ativo, I=Inativo |\n| `gtin` | - | Código de barras (opcional) |\n\n## Implementação Sugerida\n\n### Estrutura de Arquivos\n```\nserver/\n  services/\n    bling/\n      auth.ts      # Autenticação OAuth\n      products.ts  # Sincronização de produtos\n      categories.ts # Sincronização de categorias\n  routes/\n    bling.ts       # Endpoints da integração\n```\n\n### Endpoints da Aplicação\n\n```typescript\n// Iniciar autenticação\nGET /api/bling/auth\n\n// Callback OAuth\nGET /api/bling/callback?code={code}&state={state}\n\n// Importar produtos\nPOST /api/bling/sync/products\n\n// Status da integração\nGET /api/bling/status\n```\n\n## Tratamento de Erros\n\n### Códigos HTTP\n- `401` - Token expirado (fazer refresh)\n- `429` - Rate limit (aguardar e tentar novamente)\n- `500` - Erro interno do Bling\n\n### Rate Limiting\nA API do Bling tem limite de requisições. Implementar:\n- Delay entre requisições (100ms)\n- Retry com backoff exponencial\n- Cache de dados frequentes\n\n## Sincronização\n\n### Estratégia Recomendada\n\n1. **Sincronização Inicial:**\n   - Paginar todos os produtos\n   - Criar categorias não existentes\n   - Inserir produtos em lote\n\n2. **Sincronização Incremental:**\n   - Usar webhooks do Bling (se disponível)\n   - Ou sync periódico a cada X horas\n   - Atualizar apenas produtos modificados\n\n3. **Mapeamento de IDs:**\n   - Manter tabela de referência `blingId` -> `productId`\n   - Permitir atualização sem duplicar produtos\n\n## Webhooks (Sincronização Automática)\n\nOs webhooks do Bling permitem receber notificações em tempo real quando produtos são criados, atualizados ou excluídos no ERP.\n\n### Configuração no Bling\n\n1. Acesse seu aplicativo em https://developer.bling.com.br/aplicativos\n2. Navegue até a aba \"Webhooks\"\n3. Configure o servidor de destino (URL do webhook)\n4. Selecione os recursos que deseja receber notificações:\n   - `product.created` - Produto criado\n   - `product.updated` - Produto atualizado\n   - `product.deleted` - Produto excluído\n   - `stock.created` - Estoque atualizado\n   - `stock.updated` - Estoque atualizado\n\n### URL do Webhook\n\n```\nhttps://seu-dominio.replit.dev/api/bling/webhook\n```\n\n### Verificação de Assinatura\n\nO Bling envia uma assinatura HMAC-SHA256 no header `X-Bling-Signature-256` para validar a autenticidade da requisição.\n\n```typescript\nimport crypto from \"crypto\";\n\nfunction verifyWebhookSignature(payload: string, signature: string): boolean {\n  const clientSecret = process.env.BLING_CLIENT_SECRET;\n  \n  const expectedSignature = crypto\n    .createHmac(\"sha256\", clientSecret)\n    .update(payload, \"utf8\")\n    .digest(\"hex\");\n\n  return crypto.timingSafeEqual(\n    Buffer.from(expectedSignature, \"hex\"),\n    Buffer.from(signature, \"hex\")\n  );\n}\n```\n\n### Estrutura do Payload\n\n```json\n{\n  \"eventId\": \"uuid-do-evento\",\n  \"date\": \"2024-01-15T10:30:00Z\",\n  \"version\": \"3\",\n  \"event\": \"product.created\",\n  \"companyId\": \"12345\",\n  \"data\": {\n    \"id\": 67890,\n    \"nome\": \"Novo Produto\",\n    \"codigo\": \"SKU-001\",\n    \"preco\": 99.90,\n    \"situacao\": \"A\"\n  }\n}\n```\n\n### Boas Práticas\n\n1. **Responder rapidamente:** Retorne HTTP 2xx imediatamente e processe o webhook de forma assíncrona\n2. **Idempotência:** O mesmo webhook pode ser enviado mais de uma vez\n3. **Ordem dos eventos:** Eventos podem chegar fora de ordem (ex: update antes de create)\n4. **Retries:** O Bling tenta reenviar por até 3 dias com intervalos crescentes\n5. **Desativação automática:** Se todas as tentativas falharem, o webhook é desativado\n\n### Eventos Suportados na Aplicação\n\n| Evento | Ação |\n|--------|------|\n| `product.created` | Cria produto no catálogo |\n| `product.updated` | Atualiza produto existente |\n| `product.deleted` | Remove produto do catálogo |\n| `stock.created` | Atualiza estoque do produto |\n| `stock.updated` | Atualiza estoque do produto |\n\n## Links Úteis\n\n- [Documentação Oficial](https://developer.bling.com.br/)\n- [Documentação de Webhooks](https://developer.bling.com.br/webhooks)\n- [Referência da API](https://developer.bling.com.br/referencia)\n- [SDK JavaScript](https://github.com/AlexandreBellas/bling-erp-api-js)\n- [OpenAPI Spec](https://developer.bling.com.br/build/assets/openapi-CilBfHrw.json)\n","path":null,"size_bytes":8166,"size_tokens":null},"client/src/pages/bling.tsx":{"content":"import { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { useLocation } from \"wouter\";\nimport { useEffect, useState, useRef } from \"react\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Progress } from \"@/components/ui/progress\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { Checkbox } from \"@/components/ui/checkbox\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport { Loader2, CheckCircle, XCircle, RefreshCw, Link as LinkIcon, FolderSync, Package, Unlink, Clock, AlertCircle, Download, Search } from \"lucide-react\";\n\ninterface BlingStatus {\n  authenticated: boolean;\n  hasCredentials: boolean;\n}\n\ninterface SyncResult {\n  created: number;\n  updated: number;\n  errors?: string[];\n}\n\ninterface SyncProgress {\n  status: 'idle' | 'running' | 'completed' | 'error';\n  phase: string;\n  currentStep: number;\n  totalSteps: number;\n  message: string;\n  created: number;\n  updated: number;\n  errors: number;\n  startTime: number | null;\n  estimatedRemaining: string | null;\n}\n\ninterface BlingCategory {\n  id: number;\n  descricao: string;\n  categoriaPai?: { id: number };\n}\n\ninterface BlingProduct {\n  id: number;\n  nome: string;\n  codigo: string;\n  preco: number;\n  situacao: string;\n}\n\ninterface ImportResult {\n  imported: number;\n  skipped: number;\n  errors: string[];\n}\n\nexport default function BlingPage() {\n  const { toast } = useToast();\n  const [location] = useLocation();\n  const [syncProgress, setSyncProgress] = useState<SyncProgress | null>(null);\n  const eventSourceRef = useRef<EventSource | null>(null);\n  const [activeTab, setActiveTab] = useState(\"categories\");\n  const [selectedCategories, setSelectedCategories] = useState<number[]>([]);\n  const [selectedProducts, setSelectedProducts] = useState<number[]>([]);\n  const [blingCategories, setBlingCategories] = useState<BlingCategory[]>([]);\n  const [blingProducts, setBlingProducts] = useState<BlingProduct[]>([]);\n  const [loadingCategories, setLoadingCategories] = useState(false);\n  const [loadingProducts, setLoadingProducts] = useState(false);\n\n  const { data: status, isLoading } = useQuery<BlingStatus>({\n    queryKey: [\"/api/bling/status\"],\n  });\n\n  useEffect(() => {\n    const params = new URLSearchParams(window.location.search);\n    if (params.get(\"success\") === \"true\") {\n      toast({\n        title: \"Conectado ao Bling\",\n        description: \"Sua conta Bling foi conectada com sucesso.\",\n      });\n      queryClient.invalidateQueries({ queryKey: [\"/api/bling/status\"] });\n      window.history.replaceState({}, \"\", \"/bling\");\n    } else if (params.get(\"error\") === \"auth_failed\") {\n      toast({\n        title: \"Falha na Conexão\",\n        description: \"Falha ao conectar ao Bling. Por favor, tente novamente.\",\n        variant: \"destructive\",\n      });\n      window.history.replaceState({}, \"\", \"/bling\");\n    }\n  }, [location, toast]);\n\n  useEffect(() => {\n    if (status?.authenticated) {\n      const eventSource = new EventSource(\"/api/bling/sync/progress\", { withCredentials: true });\n      eventSourceRef.current = eventSource;\n\n      eventSource.onmessage = (event) => {\n        try {\n          const progress: SyncProgress = JSON.parse(event.data);\n          setSyncProgress(progress);\n          \n          if (progress.status === 'completed') {\n            queryClient.invalidateQueries({ queryKey: [\"/api/products\"] });\n            toast({\n              title: \"Sincronização Concluída\",\n              description: `${progress.created} criados, ${progress.updated} atualizados${progress.errors > 0 ? `, ${progress.errors} erros` : ''}`,\n            });\n          }\n        } catch (e) {\n          console.error(\"Error parsing SSE data:\", e);\n        }\n      };\n\n      eventSource.onerror = () => {\n        eventSource.close();\n      };\n\n      return () => {\n        eventSource.close();\n      };\n    }\n  }, [status?.authenticated, toast]);\n\n  const syncCategoriesMutation = useMutation({\n    mutationFn: async () => {\n      const response = await apiRequest(\"POST\", \"/api/bling/sync/categories\");\n      return response.json();\n    },\n    onSuccess: (data: SyncResult) => {\n      toast({\n        title: \"Categorias Sincronizadas\",\n        description: `Criadas: ${data.created}, Atualizadas: ${data.updated}`,\n      });\n      queryClient.invalidateQueries({ queryKey: [\"/api/categories\"] });\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Falha na Sincronização\",\n        description: error.message || \"Falha ao sincronizar categorias\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const syncProductsMutation = useMutation({\n    mutationFn: async () => {\n      const response = await apiRequest(\"POST\", \"/api/bling/sync/products\");\n      return response.json();\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Falha na Sincronização\",\n        description: error.message || \"Falha ao sincronizar produtos\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const disconnectMutation = useMutation({\n    mutationFn: async () => {\n      const response = await apiRequest(\"POST\", \"/api/bling/disconnect\");\n      return response.json();\n    },\n    onSuccess: () => {\n      toast({\n        title: \"Desconectado\",\n        description: \"Sua conta Bling foi desconectada.\",\n      });\n      queryClient.invalidateQueries({ queryKey: [\"/api/bling/status\"] });\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Erro\",\n        description: error.message || \"Falha ao desconectar\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const handleConnect = () => {\n    window.location.href = \"/api/bling/auth\";\n  };\n\n  const loadBlingCategories = async () => {\n    setLoadingCategories(true);\n    try {\n      const response = await apiRequest(\"GET\", \"/api/bling/categories/preview\");\n      const data = await response.json();\n      setBlingCategories(data.categories || []);\n      setSelectedCategories([]);\n    } catch (error: any) {\n      toast({\n        title: \"Erro ao carregar categorias\",\n        description: error.message || \"Falha ao buscar categorias do Bling\",\n        variant: \"destructive\",\n      });\n    } finally {\n      setLoadingCategories(false);\n    }\n  };\n\n  const loadBlingProducts = async () => {\n    setLoadingProducts(true);\n    try {\n      const response = await apiRequest(\"GET\", \"/api/bling/products/preview\");\n      const data = await response.json();\n      setBlingProducts(data.products || []);\n      setSelectedProducts([]);\n    } catch (error: any) {\n      toast({\n        title: \"Erro ao carregar produtos\",\n        description: error.message || \"Falha ao buscar produtos do Bling\",\n        variant: \"destructive\",\n      });\n    } finally {\n      setLoadingProducts(false);\n    }\n  };\n\n  const importCategoriesMutation = useMutation({\n    mutationFn: async (categoryIds: number[]) => {\n      const response = await apiRequest(\"POST\", \"/api/bling/categories/import\", { categoryIds });\n      return response.json();\n    },\n    onSuccess: (data: ImportResult) => {\n      toast({\n        title: \"Categorias importadas\",\n        description: `${data.imported} importadas, ${data.skipped} já existentes`,\n      });\n      queryClient.invalidateQueries({ queryKey: [\"/api/categories\"] });\n      setSelectedCategories([]);\n      loadBlingCategories();\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Erro ao importar categorias\",\n        description: error.message || \"Falha ao importar categorias selecionadas\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const importProductsMutation = useMutation({\n    mutationFn: async (productIds: number[]) => {\n      const response = await apiRequest(\"POST\", \"/api/bling/products/import\", { productIds });\n      return response.json();\n    },\n    onSuccess: (data: ImportResult) => {\n      toast({\n        title: \"Produtos importados\",\n        description: `${data.imported} importados, ${data.skipped} já existentes`,\n      });\n      queryClient.invalidateQueries({ queryKey: [\"/api/products\"] });\n      setSelectedProducts([]);\n      loadBlingProducts();\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Erro ao importar produtos\",\n        description: error.message || \"Falha ao importar produtos selecionados\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const toggleCategorySelection = (id: number) => {\n    setSelectedCategories(prev => \n      prev.includes(id) ? prev.filter(c => c !== id) : [...prev, id]\n    );\n  };\n\n  const toggleProductSelection = (id: number) => {\n    setSelectedProducts(prev => \n      prev.includes(id) ? prev.filter(p => p !== id) : [...prev, id]\n    );\n  };\n\n  const selectAllCategories = () => {\n    if (selectedCategories.length === blingCategories.length) {\n      setSelectedCategories([]);\n    } else {\n      setSelectedCategories(blingCategories.map(c => c.id));\n    }\n  };\n\n  const selectAllProducts = () => {\n    if (selectedProducts.length === blingProducts.length) {\n      setSelectedProducts([]);\n    } else {\n      setSelectedProducts(blingProducts.map(p => p.id));\n    }\n  };\n\n  const isSyncing = syncProgress?.status === 'running';\n  const progressPercent = syncProgress && syncProgress.totalSteps > 0 \n    ? Math.round((syncProgress.currentStep / syncProgress.totalSteps) * 100) \n    : 0;\n\n  if (isLoading) {\n    return (\n      <div className=\"flex items-center justify-center h-64\">\n        <Loader2 className=\"h-8 w-8 animate-spin text-muted-foreground\" />\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"p-6 max-w-4xl mx-auto space-y-6\">\n      <div>\n        <h1 className=\"text-2xl font-bold\" data-testid=\"text-bling-title\">Integração Bling</h1>\n        <p className=\"text-muted-foreground\">\n          Conecte sua conta Bling para sincronizar produtos e categorias.\n        </p>\n      </div>\n\n      <Card>\n        <CardHeader>\n          <CardTitle className=\"flex items-center gap-2\">\n            <LinkIcon className=\"h-5 w-5\" />\n            Status da Conexão\n          </CardTitle>\n          <CardDescription>\n            Status da sua conexão com a API Bling\n          </CardDescription>\n        </CardHeader>\n        <CardContent className=\"space-y-4\">\n          <div className=\"flex items-center gap-4\">\n            <div className=\"flex items-center gap-2\">\n              <span className=\"text-sm font-medium\">Credenciais:</span>\n              {status?.hasCredentials ? (\n                <Badge variant=\"default\" className=\"flex items-center gap-1\">\n                  <CheckCircle className=\"h-3 w-3\" />\n                  Configuradas\n                </Badge>\n              ) : (\n                <Badge variant=\"destructive\" className=\"flex items-center gap-1\">\n                  <XCircle className=\"h-3 w-3\" />\n                  Ausentes\n                </Badge>\n              )}\n            </div>\n            <div className=\"flex items-center gap-2\">\n              <span className=\"text-sm font-medium\">Autenticação:</span>\n              {status?.authenticated ? (\n                <Badge variant=\"default\" className=\"flex items-center gap-1\">\n                  <CheckCircle className=\"h-3 w-3\" />\n                  Conectado\n                </Badge>\n              ) : (\n                <Badge variant=\"secondary\" className=\"flex items-center gap-1\">\n                  <XCircle className=\"h-3 w-3\" />\n                  Não Conectado\n                </Badge>\n              )}\n            </div>\n          </div>\n\n          <div className=\"flex flex-wrap gap-2\">\n            {status?.hasCredentials && !status?.authenticated && (\n              <Button onClick={handleConnect} data-testid=\"button-bling-connect\">\n                <LinkIcon className=\"h-4 w-4 mr-2\" />\n                Conectar ao Bling\n              </Button>\n            )}\n\n            {status?.authenticated && (\n              <Button \n                variant=\"destructive\" \n                onClick={() => disconnectMutation.mutate()}\n                disabled={disconnectMutation.isPending}\n                data-testid=\"button-bling-disconnect\"\n              >\n                {disconnectMutation.isPending ? (\n                  <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />\n                ) : (\n                  <Unlink className=\"h-4 w-4 mr-2\" />\n                )}\n                Desconectar\n              </Button>\n            )}\n          </div>\n\n          {!status?.hasCredentials && (\n            <p className=\"text-sm text-muted-foreground\">\n              Por favor, configure BLING_CLIENT_ID e BLING_CLIENT_SECRET no seu ambiente.\n            </p>\n          )}\n        </CardContent>\n      </Card>\n\n      {status?.authenticated && (\n        <Card>\n          <CardHeader>\n            <CardTitle className=\"flex items-center gap-2\">\n              <RefreshCw className=\"h-5 w-5\" />\n              Sincronização\n            </CardTitle>\n            <CardDescription>\n              Sincronize dados do Bling para seu catálogo\n            </CardDescription>\n          </CardHeader>\n          <CardContent className=\"space-y-4\">\n            <div className=\"flex flex-wrap gap-4\">\n              <Button\n                onClick={() => syncCategoriesMutation.mutate()}\n                disabled={syncCategoriesMutation.isPending || isSyncing}\n                variant=\"outline\"\n                data-testid=\"button-sync-categories\"\n              >\n                {syncCategoriesMutation.isPending ? (\n                  <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />\n                ) : (\n                  <FolderSync className=\"h-4 w-4 mr-2\" />\n                )}\n                Sincronizar Categorias\n              </Button>\n\n              <Button\n                onClick={() => syncProductsMutation.mutate()}\n                disabled={syncProductsMutation.isPending || isSyncing}\n                data-testid=\"button-sync-products\"\n              >\n                {(syncProductsMutation.isPending || isSyncing) ? (\n                  <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />\n                ) : (\n                  <Package className=\"h-4 w-4 mr-2\" />\n                )}\n                Sincronizar Produtos\n              </Button>\n            </div>\n\n            {isSyncing && syncProgress && (\n              <div className=\"space-y-3 p-4 bg-muted/50 rounded-md\" data-testid=\"sync-progress-container\">\n                <div className=\"flex items-center justify-between\">\n                  <div className=\"flex items-center gap-2\">\n                    <Loader2 className=\"h-4 w-4 animate-spin text-primary\" />\n                    <span className=\"font-medium text-sm\">{syncProgress.phase}</span>\n                  </div>\n                  {syncProgress.estimatedRemaining && (\n                    <div className=\"flex items-center gap-1 text-sm text-muted-foreground\">\n                      <Clock className=\"h-3 w-3\" />\n                      <span>~{syncProgress.estimatedRemaining}</span>\n                    </div>\n                  )}\n                </div>\n                \n                <Progress value={progressPercent} className=\"h-2\" data-testid=\"sync-progress-bar\" />\n                \n                <div className=\"flex items-center justify-between text-sm\">\n                  <span className=\"text-muted-foreground\">{syncProgress.message}</span>\n                  <span className=\"font-medium\">{progressPercent}%</span>\n                </div>\n                \n                <div className=\"flex gap-4 text-sm\">\n                  <div className=\"flex items-center gap-1\">\n                    <CheckCircle className=\"h-3 w-3 text-green-500\" />\n                    <span>{syncProgress.created} novos</span>\n                  </div>\n                  <div className=\"flex items-center gap-1\">\n                    <RefreshCw className=\"h-3 w-3 text-blue-500\" />\n                    <span>{syncProgress.updated} atualizados</span>\n                  </div>\n                  {syncProgress.errors > 0 && (\n                    <div className=\"flex items-center gap-1\">\n                      <AlertCircle className=\"h-3 w-3 text-destructive\" />\n                      <span>{syncProgress.errors} erros</span>\n                    </div>\n                  )}\n                </div>\n              </div>\n            )}\n\n            {syncProgress?.status === 'completed' && (\n              <div className=\"p-4 bg-green-500/10 border border-green-500/20 rounded-md\" data-testid=\"sync-completed\">\n                <div className=\"flex items-center gap-2 text-green-600 dark:text-green-400\">\n                  <CheckCircle className=\"h-5 w-5\" />\n                  <span className=\"font-medium\">{syncProgress.message}</span>\n                </div>\n                <div className=\"mt-2 text-sm text-muted-foreground\">\n                  {syncProgress.created} produtos criados, {syncProgress.updated} atualizados\n                  {syncProgress.errors > 0 && `, ${syncProgress.errors} erros`}\n                </div>\n              </div>\n            )}\n\n            {syncProgress?.status === 'error' && (\n              <div className=\"p-4 bg-destructive/10 border border-destructive/20 rounded-md\" data-testid=\"sync-error\">\n                <div className=\"flex items-center gap-2 text-destructive\">\n                  <AlertCircle className=\"h-5 w-5\" />\n                  <span className=\"font-medium\">{syncProgress.message}</span>\n                </div>\n              </div>\n            )}\n\n            <p className=\"text-sm text-muted-foreground\">\n              A sincronização irá importar ou atualizar categorias e produtos da sua conta Bling.\n            </p>\n          </CardContent>\n        </Card>\n      )}\n\n      {status?.authenticated && (\n        <Card>\n          <CardHeader>\n            <CardTitle className=\"flex items-center gap-2\">\n              <Download className=\"h-5 w-5\" />\n              Importação Manual\n            </CardTitle>\n            <CardDescription>\n              Selecione categorias e produtos específicos para importar do Bling\n            </CardDescription>\n          </CardHeader>\n          <CardContent>\n            <Tabs value={activeTab} onValueChange={setActiveTab}>\n              <TabsList className=\"mb-4\">\n                <TabsTrigger value=\"categories\" data-testid=\"tab-categories\">\n                  <FolderSync className=\"h-4 w-4 mr-2\" />\n                  Categorias\n                </TabsTrigger>\n                <TabsTrigger value=\"products\" data-testid=\"tab-products\">\n                  <Package className=\"h-4 w-4 mr-2\" />\n                  Produtos\n                </TabsTrigger>\n              </TabsList>\n\n              <TabsContent value=\"categories\" className=\"space-y-4\">\n                <div className=\"flex flex-wrap items-center gap-2\">\n                  <Button\n                    variant=\"outline\"\n                    onClick={loadBlingCategories}\n                    disabled={loadingCategories}\n                    data-testid=\"button-load-categories\"\n                  >\n                    {loadingCategories ? (\n                      <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />\n                    ) : (\n                      <Search className=\"h-4 w-4 mr-2\" />\n                    )}\n                    Carregar Categorias\n                  </Button>\n                  {blingCategories.length > 0 && (\n                    <>\n                      <Button\n                        variant=\"ghost\"\n                        size=\"sm\"\n                        onClick={selectAllCategories}\n                        data-testid=\"button-select-all-categories\"\n                      >\n                        {selectedCategories.length === blingCategories.length ? \"Desmarcar Tudo\" : \"Selecionar Tudo\"}\n                      </Button>\n                      <Badge variant=\"secondary\">\n                        {selectedCategories.length} de {blingCategories.length} selecionadas\n                      </Badge>\n                    </>\n                  )}\n                </div>\n\n                {blingCategories.length > 0 && (\n                  <ScrollArea className=\"h-80 border rounded-md p-3\">\n                    <div className=\"space-y-1\">\n                      {/* Show parent categories first, then their subcategories */}\n                      {blingCategories\n                        .filter(cat => !cat.categoriaPai)\n                        .map((parentCat) => {\n                          const subcategories = blingCategories.filter(\n                            sub => sub.categoriaPai?.id === parentCat.id\n                          );\n                          return (\n                            <div key={parentCat.id} className=\"space-y-1\">\n                              <label\n                                className=\"flex items-center gap-3 p-2 rounded-md hover-elevate cursor-pointer bg-muted/30\"\n                                data-testid={`category-item-${parentCat.id}`}\n                              >\n                                <Checkbox\n                                  checked={selectedCategories.includes(parentCat.id)}\n                                  onCheckedChange={() => toggleCategorySelection(parentCat.id)}\n                                  data-testid={`checkbox-category-${parentCat.id}`}\n                                />\n                                <div className=\"flex-1\">\n                                  <span className=\"text-sm font-semibold\">{parentCat.descricao}</span>\n                                  <span className=\"text-xs text-muted-foreground ml-2\">\n                                    (Categoria)\n                                  </span>\n                                </div>\n                                <Badge variant=\"outline\" className=\"text-xs\">\n                                  ID: {parentCat.id}\n                                </Badge>\n                              </label>\n                              {subcategories.map((subCat) => (\n                                <label\n                                  key={subCat.id}\n                                  className=\"flex items-center gap-3 p-2 pl-8 rounded-md hover-elevate cursor-pointer\"\n                                  data-testid={`category-item-${subCat.id}`}\n                                >\n                                  <Checkbox\n                                    checked={selectedCategories.includes(subCat.id)}\n                                    onCheckedChange={() => toggleCategorySelection(subCat.id)}\n                                    data-testid={`checkbox-category-${subCat.id}`}\n                                  />\n                                  <div className=\"flex-1\">\n                                    <span className=\"text-sm\">{subCat.descricao}</span>\n                                    <span className=\"text-xs text-muted-foreground ml-2\">\n                                      (Subcategoria)\n                                    </span>\n                                  </div>\n                                  <Badge variant=\"outline\" className=\"text-xs\">\n                                    ID: {subCat.id}\n                                  </Badge>\n                                </label>\n                              ))}\n                            </div>\n                          );\n                        })}\n                      {/* Show orphan subcategories (parent not in list) */}\n                      {blingCategories\n                        .filter(cat => cat.categoriaPai && !blingCategories.find(p => p.id === cat.categoriaPai?.id))\n                        .map((orphanCat) => (\n                          <label\n                            key={orphanCat.id}\n                            className=\"flex items-center gap-3 p-2 rounded-md hover-elevate cursor-pointer\"\n                            data-testid={`category-item-${orphanCat.id}`}\n                          >\n                            <Checkbox\n                              checked={selectedCategories.includes(orphanCat.id)}\n                              onCheckedChange={() => toggleCategorySelection(orphanCat.id)}\n                              data-testid={`checkbox-category-${orphanCat.id}`}\n                            />\n                            <div className=\"flex-1\">\n                              <span className=\"text-sm\">{orphanCat.descricao}</span>\n                              <span className=\"text-xs text-muted-foreground ml-2\">\n                                (Subcategoria órfã)\n                              </span>\n                            </div>\n                            <Badge variant=\"outline\" className=\"text-xs\">\n                              ID: {orphanCat.id}\n                            </Badge>\n                          </label>\n                        ))}\n                    </div>\n                  </ScrollArea>\n                )}\n\n                {blingCategories.length > 0 && (\n                  <Button\n                    onClick={() => importCategoriesMutation.mutate(selectedCategories)}\n                    disabled={selectedCategories.length === 0 || importCategoriesMutation.isPending}\n                    data-testid=\"button-import-categories\"\n                  >\n                    {importCategoriesMutation.isPending ? (\n                      <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />\n                    ) : (\n                      <Download className=\"h-4 w-4 mr-2\" />\n                    )}\n                    Importar {selectedCategories.length} Categoria{selectedCategories.length !== 1 ? 's' : ''}\n                  </Button>\n                )}\n              </TabsContent>\n\n              <TabsContent value=\"products\" className=\"space-y-4\">\n                <div className=\"flex flex-wrap items-center gap-2\">\n                  <Button\n                    variant=\"outline\"\n                    onClick={loadBlingProducts}\n                    disabled={loadingProducts}\n                    data-testid=\"button-load-products\"\n                  >\n                    {loadingProducts ? (\n                      <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />\n                    ) : (\n                      <Search className=\"h-4 w-4 mr-2\" />\n                    )}\n                    Carregar Produtos\n                  </Button>\n                  {blingProducts.length > 0 && (\n                    <>\n                      <Button\n                        variant=\"ghost\"\n                        size=\"sm\"\n                        onClick={selectAllProducts}\n                        data-testid=\"button-select-all-products\"\n                      >\n                        {selectedProducts.length === blingProducts.length ? \"Desmarcar Tudo\" : \"Selecionar Tudo\"}\n                      </Button>\n                      <Badge variant=\"secondary\">\n                        {selectedProducts.length} de {blingProducts.length} selecionados\n                      </Badge>\n                    </>\n                  )}\n                </div>\n\n                {blingProducts.length > 0 && (\n                  <ScrollArea className=\"h-64 border rounded-md p-3\">\n                    <div className=\"space-y-2\">\n                      {blingProducts.map((product) => (\n                        <label\n                          key={product.id}\n                          className=\"flex items-center gap-3 p-2 rounded-md hover-elevate cursor-pointer\"\n                          data-testid={`product-item-${product.id}`}\n                        >\n                          <Checkbox\n                            checked={selectedProducts.includes(product.id)}\n                            onCheckedChange={() => toggleProductSelection(product.id)}\n                            data-testid={`checkbox-product-${product.id}`}\n                          />\n                          <div className=\"flex-1 min-w-0\">\n                            <div className=\"text-sm font-medium truncate\">{product.nome}</div>\n                            <div className=\"text-xs text-muted-foreground flex flex-wrap gap-2\">\n                              <span>SKU: {product.codigo}</span>\n                              <span>R$ {product.preco?.toFixed(2) || '0.00'}</span>\n                            </div>\n                          </div>\n                          <Badge variant={product.situacao === 'A' ? 'default' : 'secondary'} className=\"text-xs\">\n                            {product.situacao === 'A' ? 'Ativo' : 'Inativo'}\n                          </Badge>\n                        </label>\n                      ))}\n                    </div>\n                  </ScrollArea>\n                )}\n\n                {blingProducts.length > 0 && (\n                  <Button\n                    onClick={() => importProductsMutation.mutate(selectedProducts)}\n                    disabled={selectedProducts.length === 0 || importProductsMutation.isPending}\n                    data-testid=\"button-import-products\"\n                  >\n                    {importProductsMutation.isPending ? (\n                      <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />\n                    ) : (\n                      <Download className=\"h-4 w-4 mr-2\" />\n                    )}\n                    Importar {selectedProducts.length} Produto{selectedProducts.length !== 1 ? 's' : ''}\n                  </Button>\n                )}\n              </TabsContent>\n            </Tabs>\n          </CardContent>\n        </Card>\n      )}\n    </div>\n  );\n}\n","path":null,"size_bytes":29697,"size_tokens":null},"server/services/bling.ts":{"content":"import { db } from \"../db\";\nimport { products, categories, blingTokens, type InsertProduct, type InsertCategory } from \"@shared/schema\";\nimport { eq, desc } from \"drizzle-orm\";\nimport crypto from \"crypto\";\n\nconst BLING_API_BASE = \"https://api.bling.com.br/Api/v3\";\nconst BLING_OAUTH_URL = \"https://www.bling.com.br/Api/v3/oauth\";\n\n// Encryption key for tokens (uses SESSION_SECRET as base)\nconst ENCRYPTION_KEY = crypto.scryptSync(\n  process.env.SESSION_SECRET || 'bling-token-encryption-key',\n  'salt',\n  32\n);\n\nfunction encryptToken(text: string): string {\n  const iv = crypto.randomBytes(16);\n  const cipher = crypto.createCipheriv('aes-256-cbc', ENCRYPTION_KEY, iv);\n  let encrypted = cipher.update(text, 'utf8', 'hex');\n  encrypted += cipher.final('hex');\n  return iv.toString('hex') + ':' + encrypted;\n}\n\nfunction decryptToken(encryptedText: string): string {\n  try {\n    const [ivHex, encrypted] = encryptedText.split(':');\n    if (!ivHex || !encrypted) return encryptedText; // Return as-is if not encrypted\n    const iv = Buffer.from(ivHex, 'hex');\n    const decipher = crypto.createDecipheriv('aes-256-cbc', ENCRYPTION_KEY, iv);\n    let decrypted = decipher.update(encrypted, 'hex', 'utf8');\n    decrypted += decipher.final('utf8');\n    return decrypted;\n  } catch {\n    return encryptedText; // Return as-is if decryption fails\n  }\n}\n\ninterface BlingTokensResponse {\n  access_token: string;\n  refresh_token: string;\n  expires_in: number;\n  token_type: string;\n}\n\ninterface BlingProductBasic {\n  id: number;\n  nome: string;\n  codigo: string;\n  preco: number;\n  precoCusto?: number;\n  tipo: string;\n  situacao: string;\n  formato?: string;\n  descricaoCurta?: string;\n  imagemURL?: string;\n  estoque?: {\n    saldoVirtualTotal?: number;\n    saldoFisicoTotal?: number;\n  };\n}\n\ninterface BlingProductFull {\n  id: number;\n  nome: string;\n  codigo: string;\n  preco: number;\n  precoCusto?: number;\n  tipo: string;\n  situacao: string;\n  descricaoCurta?: string;\n  descricaoComplementar?: string;\n  marca?: string;\n  categoria?: {\n    id: number;\n    descricao?: string;\n  };\n  estoque?: {\n    minimo?: number;\n    maximo?: number;\n    saldoFisico?: number;\n    saldoVirtual?: number;\n  };\n  imagens?: Array<{\n    id: number;\n    tipo?: string;\n    ordem?: number;\n    linkExterno?: string;\n    link?: string;\n  }>;\n  midia?: {\n    imagens?: {\n      externas?: Array<{ link: string }>;\n      internas?: Array<{ link: string }>;\n    };\n  };\n}\n\ninterface BlingCategory {\n  id: number;\n  descricao: string;\n  categoriaPai?: {\n    id: number;\n    descricao?: string;\n  };\n}\n\nlet cachedTokens: BlingTokensResponse | null = null;\nlet tokenExpiresAt: number = 0;\nlet isRefreshing: boolean = false;\nlet refreshPromise: Promise<BlingTokensResponse> | null = null;\n\n// ========== TOKEN PERSISTENCE ==========\n\nasync function saveTokensToDb(tokens: BlingTokensResponse): Promise<void> {\n  try {\n    const expiresAt = new Date(Date.now() + (tokens.expires_in * 1000));\n    \n    // Delete old tokens and insert new one\n    await db.delete(blingTokens);\n    await db.insert(blingTokens).values({\n      accessToken: encryptToken(tokens.access_token),\n      refreshToken: encryptToken(tokens.refresh_token),\n      expiresAt,\n      tokenType: tokens.token_type || 'Bearer',\n    });\n    \n    console.log(\"[Bling] Tokens saved to database. Expires at:\", expiresAt.toISOString());\n  } catch (error) {\n    console.error(\"[Bling] Failed to save tokens to database:\", error);\n  }\n}\n\nasync function loadTokensFromDb(): Promise<BlingTokensResponse | null> {\n  try {\n    const rows = await db.select().from(blingTokens).orderBy(desc(blingTokens.id)).limit(1);\n    \n    if (rows.length === 0) {\n      console.log(\"[Bling] No tokens found in database\");\n      return null;\n    }\n    \n    const row = rows[0];\n    const accessToken = decryptToken(row.accessToken);\n    const refreshToken = decryptToken(row.refreshToken);\n    const expiresIn = Math.floor((row.expiresAt.getTime() - Date.now()) / 1000);\n    \n    console.log(\"[Bling] Tokens loaded from database. Expires in:\", expiresIn, \"seconds\");\n    \n    return {\n      access_token: accessToken,\n      refresh_token: refreshToken,\n      expires_in: expiresIn > 0 ? expiresIn : 0,\n      token_type: row.tokenType,\n    };\n  } catch (error) {\n    console.error(\"[Bling] Failed to load tokens from database:\", error);\n    return null;\n  }\n}\n\nexport async function initializeBlingTokens(): Promise<boolean> {\n  console.log(\"[Bling] Initializing tokens from database...\");\n  \n  const tokens = await loadTokensFromDb();\n  \n  if (!tokens) {\n    console.log(\"[Bling] No stored tokens found. Authorization required.\");\n    return false;\n  }\n  \n  // Set in memory\n  cachedTokens = tokens;\n  tokenExpiresAt = Date.now() + (tokens.expires_in * 1000) - 120000;\n  \n  // Also set in environment for compatibility\n  process.env.BLING_ACCESS_TOKEN = tokens.access_token;\n  process.env.BLING_REFRESH_TOKEN = tokens.refresh_token;\n  \n  // If token is expired or about to expire, refresh it\n  if (tokens.expires_in < 300) { // Less than 5 minutes\n    console.log(\"[Bling] Token expired or expiring soon, refreshing...\");\n    try {\n      await refreshAccessToken();\n      return true;\n    } catch (error) {\n      console.error(\"[Bling] Failed to refresh token on init:\", error);\n      return false;\n    }\n  }\n  \n  console.log(\"[Bling] Tokens initialized successfully\");\n  return true;\n}\n\nexport async function clearBlingTokens(): Promise<void> {\n  try {\n    await db.delete(blingTokens);\n    cachedTokens = null;\n    tokenExpiresAt = 0;\n    delete process.env.BLING_ACCESS_TOKEN;\n    delete process.env.BLING_REFRESH_TOKEN;\n    console.log(\"[Bling] Tokens cleared from database\");\n  } catch (error) {\n    console.error(\"[Bling] Failed to clear tokens:\", error);\n  }\n}\n\n// ========== SYNC PROGRESS MANAGEMENT ==========\nexport interface SyncProgress {\n  status: 'idle' | 'running' | 'completed' | 'error';\n  phase: string;\n  currentStep: number;\n  totalSteps: number;\n  message: string;\n  created: number;\n  updated: number;\n  errors: number;\n  startTime: number | null;\n  estimatedRemaining: string | null;\n}\n\nlet syncProgress: SyncProgress = {\n  status: 'idle',\n  phase: '',\n  currentStep: 0,\n  totalSteps: 0,\n  message: '',\n  created: 0,\n  updated: 0,\n  errors: 0,\n  startTime: null,\n  estimatedRemaining: null,\n};\n\nconst progressListeners: Set<(progress: SyncProgress) => void> = new Set();\n\nexport function getSyncProgress(): SyncProgress {\n  return { ...syncProgress };\n}\n\nexport function subscribeSyncProgress(callback: (progress: SyncProgress) => void): () => void {\n  progressListeners.add(callback);\n  callback(syncProgress);\n  return () => progressListeners.delete(callback);\n}\n\nfunction updateProgress(updates: Partial<SyncProgress>) {\n  syncProgress = { ...syncProgress, ...updates };\n  \n  if (syncProgress.startTime && syncProgress.currentStep > 0 && syncProgress.totalSteps > 0) {\n    const elapsed = Date.now() - syncProgress.startTime;\n    const avgTimePerStep = elapsed / syncProgress.currentStep;\n    const remaining = avgTimePerStep * (syncProgress.totalSteps - syncProgress.currentStep);\n    \n    if (remaining > 60000) {\n      syncProgress.estimatedRemaining = `${Math.ceil(remaining / 60000)} min`;\n    } else if (remaining > 0) {\n      syncProgress.estimatedRemaining = `${Math.ceil(remaining / 1000)} seg`;\n    } else {\n      syncProgress.estimatedRemaining = null;\n    }\n  }\n  \n  const snapshot = { ...syncProgress };\n  progressListeners.forEach(cb => cb(snapshot));\n}\n\nfunction resetProgress() {\n  syncProgress = {\n    status: 'idle',\n    phase: '',\n    currentStep: 0,\n    totalSteps: 0,\n    message: '',\n    created: 0,\n    updated: 0,\n    errors: 0,\n    startTime: null,\n    estimatedRemaining: null,\n  };\n  progressListeners.forEach(cb => cb(syncProgress));\n}\n\nfunction getBasicAuthHeader(): string {\n  const clientId = process.env.BLING_CLIENT_ID;\n  const clientSecret = process.env.BLING_CLIENT_SECRET;\n  if (!clientId || !clientSecret) {\n    throw new Error(\"BLING_CLIENT_ID and BLING_CLIENT_SECRET are required\");\n  }\n  return Buffer.from(`${clientId}:${clientSecret}`).toString(\"base64\");\n}\n\nexport function getAuthorizationUrl(redirectUri: string): string {\n  const clientId = process.env.BLING_CLIENT_ID;\n  if (!clientId) {\n    throw new Error(\"BLING_CLIENT_ID is required\");\n  }\n  const state = Math.random().toString(36).substring(2);\n  return `${BLING_OAUTH_URL}/authorize?response_type=code&client_id=${clientId}&redirect_uri=${encodeURIComponent(redirectUri)}&state=${state}`;\n}\n\nexport async function exchangeCodeForTokens(code: string, redirectUri: string): Promise<BlingTokensResponse> {\n  const response = await fetch(`${BLING_OAUTH_URL}/token`, {\n    method: \"POST\",\n    headers: {\n      \"Content-Type\": \"application/x-www-form-urlencoded\",\n      \"Authorization\": `Basic ${getBasicAuthHeader()}`,\n    },\n    body: new URLSearchParams({\n      grant_type: \"authorization_code\",\n      code,\n      redirect_uri: redirectUri,\n    }),\n  });\n\n  if (!response.ok) {\n    const error = await response.text();\n    console.error(\"Bling token exchange error:\", error);\n    throw new Error(`Failed to exchange code for tokens: ${response.status}`);\n  }\n\n  const tokens: BlingTokensResponse = await response.json();\n  cachedTokens = tokens;\n  tokenExpiresAt = Date.now() + (tokens.expires_in * 1000) - 60000;\n  \n  process.env.BLING_ACCESS_TOKEN = tokens.access_token;\n  process.env.BLING_REFRESH_TOKEN = tokens.refresh_token;\n  \n  // Save tokens to database for persistence\n  await saveTokensToDb(tokens);\n  \n  return tokens;\n}\n\nexport async function refreshAccessToken(): Promise<BlingTokensResponse> {\n  // Prevent concurrent refresh attempts\n  if (isRefreshing && refreshPromise) {\n    console.log(\"[Bling] Waiting for ongoing token refresh...\");\n    return refreshPromise;\n  }\n  \n  const refreshToken = process.env.BLING_REFRESH_TOKEN;\n  if (!refreshToken) {\n    throw new Error(\"No refresh token available. Please re-authorize.\");\n  }\n\n  isRefreshing = true;\n  \n  refreshPromise = (async () => {\n    try {\n      console.log(\"[Bling] Refreshing access token...\");\n      const response = await fetch(`${BLING_OAUTH_URL}/token`, {\n        method: \"POST\",\n        headers: {\n          \"Content-Type\": \"application/x-www-form-urlencoded\",\n          \"Authorization\": `Basic ${getBasicAuthHeader()}`,\n        },\n        body: new URLSearchParams({\n          grant_type: \"refresh_token\",\n          refresh_token: refreshToken,\n        }),\n      });\n\n      if (!response.ok) {\n        const error = await response.text();\n        console.error(\"[Bling] Token refresh error:\", error);\n        // Clear cached data on refresh failure\n        cachedTokens = null;\n        tokenExpiresAt = 0;\n        throw new Error(`Failed to refresh token: ${response.status}`);\n      }\n\n      const tokens: BlingTokensResponse = await response.json();\n      cachedTokens = tokens;\n      // Set expiration with 2-minute buffer for safety\n      tokenExpiresAt = Date.now() + (tokens.expires_in * 1000) - 120000;\n      \n      process.env.BLING_ACCESS_TOKEN = tokens.access_token;\n      process.env.BLING_REFRESH_TOKEN = tokens.refresh_token;\n      \n      // Save refreshed tokens to database\n      await saveTokensToDb(tokens);\n      \n      console.log(\"[Bling] Token refreshed and saved. Expires at:\", new Date(tokenExpiresAt).toISOString());\n      return tokens;\n    } finally {\n      isRefreshing = false;\n      refreshPromise = null;\n    }\n  })();\n  \n  return refreshPromise;\n}\n\nasync function getValidAccessToken(): Promise<string> {\n  const accessToken = process.env.BLING_ACCESS_TOKEN;\n  \n  if (!accessToken) {\n    throw new Error(\"Not authenticated with Bling. Please authorize first.\");\n  }\n  \n  // Proactive refresh: if token is close to expiring (within 5 minutes), refresh it now\n  const now = Date.now();\n  const fiveMinutes = 5 * 60 * 1000;\n  \n  if (tokenExpiresAt > 0 && (tokenExpiresAt - now) < fiveMinutes) {\n    console.log(\"[Bling] Token expiring soon, proactively refreshing...\");\n    try {\n      const tokens = await refreshAccessToken();\n      return tokens.access_token;\n    } catch (error) {\n      console.error(\"[Bling] Proactive refresh failed, using existing token:\", error);\n      // Fall through to use existing token - it might still work\n    }\n  }\n  \n  return accessToken;\n}\n\nasync function blingApiRequest<T>(endpoint: string): Promise<T> {\n  const accessToken = await getValidAccessToken();\n  \n  const response = await fetch(`${BLING_API_BASE}${endpoint}`, {\n    headers: {\n      \"Authorization\": `Bearer ${accessToken}`,\n      \"Accept\": \"application/json\",\n    },\n  });\n\n  if (response.status === 401) {\n    try {\n      await refreshAccessToken();\n      return blingApiRequest<T>(endpoint);\n    } catch {\n      throw new Error(\"Authentication failed. Please re-authorize with Bling.\");\n    }\n  }\n\n  if (!response.ok) {\n    const error = await response.text();\n    console.error(`Bling API error for ${endpoint}:`, error);\n    throw new Error(`Bling API error: ${response.status}`);\n  }\n\n  return response.json();\n}\n\nasync function blingApiPost<T>(endpoint: string, body: unknown): Promise<T> {\n  const accessToken = await getValidAccessToken();\n  \n  const response = await fetch(`${BLING_API_BASE}${endpoint}`, {\n    method: \"POST\",\n    headers: {\n      \"Authorization\": `Bearer ${accessToken}`,\n      \"Accept\": \"application/json\",\n      \"Content-Type\": \"application/json\",\n    },\n    body: JSON.stringify(body),\n  });\n\n  if (response.status === 401) {\n    try {\n      await refreshAccessToken();\n      return blingApiPost<T>(endpoint, body);\n    } catch {\n      throw new Error(\"Authentication failed. Please re-authorize with Bling.\");\n    }\n  }\n\n  if (!response.ok) {\n    const error = await response.text();\n    console.error(`Bling API POST error for ${endpoint}:`, error);\n    throw new Error(`Bling API error: ${response.status} - ${error}`);\n  }\n\n  return response.json();\n}\n\nexport async function fetchBlingProductsList(page: number = 1, limit: number = 100): Promise<BlingProductBasic[]> {\n  const response = await blingApiRequest<{ data: BlingProductBasic[] }>(\n    `/produtos?pagina=${page}&limite=${limit}&tipo=P&criterio=1`\n  );\n  return response.data || [];\n}\n\nexport async function fetchBlingProductDetails(productId: number, throwOn429: boolean = false): Promise<BlingProductFull | null> {\n  try {\n    const response = await blingApiRequest<{ data: BlingProductFull }>(`/produtos/${productId}`);\n    return response.data || null;\n  } catch (error) {\n    const message = String(error);\n    if (throwOn429 && message.includes(\"429\")) {\n      throw error;\n    }\n    console.error(`Failed to fetch product ${productId}:`, error);\n    return null;\n  }\n}\n\nexport async function fetchBlingCategories(): Promise<BlingCategory[]> {\n  const response = await blingApiRequest<{ data: BlingCategory[] }>(\"/categorias/produtos\");\n  return response.data || [];\n}\n\ninterface BlingStockItem {\n  produto: { id: number };\n  saldoFisicoTotal: number;\n  saldoVirtualTotal: number;\n}\n\ninterface BlingStockResponse {\n  id: number;\n  codigo: string;\n  nome: string;\n  estoqueAtual: number;\n  depositos?: Array<{\n    id: number;\n    nome: string;\n    saldo: number;\n    saldoVirtual: number;\n  }>;\n}\n\ninterface BlingStockListItem {\n  produto: { id: number; codigo?: string };\n  deposito?: { id: number; nome?: string };\n  saldoFisico?: number;\n  saldoVirtual?: number;\n}\n\nexport async function fetchBlingStock(productIds: number[]): Promise<Map<number, number>> {\n  const stockMap = new Map<number, number>();\n  \n  console.log(`[fetchBlingStock] Starting stock fetch using /estoques endpoint`);\n  \n  // Fetch all stock data with pagination\n  let page = 1;\n  const limit = 100;\n  let totalFetched = 0;\n  \n  while (true) {\n    try {\n      const response = await blingApiRequest<{ data: BlingStockListItem[] }>(\n        `/estoques?pagina=${page}&limite=${limit}`\n      );\n      \n      if (!response.data || response.data.length === 0) {\n        console.log(`[fetchBlingStock] No more stock data at page ${page}`);\n        break;\n      }\n      \n      for (const item of response.data) {\n        const productId = item.produto?.id;\n        if (!productId) continue;\n        \n        const stock = item.saldoVirtual ?? item.saldoFisico ?? 0;\n        \n        // Sum stock across all deposits for same product\n        const currentStock = stockMap.get(productId) || 0;\n        stockMap.set(productId, currentStock + Math.floor(stock));\n      }\n      \n      totalFetched += response.data.length;\n      console.log(`[fetchBlingStock] Page ${page}: fetched ${response.data.length} stock entries, total: ${totalFetched}`);\n      \n      if (response.data.length < limit) {\n        break;\n      }\n      \n      page++;\n      \n      // Rate limiting\n      await new Promise(resolve => setTimeout(resolve, 300));\n      \n    } catch (error) {\n      const errorStr = String(error);\n      if (errorStr.includes(\"429\")) {\n        console.log(\"[fetchBlingStock] Rate limit hit, waiting 30 seconds...\");\n        await new Promise(resolve => setTimeout(resolve, 30000));\n        continue;\n      } else if (errorStr.includes(\"404\")) {\n        console.log(\"[fetchBlingStock] Stock endpoint returned 404 - module may not be enabled\");\n        break;\n      } else {\n        console.error(`[fetchBlingStock] Error fetching stock page ${page}:`, error);\n        break;\n      }\n    }\n  }\n  \n  const withStock = Array.from(stockMap.values()).filter(v => v > 0).length;\n  console.log(`[fetchBlingStock] Finished. Products with stock data: ${stockMap.size}, with stock > 0: ${withStock}`);\n  \n  // Log first 5 products with stock for debugging\n  let logged = 0;\n  const entries = Array.from(stockMap.entries());\n  for (const [productId, stock] of entries) {\n    if (stock > 0 && logged < 5) {\n      console.log(`[fetchBlingStock] Product ${productId}: stock=${stock}`);\n      logged++;\n    }\n  }\n  \n  return stockMap;\n}\n\nexport async function syncCategories(): Promise<{ created: number; updated: number }> {\n  const blingCategories = await fetchBlingCategories();\n  let created = 0;\n  let updated = 0;\n\n  const blingIdToLocalId: Record<number, number> = {};\n  const blingCatMap = new Map<number, BlingCategory>();\n  blingCategories.forEach(c => blingCatMap.set(c.id, c));\n\n  function topologicalSort(cats: BlingCategory[]): BlingCategory[] {\n    const sorted: BlingCategory[] = [];\n    const visited = new Set<number>();\n    \n    function visit(cat: BlingCategory) {\n      if (visited.has(cat.id)) return;\n      visited.add(cat.id);\n      \n      const parentBlingId = cat.categoriaPai?.id;\n      if (parentBlingId && blingCatMap.has(parentBlingId)) {\n        visit(blingCatMap.get(parentBlingId)!);\n      }\n      \n      sorted.push(cat);\n    }\n    \n    cats.forEach(c => visit(c));\n    return sorted;\n  }\n\n  const sortedCategories = topologicalSort(blingCategories);\n\n  for (const cat of sortedCategories) {\n    const slug = cat.descricao\n      .toLowerCase()\n      .normalize(\"NFD\")\n      .replace(/[\\u0300-\\u036f]/g, \"\")\n      .replace(/[^a-z0-9]+/g, \"-\")\n      .replace(/(^-|-$)/g, \"\") || `cat-${cat.id}`;\n\n    const parentBlingId = cat.categoriaPai?.id;\n    const parentLocalId = parentBlingId ? blingIdToLocalId[parentBlingId] || null : null;\n\n    let existing = await db.select().from(categories).where(eq(categories.blingId, cat.id)).limit(1);\n    \n    if (existing.length === 0) {\n      existing = await db.select().from(categories).where(eq(categories.slug, slug)).limit(1);\n    }\n\n    if (existing.length === 0) {\n      const [newCat] = await db.insert(categories).values({\n        name: cat.descricao,\n        slug,\n        parentId: parentLocalId,\n        blingId: cat.id,\n      }).returning();\n      blingIdToLocalId[cat.id] = newCat.id;\n      created++;\n    } else {\n      await db.update(categories).set({ \n        name: cat.descricao,\n        slug,\n        parentId: parentLocalId,\n        blingId: cat.id,\n      }).where(eq(categories.id, existing[0].id));\n      blingIdToLocalId[cat.id] = existing[0].id;\n      updated++;\n    }\n  }\n\n  return { created, updated };\n}\n\nasync function runWithConcurrency<T, R>(\n  items: T[],\n  fn: (item: T) => Promise<R>,\n  concurrency: number,\n  onProgress?: (completed: number, total: number) => void\n): Promise<R[]> {\n  const results: R[] = new Array(items.length);\n  let index = 0;\n  let completed = 0;\n\n  async function worker() {\n    while (index < items.length) {\n      const i = index++;\n      try {\n        results[i] = await fn(items[i]);\n      } catch (error) {\n        results[i] = null as R;\n      }\n      completed++;\n      if (onProgress && completed % 50 === 0) {\n        onProgress(completed, items.length);\n      }\n    }\n  }\n\n  await Promise.all(Array(Math.min(concurrency, items.length)).fill(0).map(() => worker()));\n  return results;\n}\n\nasync function fetchProductDetailsWithRetry(productId: number): Promise<BlingProductFull | null> {\n  for (let attempt = 0; attempt < 3; attempt++) {\n    try {\n      const result = await fetchBlingProductDetails(productId, true);\n      return result;\n    } catch (error) {\n      const message = String(error);\n      if (message.includes(\"429\")) {\n        const waitTime = Math.pow(2, attempt) * 5000 + Math.random() * 1000;\n        console.log(`Rate limit on product ${productId}, attempt ${attempt + 1}/3, waiting ${(waitTime/1000).toFixed(1)}s...`);\n        await new Promise(resolve => setTimeout(resolve, waitTime));\n      } else {\n        console.error(`Error fetching product ${productId}:`, message);\n        return null;\n      }\n    }\n  }\n  console.error(`Failed to fetch product ${productId} after 3 retries`);\n  return null;\n}\n\nasync function fetchProductListWithRetry(page: number, limit: number): Promise<BlingProductBasic[]> {\n  for (let attempt = 0; attempt < 5; attempt++) {\n    try {\n      return await fetchBlingProductsList(page, limit);\n    } catch (error) {\n      const message = String(error);\n      if (message.includes(\"429\")) {\n        const waitTime = Math.pow(2, attempt) * 3000 + Math.random() * 2000;\n        console.log(`Rate limit on product list page ${page}, attempt ${attempt + 1}/5, waiting ${(waitTime/1000).toFixed(1)}s...`);\n        await new Promise(resolve => setTimeout(resolve, waitTime));\n      } else {\n        throw error;\n      }\n    }\n  }\n  throw new Error(`Failed to fetch product list page ${page} after 5 retries`);\n}\n\nasync function fetchCategoriesWithRetry(): Promise<BlingCategory[]> {\n  for (let attempt = 0; attempt < 5; attempt++) {\n    try {\n      return await fetchBlingCategories();\n    } catch (error) {\n      const message = String(error);\n      if (message.includes(\"429\")) {\n        const waitTime = Math.pow(2, attempt) * 3000 + Math.random() * 2000;\n        console.log(`Rate limit on categories, attempt ${attempt + 1}/5, waiting ${(waitTime/1000).toFixed(1)}s...`);\n        await new Promise(resolve => setTimeout(resolve, waitTime));\n      } else {\n        throw error;\n      }\n    }\n  }\n  throw new Error(\"Failed to fetch categories after 5 retries\");\n}\n\n// Sync categories from scratch (used when clearing all data first)\nasync function syncCategoriesClean(): Promise<{ created: number }> {\n  const blingCategories = await fetchCategoriesWithRetry();\n  let created = 0;\n\n  const blingIdToLocalId: Record<number, number> = {};\n  const blingCatMap = new Map<number, BlingCategory>();\n  blingCategories.forEach(c => blingCatMap.set(c.id, c));\n\n  // Topological sort to process parents before children (subcategories)\n  function topologicalSort(cats: BlingCategory[]): BlingCategory[] {\n    const sorted: BlingCategory[] = [];\n    const visited = new Set<number>();\n    \n    function visit(cat: BlingCategory) {\n      if (visited.has(cat.id)) return;\n      visited.add(cat.id);\n      \n      const parentBlingId = cat.categoriaPai?.id;\n      if (parentBlingId && blingCatMap.has(parentBlingId)) {\n        visit(blingCatMap.get(parentBlingId)!);\n      }\n      \n      sorted.push(cat);\n    }\n    \n    cats.forEach(c => visit(c));\n    return sorted;\n  }\n\n  const sortedCategories = topologicalSort(blingCategories);\n  console.log(`Importing ${sortedCategories.length} categories (including subcategories)...`);\n\n  for (const cat of sortedCategories) {\n    const slug = cat.descricao\n      .toLowerCase()\n      .normalize(\"NFD\")\n      .replace(/[\\u0300-\\u036f]/g, \"\")\n      .replace(/[^a-z0-9]+/g, \"-\")\n      .replace(/(^-|-$)/g, \"\") || `cat-${cat.id}`;\n\n    const parentBlingId = cat.categoriaPai?.id;\n    const parentLocalId = parentBlingId ? blingIdToLocalId[parentBlingId] || null : null;\n\n    const isSubcategory = !!parentBlingId;\n    console.log(`Creating category: ${cat.descricao} (blingId: ${cat.id})${isSubcategory ? ` - Subcategory of blingId: ${parentBlingId}` : ''}`);\n\n    const [newCat] = await db.insert(categories).values({\n      name: cat.descricao,\n      slug,\n      parentId: parentLocalId,\n      blingId: cat.id,\n    }).returning();\n    \n    blingIdToLocalId[cat.id] = newCat.id;\n    created++;\n  }\n\n  console.log(`Created ${created} categories (including subcategories)`);\n  return { created };\n}\n\nexport async function syncProducts(): Promise<{ created: number; updated: number; errors: string[] }> {\n  if (syncProgress.status === 'running') {\n    throw new Error('Sincronização já em andamento');\n  }\n  \n  const startTime = Date.now();\n  let basicProducts: BlingProductBasic[] = [];\n  let page = 1;\n  const limit = 100;\n  \n  try {\n    updateProgress({\n      status: 'running',\n      phase: 'Sincronizando categorias',\n      currentStep: 0,\n      totalSteps: 100,\n      message: 'Sincronizando categorias do Bling...',\n      created: 0,\n      updated: 0,\n      errors: 0,\n      startTime,\n    });\n    \n    console.log(\"Syncing categories from Bling...\");\n    const catResult = await syncCategories();\n    console.log(`Categories synced: ${catResult.created} created, ${catResult.updated} updated`);\n    \n    updateProgress({\n      phase: 'Buscando lista de produtos',\n      message: `Categorias sincronizadas. Buscando produtos...`,\n    });\n    \n    console.log(\"Fetching product list from Bling (with rate limit handling)...\");\n    while (true) {\n      await new Promise(resolve => setTimeout(resolve, 600));\n      const pageProducts = await fetchProductListWithRetry(page, limit);\n      if (pageProducts.length === 0) break;\n      \n      // Import ALL products (active and inactive, with and without stock)\n      for (const p of pageProducts) {\n        basicProducts.push(p);\n      }\n      updateProgress({ message: `Página ${page}: ${basicProducts.length} produtos encontrados` });\n      console.log(`Page ${page}: ${pageProducts.length} products (${basicProducts.length} total)`);\n      \n      if (pageProducts.length < limit) break;\n      page++;\n    }\n    \n    console.log(`Found ${basicProducts.length} products (all).`);\n    const totalProducts = basicProducts.length;\n    const totalSteps = totalProducts * 2;\n    \n    updateProgress({\n      phase: 'Carregando categorias locais',\n      totalSteps,\n      message: `${totalProducts} produtos encontrados. Carregando categorias...`,\n    });\n\n    const existingCategories = await db.select().from(categories);\n    const categoryMap: Record<string, number> = {};\n    const blingIdToCategoryId: Record<number, number> = {};\n    existingCategories.forEach(c => {\n      categoryMap[c.name.toLowerCase()] = c.id;\n      if (c.blingId) {\n        blingIdToCategoryId[c.blingId] = c.id;\n      }\n    });\n    console.log(`Loaded ${Object.keys(categoryMap).length} local categories with ${Object.keys(blingIdToCategoryId).length} Bling IDs mapped`);\n\n    updateProgress({\n      phase: 'Buscando detalhes dos produtos',\n      message: `Buscando detalhes de ${totalProducts} produtos...`,\n    });\n    \n    console.log(`Fetching product details sequentially (1 req per 600ms = ~1.6 req/s)...`);\n    const productIds = basicProducts.map(p => p.id);\n    let detailsFetched = 0;\n    \n    const blingProducts = await runWithConcurrency(\n      productIds,\n      async (id) => {\n        await new Promise(resolve => setTimeout(resolve, 600));\n        const result = await fetchProductDetailsWithRetry(id);\n        detailsFetched++;\n        if (detailsFetched % 10 === 0 || detailsFetched === totalProducts) {\n          updateProgress({\n            currentStep: detailsFetched,\n            message: `Buscando detalhes: ${detailsFetched}/${totalProducts}`,\n          });\n        }\n        return result;\n      },\n      1,\n      (done, total) => { if (done % 50 === 0) console.log(`Fetched ${done}/${total} product details...`); }\n    );\n    console.log(`Fetched all product details.`);\n\n    // Build stock map from basic product listing first (as fallback)\n    const stockFromListing = new Map<number, number>();\n    for (const bp of basicProducts) {\n      const stock = bp.estoque?.saldoVirtualTotal ?? bp.estoque?.saldoFisicoTotal ?? 0;\n      if (stock > 0) {\n        stockFromListing.set(bp.id, stock);\n      }\n    }\n    console.log(`[import] Stock from listing: ${stockFromListing.size} products with stock > 0`);\n    \n    // Try to fetch from dedicated stock endpoint (may fail if module not enabled)\n    updateProgress({\n      phase: 'Buscando estoque',\n      currentStep: totalProducts,\n      message: 'Buscando estoque dos produtos...',\n    });\n    \n    console.log(`[import] Fetching stock for ${productIds.length} products...`);\n    const stockFromEndpoint = await fetchBlingStock(productIds);\n    const nonZeroFromEndpoint = Array.from(stockFromEndpoint.values()).filter(v => v > 0).length;\n    console.log(`[import] Got stock for ${stockFromEndpoint.size} products. Non-zero: ${nonZeroFromEndpoint}`);\n    \n    // Merge: prefer endpoint stock, fallback to listing stock\n    const stockMap = new Map<number, number>();\n    for (const id of productIds) {\n      const fromEndpoint = stockFromEndpoint.get(id);\n      const fromListing = stockFromListing.get(id);\n      stockMap.set(id, fromEndpoint ?? fromListing ?? 0);\n    }\n    const finalNonZero = Array.from(stockMap.values()).filter(v => v > 0).length;\n    console.log(`[import] Final stock map: ${finalNonZero} products with stock > 0`);\n\n    updateProgress({\n      phase: 'Salvando produtos',\n      message: 'Salvando produtos no banco de dados...',\n    });\n\n    let created = 0;\n    let updated = 0;\n    const errors: string[] = [];\n\n    for (let i = 0; i < productIds.length; i++) {\n      const productId = productIds[i];\n      const blingProduct = blingProducts[i];\n      \n      if (!blingProduct) {\n        errors.push(`Product ${productId}: Failed to fetch details`);\n        updateProgress({ errors: errors.length });\n        continue;\n      }\n\n      try {\n        let categoryId: number | null = null;\n        const blingCat = blingProduct.categoria;\n        if (blingCat && blingCat.id) {\n          categoryId = blingIdToCategoryId[blingCat.id] || null;\n          if (!categoryId && blingCat.descricao) {\n            categoryId = categoryMap[blingCat.descricao.toLowerCase()] || null;\n          }\n          if (!categoryId) {\n            console.log(`Category not found for product ${blingProduct.codigo}: Bling category ID ${blingCat.id}, desc: ${blingCat.descricao}`);\n          }\n        }\n\n        let imageUrl: string | null = null;\n        if (blingProduct.imagens && blingProduct.imagens.length > 0) {\n          const sortedImages = [...blingProduct.imagens].sort((a, b) => (a.ordem || 0) - (b.ordem || 0));\n          imageUrl = sortedImages[0]?.linkExterno || sortedImages[0]?.link || null;\n        }\n        if (!imageUrl && blingProduct.midia?.imagens?.externas?.[0]?.link) {\n          imageUrl = blingProduct.midia.imagens.externas[0].link;\n        }\n        if (!imageUrl && blingProduct.midia?.imagens?.internas?.[0]?.link) {\n          imageUrl = blingProduct.midia.imagens.internas[0].link;\n        }\n\n        const description = blingProduct.descricaoComplementar || blingProduct.descricaoCurta || null;\n        // Get stock from dedicated stock endpoint (stockMap) - more reliable\n        const stock = stockMap.get(productId) ?? blingProduct.estoque?.saldoVirtual ?? blingProduct.estoque?.saldoFisico ?? 0;\n        \n        if (i < 5) {\n          console.log(`Product ${blingProduct.codigo}: image=${imageUrl ? 'YES' : 'NO'}, stock=${stock} (from stockMap: ${stockMap.has(productId)}), category=${categoryId}`);\n        }\n\n        const productData: InsertProduct = {\n          name: blingProduct.nome,\n          sku: blingProduct.codigo || `BLING-${blingProduct.id}`,\n          categoryId,\n          brand: blingProduct.marca || null,\n          description,\n          price: String(blingProduct.preco || 0),\n          stock,\n          image: imageUrl,\n        };\n\n        const existing = await db.select().from(products).where(eq(products.sku, productData.sku)).limit(1);\n\n        if (existing.length === 0) {\n          await db.insert(products).values(productData);\n          created++;\n        } else {\n          await db.update(products)\n            .set({\n              name: productData.name,\n              categoryId: productData.categoryId,\n              brand: productData.brand,\n              description: productData.description,\n              price: productData.price,\n              stock: productData.stock,\n              image: productData.image,\n            })\n            .where(eq(products.sku, productData.sku));\n          updated++;\n        }\n        \n        if ((i + 1) % 10 === 0 || i === productIds.length - 1) {\n          updateProgress({\n            currentStep: totalProducts + i + 1,\n            created,\n            updated,\n            message: `Salvando: ${i + 1}/${totalProducts} (${created} novos, ${updated} atualizados)`,\n          });\n        }\n      } catch (error) {\n        const message = error instanceof Error ? error.message : \"Unknown error\";\n        errors.push(`Product ${productId}: ${message}`);\n        updateProgress({ errors: errors.length });\n      }\n    }\n    \n    const elapsed = ((Date.now() - startTime) / 1000).toFixed(1);\n    console.log(`Sync complete in ${elapsed}s: ${created} created, ${updated} updated, ${errors.length} errors`);\n\n    updateProgress({\n      status: 'completed',\n      phase: 'Concluído',\n      currentStep: totalSteps,\n      message: `Sincronização concluída em ${elapsed}s`,\n      created,\n      updated,\n      errors: errors.length,\n      estimatedRemaining: null,\n    });\n\n    setTimeout(() => resetProgress(), 30000);\n\n    return { created, updated, errors };\n  } catch (error) {\n    const message = error instanceof Error ? error.message : 'Erro desconhecido';\n    updateProgress({\n      status: 'error',\n      phase: 'Erro',\n      message: `Erro: ${message}`,\n    });\n    setTimeout(() => resetProgress(), 10000);\n    throw error;\n  }\n}\n\nexport function isAuthenticated(): boolean {\n  return !!process.env.BLING_ACCESS_TOKEN;\n}\n\nexport function getStatus(): { authenticated: boolean; hasCredentials: boolean } {\n  return {\n    authenticated: isAuthenticated(),\n    hasCredentials: !!(process.env.BLING_CLIENT_ID && process.env.BLING_CLIENT_SECRET),\n  };\n}\n\n// ========== WEBHOOK HANDLING ==========\n\ninterface BlingWebhookPayload {\n  eventId: string;\n  date: string;\n  version: string;\n  event: string;\n  companyId: string;\n  data: any;\n}\n\ninterface WebhookProductData {\n  id: number;\n  nome: string;\n  codigo: string;\n  tipo: string;\n  situacao: string;\n  preco: number;\n  unidade?: string;\n  formato?: string;\n  idProdutoPai?: number;\n  categoria?: { id: number };\n  descricaoCurta?: string;\n  descricaoComplementar?: string;\n}\n\ninterface WebhookStockData {\n  produto: { id: number };\n  deposito?: { id: number; saldoFisico: number; saldoVirtual: number };\n  operacao?: string;\n  quantidade?: number;\n  saldoFisicoTotal: number;\n  saldoVirtualTotal: number;\n}\n\nexport function verifyWebhookSignature(payload: string, signature: string): boolean {\n  const clientSecret = process.env.BLING_CLIENT_SECRET;\n  if (!clientSecret) {\n    console.error(\"BLING_CLIENT_SECRET not configured for webhook verification\");\n    return false;\n  }\n\n  const expectedSignature = crypto\n    .createHmac(\"sha256\", clientSecret)\n    .update(payload, \"utf8\")\n    .digest(\"hex\");\n\n  // Handle both formats: \"sha256=HASH\" or just \"HASH\"\n  const providedHash = signature.replace(/^sha256=/i, \"\");\n  \n  // Ensure both signatures have same length before comparing\n  if (expectedSignature.length !== providedHash.length) {\n    console.error(\"Signature length mismatch\");\n    return false;\n  }\n  \n  try {\n    return crypto.timingSafeEqual(\n      Buffer.from(expectedSignature, \"hex\"),\n      Buffer.from(providedHash, \"hex\")\n    );\n  } catch (error) {\n    console.error(\"Signature comparison error:\", error);\n    return false;\n  }\n}\n\nexport async function handleWebhook(payload: BlingWebhookPayload): Promise<{ success: boolean; message: string }> {\n  const { event, data, eventId } = payload;\n  console.log(`Processing Bling webhook: ${event} (${eventId})`);\n\n  try {\n    switch (event) {\n      case \"product.created\":\n      case \"product.updated\":\n        return await handleProductEvent(data as WebhookProductData);\n      case \"product.deleted\":\n        return await handleProductDeleted(data.id);\n      case \"stock.created\":\n      case \"stock.updated\":\n        return await handleStockEvent(data as WebhookStockData);\n      default:\n        console.log(`Unhandled webhook event: ${event}`);\n        return { success: true, message: `Event ${event} acknowledged but not processed` };\n    }\n  } catch (error) {\n    const message = error instanceof Error ? error.message : \"Unknown error\";\n    console.error(`Webhook processing error for ${event}:`, message);\n    return { success: false, message };\n  }\n}\n\nasync function handleProductEvent(data: WebhookProductData): Promise<{ success: boolean; message: string }> {\n  const sku = data.codigo || `BLING-${data.id}`;\n  \n  if (data.situacao !== \"A\") {\n    const existing = await db.select().from(products).where(eq(products.sku, sku)).limit(1);\n    if (existing.length > 0) {\n      await db.delete(products).where(eq(products.sku, sku));\n      return { success: true, message: `Product ${sku} deleted (inactive)` };\n    }\n    return { success: true, message: `Inactive product ${sku} ignored` };\n  }\n\n  // Fetch full product details from Bling API to get image and category\n  console.log(`Fetching full details for product ${data.id}...`);\n  const fullProduct = await fetchBlingProductDetails(data.id);\n  \n  if (!fullProduct) {\n    // Fallback to basic webhook data if API call fails\n    console.log(`Using fallback webhook data for product ${data.id}`);\n    \n    // Try to get category from webhook data\n    let categoryId: number | null = null;\n    if (data.categoria?.id) {\n      const existingCategories = await db.select().from(categories);\n      const matchingCategory = existingCategories.find(c => c.blingId === data.categoria?.id);\n      if (matchingCategory) {\n        categoryId = matchingCategory.id;\n        console.log(`Found category ${matchingCategory.name} (blingId: ${data.categoria.id}) for product ${sku}`);\n      } else {\n        console.log(`No matching category found for blingId ${data.categoria.id}`);\n      }\n    }\n    \n    const productData: Partial<InsertProduct> = {\n      name: data.nome,\n      sku,\n      categoryId,\n      description: data.descricaoCurta || data.descricaoComplementar || null,\n      price: String(data.preco || 0),\n    };\n\n    const existing = await db.select().from(products).where(eq(products.sku, sku)).limit(1);\n    if (existing.length === 0) {\n      await db.insert(products).values(productData as InsertProduct);\n      return { success: true, message: `Product ${sku} created (webhook data, categoryId: ${categoryId})` };\n    } else {\n      await db.update(products).set(productData).where(eq(products.sku, sku));\n      return { success: true, message: `Product ${sku} updated (webhook data, categoryId: ${categoryId})` };\n    }\n  }\n\n  // Debug: log what Bling API returned for images and stock\n  console.log(`Product ${sku} API response:`, {\n    imagens: fullProduct.imagens,\n    midia: fullProduct.midia,\n    estoque: fullProduct.estoque,\n  });\n\n  // Extract image URL\n  let imageUrl: string | null = null;\n  if (fullProduct.imagens && fullProduct.imagens.length > 0) {\n    const sortedImages = [...fullProduct.imagens].sort((a, b) => (a.ordem || 0) - (b.ordem || 0));\n    imageUrl = sortedImages[0]?.linkExterno || sortedImages[0]?.link || null;\n  }\n  if (!imageUrl && fullProduct.midia?.imagens?.externas?.[0]?.link) {\n    imageUrl = fullProduct.midia.imagens.externas[0].link;\n  }\n  if (!imageUrl && fullProduct.midia?.imagens?.internas?.[0]?.link) {\n    imageUrl = fullProduct.midia.imagens.internas[0].link;\n  }\n  \n  console.log(`Product ${sku} extracted imageUrl:`, imageUrl);\n\n  // Find category by blingId\n  let categoryId: number | null = null;\n  if (fullProduct.categoria?.id) {\n    const existingCategories = await db.select().from(categories);\n    const matchingCategory = existingCategories.find(c => c.blingId === fullProduct.categoria?.id);\n    if (matchingCategory) {\n      categoryId = matchingCategory.id;\n    }\n  }\n\n  const productData: InsertProduct = {\n    name: fullProduct.nome,\n    sku,\n    categoryId,\n    brand: fullProduct.marca || null,\n    description: fullProduct.descricaoComplementar || fullProduct.descricaoCurta || null,\n    price: String(fullProduct.preco || 0),\n    stock: fullProduct.estoque?.saldoVirtual ?? fullProduct.estoque?.saldoFisico ?? 0,\n    image: imageUrl,\n  };\n\n  const existing = await db.select().from(products).where(eq(products.sku, sku)).limit(1);\n\n  if (existing.length === 0) {\n    await db.insert(products).values(productData);\n    return { success: true, message: `Product ${sku} created with full details` };\n  } else {\n    await db.update(products).set({\n      name: productData.name,\n      categoryId: productData.categoryId,\n      brand: productData.brand,\n      description: productData.description,\n      price: productData.price,\n      stock: productData.stock,\n      image: productData.image,\n    }).where(eq(products.sku, sku));\n    return { success: true, message: `Product ${sku} updated with full details` };\n  }\n}\n\nasync function handleProductDeleted(blingId: number): Promise<{ success: boolean; message: string }> {\n  const sku = `BLING-${blingId}`;\n  const existing = await db.select().from(products).where(eq(products.sku, sku)).limit(1);\n  \n  if (existing.length > 0) {\n    await db.delete(products).where(eq(products.sku, sku));\n    return { success: true, message: `Product ${sku} deleted` };\n  }\n  \n  return { success: true, message: `Product ${blingId} not found locally` };\n}\n\nasync function handleStockEvent(data: WebhookStockData): Promise<{ success: boolean; message: string }> {\n  const blingProductId = data.produto.id;\n  const newStock = data.saldoVirtualTotal;\n\n  const allProducts = await db.select().from(products);\n  const product = allProducts.find(p => p.sku === `BLING-${blingProductId}` || p.sku.includes(String(blingProductId)));\n\n  if (product) {\n    await db.update(products).set({ stock: Math.floor(newStock) }).where(eq(products.id, product.id));\n    return { success: true, message: `Stock updated for product ${product.sku}: ${newStock}` };\n  }\n\n  return { success: true, message: `Product ${blingProductId} not found for stock update` };\n}\n\n// ========== ORDER CREATION ==========\n\nexport interface BlingOrderItem {\n  codigo: string;\n  descricao: string;\n  quantidade: number;\n  valorUnidade: number;\n}\n\nexport interface BlingOrderData {\n  orderNumber: string;\n  customerCpfCnpj?: string;\n  customerName?: string;\n  items: BlingOrderItem[];\n  frete?: number;\n  desconto?: number;\n  observacoes?: string;\n}\n\ninterface BlingOrderResponse {\n  data: {\n    id: number;\n    numero?: string;\n  };\n}\n\nexport async function createBlingOrder(orderData: BlingOrderData): Promise<{ success: boolean; blingId?: number; error?: string }> {\n  try {\n    const accessToken = process.env.BLING_ACCESS_TOKEN;\n    if (!accessToken) {\n      console.log(\"Bling not configured - skipping order sync\");\n      return { success: false, error: \"Bling not configured\" };\n    }\n\n    const today = new Date().toISOString().split('T')[0];\n\n    const blingPayload: any = {\n      data: today,\n      dataPrevista: today,\n      numeroLoja: orderData.orderNumber,\n      observacoes: orderData.observacoes || `Pedido #${orderData.orderNumber} do site`,\n      itens: orderData.items.map(item => ({\n        codigo: item.codigo,\n        descricao: item.descricao,\n        quantidade: item.quantidade,\n        valorUnidade: item.valorUnidade,\n      })),\n    };\n\n    if (orderData.customerCpfCnpj) {\n      const cleanDoc = orderData.customerCpfCnpj.replace(/\\D/g, '');\n      blingPayload.contato = {\n        tipoPessoa: cleanDoc.length > 11 ? \"J\" : \"F\",\n        cpfCnpj: cleanDoc,\n        nome: orderData.customerName || \"Cliente\",\n      };\n    }\n\n    if (orderData.frete && orderData.frete > 0) {\n      blingPayload.transporte = {\n        valorFrete: orderData.frete,\n      };\n    }\n\n    if (orderData.desconto && orderData.desconto > 0) {\n      blingPayload.desconto = {\n        valor: orderData.desconto,\n        unidade: \"REAL\",\n      };\n    }\n\n    console.log(\"Sending order to Bling:\", JSON.stringify(blingPayload, null, 2));\n\n    const response = await blingApiPost<BlingOrderResponse>(\"/pedidos/vendas\", blingPayload);\n    \n    console.log(\"Bling order created successfully:\", response.data.id);\n    return { success: true, blingId: response.data.id };\n  } catch (error) {\n    const message = error instanceof Error ? error.message : \"Unknown error\";\n    console.error(\"Failed to create Bling order:\", message);\n    return { success: false, error: message };\n  }\n}\n","path":null,"size_bytes":45724,"size_tokens":null},"client/src/pages/register.tsx":{"content":"import { useState, useMemo } from \"react\";\nimport { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { z } from \"zod\";\nimport { useMutation } from \"@tanstack/react-query\";\nimport { useLocation } from \"wouter\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription } from \"@/components/ui/card\";\n\nfunction generateMathCaptcha() {\n  const num1 = Math.floor(Math.random() * 10) + 1;\n  const num2 = Math.floor(Math.random() * 10) + 1;\n  return { num1, num2, answer: num1 + num2 };\n}\nimport {\n  Form,\n  FormControl,\n  FormField,\n  FormItem,\n  FormLabel,\n  FormMessage,\n} from \"@/components/ui/form\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport { RadioGroup, RadioGroupItem } from \"@/components/ui/radio-group\";\nimport { Alert, AlertDescription } from \"@/components/ui/alert\";\nimport { Store, ArrowRight, ArrowLeft, Loader2, CheckCircle, Zap } from \"lucide-react\";\nimport { apiRequest } from \"@/lib/queryClient\";\n\nconst BRAZILIAN_STATES = [\n  { value: \"AC\", label: \"Acre\" },\n  { value: \"AL\", label: \"Alagoas\" },\n  { value: \"AP\", label: \"Amapa\" },\n  { value: \"AM\", label: \"Amazonas\" },\n  { value: \"BA\", label: \"Bahia\" },\n  { value: \"CE\", label: \"Ceara\" },\n  { value: \"DF\", label: \"Distrito Federal\" },\n  { value: \"ES\", label: \"Espirito Santo\" },\n  { value: \"GO\", label: \"Goias\" },\n  { value: \"MA\", label: \"Maranhao\" },\n  { value: \"MT\", label: \"Mato Grosso\" },\n  { value: \"MS\", label: \"Mato Grosso do Sul\" },\n  { value: \"MG\", label: \"Minas Gerais\" },\n  { value: \"PA\", label: \"Para\" },\n  { value: \"PB\", label: \"Paraiba\" },\n  { value: \"PR\", label: \"Parana\" },\n  { value: \"PE\", label: \"Pernambuco\" },\n  { value: \"PI\", label: \"Piaui\" },\n  { value: \"RJ\", label: \"Rio de Janeiro\" },\n  { value: \"RN\", label: \"Rio Grande do Norte\" },\n  { value: \"RS\", label: \"Rio Grande do Sul\" },\n  { value: \"RO\", label: \"Rondonia\" },\n  { value: \"RR\", label: \"Roraima\" },\n  { value: \"SC\", label: \"Santa Catarina\" },\n  { value: \"SP\", label: \"Sao Paulo\" },\n  { value: \"SE\", label: \"Sergipe\" },\n  { value: \"TO\", label: \"Tocantins\" },\n];\n\nfunction validateCPF(cpf: string): boolean {\n  const cleanCpf = cpf.replace(/\\D/g, \"\");\n  if (cleanCpf.length !== 11) return false;\n  if (/^(\\d)\\1{10}$/.test(cleanCpf)) return false;\n  \n  let sum = 0;\n  for (let i = 0; i < 9; i++) {\n    sum += parseInt(cleanCpf[i]) * (10 - i);\n  }\n  let remainder = (sum * 10) % 11;\n  if (remainder === 10 || remainder === 11) remainder = 0;\n  if (remainder !== parseInt(cleanCpf[9])) return false;\n  \n  sum = 0;\n  for (let i = 0; i < 10; i++) {\n    sum += parseInt(cleanCpf[i]) * (11 - i);\n  }\n  remainder = (sum * 10) % 11;\n  if (remainder === 10 || remainder === 11) remainder = 0;\n  if (remainder !== parseInt(cleanCpf[10])) return false;\n  \n  return true;\n}\n\nfunction validateCNPJ(cnpj: string): boolean {\n  const cleanCnpj = cnpj.replace(/\\D/g, \"\");\n  if (cleanCnpj.length !== 14) return false;\n  if (/^(\\d)\\1{13}$/.test(cleanCnpj)) return false;\n  \n  const weights1 = [5, 4, 3, 2, 9, 8, 7, 6, 5, 4, 3, 2];\n  const weights2 = [6, 5, 4, 3, 2, 9, 8, 7, 6, 5, 4, 3, 2];\n  \n  let sum = 0;\n  for (let i = 0; i < 12; i++) {\n    sum += parseInt(cleanCnpj[i]) * weights1[i];\n  }\n  let remainder = sum % 11;\n  const digit1 = remainder < 2 ? 0 : 11 - remainder;\n  if (digit1 !== parseInt(cleanCnpj[12])) return false;\n  \n  sum = 0;\n  for (let i = 0; i < 13; i++) {\n    sum += parseInt(cleanCnpj[i]) * weights2[i];\n  }\n  remainder = sum % 11;\n  const digit2 = remainder < 2 ? 0 : 11 - remainder;\n  if (digit2 !== parseInt(cleanCnpj[13])) return false;\n  \n  return true;\n}\n\n// Quick registration schema for retail (pessoa fisica) - simplified!\nconst retailQuickSchema = z.object({\n  personType: z.literal(\"fisica\"),\n  cpf: z.string().refine((val) => validateCPF(val), { message: \"CPF invalido\" }),\n  email: z.string().email(\"E-mail invalido\"),\n  firstName: z.string().min(2, \"Nome obrigatorio\"),\n  phone: z.string().min(10, \"Telefone com DDD obrigatorio\"),\n  password: z.string().min(6, \"Senha deve ter pelo menos 6 caracteres\"),\n  confirmPassword: z.string().min(1, \"Confirme a senha\"),\n}).refine((data) => data.password === data.confirmPassword, {\n  message: \"As senhas nao coincidem\",\n  path: [\"confirmPassword\"],\n});\n\ntype RetailQuickData = z.infer<typeof retailQuickSchema>;\n\n// Full registration schema for wholesale (pessoa juridica)\nconst step1Schema = z.object({\n  personType: z.enum([\"juridica\", \"fisica\"]),\n  cnpj: z.string().optional(),\n  cpf: z.string().optional(),\n  email: z.string().email(\"E-mail invalido\"),\n}).superRefine((data, ctx) => {\n  if (data.personType === \"juridica\") {\n    const cleanCnpj = (data.cnpj || \"\").replace(/\\D/g, \"\");\n    if (!cleanCnpj || cleanCnpj.length < 14) {\n      ctx.addIssue({\n        code: z.ZodIssueCode.custom,\n        message: \"CNPJ obrigatorio\",\n        path: [\"cnpj\"],\n      });\n    } else if (!validateCNPJ(data.cnpj || \"\")) {\n      ctx.addIssue({\n        code: z.ZodIssueCode.custom,\n        message: \"CNPJ invalido\",\n        path: [\"cnpj\"],\n      });\n    }\n  } else {\n    const cleanCpf = (data.cpf || \"\").replace(/\\D/g, \"\");\n    if (!cleanCpf || cleanCpf.length < 11) {\n      ctx.addIssue({\n        code: z.ZodIssueCode.custom,\n        message: \"CPF obrigatorio\",\n        path: [\"cpf\"],\n      });\n    } else if (!validateCPF(data.cpf || \"\")) {\n      ctx.addIssue({\n        code: z.ZodIssueCode.custom,\n        message: \"CPF invalido\",\n        path: [\"cpf\"],\n      });\n    }\n  }\n});\n\nconst step2Schema = z.object({\n  firstName: z.string().min(2, \"Nome obrigatorio\"),\n  phone: z.string().min(10, \"Telefone com DDD obrigatorio\"),\n  password: z.string().min(6, \"Senha deve ter pelo menos 6 caracteres\"),\n  confirmPassword: z.string().min(1, \"Confirme a senha\"),\n  cep: z.string().min(8, \"CEP obrigatorio\"),\n  address: z.string().min(3, \"Endereco obrigatorio\"),\n  addressNumber: z.string().min(1, \"Numero obrigatorio\"),\n  complement: z.string().optional(),\n  neighborhood: z.string().min(2, \"Bairro obrigatorio\"),\n  city: z.string().min(2, \"Cidade obrigatoria\"),\n  state: z.string().min(2, \"Estado obrigatorio\"),\n  company: z.string().optional(),\n  tradingName: z.string().optional(),\n  stateRegistration: z.string().optional(),\n}).refine((data) => data.password === data.confirmPassword, {\n  message: \"As senhas nao coincidem\",\n  path: [\"confirmPassword\"],\n});\n\ntype Step1Data = z.infer<typeof step1Schema>;\ntype Step2Data = z.infer<typeof step2Schema>;\n\nexport default function RegisterPage() {\n  const [, setLocation] = useLocation();\n  const [registrationType, setRegistrationType] = useState<\"retail\" | \"wholesale\" | null>(null);\n  const [step, setStep] = useState(1);\n  const [step1Data, setStep1Data] = useState<Step1Data | null>(null);\n  const [success, setSuccess] = useState(false);\n  const [isAutoApproved, setIsAutoApproved] = useState(false);\n  const [error, setError] = useState<string | null>(null);\n  const [captchaAnswer, setCaptchaAnswer] = useState(\"\");\n  const [honeypot, setHoneypot] = useState(\"\");\n  \n  const captcha = useMemo(() => generateMathCaptcha(), []);\n\n  // Quick retail form\n  const retailForm = useForm<RetailQuickData>({\n    resolver: zodResolver(retailQuickSchema),\n    defaultValues: {\n      personType: \"fisica\",\n      cpf: \"\",\n      email: \"\",\n      firstName: \"\",\n      phone: \"\",\n      password: \"\",\n      confirmPassword: \"\",\n    },\n  });\n\n  const form1 = useForm<Step1Data>({\n    resolver: zodResolver(step1Schema),\n    defaultValues: {\n      personType: \"juridica\",\n      cnpj: \"\",\n      cpf: \"\",\n      email: \"\",\n    },\n  });\n\n  const form2 = useForm<Step2Data>({\n    resolver: zodResolver(step2Schema),\n    defaultValues: {\n      firstName: \"\",\n      phone: \"\",\n      password: \"\",\n      confirmPassword: \"\",\n      cep: \"\",\n      address: \"\",\n      addressNumber: \"\",\n      complement: \"\",\n      neighborhood: \"\",\n      city: \"\",\n      state: \"\",\n      company: \"\",\n      tradingName: \"\",\n      stateRegistration: \"\",\n    },\n  });\n\n  const registerMutation = useMutation({\n    mutationFn: async (data: any) => {\n      const response = await apiRequest(\"POST\", \"/api/register\", data);\n      return response.json();\n    },\n    onSuccess: (data: { message: string; userId: string; approved: boolean }) => {\n      setSuccess(true);\n      setIsAutoApproved(data.approved);\n      \n      if (data.approved) {\n        const urlParams = new URLSearchParams(window.location.search);\n        const redirectTo = urlParams.get('redirect');\n        const stepParam = urlParams.get('step');\n        \n        if (redirectTo) {\n          const loginUrl = stepParam \n            ? `/login?redirect=${encodeURIComponent(redirectTo)}&step=${stepParam}&registered=true`\n            : `/login?redirect=${encodeURIComponent(redirectTo)}&registered=true`;\n          setTimeout(() => setLocation(loginUrl), 2000);\n        }\n      }\n    },\n    onError: (err: Error) => {\n      setError(err.message || \"Erro ao criar cadastro\");\n    },\n  });\n\n  // Handle quick retail registration\n  const handleRetailSubmit = (data: RetailQuickData) => {\n    if (honeypot) {\n      setError(\"Verificacao de seguranca falhou\");\n      return;\n    }\n    \n    if (parseInt(captchaAnswer) !== captcha.answer) {\n      setError(\"Resposta da verificacao incorreta. Tente novamente.\");\n      return;\n    }\n    \n    setError(null);\n    registerMutation.mutate(data);\n  };\n\n  const handleStep1Submit = (data: Step1Data) => {\n    setStep1Data(data);\n    setStep(2);\n  };\n\n  const handleStep2Submit = (data: Step2Data) => {\n    if (!step1Data) return;\n    \n    if (honeypot) {\n      setError(\"Verificacao de seguranca falhou\");\n      return;\n    }\n    \n    if (parseInt(captchaAnswer) !== captcha.answer) {\n      setError(\"Resposta da verificacao incorreta. Tente novamente.\");\n      return;\n    }\n    \n    setError(null);\n    registerMutation.mutate({ ...step1Data, ...data });\n  };\n\n  const fetchCep = async (cep: string) => {\n    const cleanCep = cep.replace(/\\D/g, \"\");\n    if (cleanCep.length !== 8) return;\n    \n    try {\n      const response = await fetch(`https://viacep.com.br/ws/${cleanCep}/json/`);\n      const data = await response.json();\n      if (!data.erro) {\n        form2.setValue(\"address\", data.logradouro || \"\");\n        form2.setValue(\"neighborhood\", data.bairro || \"\");\n        form2.setValue(\"city\", data.localidade || \"\");\n        form2.setValue(\"state\", data.uf || \"\");\n      }\n    } catch {\n      // Silently fail CEP lookup\n    }\n  };\n\n  const personType = form1.watch(\"personType\");\n\n  if (success) {\n    const urlParams = new URLSearchParams(window.location.search);\n    const hasCheckoutRedirect = urlParams.get('redirect')?.includes('/checkout');\n    \n    return (\n      <div className=\"min-h-screen bg-background flex items-center justify-center p-4\">\n        <Card className=\"w-full max-w-md text-center\">\n          <CardHeader>\n            <div className=\"mx-auto mb-4 p-4 bg-green-100 dark:bg-green-900/30 rounded-full w-fit\">\n              <CheckCircle className=\"h-12 w-12 text-green-600 dark:text-green-400\" />\n            </div>\n            <CardTitle className=\"text-2xl\">\n              {isAutoApproved ? \"Cadastro Aprovado!\" : \"Cadastro Enviado!\"}\n            </CardTitle>\n            <CardDescription className=\"text-base mt-2\">\n              {isAutoApproved ? (\n                hasCheckoutRedirect ? (\n                  \"Seu cadastro foi aprovado automaticamente! Voce sera redirecionado para fazer login e finalizar sua compra...\"\n                ) : (\n                  \"Seu cadastro foi aprovado automaticamente! Voce ja pode fazer login.\"\n                )\n              ) : (\n                \"Sua solicitacao de acesso foi enviada com sucesso. Nossa equipe ira analisar seu cadastro e voce recebera uma confirmacao por e-mail em breve.\"\n              )}\n            </CardDescription>\n          </CardHeader>\n          <CardContent className=\"space-y-3\">\n            {isAutoApproved ? (\n              <Button \n                onClick={() => {\n                  const redirect = urlParams.get('redirect');\n                  const stepParam = urlParams.get('step');\n                  if (redirect) {\n                    const loginUrl = stepParam \n                      ? `/login?redirect=${encodeURIComponent(redirect)}&step=${stepParam}`\n                      : `/login?redirect=${encodeURIComponent(redirect)}`;\n                    setLocation(loginUrl);\n                  } else {\n                    setLocation(\"/login\");\n                  }\n                }} \n                className=\"gap-2 bg-orange-500 hover:bg-orange-600\" \n                data-testid=\"button-go-login\"\n              >\n                <ArrowRight className=\"h-4 w-4\" />\n                Fazer Login\n              </Button>\n            ) : (\n              <Button onClick={() => setLocation(\"/\")} className=\"gap-2\" data-testid=\"button-back-home\">\n                <ArrowLeft className=\"h-4 w-4\" />\n                Voltar para Inicio\n              </Button>\n            )}\n          </CardContent>\n        </Card>\n      </div>\n    );\n  }\n\n  // Selection screen - choose between retail and wholesale\n  if (registrationType === null) {\n    return (\n      <div className=\"min-h-screen bg-background\">\n        <div className=\"container mx-auto px-4 py-8\">\n          <div className=\"max-w-lg mx-auto\">\n            <div className=\"text-center mb-8\">\n              <div className=\"w-20 h-20 rounded-full bg-primary/10 flex items-center justify-center mx-auto mb-4\">\n                <Store className=\"h-10 w-10 text-primary\" />\n              </div>\n              <h1 className=\"text-xl font-bold mb-1\">LOJAMADRUGADAO</h1>\n              <p className=\"text-muted-foreground text-sm\">11 99284-5596</p>\n            </div>\n\n            <Card>\n              <CardHeader className=\"text-center\">\n                <CardTitle>Como voce quer comprar?</CardTitle>\n                <CardDescription>\n                  Escolha o tipo de cadastro\n                </CardDescription>\n              </CardHeader>\n              <CardContent className=\"space-y-4\">\n                <Card \n                  className=\"hover-elevate cursor-pointer border-orange-500/50\"\n                  onClick={() => setRegistrationType(\"retail\")}\n                  data-testid=\"card-retail\"\n                >\n                  <CardContent className=\"pt-6\">\n                    <div className=\"flex items-center gap-4\">\n                      <div className=\"p-3 rounded-full bg-orange-500/10\">\n                        <Zap className=\"h-8 w-8 text-orange-500\" />\n                      </div>\n                      <div className=\"flex-1\">\n                        <h3 className=\"font-bold text-lg\">Varejo (Pessoa Fisica)</h3>\n                        <p className=\"text-sm text-muted-foreground\">\n                          Cadastro rapido - aprovacao automatica\n                        </p>\n                        <div className=\"flex items-center gap-2 mt-2\">\n                          <span className=\"text-xs bg-green-500/20 text-green-600 dark:text-green-400 px-2 py-1 rounded-full\">\n                            Compre ja!\n                          </span>\n                        </div>\n                      </div>\n                      <ArrowRight className=\"h-5 w-5 text-muted-foreground\" />\n                    </div>\n                  </CardContent>\n                </Card>\n\n                <Card \n                  className=\"hover-elevate cursor-pointer\"\n                  onClick={() => setRegistrationType(\"wholesale\")}\n                  data-testid=\"card-wholesale\"\n                >\n                  <CardContent className=\"pt-6\">\n                    <div className=\"flex items-center gap-4\">\n                      <div className=\"p-3 rounded-full bg-primary/10\">\n                        <Store className=\"h-8 w-8 text-primary\" />\n                      </div>\n                      <div className=\"flex-1\">\n                        <h3 className=\"font-bold text-lg\">Atacado (Pessoa Juridica)</h3>\n                        <p className=\"text-sm text-muted-foreground\">\n                          Cadastro completo com CNPJ\n                        </p>\n                        <div className=\"flex items-center gap-2 mt-2\">\n                          <span className=\"text-xs bg-muted text-muted-foreground px-2 py-1 rounded-full\">\n                            Precos especiais\n                          </span>\n                        </div>\n                      </div>\n                      <ArrowRight className=\"h-5 w-5 text-muted-foreground\" />\n                    </div>\n                  </CardContent>\n                </Card>\n\n                <div className=\"text-center pt-4\">\n                  <Button variant=\"ghost\" onClick={() => setLocation(\"/login\")} data-testid=\"link-login\">\n                    Ja tenho cadastro? Entrar\n                  </Button>\n                </div>\n              </CardContent>\n            </Card>\n          </div>\n        </div>\n      </div>\n    );\n  }\n\n  // Quick retail registration form\n  if (registrationType === \"retail\") {\n    return (\n      <div className=\"min-h-screen bg-background\">\n        <div className=\"container mx-auto px-4 py-8\">\n          <div className=\"max-w-lg mx-auto\">\n            <div className=\"text-center mb-8\">\n              <div className=\"w-20 h-20 rounded-full bg-orange-500/10 flex items-center justify-center mx-auto mb-4\">\n                <Zap className=\"h-10 w-10 text-orange-500\" />\n              </div>\n              <h1 className=\"text-xl font-bold mb-1\">Cadastro Rapido</h1>\n              <p className=\"text-muted-foreground text-sm\">Pessoa Fisica - Varejo</p>\n            </div>\n\n            <Card>\n              <CardHeader className=\"text-center\">\n                <CardTitle className=\"flex items-center justify-center gap-2\">\n                  <Zap className=\"h-5 w-5 text-orange-500\" />\n                  Cadastro Expresso\n                </CardTitle>\n                <CardDescription>\n                  Preencha apenas o essencial e comece a comprar\n                </CardDescription>\n              </CardHeader>\n              <CardContent>\n                {error && (\n                  <Alert variant=\"destructive\" className=\"mb-4\">\n                    <AlertDescription>{error}</AlertDescription>\n                  </Alert>\n                )}\n\n                <Form {...retailForm}>\n                  <form onSubmit={retailForm.handleSubmit(handleRetailSubmit)} className=\"space-y-4\">\n                    <FormField\n                      control={retailForm.control}\n                      name=\"cpf\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>CPF *</FormLabel>\n                          <FormControl>\n                            <Input \n                              placeholder=\"000.000.000-00\" \n                              {...field}\n                              data-testid=\"input-cpf\"\n                            />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n\n                    <FormField\n                      control={retailForm.control}\n                      name=\"email\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>E-mail *</FormLabel>\n                          <FormControl>\n                            <Input \n                              type=\"email\" \n                              placeholder=\"seu@email.com\" \n                              {...field}\n                              data-testid=\"input-email\"\n                            />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n\n                    <FormField\n                      control={retailForm.control}\n                      name=\"firstName\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Seu nome *</FormLabel>\n                          <FormControl>\n                            <Input {...field} data-testid=\"input-name\" />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n\n                    <FormField\n                      control={retailForm.control}\n                      name=\"phone\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Telefone/WhatsApp *</FormLabel>\n                          <FormControl>\n                            <Input \n                              placeholder=\"(11) 99999-9999\" \n                              {...field}\n                              data-testid=\"input-phone\"\n                            />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n\n                    <div className=\"grid grid-cols-2 gap-4\">\n                      <FormField\n                        control={retailForm.control}\n                        name=\"password\"\n                        render={({ field }) => (\n                          <FormItem>\n                            <FormLabel>Senha *</FormLabel>\n                            <FormControl>\n                              <Input type=\"password\" {...field} data-testid=\"input-password\" />\n                            </FormControl>\n                            <FormMessage />\n                          </FormItem>\n                        )}\n                      />\n\n                      <FormField\n                        control={retailForm.control}\n                        name=\"confirmPassword\"\n                        render={({ field }) => (\n                          <FormItem>\n                            <FormLabel>Confirmar *</FormLabel>\n                            <FormControl>\n                              <Input type=\"password\" {...field} data-testid=\"input-confirm-password\" />\n                            </FormControl>\n                            <FormMessage />\n                          </FormItem>\n                        )}\n                      />\n                    </div>\n\n                    {/* Honeypot field - hidden from users */}\n                    <div className=\"absolute -left-[9999px]\" aria-hidden=\"true\">\n                      <input\n                        type=\"text\"\n                        name=\"website\"\n                        tabIndex={-1}\n                        autoComplete=\"off\"\n                        value={honeypot}\n                        onChange={(e) => setHoneypot(e.target.value)}\n                      />\n                    </div>\n\n                    {/* Simple math captcha */}\n                    <div className=\"p-3 rounded-lg bg-muted/50\">\n                      <label className=\"text-sm font-medium\">\n                        Verificacao: Quanto e {captcha.num1} + {captcha.num2}? *\n                      </label>\n                      <Input\n                        type=\"number\"\n                        placeholder=\"Resposta\"\n                        value={captchaAnswer}\n                        onChange={(e) => setCaptchaAnswer(e.target.value)}\n                        className=\"mt-2\"\n                        data-testid=\"input-captcha\"\n                      />\n                    </div>\n\n                    <Button \n                      type=\"submit\" \n                      className=\"w-full gap-2 bg-orange-500 hover:bg-orange-600\" \n                      disabled={registerMutation.isPending}\n                      data-testid=\"button-register\"\n                    >\n                      {registerMutation.isPending ? (\n                        <Loader2 className=\"h-4 w-4 animate-spin\" />\n                      ) : (\n                        <>\n                          <Zap className=\"h-4 w-4\" />\n                          Criar Conta e Comprar\n                        </>\n                      )}\n                    </Button>\n\n                    <Button \n                      type=\"button\"\n                      variant=\"ghost\" \n                      className=\"w-full\" \n                      onClick={() => setRegistrationType(null)}\n                    >\n                      <ArrowLeft className=\"h-4 w-4 mr-2\" />\n                      Voltar\n                    </Button>\n                  </form>\n                </Form>\n              </CardContent>\n            </Card>\n          </div>\n        </div>\n      </div>\n    );\n  }\n\n  // Full wholesale registration (existing flow)\n  return (\n    <div className=\"min-h-screen bg-background\">\n      <div className=\"container mx-auto px-4 py-8\">\n        <div className=\"max-w-lg mx-auto\">\n          <div className=\"text-center mb-8\">\n            <div className=\"w-20 h-20 rounded-full bg-primary/10 flex items-center justify-center mx-auto mb-4\">\n              <Store className=\"h-10 w-10 text-primary\" />\n            </div>\n            <h1 className=\"text-xl font-bold mb-1\">LOJAMADRUGADAO</h1>\n            <p className=\"text-muted-foreground text-sm\">11 99284-5596</p>\n          </div>\n\n          <Card>\n            <CardHeader className=\"text-center\">\n              <CardTitle>Cadastro Atacado</CardTitle>\n              <CardDescription>\n                {step === 1 ? \"Passo 1 de 2 - Identificacao\" : \"Passo 2 de 2 - Dados completos\"}\n              </CardDescription>\n            </CardHeader>\n            <CardContent>\n              {error && (\n                <Alert variant=\"destructive\" className=\"mb-4\">\n                  <AlertDescription>{error}</AlertDescription>\n                </Alert>\n              )}\n\n              {step === 1 && (\n                <Form {...form1}>\n                  <form onSubmit={form1.handleSubmit(handleStep1Submit)} className=\"space-y-4\">\n                    <FormField\n                      control={form1.control}\n                      name=\"cnpj\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>CNPJ *</FormLabel>\n                          <FormControl>\n                            <Input \n                              placeholder=\"00.000.000/0000-00\" \n                              value={field.value || \"\"}\n                              onChange={field.onChange}\n                              onBlur={field.onBlur}\n                              name={field.name}\n                              ref={field.ref}\n                              data-testid=\"input-cnpj\"\n                            />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n\n                    <FormField\n                      control={form1.control}\n                      name=\"email\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Seu e-mail para acessar *</FormLabel>\n                          <FormControl>\n                            <Input \n                              type=\"email\" \n                              placeholder=\"seu@email.com\" \n                              {...field}\n                              data-testid=\"input-email\"\n                            />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n\n                    <Button type=\"submit\" className=\"w-full gap-2\" data-testid=\"button-continue\">\n                      Continuar o cadastro\n                      <ArrowRight className=\"h-4 w-4\" />\n                    </Button>\n\n                    <Button \n                      type=\"button\"\n                      variant=\"ghost\" \n                      className=\"w-full\" \n                      onClick={() => setRegistrationType(null)}\n                    >\n                      <ArrowLeft className=\"h-4 w-4 mr-2\" />\n                      Voltar\n                    </Button>\n                  </form>\n                </Form>\n              )}\n\n              {step === 2 && (\n                <Form {...form2}>\n                  <form onSubmit={form2.handleSubmit(handleStep2Submit)} className=\"space-y-4\">\n                    <FormField\n                      control={form2.control}\n                      name=\"firstName\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Seu nome *</FormLabel>\n                          <FormControl>\n                            <Input {...field} data-testid=\"input-name\" />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n\n                    <FormField\n                      control={form2.control}\n                      name=\"company\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Razao Social</FormLabel>\n                          <FormControl>\n                            <Input {...field} data-testid=\"input-company\" />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n                    <FormField\n                      control={form2.control}\n                      name=\"tradingName\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Nome Fantasia</FormLabel>\n                          <FormControl>\n                            <Input {...field} data-testid=\"input-trading-name\" />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n                    <FormField\n                      control={form2.control}\n                      name=\"stateRegistration\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Inscricao Estadual</FormLabel>\n                          <FormControl>\n                            <Input {...field} data-testid=\"input-state-registration\" />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n\n                    <FormField\n                      control={form2.control}\n                      name=\"phone\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Telefone/WhatsApp *</FormLabel>\n                          <FormControl>\n                            <Input \n                              placeholder=\"(11) 99999-9999\" \n                              {...field}\n                              data-testid=\"input-phone\"\n                            />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n\n                    <div className=\"grid grid-cols-2 gap-4\">\n                      <FormField\n                        control={form2.control}\n                        name=\"password\"\n                        render={({ field }) => (\n                          <FormItem>\n                            <FormLabel>Senha *</FormLabel>\n                            <FormControl>\n                              <Input type=\"password\" {...field} data-testid=\"input-password\" />\n                            </FormControl>\n                            <FormMessage />\n                          </FormItem>\n                        )}\n                      />\n\n                      <FormField\n                        control={form2.control}\n                        name=\"confirmPassword\"\n                        render={({ field }) => (\n                          <FormItem>\n                            <FormLabel>Confirmar *</FormLabel>\n                            <FormControl>\n                              <Input type=\"password\" {...field} data-testid=\"input-confirm-password\" />\n                            </FormControl>\n                            <FormMessage />\n                          </FormItem>\n                        )}\n                      />\n                    </div>\n\n                    <div className=\"pt-2\">\n                      <h3 className=\"text-sm font-medium mb-3\">Endereco</h3>\n                      \n                      <div className=\"space-y-4\">\n                        <FormField\n                          control={form2.control}\n                          name=\"cep\"\n                          render={({ field }) => (\n                            <FormItem>\n                              <FormLabel>CEP *</FormLabel>\n                              <FormControl>\n                                <Input \n                                  placeholder=\"00000-000\"\n                                  {...field}\n                                  onBlur={(e) => {\n                                    field.onBlur();\n                                    fetchCep(e.target.value);\n                                  }}\n                                  data-testid=\"input-cep\"\n                                />\n                              </FormControl>\n                              <FormMessage />\n                            </FormItem>\n                          )}\n                        />\n\n                        <FormField\n                          control={form2.control}\n                          name=\"address\"\n                          render={({ field }) => (\n                            <FormItem>\n                              <FormLabel>Endereco *</FormLabel>\n                              <FormControl>\n                                <Input {...field} data-testid=\"input-address\" />\n                              </FormControl>\n                              <FormMessage />\n                            </FormItem>\n                          )}\n                        />\n\n                        <div className=\"grid grid-cols-2 gap-4\">\n                          <FormField\n                            control={form2.control}\n                            name=\"addressNumber\"\n                            render={({ field }) => (\n                              <FormItem>\n                                <FormLabel>Numero *</FormLabel>\n                                <FormControl>\n                                  <Input {...field} data-testid=\"input-number\" />\n                                </FormControl>\n                                <FormMessage />\n                              </FormItem>\n                            )}\n                          />\n\n                          <FormField\n                            control={form2.control}\n                            name=\"complement\"\n                            render={({ field }) => (\n                              <FormItem>\n                                <FormLabel>Complemento</FormLabel>\n                                <FormControl>\n                                  <Input {...field} data-testid=\"input-complement\" />\n                                </FormControl>\n                                <FormMessage />\n                              </FormItem>\n                            )}\n                          />\n                        </div>\n\n                        <FormField\n                          control={form2.control}\n                          name=\"neighborhood\"\n                          render={({ field }) => (\n                            <FormItem>\n                              <FormLabel>Bairro *</FormLabel>\n                              <FormControl>\n                                <Input {...field} data-testid=\"input-neighborhood\" />\n                              </FormControl>\n                              <FormMessage />\n                            </FormItem>\n                          )}\n                        />\n\n                        <div className=\"grid grid-cols-2 gap-4\">\n                          <FormField\n                            control={form2.control}\n                            name=\"city\"\n                            render={({ field }) => (\n                              <FormItem>\n                                <FormLabel>Cidade *</FormLabel>\n                                <FormControl>\n                                  <Input {...field} data-testid=\"input-city\" />\n                                </FormControl>\n                                <FormMessage />\n                              </FormItem>\n                            )}\n                          />\n\n                          <FormField\n                            control={form2.control}\n                            name=\"state\"\n                            render={({ field }) => (\n                              <FormItem>\n                                <FormLabel>Estado *</FormLabel>\n                                <Select onValueChange={field.onChange} value={field.value}>\n                                  <FormControl>\n                                    <SelectTrigger data-testid=\"select-state\">\n                                      <SelectValue placeholder=\"Selecione\" />\n                                    </SelectTrigger>\n                                  </FormControl>\n                                  <SelectContent>\n                                    {BRAZILIAN_STATES.map((state) => (\n                                      <SelectItem key={state.value} value={state.value}>\n                                        {state.label}\n                                      </SelectItem>\n                                    ))}\n                                  </SelectContent>\n                                </Select>\n                                <FormMessage />\n                              </FormItem>\n                            )}\n                          />\n                        </div>\n                      </div>\n                    </div>\n\n                    {/* Honeypot field - hidden from users */}\n                    <div className=\"absolute -left-[9999px]\" aria-hidden=\"true\">\n                      <input\n                        type=\"text\"\n                        name=\"website\"\n                        tabIndex={-1}\n                        autoComplete=\"off\"\n                        value={honeypot}\n                        onChange={(e) => setHoneypot(e.target.value)}\n                      />\n                    </div>\n\n                    {/* Simple math captcha */}\n                    <div className=\"p-3 rounded-lg bg-muted/50\">\n                      <label className=\"text-sm font-medium\">\n                        Verificacao: Quanto e {captcha.num1} + {captcha.num2}? *\n                      </label>\n                      <Input\n                        type=\"number\"\n                        placeholder=\"Resposta\"\n                        value={captchaAnswer}\n                        onChange={(e) => setCaptchaAnswer(e.target.value)}\n                        className=\"mt-2\"\n                        data-testid=\"input-captcha\"\n                      />\n                    </div>\n\n                    <Button \n                      type=\"submit\" \n                      className=\"w-full gap-2\" \n                      disabled={registerMutation.isPending}\n                      data-testid=\"button-register\"\n                    >\n                      {registerMutation.isPending ? (\n                        <Loader2 className=\"h-4 w-4 animate-spin\" />\n                      ) : (\n                        <>\n                          Solicitar Acesso\n                          <ArrowRight className=\"h-4 w-4\" />\n                        </>\n                      )}\n                    </Button>\n\n                    <Button \n                      type=\"button\"\n                      variant=\"ghost\" \n                      className=\"w-full\" \n                      onClick={() => setStep(1)}\n                    >\n                      <ArrowLeft className=\"h-4 w-4 mr-2\" />\n                      Voltar\n                    </Button>\n                  </form>\n                </Form>\n              )}\n            </CardContent>\n          </Card>\n        </div>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":40736,"size_tokens":null},"client/src/pages/order-details.tsx":{"content":"import { useState, useMemo } from \"react\";\nimport { useParams, Link } from \"wouter\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { useAuth } from \"@/contexts/AuthContext\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Separator } from \"@/components/ui/separator\";\nimport { Input } from \"@/components/ui/input\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { ArrowLeft, Loader2, Package, User, Calendar, FileText, DollarSign, Printer, MapPin, Download, Pencil, Plus, Minus, Trash2, Search, X, AlertTriangle, ChevronDown, MessageCircle } from \"lucide-react\";\nimport { format } from \"date-fns\";\nimport { ptBR } from \"date-fns/locale\";\nimport type { Order, OrderItem, Product as SchemaProduct } from \"@shared/schema\";\n\ninterface ProductInfo {\n  id: number;\n  name: string;\n  sku: string;\n  image: string | null;\n  price: string;\n}\n\ninterface CustomerInfo {\n  id: string;\n  firstName: string | null;\n  lastName: string | null;\n  company: string | null;\n  tradingName: string | null;\n  stateRegistration: string | null;\n  email: string | null;\n  phone: string | null;\n  personType: string | null;\n  cnpj: string | null;\n  cpf: string | null;\n  cep: string | null;\n  address: string | null;\n  addressNumber: string | null;\n  complement: string | null;\n  neighborhood: string | null;\n  city: string | null;\n  state: string | null;\n}\n\ninterface PrintedByUser {\n  id: string;\n  firstName: string | null;\n  lastName: string | null;\n  email: string | null;\n}\n\ninterface OrderWithDetails extends Order {\n  items: (OrderItem & { product: ProductInfo })[];\n  customer: CustomerInfo;\n  printedByUser: PrintedByUser | null;\n}\n\nconst statusLabels: Record<string, string> = {\n  ORCAMENTO_ABERTO: \"Orçamento Aberto\",\n  ORCAMENTO_CONCLUIDO: \"Orçamento Enviado\",\n  PEDIDO_GERADO: \"Pedido Gerado\",\n  PEDIDO_FATURADO: \"Faturado\",\n  PEDIDO_CANCELADO: \"Cancelado\",\n  pending: \"Pendente\",\n  approved: \"Aprovado\",\n  processing: \"Processando\",\n  completed: \"Concluído\",\n  cancelled: \"Cancelado\",\n};\n\nconst statusVariants: Record<string, \"default\" | \"secondary\" | \"destructive\" | \"outline\"> = {\n  ORCAMENTO_ABERTO: \"secondary\",\n  ORCAMENTO_CONCLUIDO: \"outline\",\n  PEDIDO_GERADO: \"default\",\n  PEDIDO_FATURADO: \"default\",\n  PEDIDO_CANCELADO: \"destructive\",\n  pending: \"secondary\",\n  approved: \"default\",\n  processing: \"default\",\n  completed: \"default\",\n  cancelled: \"destructive\",\n};\n\nexport default function OrderDetailsPage() {\n  const params = useParams<{ id: string }>();\n  const orderId = params.id;\n  const { isAdmin, isSales } = useAuth();\n  const { toast } = useToast();\n  const canEditStatus = isAdmin || isSales;\n  \n  const [isEditMode, setIsEditMode] = useState(false);\n  const [editItems, setEditItems] = useState<Map<number, { productId: number; quantity: number; price: string; product: ProductInfo }>>(new Map());\n  const [productSearch, setProductSearch] = useState(\"\");\n  const [visibleItems, setVisibleItems] = useState(10);\n  const ITEMS_PER_LOAD = 30;\n\n  const { data: orderData, isLoading } = useQuery<OrderWithDetails>({\n    queryKey: [\"/api/orders\", orderId],\n    enabled: !!orderId,\n  });\n\n  const { data: productsData } = useQuery<{ products: { id: number; name: string; sku: string; price: string; image: string | null }[] }>({\n    queryKey: [\"/api/products\"],\n    queryFn: async () => {\n      const res = await fetch('/api/products?limit=1000', { credentials: 'include' });\n      if (!res.ok) throw new Error('Failed to fetch products');\n      return res.json();\n    },\n    enabled: isEditMode,\n  });\n\n  const editTotal = useMemo(() => {\n    let total = 0;\n    editItems.forEach(item => {\n      total += parseFloat(item.price) * item.quantity;\n    });\n    return total;\n  }, [editItems]);\n\n  const filteredProducts = useMemo(() => {\n    if (!productsData?.products || !productSearch.trim()) return [];\n    const search = productSearch.toLowerCase();\n    return productsData.products\n      .filter(p => p.name.toLowerCase().includes(search) || p.sku.toLowerCase().includes(search))\n      .slice(0, 10);\n  }, [productsData?.products, productSearch]);\n\n  const updateItemsMutation = useMutation({\n    mutationFn: async (items: { productId: number; quantity: number; price: string }[]) => {\n      const response = await apiRequest(\"PUT\", `/api/orders/${orderId}/items`, { items });\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/orders\", orderId] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/orders\"] });\n      setIsEditMode(false);\n      setEditItems(new Map());\n      toast({\n        title: \"Pedido Atualizado\",\n        description: \"Os itens do pedido foram atualizados com sucesso.\",\n      });\n    },\n    onError: (error: Error) => {\n      const desc = isAdmin \n        ? (error.message || \"Não foi possível atualizar o pedido.\")\n        : \"Não foi possível atualizar o pedido. Contate o administrador.\";\n      toast({\n        title: \"Erro\",\n        description: desc,\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const updateStatusMutation = useMutation({\n    mutationFn: async (status: string) => {\n      await apiRequest(\"PATCH\", `/api/orders/${orderId}`, { status });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/orders\", orderId] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/orders\"] });\n      toast({\n        title: \"Status Atualizado\",\n        description: \"O status do pedido foi atualizado com sucesso.\",\n      });\n    },\n    onError: () => {\n      toast({\n        title: \"Erro\",\n        description: \"Não foi possível atualizar o status do pedido.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const reserveStockMutation = useMutation({\n    mutationFn: async () => {\n      await apiRequest(\"POST\", `/api/orders/${orderId}/reserve`, {});\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/orders\", orderId] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/orders\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/products\"] });\n      toast({\n        title: \"Sucesso\",\n        description: \"Estoque reservado - Pedido gerado com sucesso.\",\n      });\n    },\n    onError: (err: Error) => {\n      let desc = \"Não foi possível reservar o estoque. Verifique se há estoque disponível.\";\n      const errorMsg = err.message || \"\";\n      const match = errorMsg.match(/\\d+:\\s*(.+)/);\n      if (match) {\n        try {\n          const parsed = JSON.parse(match[1]);\n          if (parsed.message) {\n            desc = parsed.message;\n          }\n        } catch {\n          desc = match[1];\n        }\n      }\n      toast({\n        title: \"Estoque Insuficiente\",\n        description: desc,\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const invoiceMutation = useMutation({\n    mutationFn: async () => {\n      await apiRequest(\"POST\", `/api/orders/${orderId}/invoice`, {});\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/orders\", orderId] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/orders\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/products\"] });\n      toast({\n        title: \"Sucesso\",\n        description: \"Pedido faturado - Estoque baixado com sucesso.\",\n      });\n    },\n    onError: (err: Error) => {\n      const desc = isAdmin \n        ? (err.message || \"Não foi possível faturar o pedido.\")\n        : \"Não foi possível faturar o pedido. Contate o administrador.\";\n      toast({\n        title: \"Erro\",\n        description: desc,\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const handleStatusChange = (newStatus: string) => {\n    if (newStatus === \"PEDIDO_GERADO\") {\n      reserveStockMutation.mutate();\n    } else if (newStatus === \"FATURADO\" || newStatus === \"PEDIDO_FATURADO\") {\n      invoiceMutation.mutate();\n    } else {\n      updateStatusMutation.mutate(newStatus);\n    }\n  };\n\n  const printMutation = useMutation({\n    mutationFn: async () => {\n      await apiRequest(\"PATCH\", `/api/orders/${orderId}/print`, {});\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/orders\", orderId] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/orders\"] });\n      window.print();\n      toast({\n        title: \"Pedido Impresso\",\n        description: \"O pedido foi marcado como impresso.\",\n      });\n    },\n    onError: () => {\n      toast({\n        title: \"Erro\",\n        description: \"Não foi possível marcar o pedido como impresso.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const unreserveMutation = useMutation({\n    mutationFn: async () => {\n      await apiRequest(\"POST\", `/api/orders/${orderId}/unreserve`, {});\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/orders\", orderId] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/orders\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/products\"] });\n      toast({\n        title: \"Sucesso\",\n        description: \"Pedido retornado para Orçamento. Estoque liberado.\",\n      });\n    },\n    onError: (err: Error) => {\n      const desc = isAdmin \n        ? (err.message || \"Não foi possível retornar o pedido.\")\n        : \"Não foi possível retornar o pedido. Contate o administrador.\";\n      toast({\n        title: \"Erro\",\n        description: desc,\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  if (isLoading) {\n    return (\n      <div className=\"flex items-center justify-center py-24\">\n        <Loader2 className=\"h-8 w-8 animate-spin text-muted-foreground\" />\n      </div>\n    );\n  }\n\n  if (!orderData) {\n    return (\n      <div className=\"p-6 lg:p-8\">\n        <Link href=\"/orders\">\n          <Button variant=\"ghost\" size=\"sm\" data-testid=\"link-back-orders\">\n            <ArrowLeft className=\"h-4 w-4 mr-2\" />\n            Voltar para Pedidos\n          </Button>\n        </Link>\n        <div className=\"text-center py-12 text-muted-foreground\">\n          Pedido não encontrado\n        </div>\n      </div>\n    );\n  }\n\n  const customer = orderData.customer;\n  const itemsWithProducts = orderData.items || [];\n\n  const subtotal = itemsWithProducts.reduce(\n    (sum, item) => sum + parseFloat(item.price) * item.quantity,\n    0\n  );\n\n  const formatDocument = () => {\n    if (customer?.personType === 'juridica' && customer?.cnpj) {\n      return `CNPJ: ${customer.cnpj}`;\n    }\n    if (customer?.personType === 'fisica' && customer?.cpf) {\n      return `CPF: ${customer.cpf}`;\n    }\n    return null;\n  };\n\n  const formatAddress = () => {\n    const parts = [];\n    if (customer?.address) {\n      let addressLine = customer.address;\n      if (customer.addressNumber) addressLine += `, ${customer.addressNumber}`;\n      if (customer.complement) addressLine += ` - ${customer.complement}`;\n      parts.push(addressLine);\n    }\n    if (customer?.neighborhood) parts.push(customer.neighborhood);\n    if (customer?.city || customer?.state) {\n      parts.push([customer.city, customer.state].filter(Boolean).join(\" - \"));\n    }\n    if (customer?.cep) parts.push(`CEP: ${customer.cep}`);\n    return parts;\n  };\n\n  const canEditItems = orderData?.status === 'ORCAMENTO_CONCLUIDO' || orderData?.status === 'ORCAMENTO_ABERTO';\n  const isFaturado = orderData?.status === 'PEDIDO_FATURADO';\n  const isPedidoGerado = orderData?.status === 'PEDIDO_GERADO';\n\n  const startEditMode = () => {\n    const initialItems = new Map<number, { productId: number; quantity: number; price: string; product: ProductInfo }>();\n    itemsWithProducts.forEach(item => {\n      initialItems.set(item.productId, {\n        productId: item.productId,\n        quantity: item.quantity,\n        price: item.price,\n        product: item.product,\n      });\n    });\n    setEditItems(initialItems);\n    setIsEditMode(true);\n  };\n\n  const cancelEditMode = () => {\n    setIsEditMode(false);\n    setEditItems(new Map());\n    setProductSearch(\"\");\n  };\n\n  const updateEditItemQuantity = (productId: number, delta: number) => {\n    setEditItems(prev => {\n      const newMap = new Map(prev);\n      const item = newMap.get(productId);\n      if (item) {\n        const newQty = Math.max(1, item.quantity + delta);\n        newMap.set(productId, { ...item, quantity: newQty });\n      }\n      return newMap;\n    });\n  };\n\n  const removeEditItem = (productId: number) => {\n    setEditItems(prev => {\n      const newMap = new Map(prev);\n      newMap.delete(productId);\n      return newMap;\n    });\n  };\n\n  const addProductToEdit = (product: { id: number; name: string; sku: string; price: string; image: string | null }) => {\n    setEditItems(prev => {\n      const newMap = new Map(prev);\n      if (newMap.has(product.id)) {\n        const existing = newMap.get(product.id)!;\n        newMap.set(product.id, { ...existing, quantity: existing.quantity + 1 });\n      } else {\n        newMap.set(product.id, {\n          productId: product.id,\n          quantity: 1,\n          price: product.price,\n          product: { id: product.id, name: product.name, sku: product.sku, price: product.price, image: product.image },\n        });\n      }\n      return newMap;\n    });\n    setProductSearch(\"\");\n  };\n\n  const saveEditItems = () => {\n    const items = Array.from(editItems.values()).map(item => ({\n      productId: item.productId,\n      quantity: item.quantity,\n      price: item.price,\n    }));\n    if (items.length === 0) {\n      toast({ title: \"Erro\", description: \"O pedido deve ter pelo menos um item.\", variant: \"destructive\" });\n      return;\n    }\n    updateItemsMutation.mutate(items);\n  };\n\n  return (\n    <div className=\"p-6 lg:p-8 space-y-6\">\n      <div className=\"flex items-center gap-4 flex-wrap\">\n        <Link href=\"/orders\">\n          <Button variant=\"ghost\" size=\"sm\" data-testid=\"link-back-orders\">\n            <ArrowLeft className=\"h-4 w-4 mr-2\" />\n            Voltar\n          </Button>\n        </Link>\n        <div className=\"flex-1\">\n          <h1 className=\"text-2xl font-semibold\" data-testid=\"text-order-number\">\n            Pedido {orderData.orderNumber}\n          </h1>\n          <p className=\"text-sm text-muted-foreground\">\n            Criado em {format(new Date(orderData.createdAt), \"dd 'de' MMMM 'de' yyyy 'às' HH:mm\", { locale: ptBR })}\n          </p>\n        </div>\n        <div className=\"flex items-center gap-2 flex-wrap\">\n          {orderData.printed && (\n            <Badge variant=\"outline\" data-testid=\"badge-printed\">\n              Impresso\n            </Badge>\n          )}\n          <Badge variant={statusVariants[orderData.status]} data-testid=\"badge-order-status\">\n            {statusLabels[orderData.status] || orderData.status}\n          </Badge>\n        </div>\n      </div>\n\n      <div className=\"grid gap-6 md:grid-cols-3\">\n        <div className=\"md:col-span-2 space-y-6\">\n          {isFaturado && (\n            <Card className=\"border-destructive/50 bg-destructive/5\">\n              <CardContent className=\"flex items-center gap-3 py-4\">\n                <AlertTriangle className=\"h-5 w-5 text-destructive flex-shrink-0\" />\n                <p className=\"text-sm text-destructive font-medium\" data-testid=\"alert-faturado\">\n                  Pedidos faturados não podem ser modificados.\n                </p>\n              </CardContent>\n            </Card>\n          )}\n\n          {isPedidoGerado && (\n            <Card className=\"border-orange-500/50 bg-orange-500/5\">\n              <CardContent className=\"flex items-center justify-between gap-3 py-4\">\n                <div className=\"flex items-center gap-3\">\n                  <AlertTriangle className=\"h-5 w-5 text-orange-600 dark:text-orange-400 flex-shrink-0\" />\n                  <p className=\"text-sm text-orange-700 dark:text-orange-300\" data-testid=\"alert-gerado\">\n                    Este pedido tem estoque reservado.\n                  </p>\n                </div>\n                {canEditStatus && (\n                  <Button \n                    variant=\"outline\" \n                    size=\"sm\"\n                    onClick={() => unreserveMutation.mutate()}\n                    disabled={unreserveMutation.isPending}\n                    data-testid=\"button-unreserve\"\n                  >\n                    {unreserveMutation.isPending ? \"Retornando...\" : \"Retornar para Orçamento\"}\n                  </Button>\n                )}\n              </CardContent>\n            </Card>\n          )}\n\n          <Card>\n            <CardHeader className=\"flex flex-row items-center justify-between gap-4 pb-4\">\n              <CardTitle className=\"flex items-center gap-2\">\n                <Package className=\"h-5 w-5\" />\n                Itens do Pedido\n              </CardTitle>\n              <div className=\"flex items-center gap-2\">\n                <span className=\"text-sm text-muted-foreground\">\n                  {isEditMode ? editItems.size : itemsWithProducts.length} {(isEditMode ? editItems.size : itemsWithProducts.length) === 1 ? \"item\" : \"itens\"}\n                </span>\n                {canEditStatus && canEditItems && !isEditMode && (\n                  <Button variant=\"outline\" size=\"sm\" onClick={startEditMode} data-testid=\"button-edit-items\">\n                    <Pencil className=\"h-4 w-4 mr-2\" />\n                    Editar\n                  </Button>\n                )}\n              </div>\n            </CardHeader>\n            <CardContent>\n              {isEditMode ? (\n                <div className=\"space-y-4\">\n                  <div className=\"relative\">\n                    <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\n                    <Input\n                      placeholder=\"Buscar produtos para adicionar...\"\n                      value={productSearch}\n                      onChange={(e) => setProductSearch(e.target.value)}\n                      className=\"pl-9\"\n                      data-testid=\"input-search-products\"\n                    />\n                    {filteredProducts.length > 0 && (\n                      <div className=\"absolute z-10 w-full mt-1 bg-popover border rounded-md shadow-lg max-h-60 overflow-auto\">\n                        {filteredProducts.map((product) => (\n                          <div\n                            key={product.id}\n                            className=\"flex items-center gap-3 p-3 cursor-pointer hover-elevate\"\n                            onClick={() => addProductToEdit(product)}\n                            data-testid={`add-product-${product.id}`}\n                          >\n                            <div className=\"h-10 w-10 rounded bg-muted flex items-center justify-center overflow-hidden flex-shrink-0\">\n                              {product.image ? (\n                                <img src={product.image} alt={product.name} className=\"h-full w-full object-cover\" />\n                              ) : (\n                                <Package className=\"h-4 w-4 text-muted-foreground\" />\n                              )}\n                            </div>\n                            <div className=\"flex-1 min-w-0\">\n                              <p className=\"font-medium truncate text-sm\">{product.name}</p>\n                              <p className=\"text-xs text-muted-foreground\">{product.sku}</p>\n                            </div>\n                            <p className=\"text-sm font-medium\">R$ {parseFloat(product.price).toFixed(2)}</p>\n                            <Plus className=\"h-4 w-4 text-muted-foreground\" />\n                          </div>\n                        ))}\n                      </div>\n                    )}\n                  </div>\n\n                  <Separator />\n\n                  {Array.from(editItems.values()).map((item) => (\n                    <div key={item.productId} className=\"flex items-center gap-4\" data-testid={`edit-item-${item.productId}`}>\n                      <div className=\"h-16 w-16 rounded-md bg-muted flex items-center justify-center overflow-hidden flex-shrink-0\">\n                        {item.product?.image ? (\n                          <img src={item.product.image} alt={item.product.name} className=\"h-full w-full object-cover\" />\n                        ) : (\n                          <Package className=\"h-6 w-6 text-muted-foreground\" />\n                        )}\n                      </div>\n                      <div className=\"flex-1 min-w-0\">\n                        <p className=\"font-medium truncate\">{item.product?.name}</p>\n                        <p className=\"text-sm text-muted-foreground\">SKU: {item.product?.sku}</p>\n                      </div>\n                      <div className=\"flex items-center gap-2\">\n                        <Button variant=\"outline\" size=\"icon\" onClick={() => updateEditItemQuantity(item.productId, -1)} data-testid={`btn-decrease-${item.productId}`}>\n                          <Minus className=\"h-4 w-4\" />\n                        </Button>\n                        <span className=\"w-10 text-center font-medium\">{item.quantity}</span>\n                        <Button variant=\"outline\" size=\"icon\" onClick={() => updateEditItemQuantity(item.productId, 1)} data-testid={`btn-increase-${item.productId}`}>\n                          <Plus className=\"h-4 w-4\" />\n                        </Button>\n                      </div>\n                      <div className=\"text-right w-24\">\n                        <p className=\"font-medium\">R$ {(parseFloat(item.price) * item.quantity).toFixed(2)}</p>\n                        <p className=\"text-xs text-muted-foreground\">R$ {parseFloat(item.price).toFixed(2)}/un</p>\n                      </div>\n                      <Button variant=\"ghost\" size=\"icon\" onClick={() => removeEditItem(item.productId)} data-testid={`btn-remove-${item.productId}`}>\n                        <Trash2 className=\"h-4 w-4 text-destructive\" />\n                      </Button>\n                    </div>\n                  ))}\n\n                  {editItems.size === 0 && (\n                    <p className=\"text-center text-muted-foreground py-4\">Nenhum item no pedido. Adicione produtos acima.</p>\n                  )}\n\n                  <Separator />\n\n                  <div className=\"flex justify-between items-center\">\n                    <span className=\"font-medium\">Novo Total</span>\n                    <span className=\"text-lg font-semibold\">R$ {editTotal.toFixed(2)}</span>\n                  </div>\n\n                  <div className=\"flex gap-2 pt-2\">\n                    <Button variant=\"outline\" onClick={cancelEditMode} className=\"flex-1\" data-testid=\"button-cancel-edit\">\n                      <X className=\"h-4 w-4 mr-2\" />\n                      Cancelar\n                    </Button>\n                    <Button onClick={saveEditItems} disabled={updateItemsMutation.isPending} className=\"flex-1\" data-testid=\"button-save-edit\">\n                      {updateItemsMutation.isPending ? <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" /> : null}\n                      Salvar Alterações\n                    </Button>\n                  </div>\n                </div>\n              ) : (\n                <>\n                  <div className=\"space-y-4\">\n                    {itemsWithProducts.slice(0, visibleItems).map((item) => (\n                      <div key={item.id} className=\"flex items-center gap-4\" data-testid={`order-item-${item.id}`}>\n                        <div className=\"h-16 w-16 rounded-md bg-muted flex items-center justify-center overflow-hidden flex-shrink-0\">\n                          {item.product?.image ? (\n                            <img src={item.product.image} alt={item.product.name} className=\"h-full w-full object-cover\" />\n                          ) : (\n                            <Package className=\"h-6 w-6 text-muted-foreground\" />\n                          )}\n                        </div>\n                        <div className=\"flex-1 min-w-0\">\n                          <p className=\"font-medium truncate\" data-testid={`text-product-name-${item.id}`}>\n                            {item.product?.name || `Produto #${item.productId}`}\n                          </p>\n                          <p className=\"text-sm text-muted-foreground\">SKU: {item.product?.sku || \"-\"}</p>\n                        </div>\n                        <div className=\"text-right\">\n                          <p className=\"font-medium\" data-testid={`text-item-total-${item.id}`}>\n                            R$ {(parseFloat(item.price) * item.quantity).toFixed(2)}\n                          </p>\n                          <p className=\"text-sm text-muted-foreground\">{item.quantity}x R$ {parseFloat(item.price).toFixed(2)}</p>\n                        </div>\n                      </div>\n                    ))}\n                  </div>\n                  {itemsWithProducts.length > visibleItems && (\n                    <div className=\"flex justify-center pt-4\">\n                      <Button \n                        variant=\"outline\" \n                        onClick={() => setVisibleItems(prev => prev + ITEMS_PER_LOAD)}\n                        data-testid=\"button-show-more-items\"\n                      >\n                        <ChevronDown className=\"h-4 w-4 mr-2\" />\n                        Mostrar mais ({itemsWithProducts.length - visibleItems} restantes)\n                      </Button>\n                    </div>\n                  )}\n                  <Separator className=\"my-4\" />\n                  <div className=\"flex justify-between items-center\">\n                    <span className=\"font-medium\">Total do Pedido</span>\n                    <span className=\"text-lg font-semibold\" data-testid=\"text-order-total\">R$ {parseFloat(orderData.total).toFixed(2)}</span>\n                  </div>\n                </>\n              )}\n            </CardContent>\n          </Card>\n\n          {orderData.notes && (\n            <Card>\n              <CardHeader className=\"pb-4\">\n                <CardTitle className=\"flex items-center gap-2\">\n                  <FileText className=\"h-5 w-5\" />\n                  Observações\n                </CardTitle>\n              </CardHeader>\n              <CardContent>\n                <p className=\"text-muted-foreground whitespace-pre-wrap\" data-testid=\"text-order-notes\">\n                  {orderData.notes}\n                </p>\n              </CardContent>\n            </Card>\n          )}\n        </div>\n\n        <div className=\"space-y-6\">\n          {canEditStatus && (\n            <Card>\n              <CardHeader className=\"pb-4\">\n                <CardTitle>Ações</CardTitle>\n              </CardHeader>\n              <CardContent className=\"space-y-4\">\n                <Select\n                  value={orderData.status}\n                  onValueChange={handleStatusChange}\n                  disabled={updateStatusMutation.isPending || reserveStockMutation.isPending || invoiceMutation.isPending}\n                >\n                  <SelectTrigger data-testid=\"select-status\">\n                    <SelectValue placeholder=\"Selecionar status\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"ORCAMENTO_ABERTO\">Orçamento Aberto</SelectItem>\n                    <SelectItem value=\"ORCAMENTO_CONCLUIDO\">Orçamento Enviado</SelectItem>\n                    <SelectItem value=\"PEDIDO_GERADO\">Gerar Pedido (Reservar Estoque)</SelectItem>\n                    <SelectItem value=\"PEDIDO_FATURADO\">Faturar (Baixar Estoque)</SelectItem>\n                    <SelectItem value=\"PEDIDO_CANCELADO\">Cancelado</SelectItem>\n                  </SelectContent>\n                </Select>\n                <Button\n                  variant=\"outline\"\n                  className=\"w-full\"\n                  onClick={() => printMutation.mutate()}\n                  disabled={printMutation.isPending}\n                  data-testid=\"button-print\"\n                >\n                  <Printer className=\"h-4 w-4 mr-2\" />\n                  {printMutation.isPending ? \"Imprimindo...\" : \"Imprimir Pedido\"}\n                </Button>\n                <div className=\"grid grid-cols-1 gap-2\">\n                  <Button\n                    variant=\"default\"\n                    className=\"w-full\"\n                    onClick={async () => {\n                      try {\n                        const response = await fetch(`/api/orders/${orderId}/pdf?type=cobranca`, {\n                          credentials: 'include',\n                        });\n                        if (!response.ok) throw new Error('Failed to generate PDF');\n                        const blob = await response.blob();\n                        const url = window.URL.createObjectURL(blob);\n                        const a = document.createElement('a');\n                        a.href = url;\n                        a.download = `Orcamento_${orderData?.orderNumber || orderId}.pdf`;\n                        document.body.appendChild(a);\n                        a.click();\n                        window.URL.revokeObjectURL(url);\n                        document.body.removeChild(a);\n                        \n                        await apiRequest(\"PATCH\", `/api/orders/${orderId}/print`, {});\n                        queryClient.invalidateQueries({ queryKey: [\"/api/orders\", orderId] });\n                        queryClient.invalidateQueries({ queryKey: [\"/api/orders\"] });\n                        \n                        toast({\n                          title: \"PDF Gerado\",\n                          description: \"PDF de Cobranca gerado com sucesso.\",\n                        });\n                      } catch (error) {\n                        toast({\n                          title: \"Erro\",\n                          description: \"Nao foi possivel gerar o PDF.\",\n                          variant: \"destructive\",\n                        });\n                      }\n                    }}\n                    data-testid=\"button-pdf-cobranca\"\n                  >\n                    <Download className=\"h-4 w-4 mr-2\" />\n                    PDF Cobranca\n                  </Button>\n                  <Button\n                    variant=\"outline\"\n                    className=\"w-full\"\n                    onClick={async () => {\n                      try {\n                        const response = await fetch(`/api/orders/${orderId}/pdf?type=separacao`, {\n                          credentials: 'include',\n                        });\n                        if (!response.ok) throw new Error('Failed to generate PDF');\n                        const blob = await response.blob();\n                        const url = window.URL.createObjectURL(blob);\n                        const a = document.createElement('a');\n                        a.href = url;\n                        a.download = `Separacao_${orderData?.orderNumber || orderId}.pdf`;\n                        document.body.appendChild(a);\n                        a.click();\n                        window.URL.revokeObjectURL(url);\n                        document.body.removeChild(a);\n                        \n                        toast({\n                          title: \"PDF Gerado\",\n                          description: \"PDF de Separacao gerado com sucesso.\",\n                        });\n                      } catch (error) {\n                        toast({\n                          title: \"Erro\",\n                          description: \"Nao foi possivel gerar o PDF.\",\n                          variant: \"destructive\",\n                        });\n                      }\n                    }}\n                    data-testid=\"button-pdf-separacao\"\n                  >\n                    <Download className=\"h-4 w-4 mr-2\" />\n                    PDF Separacao\n                  </Button>\n                  <Button\n                    variant=\"outline\"\n                    className=\"w-full\"\n                    onClick={async () => {\n                      try {\n                        const response = await fetch(`/api/orders/${orderId}/pdf?type=conferencia`, {\n                          credentials: 'include',\n                        });\n                        if (!response.ok) throw new Error('Failed to generate PDF');\n                        const blob = await response.blob();\n                        const url = window.URL.createObjectURL(blob);\n                        const a = document.createElement('a');\n                        a.href = url;\n                        a.download = `Conferencia_${orderData?.orderNumber || orderId}.pdf`;\n                        document.body.appendChild(a);\n                        a.click();\n                        window.URL.revokeObjectURL(url);\n                        document.body.removeChild(a);\n                        \n                        toast({\n                          title: \"PDF Gerado\",\n                          description: \"PDF de Conferencia gerado com sucesso.\",\n                        });\n                      } catch (error) {\n                        toast({\n                          title: \"Erro\",\n                          description: \"Nao foi possivel gerar o PDF.\",\n                          variant: \"destructive\",\n                        });\n                      }\n                    }}\n                    data-testid=\"button-pdf-conferencia\"\n                  >\n                    <Download className=\"h-4 w-4 mr-2\" />\n                    PDF Conferencia\n                  </Button>\n                </div>\n                <Separator className=\"my-2\" />\n                <div className=\"grid grid-cols-1 gap-2\">\n                  {customer?.phone && (\n                    <Button\n                      variant=\"outline\"\n                      className=\"w-full bg-green-500/10 border-green-500/30 text-green-600 dark:text-green-400\"\n                      onClick={() => {\n                        const phone = customer.phone?.replace(/\\D/g, '');\n                        const customerName = customer.firstName || 'Cliente';\n                        const message = encodeURIComponent(\n                          `Oi ${customerName}, tudo bem? Estou entrando em contato sobre o pedido ${orderData.orderNumber}.`\n                        );\n                        window.open(`https://wa.me/55${phone}?text=${message}`, '_blank');\n                      }}\n                      data-testid=\"button-whatsapp-customer\"\n                    >\n                      <MessageCircle className=\"h-4 w-4 mr-2\" />\n                      Chamar Cliente no WhatsApp\n                    </Button>\n                  )}\n                  <Button\n                    variant=\"outline\"\n                    className=\"w-full bg-green-500/10 border-green-500/30 text-green-600 dark:text-green-400\"\n                    onClick={() => {\n                      const customerName = customer?.firstName || 'Cliente';\n                      const total = parseFloat(orderData.total).toFixed(2);\n                      const message = encodeURIComponent(\n                        `Oi ${customerName} acabei de mandar orçamento de número ${orderData.orderNumber} de valor R$ ${total} aguardando para darmos andamento`\n                      );\n                      window.open(`https://wa.me/5511992845596?text=${message}`, '_blank');\n                    }}\n                    data-testid=\"button-whatsapp-store\"\n                  >\n                    <MessageCircle className=\"h-4 w-4 mr-2\" />\n                    Enviar Pedido no WhatsApp\n                  </Button>\n                </div>\n              </CardContent>\n            </Card>\n          )}\n\n          <Card>\n            <CardHeader className=\"pb-4\">\n              <CardTitle className=\"flex items-center gap-2\">\n                <User className=\"h-5 w-5\" />\n                Cliente\n              </CardTitle>\n            </CardHeader>\n            <CardContent className=\"space-y-3\">\n              {customer ? (\n                <>\n                  <div>\n                    <p className=\"text-sm text-muted-foreground\">Nome</p>\n                    <p className=\"font-medium\" data-testid=\"text-customer-name\">\n                      {customer.firstName} {customer.lastName}\n                    </p>\n                  </div>\n                  {customer.company && (\n                    <div>\n                      <p className=\"text-sm text-muted-foreground\">Empresa</p>\n                      <p className=\"font-medium\">{customer.company}</p>\n                    </div>\n                  )}\n                  {formatDocument() && (\n                    <div>\n                      <p className=\"text-sm text-muted-foreground\">Documento</p>\n                      <p className=\"font-medium\" data-testid=\"text-customer-document\">{formatDocument()}</p>\n                    </div>\n                  )}\n                  {customer.email && (\n                    <div>\n                      <p className=\"text-sm text-muted-foreground\">E-mail</p>\n                      <p className=\"font-medium\">{customer.email}</p>\n                    </div>\n                  )}\n                  {customer.phone && (\n                    <div>\n                      <p className=\"text-sm text-muted-foreground\">Telefone</p>\n                      <p className=\"font-medium\">{customer.phone}</p>\n                    </div>\n                  )}\n                </>\n              ) : (\n                <div>\n                  <p className=\"text-sm text-muted-foreground\">ID do Cliente</p>\n                  <p className=\"font-medium font-mono text-sm\" data-testid=\"text-customer-id\">\n                    {orderData.userId}\n                  </p>\n                </div>\n              )}\n            </CardContent>\n          </Card>\n\n          {customer && formatAddress().length > 0 && (\n            <Card>\n              <CardHeader className=\"pb-4\">\n                <CardTitle className=\"flex items-center gap-2\">\n                  <MapPin className=\"h-5 w-5\" />\n                  Endereço\n                </CardTitle>\n              </CardHeader>\n              <CardContent>\n                <div className=\"space-y-1\" data-testid=\"text-customer-address\">\n                  {formatAddress().map((line, idx) => (\n                    <p key={idx} className={idx === 0 ? \"font-medium\" : \"text-muted-foreground text-sm\"}>\n                      {line}\n                    </p>\n                  ))}\n                </div>\n              </CardContent>\n            </Card>\n          )}\n\n          <Card>\n            <CardHeader className=\"pb-4\">\n              <CardTitle className=\"flex items-center gap-2\">\n                <DollarSign className=\"h-5 w-5\" />\n                Resumo\n              </CardTitle>\n            </CardHeader>\n            <CardContent className=\"space-y-3\">\n              <div className=\"flex justify-between\">\n                <span className=\"text-muted-foreground\">Subtotal</span>\n                <span>R$ {subtotal.toFixed(2)}</span>\n              </div>\n              <Separator />\n              <div className=\"flex justify-between font-semibold\">\n                <span>Total</span>\n                <span data-testid=\"text-summary-total\">R$ {parseFloat(orderData.total).toFixed(2)}</span>\n              </div>\n            </CardContent>\n          </Card>\n\n          <Card>\n            <CardHeader className=\"pb-4\">\n              <CardTitle className=\"flex items-center gap-2\">\n                <Calendar className=\"h-5 w-5\" />\n                Informações\n              </CardTitle>\n            </CardHeader>\n            <CardContent className=\"space-y-3\">\n              <div>\n                <p className=\"text-sm text-muted-foreground\">Número do Pedido</p>\n                <p className=\"font-medium font-mono\">{orderData.orderNumber}</p>\n              </div>\n              <div>\n                <p className=\"text-sm text-muted-foreground\">Data de Criação</p>\n                <p className=\"font-medium\">\n                  {format(new Date(orderData.createdAt), \"dd/MM/yyyy HH:mm\", { locale: ptBR })}\n                </p>\n              </div>\n              {orderData.printed && orderData.printedAt && (\n                <div>\n                  <p className=\"text-sm text-muted-foreground\">Impresso em</p>\n                  <p className=\"font-medium\">\n                    {format(new Date(orderData.printedAt), \"dd/MM/yyyy HH:mm\", { locale: ptBR })}\n                  </p>\n                  {orderData.printedByUser && (\n                    <p className=\"text-sm text-muted-foreground mt-1\" data-testid=\"text-printed-by\">\n                      por {orderData.printedByUser.firstName || orderData.printedByUser.email}\n                    </p>\n                  )}\n                </div>\n              )}\n              <div>\n                <p className=\"text-sm text-muted-foreground\">Status Atual</p>\n                <Badge variant={statusVariants[orderData.status]} className=\"mt-1\">\n                  {statusLabels[orderData.status] || orderData.status}\n                </Badge>\n              </div>\n            </CardContent>\n          </Card>\n        </div>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":41320,"size_tokens":null},"client/src/pages/coupons.tsx":{"content":"import { useState } from \"react\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Switch } from \"@/components/ui/switch\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogHeader,\n  DialogTitle,\n  DialogFooter,\n} from \"@/components/ui/dialog\";\nimport {\n  Form,\n  FormControl,\n  FormField,\n  FormItem,\n  FormLabel,\n  FormMessage,\n} from \"@/components/ui/form\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport {\n  Table,\n  TableBody,\n  TableCell,\n  TableHead,\n  TableHeader,\n  TableRow,\n} from \"@/components/ui/table\";\nimport { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { z } from \"zod\";\nimport { \n  Search, \n  RefreshCw, \n  Loader2, \n  Plus, \n  Pencil, \n  Trash2,\n  Ticket,\n  Percent,\n  DollarSign,\n  Calendar\n} from \"lucide-react\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\nimport type { Coupon } from \"@shared/schema\";\nimport { format } from \"date-fns\";\n\nconst couponSchema = z.object({\n  code: z.string().min(3, \"Código deve ter pelo menos 3 caracteres\"),\n  name: z.string().min(1, \"Nome é obrigatório\"),\n  discountType: z.enum([\"percent\", \"fixed\"]),\n  discountValue: z.coerce.number().min(0.01, \"Valor deve ser maior que 0\"),\n  minOrderValue: z.coerce.number().optional(),\n  maxUses: z.coerce.number().optional(),\n  validFrom: z.string().optional(),\n  validUntil: z.string().optional(),\n  active: z.boolean().default(true),\n});\n\ntype CouponFormValues = z.infer<typeof couponSchema>;\n\nexport default function CouponsPage() {\n  const { toast } = useToast();\n  const [searchQuery, setSearchQuery] = useState(\"\");\n  const [isDialogOpen, setIsDialogOpen] = useState(false);\n  const [editingCoupon, setEditingCoupon] = useState<Coupon | null>(null);\n\n  const { data: couponsData = [], isLoading, refetch } = useQuery<Coupon[]>({\n    queryKey: ['/api/coupons'],\n  });\n\n  const form = useForm<CouponFormValues>({\n    resolver: zodResolver(couponSchema),\n    defaultValues: {\n      code: \"\",\n      name: \"\",\n      discountType: \"percent\",\n      discountValue: 10,\n      minOrderValue: undefined,\n      maxUses: undefined,\n      validFrom: \"\",\n      validUntil: \"\",\n      active: true,\n    },\n  });\n\n  const filteredCoupons = couponsData.filter((coupon) =>\n    coupon.code.toLowerCase().includes(searchQuery.toLowerCase()) ||\n    coupon.name.toLowerCase().includes(searchQuery.toLowerCase())\n  );\n\n  const createMutation = useMutation({\n    mutationFn: async (data: CouponFormValues) => {\n      await apiRequest(\"POST\", \"/api/coupons\", data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/coupons'] });\n      toast({ title: \"Cupom criado\", description: \"O cupom foi criado com sucesso.\" });\n      setIsDialogOpen(false);\n      form.reset();\n    },\n    onError: () => {\n      toast({ title: \"Erro\", description: \"Falha ao criar cupom\", variant: \"destructive\" });\n    },\n  });\n\n  const updateMutation = useMutation({\n    mutationFn: async ({ id, data }: { id: number; data: Partial<CouponFormValues> }) => {\n      await apiRequest(\"PATCH\", `/api/coupons/${id}`, data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/coupons'] });\n      toast({ title: \"Cupom atualizado\", description: \"O cupom foi atualizado com sucesso.\" });\n      setIsDialogOpen(false);\n      setEditingCoupon(null);\n      form.reset();\n    },\n    onError: () => {\n      toast({ title: \"Erro\", description: \"Falha ao atualizar cupom\", variant: \"destructive\" });\n    },\n  });\n\n  const deleteMutation = useMutation({\n    mutationFn: async (id: number) => {\n      await apiRequest(\"DELETE\", `/api/coupons/${id}`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/coupons'] });\n      toast({ title: \"Cupom excluído\", description: \"O cupom foi excluído com sucesso.\" });\n    },\n    onError: () => {\n      toast({ title: \"Erro\", description: \"Falha ao excluir cupom\", variant: \"destructive\" });\n    },\n  });\n\n  const toggleActiveMutation = useMutation({\n    mutationFn: async ({ id, active }: { id: number; active: boolean }) => {\n      await apiRequest(\"PATCH\", `/api/coupons/${id}`, { active });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/coupons'] });\n    },\n    onError: () => {\n      toast({ title: \"Erro\", description: \"Falha ao atualizar status\", variant: \"destructive\" });\n    },\n  });\n\n  const handleOpenDialog = (coupon?: Coupon) => {\n    if (coupon) {\n      setEditingCoupon(coupon);\n      form.reset({\n        code: coupon.code,\n        name: coupon.name,\n        discountType: coupon.discountType as \"percent\" | \"fixed\",\n        discountValue: parseFloat(coupon.discountValue),\n        minOrderValue: coupon.minOrderValue ? parseFloat(coupon.minOrderValue) : undefined,\n        maxUses: coupon.maxUses || undefined,\n        validFrom: coupon.validFrom ? format(new Date(coupon.validFrom), \"yyyy-MM-dd\") : \"\",\n        validUntil: coupon.validUntil ? format(new Date(coupon.validUntil), \"yyyy-MM-dd\") : \"\",\n        active: coupon.active,\n      });\n    } else {\n      setEditingCoupon(null);\n      form.reset();\n    }\n    setIsDialogOpen(true);\n  };\n\n  const onSubmit = (data: CouponFormValues) => {\n    const payload = {\n      ...data,\n      minOrderValue: data.minOrderValue || null,\n      maxUses: data.maxUses || null,\n      validFrom: data.validFrom ? new Date(data.validFrom).toISOString() : null,\n      validUntil: data.validUntil ? new Date(data.validUntil).toISOString() : null,\n    };\n\n    if (editingCoupon) {\n      updateMutation.mutate({ id: editingCoupon.id, data: payload });\n    } else {\n      createMutation.mutate(payload as any);\n    }\n  };\n\n  const formatDate = (date: Date | string | null) => {\n    if (!date) return \"-\";\n    return format(new Date(date), \"dd/MM/yyyy\");\n  };\n\n  return (\n    <div className=\"p-4 lg:p-6 space-y-6\">\n      <div className=\"flex items-center justify-between gap-4 flex-wrap\">\n        <div>\n          <h1 className=\"text-2xl lg:text-3xl font-bold\">Cupons de Desconto</h1>\n          <p className=\"text-sm text-muted-foreground mt-0.5\">\n            Gerencie cupons e promoções para seus clientes\n          </p>\n        </div>\n        <div className=\"flex gap-2\">\n          <Button variant=\"outline\" onClick={() => refetch()} data-testid=\"button-refresh-coupons\">\n            <RefreshCw className=\"h-4 w-4 mr-2\" />\n            Atualizar\n          </Button>\n          <Button onClick={() => handleOpenDialog()} data-testid=\"button-add-coupon\">\n            <Plus className=\"h-4 w-4 mr-2\" />\n            Novo Cupom\n          </Button>\n        </div>\n      </div>\n\n      <div className=\"grid grid-cols-2 lg:grid-cols-4 gap-4\">\n        <Card>\n          <CardContent className=\"p-4\">\n            <div className=\"flex items-center gap-3\">\n              <div className=\"p-2 rounded-lg bg-primary/10\">\n                <Ticket className=\"h-5 w-5 text-primary\" />\n              </div>\n              <div>\n                <p className=\"text-2xl font-bold\" data-testid=\"stat-total-coupons\">{couponsData.length}</p>\n                <p className=\"text-xs text-muted-foreground\">Total de Cupons</p>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n        \n        <Card>\n          <CardContent className=\"p-4\">\n            <div className=\"flex items-center gap-3\">\n              <div className=\"p-2 rounded-lg bg-green-500/10\">\n                <Ticket className=\"h-5 w-5 text-green-500\" />\n              </div>\n              <div>\n                <p className=\"text-2xl font-bold text-green-600\" data-testid=\"stat-active-coupons\">\n                  {couponsData.filter(c => c.active).length}\n                </p>\n                <p className=\"text-xs text-muted-foreground\">Cupons Ativos</p>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n        \n        <Card>\n          <CardContent className=\"p-4\">\n            <div className=\"flex items-center gap-3\">\n              <div className=\"p-2 rounded-lg bg-blue-500/10\">\n                <Percent className=\"h-5 w-5 text-blue-500\" />\n              </div>\n              <div>\n                <p className=\"text-2xl font-bold text-blue-600\" data-testid=\"stat-percent-coupons\">\n                  {couponsData.filter(c => c.discountType === \"percent\").length}\n                </p>\n                <p className=\"text-xs text-muted-foreground\">Desconto %</p>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n        \n        <Card>\n          <CardContent className=\"p-4\">\n            <div className=\"flex items-center gap-3\">\n              <div className=\"p-2 rounded-lg bg-orange-500/10\">\n                <DollarSign className=\"h-5 w-5 text-orange-500\" />\n              </div>\n              <div>\n                <p className=\"text-2xl font-bold text-orange-600\" data-testid=\"stat-fixed-coupons\">\n                  {couponsData.filter(c => c.discountType === \"fixed\").length}\n                </p>\n                <p className=\"text-xs text-muted-foreground\">Desconto Fixo</p>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n\n      <div className=\"relative max-w-md\">\n        <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\n        <Input\n          placeholder=\"Buscar cupons...\"\n          value={searchQuery}\n          onChange={(e) => setSearchQuery(e.target.value)}\n          className=\"pl-9\"\n          data-testid=\"input-search-coupons\"\n        />\n      </div>\n\n      <Card>\n        <CardContent className=\"p-0\">\n          {isLoading ? (\n            <div className=\"flex items-center justify-center py-12\">\n              <Loader2 className=\"h-8 w-8 animate-spin text-muted-foreground\" />\n            </div>\n          ) : filteredCoupons.length === 0 ? (\n            <div className=\"text-center py-12\">\n              <Ticket className=\"h-12 w-12 mx-auto text-muted-foreground/50 mb-4\" />\n              <p className=\"text-muted-foreground\">Nenhum cupom encontrado</p>\n            </div>\n          ) : (\n            <Table>\n              <TableHeader>\n                <TableRow>\n                  <TableHead>Código</TableHead>\n                  <TableHead>Nome</TableHead>\n                  <TableHead>Desconto</TableHead>\n                  <TableHead>Pedido Mínimo</TableHead>\n                  <TableHead>Validade</TableHead>\n                  <TableHead>Usos</TableHead>\n                  <TableHead>Status</TableHead>\n                  <TableHead className=\"text-right\">Ações</TableHead>\n                </TableRow>\n              </TableHeader>\n              <TableBody>\n                {filteredCoupons.map((coupon) => (\n                  <TableRow key={coupon.id} data-testid={`row-coupon-${coupon.id}`}>\n                    <TableCell className=\"font-mono font-bold\">{coupon.code}</TableCell>\n                    <TableCell>{coupon.name}</TableCell>\n                    <TableCell>\n                      <Badge variant=\"outline\">\n                        {coupon.discountType === \"percent\" \n                          ? `${coupon.discountValue}%` \n                          : `R$ ${parseFloat(coupon.discountValue).toFixed(2)}`\n                        }\n                      </Badge>\n                    </TableCell>\n                    <TableCell>\n                      {coupon.minOrderValue \n                        ? `R$ ${parseFloat(coupon.minOrderValue).toFixed(2)}` \n                        : \"-\"\n                      }\n                    </TableCell>\n                    <TableCell>\n                      <span className=\"text-sm\">\n                        {coupon.validFrom || coupon.validUntil ? (\n                          <>\n                            {formatDate(coupon.validFrom)} - {formatDate(coupon.validUntil)}\n                          </>\n                        ) : (\n                          \"Sem limite\"\n                        )}\n                      </span>\n                    </TableCell>\n                    <TableCell>\n                      {coupon.maxUses \n                        ? `${coupon.usedCount}/${coupon.maxUses}` \n                        : coupon.usedCount\n                      }\n                    </TableCell>\n                    <TableCell>\n                      <Switch\n                        checked={coupon.active}\n                        onCheckedChange={(checked) => \n                          toggleActiveMutation.mutate({ id: coupon.id, active: checked })\n                        }\n                        data-testid={`switch-active-${coupon.id}`}\n                      />\n                    </TableCell>\n                    <TableCell className=\"text-right\">\n                      <div className=\"flex justify-end gap-1\">\n                        <Button\n                          variant=\"ghost\"\n                          size=\"icon\"\n                          onClick={() => handleOpenDialog(coupon)}\n                          data-testid={`button-edit-${coupon.id}`}\n                        >\n                          <Pencil className=\"h-4 w-4\" />\n                        </Button>\n                        <Button\n                          variant=\"ghost\"\n                          size=\"icon\"\n                          onClick={() => deleteMutation.mutate(coupon.id)}\n                          data-testid={`button-delete-${coupon.id}`}\n                        >\n                          <Trash2 className=\"h-4 w-4 text-destructive\" />\n                        </Button>\n                      </div>\n                    </TableCell>\n                  </TableRow>\n                ))}\n              </TableBody>\n            </Table>\n          )}\n        </CardContent>\n      </Card>\n\n      <Dialog open={isDialogOpen} onOpenChange={setIsDialogOpen}>\n        <DialogContent className=\"max-w-md\">\n          <DialogHeader>\n            <DialogTitle>\n              {editingCoupon ? \"Editar Cupom\" : \"Novo Cupom\"}\n            </DialogTitle>\n          </DialogHeader>\n          <Form {...form}>\n            <form onSubmit={form.handleSubmit(onSubmit)} className=\"space-y-4\">\n              <FormField\n                control={form.control}\n                name=\"code\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Código do Cupom</FormLabel>\n                    <FormControl>\n                      <Input \n                        {...field} \n                        placeholder=\"EX: DESCONTO10\" \n                        className=\"uppercase\"\n                        data-testid=\"input-coupon-code\"\n                      />\n                    </FormControl>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n\n              <FormField\n                control={form.control}\n                name=\"name\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Nome da Promoção</FormLabel>\n                    <FormControl>\n                      <Input \n                        {...field} \n                        placeholder=\"Ex: Promoção de Natal\"\n                        data-testid=\"input-coupon-name\"\n                      />\n                    </FormControl>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n\n              <div className=\"grid grid-cols-2 gap-4\">\n                <FormField\n                  control={form.control}\n                  name=\"discountType\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Tipo de Desconto</FormLabel>\n                      <Select onValueChange={field.onChange} defaultValue={field.value}>\n                        <FormControl>\n                          <SelectTrigger data-testid=\"select-discount-type\">\n                            <SelectValue />\n                          </SelectTrigger>\n                        </FormControl>\n                        <SelectContent>\n                          <SelectItem value=\"percent\">Porcentagem (%)</SelectItem>\n                          <SelectItem value=\"fixed\">Valor Fixo (R$)</SelectItem>\n                        </SelectContent>\n                      </Select>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                <FormField\n                  control={form.control}\n                  name=\"discountValue\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Valor do Desconto</FormLabel>\n                      <FormControl>\n                        <Input \n                          {...field} \n                          type=\"number\" \n                          step=\"0.01\"\n                          data-testid=\"input-discount-value\"\n                        />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n              </div>\n\n              <div className=\"grid grid-cols-2 gap-4\">\n                <FormField\n                  control={form.control}\n                  name=\"minOrderValue\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Pedido Mínimo (R$)</FormLabel>\n                      <FormControl>\n                        <Input \n                          {...field} \n                          type=\"number\" \n                          step=\"0.01\"\n                          placeholder=\"Opcional\"\n                          data-testid=\"input-min-order\"\n                        />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                <FormField\n                  control={form.control}\n                  name=\"maxUses\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Limite de Usos</FormLabel>\n                      <FormControl>\n                        <Input \n                          {...field} \n                          type=\"number\"\n                          placeholder=\"Ilimitado\"\n                          data-testid=\"input-max-uses\"\n                        />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n              </div>\n\n              <div className=\"grid grid-cols-2 gap-4\">\n                <FormField\n                  control={form.control}\n                  name=\"validFrom\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Válido a partir de</FormLabel>\n                      <FormControl>\n                        <Input \n                          {...field} \n                          type=\"date\"\n                          data-testid=\"input-valid-from\"\n                        />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                <FormField\n                  control={form.control}\n                  name=\"validUntil\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Válido até</FormLabel>\n                      <FormControl>\n                        <Input \n                          {...field} \n                          type=\"date\"\n                          data-testid=\"input-valid-until\"\n                        />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n              </div>\n\n              <FormField\n                control={form.control}\n                name=\"active\"\n                render={({ field }) => (\n                  <FormItem className=\"flex items-center gap-2\">\n                    <FormControl>\n                      <Switch\n                        checked={field.value}\n                        onCheckedChange={field.onChange}\n                        data-testid=\"switch-coupon-active\"\n                      />\n                    </FormControl>\n                    <FormLabel className=\"!mt-0\">Cupom ativo</FormLabel>\n                  </FormItem>\n                )}\n              />\n\n              <DialogFooter>\n                <Button\n                  type=\"button\"\n                  variant=\"outline\"\n                  onClick={() => setIsDialogOpen(false)}\n                >\n                  Cancelar\n                </Button>\n                <Button\n                  type=\"submit\"\n                  disabled={createMutation.isPending || updateMutation.isPending}\n                  data-testid=\"button-save-coupon\"\n                >\n                  {(createMutation.isPending || updateMutation.isPending) && (\n                    <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />\n                  )}\n                  {editingCoupon ? \"Salvar\" : \"Criar Cupom\"}\n                </Button>\n              </DialogFooter>\n            </form>\n          </Form>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n","path":null,"size_bytes":21631,"size_tokens":null},"client/src/pages/customer-analytics.tsx":{"content":"import { useState, useMemo } from \"react\";\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { \n  RefreshCw, \n  Loader2, \n  TrendingUp, \n  Users, \n  AlertTriangle,\n  Crown,\n  Clock,\n  BarChart3,\n  UserPlus,\n  RotateCcw,\n  Star,\n  MapPin\n} from \"lucide-react\";\nimport { useQuery } from \"@tanstack/react-query\";\n\ninterface CustomerRanking {\n  userId: string;\n  name: string;\n  company: string | null;\n  email: string | null;\n  totalRevenue: number;\n  orderCount: number;\n  avgTicket: number;\n  lastOrderDate: string | null;\n  daysSinceLastOrder: number;\n  firstOrderDate: string | null;\n}\n\ninterface RFMSegment {\n  userId: string;\n  name: string;\n  company: string | null;\n  recency: number;\n  frequency: number;\n  monetary: number;\n  rfmScore: string;\n  segment: string;\n}\n\ninterface InactiveCustomer {\n  userId: string;\n  name: string;\n  company: string | null;\n  email: string | null;\n  lastOrderDate: string;\n  daysSinceLastOrder: number;\n  avgDaysBetweenOrders: number;\n  churnRisk: 'low' | 'medium' | 'high';\n  totalSpent: number;\n  orderCount: number;\n}\n\ninterface CustomerAnalyticsData {\n  topCustomersByRevenue: {\n    month: CustomerRanking[];\n    quarter: CustomerRanking[];\n    year: CustomerRanking[];\n  };\n  topCustomersByFrequency: CustomerRanking[];\n  abcAnalysis: {\n    a: CustomerRanking[];\n    b: CustomerRanking[];\n    c: CustomerRanking[];\n  };\n  inactiveCustomers: {\n    days7: InactiveCustomer[];\n    days15: InactiveCustomer[];\n    days30: InactiveCustomer[];\n    days60: InactiveCustomer[];\n    days90: InactiveCustomer[];\n  };\n  reactivatedThisMonth: CustomerRanking[];\n  newCustomersThisMonth: CustomerRanking[];\n  rfmSegments: RFMSegment[];\n  avgDaysBetweenOrders: number;\n  cohortRetention: {\n    days30: number;\n    days60: number;\n    days90: number;\n  };\n}\n\ninterface LocationData {\n  totalCustomers: number;\n  customersWithLocation: number;\n  byState: { state: string; count: number; customers: { id: string; name: string; city: string | null }[] }[];\n  byCity: { city: string; state: string | null; count: number }[];\n}\n\nfunction formatCurrency(value: number): string {\n  return new Intl.NumberFormat('pt-BR', {\n    style: 'currency',\n    currency: 'BRL'\n  }).format(value);\n}\n\nfunction formatDate(dateStr: string | null): string {\n  if (!dateStr) return '-';\n  return new Intl.DateTimeFormat('pt-BR', {\n    day: '2-digit',\n    month: '2-digit',\n    year: 'numeric'\n  }).format(new Date(dateStr));\n}\n\nfunction ChurnRiskBadge({ risk }: { risk: 'low' | 'medium' | 'high' }) {\n  const variants = {\n    low: { className: 'bg-green-500/10 text-green-600 dark:text-green-400', label: 'Baixo' },\n    medium: { className: 'bg-yellow-500/10 text-yellow-600 dark:text-yellow-400', label: 'Médio' },\n    high: { className: 'bg-red-500/10 text-red-600 dark:text-red-400', label: 'Alto' }\n  };\n  const { className, label } = variants[risk];\n  return <Badge className={className}>{label}</Badge>;\n}\n\nfunction RFMSegmentBadge({ segment }: { segment: string }) {\n  const colors: Record<string, string> = {\n    'Campeões': 'bg-yellow-500/10 text-yellow-600 dark:text-yellow-400',\n    'Leais': 'bg-green-500/10 text-green-600 dark:text-green-400',\n    'Potenciais Leais': 'bg-blue-500/10 text-blue-600 dark:text-blue-400',\n    'Novos': 'bg-purple-500/10 text-purple-600 dark:text-purple-400',\n    'Promissores': 'bg-cyan-500/10 text-cyan-600 dark:text-cyan-400',\n    'Precisam de Atenção': 'bg-orange-500/10 text-orange-600 dark:text-orange-400',\n    'Em Risco': 'bg-red-500/10 text-red-600 dark:text-red-400',\n    'Hibernando': 'bg-gray-500/10 text-gray-600 dark:text-gray-400',\n    'Perdidos': 'bg-slate-500/10 text-slate-600 dark:text-slate-400',\n  };\n  return <Badge className={colors[segment] || 'bg-muted'}>{segment}</Badge>;\n}\n\nfunction getCustomerTags(customer: CustomerRanking, allCustomers: CustomerRanking[]): { label: string; className: string }[] {\n  const tags: { label: string; className: string }[] = [];\n  \n  const sortedByRevenue = [...allCustomers].sort((a, b) => b.totalRevenue - a.totalRevenue);\n  const top10PercentCount = Math.max(1, Math.ceil(allCustomers.length * 0.1));\n  const isTop10Percent = sortedByRevenue.slice(0, top10PercentCount).some(c => c.userId === customer.userId);\n  const isRecentBuyer = customer.daysSinceLastOrder <= 30;\n  \n  if (isTop10Percent && isRecentBuyer) {\n    tags.push({ label: 'Cliente VIP', className: 'bg-yellow-500/10 text-yellow-600 dark:text-yellow-400' });\n  }\n  \n  if (customer.totalRevenue >= 5000) {\n    tags.push({ label: 'Cliente Atacado', className: 'bg-purple-500/10 text-purple-600 dark:text-purple-400' });\n  }\n  \n  if (customer.orderCount >= 5) {\n    tags.push({ label: 'Compra Recorrente', className: 'bg-blue-500/10 text-blue-600 dark:text-blue-400' });\n  }\n  \n  if (customer.orderCount === 0 && customer.totalRevenue === 0) {\n    tags.push({ label: 'Só orçamento', className: 'bg-gray-500/10 text-gray-600 dark:text-gray-400' });\n  }\n  \n  return tags;\n}\n\nfunction RankingTable({ customers, showRank = true }: { customers: CustomerRanking[], showRank?: boolean }) {\n  if (customers.length === 0) {\n    return (\n      <div className=\"text-center py-8 text-muted-foreground\">\n        <Users className=\"h-12 w-12 mx-auto mb-3 opacity-50\" />\n        <p>Nenhum cliente encontrado</p>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"overflow-x-auto\">\n      <table className=\"w-full text-sm\">\n        <thead>\n          <tr className=\"border-b\">\n            {showRank && <th className=\"text-left py-3 px-2 font-medium text-muted-foreground\">#</th>}\n            <th className=\"text-left py-3 px-2 font-medium text-muted-foreground\">Cliente</th>\n            <th className=\"text-right py-3 px-2 font-medium text-muted-foreground\">Faturamento</th>\n            <th className=\"text-right py-3 px-2 font-medium text-muted-foreground\">Pedidos</th>\n            <th className=\"text-right py-3 px-2 font-medium text-muted-foreground\">Ticket Médio</th>\n            <th className=\"text-right py-3 px-2 font-medium text-muted-foreground\">Último Pedido</th>\n          </tr>\n        </thead>\n        <tbody>\n          {customers.map((customer, idx) => (\n            <tr key={customer.userId} className=\"border-b last:border-0 hover:bg-muted/50\" data-testid={`row-customer-${customer.userId}`}>\n              {showRank && (\n                <td className=\"py-3 px-2\">\n                  {idx < 3 ? (\n                    <div className={`w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold ${\n                      idx === 0 ? 'bg-yellow-500/20 text-yellow-600' :\n                      idx === 1 ? 'bg-gray-400/20 text-gray-600' :\n                      'bg-orange-500/20 text-orange-600'\n                    }`}>\n                      {idx + 1}\n                    </div>\n                  ) : (\n                    <span className=\"text-muted-foreground\">{idx + 1}</span>\n                  )}\n                </td>\n              )}\n              <td className=\"py-3 px-2\">\n                <div>\n                  <p className=\"font-medium\">{customer.name}</p>\n                  {customer.company && (\n                    <p className=\"text-xs text-muted-foreground\">{customer.company}</p>\n                  )}\n                  {getCustomerTags(customer, customers).length > 0 && (\n                    <div className=\"flex flex-wrap gap-1 mt-1\">\n                      {getCustomerTags(customer, customers).map((tag, i) => (\n                        <Badge key={i} className={tag.className} variant=\"outline\">\n                          {tag.label}\n                        </Badge>\n                      ))}\n                    </div>\n                  )}\n                </div>\n              </td>\n              <td className=\"py-3 px-2 text-right font-medium\">{formatCurrency(customer.totalRevenue)}</td>\n              <td className=\"py-3 px-2 text-right\">{customer.orderCount}</td>\n              <td className=\"py-3 px-2 text-right\">{formatCurrency(customer.avgTicket)}</td>\n              <td className=\"py-3 px-2 text-right\">\n                <div>\n                  <p>{formatDate(customer.lastOrderDate)}</p>\n                  {customer.daysSinceLastOrder < 9999 && (\n                    <p className=\"text-xs text-muted-foreground\">{customer.daysSinceLastOrder}d atrás</p>\n                  )}\n                </div>\n              </td>\n            </tr>\n          ))}\n        </tbody>\n      </table>\n    </div>\n  );\n}\n\nfunction InactiveCustomersTable({ customers }: { customers: InactiveCustomer[] }) {\n  if (customers.length === 0) {\n    return (\n      <div className=\"text-center py-8 text-muted-foreground\">\n        <Users className=\"h-12 w-12 mx-auto mb-3 opacity-50\" />\n        <p>Nenhum cliente inativo neste período</p>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"overflow-x-auto\">\n      <table className=\"w-full text-sm\">\n        <thead>\n          <tr className=\"border-b\">\n            <th className=\"text-left py-3 px-2 font-medium text-muted-foreground\">Cliente</th>\n            <th className=\"text-left py-3 px-2 font-medium text-muted-foreground\">Risco Churn</th>\n            <th className=\"text-right py-3 px-2 font-medium text-muted-foreground\">Dias Inativo</th>\n            <th className=\"text-right py-3 px-2 font-medium text-muted-foreground\">Média Dias</th>\n            <th className=\"text-right py-3 px-2 font-medium text-muted-foreground\">Total Gasto</th>\n            <th className=\"text-right py-3 px-2 font-medium text-muted-foreground\">Pedidos</th>\n            <th className=\"text-right py-3 px-2 font-medium text-muted-foreground\">Último Pedido</th>\n          </tr>\n        </thead>\n        <tbody>\n          {customers.map((customer) => (\n            <tr key={customer.userId} className=\"border-b last:border-0 hover:bg-muted/50\" data-testid={`row-inactive-${customer.userId}`}>\n              <td className=\"py-3 px-2\">\n                <div>\n                  <p className=\"font-medium\">{customer.name}</p>\n                  {customer.company && (\n                    <p className=\"text-xs text-muted-foreground\">{customer.company}</p>\n                  )}\n                  {customer.email && (\n                    <p className=\"text-xs text-muted-foreground\">{customer.email}</p>\n                  )}\n                </div>\n              </td>\n              <td className=\"py-3 px-2\">\n                <ChurnRiskBadge risk={customer.churnRisk} />\n              </td>\n              <td className=\"py-3 px-2 text-right font-medium\">{customer.daysSinceLastOrder}</td>\n              <td className=\"py-3 px-2 text-right\">{customer.avgDaysBetweenOrders.toFixed(0)}</td>\n              <td className=\"py-3 px-2 text-right\">{formatCurrency(customer.totalSpent)}</td>\n              <td className=\"py-3 px-2 text-right\">{customer.orderCount}</td>\n              <td className=\"py-3 px-2 text-right\">{formatDate(customer.lastOrderDate)}</td>\n            </tr>\n          ))}\n        </tbody>\n      </table>\n    </div>\n  );\n}\n\nfunction RFMTable({ segments }: { segments: RFMSegment[] }) {\n  if (segments.length === 0) {\n    return (\n      <div className=\"text-center py-8 text-muted-foreground\">\n        <Users className=\"h-12 w-12 mx-auto mb-3 opacity-50\" />\n        <p>Nenhum cliente para análise RFM</p>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"overflow-x-auto\">\n      <table className=\"w-full text-sm\">\n        <thead>\n          <tr className=\"border-b\">\n            <th className=\"text-left py-3 px-2 font-medium text-muted-foreground\">Cliente</th>\n            <th className=\"text-left py-3 px-2 font-medium text-muted-foreground\">Segmento</th>\n            <th className=\"text-center py-3 px-2 font-medium text-muted-foreground\">Score RFM</th>\n            <th className=\"text-center py-3 px-2 font-medium text-muted-foreground\">R</th>\n            <th className=\"text-center py-3 px-2 font-medium text-muted-foreground\">F</th>\n            <th className=\"text-center py-3 px-2 font-medium text-muted-foreground\">M</th>\n          </tr>\n        </thead>\n        <tbody>\n          {segments.map((customer) => (\n            <tr key={customer.userId} className=\"border-b last:border-0 hover:bg-muted/50\" data-testid={`row-rfm-${customer.userId}`}>\n              <td className=\"py-3 px-2\">\n                <div>\n                  <p className=\"font-medium\">{customer.name}</p>\n                  {customer.company && (\n                    <p className=\"text-xs text-muted-foreground\">{customer.company}</p>\n                  )}\n                </div>\n              </td>\n              <td className=\"py-3 px-2\">\n                <RFMSegmentBadge segment={customer.segment} />\n              </td>\n              <td className=\"py-3 px-2 text-center font-mono font-bold\">{customer.rfmScore}</td>\n              <td className=\"py-3 px-2 text-center\">{customer.recency}</td>\n              <td className=\"py-3 px-2 text-center\">{customer.frequency}</td>\n              <td className=\"py-3 px-2 text-center\">{customer.monetary}</td>\n            </tr>\n          ))}\n        </tbody>\n      </table>\n    </div>\n  );\n}\n\nexport default function CustomerAnalyticsPage() {\n  const [revenuePeriod, setRevenuePeriod] = useState<'month' | 'quarter' | 'year'>('month');\n  const [inactivePeriod, setInactivePeriod] = useState<'days7' | 'days15' | 'days30' | 'days60' | 'days90'>('days30');\n\n  const { data: analytics, isLoading, refetch } = useQuery<CustomerAnalyticsData>({\n    queryKey: ['/api/admin/customer-analytics'],\n  });\n\n  const { data: locationData, isLoading: locationLoading } = useQuery<LocationData>({\n    queryKey: ['/api/admin/customers-by-location'],\n  });\n\n  const rfmSummary = useMemo(() => {\n    if (!analytics?.rfmSegments) return {};\n    const summary: Record<string, number> = {};\n    for (const customer of analytics.rfmSegments) {\n      summary[customer.segment] = (summary[customer.segment] || 0) + 1;\n    }\n    return summary;\n  }, [analytics?.rfmSegments]);\n\n  const periodLabels = {\n    month: 'Mês',\n    quarter: '90 Dias',\n    year: 'Ano',\n  };\n\n  const inactiveLabels = {\n    days7: '7 dias',\n    days15: '15 dias',\n    days30: '30 dias',\n    days60: '60 dias',\n    days90: '90 dias',\n  };\n\n  return (\n    <div className=\"p-4 lg:p-6 space-y-6\">\n      <div className=\"flex items-center justify-between gap-4 flex-wrap\">\n        <div>\n          <h1 className=\"text-2xl lg:text-3xl font-bold\" data-testid=\"text-page-title\">Análise de Clientes</h1>\n          <p className=\"text-sm text-muted-foreground mt-0.5\">\n            Métricas baseadas apenas em pedidos faturados\n          </p>\n        </div>\n        <Button variant=\"outline\" onClick={() => refetch()} data-testid=\"button-refresh-analytics\">\n          <RefreshCw className=\"h-4 w-4 mr-2\" />\n          Atualizar\n        </Button>\n      </div>\n\n      {isLoading ? (\n        <div className=\"flex items-center justify-center py-16\">\n          <Loader2 className=\"h-10 w-10 animate-spin text-muted-foreground\" />\n        </div>\n      ) : (\n        <>\n          <div className=\"grid grid-cols-2 lg:grid-cols-5 gap-4\">\n            <Card>\n              <CardContent className=\"p-4\">\n                <div className=\"flex items-center gap-3\">\n                  <div className=\"p-2 rounded-lg bg-green-500/10\">\n                    <UserPlus className=\"h-5 w-5 text-green-500\" />\n                  </div>\n                  <div>\n                    <p className=\"text-2xl font-bold\" data-testid=\"stat-new-customers\">\n                      {analytics?.newCustomersThisMonth.length || 0}\n                    </p>\n                    <p className=\"text-xs text-muted-foreground\">Novos no Mês</p>\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n\n            <Card>\n              <CardContent className=\"p-4\">\n                <div className=\"flex items-center gap-3\">\n                  <div className=\"p-2 rounded-lg bg-blue-500/10\">\n                    <RotateCcw className=\"h-5 w-5 text-blue-500\" />\n                  </div>\n                  <div>\n                    <p className=\"text-2xl font-bold\" data-testid=\"stat-reactivated\">\n                      {analytics?.reactivatedThisMonth.length || 0}\n                    </p>\n                    <p className=\"text-xs text-muted-foreground\">Reativados</p>\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n\n            <Card>\n              <CardContent className=\"p-4\">\n                <div className=\"flex items-center gap-3\">\n                  <div className=\"p-2 rounded-lg bg-yellow-500/10\">\n                    <AlertTriangle className=\"h-5 w-5 text-yellow-500\" />\n                  </div>\n                  <div>\n                    <p className=\"text-2xl font-bold\" data-testid=\"stat-inactive-30\">\n                      {analytics?.inactiveCustomers.days30.length || 0}\n                    </p>\n                    <p className=\"text-xs text-muted-foreground\">Inativos 30d</p>\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n\n            <Card>\n              <CardContent className=\"p-4\">\n                <div className=\"flex items-center gap-3\">\n                  <div className=\"p-2 rounded-lg bg-purple-500/10\">\n                    <Clock className=\"h-5 w-5 text-purple-500\" />\n                  </div>\n                  <div>\n                    <p className=\"text-2xl font-bold\" data-testid=\"stat-avg-days\">\n                      {analytics?.avgDaysBetweenOrders.toFixed(0) || 0}\n                    </p>\n                    <p className=\"text-xs text-muted-foreground\">Média Dias/Pedido</p>\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n\n            <Card>\n              <CardContent className=\"p-4\">\n                <div className=\"flex items-center gap-3\">\n                  <div className=\"p-2 rounded-lg bg-cyan-500/10\">\n                    <Star className=\"h-5 w-5 text-cyan-500\" />\n                  </div>\n                  <div>\n                    <p className=\"text-2xl font-bold\" data-testid=\"stat-retention-30\">\n                      {((analytics?.cohortRetention.days30 || 0) * 100).toFixed(0)}%\n                    </p>\n                    <p className=\"text-xs text-muted-foreground\">Retenção 30d</p>\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n          </div>\n\n          <Tabs defaultValue=\"ranking\" className=\"space-y-4\">\n            <TabsList data-testid=\"tabs-analytics\">\n              <TabsTrigger value=\"ranking\" data-testid=\"tab-ranking\">\n                <Crown className=\"h-4 w-4 mr-2\" />\n                Ranking\n              </TabsTrigger>\n              <TabsTrigger value=\"inactive\" data-testid=\"tab-inactive\">\n                <AlertTriangle className=\"h-4 w-4 mr-2\" />\n                Inativos\n              </TabsTrigger>\n              <TabsTrigger value=\"rfm\" data-testid=\"tab-rfm\">\n                <BarChart3 className=\"h-4 w-4 mr-2\" />\n                RFM\n              </TabsTrigger>\n              <TabsTrigger value=\"abc\" data-testid=\"tab-abc\">\n                <TrendingUp className=\"h-4 w-4 mr-2\" />\n                Curva ABC\n              </TabsTrigger>\n              <TabsTrigger value=\"geography\" data-testid=\"tab-geography\">\n                <MapPin className=\"h-4 w-4 mr-2\" />\n                Geografia\n              </TabsTrigger>\n            </TabsList>\n\n            <TabsContent value=\"ranking\" className=\"space-y-4\">\n              <Card>\n                <CardHeader className=\"pb-2\">\n                  <div className=\"flex items-center justify-between gap-4 flex-wrap\">\n                    <div>\n                      <CardTitle className=\"text-lg\">Top Clientes por Faturamento</CardTitle>\n                      <CardDescription>Os clientes que mais compraram no período</CardDescription>\n                    </div>\n                    <div className=\"flex gap-1\">\n                      {(['month', 'quarter', 'year'] as const).map((period) => (\n                        <Button\n                          key={period}\n                          variant={revenuePeriod === period ? 'default' : 'outline'}\n                          size=\"sm\"\n                          onClick={() => setRevenuePeriod(period)}\n                          data-testid={`button-period-${period}`}\n                        >\n                          {periodLabels[period]}\n                        </Button>\n                      ))}\n                    </div>\n                  </div>\n                </CardHeader>\n                <CardContent>\n                  <RankingTable customers={analytics?.topCustomersByRevenue[revenuePeriod] || []} />\n                </CardContent>\n              </Card>\n\n              <div className=\"grid lg:grid-cols-2 gap-4\">\n                <Card>\n                  <CardHeader className=\"pb-2\">\n                    <CardTitle className=\"text-lg\">Top por Frequência</CardTitle>\n                    <CardDescription>Clientes com mais pedidos realizados</CardDescription>\n                  </CardHeader>\n                  <CardContent>\n                    <RankingTable customers={analytics?.topCustomersByFrequency || []} />\n                  </CardContent>\n                </Card>\n\n                <Card>\n                  <CardHeader className=\"pb-2\">\n                    <CardTitle className=\"text-lg\">Novos Clientes do Mês</CardTitle>\n                    <CardDescription>Clientes que fizeram primeira compra este mês</CardDescription>\n                  </CardHeader>\n                  <CardContent>\n                    <RankingTable customers={analytics?.newCustomersThisMonth || []} showRank={false} />\n                  </CardContent>\n                </Card>\n              </div>\n            </TabsContent>\n\n            <TabsContent value=\"inactive\" className=\"space-y-4\">\n              <Card>\n                <CardHeader className=\"pb-2\">\n                  <div className=\"flex items-center justify-between gap-4 flex-wrap\">\n                    <div>\n                      <CardTitle className=\"text-lg\">Clientes Inativos</CardTitle>\n                      <CardDescription>Clientes sem pedidos no período selecionado</CardDescription>\n                    </div>\n                    <div className=\"flex gap-1 flex-wrap\">\n                      {(['days7', 'days15', 'days30', 'days60', 'days90'] as const).map((period) => (\n                        <Button\n                          key={period}\n                          variant={inactivePeriod === period ? 'default' : 'outline'}\n                          size=\"sm\"\n                          onClick={() => setInactivePeriod(period)}\n                          data-testid={`button-inactive-${period}`}\n                        >\n                          {inactiveLabels[period]}\n                        </Button>\n                      ))}\n                    </div>\n                  </div>\n                </CardHeader>\n                <CardContent>\n                  <InactiveCustomersTable customers={analytics?.inactiveCustomers[inactivePeriod] || []} />\n                </CardContent>\n              </Card>\n\n              <Card>\n                <CardHeader className=\"pb-2\">\n                  <CardTitle className=\"text-lg\">Clientes Reativados</CardTitle>\n                  <CardDescription>Clientes que voltaram a comprar este mês após período inativo</CardDescription>\n                </CardHeader>\n                <CardContent>\n                  <RankingTable customers={analytics?.reactivatedThisMonth || []} showRank={false} />\n                </CardContent>\n              </Card>\n            </TabsContent>\n\n            <TabsContent value=\"rfm\" className=\"space-y-4\">\n              <div className=\"grid grid-cols-2 lg:grid-cols-5 gap-4\">\n                {Object.entries(rfmSummary).sort((a, b) => b[1] - a[1]).slice(0, 5).map(([segment, count]) => (\n                  <Card key={segment}>\n                    <CardContent className=\"p-4\">\n                      <div className=\"flex flex-col gap-2\">\n                        <RFMSegmentBadge segment={segment} />\n                        <p className=\"text-2xl font-bold\" data-testid={`stat-rfm-${segment.toLowerCase().replace(/\\s+/g, '-')}`}>\n                          {count}\n                        </p>\n                        <p className=\"text-xs text-muted-foreground\">clientes</p>\n                      </div>\n                    </CardContent>\n                  </Card>\n                ))}\n              </div>\n\n              <Card>\n                <CardHeader className=\"pb-2\">\n                  <CardTitle className=\"text-lg\">Segmentação RFM</CardTitle>\n                  <CardDescription>Análise Recency-Frequency-Monetary de todos os clientes</CardDescription>\n                </CardHeader>\n                <CardContent>\n                  <RFMTable segments={analytics?.rfmSegments || []} />\n                </CardContent>\n              </Card>\n            </TabsContent>\n\n            <TabsContent value=\"abc\" className=\"space-y-4\">\n              <div className=\"grid lg:grid-cols-3 gap-4\">\n                <Card>\n                  <CardHeader className=\"pb-2\">\n                    <div className=\"flex items-center gap-2\">\n                      <div className=\"w-8 h-8 rounded-full bg-green-500/20 flex items-center justify-center\">\n                        <span className=\"font-bold text-green-600\">A</span>\n                      </div>\n                      <div>\n                        <CardTitle className=\"text-lg\">Curva A</CardTitle>\n                        <CardDescription>80% do faturamento</CardDescription>\n                      </div>\n                    </div>\n                  </CardHeader>\n                  <CardContent>\n                    <div className=\"mb-4 p-3 rounded-lg bg-green-500/10\">\n                      <p className=\"text-sm text-muted-foreground\">Total de clientes</p>\n                      <p className=\"text-2xl font-bold text-green-600\" data-testid=\"stat-abc-a\">\n                        {analytics?.abcAnalysis.a.length || 0}\n                      </p>\n                    </div>\n                    <RankingTable customers={analytics?.abcAnalysis.a.slice(0, 10) || []} />\n                  </CardContent>\n                </Card>\n\n                <Card>\n                  <CardHeader className=\"pb-2\">\n                    <div className=\"flex items-center gap-2\">\n                      <div className=\"w-8 h-8 rounded-full bg-yellow-500/20 flex items-center justify-center\">\n                        <span className=\"font-bold text-yellow-600\">B</span>\n                      </div>\n                      <div>\n                        <CardTitle className=\"text-lg\">Curva B</CardTitle>\n                        <CardDescription>15% do faturamento</CardDescription>\n                      </div>\n                    </div>\n                  </CardHeader>\n                  <CardContent>\n                    <div className=\"mb-4 p-3 rounded-lg bg-yellow-500/10\">\n                      <p className=\"text-sm text-muted-foreground\">Total de clientes</p>\n                      <p className=\"text-2xl font-bold text-yellow-600\" data-testid=\"stat-abc-b\">\n                        {analytics?.abcAnalysis.b.length || 0}\n                      </p>\n                    </div>\n                    <RankingTable customers={analytics?.abcAnalysis.b.slice(0, 10) || []} />\n                  </CardContent>\n                </Card>\n\n                <Card>\n                  <CardHeader className=\"pb-2\">\n                    <div className=\"flex items-center gap-2\">\n                      <div className=\"w-8 h-8 rounded-full bg-gray-500/20 flex items-center justify-center\">\n                        <span className=\"font-bold text-gray-600\">C</span>\n                      </div>\n                      <div>\n                        <CardTitle className=\"text-lg\">Curva C</CardTitle>\n                        <CardDescription>5% do faturamento</CardDescription>\n                      </div>\n                    </div>\n                  </CardHeader>\n                  <CardContent>\n                    <div className=\"mb-4 p-3 rounded-lg bg-gray-500/10\">\n                      <p className=\"text-sm text-muted-foreground\">Total de clientes</p>\n                      <p className=\"text-2xl font-bold text-gray-600\" data-testid=\"stat-abc-c\">\n                        {analytics?.abcAnalysis.c.length || 0}\n                      </p>\n                    </div>\n                    <RankingTable customers={analytics?.abcAnalysis.c.slice(0, 10) || []} />\n                  </CardContent>\n                </Card>\n              </div>\n            </TabsContent>\n\n            <TabsContent value=\"geography\" className=\"space-y-4\">\n              {locationLoading ? (\n                <div className=\"flex items-center justify-center py-16\">\n                  <Loader2 className=\"h-10 w-10 animate-spin text-muted-foreground\" />\n                </div>\n              ) : (\n                <>\n                  <div className=\"grid grid-cols-2 lg:grid-cols-3 gap-4\">\n                    <Card>\n                      <CardContent className=\"p-4\">\n                        <div className=\"flex items-center gap-3\">\n                          <div className=\"p-2 rounded-lg bg-blue-500/10\">\n                            <Users className=\"h-5 w-5 text-blue-500\" />\n                          </div>\n                          <div>\n                            <p className=\"text-2xl font-bold\" data-testid=\"stat-total-customers\">\n                              {locationData?.totalCustomers || 0}\n                            </p>\n                            <p className=\"text-xs text-muted-foreground\">Total Clientes</p>\n                          </div>\n                        </div>\n                      </CardContent>\n                    </Card>\n\n                    <Card>\n                      <CardContent className=\"p-4\">\n                        <div className=\"flex items-center gap-3\">\n                          <div className=\"p-2 rounded-lg bg-green-500/10\">\n                            <MapPin className=\"h-5 w-5 text-green-500\" />\n                          </div>\n                          <div>\n                            <p className=\"text-2xl font-bold\" data-testid=\"stat-with-location\">\n                              {locationData?.customersWithLocation || 0}\n                            </p>\n                            <p className=\"text-xs text-muted-foreground\">Com Localização</p>\n                          </div>\n                        </div>\n                      </CardContent>\n                    </Card>\n\n                    <Card>\n                      <CardContent className=\"p-4\">\n                        <div className=\"flex items-center gap-3\">\n                          <div className=\"p-2 rounded-lg bg-purple-500/10\">\n                            <BarChart3 className=\"h-5 w-5 text-purple-500\" />\n                          </div>\n                          <div>\n                            <p className=\"text-2xl font-bold\" data-testid=\"stat-states-count\">\n                              {locationData?.byState.filter(s => s.state !== 'Não informado').length || 0}\n                            </p>\n                            <p className=\"text-xs text-muted-foreground\">Estados</p>\n                          </div>\n                        </div>\n                      </CardContent>\n                    </Card>\n                  </div>\n\n                  <div className=\"grid lg:grid-cols-2 gap-4\">\n                    <Card>\n                      <CardHeader className=\"pb-2\">\n                        <CardTitle className=\"text-lg\">Clientes por Estado</CardTitle>\n                        <CardDescription>Distribuição geográfica por UF</CardDescription>\n                      </CardHeader>\n                      <CardContent>\n                        {locationData?.byState && locationData.byState.length > 0 ? (\n                          <div className=\"space-y-2\">\n                            {locationData.byState.map((item) => (\n                              <div key={item.state} className=\"flex items-center justify-between py-2 border-b last:border-0\" data-testid={`row-state-${item.state}`}>\n                                <div className=\"flex items-center gap-2\">\n                                  <Badge variant=\"outline\">{item.state}</Badge>\n                                </div>\n                                <div className=\"flex items-center gap-4\">\n                                  <div className=\"w-32 bg-muted rounded-full h-2 overflow-hidden\">\n                                    <div \n                                      className=\"bg-blue-500 h-full rounded-full\" \n                                      style={{ width: `${Math.min(100, (item.count / (locationData.totalCustomers || 1)) * 100 * 3)}%` }}\n                                    />\n                                  </div>\n                                  <span className=\"font-medium text-sm w-12 text-right\">{item.count}</span>\n                                </div>\n                              </div>\n                            ))}\n                          </div>\n                        ) : (\n                          <div className=\"text-center py-8 text-muted-foreground\">\n                            <MapPin className=\"h-12 w-12 mx-auto mb-3 opacity-50\" />\n                            <p>Nenhum dado de localização</p>\n                          </div>\n                        )}\n                      </CardContent>\n                    </Card>\n\n                    <Card>\n                      <CardHeader className=\"pb-2\">\n                        <CardTitle className=\"text-lg\">Top 20 Cidades</CardTitle>\n                        <CardDescription>Cidades com mais clientes</CardDescription>\n                      </CardHeader>\n                      <CardContent>\n                        {locationData?.byCity && locationData.byCity.length > 0 ? (\n                          <div className=\"space-y-2\">\n                            {locationData.byCity.map((item, idx) => (\n                              <div key={`${item.city}-${item.state}`} className=\"flex items-center justify-between py-2 border-b last:border-0\" data-testid={`row-city-${idx}`}>\n                                <div className=\"flex items-center gap-2\">\n                                  <span className=\"text-muted-foreground text-sm w-6\">{idx + 1}.</span>\n                                  <span className=\"font-medium\">{item.city}</span>\n                                  {item.state && <Badge variant=\"secondary\" className=\"text-xs\">{item.state}</Badge>}\n                                </div>\n                                <span className=\"font-medium text-sm\">{item.count}</span>\n                              </div>\n                            ))}\n                          </div>\n                        ) : (\n                          <div className=\"text-center py-8 text-muted-foreground\">\n                            <MapPin className=\"h-12 w-12 mx-auto mb-3 opacity-50\" />\n                            <p>Nenhum dado de cidade</p>\n                          </div>\n                        )}\n                      </CardContent>\n                    </Card>\n                  </div>\n                </>\n              )}\n            </TabsContent>\n          </Tabs>\n        </>\n      )}\n    </div>\n  );\n}\n","path":null,"size_bytes":35647,"size_tokens":null},"client/src/pages/product-analytics.tsx":{"content":"import { useState } from \"react\";\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { \n  RefreshCw, \n  Loader2, \n  TrendingUp, \n  TrendingDown,\n  Package,\n  DollarSign,\n  ShoppingCart,\n  Layers,\n  RotateCcw,\n  AlertTriangle,\n  Zap,\n  Crown,\n  Grid3X3\n} from \"lucide-react\";\nimport { useQuery } from \"@tanstack/react-query\";\n\ninterface ProductRanking {\n  productId: number;\n  name: string;\n  sku: string;\n  brand: string | null;\n  categoryId: number | null;\n  categoryName: string | null;\n  totalRevenue: number;\n  totalQuantity: number;\n  orderCount: number;\n  avgPrice: number;\n  revenueShare: number;\n  growthPercent: number;\n}\n\ninterface ProductABC {\n  productId: number;\n  name: string;\n  sku: string;\n  categoryName: string | null;\n  totalRevenue: number;\n  revenueShare: number;\n  cumulativeShare: number;\n  abcClass: 'A' | 'B' | 'C';\n}\n\ninterface ProductVelocity {\n  productId: number;\n  name: string;\n  sku: string;\n  avgSalesPerDay: number;\n  totalQuantity: number;\n  daysSinceLastSale: number;\n  status: 'fast' | 'normal' | 'slow' | 'stopped';\n}\n\ninterface ProductRepurchase {\n  productId: number;\n  name: string;\n  sku: string;\n  uniqueCustomers: number;\n  repeatCustomers: number;\n  repurchaseRate: number;\n  avgDaysBetweenPurchases: number;\n  singlePurchaseCustomers: number;\n}\n\ninterface ProductCrossSell {\n  productId: number;\n  name: string;\n  pairedProducts: Array<{\n    productId: number;\n    name: string;\n    coOccurrence: number;\n  }>;\n  isLeader: boolean;\n}\n\ninterface CategoryPerformance {\n  categoryId: number;\n  categoryName: string;\n  totalRevenue: number;\n  totalQuantity: number;\n  productCount: number;\n  topProducts: Array<{\n    productId: number;\n    name: string;\n    revenue: number;\n  }>;\n}\n\ninterface ProblematicProduct {\n  productId: number;\n  name: string;\n  sku: string;\n  issue: 'low_turnover' | 'declining' | 'no_sales';\n  metric: number;\n  description: string;\n}\n\ninterface ProductAnalyticsData {\n  overview: {\n    totalRevenue: number;\n    totalQuantitySold: number;\n    avgTicketPerProduct: number;\n    uniqueProductsSold: number;\n  };\n  rankingByRevenue: {\n    days7: ProductRanking[];\n    days30: ProductRanking[];\n    days60: ProductRanking[];\n    days90: ProductRanking[];\n  };\n  rankingByVolume: {\n    days7: ProductRanking[];\n    days30: ProductRanking[];\n    days60: ProductRanking[];\n    days90: ProductRanking[];\n  };\n  topGrowing: ProductRanking[];\n  topDeclining: ProductRanking[];\n  abcAnalysis: {\n    a: ProductABC[];\n    b: ProductABC[];\n    c: ProductABC[];\n  };\n  velocity: ProductVelocity[];\n  repurchase: ProductRepurchase[];\n  crossSell: ProductCrossSell[];\n  categoryPerformance: CategoryPerformance[];\n  problematicProducts: ProblematicProduct[];\n}\n\nfunction formatCurrency(value: number): string {\n  return new Intl.NumberFormat('pt-BR', {\n    style: 'currency',\n    currency: 'BRL'\n  }).format(value);\n}\n\nfunction VelocityBadge({ status }: { status: 'fast' | 'normal' | 'slow' | 'stopped' }) {\n  const variants = {\n    fast: { className: 'bg-green-500/10 text-green-600 dark:text-green-400', label: 'Rápido' },\n    normal: { className: 'bg-blue-500/10 text-blue-600 dark:text-blue-400', label: 'Normal' },\n    slow: { className: 'bg-yellow-500/10 text-yellow-600 dark:text-yellow-400', label: 'Lento' },\n    stopped: { className: 'bg-red-500/10 text-red-600 dark:text-red-400', label: 'Parado' }\n  };\n  const { className, label } = variants[status];\n  return <Badge className={className}>{label}</Badge>;\n}\n\nfunction ABCBadge({ abcClass }: { abcClass: 'A' | 'B' | 'C' }) {\n  const variants = {\n    A: { className: 'bg-green-500/10 text-green-600 dark:text-green-400', label: 'A' },\n    B: { className: 'bg-yellow-500/10 text-yellow-600 dark:text-yellow-400', label: 'B' },\n    C: { className: 'bg-red-500/10 text-red-600 dark:text-red-400', label: 'C' }\n  };\n  const { className, label } = variants[abcClass];\n  return <Badge className={className}>{label}</Badge>;\n}\n\nfunction IssueBadge({ issue }: { issue: 'low_turnover' | 'declining' | 'no_sales' }) {\n  const variants = {\n    low_turnover: { className: 'bg-yellow-500/10 text-yellow-600 dark:text-yellow-400', label: 'Baixo Giro' },\n    declining: { className: 'bg-orange-500/10 text-orange-600 dark:text-orange-400', label: 'Declínio' },\n    no_sales: { className: 'bg-red-500/10 text-red-600 dark:text-red-400', label: 'Sem Vendas' }\n  };\n  const { className, label } = variants[issue];\n  return <Badge className={className}>{label}</Badge>;\n}\n\nfunction RankingTable({ products, showGrowth = false }: { products: ProductRanking[], showGrowth?: boolean }) {\n  if (products.length === 0) {\n    return (\n      <div className=\"text-center py-8 text-muted-foreground\">\n        <Package className=\"h-12 w-12 mx-auto mb-3 opacity-50\" />\n        <p>Nenhum produto encontrado</p>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"overflow-x-auto\">\n      <table className=\"w-full text-sm\">\n        <thead>\n          <tr className=\"border-b\">\n            <th className=\"text-left py-3 px-2 font-medium text-muted-foreground\">#</th>\n            <th className=\"text-left py-3 px-2 font-medium text-muted-foreground\">Produto</th>\n            <th className=\"text-right py-3 px-2 font-medium text-muted-foreground\">Faturamento</th>\n            <th className=\"text-right py-3 px-2 font-medium text-muted-foreground\">Qtd</th>\n            <th className=\"text-right py-3 px-2 font-medium text-muted-foreground\">Pedidos</th>\n            {showGrowth && <th className=\"text-right py-3 px-2 font-medium text-muted-foreground\">Crescimento</th>}\n          </tr>\n        </thead>\n        <tbody>\n          {products.map((product, idx) => (\n            <tr key={product.productId} className=\"border-b last:border-0 hover:bg-muted/50\" data-testid={`row-product-${product.productId}`}>\n              <td className=\"py-3 px-2\">\n                {idx < 3 ? (\n                  <div className={`w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold ${\n                    idx === 0 ? 'bg-yellow-500/20 text-yellow-600' :\n                    idx === 1 ? 'bg-gray-400/20 text-gray-600' :\n                    'bg-orange-500/20 text-orange-600'\n                  }`}>\n                    {idx + 1}\n                  </div>\n                ) : (\n                  <span className=\"text-muted-foreground\">{idx + 1}</span>\n                )}\n              </td>\n              <td className=\"py-3 px-2\">\n                <div>\n                  <p className=\"font-medium\">{product.name}</p>\n                  <p className=\"text-xs text-muted-foreground\">SKU: {product.sku}</p>\n                  {product.categoryName && (\n                    <p className=\"text-xs text-muted-foreground\">{product.categoryName}</p>\n                  )}\n                </div>\n              </td>\n              <td className=\"py-3 px-2 text-right font-medium\">{formatCurrency(product.totalRevenue)}</td>\n              <td className=\"py-3 px-2 text-right\">{product.totalQuantity}</td>\n              <td className=\"py-3 px-2 text-right\">{product.orderCount}</td>\n              {showGrowth && (\n                <td className=\"py-3 px-2 text-right\">\n                  <div className={`flex items-center justify-end gap-1 ${\n                    product.growthPercent > 0 ? 'text-green-600' :\n                    product.growthPercent < 0 ? 'text-red-600' : 'text-muted-foreground'\n                  }`}>\n                    {product.growthPercent > 0 ? <TrendingUp className=\"h-3 w-3\" /> : \n                     product.growthPercent < 0 ? <TrendingDown className=\"h-3 w-3\" /> : null}\n                    {product.growthPercent.toFixed(1)}%\n                  </div>\n                </td>\n              )}\n            </tr>\n          ))}\n        </tbody>\n      </table>\n    </div>\n  );\n}\n\nfunction ABCTable({ products }: { products: ProductABC[] }) {\n  if (products.length === 0) {\n    return (\n      <div className=\"text-center py-8 text-muted-foreground\">\n        <Package className=\"h-12 w-12 mx-auto mb-3 opacity-50\" />\n        <p>Nenhum produto encontrado</p>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"overflow-x-auto\">\n      <table className=\"w-full text-sm\">\n        <thead>\n          <tr className=\"border-b\">\n            <th className=\"text-left py-3 px-2 font-medium text-muted-foreground\">Classe</th>\n            <th className=\"text-left py-3 px-2 font-medium text-muted-foreground\">Produto</th>\n            <th className=\"text-right py-3 px-2 font-medium text-muted-foreground\">Faturamento</th>\n            <th className=\"text-right py-3 px-2 font-medium text-muted-foreground\">% Receita</th>\n            <th className=\"text-right py-3 px-2 font-medium text-muted-foreground\">% Acumulado</th>\n          </tr>\n        </thead>\n        <tbody>\n          {products.map((product) => (\n            <tr key={product.productId} className=\"border-b last:border-0 hover:bg-muted/50\" data-testid={`row-abc-${product.productId}`}>\n              <td className=\"py-3 px-2\">\n                <ABCBadge abcClass={product.abcClass} />\n              </td>\n              <td className=\"py-3 px-2\">\n                <div>\n                  <p className=\"font-medium\">{product.name}</p>\n                  <p className=\"text-xs text-muted-foreground\">SKU: {product.sku}</p>\n                </div>\n              </td>\n              <td className=\"py-3 px-2 text-right font-medium\">{formatCurrency(product.totalRevenue)}</td>\n              <td className=\"py-3 px-2 text-right\">{(product.revenueShare * 100).toFixed(1)}%</td>\n              <td className=\"py-3 px-2 text-right\">{(product.cumulativeShare * 100).toFixed(1)}%</td>\n            </tr>\n          ))}\n        </tbody>\n      </table>\n    </div>\n  );\n}\n\nfunction VelocityTable({ products }: { products: ProductVelocity[] }) {\n  if (products.length === 0) {\n    return (\n      <div className=\"text-center py-8 text-muted-foreground\">\n        <Package className=\"h-12 w-12 mx-auto mb-3 opacity-50\" />\n        <p>Nenhum produto encontrado</p>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"overflow-x-auto\">\n      <table className=\"w-full text-sm\">\n        <thead>\n          <tr className=\"border-b\">\n            <th className=\"text-left py-3 px-2 font-medium text-muted-foreground\">Produto</th>\n            <th className=\"text-left py-3 px-2 font-medium text-muted-foreground\">Status</th>\n            <th className=\"text-right py-3 px-2 font-medium text-muted-foreground\">Vendas/Dia</th>\n            <th className=\"text-right py-3 px-2 font-medium text-muted-foreground\">Total Vendido</th>\n            <th className=\"text-right py-3 px-2 font-medium text-muted-foreground\">Dias s/ Venda</th>\n          </tr>\n        </thead>\n        <tbody>\n          {products.map((product) => (\n            <tr key={product.productId} className=\"border-b last:border-0 hover:bg-muted/50\" data-testid={`row-velocity-${product.productId}`}>\n              <td className=\"py-3 px-2\">\n                <div>\n                  <p className=\"font-medium\">{product.name}</p>\n                  <p className=\"text-xs text-muted-foreground\">SKU: {product.sku}</p>\n                </div>\n              </td>\n              <td className=\"py-3 px-2\">\n                <VelocityBadge status={product.status} />\n              </td>\n              <td className=\"py-3 px-2 text-right font-medium\">{product.avgSalesPerDay.toFixed(2)}</td>\n              <td className=\"py-3 px-2 text-right\">{product.totalQuantity}</td>\n              <td className=\"py-3 px-2 text-right\">{product.daysSinceLastSale}</td>\n            </tr>\n          ))}\n        </tbody>\n      </table>\n    </div>\n  );\n}\n\nfunction RepurchaseTable({ products }: { products: ProductRepurchase[] }) {\n  if (products.length === 0) {\n    return (\n      <div className=\"text-center py-8 text-muted-foreground\">\n        <Package className=\"h-12 w-12 mx-auto mb-3 opacity-50\" />\n        <p>Nenhum produto encontrado</p>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"overflow-x-auto\">\n      <table className=\"w-full text-sm\">\n        <thead>\n          <tr className=\"border-b\">\n            <th className=\"text-left py-3 px-2 font-medium text-muted-foreground\">Produto</th>\n            <th className=\"text-right py-3 px-2 font-medium text-muted-foreground\">Clientes</th>\n            <th className=\"text-right py-3 px-2 font-medium text-muted-foreground\">Recompras</th>\n            <th className=\"text-right py-3 px-2 font-medium text-muted-foreground\">Taxa Recompra</th>\n            <th className=\"text-right py-3 px-2 font-medium text-muted-foreground\">Dias entre Compras</th>\n          </tr>\n        </thead>\n        <tbody>\n          {products.map((product) => (\n            <tr key={product.productId} className=\"border-b last:border-0 hover:bg-muted/50\" data-testid={`row-repurchase-${product.productId}`}>\n              <td className=\"py-3 px-2\">\n                <div>\n                  <p className=\"font-medium\">{product.name}</p>\n                  <p className=\"text-xs text-muted-foreground\">SKU: {product.sku}</p>\n                </div>\n              </td>\n              <td className=\"py-3 px-2 text-right\">{product.uniqueCustomers}</td>\n              <td className=\"py-3 px-2 text-right\">{product.repeatCustomers}</td>\n              <td className=\"py-3 px-2 text-right font-medium\">{(product.repurchaseRate * 100).toFixed(1)}%</td>\n              <td className=\"py-3 px-2 text-right\">{product.avgDaysBetweenPurchases.toFixed(0)}</td>\n            </tr>\n          ))}\n        </tbody>\n      </table>\n    </div>\n  );\n}\n\nfunction CrossSellTable({ products }: { products: ProductCrossSell[] }) {\n  if (products.length === 0) {\n    return (\n      <div className=\"text-center py-8 text-muted-foreground\">\n        <Package className=\"h-12 w-12 mx-auto mb-3 opacity-50\" />\n        <p>Nenhum produto encontrado</p>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"space-y-4\">\n      {products.map((product) => (\n        <Card key={product.productId} className=\"overflow-hidden\" data-testid={`card-crosssell-${product.productId}`}>\n          <CardHeader className=\"pb-2\">\n            <div className=\"flex items-center gap-2\">\n              <CardTitle className=\"text-base\">{product.name}</CardTitle>\n              {product.isLeader && <Badge className=\"bg-primary/10 text-primary\">Líder</Badge>}\n            </div>\n          </CardHeader>\n          <CardContent>\n            <div className=\"flex flex-wrap gap-2\">\n              {product.pairedProducts.length === 0 ? (\n                <p className=\"text-sm text-muted-foreground\">Sem produtos associados</p>\n              ) : (\n                product.pairedProducts.map((paired) => (\n                  <Badge key={paired.productId} variant=\"outline\">\n                    {paired.name} ({paired.coOccurrence}x)\n                  </Badge>\n                ))\n              )}\n            </div>\n          </CardContent>\n        </Card>\n      ))}\n    </div>\n  );\n}\n\nfunction CategoryTable({ categories }: { categories: CategoryPerformance[] }) {\n  if (categories.length === 0) {\n    return (\n      <div className=\"text-center py-8 text-muted-foreground\">\n        <Grid3X3 className=\"h-12 w-12 mx-auto mb-3 opacity-50\" />\n        <p>Nenhuma categoria encontrada</p>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"space-y-4\">\n      {categories.map((category) => (\n        <Card key={category.categoryId} data-testid={`card-category-${category.categoryId}`}>\n          <CardHeader className=\"pb-2\">\n            <div className=\"flex items-center justify-between gap-4 flex-wrap\">\n              <CardTitle className=\"text-base\">{category.categoryName}</CardTitle>\n              <Badge variant=\"outline\">{category.productCount} produtos</Badge>\n            </div>\n            <CardDescription>\n              {formatCurrency(category.totalRevenue)} | {category.totalQuantity} unidades\n            </CardDescription>\n          </CardHeader>\n          <CardContent>\n            <div className=\"space-y-2\">\n              <p className=\"text-xs font-medium text-muted-foreground\">Top 3 Produtos</p>\n              <div className=\"space-y-1\">\n                {category.topProducts.slice(0, 3).map((product, idx) => (\n                  <div key={product.productId} className=\"flex items-center justify-between text-sm\">\n                    <span className=\"flex items-center gap-2\">\n                      <span className=\"text-muted-foreground\">{idx + 1}.</span>\n                      {product.name}\n                    </span>\n                    <span className=\"font-medium\">{formatCurrency(product.revenue)}</span>\n                  </div>\n                ))}\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n      ))}\n    </div>\n  );\n}\n\nfunction ProblematicTable({ products }: { products: ProblematicProduct[] }) {\n  if (products.length === 0) {\n    return (\n      <div className=\"text-center py-8 text-muted-foreground\">\n        <AlertTriangle className=\"h-12 w-12 mx-auto mb-3 opacity-50\" />\n        <p>Nenhum produto problemático encontrado</p>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"overflow-x-auto\">\n      <table className=\"w-full text-sm\">\n        <thead>\n          <tr className=\"border-b\">\n            <th className=\"text-left py-3 px-2 font-medium text-muted-foreground\">Produto</th>\n            <th className=\"text-left py-3 px-2 font-medium text-muted-foreground\">Problema</th>\n            <th className=\"text-left py-3 px-2 font-medium text-muted-foreground\">Descrição</th>\n          </tr>\n        </thead>\n        <tbody>\n          {products.map((product) => (\n            <tr key={product.productId} className=\"border-b last:border-0 hover:bg-muted/50\" data-testid={`row-problematic-${product.productId}`}>\n              <td className=\"py-3 px-2\">\n                <div>\n                  <p className=\"font-medium\">{product.name}</p>\n                  <p className=\"text-xs text-muted-foreground\">SKU: {product.sku}</p>\n                </div>\n              </td>\n              <td className=\"py-3 px-2\">\n                <IssueBadge issue={product.issue} />\n              </td>\n              <td className=\"py-3 px-2 text-muted-foreground\">{product.description}</td>\n            </tr>\n          ))}\n        </tbody>\n      </table>\n    </div>\n  );\n}\n\nexport default function ProductAnalyticsPage() {\n  const [rankingPeriod, setRankingPeriod] = useState<'days7' | 'days30' | 'days60' | 'days90'>('days30');\n  const [rankingType, setRankingType] = useState<'revenue' | 'volume'>('revenue');\n\n  const { data: analytics, isLoading, refetch } = useQuery<ProductAnalyticsData>({\n    queryKey: ['/api/admin/product-analytics'],\n  });\n\n  const periodLabels = {\n    days7: '7 dias',\n    days30: '30 dias',\n    days60: '60 dias',\n    days90: '90 dias',\n  };\n\n  const currentRanking = rankingType === 'revenue' \n    ? analytics?.rankingByRevenue[rankingPeriod] || []\n    : analytics?.rankingByVolume[rankingPeriod] || [];\n\n  return (\n    <div className=\"p-4 lg:p-6 space-y-6\">\n      <div className=\"flex items-center justify-between gap-4 flex-wrap\">\n        <div>\n          <h1 className=\"text-2xl lg:text-3xl font-bold\" data-testid=\"text-page-title\">Análise de Produtos</h1>\n          <p className=\"text-sm text-muted-foreground mt-0.5\">\n            Métricas e insights sobre seu catálogo de produtos\n          </p>\n        </div>\n        <Button variant=\"outline\" onClick={() => refetch()} data-testid=\"button-refresh-analytics\">\n          <RefreshCw className=\"h-4 w-4 mr-2\" />\n          Atualizar\n        </Button>\n      </div>\n\n      {isLoading ? (\n        <div className=\"flex items-center justify-center py-16\">\n          <Loader2 className=\"h-10 w-10 animate-spin text-muted-foreground\" />\n        </div>\n      ) : (\n        <>\n          <div className=\"grid grid-cols-2 lg:grid-cols-4 gap-4\">\n            <Card>\n              <CardContent className=\"p-4\">\n                <div className=\"flex items-center gap-3\">\n                  <div className=\"p-2 rounded-lg bg-green-500/10\">\n                    <DollarSign className=\"h-5 w-5 text-green-500\" />\n                  </div>\n                  <div>\n                    <p className=\"text-2xl font-bold\" data-testid=\"stat-total-revenue\">\n                      {formatCurrency(analytics?.overview.totalRevenue || 0)}\n                    </p>\n                    <p className=\"text-xs text-muted-foreground\">Faturamento Total</p>\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n\n            <Card>\n              <CardContent className=\"p-4\">\n                <div className=\"flex items-center gap-3\">\n                  <div className=\"p-2 rounded-lg bg-blue-500/10\">\n                    <ShoppingCart className=\"h-5 w-5 text-blue-500\" />\n                  </div>\n                  <div>\n                    <p className=\"text-2xl font-bold\" data-testid=\"stat-total-quantity\">\n                      {analytics?.overview.totalQuantitySold || 0}\n                    </p>\n                    <p className=\"text-xs text-muted-foreground\">Qtd Vendida</p>\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n\n            <Card>\n              <CardContent className=\"p-4\">\n                <div className=\"flex items-center gap-3\">\n                  <div className=\"p-2 rounded-lg bg-purple-500/10\">\n                    <DollarSign className=\"h-5 w-5 text-purple-500\" />\n                  </div>\n                  <div>\n                    <p className=\"text-2xl font-bold\" data-testid=\"stat-avg-ticket\">\n                      {formatCurrency(analytics?.overview.avgTicketPerProduct || 0)}\n                    </p>\n                    <p className=\"text-xs text-muted-foreground\">Ticket Médio</p>\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n\n            <Card>\n              <CardContent className=\"p-4\">\n                <div className=\"flex items-center gap-3\">\n                  <div className=\"p-2 rounded-lg bg-cyan-500/10\">\n                    <Package className=\"h-5 w-5 text-cyan-500\" />\n                  </div>\n                  <div>\n                    <p className=\"text-2xl font-bold\" data-testid=\"stat-unique-products\">\n                      {analytics?.overview.uniqueProductsSold || 0}\n                    </p>\n                    <p className=\"text-xs text-muted-foreground\">Produtos Vendidos</p>\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n          </div>\n\n          <Tabs defaultValue=\"ranking\" className=\"space-y-4\">\n            <TabsList data-testid=\"tabs-analytics\" className=\"flex-wrap h-auto gap-1\">\n              <TabsTrigger value=\"ranking\" data-testid=\"tab-ranking\">\n                <Crown className=\"h-4 w-4 mr-2\" />\n                Ranking\n              </TabsTrigger>\n              <TabsTrigger value=\"abc\" data-testid=\"tab-abc\">\n                <Layers className=\"h-4 w-4 mr-2\" />\n                Curva ABC\n              </TabsTrigger>\n              <TabsTrigger value=\"velocity\" data-testid=\"tab-velocity\">\n                <Zap className=\"h-4 w-4 mr-2\" />\n                Giro\n              </TabsTrigger>\n              <TabsTrigger value=\"repurchase\" data-testid=\"tab-repurchase\">\n                <RotateCcw className=\"h-4 w-4 mr-2\" />\n                Recompra\n              </TabsTrigger>\n              <TabsTrigger value=\"crosssell\" data-testid=\"tab-crosssell\">\n                <Package className=\"h-4 w-4 mr-2\" />\n                Cross-sell\n              </TabsTrigger>\n              <TabsTrigger value=\"category\" data-testid=\"tab-category\">\n                <Grid3X3 className=\"h-4 w-4 mr-2\" />\n                Categoria\n              </TabsTrigger>\n              <TabsTrigger value=\"problems\" data-testid=\"tab-problems\">\n                <AlertTriangle className=\"h-4 w-4 mr-2\" />\n                Problemas\n              </TabsTrigger>\n            </TabsList>\n\n            <TabsContent value=\"ranking\" className=\"space-y-4\">\n              <Card>\n                <CardHeader className=\"pb-2\">\n                  <div className=\"flex items-center justify-between gap-4 flex-wrap\">\n                    <div>\n                      <CardTitle className=\"text-lg\">Ranking de Produtos</CardTitle>\n                      <CardDescription>Os produtos mais vendidos no período</CardDescription>\n                    </div>\n                    <div className=\"flex gap-2 flex-wrap\">\n                      <div className=\"flex gap-1\">\n                        <Button\n                          variant={rankingType === 'revenue' ? 'default' : 'outline'}\n                          size=\"sm\"\n                          onClick={() => setRankingType('revenue')}\n                          data-testid=\"button-type-revenue\"\n                        >\n                          Faturamento\n                        </Button>\n                        <Button\n                          variant={rankingType === 'volume' ? 'default' : 'outline'}\n                          size=\"sm\"\n                          onClick={() => setRankingType('volume')}\n                          data-testid=\"button-type-volume\"\n                        >\n                          Volume\n                        </Button>\n                      </div>\n                      <div className=\"flex gap-1\">\n                        {(['days7', 'days30', 'days60', 'days90'] as const).map((period) => (\n                          <Button\n                            key={period}\n                            variant={rankingPeriod === period ? 'default' : 'outline'}\n                            size=\"sm\"\n                            onClick={() => setRankingPeriod(period)}\n                            data-testid={`button-period-${period}`}\n                          >\n                            {periodLabels[period]}\n                          </Button>\n                        ))}\n                      </div>\n                    </div>\n                  </div>\n                </CardHeader>\n                <CardContent>\n                  <RankingTable products={currentRanking} />\n                </CardContent>\n              </Card>\n\n              <div className=\"grid lg:grid-cols-2 gap-4\">\n                <Card>\n                  <CardHeader className=\"pb-2\">\n                    <div className=\"flex items-center gap-2\">\n                      <TrendingUp className=\"h-5 w-5 text-green-500\" />\n                      <CardTitle className=\"text-lg\">Em Crescimento</CardTitle>\n                    </div>\n                    <CardDescription>Produtos com maior crescimento em vendas</CardDescription>\n                  </CardHeader>\n                  <CardContent>\n                    <RankingTable products={analytics?.topGrowing || []} showGrowth />\n                  </CardContent>\n                </Card>\n\n                <Card>\n                  <CardHeader className=\"pb-2\">\n                    <div className=\"flex items-center gap-2\">\n                      <TrendingDown className=\"h-5 w-5 text-red-500\" />\n                      <CardTitle className=\"text-lg\">Em Declínio</CardTitle>\n                    </div>\n                    <CardDescription>Produtos com queda em vendas</CardDescription>\n                  </CardHeader>\n                  <CardContent>\n                    <RankingTable products={analytics?.topDeclining || []} showGrowth />\n                  </CardContent>\n                </Card>\n              </div>\n            </TabsContent>\n\n            <TabsContent value=\"abc\" className=\"space-y-4\">\n              <div className=\"grid lg:grid-cols-3 gap-4\">\n                <Card>\n                  <CardHeader className=\"pb-2\">\n                    <div className=\"flex items-center gap-2\">\n                      <ABCBadge abcClass=\"A\" />\n                      <CardTitle className=\"text-lg\">Classe A</CardTitle>\n                    </div>\n                    <CardDescription>~80% do faturamento ({analytics?.abcAnalysis.a.length || 0} produtos)</CardDescription>\n                  </CardHeader>\n                  <CardContent>\n                    <ABCTable products={analytics?.abcAnalysis.a || []} />\n                  </CardContent>\n                </Card>\n\n                <Card>\n                  <CardHeader className=\"pb-2\">\n                    <div className=\"flex items-center gap-2\">\n                      <ABCBadge abcClass=\"B\" />\n                      <CardTitle className=\"text-lg\">Classe B</CardTitle>\n                    </div>\n                    <CardDescription>~15% do faturamento ({analytics?.abcAnalysis.b.length || 0} produtos)</CardDescription>\n                  </CardHeader>\n                  <CardContent>\n                    <ABCTable products={analytics?.abcAnalysis.b || []} />\n                  </CardContent>\n                </Card>\n\n                <Card>\n                  <CardHeader className=\"pb-2\">\n                    <div className=\"flex items-center gap-2\">\n                      <ABCBadge abcClass=\"C\" />\n                      <CardTitle className=\"text-lg\">Classe C</CardTitle>\n                    </div>\n                    <CardDescription>~5% do faturamento ({analytics?.abcAnalysis.c.length || 0} produtos)</CardDescription>\n                  </CardHeader>\n                  <CardContent>\n                    <ABCTable products={analytics?.abcAnalysis.c || []} />\n                  </CardContent>\n                </Card>\n              </div>\n            </TabsContent>\n\n            <TabsContent value=\"velocity\" className=\"space-y-4\">\n              <Card>\n                <CardHeader className=\"pb-2\">\n                  <CardTitle className=\"text-lg\">Velocidade de Vendas</CardTitle>\n                  <CardDescription>Análise do giro de estoque por produto</CardDescription>\n                </CardHeader>\n                <CardContent>\n                  <VelocityTable products={analytics?.velocity || []} />\n                </CardContent>\n              </Card>\n            </TabsContent>\n\n            <TabsContent value=\"repurchase\" className=\"space-y-4\">\n              <Card>\n                <CardHeader className=\"pb-2\">\n                  <CardTitle className=\"text-lg\">Taxa de Recompra</CardTitle>\n                  <CardDescription>Produtos com maior fidelização de clientes</CardDescription>\n                </CardHeader>\n                <CardContent>\n                  <RepurchaseTable products={analytics?.repurchase || []} />\n                </CardContent>\n              </Card>\n            </TabsContent>\n\n            <TabsContent value=\"crosssell\" className=\"space-y-4\">\n              <Card>\n                <CardHeader className=\"pb-2\">\n                  <CardTitle className=\"text-lg\">Produtos Complementares</CardTitle>\n                  <CardDescription>Produtos frequentemente comprados juntos</CardDescription>\n                </CardHeader>\n                <CardContent>\n                  <CrossSellTable products={analytics?.crossSell || []} />\n                </CardContent>\n              </Card>\n            </TabsContent>\n\n            <TabsContent value=\"category\" className=\"space-y-4\">\n              <Card>\n                <CardHeader className=\"pb-2\">\n                  <CardTitle className=\"text-lg\">Desempenho por Categoria</CardTitle>\n                  <CardDescription>Performance de vendas por categoria de produto</CardDescription>\n                </CardHeader>\n                <CardContent>\n                  <CategoryTable categories={analytics?.categoryPerformance || []} />\n                </CardContent>\n              </Card>\n            </TabsContent>\n\n            <TabsContent value=\"problems\" className=\"space-y-4\">\n              <Card>\n                <CardHeader className=\"pb-2\">\n                  <CardTitle className=\"text-lg\">Produtos Problemáticos</CardTitle>\n                  <CardDescription>Produtos que precisam de atenção</CardDescription>\n                </CardHeader>\n                <CardContent>\n                  <ProblematicTable products={analytics?.problematicProducts || []} />\n                </CardContent>\n              </Card>\n            </TabsContent>\n          </Tabs>\n        </>\n      )}\n    </div>\n  );\n}\n","path":null,"size_bytes":32399,"size_tokens":null},"client/src/pages/login.tsx":{"content":"import { useState } from \"react\";\nimport { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { z } from \"zod\";\nimport { useMutation } from \"@tanstack/react-query\";\nimport { useLocation } from \"wouter\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport {\n  Form,\n  FormControl,\n  FormField,\n  FormItem,\n  FormMessage,\n} from \"@/components/ui/form\";\nimport { Alert, AlertDescription } from \"@/components/ui/alert\";\nimport { Loader2, Eye, EyeOff, Phone } from \"lucide-react\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport logoImage from \"@assets/image_1765659931449.png\";\n\nconst loginSchema = z.object({\n  email: z.string().min(1, \"Campo obrigatorio\"),\n  password: z.string().min(1, \"Senha obrigatoria\"),\n});\n\ntype LoginData = z.infer<typeof loginSchema>;\n\nexport default function LoginPage() {\n  const [, setLocation] = useLocation();\n  const [error, setError] = useState<string | null>(null);\n  const [showPassword, setShowPassword] = useState(false);\n\n  const form = useForm<LoginData>({\n    resolver: zodResolver(loginSchema),\n    defaultValues: {\n      email: \"\",\n      password: \"\",\n    },\n  });\n\n  const loginMutation = useMutation({\n    mutationFn: async (data: LoginData) => {\n      const response = await apiRequest(\"POST\", \"/api/auth/login\", data);\n      return response.json();\n    },\n    onSuccess: (data: { user: { role: string } }) => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/auth/user\"] });\n      \n      // Handle redirect after login (e.g., from checkout flow)\n      const urlParams = new URLSearchParams(window.location.search);\n      const redirectTo = urlParams.get('redirect');\n      const step = urlParams.get('step');\n      \n      if (redirectTo) {\n        const redirectUrl = step ? `${redirectTo}?step=${step}` : redirectTo;\n        setLocation(redirectUrl);\n      } else if (data.user?.role === \"supplier\") {\n        setLocation(\"/brand-analytics\");\n      } else {\n        setLocation(\"/\");\n      }\n    },\n    onError: (err: Error) => {\n      setError(err.message || \"E-mail ou senha incorretos\");\n    },\n  });\n\n  const handleSubmit = (data: LoginData) => {\n    setError(null);\n    loginMutation.mutate(data);\n  };\n\n  return (\n    <div className=\"min-h-screen bg-zinc-900 flex flex-col items-center justify-center p-4\">\n      <div className=\"w-full max-w-md\">\n        <div className=\"text-center mb-8\">\n          <div className=\"flex justify-center mb-4\">\n            <img \n              src={logoImage} \n              alt=\"Lojamadrugadao\" \n              className=\"h-24 w-24 rounded-full border-4 border-white/10\"\n            />\n          </div>\n          <h1 className=\"text-2xl font-bold text-white tracking-wide\">\n            LOJAMADRUGADAO SAO PAULO\n          </h1>\n          <div className=\"flex items-center justify-center gap-2 mt-2 text-zinc-400\">\n            <Phone className=\"h-4 w-4\" />\n            <span>11 99294-0168</span>\n          </div>\n        </div>\n\n        {error && (\n          <Alert variant=\"destructive\" className=\"mb-4\">\n            <AlertDescription>{error}</AlertDescription>\n          </Alert>\n        )}\n\n        <Form {...form}>\n          <form onSubmit={form.handleSubmit(handleSubmit)} className=\"space-y-4\">\n            <FormField\n              control={form.control}\n              name=\"email\"\n              render={({ field }) => (\n                <FormItem>\n                  <FormControl>\n                    <Input\n                      type=\"text\"\n                      placeholder=\"Email ou CPF/CNPJ\"\n                      className=\"h-12 bg-zinc-800 border-zinc-700 text-white placeholder:text-zinc-500 focus:border-orange-500\"\n                      {...field}\n                      data-testid=\"input-login-email\"\n                    />\n                  </FormControl>\n                  <FormMessage />\n                </FormItem>\n              )}\n            />\n\n            <FormField\n              control={form.control}\n              name=\"password\"\n              render={({ field }) => (\n                <FormItem>\n                  <FormControl>\n                    <div className=\"relative\">\n                      <Input\n                        type={showPassword ? \"text\" : \"password\"}\n                        placeholder=\"Senha\"\n                        className=\"h-12 bg-zinc-800 border-zinc-700 text-white placeholder:text-zinc-500 pr-12 focus:border-orange-500\"\n                        {...field}\n                        data-testid=\"input-login-password\"\n                      />\n                      <Button\n                        type=\"button\"\n                        variant=\"ghost\"\n                        size=\"icon\"\n                        className=\"absolute right-0 top-0 h-full px-3 text-zinc-400 hover:text-white hover:bg-transparent\"\n                        onClick={() => setShowPassword(!showPassword)}\n                        data-testid=\"button-toggle-password\"\n                      >\n                        {showPassword ? (\n                          <EyeOff className=\"h-5 w-5\" />\n                        ) : (\n                          <Eye className=\"h-5 w-5\" />\n                        )}\n                      </Button>\n                    </div>\n                  </FormControl>\n                  <FormMessage />\n                </FormItem>\n              )}\n            />\n\n            <Button\n              type=\"submit\"\n              className=\"w-full h-12 bg-orange-500 hover:bg-orange-600 text-white font-semibold text-lg\"\n              disabled={loginMutation.isPending}\n              data-testid=\"button-login-submit\"\n            >\n              {loginMutation.isPending ? (\n                <>\n                  <Loader2 className=\"mr-2 h-5 w-5 animate-spin\" />\n                  Acessando...\n                </>\n              ) : (\n                \"Acessar\"\n              )}\n            </Button>\n          </form>\n        </Form>\n\n        <div className=\"flex items-center justify-between mt-6\">\n          <Button\n            variant=\"link\"\n            className=\"p-0 h-auto text-orange-500 hover:text-orange-400 font-normal\"\n            onClick={() => {}}\n            data-testid=\"link-forgot-password\"\n          >\n            Esqueci minha senha\n          </Button>\n          <Button\n            variant=\"link\"\n            className=\"p-0 h-auto text-orange-500 hover:text-orange-400 font-normal\"\n            onClick={() => setLocation(\"/register\")}\n            data-testid=\"link-register\"\n          >\n            Solicitar acesso\n          </Button>\n        </div>\n\n        <div className=\"mt-12 text-center\">\n          <Button\n            variant=\"link\"\n            className=\"text-zinc-400 hover:text-zinc-300\"\n            onClick={() => setLocation(\"/catalogo\")}\n            data-testid=\"link-public-catalog\"\n          >\n            Continuar visualizando o catalogo sem precos\n          </Button>\n        </div>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":7001,"size_tokens":null},"client/src/pages/public-catalog.tsx":{"content":"import { useState, useMemo, useEffect } from \"react\";\nimport { useLocation, useSearch } from \"wouter\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport { \n  Search, \n  Loader2, \n  Package, \n  ChevronLeft, \n  ChevronRight,\n  Store,\n  Phone,\n  X,\n  Grid3X3,\n  List,\n  Home,\n  Filter,\n  ShoppingCart,\n  User,\n  UserPlus\n} from \"lucide-react\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport type { Product as SchemaProduct, Category } from \"@shared/schema\";\nimport { ThemeToggle } from \"@/components/ThemeToggle\";\nimport { useCart } from \"@/contexts/CartContext\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { DeliveryCatalog } from \"@/components/DeliveryCatalog\";\nimport logoImage from \"@assets/image_1765659931449.png\";\n\ninterface ProductsResponse {\n  products: SchemaProduct[];\n  total: number;\n  page: number;\n  totalPages: number;\n}\n\nexport default function PublicCatalogPage() {\n  const searchString = useSearch();\n  const [, setLocation] = useLocation();\n  const [searchQuery, setSearchQuery] = useState(\"\");\n  const [category, setCategory] = useState(\"all\");\n  const [brand, setBrand] = useState(\"all\");\n  const [page, setPage] = useState(1);\n  const [selectedCategoryId, setSelectedCategoryId] = useState<number | undefined>(undefined);\n  const [viewMode, setViewMode] = useState<\"grid\" | \"list\">(\"grid\");\n  const [showMobileFilters, setShowMobileFilters] = useState(false);\n  const [quantities, setQuantities] = useState<Record<number, number>>({});\n  \n  const { addItem, itemCount, openCart } = useCart();\n  const { toast } = useToast();\n\n  const { data: categoriesData = [] } = useQuery<Category[]>({\n    queryKey: ['/api/public/categories'],\n    queryFn: async () => {\n      const res = await fetch('/api/public/categories');\n      if (!res.ok) throw new Error('Failed to fetch categories');\n      return res.json();\n    },\n  });\n\n  const { data: deliveryModeSetting } = useQuery<{ key: string; value: string | null }>({\n    queryKey: ['/api/settings/delivery_catalog_mode'],\n  });\n\n  const isDeliveryMode = deliveryModeSetting?.value === 'true';\n\n  useEffect(() => {\n    const params = new URLSearchParams(searchString);\n    const categoryParam = params.get(\"category\");\n    const searchParam = params.get(\"search\");\n    if (categoryParam) {\n      const decodedCategory = decodeURIComponent(categoryParam);\n      setCategory(decodedCategory);\n      const cat = categoriesData.find(c => c.name === decodedCategory);\n      if (cat) {\n        setSelectedCategoryId(cat.id);\n      }\n    }\n    if (searchParam) {\n      setSearchQuery(decodeURIComponent(searchParam));\n    }\n  }, [searchString, categoriesData]);\n\n  useEffect(() => {\n    if (category === \"all\") {\n      setSelectedCategoryId(undefined);\n    } else {\n      const cat = categoriesData.find(c => c.name === category);\n      setSelectedCategoryId(cat?.id);\n    }\n    setPage(1);\n  }, [category, categoriesData]);\n\n  useEffect(() => {\n    setPage(1);\n  }, [searchQuery, brand]);\n\n  const queryParams = useMemo(() => {\n    const params = new URLSearchParams();\n    params.set('page', String(page));\n    params.set('limit', '24');\n    if (selectedCategoryId) params.set('categoryId', String(selectedCategoryId));\n    if (searchQuery) params.set('search', searchQuery);\n    return params.toString();\n  }, [page, selectedCategoryId, searchQuery]);\n\n  const { data: productsResponse, isLoading: productsLoading } = useQuery<ProductsResponse>({\n    queryKey: ['/api/public/products', queryParams],\n    queryFn: async () => {\n      const res = await fetch(`/api/public/products?${queryParams}`);\n      if (!res.ok) throw new Error('Failed to fetch products');\n      return res.json();\n    },\n  });\n\n  const productsData = productsResponse?.products || [];\n  const totalPages = productsResponse?.totalPages || 1;\n  const totalProducts = productsResponse?.total || 0;\n\n  const categoryMap = useMemo(() => {\n    const map: Record<number, string> = {};\n    categoriesData.forEach(cat => {\n      map[cat.id] = cat.name;\n    });\n    return map;\n  }, [categoriesData]);\n\n  const brands = useMemo(() => {\n    const brandSet = new Set<string>();\n    productsData.forEach(p => {\n      if (p.brand) brandSet.add(p.brand);\n    });\n    return Array.from(brandSet).sort();\n  }, [productsData]);\n\n  const filteredProducts = useMemo(() => {\n    return productsData.filter((product) => {\n      const matchesBrand = brand === \"all\" || product.brand === brand;\n      return matchesBrand;\n    });\n  }, [productsData, brand]);\n\n  const clearFilters = () => {\n    setSearchQuery(\"\");\n    setCategory(\"all\");\n    setBrand(\"all\");\n    setLocation(\"/catalogo\");\n  };\n\n  const formatPrice = (price: string | number) => {\n    const numPrice = typeof price === 'string' ? parseFloat(price) : price;\n    return new Intl.NumberFormat('pt-BR', {\n      style: 'currency',\n      currency: 'BRL'\n    }).format(numPrice);\n  };\n\n  const hasFilters = searchQuery || category !== \"all\" || brand !== \"all\";\n\n  const handleSearch = (e: React.FormEvent) => {\n    e.preventDefault();\n  };\n\n  const selectCategory = (catName: string) => {\n    setCategory(catName);\n    setShowMobileFilters(false);\n  };\n\n  const getQuantity = (productId: number) => quantities[productId] ?? 0;\n\n  const setQuantity = (productId: number, qty: number) => {\n    if (qty < 0) qty = 0;\n    if (qty > 999) qty = 999;\n    setQuantities(prev => ({ ...prev, [productId]: qty }));\n  };\n\n  const handleAddToCart = (product: SchemaProduct) => {\n    const qty = getQuantity(product.id);\n    if (qty <= 0) {\n      toast({\n        title: \"Informe a quantidade\",\n        description: \"Digite a quantidade desejada\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n    \n    const price = typeof product.price === 'string' ? parseFloat(product.price) : product.price;\n    \n    addItem({\n      productId: String(product.id),\n      name: product.name,\n      sku: product.sku,\n      price: price,\n      quantity: qty,\n      image: product.image || undefined,\n    });\n\n    toast({\n      title: \"Adicionado ao carrinho\",\n      description: `${qty}x ${product.name}`,\n    });\n\n    setQuantities(prev => ({ ...prev, [product.id]: 0 }));\n  };\n\n  if (isDeliveryMode) {\n    return (\n      <div className=\"min-h-screen bg-background\">\n        <header className=\"sticky top-0 z-50 bg-zinc-900 text-white\">\n          <div className=\"container mx-auto px-4 py-3\">\n            <div className=\"flex items-center justify-between gap-4\">\n              <div className=\"flex items-center gap-3\">\n                <img \n                  src={logoImage} \n                  alt=\"Lojamadrugadao\" \n                  className=\"h-10 w-10 rounded-full border-2 border-white/20 cursor-pointer\"\n                  onClick={() => setLocation(\"/\")}\n                  data-testid=\"img-logo\"\n                />\n                <div className=\"hidden sm:block\">\n                  <h1 className=\"font-bold text-sm tracking-wide cursor-pointer\" onClick={() => setLocation(\"/\")}>\n                    LOJAMADRUGADAO\n                  </h1>\n                </div>\n              </div>\n              <div className=\"flex items-center gap-2\">\n                <ThemeToggle />\n                <Button\n                  variant=\"ghost\"\n                  size=\"sm\"\n                  className=\"text-white relative\"\n                  onClick={openCart}\n                  data-testid=\"button-cart\"\n                >\n                  <ShoppingCart className=\"h-5 w-5\" />\n                  {itemCount > 0 && (\n                    <Badge className=\"absolute -top-1 -right-1 h-5 min-w-[20px] flex items-center justify-center text-xs\">\n                      {itemCount}\n                    </Badge>\n                  )}\n                </Button>\n                <Button\n                  variant=\"ghost\"\n                  size=\"sm\"\n                  className=\"text-white\"\n                  onClick={() => setLocation(\"/login\")}\n                  data-testid=\"button-login\"\n                >\n                  <User className=\"h-5 w-5\" />\n                </Button>\n              </div>\n            </div>\n          </div>\n        </header>\n        <DeliveryCatalog isPublic={true} />\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"min-h-screen bg-background flex flex-col\">\n      <header className=\"sticky top-0 z-50 bg-zinc-900 text-white\">\n        <div className=\"container mx-auto px-4 py-3\">\n          <div className=\"flex items-center justify-between gap-4\">\n            <div className=\"flex items-center gap-3\">\n              <img \n                src={logoImage} \n                alt=\"Lojamadrugadao\" \n                className=\"h-10 w-10 rounded-full border-2 border-white/20 cursor-pointer\"\n                onClick={() => setLocation(\"/\")}\n                data-testid=\"img-logo\"\n              />\n              <div className=\"hidden sm:block\">\n                <h1 className=\"font-bold text-sm tracking-wide cursor-pointer\" onClick={() => setLocation(\"/\")}>\n                  LOJAMADRUGADAO\n                </h1>\n                <div \n                  className=\"flex items-center gap-1 text-zinc-400 text-xs cursor-pointer select-none\"\n                  onDoubleClick={() => setLocation(\"/login\")}\n                  data-testid=\"phone-employee-login\"\n                >\n                  <Phone className=\"h-3 w-3\" />\n                  <span>11 99294-0168</span>\n                </div>\n              </div>\n            </div>\n\n            <form onSubmit={handleSearch} className=\"hidden md:flex flex-1 max-w-lg mx-4\">\n              <div className=\"relative w-full\">\n                <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-zinc-400\" />\n                <Input\n                  placeholder=\"Buscar produtos...\"\n                  value={searchQuery}\n                  onChange={(e) => setSearchQuery(e.target.value)}\n                  className=\"pl-10 bg-zinc-800 border-zinc-700 text-white placeholder:text-zinc-500\"\n                  data-testid=\"input-search-header\"\n                />\n              </div>\n            </form>\n\n            <div className=\"flex items-center gap-2\">\n              <Button \n                variant=\"ghost\"\n                size=\"icon\"\n                onClick={() => setLocation(\"/\")}\n                className=\"text-white hover:bg-zinc-800\"\n                data-testid=\"button-home\"\n              >\n                <Home className=\"h-5 w-5\" />\n              </Button>\n              \n              <Button \n                variant=\"ghost\"\n                size=\"icon\"\n                className=\"text-white hover:bg-zinc-800 relative\"\n                onClick={openCart}\n                data-testid=\"button-cart\"\n              >\n                <ShoppingCart className=\"h-5 w-5\" />\n                {itemCount > 0 && (\n                  <span className=\"absolute -top-1 -right-1 bg-orange-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center font-medium\">\n                    {itemCount > 99 ? \"99+\" : itemCount}\n                  </span>\n                )}\n              </Button>\n              \n              <Button \n                variant=\"ghost\"\n                size=\"sm\"\n                onClick={() => setLocation(\"/login\")}\n                className=\"text-white hover:bg-zinc-800 hidden sm:flex\"\n                data-testid=\"button-login\"\n              >\n                <User className=\"h-4 w-4 mr-1\" />\n                Entrar\n              </Button>\n              \n              <Button \n                variant=\"ghost\"\n                size=\"sm\"\n                onClick={() => setLocation(\"/register\")}\n                className=\"text-white hover:bg-zinc-800 hidden sm:flex\"\n                data-testid=\"button-register\"\n              >\n                <UserPlus className=\"h-4 w-4 mr-1\" />\n                Cadastrar\n              </Button>\n              \n              <Button \n                onClick={() => setLocation(\"/login\")}\n                className=\"bg-orange-500 hover:bg-orange-600 text-white\"\n                data-testid=\"button-atacado-login\"\n              >\n                <Store className=\"h-4 w-4 mr-2\" />\n                <span className=\"hidden sm:inline\">Atacado</span>\n              </Button>\n              <ThemeToggle />\n            </div>\n          </div>\n        </div>\n      </header>\n\n      <div className=\"flex flex-1\">\n        <aside className=\"hidden lg:block w-64 border-r bg-muted/30 shrink-0\">\n          <ScrollArea className=\"h-[calc(100vh-64px)]\">\n            <div className=\"p-4\">\n              <h2 className=\"font-semibold text-sm uppercase tracking-wide text-muted-foreground mb-3\">\n                Categorias\n              </h2>\n              <div className=\"space-y-1\">\n                <Button\n                  variant={category === \"all\" ? \"secondary\" : \"ghost\"}\n                  className=\"w-full justify-start text-sm h-9\"\n                  onClick={() => selectCategory(\"all\")}\n                  data-testid=\"button-category-all\"\n                >\n                  Todas as Categorias\n                  <Badge variant=\"outline\" className=\"ml-auto text-xs\">\n                    {totalProducts}\n                  </Badge>\n                </Button>\n                {categoriesData.map(cat => (\n                  <Button\n                    key={cat.id}\n                    variant={category === cat.name ? \"secondary\" : \"ghost\"}\n                    className=\"w-full justify-start text-sm h-9\"\n                    onClick={() => selectCategory(cat.name)}\n                    data-testid={`button-category-${cat.id}`}\n                  >\n                    {cat.name}\n                  </Button>\n                ))}\n              </div>\n\n              {brands.length > 0 && (\n                <>\n                  <h2 className=\"font-semibold text-sm uppercase tracking-wide text-muted-foreground mb-3 mt-6\">\n                    Marcas\n                  </h2>\n                  <div className=\"space-y-1\">\n                    <Button\n                      variant={brand === \"all\" ? \"secondary\" : \"ghost\"}\n                      className=\"w-full justify-start text-sm h-9\"\n                      onClick={() => setBrand(\"all\")}\n                      data-testid=\"button-brand-all\"\n                    >\n                      Todas as Marcas\n                    </Button>\n                    {brands.map(b => (\n                      <Button\n                        key={b}\n                        variant={brand === b ? \"secondary\" : \"ghost\"}\n                        className=\"w-full justify-start text-sm h-9\"\n                        onClick={() => setBrand(b)}\n                        data-testid={`button-brand-${b}`}\n                      >\n                        {b}\n                      </Button>\n                    ))}\n                  </div>\n                </>\n              )}\n            </div>\n          </ScrollArea>\n        </aside>\n\n        <main className=\"flex-1 flex flex-col min-w-0\">\n          <div className=\"border-b bg-background sticky top-[64px] z-40\">\n            <div className=\"p-4\">\n              <form onSubmit={handleSearch} className=\"md:hidden mb-3\">\n                <div className=\"relative\">\n                  <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\n                  <Input\n                    placeholder=\"Buscar produtos...\"\n                    value={searchQuery}\n                    onChange={(e) => setSearchQuery(e.target.value)}\n                    className=\"pl-10\"\n                    data-testid=\"input-search-mobile\"\n                  />\n                </div>\n              </form>\n\n              <div className=\"flex items-center justify-between gap-3 flex-wrap\">\n                <div className=\"flex items-center gap-2\">\n                  <Button\n                    variant=\"outline\"\n                    size=\"sm\"\n                    className=\"lg:hidden\"\n                    onClick={() => setShowMobileFilters(!showMobileFilters)}\n                    data-testid=\"button-toggle-filters\"\n                  >\n                    <Filter className=\"h-4 w-4 mr-1\" />\n                    Filtros\n                  </Button>\n                  \n                  <div className=\"text-sm text-muted-foreground\">\n                    <span className=\"font-medium text-foreground\">{filteredProducts.length}</span> produtos\n                    {category !== \"all\" && (\n                      <span> em <span className=\"font-medium text-foreground\">{category}</span></span>\n                    )}\n                  </div>\n                </div>\n\n                <div className=\"flex items-center gap-2\">\n                  {hasFilters && (\n                    <Button \n                      variant=\"ghost\" \n                      size=\"sm\" \n                      onClick={clearFilters}\n                      data-testid=\"button-clear-filters\"\n                    >\n                      <X className=\"h-4 w-4 mr-1\" />\n                      Limpar filtros\n                    </Button>\n                  )}\n                  \n                  <div className=\"flex border rounded-md\">\n                    <Button\n                      variant={viewMode === \"grid\" ? \"secondary\" : \"ghost\"}\n                      size=\"icon\"\n                      className=\"h-8 w-8 rounded-r-none\"\n                      onClick={() => setViewMode(\"grid\")}\n                      data-testid=\"button-view-grid\"\n                    >\n                      <Grid3X3 className=\"h-4 w-4\" />\n                    </Button>\n                    <Button\n                      variant={viewMode === \"list\" ? \"secondary\" : \"ghost\"}\n                      size=\"icon\"\n                      className=\"h-8 w-8 rounded-l-none\"\n                      onClick={() => setViewMode(\"list\")}\n                      data-testid=\"button-view-list\"\n                    >\n                      <List className=\"h-4 w-4\" />\n                    </Button>\n                  </div>\n                </div>\n              </div>\n\n              {showMobileFilters && (\n                <div className=\"mt-3 pt-3 border-t lg:hidden\">\n                  <div className=\"flex flex-wrap gap-2\">\n                    <Button\n                      variant={category === \"all\" ? \"default\" : \"outline\"}\n                      size=\"sm\"\n                      onClick={() => selectCategory(\"all\")}\n                    >\n                      Todas\n                    </Button>\n                    {categoriesData.map(cat => (\n                      <Button\n                        key={cat.id}\n                        variant={category === cat.name ? \"default\" : \"outline\"}\n                        size=\"sm\"\n                        onClick={() => selectCategory(cat.name)}\n                      >\n                        {cat.name}\n                      </Button>\n                    ))}\n                  </div>\n                </div>\n              )}\n            </div>\n          </div>\n\n          <div className=\"flex-1 p-4\">\n            {productsLoading ? (\n              <div className=\"flex flex-col items-center justify-center py-20\">\n                <Loader2 className=\"h-10 w-10 animate-spin text-primary mb-4\" />\n                <p className=\"text-muted-foreground\">Carregando produtos...</p>\n              </div>\n            ) : filteredProducts.length === 0 ? (\n              <div className=\"flex flex-col items-center justify-center py-20 text-center\">\n                <div className=\"w-20 h-20 rounded-full bg-muted/50 flex items-center justify-center mb-4\">\n                  <Package className=\"h-10 w-10 text-muted-foreground/50\" />\n                </div>\n                <h3 className=\"font-semibold text-lg mb-2\">Nenhum produto encontrado</h3>\n                <p className=\"text-muted-foreground text-sm mb-4\">\n                  {hasFilters ? \"Tente ajustar os filtros de busca\" : \"Os produtos serao exibidos aqui quando forem cadastrados\"}\n                </p>\n                {hasFilters && (\n                  <Button variant=\"outline\" onClick={clearFilters}>\n                    Limpar filtros\n                  </Button>\n                )}\n              </div>\n            ) : viewMode === \"grid\" ? (\n              <div className=\"grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 xl:grid-cols-5 2xl:grid-cols-6 gap-3\">\n                {filteredProducts.map(product => (\n                  <Card \n                    key={product.id}\n                    className=\"overflow-hidden group hover-elevate transition-all duration-200\"\n                    data-testid={`card-product-${product.id}`}\n                  >\n                    <div className=\"aspect-square bg-muted/30 flex items-center justify-center relative overflow-hidden\">\n                      {product.image ? (\n                        <img\n                          src={product.image}\n                          alt={product.name}\n                          className=\"w-full h-full object-cover transition-transform duration-300 group-hover:scale-105\"\n                        />\n                      ) : (\n                        <Package className=\"h-12 w-12 text-muted-foreground/20\" />\n                      )}\n                      {product.stock === 0 && (\n                        <div className=\"absolute inset-0 bg-background/80 flex items-center justify-center backdrop-blur-sm\">\n                          <Badge variant=\"destructive\">Indisponivel</Badge>\n                        </div>\n                      )}\n                      {product.brand && (\n                        <div className=\"absolute top-1.5 left-1.5\">\n                          <Badge variant=\"secondary\" className=\"text-xs font-medium bg-background/90 backdrop-blur-sm\">\n                            {product.brand}\n                          </Badge>\n                        </div>\n                      )}\n                    </div>\n                    <CardContent className=\"p-3\">\n                      <p className=\"text-xs text-muted-foreground mb-1 font-mono\">\n                        {product.sku}\n                      </p>\n                      <h3 className=\"font-medium text-sm line-clamp-2 min-h-[2.5rem] leading-tight mb-2\">\n                        {product.name}\n                      </h3>\n                      <p className=\"text-base font-bold text-orange-600 dark:text-orange-500 mb-3\" data-testid={`text-price-${product.id}`}>\n                        {formatPrice(product.price)}\n                      </p>\n                      \n                      {product.stock > 0 && (\n                        <div className=\"flex items-center gap-2 mt-2\">\n                          <Input\n                            type=\"number\"\n                            min=\"0\"\n                            max=\"999\"\n                            value={getQuantity(product.id)}\n                            onChange={(e) => setQuantity(product.id, parseInt(e.target.value) || 0)}\n                            className=\"h-9 w-16 text-center text-sm\"\n                            data-testid={`input-qty-${product.id}`}\n                          />\n                          <Button\n                            className=\"flex-1 bg-orange-500 hover:bg-orange-600 text-white h-9 font-semibold\"\n                            onClick={() => handleAddToCart(product)}\n                            data-testid={`button-add-cart-${product.id}`}\n                          >\n                            COMPRAR\n                          </Button>\n                        </div>\n                      )}\n                    </CardContent>\n                  </Card>\n                ))}\n              </div>\n            ) : (\n              <div className=\"space-y-2\">\n                {filteredProducts.map(product => (\n                  <Card \n                    key={product.id}\n                    className=\"overflow-hidden hover-elevate transition-all duration-200\"\n                    data-testid={`card-product-${product.id}`}\n                  >\n                    <div className=\"flex gap-4 p-3\">\n                      <div className=\"w-20 h-20 bg-muted/30 rounded-md flex items-center justify-center shrink-0 overflow-hidden\">\n                        {product.image ? (\n                          <img\n                            src={product.image}\n                            alt={product.name}\n                            className=\"w-full h-full object-cover\"\n                          />\n                        ) : (\n                          <Package className=\"h-8 w-8 text-muted-foreground/20\" />\n                        )}\n                      </div>\n                      <div className=\"flex-1 min-w-0\">\n                        <div className=\"flex items-start justify-between gap-2\">\n                          <div className=\"min-w-0\">\n                            <p className=\"text-xs text-muted-foreground font-mono\">\n                              {product.sku}\n                            </p>\n                            <h3 className=\"font-medium text-sm truncate\">\n                              {product.name}\n                            </h3>\n                            {product.brand && (\n                              <Badge variant=\"secondary\" className=\"text-xs mt-1\">\n                                {product.brand}\n                              </Badge>\n                            )}\n                          </div>\n                          <div className=\"text-right shrink-0\">\n                            <p className=\"text-base font-bold text-orange-600 dark:text-orange-500\" data-testid={`text-price-${product.id}`}>\n                              {formatPrice(product.price)}\n                            </p>\n                          </div>\n                        </div>\n                        \n                        {product.stock > 0 && (\n                          <div className=\"flex items-center gap-2 mt-2\">\n                            <Input\n                              type=\"number\"\n                              min=\"0\"\n                              max=\"999\"\n                              value={getQuantity(product.id)}\n                              onChange={(e) => setQuantity(product.id, parseInt(e.target.value) || 0)}\n                              className=\"h-8 w-14 text-center text-sm\"\n                              data-testid={`input-qty-${product.id}`}\n                            />\n                            <Button\n                              className=\"bg-orange-500 hover:bg-orange-600 text-white h-8 font-semibold\"\n                              onClick={() => handleAddToCart(product)}\n                              data-testid={`button-add-cart-${product.id}`}\n                            >\n                              COMPRAR\n                            </Button>\n                          </div>\n                        )}\n                        \n                        {product.stock === 0 && (\n                          <Badge variant=\"destructive\" className=\"mt-2\">Indisponivel</Badge>\n                        )}\n                      </div>\n                    </div>\n                  </Card>\n                ))}\n              </div>\n            )}\n\n            {totalPages > 1 && (\n              <div className=\"flex items-center justify-center gap-2 pt-6\">\n                <Button\n                  variant=\"outline\"\n                  size=\"sm\"\n                  onClick={() => setPage(p => Math.max(1, p - 1))}\n                  disabled={page === 1}\n                  data-testid=\"button-prev-page\"\n                >\n                  <ChevronLeft className=\"h-4 w-4\" />\n                  Anterior\n                </Button>\n                <div className=\"flex items-center gap-1\">\n                  {Array.from({ length: Math.min(5, totalPages) }, (_, i) => {\n                    let pageNum;\n                    if (totalPages <= 5) {\n                      pageNum = i + 1;\n                    } else if (page <= 3) {\n                      pageNum = i + 1;\n                    } else if (page >= totalPages - 2) {\n                      pageNum = totalPages - 4 + i;\n                    } else {\n                      pageNum = page - 2 + i;\n                    }\n                    return (\n                      <Button\n                        key={pageNum}\n                        variant={page === pageNum ? \"default\" : \"outline\"}\n                        size=\"sm\"\n                        className=\"w-9\"\n                        onClick={() => setPage(pageNum)}\n                        data-testid={`button-page-${pageNum}`}\n                      >\n                        {pageNum}\n                      </Button>\n                    );\n                  })}\n                </div>\n                <Button\n                  variant=\"outline\"\n                  size=\"sm\"\n                  onClick={() => setPage(p => Math.min(totalPages, p + 1))}\n                  disabled={page === totalPages}\n                  data-testid=\"button-next-page\"\n                >\n                  Proxima\n                  <ChevronRight className=\"h-4 w-4\" />\n                </Button>\n              </div>\n            )}\n          </div>\n        </main>\n      </div>\n\n      <footer className=\"border-t py-4 bg-zinc-900 text-white\">\n        <div className=\"container mx-auto px-4 text-center text-sm\">\n          <p className=\"text-zinc-400\">\n            Precos de varejo. Para precos de atacado, \n            <span \n              className=\"text-orange-500 cursor-pointer hover:underline ml-1\"\n              onClick={() => setLocation(\"/login\")}\n            >\n              faca login\n            </span>\n          </p>\n        </div>\n      </footer>\n    </div>\n  );\n}\n","path":null,"size_bytes":29859,"size_tokens":null},"client/src/pages/checkout.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { useLocation } from \"wouter\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription } from \"@/components/ui/card\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Separator } from \"@/components/ui/separator\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { RadioGroup, RadioGroupItem } from \"@/components/ui/radio-group\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { useCart } from \"@/contexts/CartContext\";\nimport { useAuth } from \"@/contexts/AuthContext\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { \n  ArrowLeft, \n  ArrowRight, \n  ShoppingCart, \n  User, \n  Truck, \n  CreditCard, \n  FileText,\n  Package,\n  Phone,\n  MapPin,\n  Calculator,\n  Loader2,\n  CheckCircle2\n} from \"lucide-react\";\nimport { SiWhatsapp } from \"react-icons/si\";\nimport logoImage from \"@assets/image_1765659931449.png\";\nimport { ThemeToggle } from \"@/components/ThemeToggle\";\n\nconst STORE_WHATSAPP = \"5511992845596\";\n\ntype CheckoutStep = \"resumo\" | \"cadastro\" | \"frete\" | \"pagamento\" | \"orcamento\";\n\nconst steps: { key: CheckoutStep; label: string; icon: typeof ShoppingCart }[] = [\n  { key: \"resumo\", label: \"Resumo\", icon: ShoppingCart },\n  { key: \"cadastro\", label: \"Cadastro\", icon: User },\n  { key: \"frete\", label: \"Frete\", icon: Truck },\n  { key: \"pagamento\", label: \"Pagamento\", icon: CreditCard },\n  { key: \"orcamento\", label: \"Orcamento\", icon: FileText },\n];\n\ninterface ShippingAddress {\n  cep: string;\n  street: string;\n  number: string;\n  complement: string;\n  neighborhood: string;\n  city: string;\n  state: string;\n}\n\ninterface FreightQuote {\n  type: string;\n  price: number;\n  deadline: string;\n  selected: boolean;\n}\n\nexport default function CheckoutPage() {\n  const [, setLocation] = useLocation();\n  const { items, total, itemCount, clearCart } = useCart();\n  const { user, isAuthenticated } = useAuth();\n  const { toast } = useToast();\n  const [currentStep, setCurrentStep] = useState<CheckoutStep>(\"resumo\");\n  const [isSubmitting, setIsSubmitting] = useState(false);\n  \n  // Shipping state\n  const [shippingAddress, setShippingAddress] = useState<ShippingAddress>({\n    cep: \"\",\n    street: \"\",\n    number: \"\",\n    complement: \"\",\n    neighborhood: \"\",\n    city: \"\",\n    state: \"\",\n  });\n  const [freightQuotes, setFreightQuotes] = useState<FreightQuote[]>([]);\n  const [selectedFreight, setSelectedFreight] = useState<string>(\"\");\n  const [isLoadingCep, setIsLoadingCep] = useState(false);\n  const [freightCalculated, setFreightCalculated] = useState(false);\n  \n  // Payment state\n  const [paymentMethod, setPaymentMethod] = useState<string>(\"\");\n  const [paymentNotes, setPaymentNotes] = useState(\"\");\n  \n  // Guest checkout state\n  const [isGuestCheckout, setIsGuestCheckout] = useState(false);\n  const [showGuestForm, setShowGuestForm] = useState(false);\n  const [guestCpf, setGuestCpf] = useState(\"\");\n  const [guestName, setGuestName] = useState(\"\");\n  const [guestPhone, setGuestPhone] = useState(\"\");\n  const [guestEmail, setGuestEmail] = useState(\"\");\n  \n  // Business rule: guest checkout only allowed for orders under R$ 400\n  const canUseGuestCheckout = total < 400;\n  \n  // Success state\n  const [orderSuccess, setOrderSuccess] = useState(false);\n  const [createdOrderNumber, setCreatedOrderNumber] = useState(\"\");\n\n  // Handle step from URL query parameter (after login/register redirect)\n  useEffect(() => {\n    const checkStepParam = () => {\n      const urlParams = new URLSearchParams(window.location.search);\n      const stepParam = urlParams.get('step') as CheckoutStep;\n      if (stepParam && steps.find(s => s.key === stepParam)) {\n        setCurrentStep(stepParam);\n        window.history.replaceState({}, '', '/checkout');\n      }\n    };\n    \n    checkStepParam();\n  }, []);\n\n  // Skip cadastro step if already logged in\n  useEffect(() => {\n    if (currentStep === \"cadastro\" && isAuthenticated && user) {\n      setCurrentStep(\"frete\");\n    }\n  }, [currentStep, isAuthenticated, user]);\n\n  const formatPrice = (price: number) => {\n    return new Intl.NumberFormat('pt-BR', {\n      style: 'currency',\n      currency: 'BRL'\n    }).format(price);\n  };\n\n  const getCurrentStepIndex = () => steps.findIndex(s => s.key === currentStep);\n\n  const goToNextStep = () => {\n    const currentIndex = getCurrentStepIndex();\n    if (currentIndex < steps.length - 1) {\n      const nextStep = steps[currentIndex + 1].key;\n      // Skip cadastro if logged in\n      if (nextStep === \"cadastro\" && isAuthenticated && user) {\n        setCurrentStep(\"frete\");\n      } else {\n        setCurrentStep(nextStep);\n      }\n    }\n  };\n\n  const goToPreviousStep = () => {\n    const currentIndex = getCurrentStepIndex();\n    if (currentIndex > 0) {\n      const prevStep = steps[currentIndex - 1].key;\n      // Skip cadastro if logged in\n      if (prevStep === \"cadastro\" && isAuthenticated && user) {\n        setCurrentStep(\"resumo\");\n      } else {\n        setCurrentStep(prevStep);\n      }\n    }\n  };\n\n  const handleContinueToRegister = () => {\n    setLocation(\"/register?redirect=/checkout&step=frete\");\n  };\n\n  const handleLoginRedirect = () => {\n    setLocation(\"/login?redirect=/checkout&step=frete\");\n  };\n\n  // CEP lookup\n  const handleCepLookup = async () => {\n    const cep = shippingAddress.cep.replace(/\\D/g, '');\n    if (cep.length !== 8) {\n      toast({\n        title: \"CEP invalido\",\n        description: \"Digite um CEP com 8 digitos\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    setIsLoadingCep(true);\n    try {\n      const response = await fetch(`https://viacep.com.br/ws/${cep}/json/`);\n      const data = await response.json();\n      \n      if (data.erro) {\n        toast({\n          title: \"CEP nao encontrado\",\n          description: \"Verifique o CEP digitado\",\n          variant: \"destructive\",\n        });\n        return;\n      }\n\n      setShippingAddress(prev => ({\n        ...prev,\n        street: data.logradouro || \"\",\n        neighborhood: data.bairro || \"\",\n        city: data.localidade || \"\",\n        state: data.uf || \"\",\n      }));\n    } catch {\n      toast({\n        title: \"Erro ao buscar CEP\",\n        description: \"Tente novamente\",\n        variant: \"destructive\",\n      });\n    } finally {\n      setIsLoadingCep(false);\n    }\n  };\n\n  // Calculate freight quotes\n  const handleCalculateFreight = () => {\n    if (!shippingAddress.cep || !shippingAddress.street || !shippingAddress.number || !shippingAddress.city) {\n      toast({\n        title: \"Endereco incompleto\",\n        description: \"Preencha todos os campos obrigatorios\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    // Simulate freight calculation\n    const quotes: FreightQuote[] = [\n      { type: \"economico\", price: 25.90, deadline: \"10-15 dias uteis\", selected: false },\n      { type: \"normal\", price: 45.90, deadline: \"5-8 dias uteis\", selected: false },\n      { type: \"expresso\", price: 89.90, deadline: \"2-3 dias uteis\", selected: false },\n      { type: \"combinar\", price: 0, deadline: \"A combinar com vendedor\", selected: false },\n    ];\n    \n    setFreightQuotes(quotes);\n    setFreightCalculated(true);\n    \n    toast({\n      title: \"Frete calculado\",\n      description: \"Selecione uma opcao de entrega\",\n    });\n  };\n\n  // Get selected freight price\n  const getSelectedFreightPrice = () => {\n    const selected = freightQuotes.find(q => q.type === selectedFreight);\n    return selected?.price || 0;\n  };\n\n  // Generate order\n  const handleGenerateOrder = async () => {\n    if (!isGuestCheckout && (!isAuthenticated || !user)) {\n      toast({\n        title: \"Faca login\",\n        description: \"Voce precisa estar logado para gerar o orcamento\",\n        variant: \"destructive\",\n      });\n      setLocation(\"/login?redirect=/checkout&step=orcamento\");\n      return;\n    }\n    \n    // Validate guest CPF\n    if (isGuestCheckout && (!guestCpf || guestCpf.replace(/\\D/g, '').length !== 11)) {\n      toast({\n        title: \"CPF invalido\",\n        description: \"Informe um CPF valido com 11 digitos\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    if (!selectedFreight) {\n      toast({\n        title: \"Selecione o frete\",\n        description: \"Escolha uma opcao de entrega\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    if (!paymentMethod) {\n      toast({\n        title: \"Selecione o pagamento\",\n        description: \"Escolha uma forma de pagamento\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    setIsSubmitting(true);\n    try {\n      const orderData: any = {\n        items: items.map(item => ({\n          productId: parseInt(item.productId, 10),\n          quantity: item.quantity,\n          unitPrice: item.price,\n          totalPrice: item.price * item.quantity,\n        })),\n        subtotal: total,\n        shippingCost: getSelectedFreightPrice(),\n        total: total + getSelectedFreightPrice(),\n        shippingAddress: {\n          ...shippingAddress,\n          fullAddress: `${shippingAddress.street}, ${shippingAddress.number}${shippingAddress.complement ? ` - ${shippingAddress.complement}` : ''}, ${shippingAddress.neighborhood}, ${shippingAddress.city} - ${shippingAddress.state}, CEP: ${shippingAddress.cep}`\n        },\n        shippingMethod: selectedFreight,\n        paymentMethod: paymentMethod,\n        paymentNotes: paymentNotes,\n        notes: `Frete: ${selectedFreight} | Pagamento: ${paymentMethod}${paymentNotes ? ` | Obs: ${paymentNotes}` : ''}`,\n      };\n      \n      // Add guest info if guest checkout\n      if (isGuestCheckout) {\n        orderData.guestCpf = guestCpf;\n        orderData.guestName = guestName;\n        orderData.guestPhone = guestPhone;\n        orderData.guestEmail = guestEmail || null;\n      }\n\n      const endpoint = isGuestCheckout ? \"/api/orders/guest\" : \"/api/orders\";\n      const response = await apiRequest(\"POST\", endpoint, orderData);\n      const orderResult = await response.json();\n      \n      // Clear cart and show success screen\n      clearCart();\n      queryClient.invalidateQueries({ queryKey: [\"/api/orders\"] });\n      \n      setCreatedOrderNumber(orderResult.orderNumber || \"\");\n      setOrderSuccess(true);\n      \n      toast({\n        title: \"Orcamento gerado com sucesso!\",\n        description: \"Entraremos em contato em breve\",\n      });\n    } catch (error) {\n      toast({\n        title: \"Erro ao gerar orcamento\",\n        description: error instanceof Error ? error.message : \"Tente novamente\",\n        variant: \"destructive\",\n      });\n    } finally {\n      setIsSubmitting(false);\n    }\n  };\n\n  // Success screen after order creation\n  if (orderSuccess) {\n    const whatsappMessage = `Olá! Acabei de gerar o orçamento #${createdOrderNumber} e gostaria de mais informações.`;\n    const whatsappLink = `https://wa.me/${STORE_WHATSAPP}?text=${encodeURIComponent(whatsappMessage)}`;\n    \n    return (\n      <div className=\"min-h-screen bg-background flex flex-col\">\n        <header className=\"sticky top-0 z-50 bg-zinc-900 text-white\">\n          <div className=\"container mx-auto px-4 py-3\">\n            <div className=\"flex items-center justify-between gap-2\">\n              <div className=\"flex items-center gap-3 cursor-pointer\" onClick={() => setLocation(\"/\")}>\n                <img \n                  src={logoImage} \n                  alt=\"Lojamadrugadao\" \n                  className=\"h-10 w-10 rounded-full border-2 border-white/20\"\n                />\n                <h1 className=\"font-bold text-lg\">LOJAMADRUGADAO</h1>\n              </div>\n              <ThemeToggle />\n            </div>\n          </div>\n        </header>\n\n        <div className=\"flex-1 flex items-center justify-center p-4\">\n          <Card className=\"max-w-md w-full\">\n            <CardContent className=\"pt-6 text-center\">\n              <CheckCircle2 className=\"h-16 w-16 text-green-500 mx-auto mb-4\" />\n              <h2 className=\"text-xl font-semibold mb-2\">Orcamento Gerado!</h2>\n              {createdOrderNumber && (\n                <p className=\"text-2xl font-bold text-primary mb-2\">#{createdOrderNumber}</p>\n              )}\n              <p className=\"text-muted-foreground mb-6\">\n                Seu orcamento foi gerado com sucesso. Entre em contato conosco pelo WhatsApp para finalizar seu pedido.\n              </p>\n              <div className=\"flex flex-col gap-3\">\n                <a href={whatsappLink} target=\"_blank\" rel=\"noopener noreferrer\">\n                  <Button \n                    className=\"w-full bg-green-600 hover:bg-green-700 text-white\"\n                    data-testid=\"button-whatsapp-order\"\n                  >\n                    <SiWhatsapp className=\"h-5 w-5 mr-2\" />\n                    Falar no WhatsApp\n                  </Button>\n                </a>\n                <Button \n                  variant=\"outline\" \n                  onClick={() => setLocation(isGuestCheckout ? \"/catalogo\" : \"/minha-conta\")}\n                  data-testid=\"button-continue-shopping\"\n                >\n                  {isGuestCheckout ? \"Voltar ao Catalogo\" : \"Ver Meus Pedidos\"}\n                </Button>\n              </div>\n            </CardContent>\n          </Card>\n        </div>\n      </div>\n    );\n  }\n\n  if (items.length === 0 && currentStep !== \"orcamento\") {\n    return (\n      <div className=\"min-h-screen bg-background flex flex-col\">\n        <header className=\"sticky top-0 z-50 bg-zinc-900 text-white\">\n          <div className=\"container mx-auto px-4 py-3\">\n            <div className=\"flex items-center justify-between gap-2\">\n              <div className=\"flex items-center gap-3 cursor-pointer\" onClick={() => setLocation(\"/\")}>\n                <img \n                  src={logoImage} \n                  alt=\"Lojamadrugadao\" \n                  className=\"h-10 w-10 rounded-full border-2 border-white/20\"\n                />\n                <h1 className=\"font-bold text-lg\">LOJAMADRUGADAO</h1>\n              </div>\n              <ThemeToggle />\n            </div>\n          </div>\n        </header>\n\n        <div className=\"flex-1 flex items-center justify-center p-4\">\n          <Card className=\"max-w-md w-full\">\n            <CardContent className=\"pt-6 text-center\">\n              <Package className=\"h-16 w-16 text-muted-foreground/50 mx-auto mb-4\" />\n              <h2 className=\"text-xl font-semibold mb-2\">Carrinho Vazio</h2>\n              <p className=\"text-muted-foreground mb-6\">\n                Adicione produtos ao carrinho para continuar com a compra.\n              </p>\n              <Button onClick={() => setLocation(\"/catalogo\")} className=\"bg-orange-500 hover:bg-orange-600\">\n                Ver Catalogo\n              </Button>\n            </CardContent>\n          </Card>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"min-h-screen bg-background flex flex-col\">\n      <header className=\"sticky top-0 z-50 bg-zinc-900 text-white\">\n        <div className=\"container mx-auto px-4 py-3\">\n          <div className=\"flex items-center justify-between gap-2\">\n            <div className=\"flex items-center gap-3 cursor-pointer\" onClick={() => setLocation(\"/\")}>\n              <img \n                src={logoImage} \n                alt=\"Lojamadrugadao\" \n                className=\"h-10 w-10 rounded-full border-2 border-white/20\"\n              />\n              <div className=\"hidden sm:block\">\n                <h1 className=\"font-bold text-sm\">LOJAMADRUGADAO</h1>\n                <div className=\"flex items-center gap-1 text-zinc-400 text-xs\">\n                  <Phone className=\"h-3 w-3\" />\n                  <span>11 99294-0168</span>\n                </div>\n              </div>\n            </div>\n            <div className=\"flex items-center gap-4\">\n              <div className=\"hidden md:flex items-center gap-2 text-sm\">\n                <ShoppingCart className=\"h-4 w-4\" />\n                <span>{itemCount} itens</span>\n                <span className=\"font-bold text-orange-500\">{formatPrice(total)}</span>\n              </div>\n              <ThemeToggle />\n            </div>\n          </div>\n        </div>\n      </header>\n\n      <div className=\"container mx-auto px-4 py-6\">\n        <div className=\"flex items-center gap-2 mb-6\">\n          <Button \n            variant=\"ghost\" \n            size=\"sm\" \n            onClick={() => setLocation(\"/catalogo\")}\n            data-testid=\"button-back-catalog\"\n          >\n            <ArrowLeft className=\"h-4 w-4 mr-1\" />\n            Voltar ao catalogo\n          </Button>\n        </div>\n\n        <div className=\"flex items-center justify-center mb-8 overflow-x-auto\">\n          <div className=\"flex items-center gap-2\">\n            {steps.map((step, index) => {\n              const StepIcon = step.icon;\n              const isActive = step.key === currentStep;\n              const isPast = index < getCurrentStepIndex();\n              const isSkipped = step.key === \"cadastro\" && isAuthenticated && user;\n              \n              if (isSkipped) return null;\n              \n              return (\n                <div key={step.key} className=\"flex items-center\">\n                  <div \n                    className={`flex items-center gap-2 px-3 py-2 rounded-lg transition-colors ${\n                      isActive \n                        ? \"bg-orange-500 text-white\" \n                        : isPast \n                          ? \"bg-green-500/20 text-green-600 dark:text-green-400\" \n                          : \"bg-muted text-muted-foreground\"\n                    }`}\n                  >\n                    <StepIcon className=\"h-4 w-4\" />\n                    <span className=\"text-sm font-medium hidden sm:inline\">{step.label}</span>\n                  </div>\n                  {index < steps.length - 1 && !isSkipped && (\n                    <div className={`w-8 h-0.5 mx-1 ${isPast ? \"bg-green-500\" : \"bg-muted\"}`} />\n                  )}\n                </div>\n              );\n            })}\n          </div>\n        </div>\n\n        <div className=\"grid lg:grid-cols-3 gap-6\">\n          <div className=\"lg:col-span-2\">\n            {currentStep === \"resumo\" && (\n              <Card>\n                <CardHeader>\n                  <CardTitle className=\"flex items-center gap-2\">\n                    <ShoppingCart className=\"h-5 w-5\" />\n                    Resumo do Pedido\n                  </CardTitle>\n                  <CardDescription>\n                    Confira os itens do seu carrinho antes de continuar\n                  </CardDescription>\n                </CardHeader>\n                <CardContent className=\"space-y-4\">\n                  {items.map((item) => (\n                    <div \n                      key={item.id} \n                      className=\"flex gap-4 p-3 rounded-lg bg-muted/50\"\n                      data-testid={`checkout-item-${item.id}`}\n                    >\n                      <div className=\"w-16 h-16 bg-muted rounded-md flex items-center justify-center shrink-0\">\n                        {item.image ? (\n                          <img src={item.image} alt={item.name} className=\"w-full h-full object-cover rounded-md\" />\n                        ) : (\n                          <Package className=\"h-6 w-6 text-muted-foreground/50\" />\n                        )}\n                      </div>\n                      <div className=\"flex-1 min-w-0\">\n                        <p className=\"font-medium text-sm\">{item.name}</p>\n                        <p className=\"text-xs text-muted-foreground\">{item.sku}</p>\n                        <div className=\"flex items-center gap-2 mt-1\">\n                          <Badge variant=\"secondary\" className=\"text-xs\">\n                            Qtd: {item.quantity}\n                          </Badge>\n                          <span className=\"text-sm font-semibold\">\n                            {formatPrice(item.price * item.quantity)}\n                          </span>\n                        </div>\n                      </div>\n                    </div>\n                  ))}\n\n                  <Separator />\n\n                  <div className=\"flex items-center justify-between text-lg font-bold\">\n                    <span>Subtotal</span>\n                    <span className=\"text-orange-600 dark:text-orange-500\">{formatPrice(total)}</span>\n                  </div>\n\n                  <Button \n                    className=\"w-full bg-orange-500 hover:bg-orange-600\"\n                    onClick={goToNextStep}\n                    data-testid=\"button-continue-to-cadastro\"\n                  >\n                    Continuar\n                    <ArrowRight className=\"h-4 w-4 ml-2\" />\n                  </Button>\n                </CardContent>\n              </Card>\n            )}\n\n            {currentStep === \"cadastro\" && (\n              <Card>\n                <CardHeader>\n                  <CardTitle className=\"flex items-center gap-2\">\n                    <User className=\"h-5 w-5\" />\n                    Identificacao\n                  </CardTitle>\n                  <CardDescription>\n                    {showGuestForm ? \"Preencha seus dados para continuar\" : \"Escolha como deseja continuar\"}\n                  </CardDescription>\n                </CardHeader>\n                <CardContent className=\"space-y-6\">\n                  {!showGuestForm ? (\n                    <>\n                      {!canUseGuestCheckout && (\n                        <div className=\"p-4 rounded-lg bg-orange-500/10 border border-orange-500/30 mb-4\">\n                          <p className=\"text-sm text-orange-600 dark:text-orange-500 font-medium\">\n                            Para compras acima de R$ 400,00 e necessario criar uma conta ou fazer login.\n                          </p>\n                        </div>\n                      )}\n                      <div className={`grid gap-4 ${canUseGuestCheckout ? 'md:grid-cols-3' : 'md:grid-cols-2'}`}>\n                        <Card className=\"hover-elevate cursor-pointer\" onClick={handleLoginRedirect}>\n                          <CardContent className=\"pt-6 text-center\">\n                            <User className=\"h-12 w-12 mx-auto mb-4 text-orange-500\" />\n                            <h3 className=\"font-semibold mb-2\">Ja tenho conta</h3>\n                            <p className=\"text-sm text-muted-foreground mb-4\">\n                              Faca login para continuar\n                            </p>\n                            <Button variant=\"outline\" className=\"w-full\" data-testid=\"button-login-checkout\">\n                              Entrar\n                            </Button>\n                          </CardContent>\n                        </Card>\n\n                        <Card className=\"hover-elevate cursor-pointer\" onClick={handleContinueToRegister}>\n                          <CardContent className=\"pt-6 text-center\">\n                            <User className=\"h-12 w-12 mx-auto mb-4 text-orange-500\" />\n                            <h3 className=\"font-semibold mb-2\">Criar conta</h3>\n                            <p className=\"text-sm text-muted-foreground mb-4\">\n                              Cadastre-se para comprar\n                            </p>\n                            <Button variant=\"outline\" className=\"w-full\" data-testid=\"button-register-checkout\">\n                              Cadastrar\n                            </Button>\n                          </CardContent>\n                        </Card>\n\n                        {canUseGuestCheckout && (\n                          <Card \n                            className=\"hover-elevate cursor-pointer border-orange-500/50\" \n                            onClick={() => {\n                              setShowGuestForm(true);\n                              setIsGuestCheckout(true);\n                            }}\n                            data-testid=\"card-guest-checkout\"\n                          >\n                            <CardContent className=\"pt-6 text-center\">\n                              <ShoppingCart className=\"h-12 w-12 mx-auto mb-4 text-orange-500\" />\n                              <h3 className=\"font-semibold mb-2\">Comprar sem cadastro</h3>\n                              <p className=\"text-sm text-muted-foreground mb-4\">\n                                Informe apenas seus dados\n                              </p>\n                              <Button className=\"w-full bg-orange-500 hover:bg-orange-600\" data-testid=\"button-guest-checkout\">\n                                Continuar\n                              </Button>\n                            </CardContent>\n                          </Card>\n                        )}\n                      </div>\n                    </>\n                  ) : (\n                    <div className=\"space-y-4\">\n                      <div className=\"p-4 rounded-lg bg-orange-500/10 border border-orange-500/30 mb-4\">\n                        <p className=\"text-sm text-orange-600 dark:text-orange-500 font-medium\">\n                          Compra como visitante - preencha seus dados abaixo\n                        </p>\n                      </div>\n                      \n                      <div className=\"grid md:grid-cols-2 gap-4\">\n                        <div>\n                          <Label htmlFor=\"guestName\">Nome completo *</Label>\n                          <Input\n                            id=\"guestName\"\n                            placeholder=\"Seu nome\"\n                            value={guestName}\n                            onChange={(e) => setGuestName(e.target.value)}\n                            data-testid=\"input-guest-name\"\n                          />\n                        </div>\n                        <div>\n                          <Label htmlFor=\"guestCpf\">CPF *</Label>\n                          <Input\n                            id=\"guestCpf\"\n                            placeholder=\"000.000.000-00\"\n                            value={guestCpf}\n                            onChange={(e) => setGuestCpf(e.target.value)}\n                            data-testid=\"input-guest-cpf\"\n                          />\n                        </div>\n                      </div>\n                      \n                      <div className=\"grid md:grid-cols-2 gap-4\">\n                        <div>\n                          <Label htmlFor=\"guestPhone\">Telefone *</Label>\n                          <Input\n                            id=\"guestPhone\"\n                            placeholder=\"(11) 99999-9999\"\n                            value={guestPhone}\n                            onChange={(e) => setGuestPhone(e.target.value)}\n                            data-testid=\"input-guest-phone\"\n                          />\n                        </div>\n                        <div>\n                          <Label htmlFor=\"guestEmail\">E-mail (opcional)</Label>\n                          <Input\n                            id=\"guestEmail\"\n                            type=\"email\"\n                            placeholder=\"seu@email.com\"\n                            value={guestEmail}\n                            onChange={(e) => setGuestEmail(e.target.value)}\n                            data-testid=\"input-guest-email\"\n                          />\n                        </div>\n                      </div>\n\n                      <div className=\"flex items-center justify-between gap-2 pt-4\">\n                        <Button \n                          variant=\"ghost\" \n                          onClick={() => {\n                            setShowGuestForm(false);\n                            setIsGuestCheckout(false);\n                          }}\n                        >\n                          <ArrowLeft className=\"h-4 w-4 mr-2\" />\n                          Voltar\n                        </Button>\n                        <Button \n                          className=\"bg-orange-500 hover:bg-orange-600\"\n                          onClick={() => {\n                            if (!guestName.trim()) {\n                              toast({ title: \"Informe seu nome\", variant: \"destructive\" });\n                              return;\n                            }\n                            if (!guestCpf || guestCpf.replace(/\\D/g, '').length !== 11) {\n                              toast({ title: \"CPF invalido\", description: \"Informe um CPF valido com 11 digitos\", variant: \"destructive\" });\n                              return;\n                            }\n                            if (!guestPhone.trim()) {\n                              toast({ title: \"Informe seu telefone\", variant: \"destructive\" });\n                              return;\n                            }\n                            setCurrentStep(\"frete\");\n                          }}\n                          data-testid=\"button-guest-continue\"\n                        >\n                          Continuar\n                          <ArrowRight className=\"h-4 w-4 ml-2\" />\n                        </Button>\n                      </div>\n                    </div>\n                  )}\n\n                  {!showGuestForm && (\n                    <div className=\"flex items-center gap-2\">\n                      <Button variant=\"ghost\" onClick={goToPreviousStep}>\n                        <ArrowLeft className=\"h-4 w-4 mr-2\" />\n                        Voltar\n                      </Button>\n                    </div>\n                  )}\n                </CardContent>\n              </Card>\n            )}\n\n            {currentStep === \"frete\" && (\n              <Card>\n                <CardHeader>\n                  <CardTitle className=\"flex items-center gap-2\">\n                    <Truck className=\"h-5 w-5\" />\n                    Cotacao de Frete\n                  </CardTitle>\n                  <CardDescription>\n                    Informe seu endereco para calcular o frete\n                  </CardDescription>\n                </CardHeader>\n                <CardContent className=\"space-y-6\">\n                  {isGuestCheckout && (\n                    <div className=\"p-4 rounded-lg bg-orange-500/10 border border-orange-500/30 mb-2\">\n                      <p className=\"text-sm text-orange-600 dark:text-orange-500 font-medium\">\n                        Compra como visitante: {guestName} - CPF: {guestCpf}\n                      </p>\n                    </div>\n                  )}\n                  \n                  <div className=\"grid gap-4\">\n                    <div className=\"grid grid-cols-3 gap-4\">\n                      <div className=\"col-span-2\">\n                        <Label htmlFor=\"cep\">CEP *</Label>\n                        <div className=\"flex gap-2\">\n                          <Input\n                            id=\"cep\"\n                            placeholder=\"00000-000\"\n                            value={shippingAddress.cep}\n                            onChange={(e) => setShippingAddress(prev => ({ ...prev, cep: e.target.value }))}\n                            data-testid=\"input-cep\"\n                          />\n                          <Button \n                            variant=\"outline\" \n                            onClick={handleCepLookup}\n                            disabled={isLoadingCep}\n                            data-testid=\"button-search-cep\"\n                          >\n                            {isLoadingCep ? <Loader2 className=\"h-4 w-4 animate-spin\" /> : <MapPin className=\"h-4 w-4\" />}\n                          </Button>\n                        </div>\n                      </div>\n                    </div>\n\n                    <div>\n                      <Label htmlFor=\"street\">Rua/Avenida *</Label>\n                      <Input\n                        id=\"street\"\n                        placeholder=\"Nome da rua\"\n                        value={shippingAddress.street}\n                        onChange={(e) => setShippingAddress(prev => ({ ...prev, street: e.target.value }))}\n                        data-testid=\"input-street\"\n                      />\n                    </div>\n\n                    <div className=\"grid grid-cols-2 gap-4\">\n                      <div>\n                        <Label htmlFor=\"number\">Numero *</Label>\n                        <Input\n                          id=\"number\"\n                          placeholder=\"123\"\n                          value={shippingAddress.number}\n                          onChange={(e) => setShippingAddress(prev => ({ ...prev, number: e.target.value }))}\n                          data-testid=\"input-number\"\n                        />\n                      </div>\n                      <div>\n                        <Label htmlFor=\"complement\">Complemento</Label>\n                        <Input\n                          id=\"complement\"\n                          placeholder=\"Apto, Sala...\"\n                          value={shippingAddress.complement}\n                          onChange={(e) => setShippingAddress(prev => ({ ...prev, complement: e.target.value }))}\n                          data-testid=\"input-complement\"\n                        />\n                      </div>\n                    </div>\n\n                    <div>\n                      <Label htmlFor=\"neighborhood\">Bairro *</Label>\n                      <Input\n                        id=\"neighborhood\"\n                        placeholder=\"Bairro\"\n                        value={shippingAddress.neighborhood}\n                        onChange={(e) => setShippingAddress(prev => ({ ...prev, neighborhood: e.target.value }))}\n                        data-testid=\"input-neighborhood\"\n                      />\n                    </div>\n\n                    <div className=\"grid grid-cols-2 gap-4\">\n                      <div>\n                        <Label htmlFor=\"city\">Cidade *</Label>\n                        <Input\n                          id=\"city\"\n                          placeholder=\"Cidade\"\n                          value={shippingAddress.city}\n                          onChange={(e) => setShippingAddress(prev => ({ ...prev, city: e.target.value }))}\n                          data-testid=\"input-city\"\n                        />\n                      </div>\n                      <div>\n                        <Label htmlFor=\"state\">Estado *</Label>\n                        <Input\n                          id=\"state\"\n                          placeholder=\"UF\"\n                          value={shippingAddress.state}\n                          onChange={(e) => setShippingAddress(prev => ({ ...prev, state: e.target.value }))}\n                          maxLength={2}\n                          data-testid=\"input-state\"\n                        />\n                      </div>\n                    </div>\n                  </div>\n\n                  <Button \n                    className=\"w-full bg-orange-500 hover:bg-orange-600\"\n                    onClick={handleCalculateFreight}\n                    data-testid=\"button-calculate-freight\"\n                  >\n                    <Calculator className=\"h-4 w-4 mr-2\" />\n                    Calcular Frete\n                  </Button>\n\n                  {freightCalculated && freightQuotes.length > 0 && (\n                    <div className=\"space-y-3\">\n                      <Label>Selecione a opcao de entrega *</Label>\n                      <RadioGroup value={selectedFreight} onValueChange={setSelectedFreight}>\n                        {freightQuotes.map((quote) => (\n                          <div \n                            key={quote.type}\n                            className={`flex items-center space-x-3 p-4 rounded-lg border cursor-pointer transition-colors ${\n                              selectedFreight === quote.type \n                                ? \"border-orange-500 bg-orange-500/10\" \n                                : \"border-border hover:border-orange-500/50\"\n                            }`}\n                            onClick={() => setSelectedFreight(quote.type)}\n                            data-testid={`freight-option-${quote.type}`}\n                          >\n                            <RadioGroupItem value={quote.type} id={quote.type} />\n                            <div className=\"flex-1\">\n                              <Label htmlFor={quote.type} className=\"font-medium cursor-pointer capitalize\">\n                                {quote.type === \"combinar\" ? \"A combinar com vendedor\" : `Entrega ${quote.type}`}\n                              </Label>\n                              <p className=\"text-sm text-muted-foreground\">{quote.deadline}</p>\n                            </div>\n                            <span className=\"font-bold text-orange-600 dark:text-orange-500\">\n                              {quote.price === 0 ? \"Sob consulta\" : formatPrice(quote.price)}\n                            </span>\n                          </div>\n                        ))}\n                      </RadioGroup>\n                    </div>\n                  )}\n                  \n                  <div className=\"flex items-center justify-between gap-2\">\n                    <Button variant=\"ghost\" onClick={goToPreviousStep}>\n                      <ArrowLeft className=\"h-4 w-4 mr-2\" />\n                      Voltar\n                    </Button>\n                    <Button \n                      className=\"bg-orange-500 hover:bg-orange-600\"\n                      onClick={goToNextStep}\n                      disabled={!selectedFreight}\n                      data-testid=\"button-confirm-frete\"\n                    >\n                      Continuar\n                      <ArrowRight className=\"h-4 w-4 ml-2\" />\n                    </Button>\n                  </div>\n                </CardContent>\n              </Card>\n            )}\n\n            {currentStep === \"pagamento\" && (\n              <Card>\n                <CardHeader>\n                  <CardTitle className=\"flex items-center gap-2\">\n                    <CreditCard className=\"h-5 w-5\" />\n                    Forma de Pagamento\n                  </CardTitle>\n                  <CardDescription>\n                    Selecione como deseja pagar\n                  </CardDescription>\n                </CardHeader>\n                <CardContent className=\"space-y-6\">\n                  <div className=\"space-y-3\">\n                    <Label>Selecione o metodo de pagamento *</Label>\n                    <RadioGroup value={paymentMethod} onValueChange={setPaymentMethod}>\n                      {[\n                        { value: \"pix\", label: \"PIX\", description: \"Transferencia instantanea\" },\n                        { value: \"boleto\", label: \"Boleto Bancario\", description: \"Vencimento em 3 dias uteis\" },\n                        { value: \"cartao\", label: \"Cartao de Credito\", description: \"Ate 12x sem juros\" },\n                        { value: \"transferencia\", label: \"Transferencia Bancaria\", description: \"TED ou DOC\" },\n                        { value: \"combinar\", label: \"A Combinar\", description: \"Combinar com vendedor\" },\n                      ].map((method) => (\n                        <div \n                          key={method.value}\n                          className={`flex items-center space-x-3 p-4 rounded-lg border cursor-pointer transition-colors ${\n                            paymentMethod === method.value \n                              ? \"border-orange-500 bg-orange-500/10\" \n                              : \"border-border hover:border-orange-500/50\"\n                          }`}\n                          onClick={() => setPaymentMethod(method.value)}\n                          data-testid={`payment-option-${method.value}`}\n                        >\n                          <RadioGroupItem value={method.value} id={method.value} />\n                          <div className=\"flex-1\">\n                            <Label htmlFor={method.value} className=\"font-medium cursor-pointer\">\n                              {method.label}\n                            </Label>\n                            <p className=\"text-sm text-muted-foreground\">{method.description}</p>\n                          </div>\n                        </div>\n                      ))}\n                    </RadioGroup>\n                  </div>\n\n                  <div>\n                    <Label htmlFor=\"paymentNotes\">Observacoes sobre pagamento</Label>\n                    <Textarea\n                      id=\"paymentNotes\"\n                      placeholder=\"Alguma observacao sobre o pagamento? (opcional)\"\n                      value={paymentNotes}\n                      onChange={(e) => setPaymentNotes(e.target.value)}\n                      className=\"resize-none\"\n                      data-testid=\"textarea-payment-notes\"\n                    />\n                  </div>\n                  \n                  <div className=\"flex items-center justify-between gap-2\">\n                    <Button variant=\"ghost\" onClick={goToPreviousStep}>\n                      <ArrowLeft className=\"h-4 w-4 mr-2\" />\n                      Voltar\n                    </Button>\n                    <Button \n                      className=\"bg-orange-500 hover:bg-orange-600\"\n                      onClick={goToNextStep}\n                      disabled={!paymentMethod}\n                      data-testid=\"button-confirm-pagamento\"\n                    >\n                      Continuar\n                      <ArrowRight className=\"h-4 w-4 ml-2\" />\n                    </Button>\n                  </div>\n                </CardContent>\n              </Card>\n            )}\n\n            {currentStep === \"orcamento\" && (\n              <Card>\n                <CardHeader>\n                  <CardTitle className=\"flex items-center gap-2\">\n                    <FileText className=\"h-5 w-5\" />\n                    Gerar Orcamento\n                  </CardTitle>\n                  <CardDescription>\n                    Revise as informacoes e gere seu orcamento\n                  </CardDescription>\n                </CardHeader>\n                <CardContent className=\"space-y-6\">\n                  {/* Address Summary */}\n                  <div className=\"p-4 rounded-lg bg-muted/50 space-y-2\">\n                    <div className=\"flex items-center gap-2 font-medium\">\n                      <MapPin className=\"h-4 w-4 text-orange-500\" />\n                      Endereco de Entrega\n                    </div>\n                    <p className=\"text-sm text-muted-foreground\">\n                      {shippingAddress.street}, {shippingAddress.number}\n                      {shippingAddress.complement && ` - ${shippingAddress.complement}`}\n                    </p>\n                    <p className=\"text-sm text-muted-foreground\">\n                      {shippingAddress.neighborhood}, {shippingAddress.city} - {shippingAddress.state}\n                    </p>\n                    <p className=\"text-sm text-muted-foreground\">CEP: {shippingAddress.cep}</p>\n                  </div>\n\n                  {/* Freight Summary */}\n                  <div className=\"p-4 rounded-lg bg-muted/50 space-y-2\">\n                    <div className=\"flex items-center gap-2 font-medium\">\n                      <Truck className=\"h-4 w-4 text-orange-500\" />\n                      Frete Selecionado\n                    </div>\n                    <div className=\"flex items-center justify-between\">\n                      <span className=\"text-sm text-muted-foreground capitalize\">\n                        {selectedFreight === \"combinar\" ? \"A combinar com vendedor\" : `Entrega ${selectedFreight}`}\n                      </span>\n                      <span className=\"font-bold text-orange-600 dark:text-orange-500\">\n                        {getSelectedFreightPrice() === 0 ? \"Sob consulta\" : formatPrice(getSelectedFreightPrice())}\n                      </span>\n                    </div>\n                  </div>\n\n                  {/* Payment Summary */}\n                  <div className=\"p-4 rounded-lg bg-muted/50 space-y-2\">\n                    <div className=\"flex items-center gap-2 font-medium\">\n                      <CreditCard className=\"h-4 w-4 text-orange-500\" />\n                      Forma de Pagamento\n                    </div>\n                    <p className=\"text-sm text-muted-foreground capitalize\">\n                      {paymentMethod === \"combinar\" ? \"A combinar com vendedor\" : paymentMethod}\n                    </p>\n                    {paymentNotes && (\n                      <p className=\"text-xs text-muted-foreground\">Obs: {paymentNotes}</p>\n                    )}\n                  </div>\n\n                  <Separator />\n\n                  {/* Items Summary */}\n                  <div className=\"space-y-3\">\n                    <div className=\"font-medium\">Itens do Pedido</div>\n                    {items.map((item) => (\n                      <div key={item.id} className=\"flex justify-between text-sm\">\n                        <span className=\"text-muted-foreground\">\n                          {item.name} x {item.quantity}\n                        </span>\n                        <span>{formatPrice(item.price * item.quantity)}</span>\n                      </div>\n                    ))}\n                  </div>\n\n                  <Separator />\n\n                  {/* Totals */}\n                  <div className=\"space-y-2\">\n                    <div className=\"flex justify-between text-sm\">\n                      <span className=\"text-muted-foreground\">Subtotal</span>\n                      <span>{formatPrice(total)}</span>\n                    </div>\n                    <div className=\"flex justify-between text-sm\">\n                      <span className=\"text-muted-foreground\">Frete</span>\n                      <span>\n                        {getSelectedFreightPrice() === 0 ? \"Sob consulta\" : formatPrice(getSelectedFreightPrice())}\n                      </span>\n                    </div>\n                    <Separator />\n                    <div className=\"flex justify-between text-lg font-bold\">\n                      <span>Total</span>\n                      <span className=\"text-orange-600 dark:text-orange-500\">\n                        {getSelectedFreightPrice() === 0 \n                          ? `${formatPrice(total)} + frete` \n                          : formatPrice(total + getSelectedFreightPrice())}\n                      </span>\n                    </div>\n                  </div>\n                  \n                  <div className=\"flex items-center justify-between gap-2\">\n                    <Button variant=\"ghost\" onClick={goToPreviousStep}>\n                      <ArrowLeft className=\"h-4 w-4 mr-2\" />\n                      Voltar\n                    </Button>\n                    <Button \n                      className=\"bg-green-600 hover:bg-green-700\"\n                      onClick={handleGenerateOrder}\n                      disabled={isSubmitting}\n                      data-testid=\"button-gerar-orcamento\"\n                    >\n                      {isSubmitting ? (\n                        <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />\n                      ) : (\n                        <FileText className=\"h-4 w-4 mr-2\" />\n                      )}\n                      Gerar Orcamento\n                    </Button>\n                  </div>\n                </CardContent>\n              </Card>\n            )}\n          </div>\n\n          <div className=\"lg:col-span-1\">\n            <Card className=\"sticky top-24\">\n              <CardHeader>\n                <CardTitle className=\"text-base\">Resumo</CardTitle>\n              </CardHeader>\n              <CardContent className=\"space-y-4\">\n                <div className=\"flex items-center justify-between text-sm\">\n                  <span className=\"text-muted-foreground\">Itens ({itemCount})</span>\n                  <span>{formatPrice(total)}</span>\n                </div>\n                <div className=\"flex items-center justify-between text-sm\">\n                  <span className=\"text-muted-foreground\">Frete</span>\n                  <span className=\"text-muted-foreground\">\n                    {selectedFreight \n                      ? (getSelectedFreightPrice() === 0 ? \"Sob consulta\" : formatPrice(getSelectedFreightPrice()))\n                      : \"A calcular\"\n                    }\n                  </span>\n                </div>\n                <Separator />\n                <div className=\"flex items-center justify-between font-bold\">\n                  <span>Total</span>\n                  <span className=\"text-xl text-orange-600 dark:text-orange-500\">\n                    {selectedFreight && getSelectedFreightPrice() > 0\n                      ? formatPrice(total + getSelectedFreightPrice())\n                      : formatPrice(total)\n                    }\n                  </span>\n                </div>\n                {selectedFreight && getSelectedFreightPrice() === 0 && (\n                  <p className=\"text-xs text-muted-foreground text-center\">+ frete a combinar</p>\n                )}\n              </CardContent>\n            </Card>\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":49088,"size_tokens":null},"client/src/components/PWAInstallPrompt.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { X, Share, Plus, MoreVertical, Download } from \"lucide-react\";\n\ntype DeviceType = \"ios\" | \"android\" | \"desktop\" | \"unknown\";\n\nconst MAX_DISMISS_COUNT = 5;\nconst STORAGE_KEYS = {\n  installed: \"pwa-installed\",\n  dismissCount: \"pwa-dismiss-count\",\n  lastDismissTime: \"pwa-last-dismiss\",\n};\n\nfunction detectDevice(): DeviceType {\n  const ua = navigator.userAgent.toLowerCase();\n  \n  if (/iphone|ipad|ipod/.test(ua)) {\n    return \"ios\";\n  }\n  if (/android/.test(ua)) {\n    return \"android\";\n  }\n  if (/windows|macintosh|linux/.test(ua) && !/mobile/.test(ua)) {\n    return \"desktop\";\n  }\n  return \"unknown\";\n}\n\nfunction isStandalone(): boolean {\n  return (\n    window.matchMedia(\"(display-mode: standalone)\").matches ||\n    (window.navigator as any).standalone === true\n  );\n}\n\nfunction getDismissCount(): number {\n  const count = localStorage.getItem(STORAGE_KEYS.dismissCount);\n  return count ? parseInt(count, 10) : 0;\n}\n\nfunction isInstalled(): boolean {\n  return localStorage.getItem(STORAGE_KEYS.installed) === \"true\";\n}\n\nfunction shouldShowPrompt(): boolean {\n  if (isStandalone() || isInstalled()) {\n    return false;\n  }\n  \n  const dismissCount = getDismissCount();\n  if (dismissCount >= MAX_DISMISS_COUNT) {\n    return false;\n  }\n  \n  const lastDismiss = localStorage.getItem(STORAGE_KEYS.lastDismissTime);\n  if (lastDismiss) {\n    const hoursSinceLastDismiss = (Date.now() - parseInt(lastDismiss, 10)) / (1000 * 60 * 60);\n    if (hoursSinceLastDismiss < 24) {\n      return false;\n    }\n  }\n  \n  return true;\n}\n\nexport function PWAInstallPrompt() {\n  const [showPrompt, setShowPrompt] = useState(false);\n  const [deviceType, setDeviceType] = useState<DeviceType>(\"unknown\");\n\n  useEffect(() => {\n    if (isStandalone()) {\n      localStorage.setItem(STORAGE_KEYS.installed, \"true\");\n      return;\n    }\n\n    if (!shouldShowPrompt()) {\n      return;\n    }\n\n    const device = detectDevice();\n    setDeviceType(device);\n\n    if (device === \"ios\" || device === \"android\") {\n      const timer = setTimeout(() => {\n        setShowPrompt(true);\n      }, 2000);\n      return () => clearTimeout(timer);\n    }\n  }, []);\n\n  const handleInstalled = () => {\n    setShowPrompt(false);\n    localStorage.setItem(STORAGE_KEYS.installed, \"true\");\n  };\n\n  const handleDismiss = () => {\n    setShowPrompt(false);\n    const currentCount = getDismissCount();\n    localStorage.setItem(STORAGE_KEYS.dismissCount, String(currentCount + 1));\n    localStorage.setItem(STORAGE_KEYS.lastDismissTime, String(Date.now()));\n  };\n\n  const handleLater = () => {\n    handleDismiss();\n  };\n\n  if (!showPrompt) {\n    return null;\n  }\n\n  const dismissCount = getDismissCount();\n  const remainingShows = MAX_DISMISS_COUNT - dismissCount;\n\n  return (\n    <div className=\"fixed inset-0 z-50 flex items-end justify-center p-4 bg-black/50\" onClick={handleLater}>\n      <Card className=\"w-full max-w-md animate-in slide-in-from-bottom-4\" onClick={(e) => e.stopPropagation()}>\n        <CardContent className=\"pt-4\">\n          <div className=\"flex items-start justify-between gap-3 mb-4\">\n            <div className=\"flex items-center gap-3\">\n              <div className=\"w-12 h-12 rounded-xl bg-primary flex items-center justify-center text-primary-foreground\">\n                <Download className=\"h-6 w-6\" />\n              </div>\n              <div>\n                <h3 className=\"font-semibold text-lg\">Instale o Aplicativo</h3>\n                <p className=\"text-sm text-muted-foreground\">Acesso mais rápido e prático</p>\n              </div>\n            </div>\n            <Button variant=\"ghost\" size=\"icon\" onClick={handleDismiss} data-testid=\"button-dismiss-pwa\">\n              <X className=\"h-4 w-4\" />\n            </Button>\n          </div>\n\n          {deviceType === \"ios\" && (\n            <div className=\"space-y-3\">\n              <p className=\"text-sm text-muted-foreground\">\n                Para instalar este site como aplicativo no seu iPhone:\n              </p>\n              <div className=\"space-y-2\">\n                <div className=\"flex items-center gap-3 p-2 bg-muted/50 rounded-md\">\n                  <div className=\"w-8 h-8 rounded bg-primary/10 flex items-center justify-center flex-shrink-0\">\n                    <span className=\"text-sm font-semibold text-primary\">1</span>\n                  </div>\n                  <p className=\"text-sm\">\n                    Toque no botão <Share className=\"inline h-4 w-4 mx-1\" /> <strong>Compartilhar</strong> na barra inferior\n                  </p>\n                </div>\n                <div className=\"flex items-center gap-3 p-2 bg-muted/50 rounded-md\">\n                  <div className=\"w-8 h-8 rounded bg-primary/10 flex items-center justify-center flex-shrink-0\">\n                    <span className=\"text-sm font-semibold text-primary\">2</span>\n                  </div>\n                  <p className=\"text-sm\">\n                    Role e toque em <Plus className=\"inline h-4 w-4 mx-1\" /> <strong>Adicionar à Tela de Início</strong>\n                  </p>\n                </div>\n                <div className=\"flex items-center gap-3 p-2 bg-muted/50 rounded-md\">\n                  <div className=\"w-8 h-8 rounded bg-primary/10 flex items-center justify-center flex-shrink-0\">\n                    <span className=\"text-sm font-semibold text-primary\">3</span>\n                  </div>\n                  <p className=\"text-sm\">\n                    Confirme tocando em <strong>Adicionar</strong>\n                  </p>\n                </div>\n              </div>\n            </div>\n          )}\n\n          {deviceType === \"android\" && (\n            <div className=\"space-y-3\">\n              <p className=\"text-sm text-muted-foreground\">\n                Para instalar este site como aplicativo no seu Android:\n              </p>\n              <div className=\"space-y-2\">\n                <div className=\"flex items-center gap-3 p-2 bg-muted/50 rounded-md\">\n                  <div className=\"w-8 h-8 rounded bg-primary/10 flex items-center justify-center flex-shrink-0\">\n                    <span className=\"text-sm font-semibold text-primary\">1</span>\n                  </div>\n                  <p className=\"text-sm\">\n                    Toque no menu <MoreVertical className=\"inline h-4 w-4 mx-1\" /> (3 pontos) no canto superior\n                  </p>\n                </div>\n                <div className=\"flex items-center gap-3 p-2 bg-muted/50 rounded-md\">\n                  <div className=\"w-8 h-8 rounded bg-primary/10 flex items-center justify-center flex-shrink-0\">\n                    <span className=\"text-sm font-semibold text-primary\">2</span>\n                  </div>\n                  <p className=\"text-sm\">\n                    Toque em <strong>Instalar aplicativo</strong> ou <strong>Adicionar à tela inicial</strong>\n                  </p>\n                </div>\n                <div className=\"flex items-center gap-3 p-2 bg-muted/50 rounded-md\">\n                  <div className=\"w-8 h-8 rounded bg-primary/10 flex items-center justify-center flex-shrink-0\">\n                    <span className=\"text-sm font-semibold text-primary\">3</span>\n                  </div>\n                  <p className=\"text-sm\">\n                    Confirme tocando em <strong>Instalar</strong>\n                  </p>\n                </div>\n              </div>\n            </div>\n          )}\n\n          <div className=\"flex gap-2 mt-4\">\n            <Button variant=\"outline\" className=\"flex-1\" onClick={handleLater} data-testid=\"button-later-pwa\">\n              Agora não\n            </Button>\n            <Button className=\"flex-1\" onClick={handleInstalled} data-testid=\"button-ok-pwa\">\n              Já instalei\n            </Button>\n          </div>\n          \n          {remainingShows <= 3 && remainingShows > 0 && (\n            <p className=\"text-xs text-muted-foreground text-center mt-2\">\n              Este aviso aparecerá mais {remainingShows} vez{remainingShows > 1 ? \"es\" : \"\"}\n            </p>\n          )}\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","path":null,"size_bytes":8174,"size_tokens":null},"client/src/pages/purchases-dashboard.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Button } from \"@/components/ui/button\";\nimport { Loader2, AlertTriangle, TrendingDown, TrendingUp, ShoppingCart, Package, DollarSign, Tag, ChevronDown, ChevronRight } from \"lucide-react\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { StatCard } from \"@/components/StatCard\";\nimport { Collapsible, CollapsibleContent, CollapsibleTrigger } from \"@/components/ui/collapsible\";\nimport { useAuth } from \"@/contexts/AuthContext\";\n\ninterface LowStockProduct {\n  productId: number;\n  name: string;\n  sku: string;\n  categoryName: string | null;\n  currentStock: number;\n  reservedStock: number;\n  availableStock: number;\n  avgDailySales: number;\n  daysOfStock: number;\n  suggestedPurchaseQty: number;\n  urgency: 'critical' | 'high' | 'medium' | 'low';\n}\n\ninterface SlowMovingProduct {\n  productId: number;\n  name: string;\n  sku: string;\n  categoryName: string | null;\n  currentStock: number;\n  stockValue: number;\n  daysSinceLastSale: number;\n  totalSalesLast90Days: number;\n  avgDailySales: number;\n  recommendation: string;\n}\n\ninterface FastMovingProduct {\n  productId: number;\n  name: string;\n  sku: string;\n  categoryName: string | null;\n  currentStock: number;\n  avgDailySales: number;\n  daysOfStock: number;\n  salesLast30Days: number;\n  growthPercent: number;\n  suggestedPurchaseQty: number;\n}\n\ninterface PurchaseSuggestion {\n  productId: number;\n  name: string;\n  sku: string;\n  categoryName: string | null;\n  currentStock: number;\n  suggestedQty: number;\n  estimatedCost: number;\n  reason: string;\n  priority: 'urgent' | 'high' | 'normal';\n}\n\ninterface PurchasesAnalyticsData {\n  overview: {\n    totalLowStockProducts: number;\n    totalSlowMovingProducts: number;\n    totalFastMovingProducts: number;\n    estimatedPurchaseValue: number;\n    criticalItems: number;\n  };\n  lowStock: LowStockProduct[];\n  slowMoving: SlowMovingProduct[];\n  fastMoving: FastMovingProduct[];\n  suggestions: PurchaseSuggestion[];\n}\n\ninterface BrandSummary {\n  brand: string;\n  totalProducts: number;\n  totalStock: number;\n  lowStockCount: number;\n  outOfStockCount: number;\n  totalSales30d: number;\n  totalRevenue30d: number;\n  avgTurnover: number;\n}\n\ninterface BrandProductDetail {\n  productId: number;\n  name: string;\n  sku: string;\n  brand: string;\n  stock: number;\n  sales30d: number;\n  sales60d: number;\n  sales90d: number;\n  revenue30d: number;\n  lastSaleDate: string | null;\n  turnoverDays: number | null;\n  status: 'critical' | 'low' | 'ok' | 'overstock';\n  suggestedPurchase: number;\n}\n\ninterface BrandAnalyticsData {\n  brands: BrandSummary[];\n  productsByBrand: Record<string, BrandProductDetail[]>;\n  overview: {\n    totalBrands: number;\n    totalProducts: number;\n    totalLowStock: number;\n    totalOutOfStock: number;\n    topSellingBrand: string | null;\n    topSellingBrandRevenue: number;\n  };\n}\n\nconst brandStatusColors = {\n  critical: 'bg-red-500/10 text-red-600 dark:text-red-400 border-red-200 dark:border-red-800',\n  low: 'bg-orange-500/10 text-orange-600 dark:text-orange-400 border-orange-200 dark:border-orange-800',\n  ok: 'bg-green-500/10 text-green-600 dark:text-green-400 border-green-200 dark:border-green-800',\n  overstock: 'bg-blue-500/10 text-blue-600 dark:text-blue-400 border-blue-200 dark:border-blue-800',\n};\n\nconst brandStatusLabels = {\n  critical: 'Critico',\n  low: 'Baixo',\n  ok: 'OK',\n  overstock: 'Excesso',\n};\n\nconst urgencyColors = {\n  critical: 'bg-red-500/10 text-red-600 dark:text-red-400',\n  high: 'bg-orange-500/10 text-orange-600 dark:text-orange-400',\n  medium: 'bg-yellow-500/10 text-yellow-600 dark:text-yellow-400',\n  low: 'bg-blue-500/10 text-blue-600 dark:text-blue-400',\n};\n\nconst priorityColors = {\n  urgent: 'bg-red-500/10 text-red-600 dark:text-red-400',\n  high: 'bg-orange-500/10 text-orange-600 dark:text-orange-400',\n  normal: 'bg-green-500/10 text-green-600 dark:text-green-400',\n};\n\nexport default function PurchasesDashboardPage() {\n  const { isSupplier, user, isAuthenticated } = useAuth();\n  const [expandedBrands, setExpandedBrands] = useState<Set<string>>(new Set());\n\n  const { data, isLoading } = useQuery<PurchasesAnalyticsData>({\n    queryKey: ['/api/admin/purchases-analytics'],\n    enabled: !isSupplier && isAuthenticated,\n  });\n\n  const { data: brandData, isLoading: brandLoading } = useQuery<BrandAnalyticsData>({\n    queryKey: ['/api/admin/brand-analytics'],\n    enabled: isAuthenticated,\n  });\n\n  const toggleBrandExpansion = (brand: string) => {\n    setExpandedBrands(prev => {\n      const next = new Set(prev);\n      if (next.has(brand)) {\n        next.delete(brand);\n      } else {\n        next.add(brand);\n      }\n      return next;\n    });\n  };\n\n  if (isSupplier) {\n    if (brandLoading) {\n      return (\n        <div className=\"flex items-center justify-center min-h-[400px]\">\n          <Loader2 className=\"h-8 w-8 animate-spin text-muted-foreground\" />\n        </div>\n      );\n    }\n\n    if (!brandData) {\n      return (\n        <div className=\"p-6 lg:p-8\">\n          <p className=\"text-muted-foreground\">Erro ao carregar dados de marcas.</p>\n        </div>\n      );\n    }\n\n    return (\n      <div className=\"p-6 lg:p-8 space-y-8\">\n        <div>\n          <h1 className=\"text-3xl font-semibold\">Minhas Marcas</h1>\n          <p className=\"text-muted-foreground mt-1\">\n            Visualizacao das marcas: {user?.allowedBrands?.join(', ') || 'Nenhuma'}\n          </p>\n        </div>\n\n        <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4\">\n          <StatCard\n            title=\"Total de Marcas\"\n            value={brandData.overview.totalBrands}\n            icon={Tag}\n            data-testid=\"stat-total-brands\"\n          />\n          <StatCard\n            title=\"Total de Produtos\"\n            value={brandData.overview.totalProducts}\n            icon={Package}\n            data-testid=\"stat-total-products\"\n          />\n          <StatCard\n            title=\"Estoque Baixo\"\n            value={brandData.overview.totalLowStock}\n            icon={AlertTriangle}\n            data-testid=\"stat-low-stock\"\n          />\n          <StatCard\n            title=\"Sem Estoque\"\n            value={brandData.overview.totalOutOfStock}\n            icon={AlertTriangle}\n            data-testid=\"stat-out-of-stock\"\n          />\n        </div>\n\n        <div className=\"space-y-4\">\n          <h2 className=\"text-xl font-semibold\">Produtos por Marca</h2>\n          \n          {brandData.brands.length === 0 ? (\n            <Card>\n              <CardContent className=\"py-8\">\n                <p className=\"text-center text-muted-foreground\">Nenhuma marca atribuida a voce.</p>\n              </CardContent>\n            </Card>\n          ) : (\n            brandData.brands.map(brand => (\n              <Collapsible \n                key={brand.brand}\n                open={expandedBrands.has(brand.brand)}\n                onOpenChange={() => toggleBrandExpansion(brand.brand)}\n              >\n                <Card>\n                  <CardHeader className=\"pb-2\">\n                    <CollapsibleTrigger asChild>\n                      <Button variant=\"ghost\" className=\"w-full justify-between p-0 h-auto hover:bg-transparent\" data-testid={`brand-toggle-${brand.brand}`}>\n                        <div className=\"flex items-center gap-4\">\n                          {expandedBrands.has(brand.brand) ? (\n                            <ChevronDown className=\"h-5 w-5 text-muted-foreground\" />\n                          ) : (\n                            <ChevronRight className=\"h-5 w-5 text-muted-foreground\" />\n                          )}\n                          <CardTitle className=\"text-lg\">{brand.brand}</CardTitle>\n                          <div className=\"flex items-center gap-2\">\n                            <Badge variant=\"outline\">{brand.totalProducts} produtos</Badge>\n                            {brand.outOfStockCount > 0 && (\n                              <Badge className=\"bg-red-500/10 text-red-600 dark:text-red-400\">\n                                {brand.outOfStockCount} sem estoque\n                              </Badge>\n                            )}\n                            {brand.lowStockCount > 0 && (\n                              <Badge className=\"bg-orange-500/10 text-orange-600 dark:text-orange-400\">\n                                {brand.lowStockCount} baixo\n                              </Badge>\n                            )}\n                          </div>\n                        </div>\n                        <div className=\"flex items-center gap-6 text-sm\">\n                          <div className=\"text-right\">\n                            <span className=\"text-muted-foreground\">Estoque:</span>\n                            <span className=\"ml-2 font-semibold\">{brand.totalStock}</span>\n                          </div>\n                          <div className=\"text-right\">\n                            <span className=\"text-muted-foreground\">Vendas 30d:</span>\n                            <span className=\"ml-2 font-semibold\">{brand.totalSales30d}</span>\n                          </div>\n                        </div>\n                      </Button>\n                    </CollapsibleTrigger>\n                  </CardHeader>\n                  <CollapsibleContent>\n                    <CardContent className=\"pt-4\">\n                      <div className=\"space-y-2\">\n                        <div className=\"grid grid-cols-12 gap-4 text-sm font-medium text-muted-foreground pb-2 border-b\">\n                          <div className=\"col-span-3\">Produto</div>\n                          <div className=\"col-span-1 text-center\">SKU</div>\n                          <div className=\"col-span-1 text-center\">Estoque</div>\n                          <div className=\"col-span-1 text-center\">30d</div>\n                          <div className=\"col-span-1 text-center\">60d</div>\n                          <div className=\"col-span-1 text-center\">90d</div>\n                          <div className=\"col-span-1 text-center\">Giro</div>\n                          <div className=\"col-span-1 text-center\">Status</div>\n                          <div className=\"col-span-2 text-center\">Sugestao Compra</div>\n                        </div>\n                        {(brandData.productsByBrand[brand.brand] || []).map(product => (\n                          <div \n                            key={product.productId}\n                            className=\"grid grid-cols-12 gap-4 text-sm items-center py-2 hover-elevate rounded-md px-2\"\n                            data-testid={`product-row-${product.productId}`}\n                          >\n                            <div className=\"col-span-3 font-medium truncate\" title={product.name}>\n                              {product.name}\n                            </div>\n                            <div className=\"col-span-1 text-center\">\n                              <Badge variant=\"outline\" className=\"text-xs\">{product.sku}</Badge>\n                            </div>\n                            <div className=\"col-span-1 text-center font-semibold\">\n                              {product.stock}\n                            </div>\n                            <div className=\"col-span-1 text-center\">\n                              {product.sales30d}\n                            </div>\n                            <div className=\"col-span-1 text-center\">\n                              {product.sales60d}\n                            </div>\n                            <div className=\"col-span-1 text-center\">\n                              {product.sales90d}\n                            </div>\n                            <div className=\"col-span-1 text-center\">\n                              {product.turnoverDays !== null ? `${product.turnoverDays}d` : '-'}\n                            </div>\n                            <div className=\"col-span-1 text-center\">\n                              <Badge className={brandStatusColors[product.status]}>\n                                {brandStatusLabels[product.status]}\n                              </Badge>\n                            </div>\n                            <div className=\"col-span-2 text-center\">\n                              {product.suggestedPurchase > 0 ? (\n                                <div className=\"flex items-center justify-center gap-2\">\n                                  <ShoppingCart className=\"h-4 w-4 text-muted-foreground\" />\n                                  <span className=\"font-semibold text-primary\">{product.suggestedPurchase} un.</span>\n                                </div>\n                              ) : (\n                                <span className=\"text-muted-foreground\">-</span>\n                              )}\n                            </div>\n                          </div>\n                        ))}\n                      </div>\n                    </CardContent>\n                  </CollapsibleContent>\n                </Card>\n              </Collapsible>\n            ))\n          )}\n        </div>\n      </div>\n    );\n  }\n\n  if (isLoading || brandLoading) {\n    return (\n      <div className=\"flex items-center justify-center min-h-[400px]\">\n        <Loader2 className=\"h-8 w-8 animate-spin text-muted-foreground\" />\n      </div>\n    );\n  }\n\n  if (!data) {\n    return (\n      <div className=\"p-6 lg:p-8\">\n        <p className=\"text-muted-foreground\">Erro ao carregar dados de compras.</p>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"p-6 lg:p-8 space-y-8\">\n      <div>\n        <h1 className=\"text-3xl font-semibold\">Painel de Compras</h1>\n        <p className=\"text-muted-foreground mt-1\">Analise de estoque e sugestoes de reposicao</p>\n      </div>\n\n      <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4\">\n        <StatCard\n          title=\"Estoque Baixo\"\n          value={data.overview.totalLowStockProducts}\n          icon={AlertTriangle}\n          data-testid=\"stat-low-stock\"\n        />\n        <StatCard\n          title=\"Itens Criticos\"\n          value={data.overview.criticalItems}\n          icon={AlertTriangle}\n          data-testid=\"stat-critical-items\"\n        />\n        <StatCard\n          title=\"Giro Lento\"\n          value={data.overview.totalSlowMovingProducts}\n          icon={TrendingDown}\n          data-testid=\"stat-slow-moving\"\n        />\n        <StatCard\n          title=\"Giro Rapido\"\n          value={data.overview.totalFastMovingProducts}\n          icon={TrendingUp}\n          data-testid=\"stat-fast-moving\"\n        />\n        <StatCard\n          title=\"Custo Est. Compra\"\n          value={`R$ ${(data.overview.estimatedPurchaseValue ?? 0).toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`}\n          icon={DollarSign}\n          data-testid=\"stat-estimated-cost\"\n        />\n      </div>\n\n      <Tabs defaultValue=\"suggestions\" className=\"w-full\">\n        <TabsList className=\"grid w-full grid-cols-5\">\n          <TabsTrigger value=\"suggestions\" data-testid=\"tab-suggestions\">\n            <ShoppingCart className=\"h-4 w-4 mr-2\" />\n            Sugestoes\n          </TabsTrigger>\n          <TabsTrigger value=\"brands\" data-testid=\"tab-brands\">\n            <Tag className=\"h-4 w-4 mr-2\" />\n            Marcas\n          </TabsTrigger>\n          <TabsTrigger value=\"low-stock\" data-testid=\"tab-low-stock\">\n            <AlertTriangle className=\"h-4 w-4 mr-2\" />\n            Estoque Baixo\n          </TabsTrigger>\n          <TabsTrigger value=\"slow-moving\" data-testid=\"tab-slow-moving\">\n            <TrendingDown className=\"h-4 w-4 mr-2\" />\n            Giro Lento\n          </TabsTrigger>\n          <TabsTrigger value=\"fast-moving\" data-testid=\"tab-fast-moving\">\n            <TrendingUp className=\"h-4 w-4 mr-2\" />\n            Giro Rapido\n          </TabsTrigger>\n        </TabsList>\n\n        <TabsContent value=\"suggestions\" className=\"mt-6\">\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"flex items-center gap-2\">\n                <ShoppingCart className=\"h-5 w-5 text-muted-foreground\" />\n                Sugestoes Inteligentes de Compra\n              </CardTitle>\n            </CardHeader>\n            <CardContent>\n              {data.suggestions.length === 0 ? (\n                <p className=\"text-muted-foreground py-4\">Nenhuma sugestao de compra no momento.</p>\n              ) : (\n                <div className=\"space-y-3\">\n                  {data.suggestions.map((item) => (\n                    <div \n                      key={item.productId} \n                      className=\"flex flex-wrap items-center justify-between gap-4 p-4 rounded-md bg-muted/50\"\n                      data-testid={`suggestion-${item.productId}`}\n                    >\n                      <div className=\"flex-1 min-w-[200px]\">\n                        <div className=\"flex items-center gap-2 flex-wrap\">\n                          <span className=\"font-medium\">{item.name}</span>\n                          <Badge variant=\"outline\" className=\"text-xs\">{item.sku}</Badge>\n                          <Badge className={priorityColors[item.priority]}>\n                            {item.priority === 'urgent' ? 'Urgente' : item.priority === 'high' ? 'Alta' : 'Normal'}\n                          </Badge>\n                        </div>\n                        <p className=\"text-sm text-muted-foreground mt-1\">{item.reason}</p>\n                        {item.categoryName && (\n                          <p className=\"text-xs text-muted-foreground\">{item.categoryName}</p>\n                        )}\n                      </div>\n                      <div className=\"text-right\">\n                        <p className=\"text-sm\">Estoque: <span className=\"font-semibold\">{item.currentStock}</span></p>\n                        <p className=\"text-sm\">Sugerido: <span className=\"font-semibold text-primary\">{item.suggestedQty} un.</span></p>\n                        <p className=\"text-sm text-muted-foreground\">Est.: R$ {(item.estimatedCost ?? 0).toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</p>\n                      </div>\n                    </div>\n                  ))}\n                </div>\n              )}\n            </CardContent>\n          </Card>\n        </TabsContent>\n\n        <TabsContent value=\"brands\" className=\"mt-6\">\n          <div className=\"space-y-4\">\n            {!brandData || brandData.brands.length === 0 ? (\n              <Card>\n                <CardContent className=\"py-8\">\n                  <p className=\"text-center text-muted-foreground\">Nenhuma marca encontrada.</p>\n                </CardContent>\n              </Card>\n            ) : (\n              brandData.brands.map(brand => (\n                <Collapsible \n                  key={brand.brand}\n                  open={expandedBrands.has(brand.brand)}\n                  onOpenChange={() => toggleBrandExpansion(brand.brand)}\n                >\n                  <Card>\n                    <CardHeader className=\"pb-2\">\n                      <CollapsibleTrigger asChild>\n                        <Button variant=\"ghost\" className=\"w-full justify-between p-0 h-auto hover:bg-transparent\" data-testid={`brand-toggle-${brand.brand}`}>\n                          <div className=\"flex items-center gap-4\">\n                            {expandedBrands.has(brand.brand) ? (\n                              <ChevronDown className=\"h-5 w-5 text-muted-foreground\" />\n                            ) : (\n                              <ChevronRight className=\"h-5 w-5 text-muted-foreground\" />\n                            )}\n                            <CardTitle className=\"text-lg\">{brand.brand}</CardTitle>\n                            <div className=\"flex items-center gap-2\">\n                              <Badge variant=\"outline\">{brand.totalProducts} produtos</Badge>\n                              {brand.outOfStockCount > 0 && (\n                                <Badge className=\"bg-red-500/10 text-red-600 dark:text-red-400\">\n                                  {brand.outOfStockCount} sem estoque\n                                </Badge>\n                              )}\n                              {brand.lowStockCount > 0 && (\n                                <Badge className=\"bg-orange-500/10 text-orange-600 dark:text-orange-400\">\n                                  {brand.lowStockCount} baixo\n                                </Badge>\n                              )}\n                            </div>\n                          </div>\n                          <div className=\"flex items-center gap-6 text-sm\">\n                            <div className=\"text-right\">\n                              <span className=\"text-muted-foreground\">Estoque:</span>\n                              <span className=\"ml-2 font-semibold\">{brand.totalStock}</span>\n                            </div>\n                            <div className=\"text-right\">\n                              <span className=\"text-muted-foreground\">Vendas 30d:</span>\n                              <span className=\"ml-2 font-semibold\">{brand.totalSales30d}</span>\n                            </div>\n                            <div className=\"text-right\">\n                              <span className=\"text-muted-foreground\">Receita 30d:</span>\n                              <span className=\"ml-2 font-semibold\">\n                                R$ {brand.totalRevenue30d.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}\n                              </span>\n                            </div>\n                          </div>\n                        </Button>\n                      </CollapsibleTrigger>\n                    </CardHeader>\n                    <CollapsibleContent>\n                      <CardContent className=\"pt-4\">\n                        <div className=\"space-y-2\">\n                          <div className=\"grid grid-cols-12 gap-4 text-sm font-medium text-muted-foreground pb-2 border-b\">\n                            <div className=\"col-span-3\">Produto</div>\n                            <div className=\"col-span-1 text-center\">SKU</div>\n                            <div className=\"col-span-1 text-center\">Estoque</div>\n                            <div className=\"col-span-1 text-center\">30d</div>\n                            <div className=\"col-span-1 text-center\">60d</div>\n                            <div className=\"col-span-1 text-center\">90d</div>\n                            <div className=\"col-span-1 text-center\">Giro</div>\n                            <div className=\"col-span-1 text-center\">Status</div>\n                            <div className=\"col-span-2 text-center\">Sugestao Compra</div>\n                          </div>\n                          {(brandData.productsByBrand[brand.brand] || []).map(product => (\n                            <div \n                              key={product.productId}\n                              className=\"grid grid-cols-12 gap-4 text-sm items-center py-2 hover-elevate rounded-md px-2\"\n                              data-testid={`brand-product-row-${product.productId}`}\n                            >\n                              <div className=\"col-span-3 font-medium truncate\" title={product.name}>\n                                {product.name}\n                              </div>\n                              <div className=\"col-span-1 text-center\">\n                                <Badge variant=\"outline\" className=\"text-xs\">{product.sku}</Badge>\n                              </div>\n                              <div className=\"col-span-1 text-center font-semibold\">\n                                {product.stock}\n                              </div>\n                              <div className=\"col-span-1 text-center\">\n                                {product.sales30d}\n                              </div>\n                              <div className=\"col-span-1 text-center\">\n                                {product.sales60d}\n                              </div>\n                              <div className=\"col-span-1 text-center\">\n                                {product.sales90d}\n                              </div>\n                              <div className=\"col-span-1 text-center\">\n                                {product.turnoverDays !== null ? `${product.turnoverDays}d` : '-'}\n                              </div>\n                              <div className=\"col-span-1 text-center\">\n                                <Badge className={brandStatusColors[product.status]}>\n                                  {brandStatusLabels[product.status]}\n                                </Badge>\n                              </div>\n                              <div className=\"col-span-2 text-center\">\n                                {product.suggestedPurchase > 0 ? (\n                                  <div className=\"flex items-center justify-center gap-2\">\n                                    <ShoppingCart className=\"h-4 w-4 text-muted-foreground\" />\n                                    <span className=\"font-semibold text-primary\">{product.suggestedPurchase} un.</span>\n                                  </div>\n                                ) : (\n                                  <span className=\"text-muted-foreground\">-</span>\n                                )}\n                              </div>\n                            </div>\n                          ))}\n                        </div>\n                      </CardContent>\n                    </CollapsibleContent>\n                  </Card>\n                </Collapsible>\n              ))\n            )}\n          </div>\n        </TabsContent>\n\n        <TabsContent value=\"low-stock\" className=\"mt-6\">\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"flex items-center gap-2\">\n                <AlertTriangle className=\"h-5 w-5 text-muted-foreground\" />\n                Produtos com Estoque Baixo\n              </CardTitle>\n            </CardHeader>\n            <CardContent>\n              {data.lowStock.length === 0 ? (\n                <p className=\"text-muted-foreground py-4\">Nenhum produto com estoque baixo.</p>\n              ) : (\n                <div className=\"space-y-3\">\n                  {data.lowStock.map((item) => (\n                    <div \n                      key={item.productId} \n                      className=\"flex flex-wrap items-center justify-between gap-4 p-4 rounded-md bg-muted/50\"\n                      data-testid={`low-stock-${item.productId}`}\n                    >\n                      <div className=\"flex-1 min-w-[200px]\">\n                        <div className=\"flex items-center gap-2 flex-wrap\">\n                          <span className=\"font-medium\">{item.name}</span>\n                          <Badge variant=\"outline\" className=\"text-xs\">{item.sku}</Badge>\n                          <Badge className={urgencyColors[item.urgency]}>\n                            {item.urgency === 'critical' ? 'Critico' : \n                             item.urgency === 'high' ? 'Alto' : \n                             item.urgency === 'medium' ? 'Medio' : 'Baixo'}\n                          </Badge>\n                        </div>\n                        {item.categoryName && (\n                          <p className=\"text-xs text-muted-foreground\">{item.categoryName}</p>\n                        )}\n                      </div>\n                      <div className=\"grid grid-cols-2 md:grid-cols-4 gap-4 text-sm\">\n                        <div>\n                          <p className=\"text-muted-foreground\">Estoque</p>\n                          <p className=\"font-semibold\">{item.currentStock}</p>\n                        </div>\n                        <div>\n                          <p className=\"text-muted-foreground\">Disponivel</p>\n                          <p className=\"font-semibold\">{item.availableStock}</p>\n                        </div>\n                        <div>\n                          <p className=\"text-muted-foreground\">Dias Rest.</p>\n                          <p className=\"font-semibold\">{item.daysOfStock}</p>\n                        </div>\n                        <div>\n                          <p className=\"text-muted-foreground\">Comprar</p>\n                          <p className=\"font-semibold text-primary\">{item.suggestedPurchaseQty} un.</p>\n                        </div>\n                      </div>\n                    </div>\n                  ))}\n                </div>\n              )}\n            </CardContent>\n          </Card>\n        </TabsContent>\n\n        <TabsContent value=\"slow-moving\" className=\"mt-6\">\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"flex items-center gap-2\">\n                <TrendingDown className=\"h-5 w-5 text-muted-foreground\" />\n                Produtos com Giro Lento (para queimar)\n              </CardTitle>\n            </CardHeader>\n            <CardContent>\n              {data.slowMoving.length === 0 ? (\n                <p className=\"text-muted-foreground py-4\">Nenhum produto com giro lento.</p>\n              ) : (\n                <div className=\"space-y-3\">\n                  {data.slowMoving.map((item) => (\n                    <div \n                      key={item.productId} \n                      className=\"flex flex-wrap items-center justify-between gap-4 p-4 rounded-md bg-muted/50\"\n                      data-testid={`slow-moving-${item.productId}`}\n                    >\n                      <div className=\"flex-1 min-w-[200px]\">\n                        <div className=\"flex items-center gap-2 flex-wrap\">\n                          <span className=\"font-medium\">{item.name}</span>\n                          <Badge variant=\"outline\" className=\"text-xs\">{item.sku}</Badge>\n                        </div>\n                        <p className=\"text-sm text-orange-600 dark:text-orange-400 mt-1\">{item.recommendation}</p>\n                        {item.categoryName && (\n                          <p className=\"text-xs text-muted-foreground\">{item.categoryName}</p>\n                        )}\n                      </div>\n                      <div className=\"grid grid-cols-2 md:grid-cols-4 gap-4 text-sm\">\n                        <div>\n                          <p className=\"text-muted-foreground\">Estoque</p>\n                          <p className=\"font-semibold\">{item.currentStock}</p>\n                        </div>\n                        <div>\n                          <p className=\"text-muted-foreground\">Valor Est.</p>\n                          <p className=\"font-semibold\">R$ {(item.stockValue ?? 0).toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</p>\n                        </div>\n                        <div>\n                          <p className=\"text-muted-foreground\">Dias s/ Venda</p>\n                          <p className=\"font-semibold\">{item.daysSinceLastSale}</p>\n                        </div>\n                        <div>\n                          <p className=\"text-muted-foreground\">Vendas 90d</p>\n                          <p className=\"font-semibold\">{item.totalSalesLast90Days}</p>\n                        </div>\n                      </div>\n                    </div>\n                  ))}\n                </div>\n              )}\n            </CardContent>\n          </Card>\n        </TabsContent>\n\n        <TabsContent value=\"fast-moving\" className=\"mt-6\">\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"flex items-center gap-2\">\n                <TrendingUp className=\"h-5 w-5 text-muted-foreground\" />\n                Produtos com Giro Rapido (precisa repor)\n              </CardTitle>\n            </CardHeader>\n            <CardContent>\n              {data.fastMoving.length === 0 ? (\n                <p className=\"text-muted-foreground py-4\">Nenhum produto com giro rapido identificado.</p>\n              ) : (\n                <div className=\"space-y-3\">\n                  {data.fastMoving.map((item) => (\n                    <div \n                      key={item.productId} \n                      className=\"flex flex-wrap items-center justify-between gap-4 p-4 rounded-md bg-muted/50\"\n                      data-testid={`fast-moving-${item.productId}`}\n                    >\n                      <div className=\"flex-1 min-w-[200px]\">\n                        <div className=\"flex items-center gap-2 flex-wrap\">\n                          <span className=\"font-medium\">{item.name}</span>\n                          <Badge variant=\"outline\" className=\"text-xs\">{item.sku}</Badge>\n                          {item.growthPercent > 0 && (\n                            <Badge className=\"bg-green-500/10 text-green-600 dark:text-green-400\">\n                              +{item.growthPercent}%\n                            </Badge>\n                          )}\n                        </div>\n                        {item.categoryName && (\n                          <p className=\"text-xs text-muted-foreground\">{item.categoryName}</p>\n                        )}\n                      </div>\n                      <div className=\"grid grid-cols-2 md:grid-cols-4 gap-4 text-sm\">\n                        <div>\n                          <p className=\"text-muted-foreground\">Estoque</p>\n                          <p className=\"font-semibold\">{item.currentStock}</p>\n                        </div>\n                        <div>\n                          <p className=\"text-muted-foreground\">Vendas/dia</p>\n                          <p className=\"font-semibold\">{item.avgDailySales}</p>\n                        </div>\n                        <div>\n                          <p className=\"text-muted-foreground\">Vendas 30d</p>\n                          <p className=\"font-semibold\">{item.salesLast30Days}</p>\n                        </div>\n                        <div>\n                          <p className=\"text-muted-foreground\">Comprar</p>\n                          <p className=\"font-semibold text-primary\">{item.suggestedPurchaseQty} un.</p>\n                        </div>\n                      </div>\n                    </div>\n                  ))}\n                </div>\n              )}\n            </CardContent>\n          </Card>\n        </TabsContent>\n      </Tabs>\n    </div>\n  );\n}\n","path":null,"size_bytes":34307,"size_tokens":null},"client/src/pages/employee-analytics.tsx":{"content":"import { Card, CardContent, CardHeader, CardTitle, CardDescription } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { \n  RefreshCw, \n  Loader2, \n  Users, \n  TrendingUp,\n  TrendingDown,\n  DollarSign,\n  ClipboardList,\n  Crown,\n  Award\n} from \"lucide-react\";\nimport { useQuery } from \"@tanstack/react-query\";\n\ninterface EmployeeMetrics {\n  userId: string;\n  name: string;\n  email: string | null;\n  role: string;\n  totalOrders: number;\n  totalRevenue: number;\n  avgTicket: number;\n  ordersThisMonth: number;\n  revenueThisMonth: number;\n  ordersThisQuarter: number;\n  revenueThisQuarter: number;\n  lastActivity: string | null;\n}\n\ninterface EmployeeAnalyticsData {\n  employees: EmployeeMetrics[];\n  overview: {\n    totalEmployees: number;\n    totalOrdersThisMonth: number;\n    totalRevenueThisMonth: number;\n    avgOrdersPerEmployee: number;\n    topPerformer: string | null;\n  };\n  periodComparison: {\n    thisMonth: { orders: number; revenue: number };\n    lastMonth: { orders: number; revenue: number };\n    thisQuarter: { orders: number; revenue: number };\n    lastQuarter: { orders: number; revenue: number };\n  };\n}\n\nfunction formatCurrency(value: number): string {\n  return new Intl.NumberFormat('pt-BR', {\n    style: 'currency',\n    currency: 'BRL'\n  }).format(value);\n}\n\nfunction formatDate(dateStr: string | null): string {\n  if (!dateStr) return '-';\n  return new Intl.DateTimeFormat('pt-BR', {\n    day: '2-digit',\n    month: '2-digit',\n    year: 'numeric'\n  }).format(new Date(dateStr));\n}\n\nfunction RoleBadge({ role }: { role: string }) {\n  const styles: Record<string, string> = {\n    admin: 'bg-purple-500/10 text-purple-600 dark:text-purple-400',\n    sales: 'bg-blue-500/10 text-blue-600 dark:text-blue-400',\n  };\n  const labels: Record<string, string> = {\n    admin: 'Admin',\n    sales: 'Vendedor',\n  };\n  return <Badge className={styles[role] || 'bg-muted'}>{labels[role] || role}</Badge>;\n}\n\nfunction GrowthIndicator({ current, previous, type = 'number' }: { current: number; previous: number; type?: 'number' | 'currency' }) {\n  if (previous === 0) return null;\n  const growth = ((current - previous) / previous) * 100;\n  const isPositive = growth >= 0;\n  \n  return (\n    <div className={`flex items-center gap-1 text-xs ${isPositive ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'}`}>\n      {isPositive ? <TrendingUp className=\"h-3 w-3\" /> : <TrendingDown className=\"h-3 w-3\" />}\n      <span>{isPositive ? '+' : ''}{growth.toFixed(1)}%</span>\n    </div>\n  );\n}\n\nexport default function EmployeeAnalyticsPage() {\n  const { data: analytics, isLoading, refetch } = useQuery<EmployeeAnalyticsData>({\n    queryKey: ['/api/admin/employee-analytics'],\n  });\n\n  return (\n    <div className=\"p-4 lg:p-6 space-y-6\">\n      <div className=\"flex items-center justify-between gap-4 flex-wrap\">\n        <div>\n          <h1 className=\"text-2xl lg:text-3xl font-bold\" data-testid=\"text-page-title\">Analise de Funcionarios</h1>\n          <p className=\"text-sm text-muted-foreground mt-0.5\">\n            Metricas de desempenho da equipe (baseado em pedidos faturados)\n          </p>\n        </div>\n        <Button variant=\"outline\" onClick={() => refetch()} data-testid=\"button-refresh-analytics\">\n          <RefreshCw className=\"h-4 w-4 mr-2\" />\n          Atualizar\n        </Button>\n      </div>\n\n      {isLoading ? (\n        <div className=\"flex items-center justify-center py-16\">\n          <Loader2 className=\"h-10 w-10 animate-spin text-muted-foreground\" />\n        </div>\n      ) : (\n        <>\n          <div className=\"grid grid-cols-2 lg:grid-cols-5 gap-4\">\n            <Card>\n              <CardContent className=\"p-4\">\n                <div className=\"flex items-center gap-3\">\n                  <div className=\"p-2 rounded-lg bg-blue-500/10\">\n                    <Users className=\"h-5 w-5 text-blue-500\" />\n                  </div>\n                  <div>\n                    <p className=\"text-2xl font-bold\" data-testid=\"stat-total-employees\">\n                      {analytics?.overview.totalEmployees || 0}\n                    </p>\n                    <p className=\"text-xs text-muted-foreground\">Funcionarios</p>\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n\n            <Card>\n              <CardContent className=\"p-4\">\n                <div className=\"flex items-center gap-3\">\n                  <div className=\"p-2 rounded-lg bg-green-500/10\">\n                    <ClipboardList className=\"h-5 w-5 text-green-500\" />\n                  </div>\n                  <div>\n                    <p className=\"text-2xl font-bold\" data-testid=\"stat-orders-month\">\n                      {analytics?.overview.totalOrdersThisMonth || 0}\n                    </p>\n                    <p className=\"text-xs text-muted-foreground\">Pedidos no Mes</p>\n                    <GrowthIndicator \n                      current={analytics?.periodComparison.thisMonth.orders || 0} \n                      previous={analytics?.periodComparison.lastMonth.orders || 0} \n                    />\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n\n            <Card>\n              <CardContent className=\"p-4\">\n                <div className=\"flex items-center gap-3\">\n                  <div className=\"p-2 rounded-lg bg-yellow-500/10\">\n                    <DollarSign className=\"h-5 w-5 text-yellow-500\" />\n                  </div>\n                  <div>\n                    <p className=\"text-xl font-bold\" data-testid=\"stat-revenue-month\">\n                      {formatCurrency(analytics?.overview.totalRevenueThisMonth || 0)}\n                    </p>\n                    <p className=\"text-xs text-muted-foreground\">Faturamento Mes</p>\n                    <GrowthIndicator \n                      current={analytics?.periodComparison.thisMonth.revenue || 0} \n                      previous={analytics?.periodComparison.lastMonth.revenue || 0} \n                      type=\"currency\"\n                    />\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n\n            <Card>\n              <CardContent className=\"p-4\">\n                <div className=\"flex items-center gap-3\">\n                  <div className=\"p-2 rounded-lg bg-purple-500/10\">\n                    <TrendingUp className=\"h-5 w-5 text-purple-500\" />\n                  </div>\n                  <div>\n                    <p className=\"text-2xl font-bold\" data-testid=\"stat-avg-orders\">\n                      {analytics?.overview.avgOrdersPerEmployee || 0}\n                    </p>\n                    <p className=\"text-xs text-muted-foreground\">Media/Funcionario</p>\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n\n            <Card>\n              <CardContent className=\"p-4\">\n                <div className=\"flex items-center gap-3\">\n                  <div className=\"p-2 rounded-lg bg-orange-500/10\">\n                    <Crown className=\"h-5 w-5 text-orange-500\" />\n                  </div>\n                  <div className=\"min-w-0\">\n                    <p className=\"text-sm font-bold truncate\" data-testid=\"stat-top-performer\">\n                      {analytics?.overview.topPerformer || '-'}\n                    </p>\n                    <p className=\"text-xs text-muted-foreground\">Top Performer</p>\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n          </div>\n\n          <div className=\"grid lg:grid-cols-2 gap-4\">\n            <Card>\n              <CardHeader className=\"pb-2\">\n                <CardTitle className=\"text-lg\">Comparativo Mensal</CardTitle>\n                <CardDescription>Este mes vs mes anterior</CardDescription>\n              </CardHeader>\n              <CardContent>\n                <div className=\"grid grid-cols-2 gap-4\">\n                  <div className=\"space-y-2\">\n                    <p className=\"text-sm text-muted-foreground\">Este Mes</p>\n                    <p className=\"text-2xl font-bold\" data-testid=\"stat-this-month-orders\">{analytics?.periodComparison.thisMonth.orders || 0}</p>\n                    <p className=\"text-sm\" data-testid=\"stat-this-month-revenue\">{formatCurrency(analytics?.periodComparison.thisMonth.revenue || 0)}</p>\n                  </div>\n                  <div className=\"space-y-2\">\n                    <p className=\"text-sm text-muted-foreground\">Mes Anterior</p>\n                    <p className=\"text-2xl font-bold\" data-testid=\"stat-last-month-orders\">{analytics?.periodComparison.lastMonth.orders || 0}</p>\n                    <p className=\"text-sm\" data-testid=\"stat-last-month-revenue\">{formatCurrency(analytics?.periodComparison.lastMonth.revenue || 0)}</p>\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n\n            <Card>\n              <CardHeader className=\"pb-2\">\n                <CardTitle className=\"text-lg\">Comparativo Trimestral</CardTitle>\n                <CardDescription>Este trimestre vs trimestre anterior</CardDescription>\n              </CardHeader>\n              <CardContent>\n                <div className=\"grid grid-cols-2 gap-4\">\n                  <div className=\"space-y-2\">\n                    <p className=\"text-sm text-muted-foreground\">Este Trimestre</p>\n                    <p className=\"text-2xl font-bold\" data-testid=\"stat-this-quarter-orders\">{analytics?.periodComparison.thisQuarter.orders || 0}</p>\n                    <p className=\"text-sm\" data-testid=\"stat-this-quarter-revenue\">{formatCurrency(analytics?.periodComparison.thisQuarter.revenue || 0)}</p>\n                  </div>\n                  <div className=\"space-y-2\">\n                    <p className=\"text-sm text-muted-foreground\">Trimestre Anterior</p>\n                    <p className=\"text-2xl font-bold\" data-testid=\"stat-last-quarter-orders\">{analytics?.periodComparison.lastQuarter.orders || 0}</p>\n                    <p className=\"text-sm\" data-testid=\"stat-last-quarter-revenue\">{formatCurrency(analytics?.periodComparison.lastQuarter.revenue || 0)}</p>\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n          </div>\n\n          <Card>\n            <CardHeader className=\"pb-2\">\n              <div className=\"flex items-center gap-2\">\n                <Award className=\"h-5 w-5 text-yellow-500\" />\n                <CardTitle className=\"text-lg\">Ranking de Funcionarios</CardTitle>\n              </div>\n              <CardDescription>Ordenado por faturamento no mes atual</CardDescription>\n            </CardHeader>\n            <CardContent>\n              {(!analytics?.employees || analytics.employees.length === 0) ? (\n                <div className=\"text-center py-8 text-muted-foreground\" data-testid=\"empty-employees-message\">\n                  <Users className=\"h-12 w-12 mx-auto mb-3 opacity-50\" />\n                  <p>Nenhum funcionario encontrado</p>\n                </div>\n              ) : (\n                <div className=\"overflow-x-auto\">\n                  <table className=\"w-full text-sm\" data-testid=\"table-employees-ranking\">\n                    <thead>\n                      <tr className=\"border-b\">\n                        <th className=\"text-left py-3 px-2 font-medium text-muted-foreground\">#</th>\n                        <th className=\"text-left py-3 px-2 font-medium text-muted-foreground\">Funcionario</th>\n                        <th className=\"text-left py-3 px-2 font-medium text-muted-foreground\">Cargo</th>\n                        <th className=\"text-right py-3 px-2 font-medium text-muted-foreground\">Pedidos Mes</th>\n                        <th className=\"text-right py-3 px-2 font-medium text-muted-foreground\">Faturamento Mes</th>\n                        <th className=\"text-right py-3 px-2 font-medium text-muted-foreground\">Total Pedidos</th>\n                        <th className=\"text-right py-3 px-2 font-medium text-muted-foreground\">Total Faturamento</th>\n                        <th className=\"text-right py-3 px-2 font-medium text-muted-foreground\">Ticket Medio</th>\n                        <th className=\"text-right py-3 px-2 font-medium text-muted-foreground\">Ultima Atividade</th>\n                      </tr>\n                    </thead>\n                    <tbody>\n                      {analytics.employees.map((employee, idx) => (\n                        <tr key={employee.userId} className=\"border-b last:border-0 hover:bg-muted/50\" data-testid={`row-employee-${employee.userId}`}>\n                          <td className=\"py-3 px-2\">\n                            {idx < 3 ? (\n                              <div className={`w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold ${\n                                idx === 0 ? 'bg-yellow-500/20 text-yellow-600' :\n                                idx === 1 ? 'bg-gray-400/20 text-gray-600' :\n                                'bg-orange-500/20 text-orange-600'\n                              }`}>\n                                {idx + 1}\n                              </div>\n                            ) : (\n                              <span className=\"text-muted-foreground\">{idx + 1}</span>\n                            )}\n                          </td>\n                          <td className=\"py-3 px-2\">\n                            <div>\n                              <p className=\"font-medium\">{employee.name}</p>\n                              {employee.email && (\n                                <p className=\"text-xs text-muted-foreground\">{employee.email}</p>\n                              )}\n                            </div>\n                          </td>\n                          <td className=\"py-3 px-2\">\n                            <RoleBadge role={employee.role} />\n                          </td>\n                          <td className=\"py-3 px-2 text-right font-medium\">{employee.ordersThisMonth}</td>\n                          <td className=\"py-3 px-2 text-right font-medium\">{formatCurrency(employee.revenueThisMonth)}</td>\n                          <td className=\"py-3 px-2 text-right\">{employee.totalOrders}</td>\n                          <td className=\"py-3 px-2 text-right\">{formatCurrency(employee.totalRevenue)}</td>\n                          <td className=\"py-3 px-2 text-right\">{formatCurrency(employee.avgTicket)}</td>\n                          <td className=\"py-3 px-2 text-right\">{formatDate(employee.lastActivity)}</td>\n                        </tr>\n                      ))}\n                    </tbody>\n                  </table>\n                </div>\n              )}\n            </CardContent>\n          </Card>\n        </>\n      )}\n    </div>\n  );\n}\n","path":null,"size_bytes":14790,"size_tokens":null},"client/src/pages/agenda.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Input } from \"@/components/ui/input\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogHeader,\n  DialogTitle,\n  DialogFooter,\n} from \"@/components/ui/dialog\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport { Label } from \"@/components/ui/label\";\nimport { Checkbox } from \"@/components/ui/checkbox\";\nimport {\n  Plus,\n  Trash2,\n  Pencil,\n  Calendar as CalendarIcon,\n  Clock,\n  CheckCircle2,\n  Circle,\n  Loader2,\n  StickyNote,\n  Users,\n  ListTodo,\n  Bell,\n} from \"lucide-react\";\nimport { format, startOfMonth, endOfMonth, addMonths, subMonths, isSameDay, parseISO } from \"date-fns\";\nimport { ptBR } from \"date-fns/locale\";\nimport type { AgendaEvent } from \"@shared/schema\";\n\nconst eventTypes = [\n  { value: \"note\", label: \"Anotacao\", icon: StickyNote, color: \"bg-blue-500\" },\n  { value: \"meeting\", label: \"Reuniao\", icon: Users, color: \"bg-purple-500\" },\n  { value: \"task\", label: \"Tarefa\", icon: ListTodo, color: \"bg-green-500\" },\n  { value: \"reminder\", label: \"Lembrete\", icon: Bell, color: \"bg-orange-500\" },\n];\n\nexport default function AgendaPage() {\n  const { toast } = useToast();\n  const [currentMonth, setCurrentMonth] = useState(new Date());\n  const [selectedDate, setSelectedDate] = useState<Date | null>(null);\n  const [isDialogOpen, setIsDialogOpen] = useState(false);\n  const [editingEvent, setEditingEvent] = useState<AgendaEvent | null>(null);\n\n  const [formData, setFormData] = useState({\n    title: \"\",\n    description: \"\",\n    date: \"\",\n    time: \"\",\n    type: \"note\",\n  });\n\n  const startDate = startOfMonth(currentMonth);\n  const endDate = endOfMonth(currentMonth);\n\n  const { data: events = [], isLoading, refetch } = useQuery<AgendaEvent[]>({\n    queryKey: [\"/api/agenda\", startDate.toISOString(), endDate.toISOString()],\n    queryFn: async () => {\n      const params = new URLSearchParams({\n        startDate: startDate.toISOString(),\n        endDate: endDate.toISOString(),\n      });\n      const res = await fetch(`/api/agenda?${params}`, { credentials: \"include\" });\n      if (!res.ok) throw new Error(\"Failed to fetch events\");\n      return res.json();\n    },\n  });\n\n  const createEventMutation = useMutation({\n    mutationFn: (data: any) => apiRequest(\"POST\", \"/api/agenda\", data),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/agenda\"] });\n      toast({ title: \"Evento criado com sucesso\" });\n      closeDialog();\n    },\n    onError: () => {\n      toast({ title: \"Erro ao criar evento\", variant: \"destructive\" });\n    },\n  });\n\n  const updateEventMutation = useMutation({\n    mutationFn: ({ id, data }: { id: number; data: any }) => \n      apiRequest(\"PATCH\", `/api/agenda/${id}`, data),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/agenda\"] });\n      toast({ title: \"Evento atualizado com sucesso\" });\n      closeDialog();\n    },\n    onError: () => {\n      toast({ title: \"Erro ao atualizar evento\", variant: \"destructive\" });\n    },\n  });\n\n  const deleteEventMutation = useMutation({\n    mutationFn: (id: number) => apiRequest(\"DELETE\", `/api/agenda/${id}`),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/agenda\"] });\n      toast({ title: \"Evento excluido com sucesso\" });\n    },\n    onError: () => {\n      toast({ title: \"Erro ao excluir evento\", variant: \"destructive\" });\n    },\n  });\n\n  const toggleCompleted = useMutation({\n    mutationFn: ({ id, completed }: { id: number; completed: boolean }) => \n      apiRequest(\"PATCH\", `/api/agenda/${id}`, { completed }),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/agenda\"] });\n    },\n  });\n\n  const closeDialog = () => {\n    setIsDialogOpen(false);\n    setEditingEvent(null);\n    setFormData({ title: \"\", description: \"\", date: \"\", time: \"\", type: \"note\" });\n  };\n\n  const openCreateDialog = (date?: Date) => {\n    setFormData({\n      title: \"\",\n      description: \"\",\n      date: date ? format(date, \"yyyy-MM-dd\") : format(new Date(), \"yyyy-MM-dd\"),\n      time: \"\",\n      type: \"note\",\n    });\n    setEditingEvent(null);\n    setIsDialogOpen(true);\n  };\n\n  const openEditDialog = (event: AgendaEvent) => {\n    try {\n      const eventDate = event.date ? new Date(event.date) : new Date();\n      const formattedDate = !isNaN(eventDate.getTime()) ? format(eventDate, \"yyyy-MM-dd\") : format(new Date(), \"yyyy-MM-dd\");\n      setFormData({\n        title: event.title,\n        description: event.description || \"\",\n        date: formattedDate,\n        time: event.time || \"\",\n        type: event.type,\n      });\n      setEditingEvent(event);\n      setIsDialogOpen(true);\n    } catch {\n      toast({ title: \"Erro ao carregar evento\", variant: \"destructive\" });\n    }\n  };\n\n  const handleSubmit = (e: React.FormEvent) => {\n    e.preventDefault();\n    if (!formData.title || !formData.date) {\n      toast({ title: \"Preencha o titulo e a data\", variant: \"destructive\" });\n      return;\n    }\n\n    const eventData = {\n      title: formData.title,\n      description: formData.description || null,\n      date: formData.date,\n      time: formData.time || null,\n      type: formData.type,\n    };\n\n    if (editingEvent) {\n      updateEventMutation.mutate({ id: editingEvent.id, data: eventData });\n    } else {\n      createEventMutation.mutate(eventData);\n    }\n  };\n\n  const getDaysInMonth = () => {\n    const days = [];\n    const start = startOfMonth(currentMonth);\n    const end = endOfMonth(currentMonth);\n    \n    const startDayOfWeek = start.getDay();\n    for (let i = 0; i < startDayOfWeek; i++) {\n      days.push(null);\n    }\n    \n    let current = start;\n    while (current <= end) {\n      days.push(new Date(current));\n      current = new Date(current);\n      current.setDate(current.getDate() + 1);\n    }\n    \n    return days;\n  };\n\n  const getEventsForDate = (date: Date) => {\n    return events.filter(event => {\n      try {\n        const eventDate = event.date ? new Date(event.date) : null;\n        if (!eventDate || isNaN(eventDate.getTime())) return false;\n        return isSameDay(eventDate, date);\n      } catch {\n        return false;\n      }\n    });\n  };\n\n  const getTypeConfig = (type: string) => {\n    return eventTypes.find(t => t.value === type) || eventTypes[0];\n  };\n\n  const days = getDaysInMonth();\n  const weekDays = [\"Dom\", \"Seg\", \"Ter\", \"Qua\", \"Qui\", \"Sex\", \"Sab\"];\n\n  return (\n    <div className=\"p-6 space-y-6\">\n      <div className=\"flex items-center justify-between flex-wrap gap-4\">\n        <div>\n          <h1 className=\"text-3xl font-bold\" data-testid=\"text-page-title\">Agenda</h1>\n          <p className=\"text-muted-foreground\">Gerencie seus compromissos e anotacoes</p>\n        </div>\n        <Button onClick={() => openCreateDialog()} data-testid=\"button-add-event\">\n          <Plus className=\"h-4 w-4 mr-2\" />\n          Novo Evento\n        </Button>\n      </div>\n\n      <div className=\"flex items-center justify-between gap-4 mb-4\">\n        <Button variant=\"outline\" onClick={() => setCurrentMonth(subMonths(currentMonth, 1))} data-testid=\"button-prev-month\">\n          Anterior\n        </Button>\n        <h2 className=\"text-xl font-semibold\">\n          {format(currentMonth, \"MMMM yyyy\", { locale: ptBR })}\n        </h2>\n        <Button variant=\"outline\" onClick={() => setCurrentMonth(addMonths(currentMonth, 1))} data-testid=\"button-next-month\">\n          Proximo\n        </Button>\n      </div>\n\n      {isLoading ? (\n        <div className=\"flex items-center justify-center py-12\">\n          <Loader2 className=\"h-8 w-8 animate-spin text-muted-foreground\" />\n        </div>\n      ) : (\n        <div className=\"grid grid-cols-1 lg:grid-cols-4 gap-6\">\n          <Card className=\"lg:col-span-3\">\n            <CardContent className=\"p-4\">\n              <div className=\"grid grid-cols-7 gap-1\">\n                {weekDays.map((day) => (\n                  <div key={day} className=\"text-center text-sm font-medium text-muted-foreground p-2\">\n                    {day}\n                  </div>\n                ))}\n                {days.map((day, idx) => {\n                  if (!day) {\n                    return <div key={`empty-${idx}`} className=\"p-2 min-h-[100px]\" />;\n                  }\n                  const dayEvents = getEventsForDate(day);\n                  const isToday = isSameDay(day, new Date());\n                  const isSelected = selectedDate && isSameDay(day, selectedDate);\n\n                  return (\n                    <div\n                      key={day.toISOString()}\n                      className={`p-2 min-h-[100px] border rounded-lg cursor-pointer transition-colors hover-elevate ${\n                        isToday ? \"bg-primary/10 border-primary\" : \"border-border\"\n                      } ${isSelected ? \"ring-2 ring-primary\" : \"\"}`}\n                      onClick={() => setSelectedDate(day)}\n                      data-testid={`calendar-day-${format(day, \"yyyy-MM-dd\")}`}\n                    >\n                      <div className=\"text-sm font-medium mb-1\">{format(day, \"d\")}</div>\n                      <div className=\"space-y-1\">\n                        {dayEvents.slice(0, 3).map((event) => {\n                          const typeConfig = getTypeConfig(event.type);\n                          return (\n                            <div\n                              key={event.id}\n                              className={`text-xs p-1 rounded truncate ${typeConfig.color} text-white ${event.completed ? \"opacity-50 line-through\" : \"\"}`}\n                              title={event.title}\n                            >\n                              {event.title}\n                            </div>\n                          );\n                        })}\n                        {dayEvents.length > 3 && (\n                          <div className=\"text-xs text-muted-foreground\">+{dayEvents.length - 3} mais</div>\n                        )}\n                      </div>\n                    </div>\n                  );\n                })}\n              </div>\n            </CardContent>\n          </Card>\n\n          <Card>\n            <CardHeader className=\"pb-3\">\n              <CardTitle className=\"text-lg flex items-center gap-2\">\n                <CalendarIcon className=\"h-5 w-5\" />\n                {selectedDate ? format(selectedDate, \"dd 'de' MMMM\", { locale: ptBR }) : \"Selecione um dia\"}\n              </CardTitle>\n            </CardHeader>\n            <CardContent className=\"space-y-3\">\n              {selectedDate && (\n                <>\n                  <Button \n                    variant=\"outline\" \n                    size=\"sm\" \n                    className=\"w-full\" \n                    onClick={() => openCreateDialog(selectedDate)}\n                    data-testid=\"button-add-event-selected-date\"\n                  >\n                    <Plus className=\"h-4 w-4 mr-2\" />\n                    Adicionar evento\n                  </Button>\n                  \n                  {getEventsForDate(selectedDate).length === 0 ? (\n                    <p className=\"text-sm text-muted-foreground text-center py-4\">\n                      Nenhum evento para este dia\n                    </p>\n                  ) : (\n                    <div className=\"space-y-2\">\n                      {getEventsForDate(selectedDate).map((event) => {\n                        const typeConfig = getTypeConfig(event.type);\n                        const TypeIcon = typeConfig.icon;\n                        return (\n                          <div\n                            key={event.id}\n                            className={`p-3 rounded-lg border ${event.completed ? \"opacity-60\" : \"\"}`}\n                            data-testid={`event-card-${event.id}`}\n                          >\n                            <div className=\"flex items-start gap-2\">\n                              <button\n                                onClick={() => toggleCompleted.mutate({ id: event.id, completed: !event.completed })}\n                                className=\"mt-0.5\"\n                                data-testid={`button-toggle-complete-${event.id}`}\n                              >\n                                {event.completed ? (\n                                  <CheckCircle2 className=\"h-4 w-4 text-green-500\" />\n                                ) : (\n                                  <Circle className=\"h-4 w-4 text-muted-foreground\" />\n                                )}\n                              </button>\n                              <div className=\"flex-1 min-w-0\">\n                                <p className={`font-medium text-sm ${event.completed ? \"line-through\" : \"\"}`}>\n                                  {event.title}\n                                </p>\n                                {event.time && (\n                                  <p className=\"text-xs text-muted-foreground flex items-center gap-1 mt-1\">\n                                    <Clock className=\"h-3 w-3\" />\n                                    {event.time}\n                                  </p>\n                                )}\n                                {event.description && (\n                                  <p className=\"text-xs text-muted-foreground mt-1 line-clamp-2\">\n                                    {event.description}\n                                  </p>\n                                )}\n                              </div>\n                              <div className=\"flex items-center gap-1\">\n                                <Badge variant=\"outline\" className=\"text-xs\">\n                                  <TypeIcon className=\"h-3 w-3 mr-1\" />\n                                  {typeConfig.label}\n                                </Badge>\n                              </div>\n                            </div>\n                            <div className=\"flex items-center gap-1 mt-2 justify-end\">\n                              <Button\n                                variant=\"ghost\"\n                                size=\"icon\"\n                                onClick={() => openEditDialog(event)}\n                                data-testid={`button-edit-event-${event.id}`}\n                              >\n                                <Pencil className=\"h-4 w-4\" />\n                              </Button>\n                              <Button\n                                variant=\"ghost\"\n                                size=\"icon\"\n                                className=\"text-destructive\"\n                                onClick={() => deleteEventMutation.mutate(event.id)}\n                                data-testid={`button-delete-event-${event.id}`}\n                              >\n                                <Trash2 className=\"h-4 w-4\" />\n                              </Button>\n                            </div>\n                          </div>\n                        );\n                      })}\n                    </div>\n                  )}\n                </>\n              )}\n              \n              {!selectedDate && (\n                <p className=\"text-sm text-muted-foreground text-center py-4\">\n                  Clique em um dia no calendario para ver os eventos\n                </p>\n              )}\n            </CardContent>\n          </Card>\n        </div>\n      )}\n\n      <Dialog open={isDialogOpen} onOpenChange={setIsDialogOpen}>\n        <DialogContent className=\"max-w-md\">\n          <DialogHeader>\n            <DialogTitle>{editingEvent ? \"Editar Evento\" : \"Novo Evento\"}</DialogTitle>\n          </DialogHeader>\n          <form onSubmit={handleSubmit} className=\"space-y-4\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"title\">Titulo</Label>\n              <Input\n                id=\"title\"\n                value={formData.title}\n                onChange={(e) => setFormData({ ...formData, title: e.target.value })}\n                placeholder=\"Digite o titulo do evento\"\n                data-testid=\"input-event-title\"\n              />\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"description\">Descricao</Label>\n              <Textarea\n                id=\"description\"\n                value={formData.description}\n                onChange={(e) => setFormData({ ...formData, description: e.target.value })}\n                placeholder=\"Descricao opcional\"\n                data-testid=\"input-event-description\"\n              />\n            </div>\n\n            <div className=\"grid grid-cols-2 gap-4\">\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"date\">Data</Label>\n                <Input\n                  id=\"date\"\n                  type=\"date\"\n                  value={formData.date}\n                  onChange={(e) => setFormData({ ...formData, date: e.target.value })}\n                  data-testid=\"input-event-date\"\n                />\n              </div>\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"time\">Hora</Label>\n                <Input\n                  id=\"time\"\n                  type=\"time\"\n                  value={formData.time}\n                  onChange={(e) => setFormData({ ...formData, time: e.target.value })}\n                  data-testid=\"input-event-time\"\n                />\n              </div>\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label>Tipo</Label>\n              <Select\n                value={formData.type}\n                onValueChange={(value) => setFormData({ ...formData, type: value })}\n              >\n                <SelectTrigger data-testid=\"select-event-type\">\n                  <SelectValue />\n                </SelectTrigger>\n                <SelectContent>\n                  {eventTypes.map((type) => (\n                    <SelectItem key={type.value} value={type.value}>\n                      <div className=\"flex items-center gap-2\">\n                        <type.icon className=\"h-4 w-4\" />\n                        {type.label}\n                      </div>\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n\n            <DialogFooter>\n              <Button type=\"button\" variant=\"outline\" onClick={closeDialog}>\n                Cancelar\n              </Button>\n              <Button \n                type=\"submit\" \n                disabled={createEventMutation.isPending || updateEventMutation.isPending}\n                data-testid=\"button-save-event\"\n              >\n                {(createEventMutation.isPending || updateEventMutation.isPending) && (\n                  <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />\n                )}\n                {editingEvent ? \"Atualizar\" : \"Criar\"}\n              </Button>\n            </DialogFooter>\n          </form>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n","path":null,"size_bytes":19257,"size_tokens":null},"client/src/pages/catalog-customization.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Switch } from \"@/components/ui/switch\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { Dialog, DialogContent, DialogDescription, DialogHeader, DialogTitle, DialogTrigger, DialogFooter } from \"@/components/ui/dialog\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Plus, Trash2, Edit, Image, GripVertical, Eye, EyeOff, Upload, Link, Layers, Settings, Palette } from \"lucide-react\";\nimport type { CatalogSlide, CatalogBanner } from \"@shared/schema\";\n\nexport default function CatalogCustomizationPage() {\n  const { toast } = useToast();\n  const [activeTab, setActiveTab] = useState(\"slides\");\n\n  return (\n    <div className=\"p-4 lg:p-6 space-y-6\">\n      <div className=\"flex items-center justify-between gap-4 flex-wrap\">\n        <div>\n          <h1 className=\"text-2xl lg:text-3xl font-bold flex items-center gap-2\">\n            <Palette className=\"h-7 w-7\" />\n            Personalizar Catálogo\n          </h1>\n          <p className=\"text-sm text-muted-foreground mt-0.5\">\n            Customize banners, slides e aparência da sua loja\n          </p>\n        </div>\n      </div>\n\n      <Tabs value={activeTab} onValueChange={setActiveTab} className=\"space-y-4\">\n        <TabsList className=\"grid w-full grid-cols-3 lg:w-auto lg:inline-flex\">\n          <TabsTrigger value=\"slides\" className=\"flex items-center gap-2\" data-testid=\"tab-slides\">\n            <Layers className=\"h-4 w-4\" />\n            Carrossel\n          </TabsTrigger>\n          <TabsTrigger value=\"banners\" className=\"flex items-center gap-2\" data-testid=\"tab-banners\">\n            <Image className=\"h-4 w-4\" />\n            Banners\n          </TabsTrigger>\n          <TabsTrigger value=\"settings\" className=\"flex items-center gap-2\" data-testid=\"tab-settings\">\n            <Settings className=\"h-4 w-4\" />\n            Configurações\n          </TabsTrigger>\n        </TabsList>\n\n        <TabsContent value=\"slides\" className=\"space-y-4\">\n          <SlidesManager />\n        </TabsContent>\n\n        <TabsContent value=\"banners\" className=\"space-y-4\">\n          <BannersManager />\n        </TabsContent>\n\n        <TabsContent value=\"settings\" className=\"space-y-4\">\n          <CatalogSettings />\n        </TabsContent>\n      </Tabs>\n    </div>\n  );\n}\n\nfunction SlidesManager() {\n  const { toast } = useToast();\n  const [isDialogOpen, setIsDialogOpen] = useState(false);\n  const [editingSlide, setEditingSlide] = useState<CatalogSlide | null>(null);\n  const [formData, setFormData] = useState({\n    title: \"\",\n    subtitle: \"\",\n    buttonText: \"\",\n    buttonLink: \"\",\n    imageUrl: \"\",\n    mobileImageUrl: \"\",\n    order: 0,\n    active: true,\n  });\n\n  const { data: slides = [], isLoading } = useQuery<CatalogSlide[]>({\n    queryKey: ['/api/catalog/slides'],\n  });\n\n  const createMutation = useMutation({\n    mutationFn: async (data: typeof formData) => {\n      return apiRequest('POST', '/api/catalog/slides', data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/catalog/slides'] });\n      toast({ title: \"Sucesso\", description: \"Slide criado com sucesso\" });\n      resetForm();\n    },\n    onError: () => {\n      toast({ title: \"Erro\", description: \"Falha ao criar slide\", variant: \"destructive\" });\n    },\n  });\n\n  const updateMutation = useMutation({\n    mutationFn: async ({ id, data }: { id: number; data: Partial<typeof formData> }) => {\n      return apiRequest('PATCH', `/api/catalog/slides/${id}`, data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/catalog/slides'] });\n      toast({ title: \"Sucesso\", description: \"Slide atualizado com sucesso\" });\n      resetForm();\n    },\n    onError: () => {\n      toast({ title: \"Erro\", description: \"Falha ao atualizar slide\", variant: \"destructive\" });\n    },\n  });\n\n  const deleteMutation = useMutation({\n    mutationFn: async (id: number) => {\n      return apiRequest('DELETE', `/api/catalog/slides/${id}`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/catalog/slides'] });\n      toast({ title: \"Sucesso\", description: \"Slide removido com sucesso\" });\n    },\n    onError: () => {\n      toast({ title: \"Erro\", description: \"Falha ao remover slide\", variant: \"destructive\" });\n    },\n  });\n\n  const resetForm = () => {\n    setFormData({\n      title: \"\",\n      subtitle: \"\",\n      buttonText: \"\",\n      buttonLink: \"\",\n      imageUrl: \"\",\n      mobileImageUrl: \"\",\n      order: slides.length,\n      active: true,\n    });\n    setEditingSlide(null);\n    setIsDialogOpen(false);\n  };\n\n  const handleEdit = (slide: CatalogSlide) => {\n    setEditingSlide(slide);\n    setFormData({\n      title: slide.title || \"\",\n      subtitle: slide.subtitle || \"\",\n      buttonText: slide.buttonText || \"\",\n      buttonLink: slide.buttonLink || \"\",\n      imageUrl: slide.imageUrl,\n      mobileImageUrl: slide.mobileImageUrl || \"\",\n      order: slide.order,\n      active: slide.active,\n    });\n    setIsDialogOpen(true);\n  };\n\n  const handleSubmit = () => {\n    if (!formData.imageUrl) {\n      toast({ title: \"Erro\", description: \"URL da imagem é obrigatória\", variant: \"destructive\" });\n      return;\n    }\n    if (editingSlide) {\n      updateMutation.mutate({ id: editingSlide.id, data: formData });\n    } else {\n      createMutation.mutate(formData);\n    }\n  };\n\n  const handleImageUpload = async (e: React.ChangeEvent<HTMLInputElement>, field: 'imageUrl' | 'mobileImageUrl') => {\n    const file = e.target.files?.[0];\n    if (!file) return;\n\n    const formDataUpload = new FormData();\n    formDataUpload.append('file', file);\n\n    try {\n      const res = await fetch('/api/upload/catalog', {\n        method: 'POST',\n        body: formDataUpload,\n        credentials: 'include',\n      });\n      if (res.ok) {\n        const data = await res.json();\n        setFormData(prev => ({ ...prev, [field]: data.url }));\n        toast({ title: \"Sucesso\", description: \"Imagem enviada com sucesso\" });\n      } else {\n        toast({ title: \"Erro\", description: \"Falha ao enviar imagem\", variant: \"destructive\" });\n      }\n    } catch (error) {\n      toast({ title: \"Erro\", description: \"Falha ao enviar imagem\", variant: \"destructive\" });\n    }\n  };\n\n  return (\n    <Card>\n      <CardHeader className=\"flex flex-row items-center justify-between gap-2 space-y-0 pb-4\">\n        <div>\n          <CardTitle className=\"text-lg\">Slides do Carrossel</CardTitle>\n          <CardDescription>\n            Gerencie os slides que aparecem no carrossel principal da página inicial\n          </CardDescription>\n        </div>\n        <Dialog open={isDialogOpen} onOpenChange={(open) => { if (!open) resetForm(); setIsDialogOpen(open); }}>\n          <DialogTrigger asChild>\n            <Button data-testid=\"button-add-slide\">\n              <Plus className=\"h-4 w-4 mr-2\" />\n              Adicionar Slide\n            </Button>\n          </DialogTrigger>\n          <DialogContent className=\"max-w-2xl max-h-[90vh] overflow-y-auto\">\n            <DialogHeader>\n              <DialogTitle>{editingSlide ? \"Editar Slide\" : \"Novo Slide\"}</DialogTitle>\n              <DialogDescription>\n                Configure o conteúdo e aparência do slide\n              </DialogDescription>\n            </DialogHeader>\n            \n            <div className=\"space-y-4 py-4\">\n              <div className=\"grid grid-cols-2 gap-4\">\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"title\">Título</Label>\n                  <Input\n                    id=\"title\"\n                    placeholder=\"Título do slide\"\n                    value={formData.title}\n                    onChange={(e) => setFormData(prev => ({ ...prev, title: e.target.value }))}\n                    data-testid=\"input-slide-title\"\n                  />\n                </div>\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"subtitle\">Subtítulo</Label>\n                  <Input\n                    id=\"subtitle\"\n                    placeholder=\"Subtítulo do slide\"\n                    value={formData.subtitle}\n                    onChange={(e) => setFormData(prev => ({ ...prev, subtitle: e.target.value }))}\n                    data-testid=\"input-slide-subtitle\"\n                  />\n                </div>\n              </div>\n\n              <div className=\"grid grid-cols-2 gap-4\">\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"buttonText\">Texto do Botão</Label>\n                  <Input\n                    id=\"buttonText\"\n                    placeholder=\"Ex: Ver Produtos\"\n                    value={formData.buttonText}\n                    onChange={(e) => setFormData(prev => ({ ...prev, buttonText: e.target.value }))}\n                    data-testid=\"input-slide-button-text\"\n                  />\n                </div>\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"buttonLink\">Link do Botão</Label>\n                  <Input\n                    id=\"buttonLink\"\n                    placeholder=\"Ex: /catalog\"\n                    value={formData.buttonLink}\n                    onChange={(e) => setFormData(prev => ({ ...prev, buttonLink: e.target.value }))}\n                    data-testid=\"input-slide-button-link\"\n                  />\n                </div>\n              </div>\n\n              <div className=\"space-y-2\">\n                <Label>Imagem Desktop (1920x600px recomendado)</Label>\n                <div className=\"flex items-center gap-2\">\n                  <Input\n                    placeholder=\"URL da imagem ou faça upload\"\n                    value={formData.imageUrl}\n                    onChange={(e) => setFormData(prev => ({ ...prev, imageUrl: e.target.value }))}\n                    data-testid=\"input-slide-image\"\n                  />\n                  <Label htmlFor=\"image-upload\" className=\"cursor-pointer\">\n                    <div className=\"flex items-center justify-center h-9 px-3 rounded-md bg-secondary text-secondary-foreground\">\n                      <Upload className=\"h-4 w-4\" />\n                    </div>\n                    <input\n                      id=\"image-upload\"\n                      type=\"file\"\n                      accept=\"image/*\"\n                      className=\"hidden\"\n                      onChange={(e) => handleImageUpload(e, 'imageUrl')}\n                    />\n                  </Label>\n                </div>\n                {formData.imageUrl && (\n                  <div className=\"mt-2 rounded-md overflow-hidden border\">\n                    <img src={formData.imageUrl} alt=\"Preview\" className=\"w-full h-32 object-cover\" />\n                  </div>\n                )}\n              </div>\n\n              <div className=\"space-y-2\">\n                <Label>Imagem Mobile (800x800px recomendado)</Label>\n                <div className=\"flex items-center gap-2\">\n                  <Input\n                    placeholder=\"URL da imagem mobile (opcional)\"\n                    value={formData.mobileImageUrl}\n                    onChange={(e) => setFormData(prev => ({ ...prev, mobileImageUrl: e.target.value }))}\n                    data-testid=\"input-slide-mobile-image\"\n                  />\n                  <Label htmlFor=\"mobile-image-upload\" className=\"cursor-pointer\">\n                    <div className=\"flex items-center justify-center h-9 px-3 rounded-md bg-secondary text-secondary-foreground\">\n                      <Upload className=\"h-4 w-4\" />\n                    </div>\n                    <input\n                      id=\"mobile-image-upload\"\n                      type=\"file\"\n                      accept=\"image/*\"\n                      className=\"hidden\"\n                      onChange={(e) => handleImageUpload(e, 'mobileImageUrl')}\n                    />\n                  </Label>\n                </div>\n              </div>\n\n              <div className=\"grid grid-cols-2 gap-4\">\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"order\">Ordem</Label>\n                  <Input\n                    id=\"order\"\n                    type=\"number\"\n                    value={formData.order}\n                    onChange={(e) => setFormData(prev => ({ ...prev, order: parseInt(e.target.value) || 0 }))}\n                    data-testid=\"input-slide-order\"\n                  />\n                </div>\n                <div className=\"flex items-center gap-2 pt-6\">\n                  <Switch\n                    id=\"active\"\n                    checked={formData.active}\n                    onCheckedChange={(checked) => setFormData(prev => ({ ...prev, active: checked }))}\n                    data-testid=\"switch-slide-active\"\n                  />\n                  <Label htmlFor=\"active\">Ativo</Label>\n                </div>\n              </div>\n            </div>\n\n            <DialogFooter>\n              <Button variant=\"outline\" onClick={resetForm}>\n                Cancelar\n              </Button>\n              <Button onClick={handleSubmit} disabled={createMutation.isPending || updateMutation.isPending} data-testid=\"button-save-slide\">\n                {editingSlide ? \"Salvar Alterações\" : \"Criar Slide\"}\n              </Button>\n            </DialogFooter>\n          </DialogContent>\n        </Dialog>\n      </CardHeader>\n      <CardContent>\n        {isLoading ? (\n          <div className=\"text-center py-8 text-muted-foreground\">Carregando...</div>\n        ) : slides.length === 0 ? (\n          <div className=\"text-center py-8 text-muted-foreground\">\n            <Image className=\"h-12 w-12 mx-auto mb-2 opacity-50\" />\n            <p>Nenhum slide cadastrado</p>\n            <p className=\"text-sm\">Adicione slides para personalizar seu carrossel</p>\n          </div>\n        ) : (\n          <div className=\"space-y-3\">\n            {slides.map((slide) => (\n              <div\n                key={slide.id}\n                className=\"flex items-center gap-4 p-3 rounded-md border bg-card\"\n                data-testid={`slide-item-${slide.id}`}\n              >\n                <GripVertical className=\"h-5 w-5 text-muted-foreground cursor-move\" />\n                <div className=\"w-24 h-16 rounded overflow-hidden bg-muted flex-shrink-0\">\n                  {slide.imageUrl ? (\n                    <img src={slide.imageUrl} alt={slide.title || \"Slide\"} className=\"w-full h-full object-cover\" />\n                  ) : (\n                    <div className=\"w-full h-full flex items-center justify-center\">\n                      <Image className=\"h-6 w-6 text-muted-foreground\" />\n                    </div>\n                  )}\n                </div>\n                <div className=\"flex-1 min-w-0\">\n                  <p className=\"font-medium truncate\">{slide.title || \"Sem título\"}</p>\n                  <p className=\"text-sm text-muted-foreground truncate\">{slide.subtitle || \"Sem subtítulo\"}</p>\n                </div>\n                <Badge variant={slide.active ? \"default\" : \"secondary\"}>\n                  {slide.active ? <Eye className=\"h-3 w-3 mr-1\" /> : <EyeOff className=\"h-3 w-3 mr-1\" />}\n                  {slide.active ? \"Ativo\" : \"Inativo\"}\n                </Badge>\n                <div className=\"flex items-center gap-1\">\n                  <Button variant=\"ghost\" size=\"icon\" onClick={() => handleEdit(slide)} data-testid={`button-edit-slide-${slide.id}`}>\n                    <Edit className=\"h-4 w-4\" />\n                  </Button>\n                  <Button\n                    variant=\"ghost\"\n                    size=\"icon\"\n                    className=\"text-destructive\"\n                    onClick={() => deleteMutation.mutate(slide.id)}\n                    data-testid={`button-delete-slide-${slide.id}`}\n                  >\n                    <Trash2 className=\"h-4 w-4\" />\n                  </Button>\n                </div>\n              </div>\n            ))}\n          </div>\n        )}\n      </CardContent>\n    </Card>\n  );\n}\n\nfunction BannersManager() {\n  const { toast } = useToast();\n  const [isDialogOpen, setIsDialogOpen] = useState(false);\n  const [editingBanner, setEditingBanner] = useState<CatalogBanner | null>(null);\n  const [formData, setFormData] = useState({\n    position: \"promo1\",\n    title: \"\",\n    subtitle: \"\",\n    buttonText: \"\",\n    buttonLink: \"\",\n    imageUrl: \"\",\n    mobileImageUrl: \"\",\n    backgroundColor: \"\",\n    textColor: \"\",\n    order: 0,\n    active: true,\n  });\n\n  const { data: banners = [], isLoading } = useQuery<CatalogBanner[]>({\n    queryKey: ['/api/catalog/banners'],\n  });\n\n  const createMutation = useMutation({\n    mutationFn: async (data: typeof formData) => {\n      return apiRequest('POST', '/api/catalog/banners', data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/catalog/banners'] });\n      toast({ title: \"Sucesso\", description: \"Banner criado com sucesso\" });\n      resetForm();\n    },\n    onError: () => {\n      toast({ title: \"Erro\", description: \"Falha ao criar banner\", variant: \"destructive\" });\n    },\n  });\n\n  const updateMutation = useMutation({\n    mutationFn: async ({ id, data }: { id: number; data: Partial<typeof formData> }) => {\n      return apiRequest('PATCH', `/api/catalog/banners/${id}`, data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/catalog/banners'] });\n      toast({ title: \"Sucesso\", description: \"Banner atualizado com sucesso\" });\n      resetForm();\n    },\n    onError: () => {\n      toast({ title: \"Erro\", description: \"Falha ao atualizar banner\", variant: \"destructive\" });\n    },\n  });\n\n  const deleteMutation = useMutation({\n    mutationFn: async (id: number) => {\n      return apiRequest('DELETE', `/api/catalog/banners/${id}`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/catalog/banners'] });\n      toast({ title: \"Sucesso\", description: \"Banner removido com sucesso\" });\n    },\n    onError: () => {\n      toast({ title: \"Erro\", description: \"Falha ao remover banner\", variant: \"destructive\" });\n    },\n  });\n\n  const resetForm = () => {\n    setFormData({\n      position: \"promo1\",\n      title: \"\",\n      subtitle: \"\",\n      buttonText: \"\",\n      buttonLink: \"\",\n      imageUrl: \"\",\n      mobileImageUrl: \"\",\n      backgroundColor: \"\",\n      textColor: \"\",\n      order: banners.length,\n      active: true,\n    });\n    setEditingBanner(null);\n    setIsDialogOpen(false);\n  };\n\n  const handleEdit = (banner: CatalogBanner) => {\n    setEditingBanner(banner);\n    setFormData({\n      position: banner.position,\n      title: banner.title || \"\",\n      subtitle: banner.subtitle || \"\",\n      buttonText: banner.buttonText || \"\",\n      buttonLink: banner.buttonLink || \"\",\n      imageUrl: banner.imageUrl || \"\",\n      mobileImageUrl: banner.mobileImageUrl || \"\",\n      backgroundColor: banner.backgroundColor || \"\",\n      textColor: banner.textColor || \"\",\n      order: banner.order,\n      active: banner.active,\n    });\n    setIsDialogOpen(true);\n  };\n\n  const handleSubmit = () => {\n    if (editingBanner) {\n      updateMutation.mutate({ id: editingBanner.id, data: formData });\n    } else {\n      createMutation.mutate(formData);\n    }\n  };\n\n  const handleImageUpload = async (e: React.ChangeEvent<HTMLInputElement>, field: 'imageUrl' | 'mobileImageUrl') => {\n    const file = e.target.files?.[0];\n    if (!file) return;\n\n    const formDataUpload = new FormData();\n    formDataUpload.append('file', file);\n\n    try {\n      const res = await fetch('/api/upload/catalog', {\n        method: 'POST',\n        body: formDataUpload,\n        credentials: 'include',\n      });\n      if (res.ok) {\n        const data = await res.json();\n        setFormData(prev => ({ ...prev, [field]: data.url }));\n        toast({ title: \"Sucesso\", description: \"Imagem enviada com sucesso\" });\n      } else {\n        toast({ title: \"Erro\", description: \"Falha ao enviar imagem\", variant: \"destructive\" });\n      }\n    } catch (error) {\n      toast({ title: \"Erro\", description: \"Falha ao enviar imagem\", variant: \"destructive\" });\n    }\n  };\n\n  const positionLabels: Record<string, string> = {\n    hero: \"Hero Principal\",\n    promo1: \"Promoção 1\",\n    promo2: \"Promoção 2\",\n    promo3: \"Promoção 3\",\n    footer: \"Rodapé\",\n    sidebar: \"Barra Lateral\",\n  };\n\n  return (\n    <Card>\n      <CardHeader className=\"flex flex-row items-center justify-between gap-2 space-y-0 pb-4\">\n        <div>\n          <CardTitle className=\"text-lg\">Banners Promocionais</CardTitle>\n          <CardDescription>\n            Gerencie banners para diferentes seções da loja\n          </CardDescription>\n        </div>\n        <Dialog open={isDialogOpen} onOpenChange={(open) => { if (!open) resetForm(); setIsDialogOpen(open); }}>\n          <DialogTrigger asChild>\n            <Button data-testid=\"button-add-banner\">\n              <Plus className=\"h-4 w-4 mr-2\" />\n              Adicionar Banner\n            </Button>\n          </DialogTrigger>\n          <DialogContent className=\"max-w-2xl max-h-[90vh] overflow-y-auto\">\n            <DialogHeader>\n              <DialogTitle>{editingBanner ? \"Editar Banner\" : \"Novo Banner\"}</DialogTitle>\n              <DialogDescription>\n                Configure o conteúdo e posição do banner\n              </DialogDescription>\n            </DialogHeader>\n            \n            <div className=\"space-y-4 py-4\">\n              <div className=\"space-y-2\">\n                <Label>Posição do Banner</Label>\n                <Select\n                  value={formData.position}\n                  onValueChange={(value) => setFormData(prev => ({ ...prev, position: value }))}\n                >\n                  <SelectTrigger data-testid=\"select-banner-position\">\n                    <SelectValue placeholder=\"Selecione a posição\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"hero\">Hero Principal</SelectItem>\n                    <SelectItem value=\"promo1\">Promoção 1</SelectItem>\n                    <SelectItem value=\"promo2\">Promoção 2</SelectItem>\n                    <SelectItem value=\"promo3\">Promoção 3</SelectItem>\n                    <SelectItem value=\"sidebar\">Barra Lateral</SelectItem>\n                    <SelectItem value=\"footer\">Rodapé</SelectItem>\n                  </SelectContent>\n                </Select>\n              </div>\n\n              <div className=\"grid grid-cols-2 gap-4\">\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"banner-title\">Título</Label>\n                  <Input\n                    id=\"banner-title\"\n                    placeholder=\"Título do banner\"\n                    value={formData.title}\n                    onChange={(e) => setFormData(prev => ({ ...prev, title: e.target.value }))}\n                    data-testid=\"input-banner-title\"\n                  />\n                </div>\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"banner-subtitle\">Subtítulo</Label>\n                  <Input\n                    id=\"banner-subtitle\"\n                    placeholder=\"Subtítulo do banner\"\n                    value={formData.subtitle}\n                    onChange={(e) => setFormData(prev => ({ ...prev, subtitle: e.target.value }))}\n                    data-testid=\"input-banner-subtitle\"\n                  />\n                </div>\n              </div>\n\n              <div className=\"grid grid-cols-2 gap-4\">\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"banner-buttonText\">Texto do Botão</Label>\n                  <Input\n                    id=\"banner-buttonText\"\n                    placeholder=\"Ex: Saiba Mais\"\n                    value={formData.buttonText}\n                    onChange={(e) => setFormData(prev => ({ ...prev, buttonText: e.target.value }))}\n                    data-testid=\"input-banner-button-text\"\n                  />\n                </div>\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"banner-buttonLink\">Link do Botão</Label>\n                  <Input\n                    id=\"banner-buttonLink\"\n                    placeholder=\"Ex: /promocao\"\n                    value={formData.buttonLink}\n                    onChange={(e) => setFormData(prev => ({ ...prev, buttonLink: e.target.value }))}\n                    data-testid=\"input-banner-button-link\"\n                  />\n                </div>\n              </div>\n\n              <div className=\"space-y-2\">\n                <Label>Imagem do Banner</Label>\n                <div className=\"flex items-center gap-2\">\n                  <Input\n                    placeholder=\"URL da imagem ou faça upload\"\n                    value={formData.imageUrl}\n                    onChange={(e) => setFormData(prev => ({ ...prev, imageUrl: e.target.value }))}\n                    data-testid=\"input-banner-image\"\n                  />\n                  <Label htmlFor=\"banner-image-upload\" className=\"cursor-pointer\">\n                    <div className=\"flex items-center justify-center h-9 px-3 rounded-md bg-secondary text-secondary-foreground\">\n                      <Upload className=\"h-4 w-4\" />\n                    </div>\n                    <input\n                      id=\"banner-image-upload\"\n                      type=\"file\"\n                      accept=\"image/*\"\n                      className=\"hidden\"\n                      onChange={(e) => handleImageUpload(e, 'imageUrl')}\n                    />\n                  </Label>\n                </div>\n                {formData.imageUrl && (\n                  <div className=\"mt-2 rounded-md overflow-hidden border\">\n                    <img src={formData.imageUrl} alt=\"Preview\" className=\"w-full h-32 object-cover\" />\n                  </div>\n                )}\n              </div>\n\n              <div className=\"grid grid-cols-2 gap-4\">\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"backgroundColor\">Cor de Fundo</Label>\n                  <div className=\"flex items-center gap-2\">\n                    <Input\n                      id=\"backgroundColor\"\n                      placeholder=\"#000000\"\n                      value={formData.backgroundColor}\n                      onChange={(e) => setFormData(prev => ({ ...prev, backgroundColor: e.target.value }))}\n                      data-testid=\"input-banner-bg-color\"\n                    />\n                    <input\n                      type=\"color\"\n                      value={formData.backgroundColor || \"#000000\"}\n                      onChange={(e) => setFormData(prev => ({ ...prev, backgroundColor: e.target.value }))}\n                      className=\"h-9 w-9 rounded border cursor-pointer\"\n                    />\n                  </div>\n                </div>\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"textColor\">Cor do Texto</Label>\n                  <div className=\"flex items-center gap-2\">\n                    <Input\n                      id=\"textColor\"\n                      placeholder=\"#FFFFFF\"\n                      value={formData.textColor}\n                      onChange={(e) => setFormData(prev => ({ ...prev, textColor: e.target.value }))}\n                      data-testid=\"input-banner-text-color\"\n                    />\n                    <input\n                      type=\"color\"\n                      value={formData.textColor || \"#FFFFFF\"}\n                      onChange={(e) => setFormData(prev => ({ ...prev, textColor: e.target.value }))}\n                      className=\"h-9 w-9 rounded border cursor-pointer\"\n                    />\n                  </div>\n                </div>\n              </div>\n\n              <div className=\"grid grid-cols-2 gap-4\">\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"banner-order\">Ordem</Label>\n                  <Input\n                    id=\"banner-order\"\n                    type=\"number\"\n                    value={formData.order}\n                    onChange={(e) => setFormData(prev => ({ ...prev, order: parseInt(e.target.value) || 0 }))}\n                    data-testid=\"input-banner-order\"\n                  />\n                </div>\n                <div className=\"flex items-center gap-2 pt-6\">\n                  <Switch\n                    id=\"banner-active\"\n                    checked={formData.active}\n                    onCheckedChange={(checked) => setFormData(prev => ({ ...prev, active: checked }))}\n                    data-testid=\"switch-banner-active\"\n                  />\n                  <Label htmlFor=\"banner-active\">Ativo</Label>\n                </div>\n              </div>\n            </div>\n\n            <DialogFooter>\n              <Button variant=\"outline\" onClick={resetForm}>\n                Cancelar\n              </Button>\n              <Button onClick={handleSubmit} disabled={createMutation.isPending || updateMutation.isPending} data-testid=\"button-save-banner\">\n                {editingBanner ? \"Salvar Alterações\" : \"Criar Banner\"}\n              </Button>\n            </DialogFooter>\n          </DialogContent>\n        </Dialog>\n      </CardHeader>\n      <CardContent>\n        {isLoading ? (\n          <div className=\"text-center py-8 text-muted-foreground\">Carregando...</div>\n        ) : banners.length === 0 ? (\n          <div className=\"text-center py-8 text-muted-foreground\">\n            <Image className=\"h-12 w-12 mx-auto mb-2 opacity-50\" />\n            <p>Nenhum banner cadastrado</p>\n            <p className=\"text-sm\">Adicione banners para diferentes seções da loja</p>\n          </div>\n        ) : (\n          <div className=\"space-y-3\">\n            {banners.map((banner) => (\n              <div\n                key={banner.id}\n                className=\"flex items-center gap-4 p-3 rounded-md border bg-card\"\n                data-testid={`banner-item-${banner.id}`}\n              >\n                <GripVertical className=\"h-5 w-5 text-muted-foreground cursor-move\" />\n                <div className=\"w-24 h-16 rounded overflow-hidden bg-muted flex-shrink-0\">\n                  {banner.imageUrl ? (\n                    <img src={banner.imageUrl} alt={banner.title || \"Banner\"} className=\"w-full h-full object-cover\" />\n                  ) : (\n                    <div \n                      className=\"w-full h-full flex items-center justify-center\"\n                      style={{ backgroundColor: banner.backgroundColor || undefined }}\n                    >\n                      <Image className=\"h-6 w-6 text-muted-foreground\" />\n                    </div>\n                  )}\n                </div>\n                <div className=\"flex-1 min-w-0\">\n                  <p className=\"font-medium truncate\">{banner.title || \"Sem título\"}</p>\n                  <p className=\"text-sm text-muted-foreground\">{positionLabels[banner.position] || banner.position}</p>\n                </div>\n                <Badge variant={banner.active ? \"default\" : \"secondary\"}>\n                  {banner.active ? <Eye className=\"h-3 w-3 mr-1\" /> : <EyeOff className=\"h-3 w-3 mr-1\" />}\n                  {banner.active ? \"Ativo\" : \"Inativo\"}\n                </Badge>\n                <div className=\"flex items-center gap-1\">\n                  <Button variant=\"ghost\" size=\"icon\" onClick={() => handleEdit(banner)} data-testid={`button-edit-banner-${banner.id}`}>\n                    <Edit className=\"h-4 w-4\" />\n                  </Button>\n                  <Button\n                    variant=\"ghost\"\n                    size=\"icon\"\n                    className=\"text-destructive\"\n                    onClick={() => deleteMutation.mutate(banner.id)}\n                    data-testid={`button-delete-banner-${banner.id}`}\n                  >\n                    <Trash2 className=\"h-4 w-4\" />\n                  </Button>\n                </div>\n              </div>\n            ))}\n          </div>\n        )}\n      </CardContent>\n    </Card>\n  );\n}\n\nfunction CatalogSettings() {\n  const { toast } = useToast();\n\n  const { data: showCategories } = useQuery<{ key: string; value: string | null }>({\n    queryKey: ['/api/catalog/config/show_categories_section'],\n  });\n\n  const { data: showBenefits } = useQuery<{ key: string; value: string | null }>({\n    queryKey: ['/api/catalog/config/show_benefits_section'],\n  });\n\n  const { data: showFeatured } = useQuery<{ key: string; value: string | null }>({\n    queryKey: ['/api/catalog/config/show_featured_section'],\n  });\n\n  const updateConfig = useMutation({\n    mutationFn: async ({ key, value }: { key: string; value: string }) => {\n      return apiRequest('POST', `/api/catalog/config/${key}`, { value });\n    },\n    onSuccess: (_, variables) => {\n      queryClient.invalidateQueries({ queryKey: ['/api/catalog/config', variables.key] });\n      toast({ title: \"Sucesso\", description: \"Configuração atualizada\" });\n    },\n    onError: () => {\n      toast({ title: \"Erro\", description: \"Falha ao atualizar configuração\", variant: \"destructive\" });\n    },\n  });\n\n  return (\n    <Card>\n      <CardHeader>\n        <CardTitle className=\"text-lg\">Configurações da Página</CardTitle>\n        <CardDescription>\n          Configure quais seções aparecem na página inicial\n        </CardDescription>\n      </CardHeader>\n      <CardContent className=\"space-y-4\">\n        <div className=\"flex items-center justify-between p-3 rounded-md border\">\n          <div>\n            <p className=\"font-medium\">Seção de Categorias</p>\n            <p className=\"text-sm text-muted-foreground\">Exibir categorias de produtos na página inicial</p>\n          </div>\n          <Switch\n            checked={showCategories?.value === 'true'}\n            onCheckedChange={(checked) => updateConfig.mutate({ key: 'show_categories_section', value: checked ? 'true' : 'false' })}\n            data-testid=\"switch-show-categories\"\n          />\n        </div>\n\n        <div className=\"flex items-center justify-between p-3 rounded-md border\">\n          <div>\n            <p className=\"font-medium\">Seção de Benefícios</p>\n            <p className=\"text-sm text-muted-foreground\">Exibir benefícios (frete grátis, parcelamento, etc)</p>\n          </div>\n          <Switch\n            checked={showBenefits?.value !== 'false'}\n            onCheckedChange={(checked) => updateConfig.mutate({ key: 'show_benefits_section', value: checked ? 'true' : 'false' })}\n            data-testid=\"switch-show-benefits\"\n          />\n        </div>\n\n        <div className=\"flex items-center justify-between p-3 rounded-md border\">\n          <div>\n            <p className=\"font-medium\">Produtos em Destaque</p>\n            <p className=\"text-sm text-muted-foreground\">Exibir seção de produtos em destaque</p>\n          </div>\n          <Switch\n            checked={showFeatured?.value !== 'false'}\n            onCheckedChange={(checked) => updateConfig.mutate({ key: 'show_featured_section', value: checked ? 'true' : 'false' })}\n            data-testid=\"switch-show-featured\"\n          />\n        </div>\n      </CardContent>\n    </Card>\n  );\n}\n","path":null,"size_bytes":35537,"size_tokens":null},"client/src/components/AgeVerificationPopup.tsx":{"content":"import { Button } from \"@/components/ui/button\";\nimport { useEffect, useState } from \"react\";\n\ninterface AgeVerificationPopupProps {\n  enabled: boolean;\n}\n\nexport function AgeVerificationPopup({ enabled }: AgeVerificationPopupProps) {\n  const [isVisible, setIsVisible] = useState(false);\n\n  useEffect(() => {\n    if (!enabled) {\n      setIsVisible(false);\n      return;\n    }\n\n    const verified = localStorage.getItem(\"age_verified\");\n    if (!verified) {\n      setIsVisible(true);\n    }\n  }, [enabled]);\n\n  const handleConfirm = () => {\n    localStorage.setItem(\"age_verified\", \"true\");\n    setIsVisible(false);\n  };\n\n  const handleReject = () => {\n    window.location.href = \"https://www.google.com\";\n  };\n\n  if (!isVisible) return null;\n\n  return (\n    <div \n      className=\"fixed inset-0 z-[9999] flex items-center justify-center bg-black/80\"\n      data-testid=\"modal-age-verification\"\n    >\n      <div className=\"bg-neutral-900 border border-neutral-700 rounded-lg p-6 mx-4 max-w-sm w-full text-center\">\n        <h2 \n          className=\"text-white text-xl font-bold mb-2\"\n          data-testid=\"text-age-title\"\n        >\n          VOCÊ TEM MAIS DE 18 ANOS?\n        </h2>\n        <p className=\"text-neutral-400 text-sm mb-6\">\n          Ao clicar em SIM, você concorda que é maior de 18 anos\n        </p>\n        \n        <div className=\"flex gap-3\">\n          <Button \n            onClick={handleConfirm}\n            className=\"flex-1 bg-primary hover:bg-primary/90 text-primary-foreground font-semibold\"\n            data-testid=\"button-age-confirm\"\n          >\n            SIM\n          </Button>\n          <Button \n            onClick={handleReject}\n            variant=\"outline\"\n            className=\"flex-1 border-neutral-600 text-neutral-300 hover:bg-neutral-800 font-semibold\"\n            data-testid=\"button-age-reject\"\n          >\n            NÃO\n          </Button>\n        </div>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":1933,"size_tokens":null},"client/src/pages/appearance.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Switch } from \"@/components/ui/switch\";\nimport { Separator } from \"@/components/ui/separator\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger, DialogFooter } from \"@/components/ui/dialog\";\nimport { Slider } from \"@/components/ui/slider\";\nimport { useTheme } from \"@/contexts/ThemeContext\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { \n  Palette, Image, Layout, Store, Layers, Check, Plus, Trash2, Edit, GripVertical, \n  Building2, Sparkles, Moon, Sun, Monitor, Type, Circle, Square, \n  Sidebar, PaintBucket, Wand2\n} from \"lucide-react\";\nimport type { CatalogSlide } from \"@shared/schema\";\n\nconst colorThemes = [\n  { id: \"orange\", name: \"Laranja\", primary: \"25 95% 53%\", description: \"Vibrante e energico\" },\n  { id: \"blue\", name: \"Azul\", primary: \"217 91% 60%\", description: \"Corporativo e confiavel\" },\n  { id: \"green\", name: \"Verde\", primary: \"142 71% 45%\", description: \"Natural e fresco\" },\n  { id: \"purple\", name: \"Roxo\", primary: \"262 83% 58%\", description: \"Elegante e moderno\" },\n  { id: \"red\", name: \"Vermelho\", primary: \"0 84% 60%\", description: \"Intenso e marcante\" },\n  { id: \"teal\", name: \"Verde Agua\", primary: \"173 80% 40%\", description: \"Calmo e sofisticado\" },\n  { id: \"pink\", name: \"Rosa\", primary: \"330 80% 60%\", description: \"Moderno e jovem\" },\n  { id: \"amber\", name: \"Dourado\", primary: \"45 93% 47%\", description: \"Premium e luxuoso\" },\n  { id: \"slate\", name: \"Grafite\", primary: \"215 25% 35%\", description: \"Discreto e profissional\" },\n  { id: \"cyan\", name: \"Ciano\", primary: \"190 95% 39%\", description: \"Tech e inovador\" },\n  { id: \"rose\", name: \"Rose\", primary: \"350 89% 60%\", description: \"Suave e acolhedor\" },\n  { id: \"indigo\", name: \"Indigo\", primary: \"239 84% 67%\", description: \"Misterioso e criativo\" },\n];\n\nconst completeThemes = [\n  {\n    id: \"professional\",\n    name: \"Profissional\",\n    description: \"Clean e corporativo\",\n    preview: { primary: \"217 91% 60%\", sidebar: \"220 14% 98%\", accent: \"220 14% 92%\" },\n    colors: {\n      primary: \"217 91% 60%\",\n      background: \"220 14% 96%\",\n      sidebar: \"220 14% 98%\",\n      card: \"0 0% 100%\",\n    }\n  },\n  {\n    id: \"dark-elegance\",\n    name: \"Elegancia Escura\",\n    description: \"Sofisticado e moderno\",\n    preview: { primary: \"262 83% 58%\", sidebar: \"222 47% 11%\", accent: \"262 83% 58%\" },\n    colors: {\n      primary: \"262 83% 58%\",\n      background: \"222 47% 11%\",\n      sidebar: \"222 47% 11%\",\n      card: \"222 47% 13%\",\n    }\n  },\n  {\n    id: \"nature\",\n    name: \"Natureza\",\n    description: \"Fresco e organico\",\n    preview: { primary: \"142 71% 45%\", sidebar: \"140 30% 96%\", accent: \"142 50% 90%\" },\n    colors: {\n      primary: \"142 71% 45%\",\n      background: \"140 20% 97%\",\n      sidebar: \"140 30% 96%\",\n      card: \"0 0% 100%\",\n    }\n  },\n  {\n    id: \"sunset\",\n    name: \"Por do Sol\",\n    description: \"Quente e acolhedor\",\n    preview: { primary: \"25 95% 53%\", sidebar: \"30 20% 97%\", accent: \"25 80% 90%\" },\n    colors: {\n      primary: \"25 95% 53%\",\n      background: \"30 15% 96%\",\n      sidebar: \"30 20% 97%\",\n      card: \"0 0% 100%\",\n    }\n  },\n  {\n    id: \"ocean\",\n    name: \"Oceano\",\n    description: \"Calmo e sereno\",\n    preview: { primary: \"190 95% 39%\", sidebar: \"195 30% 97%\", accent: \"190 50% 90%\" },\n    colors: {\n      primary: \"190 95% 39%\",\n      background: \"195 20% 96%\",\n      sidebar: \"195 30% 97%\",\n      card: \"0 0% 100%\",\n    }\n  },\n  {\n    id: \"midnight\",\n    name: \"Meia Noite\",\n    description: \"Escuro e misterioso\",\n    preview: { primary: \"217 91% 60%\", sidebar: \"222 47% 8%\", accent: \"217 50% 20%\" },\n    colors: {\n      primary: \"217 91% 60%\",\n      background: \"222 47% 6%\",\n      sidebar: \"222 47% 8%\",\n      card: \"222 47% 10%\",\n    }\n  },\n];\n\nconst designTemplates = [\n  { id: \"modern\", name: \"Moderno\", description: \"Design limpo com bordas arredondadas\", icon: Circle },\n  { id: \"classic\", name: \"Classico\", description: \"Estilo tradicional e profissional\", icon: Square },\n  { id: \"minimal\", name: \"Minimalista\", description: \"Foco no conteudo, sem distrações\", icon: Layout },\n  { id: \"bold\", name: \"Impactante\", description: \"Cores fortes e elementos grandes\", icon: Sparkles },\n];\n\nconst productsPerRowOptions = [\n  { value: \"2\", label: \"2 produtos\" },\n  { value: \"3\", label: \"3 produtos\" },\n  { value: \"4\", label: \"4 produtos\" },\n  { value: \"5\", label: \"5 produtos\" },\n  { value: \"6\", label: \"6 produtos\" },\n];\n\nconst categoryPositionOptions = [\n  { value: \"top\", label: \"Topo (Horizontal)\" },\n  { value: \"left\", label: \"Lateral Esquerda\" },\n  { value: \"hidden\", label: \"Oculto\" },\n];\n\nconst fontOptions = [\n  { value: \"inter\", label: \"Inter\", style: \"font-sans\" },\n  { value: \"roboto\", label: \"Roboto\", style: \"font-sans\" },\n  { value: \"poppins\", label: \"Poppins\", style: \"font-sans\" },\n  { value: \"nunito\", label: \"Nunito\", style: \"font-sans\" },\n  { value: \"montserrat\", label: \"Montserrat\", style: \"font-sans\" },\n];\n\nconst borderRadiusOptions = [\n  { value: \"none\", label: \"Sem bordas\", radius: \"0\" },\n  { value: \"sm\", label: \"Pequeno\", radius: \"0.25rem\" },\n  { value: \"md\", label: \"Medio\", radius: \"0.5rem\" },\n  { value: \"lg\", label: \"Grande\", radius: \"0.75rem\" },\n  { value: \"xl\", label: \"Extra Grande\", radius: \"1rem\" },\n  { value: \"full\", label: \"Arredondado\", radius: \"9999px\" },\n];\n\nexport default function AppearancePage() {\n  const { theme, setTheme } = useTheme();\n  const { toast } = useToast();\n  const [selectedColor, setSelectedColor] = useState(\"orange\");\n  const [selectedCompleteTheme, setSelectedCompleteTheme] = useState(\"\");\n  const [selectedTemplate, setSelectedTemplate] = useState(\"modern\");\n  const [productsPerRow, setProductsPerRow] = useState(\"4\");\n  const [categoryPosition, setCategoryPosition] = useState(\"top\");\n  const [isSlideDialogOpen, setIsSlideDialogOpen] = useState(false);\n  const [editingSlide, setEditingSlide] = useState<CatalogSlide | null>(null);\n  const [slideForm, setSlideForm] = useState({ title: \"\", imageUrl: \"\", buttonLink: \"\", active: true, order: 0 });\n\n  const [storeName, setStoreName] = useState(\"\");\n  const [storeCnpj, setStoreCnpj] = useState(\"\");\n  const [storePhone, setStorePhone] = useState(\"\");\n  const [storeEmail, setStoreEmail] = useState(\"\");\n  const [storeAddress, setStoreAddress] = useState(\"\");\n  const [storeLogo, setStoreLogo] = useState(\"\");\n  \n  const [selectedFont, setSelectedFont] = useState(\"inter\");\n  const [selectedRadius, setSelectedRadius] = useState(\"md\");\n  const [sidebarStyle, setSidebarStyle] = useState(\"default\");\n  const [animationsEnabled, setAnimationsEnabled] = useState(true);\n\n  const { data: slides = [], isLoading: slidesLoading } = useQuery<CatalogSlide[]>({\n    queryKey: ['/api/catalog/slides'],\n  });\n\n  const { data: wholesaleSetting } = useQuery<{ key: string; value: string | null }>({\n    queryKey: ['/api/settings/wholesale_mode'],\n  });\n\n  const { data: deliveryModeSetting } = useQuery<{ key: string; value: string | null }>({\n    queryKey: ['/api/settings/delivery_catalog_mode'],\n  });\n\n  const { data: storeNameSetting } = useQuery<{ key: string; value: string | null }>({\n    queryKey: ['/api/settings/store_name'],\n  });\n\n  const { data: storeCnpjSetting } = useQuery<{ key: string; value: string | null }>({\n    queryKey: ['/api/settings/store_cnpj'],\n  });\n\n  const { data: storePhoneSetting } = useQuery<{ key: string; value: string | null }>({\n    queryKey: ['/api/settings/store_phone'],\n  });\n\n  const { data: storeEmailSetting } = useQuery<{ key: string; value: string | null }>({\n    queryKey: ['/api/settings/store_email'],\n  });\n\n  const { data: storeAddressSetting } = useQuery<{ key: string; value: string | null }>({\n    queryKey: ['/api/settings/store_address'],\n  });\n\n  const { data: storeLogoSetting } = useQuery<{ key: string; value: string | null }>({\n    queryKey: ['/api/settings/store_logo'],\n  });\n\n  const { data: colorSetting } = useQuery<{ key: string; value: string | null }>({\n    queryKey: ['/api/settings/primary_color'],\n  });\n\n  const { data: templateSetting } = useQuery<{ key: string; value: string | null }>({\n    queryKey: ['/api/settings/design_template'],\n  });\n\n  const { data: productsPerRowSetting } = useQuery<{ key: string; value: string | null }>({\n    queryKey: ['/api/settings/products_per_row'],\n  });\n\n  const { data: categoryPositionSetting } = useQuery<{ key: string; value: string | null }>({\n    queryKey: ['/api/settings/category_position'],\n  });\n  \n  const { data: fontSetting } = useQuery<{ key: string; value: string | null }>({\n    queryKey: ['/api/settings/font_family'],\n  });\n  \n  const { data: radiusSetting } = useQuery<{ key: string; value: string | null }>({\n    queryKey: ['/api/settings/border_radius'],\n  });\n  \n  const { data: sidebarStyleSetting } = useQuery<{ key: string; value: string | null }>({\n    queryKey: ['/api/settings/sidebar_style'],\n  });\n  \n  const { data: completeThemeSetting } = useQuery<{ key: string; value: string | null }>({\n    queryKey: ['/api/settings/complete_theme'],\n  });\n\n  useEffect(() => {\n    if (colorSetting?.value) setSelectedColor(colorSetting.value);\n    if (templateSetting?.value) setSelectedTemplate(templateSetting.value);\n    if (productsPerRowSetting?.value) setProductsPerRow(productsPerRowSetting.value);\n    if (categoryPositionSetting?.value) setCategoryPosition(categoryPositionSetting.value);\n    if (storeNameSetting?.value) setStoreName(storeNameSetting.value);\n    if (storeCnpjSetting?.value) setStoreCnpj(storeCnpjSetting.value);\n    if (storePhoneSetting?.value) setStorePhone(storePhoneSetting.value);\n    if (storeEmailSetting?.value) setStoreEmail(storeEmailSetting.value);\n    if (storeAddressSetting?.value) setStoreAddress(storeAddressSetting.value);\n    if (storeLogoSetting?.value) setStoreLogo(storeLogoSetting.value);\n    if (fontSetting?.value) setSelectedFont(fontSetting.value);\n    if (radiusSetting?.value) setSelectedRadius(radiusSetting.value);\n    if (sidebarStyleSetting?.value) setSidebarStyle(sidebarStyleSetting.value);\n    if (completeThemeSetting?.value) setSelectedCompleteTheme(completeThemeSetting.value);\n  }, [colorSetting, templateSetting, productsPerRowSetting, categoryPositionSetting, storeNameSetting, storeCnpjSetting, storePhoneSetting, storeEmailSetting, storeAddressSetting, storeLogoSetting, fontSetting, radiusSetting, sidebarStyleSetting, completeThemeSetting]);\n\n  useEffect(() => {\n    if (completeThemeSetting?.value) {\n      const themeConfig = completeThemes.find(t => t.id === completeThemeSetting.value);\n      if (themeConfig) {\n        document.documentElement.style.setProperty(\"--primary\", themeConfig.colors.primary);\n        document.documentElement.style.setProperty(\"--sidebar\", themeConfig.colors.sidebar);\n        document.documentElement.style.setProperty(\"--background\", themeConfig.colors.background);\n        document.documentElement.style.setProperty(\"--card\", themeConfig.colors.card);\n      }\n    } else if (colorSetting?.value) {\n      const colorConfig = colorThemes.find(t => t.id === colorSetting.value);\n      if (colorConfig) {\n        document.documentElement.style.setProperty(\"--primary\", colorConfig.primary);\n      }\n    }\n    if (radiusSetting?.value) {\n      const radiusConfig = borderRadiusOptions.find(r => r.value === radiusSetting.value);\n      if (radiusConfig) {\n        document.documentElement.style.setProperty(\"--radius\", radiusConfig.radius);\n      }\n    }\n  }, [completeThemeSetting, colorSetting, radiusSetting]);\n\n  const saveSetting = useMutation({\n    mutationFn: async ({ key, value }: { key: string; value: string }) => {\n      return apiRequest('POST', `/api/settings/${key}`, { value });\n    },\n    onSuccess: (_, variables) => {\n      queryClient.invalidateQueries({ queryKey: [`/api/settings/${variables.key}`] });\n      toast({ title: \"Salvo\", description: \"Configuracao atualizada com sucesso.\" });\n    },\n    onError: () => {\n      toast({ title: \"Erro\", description: \"Nao foi possivel salvar.\", variant: \"destructive\" });\n    },\n  });\n\n  const createSlide = useMutation({\n    mutationFn: async (data: { title: string; imageUrl: string; buttonLink: string; active: boolean; order: number }) => {\n      return apiRequest('POST', '/api/catalog/slides', data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/catalog/slides'] });\n      setIsSlideDialogOpen(false);\n      setSlideForm({ title: \"\", imageUrl: \"\", buttonLink: \"\", active: true, order: 0 });\n      toast({ title: \"Banner criado\", description: \"O banner foi adicionado ao carrossel.\" });\n    },\n  });\n\n  const updateSlide = useMutation({\n    mutationFn: async ({ id, data }: { id: number; data: Partial<CatalogSlide> }) => {\n      return apiRequest('PATCH', `/api/catalog/slides/${id}`, data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/catalog/slides'] });\n      setIsSlideDialogOpen(false);\n      setEditingSlide(null);\n      setSlideForm({ title: \"\", imageUrl: \"\", buttonLink: \"\", active: true, order: 0 });\n      toast({ title: \"Banner atualizado\" });\n    },\n  });\n\n  const deleteSlide = useMutation({\n    mutationFn: async (id: number) => {\n      return apiRequest('DELETE', `/api/catalog/slides/${id}`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/catalog/slides'] });\n      toast({ title: \"Banner removido\" });\n    },\n  });\n\n  const isWholesaleEnabled = wholesaleSetting?.value === 'true';\n  const isDeliveryModeEnabled = deliveryModeSetting?.value === 'true';\n\n  const handleColorChange = (colorId: string) => {\n    setSelectedColor(colorId);\n    setSelectedCompleteTheme(\"\");\n    const themeConfig = colorThemes.find(t => t.id === colorId);\n    if (themeConfig) {\n      document.documentElement.style.setProperty(\"--primary\", themeConfig.primary);\n      localStorage.setItem(\"sidebarTheme\", colorId);\n    }\n    saveSetting.mutate({ key: 'primary_color', value: colorId });\n    saveSetting.mutate({ key: 'complete_theme', value: '' });\n  };\n\n  const handleCompleteThemeChange = (themeId: string) => {\n    setSelectedCompleteTheme(themeId);\n    const themeConfig = completeThemes.find(t => t.id === themeId);\n    if (themeConfig) {\n      document.documentElement.style.setProperty(\"--primary\", themeConfig.colors.primary);\n      document.documentElement.style.setProperty(\"--sidebar\", themeConfig.colors.sidebar);\n      document.documentElement.style.setProperty(\"--background\", themeConfig.colors.background);\n      document.documentElement.style.setProperty(\"--card\", themeConfig.colors.card);\n    }\n    saveSetting.mutate({ key: 'complete_theme', value: themeId });\n  };\n\n  const handleTemplateChange = (templateId: string) => {\n    setSelectedTemplate(templateId);\n    saveSetting.mutate({ key: 'design_template', value: templateId });\n  };\n  \n  const handleFontChange = (fontId: string) => {\n    setSelectedFont(fontId);\n    saveSetting.mutate({ key: 'font_family', value: fontId });\n  };\n  \n  const handleRadiusChange = (radiusId: string) => {\n    setSelectedRadius(radiusId);\n    const radiusConfig = borderRadiusOptions.find(r => r.value === radiusId);\n    if (radiusConfig) {\n      document.documentElement.style.setProperty(\"--radius\", radiusConfig.radius);\n    }\n    saveSetting.mutate({ key: 'border_radius', value: radiusId });\n  };\n  \n  const handleSidebarStyleChange = (style: string) => {\n    setSidebarStyle(style);\n    saveSetting.mutate({ key: 'sidebar_style', value: style });\n  };\n\n  const handleOpenSlideDialog = (slide?: CatalogSlide) => {\n    if (slide) {\n      setEditingSlide(slide);\n      setSlideForm({\n        title: slide.title || \"\",\n        imageUrl: slide.imageUrl,\n        buttonLink: slide.buttonLink || \"\",\n        active: slide.active,\n        order: slide.order,\n      });\n    } else {\n      setEditingSlide(null);\n      setSlideForm({ title: \"\", imageUrl: \"\", buttonLink: \"\", active: true, order: 0 });\n    }\n    setIsSlideDialogOpen(true);\n  };\n\n  const handleSaveSlide = () => {\n    if (!slideForm.imageUrl) {\n      toast({ title: \"Erro\", description: \"Informe a URL da imagem.\", variant: \"destructive\" });\n      return;\n    }\n    if (editingSlide) {\n      updateSlide.mutate({ id: editingSlide.id, data: slideForm });\n    } else {\n      createSlide.mutate(slideForm);\n    }\n  };\n\n  const handleSaveStoreInfo = () => {\n    saveSetting.mutate({ key: 'store_name', value: storeName });\n    saveSetting.mutate({ key: 'store_cnpj', value: storeCnpj });\n    saveSetting.mutate({ key: 'store_phone', value: storePhone });\n    saveSetting.mutate({ key: 'store_email', value: storeEmail });\n    saveSetting.mutate({ key: 'store_address', value: storeAddress });\n    if (storeLogo) {\n      saveSetting.mutate({ key: 'store_logo', value: storeLogo });\n    }\n  };\n\n  return (\n    <div className=\"p-6 lg:p-8 space-y-6 max-w-6xl\">\n      <div>\n        <h1 className=\"text-3xl font-bold flex items-center gap-3\">\n          <Wand2 className=\"h-8 w-8 text-primary\" />\n          Personalizacao\n        </h1>\n        <p className=\"text-muted-foreground mt-1\">Personalize completamente a aparencia do seu sistema</p>\n      </div>\n\n      <Tabs defaultValue=\"themes\" className=\"space-y-6\">\n        <TabsList className=\"grid grid-cols-6 w-full max-w-3xl h-auto p-1\">\n          <TabsTrigger value=\"themes\" className=\"flex flex-col items-center gap-1 py-2\" data-testid=\"tab-themes\">\n            <Sparkles className=\"w-4 h-4\" />\n            <span className=\"text-xs\">Temas</span>\n          </TabsTrigger>\n          <TabsTrigger value=\"colors\" className=\"flex flex-col items-center gap-1 py-2\" data-testid=\"tab-colors\">\n            <Palette className=\"w-4 h-4\" />\n            <span className=\"text-xs\">Cores</span>\n          </TabsTrigger>\n          <TabsTrigger value=\"branding\" className=\"flex flex-col items-center gap-1 py-2\" data-testid=\"tab-branding\">\n            <Store className=\"w-4 h-4\" />\n            <span className=\"text-xs\">Loja</span>\n          </TabsTrigger>\n          <TabsTrigger value=\"banners\" className=\"flex flex-col items-center gap-1 py-2\" data-testid=\"tab-banners\">\n            <Image className=\"w-4 h-4\" />\n            <span className=\"text-xs\">Banners</span>\n          </TabsTrigger>\n          <TabsTrigger value=\"layout\" className=\"flex flex-col items-center gap-1 py-2\" data-testid=\"tab-layout\">\n            <Layout className=\"w-4 h-4\" />\n            <span className=\"text-xs\">Layout</span>\n          </TabsTrigger>\n          <TabsTrigger value=\"advanced\" className=\"flex flex-col items-center gap-1 py-2\" data-testid=\"tab-advanced\">\n            <Layers className=\"w-4 h-4\" />\n            <span className=\"text-xs\">Avancado</span>\n          </TabsTrigger>\n        </TabsList>\n\n        <TabsContent value=\"themes\" className=\"space-y-6\">\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"flex items-center gap-2\">\n                <Sparkles className=\"h-5 w-5 text-primary\" />\n                Temas Prontos\n              </CardTitle>\n              <CardDescription>Escolha um tema completo para aplicar instantaneamente</CardDescription>\n            </CardHeader>\n            <CardContent>\n              <div className=\"grid sm:grid-cols-2 lg:grid-cols-3 gap-4\">\n                {completeThemes.map((themeOption) => (\n                  <button\n                    key={themeOption.id}\n                    onClick={() => handleCompleteThemeChange(themeOption.id)}\n                    className={`relative text-left p-4 rounded-xl border-2 transition-all hover-elevate ${\n                      selectedCompleteTheme === themeOption.id\n                        ? \"border-primary ring-2 ring-primary/20\"\n                        : \"border-border\"\n                    }`}\n                    data-testid={`button-theme-${themeOption.id}`}\n                  >\n                    <div className=\"flex gap-1.5 mb-3\">\n                      <div \n                        className=\"w-8 h-8 rounded-lg shadow-sm\"\n                        style={{ backgroundColor: `hsl(${themeOption.preview.primary})` }}\n                      />\n                      <div \n                        className=\"w-8 h-8 rounded-lg shadow-sm border\"\n                        style={{ backgroundColor: `hsl(${themeOption.preview.sidebar})` }}\n                      />\n                      <div \n                        className=\"w-8 h-8 rounded-lg shadow-sm\"\n                        style={{ backgroundColor: `hsl(${themeOption.preview.accent})` }}\n                      />\n                    </div>\n                    <p className=\"font-semibold\">{themeOption.name}</p>\n                    <p className=\"text-sm text-muted-foreground mt-0.5\">{themeOption.description}</p>\n                    {selectedCompleteTheme === themeOption.id && (\n                      <div className=\"absolute top-2 right-2 w-6 h-6 bg-primary rounded-full flex items-center justify-center\">\n                        <Check className=\"w-4 h-4 text-primary-foreground\" />\n                      </div>\n                    )}\n                  </button>\n                ))}\n              </div>\n            </CardContent>\n          </Card>\n\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"flex items-center gap-2\">\n                <PaintBucket className=\"h-5 w-5\" />\n                Modo de Aparencia\n              </CardTitle>\n              <CardDescription>Escolha entre modo claro ou escuro</CardDescription>\n            </CardHeader>\n            <CardContent>\n              <div className=\"grid grid-cols-2 gap-4 max-w-md\">\n                <button\n                  onClick={() => setTheme(\"light\")}\n                  className={`flex flex-col items-center gap-2 p-4 rounded-xl border-2 transition-all hover-elevate ${\n                    theme === \"light\" ? \"border-primary bg-primary/5\" : \"border-border\"\n                  }`}\n                  data-testid=\"button-theme-light\"\n                >\n                  <div className=\"w-12 h-12 rounded-full bg-gradient-to-br from-amber-100 to-amber-300 flex items-center justify-center\">\n                    <Sun className=\"w-6 h-6 text-amber-600\" />\n                  </div>\n                  <span className=\"font-medium\">Claro</span>\n                </button>\n                <button\n                  onClick={() => setTheme(\"dark\")}\n                  className={`flex flex-col items-center gap-2 p-4 rounded-xl border-2 transition-all hover-elevate ${\n                    theme === \"dark\" ? \"border-primary bg-primary/5\" : \"border-border\"\n                  }`}\n                  data-testid=\"button-theme-dark\"\n                >\n                  <div className=\"w-12 h-12 rounded-full bg-gradient-to-br from-slate-700 to-slate-900 flex items-center justify-center\">\n                    <Moon className=\"w-6 h-6 text-slate-300\" />\n                  </div>\n                  <span className=\"font-medium\">Escuro</span>\n                </button>\n              </div>\n            </CardContent>\n          </Card>\n        </TabsContent>\n\n        <TabsContent value=\"colors\" className=\"space-y-6\">\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"flex items-center gap-2\">\n                <Palette className=\"h-5 w-5\" />\n                Cor Principal\n              </CardTitle>\n              <CardDescription>Escolha a cor que define a identidade visual do site</CardDescription>\n            </CardHeader>\n            <CardContent>\n              <div className=\"grid grid-cols-3 sm:grid-cols-4 lg:grid-cols-6 gap-3\">\n                {colorThemes.map((colorOption) => (\n                  <button\n                    key={colorOption.id}\n                    onClick={() => handleColorChange(colorOption.id)}\n                    className={`relative flex flex-col items-center gap-2 p-3 rounded-xl border-2 transition-all hover-elevate ${\n                      selectedColor === colorOption.id && !selectedCompleteTheme\n                        ? \"border-primary ring-2 ring-primary/20\"\n                        : \"border-border\"\n                    }`}\n                    data-testid={`button-color-${colorOption.id}`}\n                  >\n                    <div\n                      className=\"w-10 h-10 rounded-full shadow-md ring-2 ring-white/50\"\n                      style={{ backgroundColor: `hsl(${colorOption.primary})` }}\n                    />\n                    <span className=\"text-xs font-medium\">{colorOption.name}</span>\n                    {selectedColor === colorOption.id && !selectedCompleteTheme && (\n                      <div className=\"absolute -top-1 -right-1 w-5 h-5 bg-primary rounded-full flex items-center justify-center\">\n                        <Check className=\"w-3 h-3 text-primary-foreground\" />\n                      </div>\n                    )}\n                  </button>\n                ))}\n              </div>\n            </CardContent>\n          </Card>\n\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"flex items-center gap-2\">\n                <Layers className=\"h-5 w-5\" />\n                Template de Design\n              </CardTitle>\n              <CardDescription>Escolha o estilo visual do seu site</CardDescription>\n            </CardHeader>\n            <CardContent>\n              <div className=\"grid sm:grid-cols-2 lg:grid-cols-4 gap-4\">\n                {designTemplates.map((template) => {\n                  const Icon = template.icon;\n                  return (\n                    <button\n                      key={template.id}\n                      onClick={() => handleTemplateChange(template.id)}\n                      className={`relative text-left p-4 rounded-xl border-2 transition-all hover-elevate ${\n                        selectedTemplate === template.id\n                          ? \"border-primary bg-primary/5\"\n                          : \"border-border\"\n                      }`}\n                      data-testid={`button-template-${template.id}`}\n                    >\n                      <div className=\"flex items-center gap-2 mb-2\">\n                        <Icon className=\"h-5 w-5 text-muted-foreground\" />\n                        <p className=\"font-semibold\">{template.name}</p>\n                      </div>\n                      <p className=\"text-sm text-muted-foreground\">{template.description}</p>\n                      {selectedTemplate === template.id && (\n                        <div className=\"absolute top-2 right-2 w-5 h-5 bg-primary rounded-full flex items-center justify-center\">\n                          <Check className=\"w-3 h-3 text-primary-foreground\" />\n                        </div>\n                      )}\n                    </button>\n                  );\n                })}\n              </div>\n            </CardContent>\n          </Card>\n        </TabsContent>\n\n        <TabsContent value=\"branding\" className=\"space-y-6\">\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"flex items-center gap-2\">\n                <Building2 className=\"h-5 w-5\" />\n                Dados da Loja\n              </CardTitle>\n              <CardDescription>Informacoes que aparecem no site e documentos</CardDescription>\n            </CardHeader>\n            <CardContent className=\"space-y-4\">\n              <div className=\"grid gap-4 sm:grid-cols-2\">\n                <div className=\"space-y-2\">\n                  <Label>Nome da Loja</Label>\n                  <Input \n                    placeholder=\"Minha Loja\" \n                    value={storeName}\n                    onChange={(e) => setStoreName(e.target.value)}\n                    data-testid=\"input-store-name\"\n                  />\n                </div>\n                <div className=\"space-y-2\">\n                  <Label>CNPJ</Label>\n                  <Input \n                    placeholder=\"00.000.000/0000-00\" \n                    value={storeCnpj}\n                    onChange={(e) => setStoreCnpj(e.target.value)}\n                    data-testid=\"input-store-cnpj\"\n                  />\n                </div>\n                <div className=\"space-y-2\">\n                  <Label>Telefone</Label>\n                  <Input \n                    placeholder=\"(00) 00000-0000\" \n                    value={storePhone}\n                    onChange={(e) => setStorePhone(e.target.value)}\n                    data-testid=\"input-store-phone\"\n                  />\n                </div>\n                <div className=\"space-y-2\">\n                  <Label>E-mail</Label>\n                  <Input \n                    placeholder=\"contato@loja.com\" \n                    value={storeEmail}\n                    onChange={(e) => setStoreEmail(e.target.value)}\n                    data-testid=\"input-store-email\"\n                  />\n                </div>\n              </div>\n              <div className=\"space-y-2\">\n                <Label>Endereco</Label>\n                <Input \n                  placeholder=\"Rua, numero, bairro, cidade - UF\" \n                  value={storeAddress}\n                  onChange={(e) => setStoreAddress(e.target.value)}\n                  data-testid=\"input-store-address\"\n                />\n              </div>\n              <Separator />\n              <div className=\"space-y-2\">\n                <Label>Logo da Loja (URL)</Label>\n                <Input \n                  placeholder=\"https://exemplo.com/logo.png\" \n                  value={storeLogo}\n                  onChange={(e) => setStoreLogo(e.target.value)}\n                  data-testid=\"input-store-logo\"\n                />\n                {storeLogo && (\n                  <div className=\"mt-2 p-4 border rounded-xl bg-muted/30\">\n                    <p className=\"text-sm text-muted-foreground mb-2\">Previa:</p>\n                    <img src={storeLogo} alt=\"Logo\" className=\"max-h-16 object-contain\" />\n                  </div>\n                )}\n              </div>\n              <Button onClick={handleSaveStoreInfo} disabled={saveSetting.isPending} data-testid=\"button-save-store\">\n                Salvar Dados da Loja\n              </Button>\n            </CardContent>\n          </Card>\n\n          <Card>\n            <CardHeader>\n              <CardTitle>Modos de Exibicao</CardTitle>\n              <CardDescription>Configure como o catalogo e exibido</CardDescription>\n            </CardHeader>\n            <CardContent className=\"space-y-4\">\n              <div className=\"flex items-center justify-between\">\n                <div>\n                  <Label>Modo Atacado</Label>\n                  <p className=\"text-sm text-muted-foreground\">Exibir precos e opcoes para atacado</p>\n                </div>\n                <Switch\n                  checked={isWholesaleEnabled}\n                  onCheckedChange={(checked) => saveSetting.mutate({ key: 'wholesale_mode', value: checked ? 'true' : 'false' })}\n                  data-testid=\"switch-wholesale-mode\"\n                />\n              </div>\n              <Separator />\n              <div className=\"flex items-center justify-between\">\n                <div>\n                  <Label>Modo Delivery (iFood)</Label>\n                  <p className=\"text-sm text-muted-foreground\">Layout estilo aplicativo de delivery</p>\n                </div>\n                <Switch\n                  checked={isDeliveryModeEnabled}\n                  onCheckedChange={(checked) => saveSetting.mutate({ key: 'delivery_catalog_mode', value: checked ? 'true' : 'false' })}\n                  data-testid=\"switch-delivery-mode\"\n                />\n              </div>\n            </CardContent>\n          </Card>\n        </TabsContent>\n\n        <TabsContent value=\"banners\" className=\"space-y-6\">\n          <Card>\n            <CardHeader className=\"flex flex-row items-center justify-between gap-2\">\n              <div>\n                <CardTitle className=\"flex items-center gap-2\">\n                  <Image className=\"h-5 w-5\" />\n                  Banners do Carrossel\n                </CardTitle>\n                <CardDescription>Gerencie as imagens do carrossel principal</CardDescription>\n              </div>\n              <Dialog open={isSlideDialogOpen} onOpenChange={setIsSlideDialogOpen}>\n                <DialogTrigger asChild>\n                  <Button size=\"sm\" onClick={() => handleOpenSlideDialog()} data-testid=\"button-add-banner\">\n                    <Plus className=\"w-4 h-4 mr-1\" />\n                    Adicionar\n                  </Button>\n                </DialogTrigger>\n                <DialogContent>\n                  <DialogHeader>\n                    <DialogTitle>{editingSlide ? \"Editar Banner\" : \"Novo Banner\"}</DialogTitle>\n                  </DialogHeader>\n                  <div className=\"space-y-4\">\n                    <div className=\"space-y-2\">\n                      <Label>Titulo (opcional)</Label>\n                      <Input \n                        placeholder=\"Promocao de verao\" \n                        value={slideForm.title}\n                        onChange={(e) => setSlideForm({ ...slideForm, title: e.target.value })}\n                        data-testid=\"input-banner-title\"\n                      />\n                    </div>\n                    <div className=\"space-y-2\">\n                      <Label>URL da Imagem *</Label>\n                      <Input \n                        placeholder=\"https://exemplo.com/banner.jpg\" \n                        value={slideForm.imageUrl}\n                        onChange={(e) => setSlideForm({ ...slideForm, imageUrl: e.target.value })}\n                        data-testid=\"input-banner-image\"\n                      />\n                    </div>\n                    <div className=\"space-y-2\">\n                      <Label>Link ao clicar (opcional)</Label>\n                      <Input \n                        placeholder=\"https://loja.com/promocao\" \n                        value={slideForm.buttonLink}\n                        onChange={(e) => setSlideForm({ ...slideForm, buttonLink: e.target.value })}\n                        data-testid=\"input-banner-link\"\n                      />\n                    </div>\n                    <div className=\"flex items-center gap-2\">\n                      <Switch\n                        checked={slideForm.active}\n                        onCheckedChange={(checked) => setSlideForm({ ...slideForm, active: checked })}\n                        data-testid=\"switch-banner-active\"\n                      />\n                      <Label>Banner ativo</Label>\n                    </div>\n                    {slideForm.imageUrl && (\n                      <div className=\"border rounded-xl overflow-hidden\">\n                        <img src={slideForm.imageUrl} alt=\"Preview\" className=\"w-full h-32 object-cover\" />\n                      </div>\n                    )}\n                  </div>\n                  <DialogFooter>\n                    <Button variant=\"outline\" onClick={() => setIsSlideDialogOpen(false)}>Cancelar</Button>\n                    <Button onClick={handleSaveSlide} disabled={createSlide.isPending || updateSlide.isPending} data-testid=\"button-save-banner\">\n                      {editingSlide ? \"Salvar\" : \"Adicionar\"}\n                    </Button>\n                  </DialogFooter>\n                </DialogContent>\n              </Dialog>\n            </CardHeader>\n            <CardContent>\n              {slidesLoading ? (\n                <p className=\"text-muted-foreground\">Carregando...</p>\n              ) : slides.length === 0 ? (\n                <div className=\"text-center py-8 text-muted-foreground\">\n                  <Image className=\"w-12 h-12 mx-auto mb-2 opacity-30\" />\n                  <p>Nenhum banner cadastrado</p>\n                  <p className=\"text-sm\">Clique em \"Adicionar\" para criar o primeiro</p>\n                </div>\n              ) : (\n                <div className=\"space-y-3\">\n                  {slides.map((slide) => (\n                    <div \n                      key={slide.id} \n                      className=\"flex items-center gap-3 p-3 border rounded-xl bg-muted/30\"\n                      data-testid={`banner-item-${slide.id}`}\n                    >\n                      <GripVertical className=\"w-4 h-4 text-muted-foreground cursor-grab\" />\n                      <div className=\"w-24 h-14 rounded-lg overflow-hidden bg-muted shrink-0\">\n                        <img src={slide.imageUrl} alt={slide.title || \"Banner\"} className=\"w-full h-full object-cover\" />\n                      </div>\n                      <div className=\"flex-1 min-w-0\">\n                        <p className=\"font-medium truncate\">{slide.title || \"Sem titulo\"}</p>\n                        <p className=\"text-xs text-muted-foreground truncate\">{slide.imageUrl}</p>\n                      </div>\n                      <Badge variant={slide.active ? \"default\" : \"secondary\"}>\n                        {slide.active ? \"Ativo\" : \"Inativo\"}\n                      </Badge>\n                      <Button size=\"icon\" variant=\"ghost\" onClick={() => handleOpenSlideDialog(slide)} data-testid={`button-edit-banner-${slide.id}`}>\n                        <Edit className=\"w-4 h-4\" />\n                      </Button>\n                      <Button size=\"icon\" variant=\"ghost\" onClick={() => deleteSlide.mutate(slide.id)} data-testid={`button-delete-banner-${slide.id}`}>\n                        <Trash2 className=\"w-4 h-4\" />\n                      </Button>\n                    </div>\n                  ))}\n                </div>\n              )}\n            </CardContent>\n          </Card>\n        </TabsContent>\n\n        <TabsContent value=\"layout\" className=\"space-y-6\">\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"flex items-center gap-2\">\n                <Layout className=\"h-5 w-5\" />\n                Configuracoes de Layout\n              </CardTitle>\n              <CardDescription>Ajuste como os produtos sao exibidos</CardDescription>\n            </CardHeader>\n            <CardContent className=\"space-y-6\">\n              <div className=\"grid gap-4 sm:grid-cols-2\">\n                <div className=\"space-y-2\">\n                  <Label>Produtos por Linha (Desktop)</Label>\n                  <Select value={productsPerRow} onValueChange={(v) => {\n                    setProductsPerRow(v);\n                    saveSetting.mutate({ key: 'products_per_row', value: v });\n                  }}>\n                    <SelectTrigger data-testid=\"select-products-per-row\">\n                      <SelectValue />\n                    </SelectTrigger>\n                    <SelectContent>\n                      {productsPerRowOptions.map((opt) => (\n                        <SelectItem key={opt.value} value={opt.value}>{opt.label}</SelectItem>\n                      ))}\n                    </SelectContent>\n                  </Select>\n                  <p className=\"text-xs text-muted-foreground\">Quantos produtos aparecem em cada linha no desktop</p>\n                </div>\n                <div className=\"space-y-2\">\n                  <Label>Posicao das Categorias</Label>\n                  <Select value={categoryPosition} onValueChange={(v) => {\n                    setCategoryPosition(v);\n                    saveSetting.mutate({ key: 'category_position', value: v });\n                  }}>\n                    <SelectTrigger data-testid=\"select-category-position\">\n                      <SelectValue />\n                    </SelectTrigger>\n                    <SelectContent>\n                      {categoryPositionOptions.map((opt) => (\n                        <SelectItem key={opt.value} value={opt.value}>{opt.label}</SelectItem>\n                      ))}\n                    </SelectContent>\n                  </Select>\n                  <p className=\"text-xs text-muted-foreground\">Onde as categorias aparecem no catalogo</p>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n        </TabsContent>\n\n        <TabsContent value=\"advanced\" className=\"space-y-6\">\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"flex items-center gap-2\">\n                <Type className=\"h-5 w-5\" />\n                Tipografia\n              </CardTitle>\n              <CardDescription>Escolha a fonte usada em todo o site</CardDescription>\n            </CardHeader>\n            <CardContent>\n              <div className=\"grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 gap-3\">\n                {fontOptions.map((font) => (\n                  <button\n                    key={font.value}\n                    onClick={() => handleFontChange(font.value)}\n                    className={`p-4 rounded-xl border-2 transition-all hover-elevate text-center ${\n                      selectedFont === font.value\n                        ? \"border-primary bg-primary/5\"\n                        : \"border-border\"\n                    }`}\n                    data-testid={`button-font-${font.value}`}\n                  >\n                    <span className=\"text-lg font-semibold\">{font.label}</span>\n                    <p className=\"text-xs text-muted-foreground mt-1\">Aa Bb Cc</p>\n                  </button>\n                ))}\n              </div>\n            </CardContent>\n          </Card>\n\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"flex items-center gap-2\">\n                <Square className=\"h-5 w-5\" />\n                Arredondamento de Bordas\n              </CardTitle>\n              <CardDescription>Ajuste o arredondamento dos elementos</CardDescription>\n            </CardHeader>\n            <CardContent>\n              <div className=\"grid grid-cols-3 sm:grid-cols-6 gap-3\">\n                {borderRadiusOptions.map((radius) => (\n                  <button\n                    key={radius.value}\n                    onClick={() => handleRadiusChange(radius.value)}\n                    className={`p-4 rounded-xl border-2 transition-all hover-elevate ${\n                      selectedRadius === radius.value\n                        ? \"border-primary bg-primary/5\"\n                        : \"border-border\"\n                    }`}\n                    data-testid={`button-radius-${radius.value}`}\n                  >\n                    <div \n                      className=\"w-10 h-10 bg-primary/20 mx-auto mb-2\"\n                      style={{ borderRadius: radius.radius }}\n                    />\n                    <span className=\"text-xs font-medium\">{radius.label}</span>\n                  </button>\n                ))}\n              </div>\n            </CardContent>\n          </Card>\n\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"flex items-center gap-2\">\n                <Sidebar className=\"h-5 w-5\" />\n                Estilo do Menu\n              </CardTitle>\n              <CardDescription>Configure a aparencia do menu lateral</CardDescription>\n            </CardHeader>\n            <CardContent>\n              <div className=\"grid sm:grid-cols-3 gap-4\">\n                <button\n                  onClick={() => handleSidebarStyleChange(\"default\")}\n                  className={`p-4 rounded-xl border-2 transition-all hover-elevate text-left ${\n                    sidebarStyle === \"default\"\n                      ? \"border-primary bg-primary/5\"\n                      : \"border-border\"\n                  }`}\n                  data-testid=\"button-sidebar-default\"\n                >\n                  <div className=\"flex gap-2 mb-2\">\n                    <div className=\"w-4 h-16 bg-muted rounded\" />\n                    <div className=\"flex-1 h-16 bg-muted/50 rounded\" />\n                  </div>\n                  <p className=\"font-medium\">Padrao</p>\n                  <p className=\"text-xs text-muted-foreground\">Menu lateral classico</p>\n                </button>\n                <button\n                  onClick={() => handleSidebarStyleChange(\"compact\")}\n                  className={`p-4 rounded-xl border-2 transition-all hover-elevate text-left ${\n                    sidebarStyle === \"compact\"\n                      ? \"border-primary bg-primary/5\"\n                      : \"border-border\"\n                  }`}\n                  data-testid=\"button-sidebar-compact\"\n                >\n                  <div className=\"flex gap-2 mb-2\">\n                    <div className=\"w-2 h-16 bg-muted rounded\" />\n                    <div className=\"flex-1 h-16 bg-muted/50 rounded\" />\n                  </div>\n                  <p className=\"font-medium\">Compacto</p>\n                  <p className=\"text-xs text-muted-foreground\">Menu recolhido por padrao</p>\n                </button>\n                <button\n                  onClick={() => handleSidebarStyleChange(\"floating\")}\n                  className={`p-4 rounded-xl border-2 transition-all hover-elevate text-left ${\n                    sidebarStyle === \"floating\"\n                      ? \"border-primary bg-primary/5\"\n                      : \"border-border\"\n                  }`}\n                  data-testid=\"button-sidebar-floating\"\n                >\n                  <div className=\"relative mb-2\">\n                    <div className=\"h-16 bg-muted/50 rounded\" />\n                    <div className=\"absolute left-1 top-1 bottom-1 w-3 bg-card border rounded shadow-sm\" />\n                  </div>\n                  <p className=\"font-medium\">Flutuante</p>\n                  <p className=\"text-xs text-muted-foreground\">Menu sobre o conteudo</p>\n                </button>\n              </div>\n            </CardContent>\n          </Card>\n        </TabsContent>\n      </Tabs>\n    </div>\n  );\n}\n","path":null,"size_bytes":46088,"size_tokens":null},"client/src/pages/contas-pagar.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\nimport { useAuth } from \"@/contexts/AuthContext\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport type { AccountPayable, PayablePayment } from \"@shared/schema\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Separator } from \"@/components/ui/separator\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter } from \"@/components/ui/dialog\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport {\n  ArrowDownRight,\n  TrendingDown,\n  Calendar,\n  Plus,\n  Search,\n  DollarSign,\n  AlertTriangle,\n  CheckCircle,\n  Clock,\n  Loader2,\n  Receipt,\n  X,\n  ChevronRight,\n  Banknote,\n  Building2,\n  FileText\n} from \"lucide-react\";\nimport { format, differenceInDays } from \"date-fns\";\nimport { ptBR } from \"date-fns/locale\";\n\ninterface PayablesDashboard {\n  overview: {\n    totalPayables: number;\n    totalPending: number;\n    totalPaid: number;\n    totalOverdue: number;\n    payablesCount: number;\n  };\n  upcomingPayables: Array<{\n    id: number;\n    supplierName: string | null;\n    category: string | null;\n    description: string;\n    amount: number;\n    pendingAmount: number;\n    dueDate: Date;\n    daysUntilDue: number;\n    status: string;\n  }>;\n  overduePayables: Array<{\n    id: number;\n    supplierName: string | null;\n    category: string | null;\n    description: string;\n    amount: number;\n    pendingAmount: number;\n    dueDate: Date;\n    daysUntilDue: number;\n    status: string;\n  }>;\n  recentPayments: Array<{\n    paymentId: number;\n    payableId: number;\n    supplierName: string | null;\n    amount: number;\n    paymentMethod: string | null;\n    createdAt: Date;\n  }>;\n  byCategory: Array<{\n    category: string;\n    total: number;\n    pending: number;\n    count: number;\n  }>;\n}\n\nconst CATEGORIES = [\n  \"Fornecedor\",\n  \"Aluguel\",\n  \"Salario\",\n  \"Imposto\",\n  \"Energia\",\n  \"Agua\",\n  \"Internet\",\n  \"Telefone\",\n  \"Manutencao\",\n  \"Marketing\",\n  \"Outros\"\n];\n\nconst PAYMENT_METHODS = [\n  { value: \"PIX\", label: \"PIX\" },\n  { value: \"BOLETO\", label: \"Boleto\" },\n  { value: \"TRANSFERENCIA\", label: \"Transferencia\" },\n  { value: \"DINHEIRO\", label: \"Dinheiro\" },\n  { value: \"CARTAO\", label: \"Cartao\" },\n];\n\nexport default function ContasPagarPage() {\n  const { isAdmin, isSales } = useAuth();\n  const { toast } = useToast();\n  const [activeTab, setActiveTab] = useState(\"dashboard\");\n  const [showNewPayableModal, setShowNewPayableModal] = useState(false);\n  const [showPaymentModal, setShowPaymentModal] = useState(false);\n  const [selectedPayableId, setSelectedPayableId] = useState<number | null>(null);\n  const [categoryFilter, setCategoryFilter] = useState<string>(\"all\");\n\n  const showPage = isAdmin;\n\n  const { data: dashboard, isLoading: dashboardLoading } = useQuery<PayablesDashboard>({\n    queryKey: ['/api/payables/dashboard'],\n    enabled: showPage,\n  });\n\n  const { data: allPayables = [] } = useQuery<AccountPayable[]>({\n    queryKey: ['/api/payables'],\n    enabled: showPage,\n  });\n\n  const filteredPayables = categoryFilter === \"all\" \n    ? allPayables \n    : allPayables.filter(p => p.category === categoryFilter);\n\n  const formatPrice = (value: number) => {\n    return new Intl.NumberFormat('pt-BR', {\n      style: 'currency',\n      currency: 'BRL'\n    }).format(value);\n  };\n\n  const formatDate = (date: Date | string) => {\n    return format(new Date(date), \"dd/MM/yyyy\", { locale: ptBR });\n  };\n\n  const getStatusBadge = (status: string) => {\n    switch (status) {\n      case 'PAGO':\n        return <Badge className=\"bg-green-500/20 text-green-600\">Pago</Badge>;\n      case 'VENCIDO':\n        return <Badge className=\"bg-red-500/20 text-red-600\">Vencido</Badge>;\n      case 'PENDENTE':\n        return <Badge className=\"bg-blue-500/20 text-blue-600\">Pendente</Badge>;\n      case 'CANCELADO':\n        return <Badge variant=\"secondary\">Cancelado</Badge>;\n      default:\n        return <Badge variant=\"secondary\">{status}</Badge>;\n    }\n  };\n\n  if (!showPage) {\n    return (\n      <div className=\"flex items-center justify-center h-full\">\n        <p className=\"text-muted-foreground\">Acesso nao autorizado</p>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"h-full flex flex-col\">\n      <div className=\"border-b bg-card p-4\">\n        <div className=\"flex items-center justify-between gap-4 flex-wrap\">\n          <div className=\"flex items-center gap-3\">\n            <div className=\"h-10 w-10 rounded-lg bg-red-500/10 flex items-center justify-center\">\n              <ArrowDownRight className=\"h-5 w-5 text-red-500\" />\n            </div>\n            <div>\n              <h1 className=\"text-xl font-semibold\">Contas a Pagar</h1>\n              <p className=\"text-sm text-muted-foreground\">Gerenciamento de despesas e dividas</p>\n            </div>\n          </div>\n          <Button onClick={() => setShowNewPayableModal(true)} data-testid=\"button-new-payable\">\n            <Plus className=\"h-4 w-4 mr-2\" />\n            Nova Conta\n          </Button>\n        </div>\n      </div>\n\n      <Tabs value={activeTab} onValueChange={setActiveTab} className=\"flex-1 flex flex-col\">\n        <div className=\"border-b px-4\">\n          <TabsList className=\"bg-transparent h-12\">\n            <TabsTrigger value=\"dashboard\" className=\"gap-2\" data-testid=\"tab-payables-dashboard\">\n              <TrendingDown className=\"h-4 w-4\" />\n              Visao Geral\n            </TabsTrigger>\n            <TabsTrigger value=\"list\" className=\"gap-2\" data-testid=\"tab-payables-list\">\n              <FileText className=\"h-4 w-4\" />\n              Todas as Contas\n            </TabsTrigger>\n            <TabsTrigger value=\"upcoming\" className=\"gap-2\" data-testid=\"tab-payables-upcoming\">\n              <Calendar className=\"h-4 w-4\" />\n              Vencimentos\n            </TabsTrigger>\n          </TabsList>\n        </div>\n\n        <ScrollArea className=\"flex-1\">\n          <TabsContent value=\"dashboard\" className=\"m-0 p-4\">\n            {dashboardLoading ? (\n              <div className=\"flex items-center justify-center py-20\">\n                <Loader2 className=\"h-8 w-8 animate-spin text-muted-foreground\" />\n              </div>\n            ) : dashboard ? (\n              <div className=\"space-y-6\">\n                <div className=\"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4\">\n                  <Card>\n                    <CardContent className=\"pt-4\">\n                      <div className=\"flex items-center justify-between\">\n                        <div>\n                          <p className=\"text-sm text-muted-foreground\">Total a Pagar</p>\n                          <p className=\"text-2xl font-bold text-red-500\" data-testid=\"text-total-payable\">\n                            {formatPrice(dashboard.overview.totalPending)}\n                          </p>\n                        </div>\n                        <div className=\"h-10 w-10 rounded-lg bg-red-500/10 flex items-center justify-center\">\n                          <ArrowDownRight className=\"h-5 w-5 text-red-500\" />\n                        </div>\n                      </div>\n                    </CardContent>\n                  </Card>\n\n                  <Card>\n                    <CardContent className=\"pt-4\">\n                      <div className=\"flex items-center justify-between\">\n                        <div>\n                          <p className=\"text-sm text-muted-foreground\">Vencido</p>\n                          <p className=\"text-2xl font-bold text-orange-500\" data-testid=\"text-total-overdue-payable\">\n                            {formatPrice(dashboard.overview.totalOverdue)}\n                          </p>\n                        </div>\n                        <div className=\"h-10 w-10 rounded-lg bg-orange-500/10 flex items-center justify-center\">\n                          <AlertTriangle className=\"h-5 w-5 text-orange-500\" />\n                        </div>\n                      </div>\n                    </CardContent>\n                  </Card>\n\n                  <Card>\n                    <CardContent className=\"pt-4\">\n                      <div className=\"flex items-center justify-between\">\n                        <div>\n                          <p className=\"text-sm text-muted-foreground\">Total Pago</p>\n                          <p className=\"text-2xl font-bold text-green-500\" data-testid=\"text-total-paid-payable\">\n                            {formatPrice(dashboard.overview.totalPaid)}\n                          </p>\n                        </div>\n                        <div className=\"h-10 w-10 rounded-lg bg-green-500/10 flex items-center justify-center\">\n                          <CheckCircle className=\"h-5 w-5 text-green-500\" />\n                        </div>\n                      </div>\n                    </CardContent>\n                  </Card>\n\n                  <Card>\n                    <CardContent className=\"pt-4\">\n                      <div className=\"flex items-center justify-between\">\n                        <div>\n                          <p className=\"text-sm text-muted-foreground\">Contas Ativas</p>\n                          <p className=\"text-2xl font-bold\" data-testid=\"text-payables-count\">\n                            {dashboard.overview.payablesCount}\n                          </p>\n                        </div>\n                        <div className=\"h-10 w-10 rounded-lg bg-muted flex items-center justify-center\">\n                          <Receipt className=\"h-5 w-5\" />\n                        </div>\n                      </div>\n                    </CardContent>\n                  </Card>\n                </div>\n\n                {dashboard.byCategory && dashboard.byCategory.length > 0 && (\n                  <Card>\n                    <CardHeader>\n                      <CardTitle className=\"text-base\">Por Categoria</CardTitle>\n                    </CardHeader>\n                    <CardContent>\n                      <div className=\"space-y-3\">\n                        {dashboard.byCategory.map((cat) => (\n                          <div key={cat.category} className=\"flex items-center justify-between p-3 rounded-lg bg-muted/50\">\n                            <div className=\"flex items-center gap-3\">\n                              <Badge variant=\"outline\">{cat.category}</Badge>\n                              <span className=\"text-sm text-muted-foreground\">{cat.count} contas</span>\n                            </div>\n                            <div className=\"text-right\">\n                              <p className=\"font-medium\">{formatPrice(cat.pending)}</p>\n                              <p className=\"text-xs text-muted-foreground\">de {formatPrice(cat.total)}</p>\n                            </div>\n                          </div>\n                        ))}\n                      </div>\n                    </CardContent>\n                  </Card>\n                )}\n\n                {dashboard.overduePayables && dashboard.overduePayables.length > 0 && (\n                  <Card className=\"border-red-500/20\">\n                    <CardHeader>\n                      <CardTitle className=\"text-base flex items-center gap-2\">\n                        <AlertTriangle className=\"h-4 w-4 text-red-500\" />\n                        Contas Vencidas\n                      </CardTitle>\n                    </CardHeader>\n                    <CardContent>\n                      <div className=\"space-y-2\">\n                        {dashboard.overduePayables.slice(0, 5).map((payable) => (\n                          <div key={payable.id} className=\"flex items-center justify-between p-3 rounded-lg bg-red-500/5\">\n                            <div>\n                              <p className=\"font-medium\">{payable.description}</p>\n                              <p className=\"text-sm text-muted-foreground\">\n                                {payable.supplierName || payable.category}\n                              </p>\n                            </div>\n                            <div className=\"text-right\">\n                              <p className=\"font-medium text-red-500\">{formatPrice(payable.pendingAmount)}</p>\n                              <p className=\"text-xs text-red-500\">\n                                {Math.abs(payable.daysUntilDue)} dias atrasado\n                              </p>\n                            </div>\n                          </div>\n                        ))}\n                      </div>\n                    </CardContent>\n                  </Card>\n                )}\n              </div>\n            ) : (\n              <div className=\"text-center py-20\">\n                <p className=\"text-muted-foreground\">Nenhum dado disponivel</p>\n              </div>\n            )}\n          </TabsContent>\n\n          <TabsContent value=\"list\" className=\"m-0 p-4\">\n            <div className=\"space-y-4\">\n              <div className=\"flex items-center gap-4\">\n                <Select value={categoryFilter} onValueChange={setCategoryFilter}>\n                  <SelectTrigger className=\"w-48\" data-testid=\"select-category-filter\">\n                    <SelectValue placeholder=\"Filtrar por categoria\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"all\">Todas as categorias</SelectItem>\n                    {CATEGORIES.map((cat) => (\n                      <SelectItem key={cat} value={cat}>{cat}</SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n              </div>\n\n              <div className=\"space-y-2\">\n                {filteredPayables.length === 0 ? (\n                  <div className=\"text-center py-20\">\n                    <Receipt className=\"h-12 w-12 mx-auto text-muted-foreground/50 mb-4\" />\n                    <p className=\"text-muted-foreground\">Nenhuma conta encontrada</p>\n                  </div>\n                ) : (\n                  filteredPayables.map((payable) => {\n                    const pending = parseFloat(payable.amount) - parseFloat(payable.paidAmount);\n                    return (\n                      <Card key={payable.id} className=\"hover-elevate\">\n                        <CardContent className=\"p-4\">\n                          <div className=\"flex items-center justify-between\">\n                            <div className=\"flex-1\">\n                              <div className=\"flex items-center gap-2 mb-1\">\n                                <p className=\"font-medium\">{payable.description}</p>\n                                {getStatusBadge(payable.status)}\n                              </div>\n                              <div className=\"flex items-center gap-4 text-sm text-muted-foreground\">\n                                {payable.supplierName && (\n                                  <span className=\"flex items-center gap-1\">\n                                    <Building2 className=\"h-3 w-3\" />\n                                    {payable.supplierName}\n                                  </span>\n                                )}\n                                {payable.category && (\n                                  <Badge variant=\"outline\" className=\"text-xs\">{payable.category}</Badge>\n                                )}\n                                {payable.dueDate && (\n                                  <span className=\"flex items-center gap-1\">\n                                    <Calendar className=\"h-3 w-3\" />\n                                    {formatDate(payable.dueDate)}\n                                  </span>\n                                )}\n                              </div>\n                            </div>\n                            <div className=\"text-right\">\n                              <p className=\"font-medium\">{formatPrice(pending)}</p>\n                              <p className=\"text-xs text-muted-foreground\">\n                                de {formatPrice(parseFloat(payable.amount))}\n                              </p>\n                            </div>\n                            {payable.status !== 'PAGO' && payable.status !== 'CANCELADO' && (\n                              <Button\n                                variant=\"outline\"\n                                size=\"sm\"\n                                className=\"ml-4\"\n                                onClick={() => {\n                                  setSelectedPayableId(payable.id);\n                                  setShowPaymentModal(true);\n                                }}\n                                data-testid={`button-pay-${payable.id}`}\n                              >\n                                <DollarSign className=\"h-4 w-4 mr-1\" />\n                                Pagar\n                              </Button>\n                            )}\n                          </div>\n                        </CardContent>\n                      </Card>\n                    );\n                  })\n                )}\n              </div>\n            </div>\n          </TabsContent>\n\n          <TabsContent value=\"upcoming\" className=\"m-0 p-4\">\n            <div className=\"space-y-6\">\n              {dashboard?.upcomingPayables && dashboard.upcomingPayables.length > 0 && (\n                <Card>\n                  <CardHeader>\n                    <CardTitle className=\"text-base flex items-center gap-2\">\n                      <Clock className=\"h-4 w-4\" />\n                      Proximos Vencimentos\n                    </CardTitle>\n                  </CardHeader>\n                  <CardContent>\n                    <div className=\"space-y-2\">\n                      {dashboard.upcomingPayables.map((payable) => (\n                        <div \n                          key={payable.id} \n                          className=\"flex items-center justify-between p-3 rounded-lg bg-muted/50\"\n                        >\n                          <div>\n                            <p className=\"font-medium\">{payable.description}</p>\n                            <p className=\"text-sm text-muted-foreground\">\n                              {payable.supplierName || payable.category}\n                            </p>\n                          </div>\n                          <div className=\"text-right\">\n                            <p className=\"font-medium\">{formatPrice(payable.pendingAmount)}</p>\n                            <p className=\"text-xs text-muted-foreground\">\n                              em {payable.daysUntilDue} dias\n                            </p>\n                          </div>\n                        </div>\n                      ))}\n                    </div>\n                  </CardContent>\n                </Card>\n              )}\n\n              {dashboard?.overduePayables && dashboard.overduePayables.length > 0 && (\n                <Card className=\"border-red-500/20\">\n                  <CardHeader>\n                    <CardTitle className=\"text-base flex items-center gap-2\">\n                      <AlertTriangle className=\"h-4 w-4 text-red-500\" />\n                      Contas Atrasadas\n                    </CardTitle>\n                  </CardHeader>\n                  <CardContent>\n                    <div className=\"space-y-2\">\n                      {dashboard.overduePayables.map((payable) => (\n                        <div \n                          key={payable.id} \n                          className=\"flex items-center justify-between p-3 rounded-lg bg-red-500/5\"\n                        >\n                          <div>\n                            <p className=\"font-medium\">{payable.description}</p>\n                            <p className=\"text-sm text-muted-foreground\">\n                              {payable.supplierName || payable.category}\n                            </p>\n                          </div>\n                          <div className=\"text-right\">\n                            <p className=\"font-medium text-red-500\">{formatPrice(payable.pendingAmount)}</p>\n                            <p className=\"text-xs text-red-500\">\n                              {Math.abs(payable.daysUntilDue)} dias atrasado\n                            </p>\n                          </div>\n                        </div>\n                      ))}\n                    </div>\n                  </CardContent>\n                </Card>\n              )}\n\n              {(!dashboard?.upcomingPayables?.length && !dashboard?.overduePayables?.length) && (\n                <div className=\"text-center py-20\">\n                  <Calendar className=\"h-12 w-12 mx-auto text-muted-foreground/50 mb-4\" />\n                  <p className=\"text-muted-foreground\">Nenhum vencimento programado</p>\n                </div>\n              )}\n            </div>\n          </TabsContent>\n        </ScrollArea>\n      </Tabs>\n\n      <NewPayableModal \n        open={showNewPayableModal} \n        onClose={() => setShowNewPayableModal(false)} \n      />\n\n      <PaymentModal\n        open={showPaymentModal}\n        payableId={selectedPayableId}\n        onClose={() => {\n          setShowPaymentModal(false);\n          setSelectedPayableId(null);\n        }}\n      />\n    </div>\n  );\n}\n\nfunction NewPayableModal({ open, onClose }: { open: boolean; onClose: () => void }) {\n  const { toast } = useToast();\n  const [formData, setFormData] = useState({\n    supplierName: \"\",\n    category: \"\",\n    description: \"\",\n    amount: \"\",\n    dueDate: \"\",\n    documentNumber: \"\",\n    notes: \"\"\n  });\n\n  const createMutation = useMutation({\n    mutationFn: async (data: any) => {\n      return apiRequest('/api/payables', {\n        method: 'POST',\n        body: JSON.stringify(data),\n      });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/payables'] });\n      queryClient.invalidateQueries({ queryKey: ['/api/payables/dashboard'] });\n      toast({ title: \"Conta criada com sucesso\" });\n      onClose();\n      setFormData({\n        supplierName: \"\",\n        category: \"\",\n        description: \"\",\n        amount: \"\",\n        dueDate: \"\",\n        documentNumber: \"\",\n        notes: \"\"\n      });\n    },\n    onError: () => {\n      toast({ title: \"Erro ao criar conta\", variant: \"destructive\" });\n    }\n  });\n\n  const handleSubmit = () => {\n    if (!formData.description || !formData.amount) {\n      toast({ title: \"Preencha os campos obrigatorios\", variant: \"destructive\" });\n      return;\n    }\n\n    createMutation.mutate({\n      ...formData,\n      amount: formData.amount,\n      dueDate: formData.dueDate ? new Date(formData.dueDate) : null,\n    });\n  };\n\n  return (\n    <Dialog open={open} onOpenChange={onClose}>\n      <DialogContent className=\"sm:max-w-lg\">\n        <DialogHeader>\n          <DialogTitle>Nova Conta a Pagar</DialogTitle>\n        </DialogHeader>\n        <div className=\"space-y-4 py-4\">\n          <div className=\"grid grid-cols-2 gap-4\">\n            <div className=\"space-y-2\">\n              <Label>Fornecedor</Label>\n              <Input\n                value={formData.supplierName}\n                onChange={(e) => setFormData({ ...formData, supplierName: e.target.value })}\n                placeholder=\"Nome do fornecedor\"\n                data-testid=\"input-supplier-name\"\n              />\n            </div>\n            <div className=\"space-y-2\">\n              <Label>Categoria</Label>\n              <Select\n                value={formData.category}\n                onValueChange={(val) => setFormData({ ...formData, category: val })}\n              >\n                <SelectTrigger data-testid=\"select-category\">\n                  <SelectValue placeholder=\"Selecione\" />\n                </SelectTrigger>\n                <SelectContent>\n                  {CATEGORIES.map((cat) => (\n                    <SelectItem key={cat} value={cat}>{cat}</SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n          </div>\n\n          <div className=\"space-y-2\">\n            <Label>Descricao *</Label>\n            <Input\n              value={formData.description}\n              onChange={(e) => setFormData({ ...formData, description: e.target.value })}\n              placeholder=\"Descricao da conta\"\n              data-testid=\"input-description\"\n            />\n          </div>\n\n          <div className=\"grid grid-cols-2 gap-4\">\n            <div className=\"space-y-2\">\n              <Label>Valor *</Label>\n              <Input\n                type=\"number\"\n                step=\"0.01\"\n                value={formData.amount}\n                onChange={(e) => setFormData({ ...formData, amount: e.target.value })}\n                placeholder=\"0.00\"\n                data-testid=\"input-amount\"\n              />\n            </div>\n            <div className=\"space-y-2\">\n              <Label>Vencimento</Label>\n              <Input\n                type=\"date\"\n                value={formData.dueDate}\n                onChange={(e) => setFormData({ ...formData, dueDate: e.target.value })}\n                data-testid=\"input-due-date\"\n              />\n            </div>\n          </div>\n\n          <div className=\"space-y-2\">\n            <Label>Numero do Documento</Label>\n            <Input\n              value={formData.documentNumber}\n              onChange={(e) => setFormData({ ...formData, documentNumber: e.target.value })}\n              placeholder=\"NF, Boleto, etc.\"\n              data-testid=\"input-document-number\"\n            />\n          </div>\n\n          <div className=\"space-y-2\">\n            <Label>Observacoes</Label>\n            <Textarea\n              value={formData.notes}\n              onChange={(e) => setFormData({ ...formData, notes: e.target.value })}\n              placeholder=\"Observacoes adicionais\"\n              data-testid=\"input-notes\"\n            />\n          </div>\n        </div>\n        <DialogFooter>\n          <Button variant=\"outline\" onClick={onClose}>Cancelar</Button>\n          <Button onClick={handleSubmit} disabled={createMutation.isPending}>\n            {createMutation.isPending && <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />}\n            Criar Conta\n          </Button>\n        </DialogFooter>\n      </DialogContent>\n    </Dialog>\n  );\n}\n\nfunction PaymentModal({ \n  open, \n  payableId, \n  onClose \n}: { \n  open: boolean; \n  payableId: number | null;\n  onClose: () => void;\n}) {\n  const { toast } = useToast();\n  const [amount, setAmount] = useState(\"\");\n  const [paymentMethod, setPaymentMethod] = useState(\"\");\n  const [notes, setNotes] = useState(\"\");\n\n  const payMutation = useMutation({\n    mutationFn: async (data: any) => {\n      return apiRequest(`/api/payables/${payableId}/payments`, {\n        method: 'POST',\n        body: JSON.stringify(data),\n      });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/payables'] });\n      queryClient.invalidateQueries({ queryKey: ['/api/payables/dashboard'] });\n      toast({ title: \"Pagamento registrado com sucesso\" });\n      onClose();\n      setAmount(\"\");\n      setPaymentMethod(\"\");\n      setNotes(\"\");\n    },\n    onError: () => {\n      toast({ title: \"Erro ao registrar pagamento\", variant: \"destructive\" });\n    }\n  });\n\n  const handleSubmit = () => {\n    if (!amount) {\n      toast({ title: \"Informe o valor do pagamento\", variant: \"destructive\" });\n      return;\n    }\n\n    payMutation.mutate({\n      amount,\n      paymentMethod,\n      notes\n    });\n  };\n\n  return (\n    <Dialog open={open} onOpenChange={onClose}>\n      <DialogContent className=\"sm:max-w-md\">\n        <DialogHeader>\n          <DialogTitle>Registrar Pagamento</DialogTitle>\n        </DialogHeader>\n        <div className=\"space-y-4 py-4\">\n          <div className=\"space-y-2\">\n            <Label>Valor *</Label>\n            <Input\n              type=\"number\"\n              step=\"0.01\"\n              value={amount}\n              onChange={(e) => setAmount(e.target.value)}\n              placeholder=\"0.00\"\n              data-testid=\"input-payment-amount\"\n            />\n          </div>\n\n          <div className=\"space-y-2\">\n            <Label>Forma de Pagamento</Label>\n            <Select value={paymentMethod} onValueChange={setPaymentMethod}>\n              <SelectTrigger data-testid=\"select-payment-method\">\n                <SelectValue placeholder=\"Selecione\" />\n              </SelectTrigger>\n              <SelectContent>\n                {PAYMENT_METHODS.map((method) => (\n                  <SelectItem key={method.value} value={method.value}>{method.label}</SelectItem>\n                ))}\n              </SelectContent>\n            </Select>\n          </div>\n\n          <div className=\"space-y-2\">\n            <Label>Observacoes</Label>\n            <Textarea\n              value={notes}\n              onChange={(e) => setNotes(e.target.value)}\n              placeholder=\"Observacoes\"\n              data-testid=\"input-payment-notes\"\n            />\n          </div>\n        </div>\n        <DialogFooter>\n          <Button variant=\"outline\" onClick={onClose}>Cancelar</Button>\n          <Button onClick={handleSubmit} disabled={payMutation.isPending}>\n            {payMutation.isPending && <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />}\n            Registrar Pagamento\n          </Button>\n        </DialogFooter>\n      </DialogContent>\n    </Dialog>\n  );\n}\n","path":null,"size_bytes":29694,"size_tokens":null},"client/src/components/DeliveryCatalog.tsx":{"content":"import { useState, useMemo, useRef } from \"react\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Loader2, Search, Plus, Minus, ShoppingCart, Star, ChevronLeft, ChevronRight, Package, Clock, MapPin } from \"lucide-react\";\nimport { useCart } from \"@/contexts/CartContext\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { Link } from \"wouter\";\nimport type { Product as SchemaProduct, Category } from \"@shared/schema\";\n\ninterface ProductsResponse {\n  products: SchemaProduct[];\n  total: number;\n  page: number;\n  totalPages: number;\n}\n\ninterface DeliveryCatalogProps {\n  isPublic?: boolean;\n}\n\nexport function DeliveryCatalog({ isPublic = false }: DeliveryCatalogProps) {\n  const [searchQuery, setSearchQuery] = useState(\"\");\n  const [selectedCategory, setSelectedCategory] = useState<number | null>(null);\n  const [quantities, setQuantities] = useState<Record<number, number>>({});\n  const [page, setPage] = useState(1);\n  const { items, addItem, totalItems, totalPrice } = useCart();\n  const { toast } = useToast();\n  const categoryScrollRef = useRef<HTMLDivElement>(null);\n\n  const apiPrefix = isPublic ? '/api/public' : '/api';\n\n  const { data: categories = [] } = useQuery<Category[]>({\n    queryKey: [`${apiPrefix}/categories`],\n  });\n\n  const parentCategories = useMemo(() => \n    categories.filter(c => !c.parentId), \n    [categories]\n  );\n\n  const queryParams = useMemo(() => {\n    const params = new URLSearchParams();\n    params.set('page', String(page));\n    params.set('limit', '20');\n    if (selectedCategory) params.set('categoryId', String(selectedCategory));\n    if (searchQuery) params.set('search', searchQuery);\n    return params.toString();\n  }, [selectedCategory, searchQuery, page]);\n\n  const { data: productsResponse, isLoading } = useQuery<ProductsResponse>({\n    queryKey: [`${apiPrefix}/products`, queryParams],\n    queryFn: async () => {\n      const res = await fetch(`${apiPrefix}/products?${queryParams}`, { credentials: 'include' });\n      if (!res.ok) throw new Error('Failed to fetch products');\n      return res.json();\n    },\n  });\n\n  const products = productsResponse?.products || [];\n  const totalPages = productsResponse?.totalPages || 1;\n  const totalProducts = productsResponse?.total || 0;\n  const featuredProducts = products.filter(p => p.featured);\n  const regularProducts = products.filter(p => !p.featured);\n\n  const handleCategoryChange = (catId: number | null) => {\n    setSelectedCategory(catId);\n    setPage(1);\n  };\n\n  const handleSearchChange = (value: string) => {\n    setSearchQuery(value);\n    setPage(1);\n  };\n\n  const getQuantity = (productId: number) => {\n    return quantities[productId] || 0;\n  };\n\n  const setQuantity = (productId: number, qty: number) => {\n    setQuantities(prev => ({\n      ...prev,\n      [productId]: Math.max(0, qty),\n    }));\n  };\n\n  const handleAddToCart = (product: SchemaProduct, qty: number = 1) => {\n    if (qty <= 0) return;\n\n    addItem({\n      productId: String(product.id),\n      name: product.name,\n      sku: product.sku,\n      price: Number(product.price),\n      quantity: qty,\n      image: product.image || undefined,\n    });\n\n    toast({\n      title: \"Adicionado ao carrinho\",\n      description: `${qty}x ${product.name}`,\n    });\n\n    setQuantity(product.id, 0);\n  };\n\n  const scrollCategories = (direction: 'left' | 'right') => {\n    if (categoryScrollRef.current) {\n      const scrollAmount = 200;\n      categoryScrollRef.current.scrollBy({\n        left: direction === 'left' ? -scrollAmount : scrollAmount,\n        behavior: 'smooth'\n      });\n    }\n  };\n\n  const formatPrice = (price: string | number) => {\n    return new Intl.NumberFormat('pt-BR', {\n      style: 'currency',\n      currency: 'BRL'\n    }).format(Number(price));\n  };\n\n  const ProductCard = ({ product }: { product: SchemaProduct }) => {\n    const qty = getQuantity(product.id);\n    const stock = product.stock ?? 0;\n    const isOutOfStock = stock <= 0;\n    const maxQty = stock > 0 ? stock : 999;\n\n    return (\n      <div \n        className={`bg-card rounded-lg border border-border/50 flex gap-3 p-3 ${isOutOfStock ? 'opacity-60' : ''}`}\n        data-testid={`delivery-card-${product.id}`}\n      >\n        <div className=\"relative w-24 h-24 sm:w-28 sm:h-28 rounded-lg overflow-hidden bg-muted shrink-0\">\n          {product.image ? (\n            <img\n              src={product.image}\n              alt={product.name}\n              className=\"w-full h-full object-cover\"\n            />\n          ) : (\n            <div className=\"w-full h-full flex items-center justify-center\">\n              <Package className=\"w-8 h-8 text-muted-foreground/30\" />\n            </div>\n          )}\n          {product.featured && (\n            <div className=\"absolute top-1 left-1\">\n              <Badge variant=\"default\" className=\"text-xs px-1.5 py-0.5\">\n                <Star className=\"w-2.5 h-2.5 mr-0.5\" />\n                Top\n              </Badge>\n            </div>\n          )}\n          {isOutOfStock && (\n            <div className=\"absolute inset-0 bg-background/70 flex items-center justify-center\">\n              <span className=\"text-xs font-medium text-muted-foreground\">Esgotado</span>\n            </div>\n          )}\n        </div>\n\n        <div className=\"flex-1 flex flex-col min-w-0\">\n          <h3 className=\"font-medium text-sm line-clamp-2 mb-0.5\" data-testid={`text-product-name-${product.id}`}>\n            {product.name}\n          </h3>\n          \n          {product.brand && (\n            <span className=\"text-xs text-muted-foreground\">{product.brand}</span>\n          )}\n          \n          {product.description && (\n            <p className=\"text-xs text-muted-foreground line-clamp-2 mt-1\">\n              {product.description.replace(/<[^>]*>/g, '').substring(0, 80)}\n            </p>\n          )}\n          \n          <div className=\"mt-auto pt-2 flex items-end justify-between gap-2\">\n            <span className=\"text-base font-bold text-primary\" data-testid={`text-price-${product.id}`}>\n              {formatPrice(product.price)}\n            </span>\n            \n            {qty === 0 ? (\n              <Button\n                size=\"sm\"\n                onClick={() => setQuantity(product.id, 1)}\n                disabled={isOutOfStock}\n                className=\"rounded-full px-4\"\n                data-testid={`button-add-${product.id}`}\n              >\n                <Plus className=\"w-4 h-4 mr-1\" />\n                Adicionar\n              </Button>\n            ) : (\n              <div className=\"flex items-center bg-primary rounded-full\">\n                <Button\n                  size=\"icon\"\n                  variant=\"ghost\"\n                  className=\"h-8 w-8 rounded-full text-primary-foreground hover:bg-primary-foreground/20\"\n                  onClick={() => setQuantity(product.id, qty - 1)}\n                  data-testid={`button-minus-${product.id}`}\n                >\n                  <Minus className=\"w-4 h-4\" />\n                </Button>\n                <span className=\"w-6 text-center text-sm font-bold text-primary-foreground\" data-testid={`text-qty-${product.id}`}>\n                  {qty}\n                </span>\n                <Button\n                  size=\"icon\"\n                  variant=\"ghost\"\n                  className=\"h-8 w-8 rounded-full text-primary-foreground hover:bg-primary-foreground/20\"\n                  onClick={() => {\n                    if (qty < maxQty) {\n                      setQuantity(product.id, qty + 1);\n                    }\n                  }}\n                  disabled={qty >= maxQty}\n                  data-testid={`button-plus-${product.id}`}\n                >\n                  <Plus className=\"w-4 h-4\" />\n                </Button>\n                <Button\n                  size=\"sm\"\n                  variant=\"ghost\"\n                  className=\"rounded-full text-primary-foreground hover:bg-primary-foreground/20 px-3 ml-1\"\n                  onClick={() => handleAddToCart(product, qty)}\n                  data-testid={`button-confirm-${product.id}`}\n                >\n                  OK\n                </Button>\n              </div>\n            )}\n          </div>\n        </div>\n      </div>\n    );\n  };\n\n  if (isLoading) {\n    return (\n      <div className=\"flex items-center justify-center h-64\">\n        <Loader2 className=\"w-8 h-8 animate-spin text-primary\" />\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"min-h-screen bg-background pb-20\">\n      <div className=\"sticky top-0 z-30 bg-background border-b shadow-sm\">\n        <div className=\"px-4 py-3 space-y-3\">\n          <div className=\"relative\">\n            <Search className=\"absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-muted-foreground\" />\n            <Input\n              placeholder=\"Buscar no cardápio...\"\n              value={searchQuery}\n              onChange={(e) => handleSearchChange(e.target.value)}\n              className=\"pl-11 h-11 text-base rounded-full bg-muted border-0\"\n              data-testid=\"input-search-delivery\"\n            />\n          </div>\n\n          <div className=\"relative -mx-4 px-4\">\n            <Button\n              size=\"icon\"\n              variant=\"ghost\"\n              className=\"absolute left-0 top-1/2 -translate-y-1/2 z-10 h-8 w-8 bg-gradient-to-r from-background via-background to-transparent\"\n              onClick={() => scrollCategories('left')}\n              data-testid=\"button-scroll-categories-left\"\n            >\n              <ChevronLeft className=\"w-5 h-5\" />\n            </Button>\n\n            <div \n              ref={categoryScrollRef}\n              className=\"flex gap-2 overflow-x-auto scrollbar-hide px-6\"\n              style={{ scrollbarWidth: 'none', msOverflowStyle: 'none' }}\n            >\n              <Button\n                variant={selectedCategory === null ? \"default\" : \"ghost\"}\n                size=\"sm\"\n                className={`rounded-full whitespace-nowrap shrink-0 ${selectedCategory === null ? '' : 'bg-muted'}`}\n                onClick={() => handleCategoryChange(null)}\n                data-testid=\"button-category-all\"\n              >\n                Todos\n              </Button>\n              {parentCategories.map((cat) => (\n                <Button\n                  key={cat.id}\n                  variant={selectedCategory === cat.id ? \"default\" : \"ghost\"}\n                  size=\"sm\"\n                  className={`rounded-full whitespace-nowrap shrink-0 ${selectedCategory === cat.id ? '' : 'bg-muted'}`}\n                  onClick={() => handleCategoryChange(cat.id)}\n                  data-testid={`button-category-${cat.id}`}\n                >\n                  {cat.name}\n                </Button>\n              ))}\n            </div>\n\n            <Button\n              size=\"icon\"\n              variant=\"ghost\"\n              className=\"absolute right-0 top-1/2 -translate-y-1/2 z-10 h-8 w-8 bg-gradient-to-l from-background via-background to-transparent\"\n              onClick={() => scrollCategories('right')}\n              data-testid=\"button-scroll-categories-right\"\n            >\n              <ChevronRight className=\"w-5 h-5\" />\n            </Button>\n          </div>\n        </div>\n      </div>\n\n      <div className=\"px-4 py-4 space-y-6\">\n        {featuredProducts.length > 0 && !searchQuery && !selectedCategory && (\n          <section>\n            <div className=\"flex items-center gap-2 mb-3\">\n              <Star className=\"w-5 h-5 text-yellow-500 fill-yellow-500\" />\n              <h2 className=\"text-lg font-bold\">Mais Pedidos</h2>\n            </div>\n            <div className=\"space-y-3\">\n              {featuredProducts.slice(0, 5).map((product) => (\n                <ProductCard key={product.id} product={product} />\n              ))}\n            </div>\n          </section>\n        )}\n\n        <section>\n          <h2 className=\"text-lg font-bold mb-3\">\n            {selectedCategory \n              ? categories.find(c => c.id === selectedCategory)?.name || 'Produtos'\n              : searchQuery \n                ? `Resultados para \"${searchQuery}\"`\n                : 'Cardápio'\n            }\n          </h2>\n\n          {regularProducts.length === 0 && featuredProducts.length === 0 ? (\n            <div className=\"text-center py-12\">\n              <Package className=\"w-16 h-16 text-muted-foreground/30 mx-auto mb-4\" />\n              <p className=\"text-muted-foreground\">Nenhum produto encontrado</p>\n            </div>\n          ) : (\n            <div className=\"space-y-3\">\n              {(searchQuery || selectedCategory ? products : regularProducts).map((product) => (\n                <ProductCard key={product.id} product={product} />\n              ))}\n            </div>\n          )}\n\n          {totalPages > 1 && (\n            <div className=\"flex items-center justify-center gap-3 pt-6\">\n              <Button\n                variant=\"outline\"\n                size=\"sm\"\n                onClick={() => setPage(p => Math.max(1, p - 1))}\n                disabled={page === 1}\n                className=\"rounded-full\"\n                data-testid=\"button-prev-page\"\n              >\n                <ChevronLeft className=\"w-4 h-4\" />\n              </Button>\n              <span className=\"text-sm text-muted-foreground\">\n                {page} / {totalPages}\n              </span>\n              <Button\n                variant=\"outline\"\n                size=\"sm\"\n                onClick={() => setPage(p => Math.min(totalPages, p + 1))}\n                disabled={page === totalPages}\n                className=\"rounded-full\"\n                data-testid=\"button-next-page\"\n              >\n                <ChevronRight className=\"w-4 h-4\" />\n              </Button>\n            </div>\n          )}\n        </section>\n      </div>\n\n      {totalItems > 0 && (\n        <Link href={isPublic ? \"/guest-checkout\" : \"/cart\"}>\n          <div \n            className=\"fixed bottom-4 right-4 z-40 bg-primary text-primary-foreground rounded-full shadow-xl cursor-pointer transition-all hover:scale-105 active:scale-95\"\n            data-testid=\"button-view-cart\"\n          >\n            <div className=\"flex items-center gap-2 pl-4 pr-5 py-3\">\n              <div className=\"relative\">\n                <ShoppingCart className=\"w-6 h-6\" />\n                <span className=\"absolute -top-2 -right-2 bg-primary-foreground text-primary text-xs font-bold w-5 h-5 rounded-full flex items-center justify-center\">\n                  {totalItems}\n                </span>\n              </div>\n              <div className=\"flex flex-col\">\n                <span className=\"text-xs opacity-80\">Ver sacola</span>\n                <span className=\"text-sm font-bold\">{formatPrice(totalPrice)}</span>\n              </div>\n            </div>\n          </div>\n        </Link>\n      )}\n    </div>\n  );\n}\n","path":null,"size_bytes":14895,"size_tokens":null},"client/src/pages/contas-receber.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\nimport { useAuth } from \"@/contexts/AuthContext\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport type { User, CustomerCredit, CreditPayment } from \"@shared/schema\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Separator } from \"@/components/ui/separator\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter } from \"@/components/ui/dialog\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport {\n  Wallet,\n  Users,\n  TrendingUp,\n  TrendingDown,\n  Calendar,\n  Plus,\n  Search,\n  DollarSign,\n  AlertTriangle,\n  CheckCircle,\n  Clock,\n  User as UserIcon,\n  Building2,\n  CreditCard,\n  ArrowUpRight,\n  ArrowDownRight,\n  Loader2,\n  Calculator,\n  Receipt,\n  X,\n  ChevronRight,\n  Banknote\n} from \"lucide-react\";\nimport { format, formatDistanceToNow, differenceInDays } from \"date-fns\";\nimport { ptBR } from \"date-fns/locale\";\n\ninterface CreditsDashboard {\n  overview: {\n    totalInCirculation: number;\n    totalPending: number;\n    totalPaid: number;\n    totalOverdue: number;\n    customersWithDebt: number;\n    averageDebtPerCustomer: number;\n  };\n  customerSummaries: Array<{\n    userId: string;\n    userName: string;\n    company: string | null;\n    totalDebt: number;\n    paidAmount: number;\n    pendingAmount: number;\n    overdueAmount: number;\n    nextDueDate: Date | null;\n    creditCount: number;\n  }>;\n  upcomingPayments: Array<{\n    creditId: number;\n    userId: string;\n    userName: string;\n    company: string | null;\n    amount: number;\n    pendingAmount: number;\n    dueDate: Date;\n    daysUntilDue: number;\n    status: string;\n  }>;\n  overduePayments: Array<{\n    creditId: number;\n    userId: string;\n    userName: string;\n    company: string | null;\n    amount: number;\n    pendingAmount: number;\n    dueDate: Date;\n    daysUntilDue: number;\n    status: string;\n  }>;\n  recentPayments: Array<{\n    paymentId: number;\n    creditId: number;\n    userId: string;\n    userName: string;\n    amount: number;\n    paymentMethod: string | null;\n    createdAt: Date;\n  }>;\n}\n\nexport default function ContasReceberPage() {\n  const { isAdmin, isSales } = useAuth();\n  const { toast } = useToast();\n  const [activeTab, setActiveTab] = useState(\"dashboard\");\n  const [customerSearch, setCustomerSearch] = useState(\"\");\n  const [selectedCustomerId, setSelectedCustomerId] = useState<string | null>(null);\n  const [showNewDebtModal, setShowNewDebtModal] = useState(false);\n  const [showPaymentModal, setShowPaymentModal] = useState(false);\n  const [selectedCreditId, setSelectedCreditId] = useState<number | null>(null);\n\n  const showPage = isAdmin || isSales;\n\n  const { data: dashboard, isLoading: dashboardLoading } = useQuery<CreditsDashboard>({\n    queryKey: ['/api/credits/dashboard'],\n    enabled: showPage,\n  });\n\n  const { data: customersData = [] } = useQuery<User[]>({\n    queryKey: ['/api/users'],\n    enabled: showPage,\n  });\n\n  const { data: customerCreditsData } = useQuery<{ credits: CustomerCredit[]; balance: { total: number; pending: number; paid: number } }>({\n    queryKey: ['/api/credits/customer', selectedCustomerId],\n    enabled: !!selectedCustomerId,\n  });\n\n  const approvedCustomers = customersData.filter(u => u.approved && u.role === \"customer\");\n\n  const filteredCustomers = customerSearch.length > 0\n    ? approvedCustomers.filter(c =>\n        (c.firstName?.toLowerCase().includes(customerSearch.toLowerCase())) ||\n        (c.lastName?.toLowerCase().includes(customerSearch.toLowerCase())) ||\n        (c.company?.toLowerCase().includes(customerSearch.toLowerCase())) ||\n        (c.tradingName?.toLowerCase().includes(customerSearch.toLowerCase()))\n      )\n    : approvedCustomers;\n\n  const formatPrice = (value: number) => {\n    return new Intl.NumberFormat('pt-BR', {\n      style: 'currency',\n      currency: 'BRL'\n    }).format(value);\n  };\n\n  const formatDate = (date: Date | string) => {\n    return format(new Date(date), \"dd/MM/yyyy\", { locale: ptBR });\n  };\n\n  const getStatusBadge = (status: string) => {\n    switch (status) {\n      case 'PAGO':\n        return <Badge className=\"bg-green-500/20 text-green-600\">Pago</Badge>;\n      case 'PARCIAL':\n        return <Badge className=\"bg-yellow-500/20 text-yellow-600\">Parcial</Badge>;\n      case 'VENCIDO':\n        return <Badge className=\"bg-red-500/20 text-red-600\">Vencido</Badge>;\n      case 'PENDENTE':\n        return <Badge className=\"bg-blue-500/20 text-blue-600\">Pendente</Badge>;\n      case 'CANCELADO':\n        return <Badge variant=\"secondary\">Cancelado</Badge>;\n      default:\n        return <Badge variant=\"secondary\">{status}</Badge>;\n    }\n  };\n\n  if (!showPage) {\n    return (\n      <div className=\"flex items-center justify-center h-full\">\n        <p className=\"text-muted-foreground\">Acesso nao autorizado</p>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"h-full flex flex-col\">\n      <div className=\"border-b bg-card p-4\">\n        <div className=\"flex items-center justify-between gap-4 flex-wrap\">\n          <div className=\"flex items-center gap-3\">\n            <div className=\"h-10 w-10 rounded-lg bg-primary/10 flex items-center justify-center\">\n              <Wallet className=\"h-5 w-5 text-primary\" />\n            </div>\n            <div>\n              <h1 className=\"text-xl font-semibold\">Contas a Receber</h1>\n              <p className=\"text-sm text-muted-foreground\">Gerenciamento de credito de clientes</p>\n            </div>\n          </div>\n          <Button onClick={() => setShowNewDebtModal(true)} data-testid=\"button-new-debt\">\n            <Plus className=\"h-4 w-4 mr-2\" />\n            Novo Lancamento\n          </Button>\n        </div>\n      </div>\n\n      <Tabs value={activeTab} onValueChange={setActiveTab} className=\"flex-1 flex flex-col\">\n        <div className=\"border-b px-4\">\n          <TabsList className=\"bg-transparent h-12\">\n            <TabsTrigger value=\"dashboard\" className=\"gap-2\" data-testid=\"tab-fiado-dashboard\">\n              <TrendingUp className=\"h-4 w-4\" />\n              Visao Geral\n            </TabsTrigger>\n            <TabsTrigger value=\"customers\" className=\"gap-2\" data-testid=\"tab-fiado-customers\">\n              <Users className=\"h-4 w-4\" />\n              Por Cliente\n            </TabsTrigger>\n            <TabsTrigger value=\"upcoming\" className=\"gap-2\" data-testid=\"tab-fiado-upcoming\">\n              <Calendar className=\"h-4 w-4\" />\n              Vencimentos\n            </TabsTrigger>\n            <TabsTrigger value=\"calculator\" className=\"gap-2\" data-testid=\"tab-fiado-calculator\">\n              <Calculator className=\"h-4 w-4\" />\n              Calculadora\n            </TabsTrigger>\n          </TabsList>\n        </div>\n\n        <ScrollArea className=\"flex-1\">\n          <TabsContent value=\"dashboard\" className=\"m-0 p-4\">\n            {dashboardLoading ? (\n              <div className=\"flex items-center justify-center py-20\">\n                <Loader2 className=\"h-8 w-8 animate-spin text-muted-foreground\" />\n              </div>\n            ) : dashboard ? (\n              <div className=\"space-y-6\">\n                <div className=\"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4\">\n                  <Card>\n                    <CardContent className=\"pt-4\">\n                      <div className=\"flex items-center justify-between\">\n                        <div>\n                          <p className=\"text-sm text-muted-foreground\">Total na Rua</p>\n                          <p className=\"text-2xl font-bold text-primary\" data-testid=\"text-total-pending\">\n                            {formatPrice(dashboard.overview.totalPending)}\n                          </p>\n                        </div>\n                        <div className=\"h-10 w-10 rounded-lg bg-primary/10 flex items-center justify-center\">\n                          <Wallet className=\"h-5 w-5 text-primary\" />\n                        </div>\n                      </div>\n                    </CardContent>\n                  </Card>\n\n                  <Card>\n                    <CardContent className=\"pt-4\">\n                      <div className=\"flex items-center justify-between\">\n                        <div>\n                          <p className=\"text-sm text-muted-foreground\">Vencido</p>\n                          <p className=\"text-2xl font-bold text-red-600\" data-testid=\"text-total-overdue\">\n                            {formatPrice(dashboard.overview.totalOverdue)}\n                          </p>\n                        </div>\n                        <div className=\"h-10 w-10 rounded-lg bg-red-500/10 flex items-center justify-center\">\n                          <AlertTriangle className=\"h-5 w-5 text-red-500\" />\n                        </div>\n                      </div>\n                    </CardContent>\n                  </Card>\n\n                  <Card>\n                    <CardContent className=\"pt-4\">\n                      <div className=\"flex items-center justify-between\">\n                        <div>\n                          <p className=\"text-sm text-muted-foreground\">Total Recebido</p>\n                          <p className=\"text-2xl font-bold text-green-600\">\n                            {formatPrice(dashboard.overview.totalPaid)}\n                          </p>\n                        </div>\n                        <div className=\"h-10 w-10 rounded-lg bg-green-500/10 flex items-center justify-center\">\n                          <CheckCircle className=\"h-5 w-5 text-green-500\" />\n                        </div>\n                      </div>\n                    </CardContent>\n                  </Card>\n\n                  <Card>\n                    <CardContent className=\"pt-4\">\n                      <div className=\"flex items-center justify-between\">\n                        <div>\n                          <p className=\"text-sm text-muted-foreground\">Clientes com Divida</p>\n                          <p className=\"text-2xl font-bold\">{dashboard.overview.customersWithDebt}</p>\n                        </div>\n                        <div className=\"h-10 w-10 rounded-lg bg-muted flex items-center justify-center\">\n                          <Users className=\"h-5 w-5 text-muted-foreground\" />\n                        </div>\n                      </div>\n                    </CardContent>\n                  </Card>\n                </div>\n\n                <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\n                  <Card>\n                    <CardHeader className=\"pb-2\">\n                      <CardTitle className=\"text-base flex items-center gap-2\">\n                        <AlertTriangle className=\"h-4 w-4 text-red-500\" />\n                        Pagamentos Vencidos\n                      </CardTitle>\n                    </CardHeader>\n                    <CardContent>\n                      {dashboard.overduePayments.length === 0 ? (\n                        <p className=\"text-sm text-muted-foreground text-center py-4\">Nenhum pagamento vencido</p>\n                      ) : (\n                        <div className=\"space-y-3\">\n                          {dashboard.overduePayments.slice(0, 5).map((payment) => (\n                            <div key={payment.creditId} className=\"flex items-center justify-between p-3 rounded-lg bg-red-500/5\">\n                              <div className=\"flex items-center gap-3\">\n                                <div className=\"h-8 w-8 rounded-full bg-red-500/10 flex items-center justify-center\">\n                                  <UserIcon className=\"h-4 w-4 text-red-500\" />\n                                </div>\n                                <div>\n                                  <p className=\"font-medium text-sm\">{payment.userName}</p>\n                                  <p className=\"text-xs text-muted-foreground\">\n                                    Venceu {formatDistanceToNow(new Date(payment.dueDate), { addSuffix: true, locale: ptBR })}\n                                  </p>\n                                </div>\n                              </div>\n                              <div className=\"text-right\">\n                                <p className=\"font-semibold text-red-600\">{formatPrice(payment.pendingAmount)}</p>\n                                <Button\n                                  size=\"sm\"\n                                  variant=\"ghost\"\n                                  className=\"h-6 text-xs\"\n                                  onClick={() => {\n                                    setSelectedCreditId(payment.creditId);\n                                    setShowPaymentModal(true);\n                                  }}\n                                >\n                                  Receber\n                                </Button>\n                              </div>\n                            </div>\n                          ))}\n                        </div>\n                      )}\n                    </CardContent>\n                  </Card>\n\n                  <Card>\n                    <CardHeader className=\"pb-2\">\n                      <CardTitle className=\"text-base flex items-center gap-2\">\n                        <Clock className=\"h-4 w-4 text-yellow-500\" />\n                        Proximos Vencimentos\n                      </CardTitle>\n                    </CardHeader>\n                    <CardContent>\n                      {dashboard.upcomingPayments.length === 0 ? (\n                        <p className=\"text-sm text-muted-foreground text-center py-4\">Nenhum vencimento proximo</p>\n                      ) : (\n                        <div className=\"space-y-3\">\n                          {dashboard.upcomingPayments.slice(0, 5).map((payment) => (\n                            <div key={payment.creditId} className=\"flex items-center justify-between p-3 rounded-lg bg-muted/30\">\n                              <div className=\"flex items-center gap-3\">\n                                <div className=\"h-8 w-8 rounded-full bg-primary/10 flex items-center justify-center\">\n                                  <UserIcon className=\"h-4 w-4 text-primary\" />\n                                </div>\n                                <div>\n                                  <p className=\"font-medium text-sm\">{payment.userName}</p>\n                                  <p className=\"text-xs text-muted-foreground\">\n                                    Vence em {payment.daysUntilDue} dias ({formatDate(payment.dueDate)})\n                                  </p>\n                                </div>\n                              </div>\n                              <div className=\"text-right\">\n                                <p className=\"font-semibold\">{formatPrice(payment.pendingAmount)}</p>\n                                <Button\n                                  size=\"sm\"\n                                  variant=\"ghost\"\n                                  className=\"h-6 text-xs\"\n                                  onClick={() => {\n                                    setSelectedCreditId(payment.creditId);\n                                    setShowPaymentModal(true);\n                                  }}\n                                >\n                                  Receber\n                                </Button>\n                              </div>\n                            </div>\n                          ))}\n                        </div>\n                      )}\n                    </CardContent>\n                  </Card>\n                </div>\n\n                <Card>\n                  <CardHeader className=\"pb-2\">\n                    <CardTitle className=\"text-base flex items-center gap-2\">\n                      <Receipt className=\"h-4 w-4\" />\n                      Ultimos Pagamentos Recebidos\n                    </CardTitle>\n                  </CardHeader>\n                  <CardContent>\n                    {dashboard.recentPayments.length === 0 ? (\n                      <p className=\"text-sm text-muted-foreground text-center py-4\">Nenhum pagamento recente</p>\n                    ) : (\n                      <div className=\"space-y-2\">\n                        {dashboard.recentPayments.map((payment) => (\n                          <div key={payment.paymentId} className=\"flex items-center justify-between p-2 rounded-lg hover:bg-muted/30\">\n                            <div className=\"flex items-center gap-3\">\n                              <div className=\"h-8 w-8 rounded-full bg-green-500/10 flex items-center justify-center\">\n                                <ArrowDownRight className=\"h-4 w-4 text-green-500\" />\n                              </div>\n                              <div>\n                                <p className=\"font-medium text-sm\">{payment.userName}</p>\n                                <p className=\"text-xs text-muted-foreground\">\n                                  {payment.paymentMethod || 'Pagamento'} - {formatDate(payment.createdAt)}\n                                </p>\n                              </div>\n                            </div>\n                            <p className=\"font-semibold text-green-600\">+{formatPrice(payment.amount)}</p>\n                          </div>\n                        ))}\n                      </div>\n                    )}\n                  </CardContent>\n                </Card>\n\n                <Card>\n                  <CardHeader className=\"pb-2\">\n                    <CardTitle className=\"text-base flex items-center gap-2\">\n                      <Users className=\"h-4 w-4\" />\n                      Clientes com Maior Divida\n                    </CardTitle>\n                  </CardHeader>\n                  <CardContent>\n                    {dashboard.customerSummaries.length === 0 ? (\n                      <p className=\"text-sm text-muted-foreground text-center py-4\">Nenhum cliente com divida</p>\n                    ) : (\n                      <div className=\"space-y-2\">\n                        {dashboard.customerSummaries.slice(0, 10).map((customer) => (\n                          <div\n                            key={customer.userId}\n                            className=\"flex items-center justify-between p-3 rounded-lg hover:bg-muted/30 cursor-pointer\"\n                            onClick={() => {\n                              setSelectedCustomerId(customer.userId);\n                              setActiveTab(\"customers\");\n                            }}\n                          >\n                            <div className=\"flex items-center gap-3\">\n                              <div className=\"h-10 w-10 rounded-full bg-primary/10 flex items-center justify-center\">\n                                <UserIcon className=\"h-5 w-5 text-primary\" />\n                              </div>\n                              <div>\n                                <p className=\"font-medium\">{customer.userName}</p>\n                                {customer.company && (\n                                  <p className=\"text-xs text-muted-foreground flex items-center gap-1\">\n                                    <Building2 className=\"h-3 w-3\" />\n                                    {customer.company}\n                                  </p>\n                                )}\n                              </div>\n                            </div>\n                            <div className=\"text-right flex items-center gap-4\">\n                              <div>\n                                <p className=\"font-semibold text-primary\">{formatPrice(customer.pendingAmount)}</p>\n                                {customer.overdueAmount > 0 && (\n                                  <p className=\"text-xs text-red-500\">{formatPrice(customer.overdueAmount)} vencido</p>\n                                )}\n                              </div>\n                              <ChevronRight className=\"h-4 w-4 text-muted-foreground\" />\n                            </div>\n                          </div>\n                        ))}\n                      </div>\n                    )}\n                  </CardContent>\n                </Card>\n              </div>\n            ) : null}\n          </TabsContent>\n\n          <TabsContent value=\"customers\" className=\"m-0 p-4\">\n            <div className=\"grid grid-cols-1 lg:grid-cols-3 gap-4\">\n              <div className=\"lg:col-span-1\">\n                <Card className=\"h-fit\">\n                  <CardHeader className=\"pb-2\">\n                    <CardTitle className=\"text-base\">Clientes</CardTitle>\n                  </CardHeader>\n                  <CardContent>\n                    <div className=\"relative mb-4\">\n                      <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\n                      <Input\n                        placeholder=\"Buscar cliente...\"\n                        className=\"pl-10\"\n                        value={customerSearch}\n                        onChange={(e) => setCustomerSearch(e.target.value)}\n                        data-testid=\"input-fiado-customer-search\"\n                      />\n                    </div>\n                    <ScrollArea className=\"h-[400px]\">\n                      <div className=\"space-y-1\">\n                        {filteredCustomers.map((customer) => {\n                          const summary = dashboard?.customerSummaries.find(s => s.userId === customer.id);\n                          return (\n                            <div\n                              key={customer.id}\n                              className={`p-3 rounded-lg cursor-pointer transition-all ${\n                                selectedCustomerId === customer.id\n                                  ? 'bg-primary/10 ring-1 ring-primary'\n                                  : 'hover:bg-muted/50'\n                              }`}\n                              onClick={() => setSelectedCustomerId(customer.id)}\n                              data-testid={`card-fiado-customer-${customer.id}`}\n                            >\n                              <div className=\"flex items-center justify-between\">\n                                <div>\n                                  <p className=\"font-medium text-sm\">{customer.firstName} {customer.lastName}</p>\n                                  <p className=\"text-xs text-muted-foreground\">{customer.company || customer.tradingName}</p>\n                                </div>\n                                {summary && summary.pendingAmount > 0 && (\n                                  <Badge className={summary.overdueAmount > 0 ? 'bg-red-500/20 text-red-600' : 'bg-primary/20 text-primary'}>\n                                    {formatPrice(summary.pendingAmount)}\n                                  </Badge>\n                                )}\n                              </div>\n                            </div>\n                          );\n                        })}\n                      </div>\n                    </ScrollArea>\n                  </CardContent>\n                </Card>\n              </div>\n\n              <div className=\"lg:col-span-2\">\n                {selectedCustomerId ? (\n                  <CustomerCreditDetails\n                    customerId={selectedCustomerId}\n                    customer={customersData.find(c => c.id === selectedCustomerId)}\n                    creditsData={customerCreditsData}\n                    onPayment={(creditId) => {\n                      setSelectedCreditId(creditId);\n                      setShowPaymentModal(true);\n                    }}\n                    onNewDebt={() => setShowNewDebtModal(true)}\n                  />\n                ) : (\n                  <Card className=\"h-full flex items-center justify-center\">\n                    <div className=\"text-center py-20 text-muted-foreground\">\n                      <UserIcon className=\"h-12 w-12 mx-auto mb-3 opacity-30\" />\n                      <p>Selecione um cliente para ver detalhes</p>\n                    </div>\n                  </Card>\n                )}\n              </div>\n            </div>\n          </TabsContent>\n\n          <TabsContent value=\"upcoming\" className=\"m-0 p-4\">\n            <Card>\n              <CardHeader>\n                <CardTitle className=\"text-base\">Calendario de Vencimentos</CardTitle>\n              </CardHeader>\n              <CardContent>\n                {dashboard && (\n                  <div className=\"space-y-6\">\n                    {dashboard.overduePayments.length > 0 && (\n                      <div>\n                        <h3 className=\"font-semibold text-red-600 mb-3 flex items-center gap-2\">\n                          <AlertTriangle className=\"h-4 w-4\" />\n                          Vencidos ({dashboard.overduePayments.length})\n                        </h3>\n                        <div className=\"space-y-2\">\n                          {dashboard.overduePayments.map((payment) => (\n                            <div key={payment.creditId} className=\"flex items-center justify-between p-3 rounded-lg bg-red-500/5 border border-red-500/20\">\n                              <div className=\"flex items-center gap-3\">\n                                <div className=\"h-10 w-10 rounded-full bg-red-500/10 flex items-center justify-center\">\n                                  <UserIcon className=\"h-5 w-5 text-red-500\" />\n                                </div>\n                                <div>\n                                  <p className=\"font-medium\">{payment.userName}</p>\n                                  <p className=\"text-sm text-muted-foreground\">\n                                    Venceu em {formatDate(payment.dueDate)} ({Math.abs(payment.daysUntilDue)} dias)\n                                  </p>\n                                </div>\n                              </div>\n                              <div className=\"flex items-center gap-4\">\n                                <p className=\"font-semibold text-red-600\">{formatPrice(payment.pendingAmount)}</p>\n                                <Button\n                                  size=\"sm\"\n                                  onClick={() => {\n                                    setSelectedCreditId(payment.creditId);\n                                    setShowPaymentModal(true);\n                                  }}\n                                >\n                                  Receber\n                                </Button>\n                              </div>\n                            </div>\n                          ))}\n                        </div>\n                      </div>\n                    )}\n\n                    {dashboard.upcomingPayments.length > 0 && (\n                      <div>\n                        <h3 className=\"font-semibold mb-3 flex items-center gap-2\">\n                          <Clock className=\"h-4 w-4\" />\n                          Proximos Vencimentos ({dashboard.upcomingPayments.length})\n                        </h3>\n                        <div className=\"space-y-2\">\n                          {dashboard.upcomingPayments.map((payment) => (\n                            <div key={payment.creditId} className=\"flex items-center justify-between p-3 rounded-lg bg-muted/30\">\n                              <div className=\"flex items-center gap-3\">\n                                <div className=\"h-10 w-10 rounded-full bg-primary/10 flex items-center justify-center\">\n                                  <UserIcon className=\"h-5 w-5 text-primary\" />\n                                </div>\n                                <div>\n                                  <p className=\"font-medium\">{payment.userName}</p>\n                                  <p className=\"text-sm text-muted-foreground\">\n                                    Vence em {formatDate(payment.dueDate)} ({payment.daysUntilDue} dias)\n                                  </p>\n                                </div>\n                              </div>\n                              <div className=\"flex items-center gap-4\">\n                                <p className=\"font-semibold\">{formatPrice(payment.pendingAmount)}</p>\n                                <Button\n                                  size=\"sm\"\n                                  variant=\"outline\"\n                                  onClick={() => {\n                                    setSelectedCreditId(payment.creditId);\n                                    setShowPaymentModal(true);\n                                  }}\n                                >\n                                  Receber\n                                </Button>\n                              </div>\n                            </div>\n                          ))}\n                        </div>\n                      </div>\n                    )}\n\n                    {dashboard.overduePayments.length === 0 && dashboard.upcomingPayments.length === 0 && (\n                      <div className=\"text-center py-12 text-muted-foreground\">\n                        <Calendar className=\"h-12 w-12 mx-auto mb-3 opacity-30\" />\n                        <p>Nenhum vencimento pendente</p>\n                      </div>\n                    )}\n                  </div>\n                )}\n              </CardContent>\n            </Card>\n          </TabsContent>\n\n          <TabsContent value=\"calculator\" className=\"m-0 p-4\">\n            <DebtCalculator />\n          </TabsContent>\n        </ScrollArea>\n      </Tabs>\n\n      <NewDebtModal\n        open={showNewDebtModal}\n        onClose={() => setShowNewDebtModal(false)}\n        customers={approvedCustomers}\n        preselectedCustomerId={selectedCustomerId}\n      />\n\n      <PaymentModal\n        open={showPaymentModal}\n        onClose={() => {\n          setShowPaymentModal(false);\n          setSelectedCreditId(null);\n        }}\n        creditId={selectedCreditId}\n      />\n    </div>\n  );\n}\n\nfunction CustomerCreditDetails({\n  customerId,\n  customer,\n  creditsData,\n  onPayment,\n  onNewDebt\n}: {\n  customerId: string;\n  customer?: User;\n  creditsData?: { credits: CustomerCredit[]; balance: { total: number; pending: number; paid: number } };\n  onPayment: (creditId: number) => void;\n  onNewDebt: () => void;\n}) {\n  const formatPrice = (value: number) => {\n    return new Intl.NumberFormat('pt-BR', {\n      style: 'currency',\n      currency: 'BRL'\n    }).format(value);\n  };\n\n  const formatDate = (date: Date | string) => {\n    return format(new Date(date), \"dd/MM/yyyy\", { locale: ptBR });\n  };\n\n  const getStatusBadge = (status: string) => {\n    switch (status) {\n      case 'PAGO':\n        return <Badge className=\"bg-green-500/20 text-green-600\">Pago</Badge>;\n      case 'PARCIAL':\n        return <Badge className=\"bg-yellow-500/20 text-yellow-600\">Parcial</Badge>;\n      case 'VENCIDO':\n        return <Badge className=\"bg-red-500/20 text-red-600\">Vencido</Badge>;\n      case 'PENDENTE':\n        return <Badge className=\"bg-blue-500/20 text-blue-600\">Pendente</Badge>;\n      default:\n        return <Badge variant=\"secondary\">{status}</Badge>;\n    }\n  };\n\n  if (!customer || !creditsData) {\n    return (\n      <Card className=\"h-full flex items-center justify-center\">\n        <Loader2 className=\"h-8 w-8 animate-spin text-muted-foreground\" />\n      </Card>\n    );\n  }\n\n  return (\n    <Card>\n      <CardHeader>\n        <div className=\"flex items-center justify-between\">\n          <div className=\"flex items-center gap-3\">\n            <div className=\"h-12 w-12 rounded-full bg-primary/10 flex items-center justify-center\">\n              <UserIcon className=\"h-6 w-6 text-primary\" />\n            </div>\n            <div>\n              <CardTitle className=\"text-lg\">{customer.firstName} {customer.lastName}</CardTitle>\n              <p className=\"text-sm text-muted-foreground\">{customer.company || customer.tradingName}</p>\n            </div>\n          </div>\n          <Button onClick={onNewDebt} size=\"sm\">\n            <Plus className=\"h-4 w-4 mr-2\" />\n            Novo Lancamento\n          </Button>\n        </div>\n      </CardHeader>\n      <CardContent>\n        <div className=\"grid grid-cols-3 gap-4 mb-6\">\n          <div className=\"text-center p-4 rounded-lg bg-muted/30\">\n            <p className=\"text-sm text-muted-foreground\">Total</p>\n            <p className=\"text-xl font-bold\">{formatPrice(creditsData.balance.total)}</p>\n          </div>\n          <div className=\"text-center p-4 rounded-lg bg-green-500/10\">\n            <p className=\"text-sm text-muted-foreground\">Pago</p>\n            <p className=\"text-xl font-bold text-green-600\">{formatPrice(creditsData.balance.paid)}</p>\n          </div>\n          <div className=\"text-center p-4 rounded-lg bg-primary/10\">\n            <p className=\"text-sm text-muted-foreground\">Pendente</p>\n            <p className=\"text-xl font-bold text-primary\">{formatPrice(creditsData.balance.pending)}</p>\n          </div>\n        </div>\n\n        <Separator className=\"my-4\" />\n\n        <h4 className=\"font-semibold mb-3\">Historico de Lancamentos</h4>\n        <ScrollArea className=\"h-[300px]\">\n          {creditsData.credits.length === 0 ? (\n            <div className=\"text-center py-8 text-muted-foreground\">\n              <Receipt className=\"h-10 w-10 mx-auto mb-2 opacity-30\" />\n              <p className=\"text-sm\">Nenhum lancamento encontrado</p>\n            </div>\n          ) : (\n            <div className=\"space-y-3\">\n              {creditsData.credits.map((credit) => {\n                const amount = parseFloat(credit.amount);\n                const paidAmount = parseFloat(credit.paidAmount);\n                const pendingAmount = amount - paidAmount;\n                const isOverdue = credit.dueDate && new Date(credit.dueDate) < new Date() && credit.status !== 'PAGO';\n\n                return (\n                  <div\n                    key={credit.id}\n                    className={`p-4 rounded-lg border ${isOverdue ? 'border-red-500/30 bg-red-500/5' : 'bg-muted/30'}`}\n                  >\n                    <div className=\"flex items-start justify-between mb-2\">\n                      <div className=\"flex items-center gap-2\">\n                        {credit.type === 'DEBITO' ? (\n                          <ArrowUpRight className=\"h-4 w-4 text-red-500\" />\n                        ) : (\n                          <ArrowDownRight className=\"h-4 w-4 text-green-500\" />\n                        )}\n                        <span className=\"font-medium\">\n                          {credit.type === 'DEBITO' ? 'Debito' : 'Credito'}\n                        </span>\n                        {getStatusBadge(isOverdue ? 'VENCIDO' : credit.status)}\n                      </div>\n                      <p className={`font-bold ${credit.type === 'DEBITO' ? 'text-red-600' : 'text-green-600'}`}>\n                        {credit.type === 'DEBITO' ? '-' : '+'}{formatPrice(amount)}\n                      </p>\n                    </div>\n\n                    {credit.description && (\n                      <p className=\"text-sm text-muted-foreground mb-2\">{credit.description}</p>\n                    )}\n\n                    <div className=\"flex items-center justify-between text-xs text-muted-foreground\">\n                      <div className=\"flex items-center gap-4\">\n                        <span>Criado: {formatDate(credit.createdAt)}</span>\n                        {credit.dueDate && (\n                          <span className={isOverdue ? 'text-red-500' : ''}>\n                            Vence: {formatDate(credit.dueDate)}\n                          </span>\n                        )}\n                      </div>\n                      {credit.type === 'DEBITO' && credit.status !== 'PAGO' && pendingAmount > 0 && (\n                        <Button\n                          size=\"sm\"\n                          variant=\"outline\"\n                          className=\"h-7\"\n                          onClick={() => onPayment(credit.id)}\n                        >\n                          <Banknote className=\"h-3 w-3 mr-1\" />\n                          Receber {formatPrice(pendingAmount)}\n                        </Button>\n                      )}\n                    </div>\n\n                    {credit.type === 'DEBITO' && paidAmount > 0 && (\n                      <div className=\"mt-2 pt-2 border-t text-xs\">\n                        <p className=\"text-muted-foreground\">\n                          Pago: {formatPrice(paidAmount)} de {formatPrice(amount)}\n                        </p>\n                        <div className=\"w-full bg-muted rounded-full h-1.5 mt-1\">\n                          <div\n                            className=\"bg-green-500 h-1.5 rounded-full\"\n                            style={{ width: `${(paidAmount / amount) * 100}%` }}\n                          />\n                        </div>\n                      </div>\n                    )}\n                  </div>\n                );\n              })}\n            </div>\n          )}\n        </ScrollArea>\n      </CardContent>\n    </Card>\n  );\n}\n\nfunction NewDebtModal({\n  open,\n  onClose,\n  customers,\n  preselectedCustomerId\n}: {\n  open: boolean;\n  onClose: () => void;\n  customers: User[];\n  preselectedCustomerId: string | null;\n}) {\n  const { toast } = useToast();\n  const [selectedCustomer, setSelectedCustomer] = useState<string>(preselectedCustomerId || \"\");\n  const [type, setType] = useState<string>(\"DEBITO\");\n  const [amount, setAmount] = useState<string>(\"\");\n  const [description, setDescription] = useState<string>(\"\");\n  const [dueDate, setDueDate] = useState<string>(\"\");\n\n  const createMutation = useMutation({\n    mutationFn: async (data: { userId: string; type: string; amount: string; description?: string; dueDate?: string }) => {\n      await apiRequest(\"POST\", \"/api/credits\", data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/credits'] });\n      queryClient.invalidateQueries({ queryKey: ['/api/credits/dashboard'] });\n      toast({ title: \"Sucesso\", description: \"Lancamento criado com sucesso\" });\n      onClose();\n      resetForm();\n    },\n    onError: (error: Error) => {\n      toast({ title: \"Erro\", description: error.message, variant: \"destructive\" });\n    }\n  });\n\n  const resetForm = () => {\n    setSelectedCustomer(\"\");\n    setType(\"DEBITO\");\n    setAmount(\"\");\n    setDescription(\"\");\n    setDueDate(\"\");\n  };\n\n  const handleSubmit = () => {\n    if (!selectedCustomer || !amount) {\n      toast({ title: \"Erro\", description: \"Preencha todos os campos obrigatorios\", variant: \"destructive\" });\n      return;\n    }\n    createMutation.mutate({\n      userId: selectedCustomer,\n      type,\n      amount,\n      description: description || undefined,\n      dueDate: dueDate || undefined\n    });\n  };\n\n  return (\n    <Dialog open={open} onOpenChange={onClose}>\n      <DialogContent className=\"max-w-md\">\n        <DialogHeader>\n          <DialogTitle className=\"flex items-center gap-2\">\n            <Plus className=\"h-5 w-5\" />\n            Novo Lancamento de Fiado\n          </DialogTitle>\n        </DialogHeader>\n\n        <div className=\"space-y-4\">\n          <div>\n            <Label>Cliente *</Label>\n            <Select value={selectedCustomer} onValueChange={setSelectedCustomer}>\n              <SelectTrigger data-testid=\"select-new-debt-customer\">\n                <SelectValue placeholder=\"Selecione um cliente\" />\n              </SelectTrigger>\n              <SelectContent>\n                {customers.map((customer) => (\n                  <SelectItem key={customer.id} value={customer.id}>\n                    {customer.firstName} {customer.lastName} {customer.company && `(${customer.company})`}\n                  </SelectItem>\n                ))}\n              </SelectContent>\n            </Select>\n          </div>\n\n          <div>\n            <Label>Tipo *</Label>\n            <Select value={type} onValueChange={setType}>\n              <SelectTrigger data-testid=\"select-new-debt-type\">\n                <SelectValue />\n              </SelectTrigger>\n              <SelectContent>\n                <SelectItem value=\"DEBITO\">Debito (Compra no Fiado)</SelectItem>\n                <SelectItem value=\"CREDITO\">Credito (Ajuste/Devolucao)</SelectItem>\n              </SelectContent>\n            </Select>\n          </div>\n\n          <div>\n            <Label>Valor (R$) *</Label>\n            <Input\n              type=\"number\"\n              step=\"0.01\"\n              min=\"0\"\n              placeholder=\"0,00\"\n              value={amount}\n              onChange={(e) => setAmount(e.target.value)}\n              data-testid=\"input-new-debt-amount\"\n            />\n          </div>\n\n          <div>\n            <Label>Data de Vencimento</Label>\n            <Input\n              type=\"date\"\n              value={dueDate}\n              onChange={(e) => setDueDate(e.target.value)}\n              data-testid=\"input-new-debt-duedate\"\n            />\n          </div>\n\n          <div>\n            <Label>Descricao</Label>\n            <Textarea\n              placeholder=\"Descricao do lancamento...\"\n              value={description}\n              onChange={(e) => setDescription(e.target.value)}\n              data-testid=\"input-new-debt-description\"\n            />\n          </div>\n        </div>\n\n        <DialogFooter>\n          <Button variant=\"outline\" onClick={onClose}>Cancelar</Button>\n          <Button onClick={handleSubmit} disabled={createMutation.isPending}>\n            {createMutation.isPending && <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />}\n            Criar Lancamento\n          </Button>\n        </DialogFooter>\n      </DialogContent>\n    </Dialog>\n  );\n}\n\nfunction PaymentModal({\n  open,\n  onClose,\n  creditId\n}: {\n  open: boolean;\n  onClose: () => void;\n  creditId: number | null;\n}) {\n  const { toast } = useToast();\n  const [amount, setAmount] = useState<string>(\"\");\n  const [paymentMethod, setPaymentMethod] = useState<string>(\"\");\n  const [notes, setNotes] = useState<string>(\"\");\n\n  const { data: creditData } = useQuery<{ credit: CustomerCredit; payments: CreditPayment[] }>({\n    queryKey: ['/api/credits', creditId],\n    enabled: !!creditId,\n  });\n\n  const paymentMutation = useMutation({\n    mutationFn: async (data: { amount: string; paymentMethod?: string; notes?: string }) => {\n      await apiRequest(\"POST\", `/api/credits/${creditId}/payments`, data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/credits'] });\n      queryClient.invalidateQueries({ queryKey: ['/api/credits/dashboard'] });\n      toast({ title: \"Sucesso\", description: \"Pagamento registrado com sucesso\" });\n      onClose();\n      resetForm();\n    },\n    onError: (error: Error) => {\n      toast({ title: \"Erro\", description: error.message, variant: \"destructive\" });\n    }\n  });\n\n  const resetForm = () => {\n    setAmount(\"\");\n    setPaymentMethod(\"\");\n    setNotes(\"\");\n  };\n\n  const handleSubmit = () => {\n    if (!amount || parseFloat(amount) <= 0) {\n      toast({ title: \"Erro\", description: \"Informe um valor valido\", variant: \"destructive\" });\n      return;\n    }\n    paymentMutation.mutate({\n      amount,\n      paymentMethod: paymentMethod || undefined,\n      notes: notes || undefined\n    });\n  };\n\n  const pendingAmount = creditData\n    ? parseFloat(creditData.credit.amount) - parseFloat(creditData.credit.paidAmount)\n    : 0;\n\n  const formatPrice = (value: number) => {\n    return new Intl.NumberFormat('pt-BR', {\n      style: 'currency',\n      currency: 'BRL'\n    }).format(value);\n  };\n\n  return (\n    <Dialog open={open} onOpenChange={onClose}>\n      <DialogContent className=\"max-w-md\">\n        <DialogHeader>\n          <DialogTitle className=\"flex items-center gap-2\">\n            <Banknote className=\"h-5 w-5\" />\n            Registrar Pagamento\n          </DialogTitle>\n        </DialogHeader>\n\n        {creditData && (\n          <div className=\"space-y-4\">\n            <div className=\"p-4 rounded-lg bg-muted/30\">\n              <div className=\"flex justify-between mb-2\">\n                <span className=\"text-sm text-muted-foreground\">Valor Total:</span>\n                <span className=\"font-medium\">{formatPrice(parseFloat(creditData.credit.amount))}</span>\n              </div>\n              <div className=\"flex justify-between mb-2\">\n                <span className=\"text-sm text-muted-foreground\">Ja Pago:</span>\n                <span className=\"font-medium text-green-600\">{formatPrice(parseFloat(creditData.credit.paidAmount))}</span>\n              </div>\n              <Separator className=\"my-2\" />\n              <div className=\"flex justify-between\">\n                <span className=\"text-sm font-medium\">Restante:</span>\n                <span className=\"font-bold text-primary\">{formatPrice(pendingAmount)}</span>\n              </div>\n            </div>\n\n            <div>\n              <Label>Valor do Pagamento (R$) *</Label>\n              <Input\n                type=\"number\"\n                step=\"0.01\"\n                min=\"0\"\n                max={pendingAmount}\n                placeholder=\"0,00\"\n                value={amount}\n                onChange={(e) => setAmount(e.target.value)}\n                data-testid=\"input-payment-amount\"\n              />\n              <Button\n                variant=\"link\"\n                className=\"h-auto p-0 text-xs\"\n                onClick={() => setAmount(pendingAmount.toFixed(2))}\n              >\n                Preencher valor total ({formatPrice(pendingAmount)})\n              </Button>\n            </div>\n\n            <div>\n              <Label>Forma de Pagamento</Label>\n              <Select value={paymentMethod} onValueChange={setPaymentMethod}>\n                <SelectTrigger data-testid=\"select-payment-method\">\n                  <SelectValue placeholder=\"Selecione\" />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"PIX\">PIX</SelectItem>\n                  <SelectItem value=\"DINHEIRO\">Dinheiro</SelectItem>\n                  <SelectItem value=\"CARTAO\">Cartao</SelectItem>\n                  <SelectItem value=\"BOLETO\">Boleto</SelectItem>\n                  <SelectItem value=\"TRANSFERENCIA\">Transferencia</SelectItem>\n                </SelectContent>\n              </Select>\n            </div>\n\n            <div>\n              <Label>Observacoes</Label>\n              <Textarea\n                placeholder=\"Observacoes do pagamento...\"\n                value={notes}\n                onChange={(e) => setNotes(e.target.value)}\n                data-testid=\"input-payment-notes\"\n              />\n            </div>\n          </div>\n        )}\n\n        <DialogFooter>\n          <Button variant=\"outline\" onClick={onClose}>Cancelar</Button>\n          <Button onClick={handleSubmit} disabled={paymentMutation.isPending}>\n            {paymentMutation.isPending && <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />}\n            Registrar Pagamento\n          </Button>\n        </DialogFooter>\n      </DialogContent>\n    </Dialog>\n  );\n}\n\nfunction DebtCalculator() {\n  const [principal, setPrincipal] = useState<string>(\"\");\n  const [interestRate, setInterestRate] = useState<string>(\"2\");\n  const [days, setDays] = useState<string>(\"30\");\n  const [interestType, setInterestType] = useState<string>(\"simple\");\n\n  const calculate = () => {\n    const p = parseFloat(principal) || 0;\n    const r = parseFloat(interestRate) / 100;\n    const d = parseInt(days) || 0;\n    const months = d / 30;\n\n    if (interestType === \"simple\") {\n      return p * (1 + r * months);\n    } else {\n      return p * Math.pow(1 + r, months);\n    }\n  };\n\n  const formatPrice = (value: number) => {\n    return new Intl.NumberFormat('pt-BR', {\n      style: 'currency',\n      currency: 'BRL'\n    }).format(value);\n  };\n\n  const totalAmount = calculate();\n  const interestAmount = totalAmount - (parseFloat(principal) || 0);\n\n  return (\n    <div className=\"max-w-md mx-auto\">\n      <Card>\n        <CardHeader>\n          <CardTitle className=\"flex items-center gap-2\">\n            <Calculator className=\"h-5 w-5\" />\n            Calculadora de Juros\n          </CardTitle>\n        </CardHeader>\n        <CardContent className=\"space-y-4\">\n          <div>\n            <Label>Valor Principal (R$)</Label>\n            <Input\n              type=\"number\"\n              step=\"0.01\"\n              placeholder=\"1000,00\"\n              value={principal}\n              onChange={(e) => setPrincipal(e.target.value)}\n              data-testid=\"input-calc-principal\"\n            />\n          </div>\n\n          <div>\n            <Label>Taxa de Juros (% ao mes)</Label>\n            <Input\n              type=\"number\"\n              step=\"0.1\"\n              placeholder=\"2\"\n              value={interestRate}\n              onChange={(e) => setInterestRate(e.target.value)}\n              data-testid=\"input-calc-rate\"\n            />\n          </div>\n\n          <div>\n            <Label>Dias em Atraso</Label>\n            <Input\n              type=\"number\"\n              placeholder=\"30\"\n              value={days}\n              onChange={(e) => setDays(e.target.value)}\n              data-testid=\"input-calc-days\"\n            />\n          </div>\n\n          <div>\n            <Label>Tipo de Juros</Label>\n            <Select value={interestType} onValueChange={setInterestType}>\n              <SelectTrigger data-testid=\"select-calc-type\">\n                <SelectValue />\n              </SelectTrigger>\n              <SelectContent>\n                <SelectItem value=\"simple\">Juros Simples</SelectItem>\n                <SelectItem value=\"compound\">Juros Compostos</SelectItem>\n              </SelectContent>\n            </Select>\n          </div>\n\n          <Separator />\n\n          <div className=\"p-4 rounded-lg bg-muted/50 space-y-2\">\n            <div className=\"flex justify-between\">\n              <span className=\"text-muted-foreground\">Valor Principal:</span>\n              <span>{formatPrice(parseFloat(principal) || 0)}</span>\n            </div>\n            <div className=\"flex justify-between\">\n              <span className=\"text-muted-foreground\">Juros:</span>\n              <span className=\"text-red-600\">+{formatPrice(interestAmount)}</span>\n            </div>\n            <Separator />\n            <div className=\"flex justify-between text-lg font-bold\">\n              <span>Total a Receber:</span>\n              <span className=\"text-primary\" data-testid=\"text-calc-total\">{formatPrice(totalAmount)}</span>\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","path":null,"size_bytes":50905,"size_tokens":null},"client/src/pages/pdv.tsx":{"content":"import { useState, useRef } from \"react\";\nimport { useLocation } from \"wouter\";\nimport { useAuth } from \"@/contexts/AuthContext\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\nimport type { Product, User, Category } from \"@shared/schema\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Separator } from \"@/components/ui/separator\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter } from \"@/components/ui/dialog\";\nimport { \n  Search, \n  Plus, \n  Minus, \n  Trash2, \n  X, \n  User as UserIcon,\n  ShoppingCart,\n  Package,\n  ArrowLeft,\n  Loader2,\n  FileText,\n  CheckCircle,\n  Building2,\n  Mail,\n  Phone,\n  Printer,\n  Download,\n  Share2,\n  RotateCcw\n} from \"lucide-react\";\n\ninterface CartItem {\n  productId: number;\n  product: Product;\n  quantity: number;\n  discount: number;\n  unitPrice: number;\n  subtotal: number;\n}\n\ninterface QuoteResult {\n  id: number;\n  orderNumber: string;\n  total: number;\n  itemCount: number;\n  customer: string;\n}\n\nexport default function PDVPage() {\n  const [, setLocation] = useLocation();\n  const { user, isAdmin, isSales } = useAuth();\n  const { toast } = useToast();\n  \n  const [productSearch, setProductSearch] = useState(\"\");\n  const [selectedCategory, setSelectedCategory] = useState<string>(\"all\");\n  const [customerSearch, setCustomerSearch] = useState(\"\");\n  const [selectedCustomer, setSelectedCustomer] = useState<User | null>(null);\n  const [cartItems, setCartItems] = useState<CartItem[]>([]);\n  const [comment, setComment] = useState(\"\");\n  const [addedProductId, setAddedProductId] = useState<number | null>(null);\n  const [showCustomerModal, setShowCustomerModal] = useState(false);\n  const [showSuccessModal, setShowSuccessModal] = useState(false);\n  const [quoteResult, setQuoteResult] = useState<QuoteResult | null>(null);\n  const searchInputRef = useRef<HTMLInputElement>(null);\n\n  const showPDV = isAdmin || isSales;\n\n  const { data: productsResponse, isLoading: productsLoading } = useQuery<{ products: Product[]; total: number }>({\n    queryKey: ['/api/products'],\n    enabled: showPDV,\n  });\n\n  const { data: customersData = [], isLoading: customersLoading } = useQuery<User[]>({\n    queryKey: ['/api/users'],\n    enabled: showPDV,\n  });\n\n  const { data: categoriesData = [] } = useQuery<Category[]>({\n    queryKey: ['/api/categories'],\n    enabled: showPDV,\n  });\n\n  const productsData = productsResponse?.products || [];\n  const approvedCustomers = customersData.filter(u => u.approved && u.role === \"customer\");\n\n  const filteredProducts = productsData.filter(p => {\n    const matchesSearch = productSearch.length === 0 || \n      p.name.toLowerCase().includes(productSearch.toLowerCase()) ||\n      p.sku.toLowerCase().includes(productSearch.toLowerCase());\n    const matchesCategory = selectedCategory === \"all\" || p.categoryId === parseInt(selectedCategory);\n    return matchesSearch && matchesCategory;\n  }).slice(0, 24);\n\n  const filteredCustomers = customerSearch.length > 0 \n    ? approvedCustomers.filter(c => \n        (c.firstName?.toLowerCase().includes(customerSearch.toLowerCase())) ||\n        (c.lastName?.toLowerCase().includes(customerSearch.toLowerCase())) ||\n        (c.company?.toLowerCase().includes(customerSearch.toLowerCase())) ||\n        (c.email?.toLowerCase().includes(customerSearch.toLowerCase())) ||\n        (c.tradingName?.toLowerCase().includes(customerSearch.toLowerCase()))\n      ).slice(0, 10)\n    : approvedCustomers.slice(0, 10);\n\n  const createOrderMutation = useMutation({\n    mutationFn: async (data: { \n      userId: string; \n      items: { productId: number; quantity: number; unitPrice: number; discount: number }[]; \n      notes?: string;\n      subtotal: number;\n      total: number;\n    }) => {\n      const res = await apiRequest(\"POST\", \"/api/orders\", data);\n      return res.json();\n    },\n    onSuccess: (data) => {\n      queryClient.invalidateQueries({ queryKey: ['/api/orders'] });\n      setQuoteResult({\n        id: data.id,\n        orderNumber: data.orderNumber || `#${data.id}`,\n        total: cartTotal,\n        itemCount: cartItemCount,\n        customer: selectedCustomer ? `${selectedCustomer.firstName} ${selectedCustomer.lastName}` : ''\n      });\n      setShowSuccessModal(true);\n    },\n    onError: (error: Error) => {\n      toast({ title: \"Erro\", description: error.message || \"Falha ao gerar orçamento\", variant: \"destructive\" });\n    },\n  });\n\n  const resetPDV = () => {\n    setCartItems([]);\n    setSelectedCustomer(null);\n    setComment(\"\");\n    setProductSearch(\"\");\n    setSelectedCategory(\"all\");\n    setCustomerSearch(\"\");\n    setQuoteResult(null);\n    setShowSuccessModal(false);\n  };\n\n  const formatPrice = (price: number) => {\n    return new Intl.NumberFormat('pt-BR', {\n      style: 'currency',\n      currency: 'BRL'\n    }).format(price);\n  };\n\n  const handleQuickAddToCart = (product: Product) => {\n    const unitPrice = parseFloat(product.price);\n    const existingIndex = cartItems.findIndex(item => item.productId === product.id);\n    \n    if (existingIndex >= 0) {\n      const newItems = [...cartItems];\n      newItems[existingIndex].quantity += 1;\n      newItems[existingIndex].subtotal = unitPrice * newItems[existingIndex].quantity;\n      setCartItems(newItems);\n    } else {\n      setCartItems([...cartItems, {\n        productId: product.id,\n        product: product,\n        quantity: 1,\n        discount: 0,\n        unitPrice,\n        subtotal: unitPrice\n      }]);\n    }\n    setAddedProductId(product.id);\n    setTimeout(() => setAddedProductId(null), 400);\n  };\n\n  const handleRemoveFromCart = (index: number) => {\n    setCartItems(cartItems.filter((_, i) => i !== index));\n  };\n\n  const handleUpdateQuantity = (index: number, newQuantity: number) => {\n    if (newQuantity < 1) {\n      handleRemoveFromCart(index);\n      return;\n    }\n    const newItems = [...cartItems];\n    newItems[index].quantity = newQuantity;\n    const unitPrice = newItems[index].unitPrice;\n    const discountAmount = (unitPrice * newItems[index].discount) / 100;\n    newItems[index].subtotal = (unitPrice - discountAmount) * newQuantity;\n    setCartItems(newItems);\n  };\n\n  const cartTotal = cartItems.reduce((sum, item) => sum + item.subtotal, 0);\n  const cartItemCount = cartItems.reduce((sum, item) => sum + item.quantity, 0);\n\n  const handleSelectCustomer = (customer: User) => {\n    setSelectedCustomer(customer);\n    setShowCustomerModal(false);\n    setCustomerSearch(\"\");\n  };\n\n  const handleGenerateQuote = () => {\n    if (!selectedCustomer) {\n      toast({ title: \"Selecione um cliente\", description: \"Clique no botão 'Selecionar Cliente' para continuar\", variant: \"destructive\" });\n      setShowCustomerModal(true);\n      return;\n    }\n    if (cartItems.length === 0) {\n      toast({ title: \"Carrinho vazio\", description: \"Adicione produtos ao carrinho\", variant: \"destructive\" });\n      return;\n    }\n\n    createOrderMutation.mutate({\n      userId: selectedCustomer.id,\n      items: cartItems.map(item => ({ \n        productId: item.productId, \n        quantity: item.quantity,\n        unitPrice: item.unitPrice,\n        discount: item.discount\n      })),\n      notes: comment || undefined,\n      subtotal: cartTotal,\n      total: cartTotal\n    });\n  };\n\n  const getProductImage = (product: Product) => {\n    if (product.image) return product.image;\n    if (product.images && product.images.length > 0) return product.images[0];\n    return null;\n  };\n\n  if (!showPDV) {\n    return (\n      <div className=\"flex items-center justify-center h-full\">\n        <p className=\"text-muted-foreground\">Acesso nao autorizado</p>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"h-full flex flex-col bg-background\">\n      <div className=\"border-b bg-card\">\n        <div className=\"flex items-center justify-between gap-4 p-4\">\n          <div className=\"flex items-center gap-3\">\n            <Button variant=\"ghost\" size=\"icon\" onClick={() => setLocation(\"/orders\")} data-testid=\"button-back-pdv\">\n              <ArrowLeft className=\"h-5 w-5\" />\n            </Button>\n            <div>\n              <h1 className=\"text-xl font-semibold\">PDV</h1>\n              <p className=\"text-xs text-muted-foreground\">Ponto de Venda</p>\n            </div>\n          </div>\n          \n          <div className=\"flex items-center gap-3\">\n            <Button\n              variant={selectedCustomer ? \"secondary\" : \"outline\"}\n              onClick={() => setShowCustomerModal(true)}\n              className=\"gap-2\"\n              data-testid=\"button-select-customer\"\n            >\n              <UserIcon className=\"h-4 w-4\" />\n              {selectedCustomer ? (\n                <span className=\"max-w-[150px] truncate\">\n                  {selectedCustomer.firstName} {selectedCustomer.lastName}\n                </span>\n              ) : (\n                \"Selecionar Cliente\"\n              )}\n            </Button>\n            \n            {selectedCustomer && (\n              <Button \n                variant=\"ghost\" \n                size=\"icon\"\n                onClick={() => setSelectedCustomer(null)}\n                data-testid=\"button-clear-customer\"\n              >\n                <X className=\"h-4 w-4\" />\n              </Button>\n            )}\n          </div>\n        </div>\n      </div>\n\n      <div className=\"flex-1 flex overflow-hidden\">\n        <div className=\"flex-1 flex flex-col min-w-0\">\n          <div className=\"p-4 border-b bg-card/50\">\n            <div className=\"flex gap-3\">\n              <div className=\"relative flex-1\">\n                <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\n                <Input\n                  ref={searchInputRef}\n                  placeholder=\"Buscar produto por nome ou SKU...\"\n                  className=\"pl-10\"\n                  value={productSearch}\n                  onChange={(e) => setProductSearch(e.target.value)}\n                  data-testid=\"input-pdv-product-search\"\n                />\n              </div>\n              <Select value={selectedCategory} onValueChange={setSelectedCategory}>\n                <SelectTrigger className=\"w-44\" data-testid=\"select-pdv-category\">\n                  <SelectValue placeholder=\"Categoria\" />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"all\">Todas</SelectItem>\n                  {categoriesData.map((cat) => (\n                    <SelectItem key={cat.id} value={cat.id.toString()}>\n                      {cat.name}\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n          </div>\n\n          <ScrollArea className=\"flex-1\">\n            <div className=\"p-4\">\n              {productsLoading ? (\n                <div className=\"flex items-center justify-center py-20\">\n                  <Loader2 className=\"h-8 w-8 animate-spin text-muted-foreground\" />\n                </div>\n              ) : filteredProducts.length === 0 ? (\n                <div className=\"text-center py-20 text-muted-foreground\">\n                  <Package className=\"h-12 w-12 mx-auto mb-3 opacity-40\" />\n                  <p className=\"font-medium\">Nenhum produto encontrado</p>\n                  <p className=\"text-sm\">Tente buscar por outro termo</p>\n                </div>\n              ) : (\n                <div className=\"grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-3\">\n                  {filteredProducts.map((product) => {\n                    const inCart = cartItems.find(item => item.productId === product.id);\n                    const imageUrl = getProductImage(product);\n                    \n                    return (\n                      <Card \n                        key={product.id} \n                        className={`hover-elevate cursor-pointer relative transition-all ${inCart ? 'ring-2 ring-primary/50' : ''}`}\n                        onClick={() => handleQuickAddToCart(product)}\n                        data-testid={`card-pdv-product-${product.id}`}\n                      >\n                        <CardContent className=\"p-2\">\n                          <div className=\"relative\">\n                            {addedProductId === product.id && (\n                              <div className=\"absolute inset-0 z-20 flex items-center justify-center bg-primary/90 rounded-md animate-in fade-in zoom-in duration-150\">\n                                <span className=\"text-primary-foreground font-bold text-lg\">+1</span>\n                              </div>\n                            )}\n                            {inCart && (\n                              <Badge className=\"absolute top-1 right-1 z-10 bg-primary text-primary-foreground\">\n                                {inCart.quantity}\n                              </Badge>\n                            )}\n                            <div className=\"aspect-square bg-muted rounded-md mb-2 flex items-center justify-center overflow-hidden\">\n                              {imageUrl ? (\n                                <img \n                                  src={imageUrl} \n                                  alt={product.name}\n                                  className=\"w-full h-full object-cover\"\n                                  loading=\"lazy\"\n                                />\n                              ) : (\n                                <Package className=\"h-8 w-8 text-muted-foreground/40\" />\n                              )}\n                            </div>\n                          </div>\n                          <p className=\"font-medium text-xs leading-tight line-clamp-2 min-h-[32px]\">{product.name}</p>\n                          <p className=\"text-[10px] text-muted-foreground mt-0.5\">{product.sku}</p>\n                          <p className=\"font-semibold text-primary text-sm mt-1\">{formatPrice(parseFloat(product.price))}</p>\n                        </CardContent>\n                      </Card>\n                    );\n                  })}\n                </div>\n              )}\n            </div>\n          </ScrollArea>\n        </div>\n\n        <div className=\"w-80 lg:w-96 flex flex-col border-l bg-card\">\n          <div className=\"p-4 border-b\">\n            <div className=\"flex items-center justify-between\">\n              <h2 className=\"font-semibold flex items-center gap-2\">\n                <ShoppingCart className=\"h-5 w-5 text-primary\" />\n                Carrinho\n              </h2>\n              {cartItemCount > 0 && (\n                <Badge variant=\"secondary\">{cartItemCount} {cartItemCount === 1 ? 'item' : 'itens'}</Badge>\n              )}\n            </div>\n          </div>\n\n          <ScrollArea className=\"flex-1\">\n            <div className=\"p-3\">\n              {cartItems.length === 0 ? (\n                <div className=\"text-center py-16 text-muted-foreground\">\n                  <ShoppingCart className=\"h-12 w-12 mx-auto mb-3 opacity-20\" />\n                  <p className=\"text-sm\">Carrinho vazio</p>\n                  <p className=\"text-xs mt-1\">Clique nos produtos para adicionar</p>\n                </div>\n              ) : (\n                <div className=\"space-y-2\">\n                  {cartItems.map((item, index) => {\n                    const imageUrl = getProductImage(item.product);\n                    \n                    return (\n                      <div \n                        key={index} \n                        className=\"flex items-center gap-3 p-2 rounded-lg bg-muted/30\"\n                        data-testid={`card-pdv-cart-item-${index}`}\n                      >\n                        <div className=\"w-10 h-10 bg-muted rounded flex items-center justify-center overflow-hidden flex-shrink-0\">\n                          {imageUrl ? (\n                            <img \n                              src={imageUrl} \n                              alt={item.product.name}\n                              className=\"w-full h-full object-cover\"\n                            />\n                          ) : (\n                            <Package className=\"h-4 w-4 text-muted-foreground\" />\n                          )}\n                        </div>\n                        \n                        <div className=\"flex-1 min-w-0\">\n                          <p className=\"font-medium text-xs truncate\">{item.product.name}</p>\n                          <p className=\"text-xs text-muted-foreground\">{formatPrice(item.unitPrice)}</p>\n                        </div>\n                        \n                        <div className=\"flex items-center gap-1\">\n                          <Button \n                            variant=\"outline\" \n                            size=\"icon\" \n                            className=\"h-6 w-6\"\n                            onClick={() => handleUpdateQuantity(index, item.quantity - 1)}\n                            data-testid={`button-pdv-cart-minus-${index}`}\n                          >\n                            <Minus className=\"h-3 w-3\" />\n                          </Button>\n                          <span className=\"w-6 text-center text-sm font-medium\">{item.quantity}</span>\n                          <Button \n                            variant=\"outline\" \n                            size=\"icon\" \n                            className=\"h-6 w-6\"\n                            onClick={() => handleUpdateQuantity(index, item.quantity + 1)}\n                            data-testid={`button-pdv-cart-plus-${index}`}\n                          >\n                            <Plus className=\"h-3 w-3\" />\n                          </Button>\n                        </div>\n                        \n                        <div className=\"text-right min-w-[70px]\">\n                          <p className=\"font-semibold text-sm\">{formatPrice(item.subtotal)}</p>\n                        </div>\n                        \n                        <Button \n                          variant=\"ghost\" \n                          size=\"icon\" \n                          className=\"h-6 w-6 text-muted-foreground hover:text-destructive\"\n                          onClick={() => handleRemoveFromCart(index)}\n                          data-testid={`button-pdv-remove-item-${index}`}\n                        >\n                          <Trash2 className=\"h-3 w-3\" />\n                        </Button>\n                      </div>\n                    );\n                  })}\n                </div>\n              )}\n            </div>\n          </ScrollArea>\n\n          {cartItems.length > 0 && (\n            <div className=\"p-4 border-t space-y-3\">\n              <Textarea\n                placeholder=\"Observacoes do pedido...\"\n                value={comment}\n                onChange={(e) => setComment(e.target.value)}\n                className=\"min-h-[60px] text-sm resize-none\"\n                data-testid=\"input-pdv-comment\"\n              />\n              \n              <Separator />\n              \n              <div className=\"space-y-1\">\n                <div className=\"flex justify-between text-sm\">\n                  <span className=\"text-muted-foreground\">Subtotal</span>\n                  <span>{formatPrice(cartTotal)}</span>\n                </div>\n                <div className=\"flex justify-between text-lg font-bold\">\n                  <span>Total</span>\n                  <span className=\"text-primary\" data-testid=\"text-pdv-total\">{formatPrice(cartTotal)}</span>\n                </div>\n              </div>\n              \n              <div className=\"flex gap-2\">\n                <Button\n                  variant=\"outline\"\n                  className=\"flex-1\"\n                  onClick={resetPDV}\n                  data-testid=\"button-pdv-clear\"\n                >\n                  <Trash2 className=\"h-4 w-4 mr-2\" />\n                  Limpar\n                </Button>\n                <Button\n                  className=\"flex-1\"\n                  onClick={handleGenerateQuote}\n                  disabled={createOrderMutation.isPending}\n                  data-testid=\"button-pdv-generate-quote\"\n                >\n                  {createOrderMutation.isPending ? (\n                    <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />\n                  ) : (\n                    <FileText className=\"h-4 w-4 mr-2\" />\n                  )}\n                  Gerar Orcamento\n                </Button>\n              </div>\n            </div>\n          )}\n        </div>\n      </div>\n\n      <Dialog open={showCustomerModal} onOpenChange={setShowCustomerModal}>\n        <DialogContent className=\"max-w-lg\">\n          <DialogHeader>\n            <DialogTitle className=\"flex items-center gap-2\">\n              <UserIcon className=\"h-5 w-5\" />\n              Selecionar Cliente\n            </DialogTitle>\n          </DialogHeader>\n          \n          <div className=\"space-y-4\">\n            <div className=\"relative\">\n              <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\n              <Input\n                placeholder=\"Buscar por nome, empresa ou email...\"\n                className=\"pl-10\"\n                value={customerSearch}\n                onChange={(e) => setCustomerSearch(e.target.value)}\n                data-testid=\"input-pdv-customer-search\"\n              />\n            </div>\n            \n            <ScrollArea className=\"h-[300px]\">\n              {customersLoading ? (\n                <div className=\"flex items-center justify-center py-12\">\n                  <Loader2 className=\"h-6 w-6 animate-spin text-muted-foreground\" />\n                </div>\n              ) : filteredCustomers.length === 0 ? (\n                <div className=\"text-center py-12 text-muted-foreground\">\n                  <UserIcon className=\"h-10 w-10 mx-auto mb-2 opacity-40\" />\n                  <p className=\"text-sm\">Nenhum cliente encontrado</p>\n                </div>\n              ) : (\n                <div className=\"space-y-2\">\n                  {filteredCustomers.map((customer) => (\n                    <div\n                      key={customer.id}\n                      className={`p-3 rounded-lg cursor-pointer hover-elevate transition-all ${\n                        selectedCustomer?.id === customer.id ? 'bg-primary/10 ring-1 ring-primary' : 'bg-muted/30'\n                      }`}\n                      onClick={() => handleSelectCustomer(customer)}\n                      data-testid={`card-pdv-customer-${customer.id}`}\n                    >\n                      <div className=\"flex items-start gap-3\">\n                        <div className=\"h-10 w-10 rounded-full bg-primary/10 flex items-center justify-center flex-shrink-0\">\n                          <UserIcon className=\"h-5 w-5 text-primary\" />\n                        </div>\n                        <div className=\"flex-1 min-w-0\">\n                          <p className=\"font-medium\">{customer.firstName} {customer.lastName}</p>\n                          {(customer.company || customer.tradingName) && (\n                            <p className=\"text-sm text-muted-foreground flex items-center gap-1\">\n                              <Building2 className=\"h-3 w-3\" />\n                              {customer.company || customer.tradingName}\n                            </p>\n                          )}\n                          {customer.email && (\n                            <p className=\"text-xs text-muted-foreground flex items-center gap-1\">\n                              <Mail className=\"h-3 w-3\" />\n                              {customer.email}\n                            </p>\n                          )}\n                        </div>\n                        {selectedCustomer?.id === customer.id && (\n                          <CheckCircle className=\"h-5 w-5 text-primary flex-shrink-0\" />\n                        )}\n                      </div>\n                    </div>\n                  ))}\n                </div>\n              )}\n            </ScrollArea>\n          </div>\n        </DialogContent>\n      </Dialog>\n\n      <Dialog open={showSuccessModal} onOpenChange={setShowSuccessModal}>\n        <DialogContent className=\"max-w-md text-center\">\n          <div className=\"py-6\">\n            <div className=\"w-16 h-16 rounded-full bg-green-100 dark:bg-green-900/30 flex items-center justify-center mx-auto mb-4\">\n              <CheckCircle className=\"h-8 w-8 text-green-600 dark:text-green-400\" />\n            </div>\n            <h2 className=\"text-xl font-semibold mb-2\">Orcamento Gerado!</h2>\n            <p className=\"text-muted-foreground text-sm mb-4\">\n              Orcamento {quoteResult?.orderNumber} criado com sucesso\n            </p>\n            \n            <div className=\"bg-muted/50 rounded-lg p-4 mb-6 text-left\">\n              <div className=\"flex justify-between text-sm mb-2\">\n                <span className=\"text-muted-foreground\">Cliente</span>\n                <span className=\"font-medium\">{quoteResult?.customer}</span>\n              </div>\n              <div className=\"flex justify-between text-sm mb-2\">\n                <span className=\"text-muted-foreground\">Itens</span>\n                <span className=\"font-medium\">{quoteResult?.itemCount}</span>\n              </div>\n              <Separator className=\"my-2\" />\n              <div className=\"flex justify-between\">\n                <span className=\"font-medium\">Total</span>\n                <span className=\"font-bold text-primary text-lg\">{quoteResult && formatPrice(quoteResult.total)}</span>\n              </div>\n            </div>\n            \n            <div className=\"flex gap-2 mb-4\">\n              <Button variant=\"outline\" className=\"flex-1\" disabled>\n                <Printer className=\"h-4 w-4 mr-2\" />\n                Imprimir\n              </Button>\n              <Button variant=\"outline\" className=\"flex-1\" disabled>\n                <Download className=\"h-4 w-4 mr-2\" />\n                PDF\n              </Button>\n              <Button variant=\"outline\" className=\"flex-1\" disabled>\n                <Share2 className=\"h-4 w-4 mr-2\" />\n                Enviar\n              </Button>\n            </div>\n          </div>\n          \n          <DialogFooter className=\"flex-col sm:flex-row gap-2\">\n            <Button \n              variant=\"outline\" \n              onClick={() => setLocation(\"/orders\")}\n              className=\"w-full sm:w-auto\"\n            >\n              Ver Pedidos\n            </Button>\n            <Button \n              onClick={resetPDV}\n              className=\"w-full sm:w-auto\"\n              data-testid=\"button-pdv-new-quote\"\n            >\n              <RotateCcw className=\"h-4 w-4 mr-2\" />\n              Novo Orcamento\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n","path":null,"size_bytes":27251,"size_tokens":null},"client/src/pages/suppliers.tsx":{"content":"import { useState } from \"react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from \"@/components/ui/table\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger, DialogFooter, DialogClose } from \"@/components/ui/dialog\";\nimport {\n  Form,\n  FormControl,\n  FormField,\n  FormItem,\n  FormLabel,\n  FormMessage,\n} from \"@/components/ui/form\";\nimport { Switch } from \"@/components/ui/switch\";\nimport { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { z } from \"zod\";\nimport { Plus, Search, Pencil, Trash2, Loader2, Building2, Phone, Mail, MapPin } from \"lucide-react\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\nimport type { Supplier } from \"@shared/schema\";\n\nconst supplierSchema = z.object({\n  name: z.string().min(1, \"Nome e obrigatorio\"),\n  tradingName: z.string().optional(),\n  cnpj: z.string().optional(),\n  email: z.string().email(\"Email invalido\").optional().or(z.literal(\"\")),\n  phone: z.string().optional(),\n  contact: z.string().optional(),\n  cep: z.string().optional(),\n  address: z.string().optional(),\n  addressNumber: z.string().optional(),\n  complement: z.string().optional(),\n  neighborhood: z.string().optional(),\n  city: z.string().optional(),\n  state: z.string().optional(),\n  notes: z.string().optional(),\n  active: z.boolean().default(true),\n});\n\ntype SupplierFormValues = z.infer<typeof supplierSchema>;\n\nexport default function SuppliersPage() {\n  const { toast } = useToast();\n  const [searchQuery, setSearchQuery] = useState(\"\");\n  const [isDialogOpen, setIsDialogOpen] = useState(false);\n  const [editingSupplier, setEditingSupplier] = useState<Supplier | null>(null);\n\n  const form = useForm<SupplierFormValues>({\n    resolver: zodResolver(supplierSchema),\n    defaultValues: {\n      name: \"\",\n      tradingName: \"\",\n      cnpj: \"\",\n      email: \"\",\n      phone: \"\",\n      contact: \"\",\n      cep: \"\",\n      address: \"\",\n      addressNumber: \"\",\n      complement: \"\",\n      neighborhood: \"\",\n      city: \"\",\n      state: \"\",\n      notes: \"\",\n      active: true,\n    },\n  });\n\n  const { data: suppliers = [], isLoading } = useQuery<Supplier[]>({\n    queryKey: ['/api/suppliers'],\n  });\n\n  const createMutation = useMutation({\n    mutationFn: async (data: SupplierFormValues) => {\n      const payload = {\n        name: data.name,\n        tradingName: data.tradingName || null,\n        cnpj: data.cnpj || null,\n        email: data.email || null,\n        phone: data.phone || null,\n        contact: data.contact || null,\n        cep: data.cep || null,\n        address: data.address || null,\n        addressNumber: data.addressNumber || null,\n        complement: data.complement || null,\n        neighborhood: data.neighborhood || null,\n        city: data.city || null,\n        state: data.state || null,\n        notes: data.notes || null,\n        active: data.active,\n      };\n      await apiRequest(\"POST\", \"/api/suppliers\", payload);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/suppliers'] });\n      toast({ title: \"Sucesso\", description: \"Fornecedor criado com sucesso\" });\n      setIsDialogOpen(false);\n      form.reset();\n    },\n    onError: () => {\n      toast({ title: \"Erro\", description: \"Falha ao criar fornecedor\", variant: \"destructive\" });\n    },\n  });\n\n  const updateMutation = useMutation({\n    mutationFn: async ({ id, data }: { id: number; data: SupplierFormValues }) => {\n      const payload = {\n        name: data.name,\n        tradingName: data.tradingName || null,\n        cnpj: data.cnpj || null,\n        email: data.email || null,\n        phone: data.phone || null,\n        contact: data.contact || null,\n        cep: data.cep || null,\n        address: data.address || null,\n        addressNumber: data.addressNumber || null,\n        complement: data.complement || null,\n        neighborhood: data.neighborhood || null,\n        city: data.city || null,\n        state: data.state || null,\n        notes: data.notes || null,\n        active: data.active,\n      };\n      await apiRequest(\"PATCH\", `/api/suppliers/${id}`, payload);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/suppliers'] });\n      toast({ title: \"Sucesso\", description: \"Fornecedor atualizado com sucesso\" });\n      setIsDialogOpen(false);\n      setEditingSupplier(null);\n      form.reset();\n    },\n    onError: () => {\n      toast({ title: \"Erro\", description: \"Falha ao atualizar fornecedor\", variant: \"destructive\" });\n    },\n  });\n\n  const deleteMutation = useMutation({\n    mutationFn: async (id: number) => {\n      await apiRequest(\"DELETE\", `/api/suppliers/${id}`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/suppliers'] });\n      toast({ title: \"Sucesso\", description: \"Fornecedor excluido com sucesso\" });\n    },\n    onError: () => {\n      toast({ title: \"Erro\", description: \"Falha ao excluir fornecedor\", variant: \"destructive\" });\n    },\n  });\n\n  const isPending = createMutation.isPending || updateMutation.isPending;\n\n  const onSubmit = (data: SupplierFormValues) => {\n    if (editingSupplier) {\n      updateMutation.mutate({ id: editingSupplier.id, data });\n    } else {\n      createMutation.mutate(data);\n    }\n  };\n\n  const openEditDialog = (supplier: Supplier) => {\n    setEditingSupplier(supplier);\n    form.reset({\n      name: supplier.name,\n      tradingName: supplier.tradingName || \"\",\n      cnpj: supplier.cnpj || \"\",\n      email: supplier.email || \"\",\n      phone: supplier.phone || \"\",\n      contact: supplier.contact || \"\",\n      cep: supplier.cep || \"\",\n      address: supplier.address || \"\",\n      addressNumber: supplier.addressNumber || \"\",\n      complement: supplier.complement || \"\",\n      neighborhood: supplier.neighborhood || \"\",\n      city: supplier.city || \"\",\n      state: supplier.state || \"\",\n      notes: supplier.notes || \"\",\n      active: supplier.active ?? true,\n    });\n    setIsDialogOpen(true);\n  };\n\n  const openAddDialog = () => {\n    setEditingSupplier(null);\n    form.reset({\n      name: \"\",\n      tradingName: \"\",\n      cnpj: \"\",\n      email: \"\",\n      phone: \"\",\n      contact: \"\",\n      cep: \"\",\n      address: \"\",\n      addressNumber: \"\",\n      complement: \"\",\n      neighborhood: \"\",\n      city: \"\",\n      state: \"\",\n      notes: \"\",\n      active: true,\n    });\n    setIsDialogOpen(true);\n  };\n\n  const filteredSuppliers = suppliers.filter(supplier =>\n    supplier.name.toLowerCase().includes(searchQuery.toLowerCase()) ||\n    (supplier.cnpj && supplier.cnpj.includes(searchQuery)) ||\n    (supplier.tradingName && supplier.tradingName.toLowerCase().includes(searchQuery.toLowerCase()))\n  );\n\n  return (\n    <div className=\"p-6 lg:p-8 space-y-6\">\n      <div className=\"flex items-center justify-between gap-4 flex-wrap\">\n        <div>\n          <h1 className=\"text-2xl font-bold\">Fornecedores</h1>\n          <p className=\"text-muted-foreground\">Gerencie seus fornecedores e contatos</p>\n        </div>\n        <Dialog open={isDialogOpen} onOpenChange={setIsDialogOpen}>\n          <DialogTrigger asChild>\n            <Button \n              onClick={openAddDialog}\n              className=\"bg-orange-500 hover:bg-orange-600\"\n              data-testid=\"button-add-supplier\"\n            >\n              <Plus className=\"h-4 w-4 mr-2\" />\n              Novo Fornecedor\n            </Button>\n          </DialogTrigger>\n          <DialogContent className=\"max-w-2xl max-h-[90vh] overflow-y-auto\">\n            <DialogHeader>\n              <DialogTitle>\n                {editingSupplier ? \"Editar Fornecedor\" : \"Novo Fornecedor\"}\n              </DialogTitle>\n            </DialogHeader>\n            <Form {...form}>\n              <form onSubmit={form.handleSubmit(onSubmit)} className=\"space-y-4\">\n                <div className=\"grid grid-cols-2 gap-4\">\n                  <FormField\n                    control={form.control}\n                    name=\"name\"\n                    render={({ field }) => (\n                      <FormItem className=\"col-span-2\">\n                        <FormLabel>Nome *</FormLabel>\n                        <FormControl>\n                          <Input \n                            {...field} \n                            placeholder=\"Nome do fornecedor\"\n                            data-testid=\"input-supplier-name\" \n                          />\n                        </FormControl>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n                  <FormField\n                    control={form.control}\n                    name=\"tradingName\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Nome Fantasia</FormLabel>\n                        <FormControl>\n                          <Input \n                            {...field} \n                            placeholder=\"Nome fantasia\"\n                            data-testid=\"input-supplier-trading-name\" \n                          />\n                        </FormControl>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n                  <FormField\n                    control={form.control}\n                    name=\"cnpj\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>CNPJ</FormLabel>\n                        <FormControl>\n                          <Input \n                            {...field} \n                            placeholder=\"00.000.000/0000-00\"\n                            data-testid=\"input-supplier-cnpj\" \n                          />\n                        </FormControl>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n                  <FormField\n                    control={form.control}\n                    name=\"email\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Email</FormLabel>\n                        <FormControl>\n                          <Input \n                            {...field} \n                            type=\"email\"\n                            placeholder=\"email@exemplo.com\"\n                            data-testid=\"input-supplier-email\" \n                          />\n                        </FormControl>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n                  <FormField\n                    control={form.control}\n                    name=\"phone\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Telefone</FormLabel>\n                        <FormControl>\n                          <Input \n                            {...field} \n                            placeholder=\"(00) 00000-0000\"\n                            data-testid=\"input-supplier-phone\" \n                          />\n                        </FormControl>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n                  <FormField\n                    control={form.control}\n                    name=\"contact\"\n                    render={({ field }) => (\n                      <FormItem className=\"col-span-2\">\n                        <FormLabel>Nome do Contato</FormLabel>\n                        <FormControl>\n                          <Input \n                            {...field} \n                            placeholder=\"Pessoa de contato\"\n                            data-testid=\"input-supplier-contact\" \n                          />\n                        </FormControl>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n                </div>\n\n                <div className=\"border-t pt-4 mt-4\">\n                  <h4 className=\"font-medium mb-3\">Endereco</h4>\n                  <div className=\"grid grid-cols-2 gap-4\">\n                    <FormField\n                      control={form.control}\n                      name=\"address\"\n                      render={({ field }) => (\n                        <FormItem className=\"col-span-2\">\n                          <FormLabel>Endereco</FormLabel>\n                          <FormControl>\n                            <Input \n                              {...field} \n                              placeholder=\"Rua, numero, complemento\"\n                              data-testid=\"input-supplier-address\" \n                            />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n                    <FormField\n                      control={form.control}\n                      name=\"city\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Cidade</FormLabel>\n                          <FormControl>\n                            <Input \n                              {...field} \n                              placeholder=\"Cidade\"\n                              data-testid=\"input-supplier-city\" \n                            />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n                    <FormField\n                      control={form.control}\n                      name=\"state\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Estado</FormLabel>\n                          <FormControl>\n                            <Input \n                              {...field} \n                              placeholder=\"UF\"\n                              maxLength={2}\n                              data-testid=\"input-supplier-state\" \n                            />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n                    <FormField\n                      control={form.control}\n                      name=\"cep\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>CEP</FormLabel>\n                          <FormControl>\n                            <Input \n                              {...field} \n                              placeholder=\"00000-000\"\n                              data-testid=\"input-supplier-cep\" \n                            />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n                  </div>\n                </div>\n\n                <FormField\n                  control={form.control}\n                  name=\"notes\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Observacoes</FormLabel>\n                      <FormControl>\n                        <Textarea \n                          {...field} \n                          placeholder=\"Observacoes adicionais sobre o fornecedor\"\n                          rows={3}\n                          data-testid=\"input-supplier-notes\" \n                        />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                <FormField\n                  control={form.control}\n                  name=\"active\"\n                  render={({ field }) => (\n                    <FormItem className=\"flex items-center justify-between rounded-lg border p-3\">\n                      <div className=\"space-y-0.5\">\n                        <FormLabel>Ativo</FormLabel>\n                        <p className=\"text-sm text-muted-foreground\">\n                          Fornecedores inativos nao aparecem nas listagens\n                        </p>\n                      </div>\n                      <FormControl>\n                        <Switch\n                          checked={field.value}\n                          onCheckedChange={field.onChange}\n                          data-testid=\"switch-supplier-active\"\n                        />\n                      </FormControl>\n                    </FormItem>\n                  )}\n                />\n\n                <DialogFooter>\n                  <DialogClose asChild>\n                    <Button type=\"button\" variant=\"outline\">Cancelar</Button>\n                  </DialogClose>\n                  <Button \n                    type=\"submit\" \n                    disabled={isPending}\n                    className=\"bg-orange-500 hover:bg-orange-600\"\n                    data-testid=\"button-save-supplier\"\n                  >\n                    {isPending && <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />}\n                    {editingSupplier ? \"Salvar\" : \"Criar\"}\n                  </Button>\n                </DialogFooter>\n              </form>\n            </Form>\n          </DialogContent>\n        </Dialog>\n      </div>\n\n      <div className=\"flex items-center gap-4\">\n        <div className=\"relative flex-1 max-w-md\">\n          <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\n          <Input\n            placeholder=\"Buscar por nome, CNPJ ou codigo...\"\n            value={searchQuery}\n            onChange={(e) => setSearchQuery(e.target.value)}\n            className=\"pl-10\"\n            data-testid=\"input-search-suppliers\"\n          />\n        </div>\n      </div>\n\n      <Card>\n        <CardHeader className=\"flex flex-row items-center justify-between gap-4 pb-4\">\n          <CardTitle className=\"text-base\">Lista de Fornecedores</CardTitle>\n          <Badge variant=\"secondary\">{filteredSuppliers.length} fornecedores</Badge>\n        </CardHeader>\n        <CardContent>\n          {isLoading ? (\n            <div className=\"flex items-center justify-center py-8\">\n              <Loader2 className=\"h-8 w-8 animate-spin text-muted-foreground\" />\n            </div>\n          ) : filteredSuppliers.length === 0 ? (\n            <div className=\"text-center py-8\">\n              <Building2 className=\"h-12 w-12 mx-auto text-muted-foreground mb-4\" />\n              <p className=\"text-muted-foreground\">\n                {searchQuery ? \"Nenhum fornecedor encontrado\" : \"Nenhum fornecedor cadastrado\"}\n              </p>\n            </div>\n          ) : (\n            <Table>\n              <TableHeader>\n                <TableRow>\n                  <TableHead>Fornecedor</TableHead>\n                  <TableHead>CNPJ</TableHead>\n                  <TableHead>Contato</TableHead>\n                  <TableHead>Cidade/UF</TableHead>\n                  <TableHead>Status</TableHead>\n                  <TableHead className=\"text-right\">Acoes</TableHead>\n                </TableRow>\n              </TableHeader>\n              <TableBody>\n                {filteredSuppliers.map((supplier) => (\n                  <TableRow key={supplier.id} data-testid={`row-supplier-${supplier.id}`}>\n                    <TableCell>\n                      <div>\n                        <div className=\"font-medium\">{supplier.name}</div>\n                        {supplier.tradingName && (\n                          <div className=\"text-sm text-muted-foreground\">{supplier.tradingName}</div>\n                        )}\n                      </div>\n                    </TableCell>\n                    <TableCell className=\"text-muted-foreground\">\n                      {supplier.cnpj || \"-\"}\n                    </TableCell>\n                    <TableCell>\n                      <div className=\"space-y-1\">\n                        {supplier.email && (\n                          <div className=\"flex items-center gap-1 text-sm\">\n                            <Mail className=\"h-3 w-3\" />\n                            {supplier.email}\n                          </div>\n                        )}\n                        {supplier.phone && (\n                          <div className=\"flex items-center gap-1 text-sm text-muted-foreground\">\n                            <Phone className=\"h-3 w-3\" />\n                            {supplier.phone}\n                          </div>\n                        )}\n                        {!supplier.email && !supplier.phone && \"-\"}\n                      </div>\n                    </TableCell>\n                    <TableCell>\n                      {supplier.city || supplier.state ? (\n                        <div className=\"flex items-center gap-1 text-sm\">\n                          <MapPin className=\"h-3 w-3\" />\n                          {[supplier.city, supplier.state].filter(Boolean).join(\"/\")}\n                        </div>\n                      ) : \"-\"}\n                    </TableCell>\n                    <TableCell>\n                      <Badge variant={supplier.active ? \"default\" : \"secondary\"}>\n                        {supplier.active ? \"Ativo\" : \"Inativo\"}\n                      </Badge>\n                    </TableCell>\n                    <TableCell className=\"text-right\">\n                      <div className=\"flex items-center justify-end gap-2\">\n                        <Button\n                          size=\"icon\"\n                          variant=\"ghost\"\n                          onClick={() => openEditDialog(supplier)}\n                          data-testid={`button-edit-supplier-${supplier.id}`}\n                        >\n                          <Pencil className=\"h-4 w-4\" />\n                        </Button>\n                        <Button\n                          size=\"icon\"\n                          variant=\"ghost\"\n                          onClick={() => {\n                            if (confirm(\"Deseja realmente excluir este fornecedor?\")) {\n                              deleteMutation.mutate(supplier.id);\n                            }\n                          }}\n                          data-testid={`button-delete-supplier-${supplier.id}`}\n                        >\n                          <Trash2 className=\"h-4 w-4\" />\n                        </Button>\n                      </div>\n                    </TableCell>\n                  </TableRow>\n                ))}\n              </TableBody>\n            </Table>\n          )}\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","path":null,"size_bytes":22964,"size_tokens":null},"client/src/components/CustomerMap.tsx":{"content":"import { useEffect, useRef, useState } from \"react\";\nimport L from \"leaflet\";\nimport \"leaflet/dist/leaflet.css\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { MapPin, Users, Loader2 } from \"lucide-react\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport type { User } from \"@shared/schema\";\n\ndelete (L.Icon.Default.prototype as any)._getIconUrl;\nL.Icon.Default.mergeOptions({\n  iconRetinaUrl: \"https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon-2x.png\",\n  iconUrl: \"https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png\",\n  shadowUrl: \"https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png\",\n});\n\ninterface CustomerLocation {\n  userId: string;\n  name: string;\n  company?: string;\n  city?: string;\n  state?: string;\n  lat: number;\n  lng: number;\n}\n\nconst BRAZIL_CENTER: [number, number] = [-14.235, -51.925];\n\nconst STATE_COORDS: Record<string, [number, number]> = {\n  AC: [-9.0238, -70.8120],\n  AL: [-9.5713, -36.7819],\n  AP: [1.4102, -51.7769],\n  AM: [-3.4168, -65.8561],\n  BA: [-12.5797, -41.7007],\n  CE: [-5.4984, -39.3206],\n  DF: [-15.7998, -47.8645],\n  ES: [-19.1834, -40.3089],\n  GO: [-15.8270, -49.8362],\n  MA: [-4.9609, -45.2744],\n  MT: [-12.6819, -56.9211],\n  MS: [-20.7722, -54.7852],\n  MG: [-18.5122, -44.5550],\n  PA: [-3.4168, -52.2170],\n  PB: [-7.2399, -36.7819],\n  PR: [-24.8946, -51.5546],\n  PE: [-8.8137, -36.9541],\n  PI: [-7.7183, -42.7289],\n  RJ: [-22.2587, -42.6592],\n  RN: [-5.8126, -36.5630],\n  RS: [-30.0346, -51.2177],\n  RO: [-10.8304, -63.3447],\n  RR: [2.7376, -62.0751],\n  SC: [-27.2423, -50.2189],\n  SP: [-22.1937, -48.7934],\n  SE: [-10.5741, -37.3857],\n  TO: [-10.1753, -48.2982],\n};\n\nconst CITY_COORDS: Record<string, [number, number]> = {\n  \"sao paulo\": [-23.5505, -46.6333],\n  \"rio de janeiro\": [-22.9068, -43.1729],\n  \"belo horizonte\": [-19.9167, -43.9345],\n  \"brasilia\": [-15.7942, -47.8822],\n  \"salvador\": [-12.9714, -38.5014],\n  \"fortaleza\": [-3.7172, -38.5433],\n  \"curitiba\": [-25.4284, -49.2733],\n  \"manaus\": [-3.1190, -60.0217],\n  \"recife\": [-8.0476, -34.8770],\n  \"porto alegre\": [-30.0346, -51.2177],\n  \"belem\": [-1.4558, -48.4902],\n  \"goiania\": [-16.6864, -49.2643],\n  \"guarulhos\": [-23.4538, -46.5333],\n  \"campinas\": [-22.9053, -47.0659],\n  \"sao luis\": [-2.5387, -44.2825],\n  \"maceio\": [-9.6498, -35.7089],\n  \"natal\": [-5.7945, -35.2110],\n  \"campo grande\": [-20.4697, -54.6201],\n  \"teresina\": [-5.0892, -42.8019],\n  \"joao pessoa\": [-7.1195, -34.8450],\n  \"aracaju\": [-10.9472, -37.0731],\n  \"cuiaba\": [-15.6014, -56.0979],\n  \"florianopolis\": [-27.5969, -48.5495],\n  \"vitoria\": [-20.3155, -40.3128],\n  \"londrina\": [-23.3045, -51.1696],\n  \"santo andre\": [-23.6737, -46.5432],\n  \"osasco\": [-23.5329, -46.7917],\n  \"ribeirao preto\": [-21.1775, -47.8103],\n  \"sorocaba\": [-23.5015, -47.4526],\n  \"joinville\": [-26.3045, -48.8487],\n  \"maringa\": [-23.4273, -51.9375],\n  \"santos\": [-23.9608, -46.3336],\n  \"sao jose dos campos\": [-23.2237, -45.9009],\n  \"uberlandia\": [-18.9186, -48.2772],\n  \"piracicaba\": [-22.7338, -47.6476],\n  \"juiz de fora\": [-21.7642, -43.3497],\n  \"sao jose do rio preto\": [-20.8113, -49.3758],\n  \"contagem\": [-19.9318, -44.0539],\n  \"feira de santana\": [-12.2500, -38.9667],\n  \"bauru\": [-22.3246, -49.0871],\n  \"caxias do sul\": [-29.1634, -51.1797],\n  \"pelotas\": [-31.7654, -52.3376],\n  \"canoas\": [-29.9178, -51.1839],\n  \"blumenau\": [-26.9194, -49.0661],\n  \"franca\": [-20.5396, -47.4008],\n};\n\nfunction getCoordinates(city?: string, state?: string): [number, number] | null {\n  if (city) {\n    const normalizedCity = city.toLowerCase().normalize(\"NFD\").replace(/[\\u0300-\\u036f]/g, \"\");\n    if (CITY_COORDS[normalizedCity]) {\n      const [lat, lng] = CITY_COORDS[normalizedCity];\n      return [lat + (Math.random() - 0.5) * 0.05, lng + (Math.random() - 0.5) * 0.05];\n    }\n  }\n  if (state) {\n    const normalizedState = state.toUpperCase().trim();\n    if (STATE_COORDS[normalizedState]) {\n      const [lat, lng] = STATE_COORDS[normalizedState];\n      return [lat + (Math.random() - 0.5) * 0.5, lng + (Math.random() - 0.5) * 0.5];\n    }\n  }\n  return null;\n}\n\nexport function CustomerMap() {\n  const mapRef = useRef<HTMLDivElement>(null);\n  const leafletMapRef = useRef<L.Map | null>(null);\n  const [mapReady, setMapReady] = useState(false);\n\n  const { data: usersData = [], isLoading } = useQuery<User[]>({\n    queryKey: [\"/api/users\"],\n  });\n\n  const customerLocations: CustomerLocation[] = usersData\n    .filter((u) => u.role === \"customer\" && (u.city || u.state))\n    .map((u) => {\n      const coords = getCoordinates(u.city || undefined, u.state || undefined);\n      if (!coords) return null;\n      return {\n        userId: u.id,\n        name: `${u.firstName || \"\"} ${u.lastName || \"\"}`.trim() || u.email || \"Cliente\",\n        company: u.company || undefined,\n        city: u.city || undefined,\n        state: u.state || undefined,\n        lat: coords[0],\n        lng: coords[1],\n      };\n    })\n    .filter(Boolean) as CustomerLocation[];\n\n  const customersWithLocation = customerLocations.length;\n  const totalCustomers = usersData.filter((u) => u.role === \"customer\").length;\n\n  useEffect(() => {\n    if (!mapRef.current || leafletMapRef.current) return;\n\n    const map = L.map(mapRef.current, {\n      center: BRAZIL_CENTER,\n      zoom: 4,\n      scrollWheelZoom: true,\n      attributionControl: true,\n    });\n\n    L.tileLayer(\"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png\", {\n      attribution: '&copy; <a href=\"https://www.openstreetmap.org/copyright\">OpenStreetMap</a>',\n    }).addTo(map);\n\n    leafletMapRef.current = map;\n    setMapReady(true);\n\n    return () => {\n      if (leafletMapRef.current) {\n        leafletMapRef.current.remove();\n        leafletMapRef.current = null;\n      }\n    };\n  }, []);\n\n  useEffect(() => {\n    if (!leafletMapRef.current || !mapReady) return;\n\n    leafletMapRef.current.eachLayer((layer) => {\n      if (layer instanceof L.Marker) {\n        leafletMapRef.current?.removeLayer(layer);\n      }\n    });\n\n    customerLocations.forEach((customer) => {\n      const marker = L.marker([customer.lat, customer.lng]).addTo(leafletMapRef.current!);\n      marker.bindPopup(`\n        <div style=\"min-width: 150px;\">\n          <strong>${customer.name}</strong>\n          ${customer.company ? `<br/><span style=\"color: #666;\">${customer.company}</span>` : \"\"}\n          <br/>\n          <span style=\"font-size: 12px; color: #888;\">\n            ${customer.city || \"\"}${customer.city && customer.state ? \", \" : \"\"}${customer.state || \"\"}\n          </span>\n          <br/>\n          <a href=\"/users?highlight=${customer.userId}\" style=\"color: #3b82f6; font-size: 12px; text-decoration: underline;\">Ver cliente</a>\n        </div>\n      `);\n    });\n\n    if (customerLocations.length > 0) {\n      const bounds = L.latLngBounds(customerLocations.map((c) => [c.lat, c.lng]));\n      leafletMapRef.current.fitBounds(bounds, { padding: [50, 50], maxZoom: 10 });\n    }\n  }, [customerLocations, mapReady]);\n\n  return (\n    <Card className=\"col-span-full\">\n      <CardHeader className=\"flex flex-row items-center justify-between gap-2 pb-2\">\n        <CardTitle className=\"flex items-center gap-2 text-lg\">\n          <MapPin className=\"h-5 w-5 text-primary\" />\n          Mapa de Clientes\n        </CardTitle>\n        <div className=\"flex items-center gap-4 text-sm text-muted-foreground\">\n          <span className=\"flex items-center gap-1\">\n            <Users className=\"h-4 w-4\" />\n            {customersWithLocation} de {totalCustomers} clientes no mapa\n          </span>\n        </div>\n      </CardHeader>\n      <CardContent>\n        {isLoading ? (\n          <div className=\"h-[400px] flex items-center justify-center\">\n            <Loader2 className=\"h-8 w-8 animate-spin text-muted-foreground\" />\n          </div>\n        ) : (\n          <div\n            ref={mapRef}\n            className=\"h-[400px] rounded-lg border\"\n            style={{ zIndex: 0 }}\n            data-testid=\"customer-map\"\n          />\n        )}\n        {!isLoading && customersWithLocation === 0 && (\n          <p className=\"text-center text-muted-foreground mt-4\">\n            Nenhum cliente com endereco cadastrado. Adicione cidade e estado nos cadastros dos clientes.\n          </p>\n        )}\n      </CardContent>\n    </Card>\n  );\n}\n","path":null,"size_bytes":8248,"size_tokens":null},"client/src/pages/brand-analytics.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Button } from \"@/components/ui/button\";\nimport { Loader2, Package, TrendingUp, AlertTriangle, ShoppingCart, Tag, ChevronDown, ChevronRight } from \"lucide-react\";\nimport { StatCard } from \"@/components/StatCard\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Collapsible, CollapsibleContent, CollapsibleTrigger } from \"@/components/ui/collapsible\";\nimport { useAuth } from \"@/contexts/AuthContext\";\n\ninterface BrandSummary {\n  brand: string;\n  totalProducts: number;\n  totalStock: number;\n  lowStockCount: number;\n  outOfStockCount: number;\n  totalSales30d: number;\n  totalRevenue30d: number;\n  avgTurnover: number;\n}\n\ninterface BrandProductDetail {\n  productId: number;\n  name: string;\n  sku: string;\n  brand: string;\n  stock: number;\n  sales30d: number;\n  sales60d: number;\n  sales90d: number;\n  revenue30d: number;\n  lastSaleDate: string | null;\n  turnoverDays: number | null;\n  status: 'critical' | 'low' | 'ok' | 'overstock';\n  suggestedPurchase: number;\n}\n\ninterface BrandAnalyticsData {\n  brands: BrandSummary[];\n  productsByBrand: Record<string, BrandProductDetail[]>;\n  overview: {\n    totalBrands: number;\n    totalProducts: number;\n    totalLowStock: number;\n    totalOutOfStock: number;\n    topSellingBrand: string | null;\n    topSellingBrandRevenue: number;\n  };\n}\n\nconst statusColors = {\n  critical: 'bg-red-500/10 text-red-600 dark:text-red-400 border-red-200 dark:border-red-800',\n  low: 'bg-orange-500/10 text-orange-600 dark:text-orange-400 border-orange-200 dark:border-orange-800',\n  ok: 'bg-green-500/10 text-green-600 dark:text-green-400 border-green-200 dark:border-green-800',\n  overstock: 'bg-blue-500/10 text-blue-600 dark:text-blue-400 border-blue-200 dark:border-blue-800',\n};\n\nconst statusLabels = {\n  critical: 'Critico',\n  low: 'Baixo',\n  ok: 'OK',\n  overstock: 'Excesso',\n};\n\nexport default function BrandAnalyticsPage() {\n  const { isSupplier, user } = useAuth();\n  const [selectedBrand, setSelectedBrand] = useState<string>(\"all\");\n  const [expandedBrands, setExpandedBrands] = useState<Set<string>>(new Set());\n\n  const { data, isLoading } = useQuery<BrandAnalyticsData>({\n    queryKey: ['/api/admin/brand-analytics'],\n  });\n\n  const toggleBrandExpansion = (brand: string) => {\n    setExpandedBrands(prev => {\n      const next = new Set(prev);\n      if (next.has(brand)) {\n        next.delete(brand);\n      } else {\n        next.add(brand);\n      }\n      return next;\n    });\n  };\n\n  if (isLoading) {\n    return (\n      <div className=\"flex items-center justify-center min-h-[400px]\">\n        <Loader2 className=\"h-8 w-8 animate-spin text-muted-foreground\" />\n      </div>\n    );\n  }\n\n  if (!data) {\n    return (\n      <div className=\"p-6 lg:p-8\">\n        <p className=\"text-muted-foreground\">Erro ao carregar dados de marcas.</p>\n      </div>\n    );\n  }\n\n  const filteredBrands = selectedBrand === \"all\" \n    ? data.brands \n    : data.brands.filter(b => b.brand === selectedBrand);\n\n  return (\n    <div className=\"p-6 lg:p-8 space-y-8\">\n      <div className=\"flex flex-wrap items-center justify-between gap-4\">\n        <div>\n          <h1 className=\"text-3xl font-semibold\">Analytics por Marca</h1>\n          <p className=\"text-muted-foreground mt-1\">\n            {isSupplier \n              ? `Visualizacao de suas marcas: ${user?.allowedBrands?.join(', ') || 'Nenhuma'}`\n              : 'Analise de desempenho e estoque por marca'\n            }\n          </p>\n        </div>\n        <Select value={selectedBrand} onValueChange={setSelectedBrand}>\n          <SelectTrigger className=\"w-[200px]\" data-testid=\"select-brand-filter\">\n            <SelectValue placeholder=\"Filtrar por marca\" />\n          </SelectTrigger>\n          <SelectContent>\n            <SelectItem value=\"all\">Todas as marcas</SelectItem>\n            {data.brands.map(b => (\n              <SelectItem key={b.brand} value={b.brand}>{b.brand}</SelectItem>\n            ))}\n          </SelectContent>\n        </Select>\n      </div>\n\n      <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4\">\n        <StatCard\n          title=\"Total de Marcas\"\n          value={data.overview.totalBrands}\n          icon={Tag}\n          data-testid=\"stat-total-brands\"\n        />\n        <StatCard\n          title=\"Total de Produtos\"\n          value={data.overview.totalProducts}\n          icon={Package}\n          data-testid=\"stat-total-products\"\n        />\n        <StatCard\n          title=\"Estoque Baixo\"\n          value={data.overview.totalLowStock}\n          icon={AlertTriangle}\n          data-testid=\"stat-low-stock\"\n        />\n        <StatCard\n          title=\"Sem Estoque\"\n          value={data.overview.totalOutOfStock}\n          icon={AlertTriangle}\n          data-testid=\"stat-out-of-stock\"\n        />\n        {!isSupplier && (\n          <StatCard\n            title=\"Marca Top\"\n            value={data.overview.topSellingBrand || '-'}\n            icon={TrendingUp}\n            data-testid=\"stat-top-brand\"\n          />\n        )}\n      </div>\n\n      <div className=\"space-y-4\">\n        <h2 className=\"text-xl font-semibold\">Desempenho por Marca</h2>\n        \n        {filteredBrands.length === 0 ? (\n          <Card>\n            <CardContent className=\"py-8\">\n              <p className=\"text-center text-muted-foreground\">Nenhuma marca encontrada.</p>\n            </CardContent>\n          </Card>\n        ) : (\n          filteredBrands.map(brand => (\n            <Collapsible \n              key={brand.brand}\n              open={expandedBrands.has(brand.brand)}\n              onOpenChange={() => toggleBrandExpansion(brand.brand)}\n            >\n              <Card>\n                <CardHeader className=\"pb-2\">\n                  <CollapsibleTrigger asChild>\n                    <Button variant=\"ghost\" className=\"w-full justify-between p-0 h-auto hover:bg-transparent\" data-testid={`brand-toggle-${brand.brand}`}>\n                      <div className=\"flex items-center gap-4\">\n                        {expandedBrands.has(brand.brand) ? (\n                          <ChevronDown className=\"h-5 w-5 text-muted-foreground\" />\n                        ) : (\n                          <ChevronRight className=\"h-5 w-5 text-muted-foreground\" />\n                        )}\n                        <CardTitle className=\"text-lg\">{brand.brand}</CardTitle>\n                        <div className=\"flex items-center gap-2\">\n                          <Badge variant=\"outline\">{brand.totalProducts} produtos</Badge>\n                          {brand.outOfStockCount > 0 && (\n                            <Badge className=\"bg-red-500/10 text-red-600 dark:text-red-400\">\n                              {brand.outOfStockCount} sem estoque\n                            </Badge>\n                          )}\n                          {brand.lowStockCount > 0 && (\n                            <Badge className=\"bg-orange-500/10 text-orange-600 dark:text-orange-400\">\n                              {brand.lowStockCount} baixo\n                            </Badge>\n                          )}\n                        </div>\n                      </div>\n                      <div className=\"flex items-center gap-6 text-sm\">\n                        <div className=\"text-right\">\n                          <span className=\"text-muted-foreground\">Estoque:</span>\n                          <span className=\"ml-2 font-semibold\">{brand.totalStock}</span>\n                        </div>\n                        <div className=\"text-right\">\n                          <span className=\"text-muted-foreground\">Vendas 30d:</span>\n                          <span className=\"ml-2 font-semibold\">{brand.totalSales30d}</span>\n                        </div>\n                        {!isSupplier && (\n                          <div className=\"text-right\">\n                            <span className=\"text-muted-foreground\">Receita 30d:</span>\n                            <span className=\"ml-2 font-semibold\">\n                              R$ {brand.totalRevenue30d.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}\n                            </span>\n                          </div>\n                        )}\n                        <div className=\"text-right\">\n                          <span className=\"text-muted-foreground\">Giro medio:</span>\n                          <span className=\"ml-2 font-semibold\">\n                            {brand.avgTurnover > 0 ? `${brand.avgTurnover} dias` : '-'}\n                          </span>\n                        </div>\n                      </div>\n                    </Button>\n                  </CollapsibleTrigger>\n                </CardHeader>\n                <CollapsibleContent>\n                  <CardContent className=\"pt-4\">\n                    <div className=\"space-y-2\">\n                      <div className=\"grid grid-cols-12 gap-4 text-sm font-medium text-muted-foreground pb-2 border-b\">\n                        <div className=\"col-span-3\">Produto</div>\n                        <div className=\"col-span-1 text-center\">SKU</div>\n                        <div className=\"col-span-1 text-center\">Estoque</div>\n                        <div className=\"col-span-1 text-center\">30d</div>\n                        <div className=\"col-span-1 text-center\">60d</div>\n                        <div className=\"col-span-1 text-center\">90d</div>\n                        <div className=\"col-span-1 text-center\">Giro</div>\n                        <div className=\"col-span-1 text-center\">Status</div>\n                        <div className=\"col-span-2 text-center\">Sugestao Compra</div>\n                      </div>\n                      {(data.productsByBrand[brand.brand] || []).map(product => (\n                        <div \n                          key={product.productId}\n                          className=\"grid grid-cols-12 gap-4 text-sm items-center py-2 hover-elevate rounded-md px-2\"\n                          data-testid={`product-row-${product.productId}`}\n                        >\n                          <div className=\"col-span-3 font-medium truncate\" title={product.name}>\n                            {product.name}\n                          </div>\n                          <div className=\"col-span-1 text-center\">\n                            <Badge variant=\"outline\" className=\"text-xs\">{product.sku}</Badge>\n                          </div>\n                          <div className=\"col-span-1 text-center font-semibold\">\n                            {product.stock}\n                          </div>\n                          <div className=\"col-span-1 text-center\">\n                            {product.sales30d}\n                          </div>\n                          <div className=\"col-span-1 text-center\">\n                            {product.sales60d}\n                          </div>\n                          <div className=\"col-span-1 text-center\">\n                            {product.sales90d}\n                          </div>\n                          <div className=\"col-span-1 text-center\">\n                            {product.turnoverDays !== null ? `${product.turnoverDays}d` : '-'}\n                          </div>\n                          <div className=\"col-span-1 text-center\">\n                            <Badge className={statusColors[product.status]}>\n                              {statusLabels[product.status]}\n                            </Badge>\n                          </div>\n                          <div className=\"col-span-2 text-center\">\n                            {product.suggestedPurchase > 0 ? (\n                              <div className=\"flex items-center justify-center gap-2\">\n                                <ShoppingCart className=\"h-4 w-4 text-muted-foreground\" />\n                                <span className=\"font-semibold text-primary\">{product.suggestedPurchase} un.</span>\n                              </div>\n                            ) : (\n                              <span className=\"text-muted-foreground\">-</span>\n                            )}\n                          </div>\n                        </div>\n                      ))}\n                    </div>\n                  </CardContent>\n                </CollapsibleContent>\n              </Card>\n            </Collapsible>\n          ))\n        )}\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":12538,"size_tokens":null},"shared/schema/products.schema.ts":{"content":"import { pgTable, serial, varchar, text, decimal, boolean, timestamp, pgEnum } from \"drizzle-orm/pg-core\";\nimport { createInsertSchema } from \"drizzle-zod\";\nimport { z } from \"zod\";\n\nexport const unidadeMedidaEnum = pgEnum(\"unidade_medida\", [\"UN\", \"CX\", \"KG\", \"MT\", \"PC\", \"LT\"]);\nexport const productStatusEnum = pgEnum(\"product_status\", [\"ATIVO\", \"INATIVO\", \"DESCONTINUADO\"]);\nexport const disponibilidadeEnum = pgEnum(\"disponibilidade\", [\"DISPONIVEL\", \"INDISPONIVEL\", \"SOB_CONSULTA\"]);\n\nexport const b2bProducts = pgTable(\"b2b_products\", {\n  id: serial(\"id\").primaryKey(),\n  nome: text(\"nome\").notNull(),\n  sku: varchar(\"sku\", { length: 50 }).unique().notNull(),\n  unidadeMedida: unidadeMedidaEnum(\"unidade_medida\").notNull().default(\"UN\"),\n  precoVarejo: decimal(\"preco_varejo\", { precision: 10, scale: 2 }).notNull(),\n  precoAtacado: decimal(\"preco_atacado\", { precision: 10, scale: 2 }).notNull(),\n  status: productStatusEnum(\"status\").notNull().default(\"ATIVO\"),\n  disponibilidade: disponibilidadeEnum(\"disponibilidade\").notNull().default(\"DISPONIVEL\"),\n  descricao: text(\"descricao\"),\n  imagem: text(\"imagem\"),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\nexport const insertB2bProductSchema = createInsertSchema(b2bProducts).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport type InsertB2bProduct = z.infer<typeof insertB2bProductSchema>;\nexport type B2bProduct = typeof b2bProducts.$inferSelect;\n","path":null,"size_bytes":1496,"size_tokens":null},"server/services/companies.service.ts":{"content":"import { db } from \"../db\";\nimport { companies, userCompanies } from \"@shared/schema\";\nimport { eq } from \"drizzle-orm\";\nimport type { InsertCompany } from \"@shared/schema\";\n\n/**\n * Cria uma nova empresa (CNPJ)\n * NÃO cria vínculo automaticamente\n */\nexport async function createCompany(data: InsertCompany) {\n  const [company] = await db\n    .insert(companies)\n    .values(data)\n    .returning();\n\n  return company;\n}\n\n/**\n * Vincula um usuário a uma empresa\n * Define role dentro da empresa (ADMIN_EMPRESA, COMPRADOR, etc)\n */\nexport async function linkUserToCompany({\n  userId,\n  companyId,\n  role,\n}: {\n  userId: string;\n  companyId: string;\n  role: string;\n}) {\n  const [link] = await db\n    .insert(userCompanies)\n    .values({\n      userId,\n      companyId,\n      role,\n    })\n    .returning();\n\n  return link;\n}\n\n/**\n * Lista todas as empresas às quais o usuário pertence\n */\nexport async function getCompaniesByUser(userId: string) {\n  const rows = await db\n    .select({\n      id: companies.id,\n      razaoSocial: companies.razaoSocial,\n      nomeFantasia: companies.nomeFantasia,\n      tipoCliente: companies.tipoCliente,\n      approvalStatus: companies.approvalStatus,\n      role: userCompanies.role,\n    })\n    .from(userCompanies)\n    .innerJoin(companies, eq(userCompanies.companyId, companies.id))\n    .where(eq(userCompanies.userId, userId));\n\n  return rows;\n}\n\n/**\n * Busca empresa por ID (uso interno / contexto ativo)\n */\nexport async function getCompanyById(companyId: string) {\n  const [company] = await db\n    .select()\n    .from(companies)\n    .where(eq(companies.id, companyId));\n\n  return company ?? null;\n}\n","path":null,"size_bytes":1639,"size_tokens":null},"shared/schema/companies.schema.ts":{"content":"import { sql } from \"drizzle-orm\";\nimport { pgTable, varchar, text, boolean, timestamp, pgEnum } from \"drizzle-orm/pg-core\";\nimport { createInsertSchema } from \"drizzle-zod\";\nimport { z } from \"zod\";\n\nexport const tipoClienteEnum = pgEnum(\"tipo_cliente\", [\"ATACADO\", \"VAREJO\"]);\nexport const approvalStatusEnum = pgEnum(\"approval_status\", [\"PENDENTE\", \"APROVADO\", \"REPROVADO\"]);\n\nexport const companies = pgTable(\"companies\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  razaoSocial: text(\"razao_social\").notNull(),\n  nomeFantasia: text(\"nome_fantasia\"),\n  cnpj: varchar(\"cnpj\", { length: 18 }).unique().notNull(),\n  tipoCliente: tipoClienteEnum(\"tipo_cliente\").notNull().default(\"VAREJO\"),\n  approvalStatus: approvalStatusEnum(\"approval_status\").notNull().default(\"PENDENTE\"),\n  ativo: boolean(\"ativo\").notNull().default(true),\n  cep: varchar(\"cep\", { length: 9 }),\n  endereco: text(\"endereco\"),\n  numero: text(\"numero\"),\n  complemento: text(\"complemento\"),\n  bairro: text(\"bairro\"),\n  cidade: text(\"cidade\"),\n  estado: varchar(\"estado\", { length: 2 }),\n  telefone: text(\"telefone\"),\n  email: text(\"email\"),\n  inscricaoEstadual: text(\"inscricao_estadual\"),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\nexport const insertCompanySchema = createInsertSchema(companies).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport type InsertCompany = z.infer<typeof insertCompanySchema>;\nexport type Company = typeof companies.$inferSelect;\n","path":null,"size_bytes":1545,"size_tokens":null},"shared/schema/users.schema.ts":{"content":"import { sql } from \"drizzle-orm\";\nimport { pgTable, varchar, text, boolean, timestamp } from \"drizzle-orm/pg-core\";\nimport { createInsertSchema } from \"drizzle-zod\";\nimport { z } from \"zod\";\n\nexport const b2bUsers = pgTable(\"b2b_users\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  nome: text(\"nome\").notNull(),\n  email: text(\"email\").unique().notNull(),\n  senhaHash: text(\"senha_hash\"),\n  telefone: text(\"telefone\"),\n  ativo: boolean(\"ativo\").notNull().default(true),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\nexport const insertB2bUserSchema = createInsertSchema(b2bUsers).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport type InsertB2bUser = z.infer<typeof insertB2bUserSchema>;\nexport type B2bUser = typeof b2bUsers.$inferSelect;\n","path":null,"size_bytes":855,"size_tokens":null},"server/services/orderTotals.service.ts":{"content":"import { db } from \"../db\";\nimport {\n  b2bOrders,\n  b2bOrderItems,\n  orderItemDiscounts,\n} from \"@shared/schema\";\nimport { eq, and, sql } from \"drizzle-orm\";\n\n/**\n * Recalcula subtotal e total do pedido\n * Usa SOMENTE descontos APROVADOS\n */\nexport async function recalcOrderTotals(orderId: number) {\n  // Soma itens\n  const items = await db\n    .select({\n      itemTotal: sql<number>`quantity * price`,\n      itemId: b2bOrderItems.id,\n    })\n    .from(b2bOrderItems)\n    .where(eq(b2bOrderItems.orderId, orderId));\n\n  let subtotal = items.reduce((acc, i) => acc + Number(i.itemTotal), 0);\n\n  // Soma descontos aprovados\n  const discounts = await db\n    .select({\n      value: orderItemDiscounts.value,\n      type: orderItemDiscounts.tipo,\n    })\n    .from(orderItemDiscounts)\n    .innerJoin(\n      b2bOrderItems,\n      eq(orderItemDiscounts.orderItemId, b2bOrderItems.id)\n    )\n    .where(\n      and(\n        eq(b2bOrderItems.orderId, orderId),\n        eq(orderItemDiscounts.status, \"APROVADO\")\n      )\n    );\n\n  let totalDiscount = 0;\n\n  for (const d of discounts) {\n    if (d.type === \"PERCENTUAL\") {\n      totalDiscount += (subtotal * Number(d.value)) / 100;\n    } else {\n      totalDiscount += Number(d.value);\n    }\n  }\n\n  const total = subtotal - totalDiscount;\n\n  const [order] = await db\n    .update(b2bOrders)\n    .set({\n      subtotal,\n      total,\n    })\n    .where(eq(b2bOrders.id, orderId))\n    .returning();\n\n  return order;\n}\n","path":null,"size_bytes":1442,"size_tokens":null},"shared/schema/index.ts":{"content":"// Re-export legacy schema for backwards compatibility\nexport * from \"./legacy.schema\";\n\n// Export new B2B schemas - companies (no conflict with legacy)\nexport * from \"./companies.schema\";\n\n// Export new B2B schemas with b2b prefix to avoid conflicts\nexport { \n  b2bUsers, \n  insertB2bUserSchema,\n  type InsertB2bUser,\n  type B2bUser \n} from \"./users.schema\";\n\nexport { userCompanies, insertUserCompanySchema, type InsertUserCompany, type UserCompany } from \"./userCompanies.schema\";\n\nexport {\n  b2bProducts,\n  insertB2bProductSchema,\n  type InsertB2bProduct,\n  type B2bProduct,\n  unidadeMedidaEnum,\n  productStatusEnum,\n  disponibilidadeEnum\n} from \"./products.schema\";\n\nexport {\n  b2bOrders,\n  insertB2bOrderSchema,\n  type InsertB2bOrder,\n  type B2bOrder,\n  orderChannelEnum,\n  orderStatusEnum,\n  orderEtapaEnum\n} from \"./orders.schema\";\n\nexport {\n  b2bOrderItems,\n  insertB2bOrderItemSchema,\n  type InsertB2bOrderItem,\n  type B2bOrderItem\n} from \"./orderItems.schema\";\n\nexport {\n  orderItemDiscounts,\n  insertOrderItemDiscountSchema,\n  type InsertOrderItemDiscount,\n  type OrderItemDiscount,\n  tipoDescontoEnum,\n  discountStatusEnum\n} from \"./orderItemDiscounts.schema\";\n\n// Export enums from companies schema\nexport { tipoClienteEnum, approvalStatusEnum } from \"./companies.schema\";\n\n// Export payment schemas\nexport {\n  paymentTypes,\n  insertPaymentTypeSchema,\n  type InsertPaymentType,\n  type PaymentType,\n  paymentIntegrations,\n  insertPaymentIntegrationSchema,\n  type InsertPaymentIntegration,\n  type PaymentIntegration,\n  paymentTransactions,\n  insertPaymentTransactionSchema,\n  type InsertPaymentTransaction,\n  type PaymentTransaction,\n  feeTypeEnum,\n  integrationStatusEnum\n} from \"./payments.schema\";\n","path":null,"size_bytes":1713,"size_tokens":null},"shared/schema/orders.schema.ts":{"content":"import { sql } from \"drizzle-orm\";\nimport { pgTable, serial, varchar, text, decimal, timestamp, pgEnum } from \"drizzle-orm/pg-core\";\nimport { createInsertSchema } from \"drizzle-zod\";\nimport { z } from \"zod\";\nimport { companies } from \"./companies.schema\";\nimport { b2bUsers } from \"./users.schema\";\n\nexport const orderChannelEnum = pgEnum(\"order_channel\", [\"SITE\", \"ADMIN\", \"REPRESENTANTE\", \"API\"]);\nexport const orderStatusEnum = pgEnum(\"order_status\", [\"ORCAMENTO\", \"GERADO\", \"FATURADO\", \"CANCELADO\"]);\nexport const orderEtapaEnum = pgEnum(\"order_etapa\", [\"AGUARDANDO\", \"SEPARADO\", \"COBRADO\", \"ENVIADO\"]);\n\nexport const b2bOrders = pgTable(\"b2b_orders\", {\n  id: serial(\"id\").primaryKey(),\n  companyId: varchar(\"company_id\").notNull().references(() => companies.id),\n  createdByUserId: varchar(\"created_by_user_id\").references(() => b2bUsers.id),\n  orderNumber: varchar(\"order_number\", { length: 20 }).unique().notNull(),\n  channel: orderChannelEnum(\"channel\").notNull().default(\"SITE\"),\n  status: orderStatusEnum(\"status\").notNull().default(\"ORCAMENTO\"),\n  etapa: orderEtapaEnum(\"etapa\").notNull().default(\"AGUARDANDO\"),\n  subtotal: decimal(\"subtotal\", { precision: 12, scale: 2 }).notNull().default(\"0\"),\n  descontoTotal: decimal(\"desconto_total\", { precision: 12, scale: 2 }).notNull().default(\"0\"),\n  frete: decimal(\"frete\", { precision: 10, scale: 2 }).notNull().default(\"0\"),\n  total: decimal(\"total\", { precision: 12, scale: 2 }).notNull(),\n  observacoes: text(\"observacoes\"),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\nexport const insertB2bOrderSchema = createInsertSchema(b2bOrders).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport type InsertB2bOrder = z.infer<typeof insertB2bOrderSchema>;\nexport type B2bOrder = typeof b2bOrders.$inferSelect;\n","path":null,"size_bytes":1851,"size_tokens":null},"shared/schema/userCompanies.schema.ts":{"content":"import { pgTable, serial, varchar, text, boolean, timestamp } from \"drizzle-orm/pg-core\";\nimport { createInsertSchema } from \"drizzle-zod\";\nimport { z } from \"zod\";\nimport { b2bUsers } from \"./users.schema\";\nimport { companies } from \"./companies.schema\";\n\nexport const userCompanies = pgTable(\"user_companies\", {\n  id: serial(\"id\").primaryKey(),\n  userId: varchar(\"user_id\").notNull().references(() => b2bUsers.id, { onDelete: \"cascade\" }),\n  companyId: varchar(\"company_id\").notNull().references(() => companies.id, { onDelete: \"cascade\" }),\n  roleNaEmpresa: text(\"role_na_empresa\").notNull().default(\"operador\"),\n  isAdmin: boolean(\"is_admin\").notNull().default(false),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n});\n\nexport const insertUserCompanySchema = createInsertSchema(userCompanies).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport type InsertUserCompany = z.infer<typeof insertUserCompanySchema>;\nexport type UserCompany = typeof userCompanies.$inferSelect;\n","path":null,"size_bytes":989,"size_tokens":null},"shared/schema/legacy.schema.ts":{"content":"import { sql } from \"drizzle-orm\";\nimport { pgTable, text, varchar, integer, decimal, boolean, timestamp, serial, jsonb, index } from \"drizzle-orm/pg-core\";\nimport { createInsertSchema } from \"drizzle-zod\";\nimport { z } from \"zod\";\n\n// Session storage table - mandatory for Replit Auth\nexport const sessions = pgTable(\n  \"sessions\",\n  {\n    sid: varchar(\"sid\").primaryKey(),\n    sess: jsonb(\"sess\").notNull(),\n    expire: timestamp(\"expire\").notNull(),\n  },\n  (table) => [index(\"IDX_session_expire\").on(table.expire)],\n);\n\n// Users table - stores all users with role-based access\n// Includes Replit Auth fields plus custom B2B fields\nexport const users = pgTable(\"users\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  email: text(\"email\").unique(),\n  password: text(\"password\"),\n  firstName: text(\"first_name\"),\n  lastName: text(\"last_name\"),\n  profileImageUrl: text(\"profile_image_url\"),\n  role: text(\"role\").notNull().default(\"customer\"), // admin, sales, customer, supplier\n  allowedBrands: text(\"allowed_brands\").array(),\n  customerType: text(\"customer_type\").notNull().default(\"varejo\"), // atacado, varejo\n  company: text(\"company\"),\n  approved: boolean(\"approved\").notNull().default(false),\n  phone: text(\"phone\"),\n  personType: text(\"person_type\"), // juridica, fisica\n  cnpj: text(\"cnpj\"),\n  cpf: text(\"cpf\"),\n  tradingName: text(\"trading_name\"), // Nome Fantasia\n  stateRegistration: text(\"state_registration\"), // Inscrição Estadual\n  cep: text(\"cep\"),\n  address: text(\"address\"),\n  addressNumber: text(\"address_number\"),\n  complement: text(\"complement\"),\n  neighborhood: text(\"neighborhood\"),\n  city: text(\"city\"),\n  state: text(\"state\"),\n  tag: text(\"tag\"),\n  instagram: text(\"instagram\"),\n  notes: text(\"notes\"),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\nexport type UpsertUser = typeof users.$inferInsert;\nexport type User = typeof users.$inferSelect;\n\nexport const insertUserSchema = createInsertSchema(users).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport type InsertUser = z.infer<typeof insertUserSchema>;\n\n// Categories table with hierarchy support (parent/child)\nexport const categories = pgTable(\"categories\", {\n  id: serial(\"id\").primaryKey(),\n  name: text(\"name\").notNull(),\n  slug: text(\"slug\").notNull().unique(),\n  parentId: integer(\"parent_id\"),\n  hideFromVarejo: boolean(\"hide_from_varejo\").notNull().default(false),\n  blingId: integer(\"bling_id\"),\n});\n\nexport const insertCategorySchema = createInsertSchema(categories).omit({\n  id: true,\n});\n\nexport type InsertCategory = z.infer<typeof insertCategorySchema>;\nexport type Category = typeof categories.$inferSelect;\n\n// Suppliers table\nexport const suppliers = pgTable(\"suppliers\", {\n  id: serial(\"id\").primaryKey(),\n  name: text(\"name\").notNull(),\n  tradingName: text(\"trading_name\"),\n  cnpj: text(\"cnpj\"),\n  email: text(\"email\"),\n  phone: text(\"phone\"),\n  contact: text(\"contact\"),\n  cep: text(\"cep\"),\n  address: text(\"address\"),\n  addressNumber: text(\"address_number\"),\n  complement: text(\"complement\"),\n  neighborhood: text(\"neighborhood\"),\n  city: text(\"city\"),\n  state: text(\"state\"),\n  notes: text(\"notes\"),\n  active: boolean(\"active\").notNull().default(true),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n});\n\nexport const insertSupplierSchema = createInsertSchema(suppliers).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport type InsertSupplier = z.infer<typeof insertSupplierSchema>;\nexport type Supplier = typeof suppliers.$inferSelect;\n\n// Products table\nexport const products = pgTable(\"products\", {\n  id: serial(\"id\").primaryKey(),\n  name: text(\"name\").notNull(),\n  sku: text(\"sku\").notNull().unique(),\n  categoryId: integer(\"category_id\").references(() => categories.id),\n  supplierId: integer(\"supplier_id\").references(() => suppliers.id),\n  brand: text(\"brand\"),\n  description: text(\"description\"),\n  price: decimal(\"price\", { precision: 10, scale: 2 }).notNull(),\n  cost: decimal(\"cost\", { precision: 10, scale: 2 }),\n  stock: integer(\"stock\").notNull().default(0),\n  reservedStock: integer(\"reserved_stock\").notNull().default(0),\n  image: text(\"image\"),\n  images: text(\"images\").array(),\n  featured: boolean(\"featured\").notNull().default(false),\n  weight: decimal(\"weight\", { precision: 10, scale: 3 }),\n  width: decimal(\"width\", { precision: 10, scale: 2 }),\n  height: decimal(\"height\", { precision: 10, scale: 2 }),\n  depth: decimal(\"depth\", { precision: 10, scale: 2 }),\n  gtin: text(\"gtin\"),\n  gtinTributario: text(\"gtin_tributario\"),\n  origem: text(\"origem\"),\n  ncm: text(\"ncm\"),\n  cest: text(\"cest\"),\n  tipoItem: text(\"tipo_item\"),\n  percentualTributos: decimal(\"percentual_tributos\", { precision: 5, scale: 2 }),\n  icmsCst: text(\"icms_cst\"),\n  icmsAliquota: decimal(\"icms_aliquota\", { precision: 5, scale: 2 }),\n  ipiCst: text(\"ipi_cst\"),\n  ipiAliquota: decimal(\"ipi_aliquota\", { precision: 5, scale: 2 }),\n  pisCst: text(\"pis_cst\"),\n  pisAliquota: decimal(\"pis_aliquota\", { precision: 5, scale: 2 }),\n  cofinsCst: text(\"cofins_cst\"),\n  cofinsAliquota: decimal(\"cofins_aliquota\", { precision: 5, scale: 2 }),\n  valorBaseIcmsStRetencao: decimal(\"valor_base_icms_st_retencao\", { precision: 10, scale: 2 }),\n  valorIcmsStRetencao: decimal(\"valor_icms_st_retencao\", { precision: 10, scale: 2 }),\n  valorIcmsProprioSubstituto: decimal(\"valor_icms_proprio_substituto\", { precision: 10, scale: 2 }),\n  codigoExcecaoTipi: text(\"codigo_excecao_tipi\"),\n  valorPisFixo: decimal(\"valor_pis_fixo\", { precision: 10, scale: 4 }),\n  valorCofinsFixo: decimal(\"valor_cofins_fixo\", { precision: 10, scale: 4 }),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n});\n\nexport const insertProductSchema = createInsertSchema(products).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport type InsertProduct = z.infer<typeof insertProductSchema>;\nexport type Product = typeof products.$inferSelect;\n\n// Orders table\n// STATUS (affects stock - situação do pedido):\n// - ORCAMENTO: no stock impact\n// - PEDIDO_GERADO: stock RESERVED\n// - FATURADO: stock DEDUCTED + sent to ERP\n//\n// STAGE (organizational - Kanban interno, NÃO afeta estoque):\n// 1. AGUARDANDO_IMPRESSAO - Inicial\n// 2. PEDIDO_IMPRESSO - Após impressão\n// 3. PEDIDO_SEPARADO - Após separação física  \n// 4. COBRADO - Após cobrança\n// 5. CONFERIR_COMPROVANTE - Aguardando validação\n// 6. EM_CONFERENCIA - Em conferência\n// 7. AGUARDANDO_ENVIO - Pronto para despacho\n// 8. PEDIDO_ENVIADO - Finalizado\nexport const orders = pgTable(\"orders\", {\n  id: serial(\"id\").primaryKey(),\n  userId: varchar(\"user_id\").references(() => users.id), // nullable for guest orders\n  orderNumber: text(\"order_number\").notNull().unique(),\n  status: text(\"status\").notNull().default(\"ORCAMENTO\"),\n  stage: text(\"stage\").notNull().default(\"AGUARDANDO_IMPRESSAO\"),\n  subtotal: decimal(\"subtotal\", { precision: 10, scale: 2 }),\n  shippingCost: decimal(\"shipping_cost\", { precision: 10, scale: 2 }),\n  total: decimal(\"total\", { precision: 10, scale: 2 }).notNull(),\n  // Guest checkout info (when no userId)\n  isGuestOrder: boolean(\"is_guest_order\").notNull().default(false),\n  guestCpf: text(\"guest_cpf\"),\n  guestName: text(\"guest_name\"),\n  guestEmail: text(\"guest_email\"),\n  guestPhone: text(\"guest_phone\"),\n  // Shipping info\n  shippingAddress: text(\"shipping_address\"),\n  shippingMethod: text(\"shipping_method\"),\n  // Payment info\n  paymentMethod: text(\"payment_method\"),\n  paymentNotes: text(\"payment_notes\"),\n  notes: text(\"notes\"),\n  printed: boolean(\"printed\").notNull().default(false),\n  printedAt: timestamp(\"printed_at\"),\n  printedBy: varchar(\"printed_by\").references(() => users.id),\n  reservedAt: timestamp(\"reserved_at\"),\n  reservedBy: varchar(\"reserved_by\").references(() => users.id),\n  invoicedAt: timestamp(\"invoiced_at\"),\n  invoicedBy: varchar(\"invoiced_by\").references(() => users.id),\n  blingOrderId: text(\"bling_order_id\"),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n});\n\nexport const insertOrderSchema = createInsertSchema(orders).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport type InsertOrder = z.infer<typeof insertOrderSchema>;\nexport type Order = typeof orders.$inferSelect;\n\n// Order Items table\nexport const orderItems = pgTable(\"order_items\", {\n  id: serial(\"id\").primaryKey(),\n  orderId: integer(\"order_id\").notNull().references(() => orders.id),\n  productId: integer(\"product_id\").notNull().references(() => products.id),\n  quantity: integer(\"quantity\").notNull(),\n  price: decimal(\"price\", { precision: 10, scale: 2 }).notNull(),\n});\n\nexport const insertOrderItemSchema = createInsertSchema(orderItems).omit({\n  id: true,\n});\n\nexport type InsertOrderItem = z.infer<typeof insertOrderItemSchema>;\nexport type OrderItem = typeof orderItems.$inferSelect;\n\n// Customer Price Tables - Personalized pricing per customer (like Mercos)\nexport const priceTables = pgTable(\"price_tables\", {\n  id: serial(\"id\").primaryKey(),\n  name: text(\"name\").notNull(),\n  description: text(\"description\"),\n  discountPercent: decimal(\"discount_percent\", { precision: 5, scale: 2 }).default(\"0\"),\n  isDefault: boolean(\"is_default\").notNull().default(false),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n});\n\nexport const insertPriceTableSchema = createInsertSchema(priceTables).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport type InsertPriceTable = z.infer<typeof insertPriceTableSchema>;\nexport type PriceTable = typeof priceTables.$inferSelect;\n\n// Customer-specific product prices\nexport const customerPrices = pgTable(\"customer_prices\", {\n  id: serial(\"id\").primaryKey(),\n  userId: varchar(\"user_id\").notNull().references(() => users.id),\n  productId: integer(\"product_id\").notNull().references(() => products.id),\n  customPrice: decimal(\"custom_price\", { precision: 10, scale: 2 }).notNull(),\n});\n\nexport const insertCustomerPriceSchema = createInsertSchema(customerPrices).omit({\n  id: true,\n});\n\nexport type InsertCustomerPrice = z.infer<typeof insertCustomerPriceSchema>;\nexport type CustomerPrice = typeof customerPrices.$inferSelect;\n\n// Coupons and promotions (like Mercos)\nexport const coupons = pgTable(\"coupons\", {\n  id: serial(\"id\").primaryKey(),\n  code: text(\"code\").notNull().unique(),\n  name: text(\"name\").notNull(),\n  discountType: text(\"discount_type\").notNull().default(\"percent\"), // percent, fixed\n  discountValue: decimal(\"discount_value\", { precision: 10, scale: 2 }).notNull(),\n  minOrderValue: decimal(\"min_order_value\", { precision: 10, scale: 2 }),\n  maxUses: integer(\"max_uses\"),\n  usedCount: integer(\"used_count\").notNull().default(0),\n  validFrom: timestamp(\"valid_from\"),\n  validUntil: timestamp(\"valid_until\"),\n  active: boolean(\"active\").notNull().default(true),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n});\n\nexport const insertCouponSchema = createInsertSchema(coupons).omit({\n  id: true,\n  usedCount: true,\n  createdAt: true,\n});\n\nexport type InsertCoupon = z.infer<typeof insertCouponSchema>;\nexport type Coupon = typeof coupons.$inferSelect;\n\n// Agenda/Calendar events for admin panel\nexport const agendaEvents = pgTable(\"agenda_events\", {\n  id: serial(\"id\").primaryKey(),\n  title: text(\"title\").notNull(),\n  description: text(\"description\"),\n  date: timestamp(\"date\").notNull(),\n  time: text(\"time\"),\n  type: text(\"type\").notNull().default(\"note\"), // note, meeting, task, reminder\n  completed: boolean(\"completed\").notNull().default(false),\n  createdBy: varchar(\"created_by\").references(() => users.id),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n});\n\nexport const insertAgendaEventSchema = createInsertSchema(agendaEvents).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport type InsertAgendaEvent = z.infer<typeof insertAgendaEventSchema>;\nexport type AgendaEvent = typeof agendaEvents.$inferSelect;\n\n// Site settings for global configurations\nexport const siteSettings = pgTable(\"site_settings\", {\n  id: serial(\"id\").primaryKey(),\n  key: text(\"key\").notNull().unique(),\n  value: text(\"value\"),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\nexport type SiteSetting = typeof siteSettings.$inferSelect;\n\n// Catalog banners for customization\nexport const catalogBanners = pgTable(\"catalog_banners\", {\n  id: serial(\"id\").primaryKey(),\n  position: text(\"position\").notNull(), // hero, promo1, promo2, promo3, footer\n  title: text(\"title\"),\n  subtitle: text(\"subtitle\"),\n  buttonText: text(\"button_text\"),\n  buttonLink: text(\"button_link\"),\n  imageUrl: text(\"image_url\"),\n  mobileImageUrl: text(\"mobile_image_url\"),\n  backgroundColor: text(\"background_color\"),\n  textColor: text(\"text_color\"),\n  order: integer(\"order\").notNull().default(0),\n  active: boolean(\"active\").notNull().default(true),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\nexport const insertCatalogBannerSchema = createInsertSchema(catalogBanners).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport type InsertCatalogBanner = z.infer<typeof insertCatalogBannerSchema>;\nexport type CatalogBanner = typeof catalogBanners.$inferSelect;\n\n// Catalog carousel slides (hero slider)\nexport const catalogSlides = pgTable(\"catalog_slides\", {\n  id: serial(\"id\").primaryKey(),\n  title: text(\"title\"),\n  subtitle: text(\"subtitle\"),\n  buttonText: text(\"button_text\"),\n  buttonLink: text(\"button_link\"),\n  imageUrl: text(\"image_url\").notNull(),\n  mobileImageUrl: text(\"mobile_image_url\"),\n  order: integer(\"order\").notNull().default(0),\n  active: boolean(\"active\").notNull().default(true),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n});\n\nexport const insertCatalogSlideSchema = createInsertSchema(catalogSlides).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport type InsertCatalogSlide = z.infer<typeof insertCatalogSlideSchema>;\nexport type CatalogSlide = typeof catalogSlides.$inferSelect;\n\n// Catalog customization settings\nexport const catalogConfig = pgTable(\"catalog_config\", {\n  id: serial(\"id\").primaryKey(),\n  key: text(\"key\").notNull().unique(),\n  value: text(\"value\"),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\nexport type CatalogConfig = typeof catalogConfig.$inferSelect;\n\n// Customer Credit (Fiado) - Store credit transactions\n// TYPE:\n// - DEBITO: Amount added to customer debt (purchase on credit)\n// - CREDITO: Payment received (reduces debt)\n// STATUS:\n// - PENDENTE: Pending payment\n// - PARCIAL: Partially paid\n// - PAGO: Fully paid\n// - VENCIDO: Overdue\n// - CANCELADO: Cancelled\nexport const customerCredits = pgTable(\"customer_credits\", {\n  id: serial(\"id\").primaryKey(),\n  userId: varchar(\"user_id\").notNull().references(() => users.id),\n  orderId: integer(\"order_id\").references(() => orders.id), // Optional link to order\n  type: text(\"type\").notNull(), // DEBITO, CREDITO\n  amount: decimal(\"amount\", { precision: 10, scale: 2 }).notNull(),\n  paidAmount: decimal(\"paid_amount\", { precision: 10, scale: 2 }).notNull().default(\"0\"),\n  description: text(\"description\"),\n  status: text(\"status\").notNull().default(\"PENDENTE\"), // PENDENTE, PARCIAL, PAGO, VENCIDO, CANCELADO\n  dueDate: timestamp(\"due_date\"), // Data de vencimento\n  paidAt: timestamp(\"paid_at\"), // Data do pagamento\n  createdBy: varchar(\"created_by\").references(() => users.id),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\nexport const insertCustomerCreditSchema = createInsertSchema(customerCredits).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport type InsertCustomerCredit = z.infer<typeof insertCustomerCreditSchema>;\nexport type CustomerCredit = typeof customerCredits.$inferSelect;\n\n// Customer credit payments - individual payments for a credit entry\nexport const creditPayments = pgTable(\"credit_payments\", {\n  id: serial(\"id\").primaryKey(),\n  creditId: integer(\"credit_id\").notNull().references(() => customerCredits.id),\n  amount: decimal(\"amount\", { precision: 10, scale: 2 }).notNull(),\n  paymentMethod: text(\"payment_method\"), // PIX, DINHEIRO, CARTAO, BOLETO, TRANSFERENCIA\n  notes: text(\"notes\"),\n  receivedBy: varchar(\"received_by\").references(() => users.id),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n});\n\nexport const insertCreditPaymentSchema = createInsertSchema(creditPayments).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport type InsertCreditPayment = z.infer<typeof insertCreditPaymentSchema>;\nexport type CreditPayment = typeof creditPayments.$inferSelect;\n\n// Accounts Payable (Contas a Pagar) - Expenses and supplier debts\n// STATUS:\n// - PENDENTE: Pending payment\n// - PAGO: Paid\n// - VENCIDO: Overdue\n// - CANCELADO: Cancelled\nexport const accountsPayable = pgTable(\"accounts_payable\", {\n  id: serial(\"id\").primaryKey(),\n  supplierId: varchar(\"supplier_id\").references(() => users.id), // Optional link to supplier\n  supplierName: text(\"supplier_name\"), // Or manual supplier name\n  category: text(\"category\"), // Tipo: fornecedor, aluguel, salario, imposto, etc.\n  description: text(\"description\").notNull(),\n  amount: decimal(\"amount\", { precision: 10, scale: 2 }).notNull(),\n  paidAmount: decimal(\"paid_amount\", { precision: 10, scale: 2 }).notNull().default(\"0\"),\n  status: text(\"status\").notNull().default(\"PENDENTE\"), // PENDENTE, PAGO, VENCIDO, CANCELADO\n  dueDate: timestamp(\"due_date\"), // Data de vencimento\n  paidAt: timestamp(\"paid_at\"), // Data do pagamento\n  paymentMethod: text(\"payment_method\"), // PIX, BOLETO, TRANSFERENCIA, etc.\n  documentNumber: text(\"document_number\"), // Número do documento/NF\n  notes: text(\"notes\"),\n  createdBy: varchar(\"created_by\").references(() => users.id),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\nexport const insertAccountPayableSchema = createInsertSchema(accountsPayable).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport type InsertAccountPayable = z.infer<typeof insertAccountPayableSchema>;\nexport type AccountPayable = typeof accountsPayable.$inferSelect;\n\n// Accounts Payable payments - individual payments\nexport const payablePayments = pgTable(\"payable_payments\", {\n  id: serial(\"id\").primaryKey(),\n  payableId: integer(\"payable_id\").notNull().references(() => accountsPayable.id),\n  amount: decimal(\"amount\", { precision: 10, scale: 2 }).notNull(),\n  paymentMethod: text(\"payment_method\"), // PIX, BOLETO, TRANSFERENCIA, DINHEIRO\n  notes: text(\"notes\"),\n  paidBy: varchar(\"paid_by\").references(() => users.id),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n});\n\nexport const insertPayablePaymentSchema = createInsertSchema(payablePayments).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport type InsertPayablePayment = z.infer<typeof insertPayablePaymentSchema>;\nexport type PayablePayment = typeof payablePayments.$inferSelect;\n\n// Banners for carousel\nexport const banners = pgTable(\"banners\", {\n  id: serial(\"id\").primaryKey(),\n  title: text(\"title\"),\n  imageUrl: text(\"image_url\").notNull(),\n  linkUrl: text(\"link_url\"),\n  active: boolean(\"active\").notNull().default(true),\n  sortOrder: integer(\"sort_order\").notNull().default(0),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n});\n\nexport const insertBannerSchema = createInsertSchema(banners).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport type InsertBanner = z.infer<typeof insertBannerSchema>;\nexport type Banner = typeof banners.$inferSelect;\n\n// System modules for permission management\nexport const modules = pgTable(\"modules\", {\n  id: serial(\"id\").primaryKey(),\n  key: text(\"key\").notNull().unique(), // catalog, orders, products, customers, etc.\n  label: text(\"label\").notNull(), // Display name in Portuguese\n  description: text(\"description\"),\n  icon: text(\"icon\"), // lucide icon name\n  defaultRoles: text(\"default_roles\").array(), // roles that have access by default\n  sortOrder: integer(\"sort_order\").notNull().default(0),\n});\n\nexport const insertModuleSchema = createInsertSchema(modules).omit({\n  id: true,\n});\n\nexport type InsertModule = z.infer<typeof insertModuleSchema>;\nexport type Module = typeof modules.$inferSelect;\n\n// User module permissions - which modules each user can access\nexport const userModulePermissions = pgTable(\"user_module_permissions\", {\n  id: serial(\"id\").primaryKey(),\n  userId: varchar(\"user_id\").notNull().references(() => users.id, { onDelete: 'cascade' }),\n  moduleKey: text(\"module_key\").notNull(),\n  allowed: boolean(\"allowed\").notNull().default(true),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\nexport const insertUserModulePermissionSchema = createInsertSchema(userModulePermissions).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport type InsertUserModulePermission = z.infer<typeof insertUserModulePermissionSchema>;\nexport type UserModulePermission = typeof userModulePermissions.$inferSelect;\n\n// Bling OAuth tokens - persisted storage for API tokens\nexport const blingTokens = pgTable(\"bling_tokens\", {\n  id: serial(\"id\").primaryKey(),\n  accessToken: text(\"access_token\").notNull(),\n  refreshToken: text(\"refresh_token\").notNull(),\n  expiresAt: timestamp(\"expires_at\").notNull(),\n  tokenType: text(\"token_type\").notNull().default(\"Bearer\"),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\nexport const insertBlingTokensSchema = createInsertSchema(blingTokens).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport type InsertBlingTokens = z.infer<typeof insertBlingTokensSchema>;\nexport type BlingTokens = typeof blingTokens.$inferSelect;\n","path":null,"size_bytes":21630,"size_tokens":null},"server/services/companyContext.service.ts":{"content":"import { db } from \"../db\";\nimport { companies, userCompanies } from \"@shared/schema\";\nimport { eq, and } from \"drizzle-orm\";\n\n/**\n * Define a empresa ativa do usuário\n * Valida se o usuário pertence à empresa\n */\nexport async function setActiveCompany({\n  userId,\n  companyId,\n}: {\n  userId: string;\n  companyId: string;\n}) {\n  const [link] = await db\n    .select()\n    .from(userCompanies)\n    .where(\n      and(\n        eq(userCompanies.userId, userId),\n        eq(userCompanies.companyId, companyId)\n      )\n    );\n\n  if (!link) {\n    throw new Error(\"Usuário não pertence a esta empresa\");\n  }\n\n  return true;\n}\n\n/**\n * Obtém a empresa ativa do usuário\n */\nexport async function getActiveCompany(companyId: string) {\n  const [company] = await db\n    .select()\n    .from(companies)\n    .where(eq(companies.id, companyId));\n\n  return company ?? null;\n}\n","path":null,"size_bytes":863,"size_tokens":null},"client/src/pages/payments.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Switch } from \"@/components/ui/switch\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger, DialogFooter } from \"@/components/ui/dialog\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { Plus, Edit2, Trash2, CreditCard, Plug, Loader2, CheckCircle2, XCircle } from \"lucide-react\";\nimport type { PaymentType, PaymentIntegration } from \"@shared/schema\";\n\nexport default function PaymentsPage() {\n  const { toast } = useToast();\n  const [activeTab, setActiveTab] = useState(\"types\");\n  const [isTypeDialogOpen, setIsTypeDialogOpen] = useState(false);\n  const [isIntegrationDialogOpen, setIsIntegrationDialogOpen] = useState(false);\n  const [editingType, setEditingType] = useState<PaymentType | null>(null);\n  const [editingIntegration, setEditingIntegration] = useState<PaymentIntegration | null>(null);\n\n  const [typeForm, setTypeForm] = useState({\n    name: \"\",\n    description: \"\",\n    active: true,\n    feeType: \"\" as \"PERCENTUAL\" | \"FIXO\" | \"\",\n    feeValue: \"\",\n    compensationDays: \"\",\n  });\n\n  const [integrationForm, setIntegrationForm] = useState({\n    provider: \"\",\n    name: \"\",\n    status: \"INATIVO\" as \"ATIVO\" | \"INATIVO\" | \"PENDENTE\",\n    sandbox: true,\n    enabledMethods: [] as string[],\n  });\n\n  const { data: paymentTypes = [], isLoading: loadingTypes } = useQuery<PaymentType[]>({\n    queryKey: [\"/api/payment-types\"],\n  });\n\n  const { data: integrations = [], isLoading: loadingIntegrations } = useQuery<PaymentIntegration[]>({\n    queryKey: [\"/api/payment-integrations\"],\n  });\n\n  const createTypeMutation = useMutation({\n    mutationFn: (data: any) => apiRequest(\"POST\", \"/api/payment-types\", data),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/payment-types\"] });\n      toast({ title: \"Tipo de pagamento criado com sucesso\" });\n      resetTypeForm();\n      setIsTypeDialogOpen(false);\n    },\n    onError: () => {\n      toast({ title: \"Erro ao criar tipo de pagamento\", variant: \"destructive\" });\n    },\n  });\n\n  const updateTypeMutation = useMutation({\n    mutationFn: ({ id, data }: { id: number; data: any }) =>\n      apiRequest(\"PATCH\", `/api/payment-types/${id}`, data),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/payment-types\"] });\n      toast({ title: \"Tipo de pagamento atualizado\" });\n      resetTypeForm();\n      setIsTypeDialogOpen(false);\n    },\n    onError: () => {\n      toast({ title: \"Erro ao atualizar\", variant: \"destructive\" });\n    },\n  });\n\n  const deleteTypeMutation = useMutation({\n    mutationFn: (id: number) => apiRequest(\"DELETE\", `/api/payment-types/${id}`),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/payment-types\"] });\n      toast({ title: \"Tipo de pagamento removido\" });\n    },\n    onError: () => {\n      toast({ title: \"Erro ao remover\", variant: \"destructive\" });\n    },\n  });\n\n  const createIntegrationMutation = useMutation({\n    mutationFn: (data: any) => apiRequest(\"POST\", \"/api/payment-integrations\", data),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/payment-integrations\"] });\n      toast({ title: \"Integração criada com sucesso\" });\n      resetIntegrationForm();\n      setIsIntegrationDialogOpen(false);\n    },\n    onError: () => {\n      toast({ title: \"Erro ao criar integração\", variant: \"destructive\" });\n    },\n  });\n\n  const updateIntegrationMutation = useMutation({\n    mutationFn: ({ id, data }: { id: number; data: any }) =>\n      apiRequest(\"PATCH\", `/api/payment-integrations/${id}`, data),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/payment-integrations\"] });\n      toast({ title: \"Integração atualizada\" });\n      resetIntegrationForm();\n      setIsIntegrationDialogOpen(false);\n    },\n    onError: () => {\n      toast({ title: \"Erro ao atualizar integração\", variant: \"destructive\" });\n    },\n  });\n\n  const deleteIntegrationMutation = useMutation({\n    mutationFn: (id: number) => apiRequest(\"DELETE\", `/api/payment-integrations/${id}`),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/payment-integrations\"] });\n      toast({ title: \"Integração removida\" });\n    },\n    onError: () => {\n      toast({ title: \"Erro ao remover integração\", variant: \"destructive\" });\n    },\n  });\n\n  function resetTypeForm() {\n    setTypeForm({ name: \"\", description: \"\", active: true, feeType: \"\", feeValue: \"\", compensationDays: \"\" });\n    setEditingType(null);\n  }\n\n  function resetIntegrationForm() {\n    setIntegrationForm({ provider: \"\", name: \"\", status: \"INATIVO\", sandbox: true, enabledMethods: [] });\n    setEditingIntegration(null);\n  }\n\n  function openEditType(pt: PaymentType) {\n    setEditingType(pt);\n    setTypeForm({\n      name: pt.name,\n      description: pt.description || \"\",\n      active: pt.active,\n      feeType: (pt.feeType as \"PERCENTUAL\" | \"FIXO\" | \"\") || \"\",\n      feeValue: pt.feeValue || \"\",\n      compensationDays: pt.compensationDays || \"\",\n    });\n    setIsTypeDialogOpen(true);\n  }\n\n  function openEditIntegration(int: PaymentIntegration) {\n    setEditingIntegration(int);\n    setIntegrationForm({\n      provider: int.provider,\n      name: int.name,\n      status: int.status as any,\n      sandbox: int.sandbox,\n      enabledMethods: int.enabledMethods || [],\n    });\n    setIsIntegrationDialogOpen(true);\n  }\n\n  function handleSubmitType(e: React.FormEvent) {\n    e.preventDefault();\n    const data = {\n      name: typeForm.name,\n      description: typeForm.description || null,\n      active: typeForm.active,\n      feeType: typeForm.feeType || null,\n      feeValue: typeForm.feeValue || null,\n      compensationDays: typeForm.compensationDays || null,\n    };\n    if (editingType) {\n      updateTypeMutation.mutate({ id: editingType.id, data });\n    } else {\n      createTypeMutation.mutate(data);\n    }\n  }\n\n  function handleSubmitIntegration(e: React.FormEvent) {\n    e.preventDefault();\n    const data = {\n      provider: integrationForm.provider,\n      name: integrationForm.name,\n      status: integrationForm.status,\n      sandbox: integrationForm.sandbox,\n      enabledMethods: integrationForm.enabledMethods.length > 0 ? integrationForm.enabledMethods : null,\n    };\n    if (editingIntegration) {\n      updateIntegrationMutation.mutate({ id: editingIntegration.id, data });\n    } else {\n      createIntegrationMutation.mutate(data);\n    }\n  }\n\n  const availableProviders = [\n    { value: \"mercadopago\", label: \"Mercado Pago\" },\n    { value: \"pagseguro\", label: \"PagSeguro\" },\n    { value: \"stripe\", label: \"Stripe\" },\n    { value: \"paypal\", label: \"PayPal\" },\n    { value: \"asaas\", label: \"Asaas\" },\n    { value: \"pix\", label: \"Pix Manual\" },\n  ];\n\n  const availableMethods = [\"pix\", \"credit_card\", \"debit_card\", \"boleto\"];\n\n  return (\n    <div className=\"container py-6 space-y-6 max-w-5xl\">\n      <div className=\"flex items-center justify-between gap-4 flex-wrap\">\n        <div>\n          <h1 className=\"text-2xl font-bold\" data-testid=\"text-page-title\">Pagamentos</h1>\n          <p className=\"text-muted-foreground\">Gerencie tipos de pagamento e integrações</p>\n        </div>\n      </div>\n\n      <Tabs value={activeTab} onValueChange={setActiveTab}>\n        <TabsList className=\"grid w-full grid-cols-2 max-w-md\">\n          <TabsTrigger value=\"types\" data-testid=\"tab-payment-types\">\n            <CreditCard className=\"w-4 h-4 mr-2\" />\n            Tipos de Pagamento\n          </TabsTrigger>\n          <TabsTrigger value=\"integrations\" data-testid=\"tab-integrations\">\n            <Plug className=\"w-4 h-4 mr-2\" />\n            Integrações\n          </TabsTrigger>\n        </TabsList>\n\n        <TabsContent value=\"types\" className=\"mt-6\">\n          <Card>\n            <CardHeader className=\"flex flex-row items-center justify-between gap-4 space-y-0 pb-4\">\n              <div>\n                <CardTitle>Tipos de Pagamento</CardTitle>\n                <CardDescription>Cadastre formas de pagamento personalizadas</CardDescription>\n              </div>\n              <Dialog open={isTypeDialogOpen} onOpenChange={(open) => { setIsTypeDialogOpen(open); if (!open) resetTypeForm(); }}>\n                <DialogTrigger asChild>\n                  <Button data-testid=\"button-create-payment-type\">\n                    <Plus className=\"w-4 h-4 mr-2\" />\n                    Criar tipo de pagamento\n                  </Button>\n                </DialogTrigger>\n                <DialogContent>\n                  <DialogHeader>\n                    <DialogTitle>{editingType ? \"Editar Tipo de Pagamento\" : \"Novo Tipo de Pagamento\"}</DialogTitle>\n                  </DialogHeader>\n                  <form onSubmit={handleSubmitType} className=\"space-y-4\">\n                    <div className=\"space-y-2\">\n                      <Label htmlFor=\"name\">Nome *</Label>\n                      <Input\n                        id=\"name\"\n                        value={typeForm.name}\n                        onChange={(e) => setTypeForm({ ...typeForm, name: e.target.value })}\n                        placeholder=\"Ex: Pagar na entrega, Pix, Cartão...\"\n                        required\n                        data-testid=\"input-payment-type-name\"\n                      />\n                    </div>\n                    <div className=\"space-y-2\">\n                      <Label htmlFor=\"description\">Descrição</Label>\n                      <Textarea\n                        id=\"description\"\n                        value={typeForm.description}\n                        onChange={(e) => setTypeForm({ ...typeForm, description: e.target.value })}\n                        placeholder=\"Descrição opcional...\"\n                        data-testid=\"input-payment-type-description\"\n                      />\n                    </div>\n                    <div className=\"flex items-center gap-2\">\n                      <Switch\n                        id=\"active\"\n                        checked={typeForm.active}\n                        onCheckedChange={(checked) => setTypeForm({ ...typeForm, active: checked })}\n                        data-testid=\"switch-payment-type-active\"\n                      />\n                      <Label htmlFor=\"active\">Ativo</Label>\n                    </div>\n                    <div className=\"grid grid-cols-2 gap-4\">\n                      <div className=\"space-y-2\">\n                        <Label>Tipo de Taxa</Label>\n                        <Select value={typeForm.feeType} onValueChange={(v) => setTypeForm({ ...typeForm, feeType: v as any })}>\n                          <SelectTrigger data-testid=\"select-fee-type\">\n                            <SelectValue placeholder=\"Sem taxa\" />\n                          </SelectTrigger>\n                          <SelectContent>\n                            <SelectItem value=\"PERCENTUAL\">Percentual (%)</SelectItem>\n                            <SelectItem value=\"FIXO\">Valor Fixo (R$)</SelectItem>\n                          </SelectContent>\n                        </Select>\n                      </div>\n                      <div className=\"space-y-2\">\n                        <Label htmlFor=\"feeValue\">Valor da Taxa</Label>\n                        <Input\n                          id=\"feeValue\"\n                          type=\"number\"\n                          step=\"0.01\"\n                          value={typeForm.feeValue}\n                          onChange={(e) => setTypeForm({ ...typeForm, feeValue: e.target.value })}\n                          placeholder=\"0.00\"\n                          data-testid=\"input-fee-value\"\n                        />\n                      </div>\n                    </div>\n                    <div className=\"space-y-2\">\n                      <Label htmlFor=\"compensationDays\">Prazo de Compensação (dias)</Label>\n                      <Input\n                        id=\"compensationDays\"\n                        type=\"number\"\n                        value={typeForm.compensationDays}\n                        onChange={(e) => setTypeForm({ ...typeForm, compensationDays: e.target.value })}\n                        placeholder=\"0\"\n                        data-testid=\"input-compensation-days\"\n                      />\n                    </div>\n                    <DialogFooter>\n                      <Button type=\"button\" variant=\"outline\" onClick={() => setIsTypeDialogOpen(false)}>Cancelar</Button>\n                      <Button type=\"submit\" disabled={createTypeMutation.isPending || updateTypeMutation.isPending} data-testid=\"button-save-payment-type\">\n                        {(createTypeMutation.isPending || updateTypeMutation.isPending) && <Loader2 className=\"w-4 h-4 mr-2 animate-spin\" />}\n                        {editingType ? \"Salvar\" : \"Criar\"}\n                      </Button>\n                    </DialogFooter>\n                  </form>\n                </DialogContent>\n              </Dialog>\n            </CardHeader>\n            <CardContent>\n              {loadingTypes ? (\n                <div className=\"flex items-center justify-center py-8\">\n                  <Loader2 className=\"w-6 h-6 animate-spin text-muted-foreground\" />\n                </div>\n              ) : paymentTypes.length === 0 ? (\n                <div className=\"text-center py-8 text-muted-foreground\">\n                  <CreditCard className=\"w-12 h-12 mx-auto mb-4 opacity-50\" />\n                  <p>Nenhum tipo de pagamento cadastrado</p>\n                  <p className=\"text-sm\">Clique em \"Criar tipo de pagamento\" para começar</p>\n                </div>\n              ) : (\n                <div className=\"space-y-3\">\n                  {paymentTypes.map((pt) => (\n                    <div\n                      key={pt.id}\n                      className=\"flex items-center justify-between p-4 border rounded-md gap-4\"\n                      data-testid={`card-payment-type-${pt.id}`}\n                    >\n                      <div className=\"flex items-center gap-3 flex-1 min-w-0\">\n                        <CreditCard className=\"w-5 h-5 text-muted-foreground flex-shrink-0\" />\n                        <div className=\"min-w-0\">\n                          <div className=\"flex items-center gap-2 flex-wrap\">\n                            <span className=\"font-medium\">{pt.name}</span>\n                            {pt.active ? (\n                              <Badge variant=\"secondary\" className=\"text-xs\"><CheckCircle2 className=\"w-3 h-3 mr-1\" />Ativo</Badge>\n                            ) : (\n                              <Badge variant=\"outline\" className=\"text-xs\"><XCircle className=\"w-3 h-3 mr-1\" />Inativo</Badge>\n                            )}\n                          </div>\n                          {pt.description && <p className=\"text-sm text-muted-foreground truncate\">{pt.description}</p>}\n                          <div className=\"flex items-center gap-4 text-xs text-muted-foreground mt-1 flex-wrap\">\n                            {pt.feeType && pt.feeValue && (\n                              <span>Taxa: {pt.feeType === \"PERCENTUAL\" ? `${pt.feeValue}%` : `R$ ${pt.feeValue}`}</span>\n                            )}\n                            {pt.compensationDays && <span>Compensação: {pt.compensationDays} dias</span>}\n                          </div>\n                        </div>\n                      </div>\n                      <div className=\"flex items-center gap-2\">\n                        <Button size=\"icon\" variant=\"ghost\" onClick={() => openEditType(pt)} data-testid={`button-edit-type-${pt.id}`}>\n                          <Edit2 className=\"w-4 h-4\" />\n                        </Button>\n                        <Button\n                          size=\"icon\"\n                          variant=\"ghost\"\n                          onClick={() => deleteTypeMutation.mutate(pt.id)}\n                          disabled={deleteTypeMutation.isPending}\n                          data-testid={`button-delete-type-${pt.id}`}\n                        >\n                          <Trash2 className=\"w-4 h-4\" />\n                        </Button>\n                      </div>\n                    </div>\n                  ))}\n                </div>\n              )}\n            </CardContent>\n          </Card>\n        </TabsContent>\n\n        <TabsContent value=\"integrations\" className=\"mt-6\">\n          <Card>\n            <CardHeader className=\"flex flex-row items-center justify-between gap-4 space-y-0 pb-4\">\n              <div>\n                <CardTitle>Integrações de Pagamento</CardTitle>\n                <CardDescription>Conecte gateways de pagamento externos</CardDescription>\n              </div>\n              <Dialog open={isIntegrationDialogOpen} onOpenChange={(open) => { setIsIntegrationDialogOpen(open); if (!open) resetIntegrationForm(); }}>\n                <DialogTrigger asChild>\n                  <Button data-testid=\"button-create-integration\">\n                    <Plus className=\"w-4 h-4 mr-2\" />\n                    Adicionar Integração\n                  </Button>\n                </DialogTrigger>\n                <DialogContent>\n                  <DialogHeader>\n                    <DialogTitle>{editingIntegration ? \"Editar Integração\" : \"Nova Integração\"}</DialogTitle>\n                  </DialogHeader>\n                  <form onSubmit={handleSubmitIntegration} className=\"space-y-4\">\n                    <div className=\"space-y-2\">\n                      <Label>Provedor *</Label>\n                      <Select value={integrationForm.provider} onValueChange={(v) => setIntegrationForm({ ...integrationForm, provider: v })}>\n                        <SelectTrigger data-testid=\"select-provider\">\n                          <SelectValue placeholder=\"Selecione o provedor\" />\n                        </SelectTrigger>\n                        <SelectContent>\n                          {availableProviders.map((p) => (\n                            <SelectItem key={p.value} value={p.value}>{p.label}</SelectItem>\n                          ))}\n                        </SelectContent>\n                      </Select>\n                    </div>\n                    <div className=\"space-y-2\">\n                      <Label htmlFor=\"intName\">Nome da Integração *</Label>\n                      <Input\n                        id=\"intName\"\n                        value={integrationForm.name}\n                        onChange={(e) => setIntegrationForm({ ...integrationForm, name: e.target.value })}\n                        placeholder=\"Ex: Mercado Pago - Produção\"\n                        required\n                        data-testid=\"input-integration-name\"\n                      />\n                    </div>\n                    <div className=\"space-y-2\">\n                      <Label>Status</Label>\n                      <Select value={integrationForm.status} onValueChange={(v) => setIntegrationForm({ ...integrationForm, status: v as any })}>\n                        <SelectTrigger data-testid=\"select-integration-status\">\n                          <SelectValue />\n                        </SelectTrigger>\n                        <SelectContent>\n                          <SelectItem value=\"ATIVO\">Ativo</SelectItem>\n                          <SelectItem value=\"INATIVO\">Inativo</SelectItem>\n                          <SelectItem value=\"PENDENTE\">Pendente</SelectItem>\n                        </SelectContent>\n                      </Select>\n                    </div>\n                    <div className=\"flex items-center gap-2\">\n                      <Switch\n                        id=\"sandbox\"\n                        checked={integrationForm.sandbox}\n                        onCheckedChange={(checked) => setIntegrationForm({ ...integrationForm, sandbox: checked })}\n                        data-testid=\"switch-sandbox\"\n                      />\n                      <Label htmlFor=\"sandbox\">Modo Sandbox/Teste</Label>\n                    </div>\n                    <div className=\"space-y-2\">\n                      <Label>Métodos Habilitados</Label>\n                      <div className=\"flex flex-wrap gap-2\">\n                        {availableMethods.map((method) => (\n                          <Badge\n                            key={method}\n                            variant={integrationForm.enabledMethods.includes(method) ? \"default\" : \"outline\"}\n                            className=\"cursor-pointer\"\n                            onClick={() => {\n                              const newMethods = integrationForm.enabledMethods.includes(method)\n                                ? integrationForm.enabledMethods.filter((m) => m !== method)\n                                : [...integrationForm.enabledMethods, method];\n                              setIntegrationForm({ ...integrationForm, enabledMethods: newMethods });\n                            }}\n                            data-testid={`badge-method-${method}`}\n                          >\n                            {method === \"pix\" && \"Pix\"}\n                            {method === \"credit_card\" && \"Cartão de Crédito\"}\n                            {method === \"debit_card\" && \"Cartão de Débito\"}\n                            {method === \"boleto\" && \"Boleto\"}\n                          </Badge>\n                        ))}\n                      </div>\n                    </div>\n                    <DialogFooter>\n                      <Button type=\"button\" variant=\"outline\" onClick={() => setIsIntegrationDialogOpen(false)}>Cancelar</Button>\n                      <Button type=\"submit\" disabled={createIntegrationMutation.isPending || updateIntegrationMutation.isPending} data-testid=\"button-save-integration\">\n                        {(createIntegrationMutation.isPending || updateIntegrationMutation.isPending) && <Loader2 className=\"w-4 h-4 mr-2 animate-spin\" />}\n                        {editingIntegration ? \"Salvar\" : \"Criar\"}\n                      </Button>\n                    </DialogFooter>\n                  </form>\n                </DialogContent>\n              </Dialog>\n            </CardHeader>\n            <CardContent>\n              {loadingIntegrations ? (\n                <div className=\"flex items-center justify-center py-8\">\n                  <Loader2 className=\"w-6 h-6 animate-spin text-muted-foreground\" />\n                </div>\n              ) : integrations.length === 0 ? (\n                <div className=\"text-center py-8 text-muted-foreground\">\n                  <Plug className=\"w-12 h-12 mx-auto mb-4 opacity-50\" />\n                  <p>Nenhuma integração configurada</p>\n                  <p className=\"text-sm\">Conecte um gateway de pagamento para processar pagamentos online</p>\n                </div>\n              ) : (\n                <div className=\"space-y-3\">\n                  {integrations.map((int) => (\n                    <div\n                      key={int.id}\n                      className=\"flex items-center justify-between p-4 border rounded-md gap-4\"\n                      data-testid={`card-integration-${int.id}`}\n                    >\n                      <div className=\"flex items-center gap-3 flex-1 min-w-0\">\n                        <Plug className=\"w-5 h-5 text-muted-foreground flex-shrink-0\" />\n                        <div className=\"min-w-0\">\n                          <div className=\"flex items-center gap-2 flex-wrap\">\n                            <span className=\"font-medium\">{int.name}</span>\n                            <Badge variant=\"outline\" className=\"text-xs\">{int.provider}</Badge>\n                            {int.status === \"ATIVO\" && <Badge variant=\"secondary\" className=\"text-xs\"><CheckCircle2 className=\"w-3 h-3 mr-1\" />Ativo</Badge>}\n                            {int.status === \"INATIVO\" && <Badge variant=\"outline\" className=\"text-xs\"><XCircle className=\"w-3 h-3 mr-1\" />Inativo</Badge>}\n                            {int.status === \"PENDENTE\" && <Badge variant=\"outline\" className=\"text-xs\">Pendente</Badge>}\n                            {int.sandbox && <Badge variant=\"outline\" className=\"text-xs\">Sandbox</Badge>}\n                          </div>\n                          {int.enabledMethods && int.enabledMethods.length > 0 && (\n                            <p className=\"text-xs text-muted-foreground mt-1\">\n                              Métodos: {int.enabledMethods.join(\", \")}\n                            </p>\n                          )}\n                        </div>\n                      </div>\n                      <div className=\"flex items-center gap-2\">\n                        <Button size=\"icon\" variant=\"ghost\" onClick={() => openEditIntegration(int)} data-testid={`button-edit-integration-${int.id}`}>\n                          <Edit2 className=\"w-4 h-4\" />\n                        </Button>\n                        <Button\n                          size=\"icon\"\n                          variant=\"ghost\"\n                          onClick={() => deleteIntegrationMutation.mutate(int.id)}\n                          disabled={deleteIntegrationMutation.isPending}\n                          data-testid={`button-delete-integration-${int.id}`}\n                        >\n                          <Trash2 className=\"w-4 h-4\" />\n                        </Button>\n                      </div>\n                    </div>\n                  ))}\n                </div>\n              )}\n            </CardContent>\n          </Card>\n        </TabsContent>\n      </Tabs>\n    </div>\n  );\n}\n","path":null,"size_bytes":26024,"size_tokens":null},"server/services/stock.service.ts":{"content":"import { db } from \"../db\";\nimport { b2bOrderItems, b2bProducts } from \"@shared/schema\";\nimport { eq } from \"drizzle-orm\";\n\n/**\n * Reserva estoque ao gerar pedido\n */\nexport async function reserveStock(orderId: number) {\n  const items = await db\n    .select()\n    .from(b2bOrderItems)\n    .where(eq(b2bOrderItems.orderId, orderId));\n\n  for (const item of items) {\n    await db\n      .update(b2bProducts)\n      .set({\n        reservedStock: sql`reserved_stock + ${item.quantity}`,\n      })\n      .where(eq(b2bProducts.id, item.productId));\n  }\n}\n\n/**\n * Baixa estoque ao faturar pedido\n */\nexport async function deductStock(orderId: number) {\n  const items = await db\n    .select()\n    .from(b2bOrderItems)\n    .where(eq(b2bOrderItems.orderId, orderId));\n\n  for (const item of items) {\n    await db\n      .update(b2bProducts)\n      .set({\n        stock: sql`stock - ${item.quantity}`,\n        reservedStock: sql`reserved_stock - ${item.quantity}`,\n      })\n      .where(eq(b2bProducts.id, item.productId));\n  }\n}\n","path":null,"size_bytes":1012,"size_tokens":null},"server/middleware/requireCompany.ts":{"content":"import { Request, Response, NextFunction } from \"express\";\n\nexport function requireCompany(\n  req: Request,\n  res: Response,\n  next: NextFunction\n) {\n  const companyId = req.session?.activeCompanyId;\n\n  if (!companyId) {\n    return res.status(400).json({\n      error: \"Nenhuma empresa ativa selecionada\",\n    });\n  }\n\n  next();\n}\n","path":null,"size_bytes":330,"size_tokens":null},"server/services/b2bOrderItems.service.ts":{"content":"import { db } from \"../db\";\nimport { b2bOrderItems } from \"@shared/schema\";\nimport { eq } from \"drizzle-orm\";\nimport type { InsertB2bOrderItem } from \"@shared/schema\";\n\n/**\n * Adiciona item ao pedido (snapshot de preço)\n * SEM desconto aqui\n */\nexport async function addItemToOrder(data: InsertB2bOrderItem) {\n  const [item] = await db\n    .insert(b2bOrderItems)\n    .values(data)\n    .returning();\n\n  return item;\n}\n\n/**\n * Lista itens de um pedido\n */\nexport async function listOrderItems(orderId: string) {\n  return db\n    .select()\n    .from(b2bOrderItems)\n    .where(eq(b2bOrderItems.orderId, orderId));\n}\n","path":null,"size_bytes":612,"size_tokens":null},"server/services/orderItemDiscounts.service.ts":{"content":"import { db } from \"../db\";\nimport { orderItemDiscounts } from \"@shared/schema\";\nimport type { InsertOrderItemDiscount } from \"@shared/schema\";\n\n/**\n * Solicita desconto (fica PENDENTE)\n */\nexport async function requestItemDiscount(data: InsertOrderItemDiscount) {\n  const [discount] = await db\n    .insert(orderItemDiscounts)\n    .values({\n      ...data,\n      status: \"PENDENTE\",\n    })\n    .returning();\n\n  return discount;\n}\n\n/**\n * Aprova desconto (SUPERVISOR)\n */\nexport async function approveItemDiscount({\n  discountId,\n  approvedBy,\n}: {\n  discountId: number;\n  approvedBy: string;\n}) {\n  const [discount] = await db\n    .update(orderItemDiscounts)\n    .set({\n      status: \"APROVADO\",\n      approvedBy,\n      approvedAt: new Date(),\n    })\n    .where(eq(orderItemDiscounts.id, discountId))\n    .returning();\n\n  return discount;\n}\n","path":null,"size_bytes":840,"size_tokens":null},"shared/schema/orderItemDiscounts.schema.ts":{"content":"import { pgTable, serial, integer, varchar, text, decimal, timestamp, pgEnum } from \"drizzle-orm/pg-core\";\nimport { createInsertSchema } from \"drizzle-zod\";\nimport { z } from \"zod\";\nimport { b2bOrderItems } from \"./orderItems.schema\";\nimport { b2bUsers } from \"./users.schema\";\n\nexport const tipoDescontoEnum = pgEnum(\"tipo_desconto\", [\"VALOR\", \"PERCENTUAL\"]);\nexport const discountStatusEnum = pgEnum(\"discount_status\", [\"PENDENTE\", \"APROVADO\", \"REJEITADO\"]);\n\nexport const orderItemDiscounts = pgTable(\"order_item_discounts\", {\n  id: serial(\"id\").primaryKey(),\n  orderItemId: integer(\"order_item_id\").notNull().references(() => b2bOrderItems.id, { onDelete: \"cascade\" }),\n  solicitadoPorUserId: varchar(\"solicitado_por_user_id\").notNull().references(() => b2bUsers.id),\n  aprovadoPorUserId: varchar(\"aprovado_por_user_id\").references(() => b2bUsers.id),\n  tipoDesconto: tipoDescontoEnum(\"tipo_desconto\").notNull(),\n  valorSolicitado: decimal(\"valor_solicitado\", { precision: 10, scale: 2 }).notNull(),\n  valorAprovado: decimal(\"valor_aprovado\", { precision: 10, scale: 2 }),\n  motivo: text(\"motivo\"),\n  status: discountStatusEnum(\"status\").notNull().default(\"PENDENTE\"),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\nexport const insertOrderItemDiscountSchema = createInsertSchema(orderItemDiscounts).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport type InsertOrderItemDiscount = z.infer<typeof insertOrderItemDiscountSchema>;\nexport type OrderItemDiscount = typeof orderItemDiscounts.$inferSelect;\n","path":null,"size_bytes":1593,"size_tokens":null},"shared/schema/orderItems.schema.ts":{"content":"import { pgTable, serial, integer, varchar, decimal, timestamp } from \"drizzle-orm/pg-core\";\nimport { createInsertSchema } from \"drizzle-zod\";\nimport { z } from \"zod\";\nimport { b2bOrders } from \"./orders.schema\";\nimport { b2bProducts } from \"./products.schema\";\n\nexport const b2bOrderItems = pgTable(\"b2b_order_items\", {\n  id: serial(\"id\").primaryKey(),\n  orderId: integer(\"order_id\").notNull().references(() => b2bOrders.id, { onDelete: \"cascade\" }),\n  productId: integer(\"product_id\").notNull().references(() => b2bProducts.id),\n  sku: varchar(\"sku\", { length: 50 }).notNull(),\n  quantidade: integer(\"quantidade\").notNull(),\n  precoLista: decimal(\"preco_lista\", { precision: 10, scale: 2 }).notNull(),\n  descontoValor: decimal(\"desconto_valor\", { precision: 10, scale: 2 }).notNull().default(\"0\"),\n  descontoPercentual: decimal(\"desconto_percentual\", { precision: 5, scale: 2 }).notNull().default(\"0\"),\n  precoUnitario: decimal(\"preco_unitario\", { precision: 10, scale: 2 }).notNull(),\n  subtotal: decimal(\"subtotal\", { precision: 12, scale: 2 }).notNull(),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n});\n\nexport const insertB2bOrderItemSchema = createInsertSchema(b2bOrderItems).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport type InsertB2bOrderItem = z.infer<typeof insertB2bOrderItemSchema>;\nexport type B2bOrderItem = typeof b2bOrderItems.$inferSelect;\n","path":null,"size_bytes":1380,"size_tokens":null},"shared/schema/payments.schema.ts":{"content":"import { pgTable, serial, text, varchar, decimal, boolean, timestamp, jsonb, pgEnum } from \"drizzle-orm/pg-core\";\nimport { createInsertSchema } from \"drizzle-zod\";\nimport { z } from \"zod\";\n\nexport const feeTypeEnum = pgEnum(\"fee_type\", [\"PERCENTUAL\", \"FIXO\"]);\nexport const integrationStatusEnum = pgEnum(\"integration_status\", [\"ATIVO\", \"INATIVO\", \"PENDENTE\"]);\n\nexport const paymentTypes = pgTable(\"payment_types\", {\n  id: serial(\"id\").primaryKey(),\n  name: text(\"name\").notNull(),\n  description: text(\"description\"),\n  active: boolean(\"active\").notNull().default(true),\n  feeType: feeTypeEnum(\"fee_type\"),\n  feeValue: decimal(\"fee_value\", { precision: 10, scale: 2 }),\n  compensationDays: decimal(\"compensation_days\", { precision: 5, scale: 0 }),\n  isIntegration: boolean(\"is_integration\").notNull().default(false),\n  integrationId: text(\"integration_id\"),\n  sortOrder: decimal(\"sort_order\", { precision: 5, scale: 0 }).default(\"0\"),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\nexport const insertPaymentTypeSchema = createInsertSchema(paymentTypes).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport type InsertPaymentType = z.infer<typeof insertPaymentTypeSchema>;\nexport type PaymentType = typeof paymentTypes.$inferSelect;\n\nexport const paymentIntegrations = pgTable(\"payment_integrations\", {\n  id: serial(\"id\").primaryKey(),\n  provider: text(\"provider\").notNull(),\n  name: text(\"name\").notNull(),\n  status: integrationStatusEnum(\"status\").notNull().default(\"INATIVO\"),\n  credentials: jsonb(\"credentials\"),\n  enabledMethods: text(\"enabled_methods\").array(),\n  webhookUrl: text(\"webhook_url\"),\n  webhookSecret: text(\"webhook_secret\"),\n  sandbox: boolean(\"sandbox\").notNull().default(true),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\nexport const insertPaymentIntegrationSchema = createInsertSchema(paymentIntegrations).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport type InsertPaymentIntegration = z.infer<typeof insertPaymentIntegrationSchema>;\nexport type PaymentIntegration = typeof paymentIntegrations.$inferSelect;\n\nexport const paymentTransactions = pgTable(\"payment_transactions\", {\n  id: serial(\"id\").primaryKey(),\n  orderId: text(\"order_id\"),\n  paymentTypeId: text(\"payment_type_id\"),\n  integrationId: text(\"integration_id\"),\n  externalId: text(\"external_id\"),\n  status: text(\"status\").notNull().default(\"pending\"),\n  amount: decimal(\"amount\", { precision: 12, scale: 2 }).notNull(),\n  fee: decimal(\"fee\", { precision: 10, scale: 2 }),\n  netAmount: decimal(\"net_amount\", { precision: 12, scale: 2 }),\n  metadata: jsonb(\"metadata\"),\n  paidAt: timestamp(\"paid_at\"),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\nexport const insertPaymentTransactionSchema = createInsertSchema(paymentTransactions).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport type InsertPaymentTransaction = z.infer<typeof insertPaymentTransactionSchema>;\nexport type PaymentTransaction = typeof paymentTransactions.$inferSelect;\n","path":null,"size_bytes":3191,"size_tokens":null},"server/services/b2bOrders.service.ts":{"content":"import { db } from \"../db\";\nimport { b2bOrders } from \"@shared/schema\";\nimport { eq } from \"drizzle-orm\";\nimport type { InsertB2bOrder } from \"@shared/schema\";\n\n/**\n * Cria um pedido B2B usando empresa ativa da sessão\n */\nexport async function createB2bOrder({\n  data,\n  userId,\n  companyId,\n}: {\n  data: InsertB2bOrder;\n  userId: string;\n  companyId: string;\n}) {\n  const [order] = await db\n    .insert(b2bOrders)\n    .values({\n      ...data,\n      companyId,\n      createdBy: userId,\n    })\n    .returning();\n\n  return order;\n}\n\n/**\n * Lista pedidos da empresa ativa\n */\nexport async function listOrdersByCompany(companyId: string) {\n  return db\n    .select()\n    .from(b2bOrders)\n    .where(eq(b2bOrders.companyId, companyId))\n    .orderBy(b2bOrders.createdAt);\n}\n","path":null,"size_bytes":768,"size_tokens":null}},"version":2}