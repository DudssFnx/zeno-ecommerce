Você é um desenvolvedor full-stack sênior. NO MODULO COMPRAS VOCE FAZ igual ao BLING no conceito de “Pedido de Compra” + “Lançar Estoque” manual.

STACK OBRIGATÓRIA
- Frontend: React + TypeScript (Vite)
- Backend: Node.js + TypeScript (Express)
- Banco: SQLite (via Prisma)
- UI: Tailwind + componentes simples (sem depender de libs pesadas)
- Rodar local no Replit com scripts claros.

OBJETIVO DO MÓDULO
Criar “Pedidos de Compra” onde o usuário adiciona produtos e fornecedor, finaliza a compra, mas o estoque NÃO é lançado automaticamente. O estoque só é alterado quando o usuário entra no pedido e clica em “Lançar Estoque”. Deve existir também “Devolver Estoque” (estornar a entrada).

MODELOS (PRISMA)
1) Product
- id, sku (único), name, unit (ex: un, cx), costPrice (decimal), salePrice (decimal opcional), stockQty (decimal), createdAt

2) Supplier
- id, name, document (cnpj/cpf opcional), phone, email, city, createdAt

3) PurchaseOrder
- id, number (sequencial tipo PC-000001), status (DRAFT | FINALIZED | STOCK_POSTED | STOCK_REVERSED), supplierId (nullable até finalizar), notes, totalValue (decimal), createdAt, updatedAt, finalizedAt, postedAt, reversedAt

4) PurchaseOrderItem
- id, purchaseOrderId, productId, descriptionSnapshot, skuSnapshot, qty (decimal), unitCost (decimal), lineTotal (decimal)

5) StockMovement (ledger)
- id, type (IN | OUT), reason (PURCHASE_POST | PURCHASE_REVERSE), refType (PURCHASE_ORDER), refId (purchaseOrderId), productId, qty (decimal), unitCost (decimal), createdAt

REGRAS DE NEGÓCIO (IGUAL BLING)
A) Criar Pedido de Compra (DRAFT)
- Tela “Adicionar Compra” cria PurchaseOrder como DRAFT
- Usuário adiciona itens (produto, qtd, custo unitário)
- Permitir buscar produto por nome/SKU e também criar produto rápido (modal “Novo Produto”)
- Totais calculados em tempo real (sum lineTotal)

B) Fornecedor
- Depois de adicionar itens, usuário seleciona ou cadastra fornecedor (modal “Novo Fornecedor”)
- Fornecedor só é obrigatório para FINALIZAR

C) Finalizar Compra
- Botão “Finalizar Compra”
- Valida: precisa ter ao menos 1 item + fornecedor
- Status vira FINALIZED
- Não mexe no estoque ainda

D) Lançar Estoque (AÇÃO MANUAL)
- Dentro do pedido FINALIZED, botão “Lançar Estoque”
- Ao lançar:
  - Para cada item, cria StockMovement IN com reason PURCHASE_POST e refId = pedido
  - Atualiza Product.stockQty += qty
  - Status vira STOCK_POSTED
  - postedAt preenchido
- Deve ser transação atômica: ou lança tudo, ou nada

E) Devolver Estoque (ESTORNO)
- Disponível apenas se status = STOCK_POSTED
- Botão “Devolver Estoque”
- Ao devolver:
  - Cria StockMovement OUT com reason PURCHASE_REVERSE
  - Atualiza Product.stockQty -= qty (estorno)
  - Status vira STOCK_REVERSED
  - reversedAt preenchido
- Impedir estoque negativo? (Se ficar negativo, bloquear e mostrar erro claro)

F) Segurança contra duplicidade
- Não permitir lançar estoque duas vezes no mesmo pedido
- Não permitir devolver se ainda não lançou
- Mostrar mensagens claras de validação

TELAS (FRONTEND)
1) Compras (Lista)
- Tabela com: Número, Fornecedor, Status, Total, Data
- Filtros por status e busca por número/fornecedor
- Botão “Adicionar Compra”

2) Nova Compra (Form)
- Lista de itens com adicionar/remover
- Campos por item: produto (autocomplete), qty, unitCost, total linha
- Subtotal/Total
- Seção fornecedor (selecionar existente + botão “Novo Fornecedor”)
- Campo observações
- Botões: “Salvar rascunho” e “Finalizar Compra”

3) Detalhe do Pedido
- Cabeçalho com status e dados do fornecedor
- Itens e totais
- Ações:
  - Se FINALIZED: botão “Lançar Estoque”
  - Se STOCK_POSTED: botão “Devolver Estoque”
- Área “Histórico” mostrando StockMovements vinculados ao pedido

ENDPOINTS (EXPRESS)
- GET /api/products?search=
- POST /api/products
- GET /api/suppliers?search=
- POST /api/suppliers
- POST /api/purchases (criar DRAFT)
- PUT /api/purchases/:id (atualizar itens/obs/fornecedor enquanto DRAFT)
- POST /api/purchases/:id/finalize
- POST /api/purchases/:id/post-stock
- POST /api/purchases/:id/reverse-stock
- GET /api/purchases (listagem + filtros)
- GET /api/purchases/:id (detalhe + itens + movimentos)

REQUISITOS DE UX
- Status com badges (Rascunho, Finalizado, Estoque Lançado, Estoque Devolvido)
- Confirmação modal antes de “Lançar Estoque” e “Devolver Estoque”
- Toasts de sucesso/erro
- Loading states



